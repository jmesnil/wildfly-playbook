<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>WildFly Elytron Security :: My Demo Site</title>
    <link rel="canonical" href="https://docs.demo.com/wildfly/WildFly_Elytron_Security.html">
    <meta name="generator" content="Antora 2.3.4">
    <link rel="stylesheet" href="../_/css/site.css">
    <script>var uiRootPath = '../_'</script>
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://docs.demo.com">My Demo Site</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="#">Home</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Products</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Product A</a>
            <a class="navbar-item" href="#">Product B</a>
            <a class="navbar-item" href="#">Product C</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Services</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Service A</a>
            <a class="navbar-item" href="#">Service B</a>
            <a class="navbar-item" href="#">Service C</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Resources</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Resource A</a>
            <a class="navbar-item" href="#">Resource B</a>
            <a class="navbar-item" href="#">Resource C</a>
          </div>
        </div>
        <div class="navbar-item">
          <span class="control">
            <a class="button is-primary" href="#">Download</a>
          </span>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="wildfly" data-version="master">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-explore is-active" data-panel="explore">
  <div class="context">
    <span class="title">WildFly</span>
    <span class="version">master</span>
  </div>
  <ul class="components">
    <li class="component">
      <a class="title" href="../wildfly-operator/user-guide.html">Kubernetes Operator for WildFly</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../wildfly-operator/user-guide.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component is-current">
      <a class="title" href="index.html">WildFly</a>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="index.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../wildfly-cloud/main/index.html">WildFly on the Cloud</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../wildfly-cloud/main/index.html">main</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
</nav>
  <div class="edit-this-page"><a href="https://github.com/jmesnil/wildfly/edit/antora/docs/modules/ROOT/pages/WildFly_Elytron_Security.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<h1 class="page">WildFly Elytron Security</h1>
<div id="preamble">
<div class="sectionbody">
<div id="toc" class="toc">
<div id="toctitle" class="title">WildFly Elytron Security Guide</div>
<ul class="sectlevel1">
<li><a href="#about">1. About</a>
<ul class="sectlevel2">
<li><a href="#elytron-authentication">1.1. Authentication</a></li>
<li><a href="#elytron-authorization">1.2. Authorization</a></li>
<li><a href="#about-ssl-tls">1.3. SSL / TLS</a></li>
<li><a href="#secure-credential-storage">1.4. Secure Credential Storage</a></li>
</ul>
</li>
<li><a href="#General_Elytron_Architecture">2. General Elytron Architecture</a>
<ul class="sectlevel2">
<li><a href="#security-domains">2.1. Security Domains</a></li>
<li><a href="#sasl-authentication">2.2. SASL Authentication</a></li>
<li><a href="#http-authentication">2.3. HTTP Authentication</a></li>
<li><a href="#ssl-tls">2.4. SSL / TLS</a></li>
<li><a href="#Passwords">2.5. Passwords</a></li>
</ul>
</li>
<li><a href="#Elytron_Subsystem">3. Elytron Subsystem</a>
<ul class="sectlevel2">
<li><a href="#get-started-using-the-elytron-subsystem">3.1. Get Started using the Elytron Subsystem</a></li>
<li><a href="#provided-components">3.2. Provided components</a></li>
<li><a href="#out-of-the-box-configuration">3.3. Out of the Box Configuration</a></li>
<li><a href="#default-application-authentication-configuration">3.4. Default Application Authentication Configuration</a></li>
<li><a href="#default-management-authentication-configuration">3.5. Default Management Authentication Configuration</a></li>
<li><a href="#comparing-legacy-approaches-to-elytron-approaches">3.6. Comparing Legacy Approaches to Elytron Approaches</a></li>
</ul>
</li>
<li><a href="#Using_the_Elytron_Subsystem">4. Using the Elytron Subsystem</a>
<ul class="sectlevel2">
<li><a href="#set-up-and-configure-authentication-for-applications">4.1. Set Up and Configure Authentication for Applications</a></li>
<li><a href="#set-up-and-configure-authentication-for-the-management-interfaces">4.2. Set up and Configure Authentication for the Management Interfaces</a></li>
<li><a href="#configure-ssltls">4.3. Configure SSL/TLS</a></li>
<li><a href="#configuring-the-elytron-and-security-subsystems">4.4. Configuring the Elytron and Security Subsystems</a></li>
<li><a href="#creating-elytron-subsystem-components">4.5. Creating Elytron Subsystem Components</a></li>
<li><a href="#_component_documentation">4.6. Component Documentation</a></li>
</ul>
</li>
<li><a href="#Using_WildFly_Elytron_with_WildFly">5. Using Elytron within WildFly</a>
<ul class="sectlevel2">
<li><a href="#using-the-out-of-the-box-elytron-components">5.1. Using the Out of the Box Elytron Components</a></li>
<li><a href="#undertow-subsystem">5.2. Undertow Subsystem</a></li>
<li><a href="#Jakarta-Enterprise-Beans-subsystem">5.3. Jakarta Enterprise Beans Subsystem</a></li>
<li><a href="#webservices-subsystem">5.4. WebServices Subsystem</a></li>
<li><a href="#legacy-security-subsystem">5.5. Legacy Security Subsystem</a></li>
</ul>
</li>
<li><a href="#Client_Authentication_with_Elytron_Client">6. Client Authentication with Elytron Client</a>
<ul class="sectlevel2">
<li><a href="#the-configuration-file-approach">6.1. The Configuration File Approach</a></li>
<li><a href="#the-programmatic-approach">6.2. The Programmatic Approach</a></li>
<li><a href="#the-default-configuration-approach">6.3. The Default Configuration Approach</a></li>
<li><a href="#using-elytron-client-with-clients-deployed-to-wildfly">6.4. Using Elytron Client with Clients Deployed to WildFly</a></li>
<li><a href="#Configuring_other_clients_using_wildfly-config">6.5. Client configuration using wildfly-config.xml</a></li>
</ul>
</li>
<li><a href="#Elytron_and_Java_Authorization_Contract_for_Containers-JACC">7. Elytron and Java Authorization Contract for Containers (JACC)</a>
<ul class="sectlevel2">
<li><a href="#disabling-jacc-in-legacy-security-subsystem-picketbox">7.1. Disabling JACC in Legacy Security Subsystem (PicketBox)</a></li>
<li><a href="#defining-a-jacc-policy-provider">7.2. Defining a JACC Policy Provider</a></li>
<li><a href="#enabling-jacc-to-a-web-deployment">7.3. Enabling JACC to a Web Deployment</a></li>
<li><a href="#enabling-jacc-to-a-ejb-deployment">7.4. Enabling JACC to a EJB Deployment</a></li>
</ul>
</li>
<li><a href="#Elytron_and_Java_Authentication_SPI_for_Containers-JASPI">9. Elytron and Java Authentication SPI for Containers (JASPI)</a>
<ul class="sectlevel1">
<li><a href="#_introduction">8. Introduction</a>
<ul class="sectlevel2">
<li><a href="#_activation">8.1. Activation</a></li>
<li><a href="#_subsystem_configuration">8.2. Subsystem Configuration</a></li>
<li><a href="#_programatic_configuration">8.3. Programatic Configuration</a></li>
<li><a href="#_authentication_process">8.4. Authentication Process</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#Elytron_and_Java_EE_Security">11. Elytron and Jakarta EE Security</a>
<ul class="sectlevel1">
<li><a href="#_introduction_2">10. Introduction</a>
<ul class="sectlevel2">
<li><a href="#_activation_2">10.1. Activation</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#Keycloak_Integration">12. Using Keycloak with WildFly Elytron</a>
<ul class="sectlevel2">
<li><a href="#_zip_installation">12.1. Zip Installation</a></li>
<li><a href="#_galleon_installation">12.2. Galleon Installation</a></li>
<li><a href="#_bootable_jar">12.3. Bootable Jar</a></li>
</ul>
</li>
<li><a href="#Bearer_Token_Authorization">13. Bearer Token Authorization</a>
<ul class="sectlevel2">
<li><a href="#_how_it_works">13.1. How it Works</a></li>
<li><a href="#_validating_jwt_tokens">13.2. Validating JWT Tokens</a></li>
<li><a href="#_validating_oauth2_bearer_tokens">13.3. Validating OAuth2 Bearer Tokens</a></li>
<li><a href="#_quickstarts">13.4. Quickstarts</a></li>
<li><a href="#_cli_examples_on_how_to_create_a_token_realm">13.5. CLI Examples on How to Create a Token Realm</a></li>
</ul>
</li>
<li><a href="#OpenSSL">14. OpenSSL</a>
<ul class="sectlevel2">
<li><a href="#_configuring_wildfly_to_use_the_openssl_tls_provider">14.1. Configuring WildFly to use the OpenSSL TLS provider</a></li>
<li><a href="#_openssl_library_location">14.2. OpenSSL Library Location</a></li>
<li><a href="#_enabling_tlsv1_3">14.3. Enabling TLSv1.3</a></li>
<li><a href="#_adding_additional_native_libraries">14.4. Adding Additional Native Libraries</a></li>
</ul>
</li>
<li><a href="#Web_Single_Sign_On">15. Web Single Sign-On</a>
<ul class="sectlevel2">
<li><a href="#_create_a_server_configuration_template">15.1. Create a Server Configuration Template</a></li>
<li><a href="#_create_two_server_instances">15.2. Create Two Server Instances</a></li>
<li><a href="#_deploy_an_application">15.3. Deploy an Application</a></li>
</ul>
</li>
<li><a href="#Audit">16. Audit</a>
<ul class="sectlevel2">
<li><a href="#_file_audit_log">16.1. File audit log</a></li>
<li><a href="#_syslog_audit_logging">16.2. Syslog Audit Logging</a></li>
</ul>
</li>
<li><a href="#CredentialStore">17. Credential Store</a>
<ul class="sectlevel2">
<li><a href="#_credential_store_creation">17.1. Credential Store Creation</a></li>
<li><a href="#_credential_manipulation">17.2. Credential Manipulation</a></li>
<li><a href="#_referencing_credentials">17.3. Referencing Credentials</a></li>
<li><a href="#_credentialstore_apis">17.4. CredentialStore APIs</a></li>
<li><a href="#Migrating_Existing_Vaults">17.5. Migrating Existing Vaults</a></li>
<li><a href="#Custom_CredentialStore">17.6. Custom Credential Store</a></li>
<li><a href="#_reference">17.7. Reference</a></li>
</ul>
</li>
<li><a href="#EncryptedExpressions">18. Encrypted Expressions</a>
<ul class="sectlevel2">
<li><a href="#_expressionencryption_resource">18.1. expression=encryption resource</a></li>
<li><a href="#_creating_expressions">18.2. Creating Expressions</a></li>
<li><a href="#_domain_mode">18.3. Domain Mode</a></li>
</ul>
</li>
<li><a href="#Custom_Components">19. Custom Components</a>
<ul class="sectlevel2">
<li><a href="#_security_event_listener">19.1. Security event listener</a></li>
<li><a href="#_configurable_custom_components">19.2. Configurable custom components</a></li>
</ul>
</li>
<li><a href="#Migrate_Legacy_Security_to_Elytron_Security">20. Migrate Legacy Security to Elytron Security</a>
<ul class="sectlevel2">
<li><a href="#_authentication_configuration">20.1. Authentication Configuration</a></li>
<li><a href="#Properties_File_Based_Authentication_Migration">20.2. Properties Based Authentication / Authorization</a></li>
<li><a href="#LDAP_Based_Authentication_Migration">20.3. LDAP Authentication Migration</a></li>
<li><a href="#Composite_Stores_Migration">20.4. Composite Stores Migration</a></li>
<li><a href="#Database_Authentication_Migration">20.5. Database Authentication</a></li>
<li><a href="#Kerberos_Based_Authentication_Migration">20.6. Kerberos Authentication Migration</a></li>
<li><a href="#Caching_Migration">20.7. Caching Migration</a></li>
<li><a href="#_clients">20.8. Clients</a></li>
<li><a href="#Application_Client_Migration">20.9. Application Client Migration</a></li>
</ul>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="about"><a class="anchor" href="#about"></a>1. About</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The WildFly Elytron project is a new security framework brought to
WildFly to provide a single unified security framework across the whole
of the application server. As a single framework it will be usable both
for configuring management access to the server and for applications
deployed to the server, it will also be usable across all process types
so there will be no need to learn a different security framework for
host controllers in a domain compared to configuring a standalone
server.</p>
</div>
<div class="paragraph">
<p>The project covers these main areas:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Authentication</p>
</li>
<li>
<p>Authorization</p>
</li>
<li>
<p>SSL / TLS</p>
</li>
<li>
<p>Secure Credential Storage</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="elytron-authentication"><a class="anchor" href="#elytron-authentication"></a>1.1. Authentication</h3>
<div class="paragraph">
<p>One of the fundamental objectives of the project was to ensure that we
can use stronger authentication mechanisms for both HTTP and SASL based
authentication, in both cases the new framework also makes it possible
to bring in new implementations opening up various integration
opportunities with external solutions.</p>
</div>
</div>
<div class="sect2">
<h3 id="elytron-authorization"><a class="anchor" href="#elytron-authorization"></a>1.2. Authorization</h3>
<div class="paragraph">
<p>The architecture of the project makes a very clear distinction between
the raw representation of the identity as returned by a SecurityRealm
from the repository of identities and the final representation as a
SecurityIdentity after roles have been decoded and mapped and
permissions have been mapped.</p>
</div>
<div class="paragraph">
<p>Custom implementations of the components to perform role decoding and
mapping, and permission mapping can be provided allowing for further
flexibility beyond the default set of components provided by the
project.</p>
</div>
</div>
<div class="sect2">
<h3 id="about-ssl-tls"><a class="anchor" href="#about-ssl-tls"></a>1.3. SSL / TLS</h3>
<div class="paragraph">
<p>The project becomes the centralised point within the application server
for configuring SSL related resources meaning they can be configured in
a central location and referenced by resources across the application
server. The centralised configuration also covers advanced options such
as configuration of enabled cipher suites and protocols without this
information needing to be distributed across the management model.</p>
</div>
<div class="paragraph">
<p>The SSL / TLS implementation also includes an optimisation where it can
be closely tied to authentication allowing for permissions checks to be
performed on establishment of a connection before the first request is
received and the eager construction of a SecurityIdentity eliminating
the need for it to be constructed on a per-request basis.</p>
</div>
</div>
<div class="sect2">
<h3 id="secure-credential-storage"><a class="anchor" href="#secure-credential-storage"></a>1.4. Secure Credential Storage</h3>
<div class="paragraph">
<p>The previous vault used for plain text String encryption is replaced
with a newly designed credential store. in addition to the protection it
offers for the credentials stored within it, the store currently
supports storage of clear text credentials.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="General_Elytron_Architecture"><a class="anchor" href="#General_Elytron_Architecture"></a>2. General Elytron Architecture</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The overall architecture for WildFly Elytron is building up a full
security policy from assembling smaller components together, by default
we include various implementations of the components - in addition to
this, custom implementations of many components can be provided in order
to provide more specialised implementations.</p>
</div>
<div class="paragraph">
<p>Within WildFly the different Elytron components are handled as
capabilities meaning that different implementations can be mixed and
matched, however the different implementations are modelled using
distinct resources. This section contains a number of diagrams to show
the general relationships between different components to provide a high
level view, however the different resource definitions may use different
dependencies depending on their purpose.</p>
</div>
<div class="sect2">
<h3 id="security-domains"><a class="anchor" href="#security-domains"></a>2.1. Security Domains</h3>
<div class="paragraph">
<p>Within WildFly Elytron a SecurityDomain can be considered as a security
policy backed by one or more SecurityRealm instances. Resources that
make authorization decisions will be associated with a SecurityDomain,
from the SecurityDomain a SecurityIdentity can be obtained which is a
representation of the current identity, from this the identities roles
and permissions can be checked to make the authorization decision for
the resource.</p>
</div>
<div class="paragraph">
<p>The SecurityDomain is the general wrapper around the policy describing a
resulting SecurityIdentity and makes use of the following components to
define this policy.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>NameRewriter</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>NameRewriters are used in multiple places within the Elytron
configuration, as their name implies, their purpose is to take a name
and map it to another representation of the name or perform some
normalisation or clean up of the name.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>RealmMapper</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>As a SecurityDomain is able to reference multiple SecurityRealms the
RealmMapper is responsible for identifying which SecurityRealm to use
based on the supplied name for authentication.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>SecurityRealm</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>One more named SecurityRealms are associated with a SecurityDomain,
the SecurityRealms are the access to the underlying repository of
identities and are used for obtaining credentials to allow
authentication mechanisms to perform verification, for validation of
Evidence and for obtaining the raw AuthorizationIdentity performing the
authentication.</p>
</div>
<div class="paragraph">
<p>Some SecurityRealm implementations are also modifiable so expose an API
that allows for updates to be made to the repository containing the
identities.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>RoleDecoder</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Along with the SecurityRealm association is also a reference to a
RoleDecoder, the RoleDecoder takes the raw AuthorizationIdentity
returned from the SecurityRealm and converts its attributes into roles.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>RoleMapper</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>After the roles have been decoded for an identity further mapping can be
applied, this could be as simple at normalising the format of the names
through to adding or removing specific role names. If a RoleMapper is
referenced by the SecurityRealm association that RoleMapper is applied
first before applying the RoleMapper associated with the SecurityDomain.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>PrincipalDecoder</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>A PrincipalDecoder converts from a Principal to a String representation
of a name, one example for this is we have an X500PrincipalDecoder which
is able to extract an attribute from a distinguished name.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>PermissionMapper</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In addition to having roles a SecurityIdentity can also have a set of
permissions, the PermissionMapper assigns those permissions to the
identity.</p>
</div>
<div class="paragraph">
<p>Different secured resources can be associated with different
SecurityDomains for their authorization decisions, within WildFly
Elytron we have the ability to configure inflow between different
SecurityDomains. The inflow process means that a SecurityIdentity
inflowed into a second SecurityDomain has the mappings of the new
SecurityDomain applied to it so although a common identity may be
calling different resources each of those resources could have a very
different view.</p>
</div>
</div>
<div class="sect2">
<h3 id="sasl-authentication"><a class="anchor" href="#sasl-authentication"></a>2.2. SASL Authentication</h3>
<div class="paragraph">
<p>The SaslAuthenticationFactory is an authentication policy for
authentication using SASL authentication mechanisms, in addition to
being a policy it is also a factory for configured authentication
mechanisms backed by a SecurityDomain.</p>
</div>
<div class="paragraph">
<p>The SaslAuthenticationFactory references the following: -</p>
</div>
<div class="ulist">
<ul>
<li>
<p>SecurityDomain</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This is the security domain that any mechanism authentication will be
performed against.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>SaslServerFactory</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This is the general factory for server side SASL authentication
mechanisms.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>MechanismConfigurationSelector</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Additional configuration can be supplied for the authentication
mechanisms, the configuration will be described in more detail later but
the purpose of the MechanismConfigurationSelector is to obtain
configuration specific to the mechanism selected. This can include
information about realm names a mechanism should present to a remote
client plus additional NameRewriters and RealmMappers to use during the
authentication process.</p>
</div>
<div class="paragraph">
<p>The reason some components referenced by the SecurityDomain are
duplicated is so that mechanism specific mappings can be applied.</p>
</div>
</div>
<div class="sect2">
<h3 id="http-authentication"><a class="anchor" href="#http-authentication"></a>2.3. HTTP Authentication</h3>
<div class="paragraph">
<p>The HttpAuthenticationFactory is an authentication policy for
authentication using HTTP authentication mechanisms, including the BASIC,
DIGEST, EXTERNAL, FORM, SPNEGO, and CLIENT_CERT mechanisms. In addition to
being a policy, it is also a factory for configured authentication
mechanisms backed by a SecurityDomain.</p>
</div>
<div class="paragraph">
<p>The HttpAuthenticationFactory references the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>SecurityDomain</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This is the security domain that any mechanism authentication will be
performed against.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>HttpServerAuthenticationMechanismFactory</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This is the general factory for server side HTTP authentication
mechanisms.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>MechanismConfigurationSelector</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Additional configuration can be supplied for the authentication
mechanisms, the configuration will be described in more detail later but
the purpose of the <code>MechanismConfigurationSelector</code> is to obtain
configuration specific to the mechanism selected. This can include
information about realm names a mechanism should present to a remote
client plus additional NameRewriters and RealmMappers to use during the
authentication process.</p>
</div>
<div class="paragraph">
<p>The reason some components referenced by the SecurityDomain are
duplicated is so that mechanism specific mappings can be applied.</p>
</div>
</div>
<div class="sect2">
<h3 id="ssl-tls"><a class="anchor" href="#ssl-tls"></a>2.4. SSL / TLS</h3>
<div class="paragraph">
<p>The SSLContext defined within Elytron is a <code>javax.net.ssl.SSLContext</code>
meaning it can be used by anything that uses an SSLContext directly.</p>
</div>
<div class="paragraph">
<p>In addition to the usual configuration for an SSLContext it is possible
to configure additional items such as cipher suites and protocols and
the SSLContext returned will wrap any engines created to set these
values.</p>
</div>
<div class="paragraph">
<p>The SSLContext within Elytron can also reference the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>KeyManagers</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>An array of KeyManager instances to be used by the SSLContext, this in
turn can reference a KeyStore to load the keys.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>TrustManagers</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>An array of TrustManager instances to be used by the SSLContext, this in
turn can also reference a KeyStore to load the certificates.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>SecurityDomain</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This is optional, however if an SSLContext is configured to reference a
SecurityDomain then verification of a client&#8217;s certificate can be
performed as an authentication ensuring the appropriate permissions to
Logon are assigned before even allowing the connection to be fully
opened, additionally the SecurityIdentity can be established at the time
the connection is opened and used for any invocations over the
connection.</p>
</div>
</div>
<div class="sect2">
<h3 id="Passwords"><a class="anchor" href="#Passwords"></a>2.5. Passwords</h3>
<div class="paragraph">
<p>One of the core features of WildFly Elytron is the ability to work with many different formats for representing passwords, WildFly Elytron also contains APIs that can be used to convert from clear text passwords to these representations that can be stored in the underlying identity stores.</p>
</div>
<div class="paragraph">
<p>This section will document how these APIs can be used to work with the different password types.</p>
</div>
<div class="sect3">
<h4 id="_passwordfactory"><a class="anchor" href="#_passwordfactory"></a>2.5.1. PasswordFactory</h4>
<div class="paragraph">
<p>Working with passwords will require interaction with the <code>org.wildfly.security.password.PasswordFactory</code> API, this obtains access to implementations from <code>java.security.Provider</code> instances, there are two different ways these can be identified: -</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>By querying the globally installed Providers</p>
</li>
<li>
<p>By passing in the <code>Provider</code> to the <code>getInstance</code> method of the <code>PasswordFactory</code> API.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>In both cases the WildFly Elytron implementations are provided by the <code>org.wildfly.security.WildFlyElytronProvider</code> provider.</p>
</div>
<div class="paragraph">
<p>When relying on the Provider being globally registered the <code>PasswordFactory</code> for a specific algorithm can be obtained as: -</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">PasswordFactory passwordFactory = PasswordFactory.getInstance(algorithm);</code></pre>
</div>
</div>
<div class="paragraph">
<p>However an alternative approach could be to manually instantiate the Provider and pass it in when obtaining an instance of the <code>PasswordFactory</code>: -</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">static final Provider ELYTRON_PROVIDER = new WildFlyElytronProvider();
...
PasswordFactory passwordFactory = PasswordFactory.getInstance(algorithm, ELYTRON_PROVIDER);</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_clear_password"><a class="anchor" href="#_clear_password"></a>2.5.2. Clear Password</h4>
<div class="paragraph">
<p>The simplest type of <code>Password</code> to obtain from the <code>PasswordFactory</code> is a clear text password, the following code illustrates how this can be obtained.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">static final Provider ELYTRON_PROVIDER = new WildFlyElytronProvider();
static final String TEST_PASSWORD = "test_password";

public static void main(String[] args) throws Exception {
    PasswordFactory passwordFactory = PasswordFactory.getInstance(ClearPassword.ALGORITHM_CLEAR, ELYTRON_PROVIDER);

    ClearPasswordSpec passwordSpec = new ClearPasswordSpec(TEST_PASSWORD.toCharArray());
    Password password = passwordFactory.generatePassword(passwordSpec);

    System.out.println(String.format("Password Verified '%b'", passwordFactory.verify(password, TEST_PASSWORD.toCharArray())));
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>A second approach is to obtain a raw representation of the <code>ClearPassword</code>, however this will need to be translated into the <code>PasswordFactory</code> if it will be used for evidence validation but if the <code>Password</code> is not being used for verification this can be a suitable alternative provided the parameters have been pre-verified.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">static final Provider ELYTRON_PROVIDER = new WildFlyElytronProvider();
static final String TEST_PASSWORD = "test_password";

public static void main(String[] args) throws Exception {
    PasswordFactory passwordFactory = PasswordFactory.getInstance(ClearPassword.ALGORITHM_CLEAR, ELYTRON_PROVIDER);

    Password rawPassword = ClearPassword.createRaw(ClearPassword.ALGORITHM_CLEAR, TEST_PASSWORD.toCharArray());

    Password password = passwordFactory.translate(rawPassword);

    System.out.println(String.format("Password Verified '%b'", passwordFactory.verify(password, TEST_PASSWORD.toCharArray())));
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The raw password can be used for other areas of the Elytron APIs however if it is used for validation an error similar to the following will be thrown.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">Exception in thread "main" java.security.InvalidKeyException
    at org.wildfly.security.password.impl.PasswordFactorySpiImpl.engineVerify(PasswordFactorySpiImpl.java:762)
    at org.wildfly.security.password.PasswordFactory.verify(PasswordFactory.java:210)
[source,java]</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="simple-digest"><a class="anchor" href="#simple-digest"></a>2.5.3. Simple Digest</h4>
<div class="paragraph">
<p>The next type of password is the simple digest, for this password type the clear text password id digested using the specified algorithm however no salt is used.</p>
</div>
<div class="paragraph">
<p>The following algorithms are applicable to this type of encoding.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>simple-digest-md2</p>
</li>
<li>
<p>simple-digest-md5</p>
</li>
<li>
<p>simple-digest-sha-1</p>
</li>
<li>
<p>simple-digest-sha-256</p>
</li>
<li>
<p>simple-digest-sha-384</p>
</li>
<li>
<p>simple-digest-sha-512</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The following example illustrates how the <code>Password</code> instance can be created starting from the clear text password,from this the digested representation of the password can be obtained which could be used to store the password.  The digested representation is then used to create a further <code>Password</code> instance.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">static final Provider ELYTRON_PROVIDER = new WildFlyElytronProvider();
static final String TEST_PASSWORD = "test_password";

public static void main(String[] args) throws Exception {
    PasswordFactory passwordFactory = PasswordFactory.getInstance(SimpleDigestPassword.ALGORITHM_SIMPLE_DIGEST_SHA_512, ELYTRON_PROVIDER);

    ClearPasswordSpec clearSpec = new ClearPasswordSpec(TEST_PASSWORD.toCharArray());
    SimpleDigestPassword original = (SimpleDigestPassword) passwordFactory.generatePassword(clearSpec);

    byte[] digest = original.getDigest();
    HashPasswordSpec hashSpec = new HashPasswordSpec(digest);

    SimpleDigestPassword restored = (SimpleDigestPassword) passwordFactory.generatePassword(hashSpec);

    System.out.println(String.format("Password Verified '%b'", passwordFactory.verify(restored, TEST_PASSWORD.toCharArray())));
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Starting from the digest the raw APIs can be used as.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">SimpleDigestPassword rawPassword = SimpleDigestPassword.createRaw(SimpleDigestPassword.ALGORITHM_SIMPLE_DIGEST_SHA_512, digest);

SimpleDigestPassword restored = (SimpleDigestPassword) passwordFactory.translate(rawPassword);

System.out.println(String.format("Password Verified '%b'", passwordFactory.verify(restored, TEST_PASSWORD.toCharArray())));</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="salted-digest"><a class="anchor" href="#salted-digest"></a>2.5.4. Salted Digest</h4>
<div class="paragraph">
<p>Two variations of salted digests are supported, these can either be digested with the salt first or the password first.  The following algorithms are supported: -</p>
</div>
<div class="ulist">
<ul>
<li>
<p>password-salt-digest-md5</p>
</li>
<li>
<p>password-salt-digest-sha-1</p>
</li>
<li>
<p>password-salt-digest-sha-256</p>
</li>
<li>
<p>password-salt-digest-sha-384</p>
</li>
<li>
<p>password-salt-digest-sha-512</p>
</li>
<li>
<p>salt-password-digest-md5</p>
</li>
<li>
<p>salt-password-digest-sha-1</p>
</li>
<li>
<p>salt-password-digest-sha-256</p>
</li>
<li>
<p>salt-password-digest-sha-384</p>
</li>
<li>
<p>salt-password-digest-sha-512</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The following example shows how using a generated salt the password can be created from a clear text password and then subsequently how the password can be recreated from the salt and digest.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">static final Provider ELYTRON_PROVIDER = new WildFlyElytronProvider();
static final String TEST_PASSWORD = "test_password";

public static void main(String[] args) throws Exception {
    PasswordFactory passwordFactory = PasswordFactory.getInstance(SaltedSimpleDigestPassword.ALGORITHM_PASSWORD_SALT_DIGEST_SHA_512, ELYTRON_PROVIDER);

    byte[] salt = new byte[32];
    SecureRandom random = new SecureRandom();
    random.nextBytes(salt);

    SaltedPasswordAlgorithmSpec saltedSpec = new SaltedPasswordAlgorithmSpec(salt);
    EncryptablePasswordSpec encryptableSpec = new EncryptablePasswordSpec(TEST_PASSWORD.toCharArray(), saltedSpec);

    SaltedSimpleDigestPassword original = (SaltedSimpleDigestPassword) passwordFactory.generatePassword(encryptableSpec);

    byte[] digest = original.getDigest();

    SaltedHashPasswordSpec saltedHashSpec = new SaltedHashPasswordSpec(digest, salt);

    SaltedSimpleDigestPassword restored = (SaltedSimpleDigestPassword) passwordFactory.generatePassword(saltedHashSpec);

    System.out.println(String.format("Password Verified '%b'", passwordFactory.verify(restored, TEST_PASSWORD.toCharArray())));
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Alternatively the salt could be generated automatically by using a <code>ClearPasswordSpec</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">ClearPasswordSpec clearSpec = new ClearPasswordSpec(TEST_PASSWORD.toCharArray());
SaltedSimpleDigestPassword original = (SaltedSimpleDigestPassword) passwordFactory.generatePassword(clearSpec);

byte[] salt = original.getSalt();
byte[] digest = original.getDigest();</code></pre>
</div>
</div>
<div class="paragraph">
<p>Starting with the digest and salt the raw APIs can also be used.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">SaltedSimpleDigestPassword rawPassword = SaltedSimpleDigestPassword.createRaw(SaltedSimpleDigestPassword.ALGORITHM_PASSWORD_SALT_DIGEST_SHA_512, digest, salt);

SaltedSimpleDigestPassword restored = (SaltedSimpleDigestPassword) passwordFactory.translate(rawPassword);

System.out.println(String.format("Password Verified '%b'", passwordFactory.verify(restored, TEST_PASSWORD.toCharArray())));</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_digest"><a class="anchor" href="#_digest"></a>2.5.5. Digest</h4>
<div class="paragraph">
<p>The Digest passwords are an alternative form of digest where the username, realm and password are digested together delimited with a ':', these are usable with clear text authentication mechanisms but also usable with the digest authentication mechanisms also eliminating the transmission of clear text passwords during authentication.  The following algorithms are supported: -</p>
</div>
<div class="ulist">
<ul>
<li>
<p>digest-md5</p>
</li>
<li>
<p>digest-sha</p>
</li>
<li>
<p>digest-sha-256</p>
</li>
<li>
<p>digest-sha-384</p>
</li>
<li>
<p>digest-sha-512</p>
</li>
<li>
<p>digest-sha-512-256</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The following example illustrates how a password can be created from the username, realm, and password and then how it can be recreated from the digest, realm, and password.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">static final Provider ELYTRON_PROVIDER = new WildFlyElytronProvider();
static final String TEST_USERNAME = "test_username";
static final String TEST_REALM = "Test Realm";
static final String TEST_PASSWORD = "test_password";

public static void main(String[] args) throws Exception {
    PasswordFactory passwordFactory = PasswordFactory.getInstance(DigestPassword.ALGORITHM_DIGEST_MD5, ELYTRON_PROVIDER);

    DigestPasswordAlgorithmSpec digestAlgorithmSpec = new DigestPasswordAlgorithmSpec(TEST_USERNAME, TEST_REALM);
    EncryptablePasswordSpec encryptableSpec = new EncryptablePasswordSpec(TEST_PASSWORD.toCharArray(), digestAlgorithmSpec);

    DigestPassword original = (DigestPassword) passwordFactory.generatePassword(encryptableSpec);

    byte[] digest = original.getDigest();

    DigestPasswordSpec digestPasswordSpec = new DigestPasswordSpec(TEST_USERNAME, TEST_REALM, digest);

    DigestPassword restored = (DigestPassword) passwordFactory.generatePassword(digestPasswordSpec);

    System.out.println(String.format("Password Verified '%b'", passwordFactory.verify(restored, TEST_PASSWORD.toCharArray())));
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>For this password type is not possible to create the password from the <code>ClearPasswordSpec</code> as additional information always needs to be specified and can not be dynamically or randomly generated, however the raw APIs can still be used.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">DigestPassword rawPassword = DigestPassword.createRaw(DigestPassword.ALGORITHM_DIGEST_MD5, TEST_USERNAME, TEST_REALM, digest);

DigestPassword restored = (DigestPassword) passwordFactory.translate(rawPassword);

System.out.println(String.format("Password Verified '%b'", passwordFactory.verify(restored, TEST_PASSWORD.toCharArray())));</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="scram"><a class="anchor" href="#scram"></a>2.5.6. SCRAM</h4>
<div class="paragraph">
<p>Another set of passwords more tightly tied to a specific authentication mechanism are the SCRAM password types, the following algorithms are supported: -</p>
</div>
<div class="ulist">
<ul>
<li>
<p>scram-sha-1</p>
</li>
<li>
<p>scram-sha-256</p>
</li>
<li>
<p>scram-sha-384</p>
</li>
<li>
<p>scram-sha-512</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The following demonstrates how a clear password can be converted to a scram password using a specified salt and iteration count and how this can be recreated from the digested value.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">static final Provider ELYTRON_PROVIDER = new WildFlyElytronProvider();

static final String TEST_PASSWORD = "test_password";

public static void main(String[] args) throws Exception {
    PasswordFactory passwordFactory = PasswordFactory.getInstance(ScramDigestPassword.ALGORITHM_SCRAM_SHA_512, ELYTRON_PROVIDER);

    byte[] salt = new byte[12];
    SecureRandom random = new SecureRandom();
    random.nextBytes(salt);

    IteratedSaltedPasswordAlgorithmSpec iteratedAlgorithmSpec = new IteratedSaltedPasswordAlgorithmSpec(2000, salt);
    EncryptablePasswordSpec encryptableSpec = new EncryptablePasswordSpec(TEST_PASSWORD.toCharArray(), iteratedAlgorithmSpec);

    ScramDigestPassword original = (ScramDigestPassword) passwordFactory.generatePassword(encryptableSpec);

    byte[] digest = original.getDigest();

    IteratedSaltedHashPasswordSpec scramPasswordSpec = new IteratedSaltedHashPasswordSpec(digest, salt, 2000);

    ScramDigestPassword restored = (ScramDigestPassword) passwordFactory.generatePassword(scramPasswordSpec);

    System.out.println(String.format("Password Verified '%b'", passwordFactory.verify(restored, TEST_PASSWORD.toCharArray())));
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Alternatively instead of using the <code>IteratedSaltedPasswordAlgorithmSpec</code> is it also possible to use a <code>SaltedPasswordAlgorithmSpec</code> when converting from the clear text password and a default iteration count will be used instead, this is similar to how the conversion happens for <a href="#salted-digest">salted digest</a> passwords.</p>
</div>
<div class="paragraph">
<p>It is also possible to omit the salt and iteration count and these will be generated.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">ClearPasswordSpec clearSpec = new ClearPasswordSpec(TEST_PASSWORD.toCharArray());

ScramDigestPassword original = (ScramDigestPassword) passwordFactory.generatePassword(clearSpec);

byte[] salt = original.getSalt();
byte[] digest = original.getDigest();
int iterationCount = original.getIterationCount();</code></pre>
</div>
</div>
<div class="paragraph">
<p>Starting with a digest, salt, and iteration count the raw APIs can also be used.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">ScramDigestPassword rawPassword = ScramDigestPassword.createRaw(ScramDigestPassword.ALGORITHM_SCRAM_SHA_256, digest, salt, 2000);

ScramDigestPassword restored = (ScramDigestPassword) passwordFactory.translate(rawPassword);

System.out.println(String.format("Password Verified '%b'", passwordFactory.verify(restored, TEST_PASSWORD.toCharArray())));</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_otp"><a class="anchor" href="#_otp"></a>2.5.7. OTP</h4>
<div class="paragraph">
<p>One more type of mechanism specific password is the one time password type.  The following algorithms are supported: -</p>
</div>
<div class="ulist">
<ul>
<li>
<p>otp-md5</p>
</li>
<li>
<p>otp-sha1</p>
</li>
<li>
<p>otp-sha256</p>
</li>
<li>
<p>otp-sha384</p>
</li>
<li>
<p>otp-sha512</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The following demonstrates how a clear password can be converted to a one time password using a specified seed and iteration count and how this can be recreated from the hashed value.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">static final Provider ELYTRON_PROVIDER = new WildFlyElytronProvider();
static final String TEST_PASSWORD = "test_password";

public static void main(String[] args) throws Exception {
    PasswordFactory passwordFactory = PasswordFactory.getInstance(OneTimePassword.ALGORITHM_OTP_SHA_512, ELYTRON_PROVIDER);

    String seed = "ke1234";
    int sequenceNumber = 500;

    OneTimePasswordAlgorithmSpec oneTimeAlgorithmSpec = new OneTimePasswordAlgorithmSpec(OneTimePassword.ALGORITHM_OTP_SHA_512, seed, sequenceNumber);
    EncryptablePasswordSpec encryptableSpec = new EncryptablePasswordSpec(TEST_PASSWORD.toCharArray(), oneTimeAlgorithmSpec);

    OneTimePassword original = (OneTimePassword) passwordFactory.generatePassword(encryptableSpec);

    byte[] hash = original.getHash();

    OneTimePasswordSpec oneTimeSpec = new OneTimePasswordSpec(hash, seed, sequenceNumber);

    OneTimePassword restored = (OneTimePassword) passwordFactory.generatePassword(oneTimeSpec);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This example does not include verification as that is handled by the SASL mechanism which also increments the sequence and replaces the hash, this does mean this password type needs to be used with a security realm which also supports updates.</p>
</div>
<div class="paragraph">
<p>Starting with the hash and sequence number the raw APIs can also be used.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">OneTimePassword rawPassword = OneTimePassword.createRaw(OneTimePassword.ALGORITHM_OTP_SHA_512, original.getHash(), original.getSeed(), original.getSequenceNumber());

OneTimePassword restored = (OneTimePassword) passwordFactory.translate(rawPassword);</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="bcrypt"><a class="anchor" href="#bcrypt"></a>2.5.8. Other Iterated Salted Types</h4>
<div class="paragraph">
<p>The following algorithms are also supported for alternative iterated salted password types: -</p>
</div>
<div class="ulist">
<ul>
<li>
<p>bcrypt</p>
</li>
<li>
<p>sun-crypt-md5</p>
</li>
<li>
<p>sun-crypt-md5-bare-salt</p>
</li>
<li>
<p>crypt-sha-256</p>
</li>
<li>
<p>crypt-sha-512</p>
</li>
<li>
<p>bsd-crypt-des</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The general pattern for working with these password types is the same as was used for <a href="#scram">Scram</a> password types if an interaction count is specified or the same as <a href="#salted-digest">salted digest</a> password types if a default iteration count is to be used instead.</p>
</div>
</div>
<div class="sect3">
<h4 id="_other_salted_types"><a class="anchor" href="#_other_salted_types"></a>2.5.9. Other Salted Types</h4>
<div class="paragraph">
<p>The following algorithms are also supported for salted password types: -</p>
</div>
<div class="ulist">
<ul>
<li>
<p>crypt-md5</p>
</li>
<li>
<p>crypt-des</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The general pattern for working with these password types is the same as was used for <a href="#salted-digest">salted digest</a> password types as no iteration count is required.</p>
</div>
</div>
<div class="sect3">
<h4 id="_masked_password_types"><a class="anchor" href="#_masked_password_types"></a>2.5.10. Masked Password Types</h4>
<div class="paragraph">
<p>Finally a set of masked password types are also supported to add support for legacy password types which were previously supported within PicketBox, the following algorithms are supported.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>masked-MD5-DES</p>
</li>
<li>
<p>masked-MD5-DES-CBC-PKCS5</p>
</li>
<li>
<p>masked-MD5-3DES</p>
</li>
<li>
<p>masked-MD5-3DES-CBC-PKCS5</p>
</li>
<li>
<p>masked-SHA1-DES-EDE</p>
</li>
<li>
<p>masked-SHA1-DES-EDE-CBC-PKCS5</p>
</li>
<li>
<p>masked-SHA1-RC2-40</p>
</li>
<li>
<p>masked-SHA1-RC2-40-CBC-PKCS5</p>
</li>
<li>
<p>masked-SHA1-RC2-128</p>
</li>
<li>
<p>masked-SHA1-RC2-128-CBC-PKCS5</p>
</li>
<li>
<p>masked-SHA1-RC4-40</p>
</li>
<li>
<p>masked-SHA1-RC4-40-ECB</p>
</li>
<li>
<p>masked-SHA1-RC4-128</p>
</li>
<li>
<p>masked-SHA1-RC4-128-ECB</p>
</li>
<li>
<p>masked-HMAC-SHA1-AES-128</p>
</li>
<li>
<p>masked-HMAC-SHA224-AES-128</p>
</li>
<li>
<p>masked-HMAC-SHA256-AES-128</p>
</li>
<li>
<p>masked-HMAC-SHA384-AES-128</p>
</li>
<li>
<p>masked-HMAC-SHA512-AES-128</p>
</li>
<li>
<p>masked-HMAC-SHA1-AES-256</p>
</li>
<li>
<p>masked-HMAC-SHA224-AES-256</p>
</li>
<li>
<p>masked-HMAC-SHA256-AES-256</p>
</li>
<li>
<p>masked-HMAC-SHA384-AES-256</p>
</li>
<li>
<p>masked-HMAC-SHA512-AES-256</p>
</li>
<li>
<p>masked-PBKDF-HMAC-SHA1</p>
</li>
<li>
<p>masked-PBKDF-HMAC-SHA224</p>
</li>
<li>
<p>masked-PBKDF-HMAC-SHA256</p>
</li>
<li>
<p>masked-PBKDF-HMAC-SHA384</p>
</li>
<li>
<p>masked-PBKDF-HMAC-SHA512</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">static final Provider ELYTRON_PROVIDER = new WildFlyElytronProvider();

static final String TEST_PASSWORD = "test_password";

public static void main(String[] args) throws Exception {
    PasswordFactory passwordFactory = PasswordFactory.getInstance(MaskedPassword.ALGORITHM_MASKED_MD5_DES, ELYTRON_PROVIDER);

    char[] key = "my_secret_key".toCharArray();

    byte[] salt = new byte[8];
    SecureRandom random = new SecureRandom();
    random.nextBytes(salt);

    int iterationCount = 100;

    MaskedPasswordAlgorithmSpec maskedAlgorithmSpec = new MaskedPasswordAlgorithmSpec(key, iterationCount, salt);
    EncryptablePasswordSpec encryptableSpec = new EncryptablePasswordSpec(TEST_PASSWORD.toCharArray(), maskedAlgorithmSpec);

    MaskedPassword original = (MaskedPassword) passwordFactory.generatePassword(encryptableSpec);

    byte[] masked = original.getMaskedPasswordBytes();

    MaskedPasswordSpec maskedPasswordSpec = new MaskedPasswordSpec(key, iterationCount, salt, masked);

    MaskedPassword restored = (MaskedPassword) passwordFactory.generatePassword(maskedPasswordSpec);

    System.out.println(String.format("Password Verified '%b'", passwordFactory.verify(restored, TEST_PASSWORD.toCharArray())));
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>As with the other password types the raw password APIs can also be used to recreate the password.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">MaskedPassword rawPassword = MaskedPassword.createRaw(MaskedPassword.ALGORITHM_MASKED_MD5_DES, key, iterationCount, salt, masked);

MaskedPassword restored = (MaskedPassword) passwordFactory.translate(rawPassword);

System.out.println(String.format("Password Verified '%b'", passwordFactory.verify(restored, TEST_PASSWORD.toCharArray())));</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="modular-crypt"><a class="anchor" href="#modular-crypt"></a>2.5.11. Modular Crypt Encoding</h4>
<div class="paragraph">
<p>A number of password types can be encoded using modular crypt allowing information such as the password type, the hash or digest, the salt, and the iteration count to be encoded in a single String, this can make storage and retrieval of passwords easier as multiple pieces of related data can be handled as one.</p>
</div>
<div class="paragraph">
<p>Within the WildFly Elytron project the utility <code>org.wildfly.security.password.util.ModularCrypt</code> can be used to handle the encoding and decoding.</p>
</div>
<div class="paragraph">
<p>The following password types can be encoded and decoded: -</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>BCryptPassword</code></p>
</li>
<li>
<p><code>BSDUnixDESCryptPassword</code></p>
</li>
<li>
<p><code>UnixDESCryptPassword</code></p>
</li>
<li>
<p><code>UnixMD5CryptPassword</code></p>
</li>
<li>
<p><code>SunUnixMD5CryptPassword</code></p>
</li>
<li>
<p><code>UnixSHACryptPassword</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The following code demonstrates this for a <code>BSDUnixDESCryptPassword</code>: -</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">static final Provider ELYTRON_PROVIDER = new WildFlyElytronProvider();

static final String TEST_PASSWORD = "myPassword";

public static void main(String[] args) throws Exception {
    PasswordFactory passwordFactory = PasswordFactory.getInstance(BSDUnixDESCryptPassword.ALGORITHM_BSD_CRYPT_DES, ELYTRON_PROVIDER);

    int iterationCount = BSDUnixDESCryptPassword.DEFAULT_ITERATION_COUNT;

    byte[] salt = new byte[BSDUnixDESCryptPassword.BSD_CRYPT_DES_SALT_SIZE];
    SecureRandom random = new SecureRandom();
    random.nextBytes(salt);

    IteratedSaltedPasswordAlgorithmSpec iteratedAlgorithmSpec = new IteratedSaltedPasswordAlgorithmSpec(iterationCount, salt);
    EncryptablePasswordSpec encryptableSpec = new EncryptablePasswordSpec(TEST_PASSWORD.toCharArray(), iteratedAlgorithmSpec);

    BSDUnixDESCryptPassword original = (BSDUnixDESCryptPassword) passwordFactory.generatePassword(encryptableSpec);

    String modularCryptString = ModularCrypt.encodeAsString(original);

    Password rawPassword = ModularCrypt.decode(modularCryptString);

    BSDUnixDESCryptPassword restored = (BSDUnixDESCryptPassword) passwordFactory.translate(rawPassword);

    System.out.println(String.format("Password Verified '%b'", passwordFactory.verify(restored, TEST_PASSWORD.toCharArray())));
}</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The <code>Password</code> returned from the call to <code>ModularCrypt.decode(&#8230;&#8203;)</code> is a raw password so needs translating by the <code>PasswordFactory</code>.
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="Elytron_Subsystem"><a class="anchor" href="#Elytron_Subsystem"></a>3. Elytron Subsystem</h2>
<div class="sectionbody">
<div class="paragraph">
<p>WildFly Elytron is a security framework used to unify security across
the entire application server. The <em>elytron</em> subsystem enables a single
point of configuration for securing both applications and the management
interfaces. WildFly Elytron also provides a set of APIs and SPIs for
providing custom implementations of functionality and integrating with
the <em>elytron</em> subsystem.</p>
</div>
<div class="paragraph">
<p>In addition, there are several other important features of the WildFly
Elytron:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Stronger authentication mechanisms for HTTP and SASL authentication.</p>
</li>
<li>
<p>Improved architecture that allows for <em>SecurityIdentities</em> to be
propagated across security domains and transparently transformed ready
to be used for authorization. This transformation takes place using
configurable role decoders, role mappers, and permission mappers.</p>
</li>
<li>
<p>Centralized point for SSL/TLS configuration including cipher suites
and protocols.</p>
</li>
<li>
<p>SSL/TLS optimizations such as eager <em>SecureIdentity</em> construction and
closely tying authorization to establishing an SSL/TLS connection. Eager
<em>SecureIdentity</em> construction eliminates the need for a <em>SecureIdentity</em>
to be constructed on a per-request basis. Closely tying authentication
to establishing an SSL/TLS connection enables permission checks to
happen <em>BEFORE</em> the first request is received.</p>
</li>
<li>
<p>A secure credential store that replaces the previous vault
implementation to store clear text credentials.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The new <em>elytron</em> subsystem exists in parallel to the legacy <em>security</em>
subsystem and legacy core management authentication. Both the legacy and
Elytron methods may be used for securing the management interfaces as
well as providing security for applications.</p>
</div>
<div class="sect2">
<h3 id="get-started-using-the-elytron-subsystem"><a class="anchor" href="#get-started-using-the-elytron-subsystem"></a>3.1. Get Started using the Elytron Subsystem</h3>
<div class="paragraph">
<p>To get started using Elytron, refer to these topics:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Use the default Elytron components for
<a href="#default-application-authentication-configuration">application</a>
and
<a href="#default-management-authentication-configuration">management</a>
authentication</p>
</li>
<li>
<p>Secure an application with a new identity store stored in a
<a href="#configure-authentication-with-a-filesystem-based-identity-store">filesystem</a>
or
<a href="#configure-authentication-with-a-database-identity-store">database</a>.</p>
</li>
<li>
<p>Set up one-way SSL/TLS for
<a href="#enable-one-way-ssltls-for-applications">applications</a>
or the
<a href="#enable-one-way-ssltls-for-the-management-interfaces">management interfaces</a>.</p>
</li>
<li>
<p>Set up two-way SSL/TLS for
<a href="#enable-two-way-ssltls-in-wildfly-for-applications">applications</a>
or the
<a href="#enable-two-way-ssltls-for-the-management-interfaces">management interfaces</a>.</p>
</li>
<li>
<p><a href="#create-and-use-a-credential-store">Create a credential store and use it with your SSL/TLS configuration</a>.</p>
</li>
<li>
<p><a href="#configure-authentication-with-certificates">Use certificate-based authentication with applications</a>.</p>
</li>
<li>
<p><a href="#override-an-applications-authentication-configuration">Override an application&#8217;s authentication configuration</a>
with Elytron authentication.</p>
</li>
<li>
<p><a href="#configure-authentication-with-a-kerberos-based-identity-store">Configure Kerberos authentication for applications</a>.</p>
</li>
<li>
<p>Secure
<a href="#configure-authentication-with-an-ldap-based-identity-store">applications</a>
and the
<a href="#secure-the-management-interfaces-with-a-new-identity-store">management interfaces</a> with an LDAP-based identity store.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="provided-components"><a class="anchor" href="#provided-components"></a>3.2. Provided components</h3>
<div class="paragraph">
<p>WildFly Elytron provides a default set of implementations in the
<em>elytron</em> subsystem.</p>
</div>
<div class="sect3">
<h4 id="factories"><a class="anchor" href="#factories"></a>3.2.1. Factories</h4>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Component</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">aggregate-http-server-mechanism-factory</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">An HTTP server factory
definition where the HTTP server factory is an aggregation of other HTTP
server factories.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">aggregate-sasl-server-factory</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A SASL server factory definition where
the SASL server factory is an aggregation of other SASL server
factories.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">configurable-http-server-mechanism-factory</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A SASL server factory
definition where the SASL server factory is an aggregation of other SASL
server factories.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">configurable-sasl-server-factory</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A SASL server factory definition
where the SASL server factory is an aggregation of other SASL server
factories.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">custom-credential-security-factory</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A custom credential SecurityFactory
definition.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">http-authentication-factory</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Resource containing the association of a
security domain with a HttpServerAuthenticationMechanismFactory.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">kerberos-security-factory</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A security factory for obtaining a
GSSCredential for use during authentication.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">mechanism-provider-filtering-sasl-server-factory</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A SASL server factory
definition that enables filtering by provider where the factory was
loaded using a provider.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">provider-http-server-mechanism-factory</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">An HTTP server factory
definition where the HTTP server factory is an aggregation of factories
from the provider list.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">provider-sasl-server-factory</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A SASL server factory definition where
the SASL server factory is an aggregation of factories from the provider
list.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">sasl-authentication-factory</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Resource containing the association of a
security domain with a SaslServerFactory.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">service-loader-http-server-mechanism-factory</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">An HTTP server factory
definition where the HTTP server factory is an aggregation of factories
identified using a ServiceLoader</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">service-loader-sasl-server-factory</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A SASL server factory definition
where the SASL server factory is an aggregation of factories identified
using a ServiceLoader</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="principal-transformers"><a class="anchor" href="#principal-transformers"></a>3.2.2. Principal Transformers</h4>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Component</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">aggregate-principal-transformer</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A principal transformer definition
where the principal transformer is an aggregation of other principal
transformers.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">case-principal-transformer</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A principal transformer definition where
the principal is adjusted to upper or lower case.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">chained-principal-transformer</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A principal transformer definition where
the principal transformer is a chaining of other principal transformers.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">constant-principal-transformer</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A principal transformer definition
where the principal transformer always returns the same constant.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">custom-principal-transformer</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A custom principal transformer
definition.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">regex-principal-transformer</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A regular expression based principal
transformer</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">regex-validating-principal-transformer</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A regular expression based
principal transformer which uses the regular expression to validate the
name.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="principal-decoders"><a class="anchor" href="#principal-decoders"></a>3.2.3. Principal Decoders</h4>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Component</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">aggregate-principal-decoder</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A principal decoder definition where the
principal decoder is an aggregation of other principal decoders.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">concatenating-principal-decoder</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A principal decoder definition where
the principal decoder is a concatenation of other principal decoders.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">constant-principal-decoder</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Definition of a principal decoder that
always returns the same constant.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">custom-principal-decoder</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Definition of a custom principal decoder.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">x500-attribute-principal-decoder</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Definition of a X500 attribute based
principal decoder.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="evidence-decoders"><a class="anchor" href="#evidence-decoders"></a>3.2.4. Evidence Decoders</h4>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Component</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">x509-subject-alt-name-evidence-decoder</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">An evidence decoder that derives the
principal associated with a certificate chain from an X.509 subject alternative
name from the first certificate in the given chain.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">x500-subject-evidence-decoder</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">An evidence decoder that derives the principal
associated with a certificate chain from the subject from the first certificate
in the given chain.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">custom-evidence-decoder</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Definition of a custom evidence decoder.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">aggregate-evidence-decoder</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">An evidence decoder that is an aggregation of other
evidence decoders. Given evidence, these evidence decoders will be attempted in
order until one returns a non-null principal or until there are no more evidence
decoders left to try.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="realm-mappers"><a class="anchor" href="#realm-mappers"></a>3.2.5. Realm Mappers</h4>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Component</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">constant-realm-mapper</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Definition of a constant realm mapper that
always returns the same value.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">custom-realm-mapper</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Definition of a custom realm mapper</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">mapped-regex-realm-mapper</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Definition of a realm mapper implementation
that first uses a regular expression to extract the realm name, this is
then converted using the configured mapping of realm names.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">simple-regex-realm-mapper</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Definition of a simple realm mapper that
attempts to extract the realm name using the capture group from the
regular expression, if that does not provide a match then the delegate
realm mapper is used instead.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="realms"><a class="anchor" href="#realms"></a>3.2.6. Realms</h4>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Component</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#aggregate-security-realm">aggregate-realm</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A realm definition that is an aggregation of two
or more realms, one for the authentication steps and one or more for loading the
identity for the authorization steps and aggregating the resulting attributes.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">caching-realm</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A realm definition that enables caching to another
security realm. Caching strategy is Least Recently Used where least
accessed entries are discarded when maximum number of entries is
reached.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">custom-modifiable-realm</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Custom realm configured as being modifiable
will be expected to implement the ModifiableSecurityRealm interface. By
configuring a realm as being modifiable management operations will be
made available to manipulate the realm.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">custom-realm</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A custom realm definitions can implement either the s
SecurityRealm interface or the ModifiableSecurityRealm interface.
Regardless of which interface is implemented management operations will
not be exposed to manage the realm. However other services that depend
on the realm will still be able to perform a type check and cast to gain
access to the modification API.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#filesystem-security-realm">filesystem-realm</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A simple security realm definition backed by the
filesystem.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">identity-realm</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A security realm definition where identities are
represented in the management model.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#jdbc-security-realm">jdbc-realm</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A security realm definition backed by database using JDBC.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">key-store-realm</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A security realm definition backed by a keystore.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ldap-realm</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A security realm definition backed by LDAP.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">properties-realm</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A security realm definition backed by properties
files.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">token-realm</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A security realm definition capable of validating and
extracting identities from security tokens.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">distributed-realm</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A security realm definition for authentication and authorization identities distributed between multiple security realms.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">failover-realm</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A realm definition that is an aggregation of two realms, one for default behaviour and
second for cases when first realm is unavailable.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="permission-mappers"><a class="anchor" href="#permission-mappers"></a>3.2.7. Permission Mappers</h4>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Component</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">custom-permission-mapper</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Definition of a custom permission mapper.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">logical-permission-mapper</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Definition of a logical permission mapper.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">simple-permission-mapper</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Definition of a simple configured permission
mapper.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">constant-permission-mapper</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Definition of a permission mapper that
always returns the same constant.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="role-decoders"><a class="anchor" href="#role-decoders"></a>3.2.8. Role Decoders</h4>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Component</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">custom-role-decoder</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Definition of a custom RoleDecoder</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">simple-role-decoder</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Definition of a simple RoleDecoder that takes a
single attribute and maps it directly to roles.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">source-address-role-decoder</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Definition of a RoleDecoder that maps roles
based on the IP address of the remote client.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">aggregate-role-decoder</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A role decoder that is an aggregation of other
role decoders. An aggregate role decoder combines the roles obtained using
each role decoder.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="role-mappers"><a class="anchor" href="#role-mappers"></a>3.2.9. Role Mappers</h4>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Component</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">add-prefix-role-mapper</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A role mapper definition for a role mapper that
adds a prefix to each provided.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">add-suffix-role-mapper</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A role mapper definition for a role mapper that
adds a suffix to each provided.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">constant-role-mapper</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A role mapper definition where a constant set of
roles is always returned.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">aggregate-role-mapper</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A role mapper definition where the role mapper
is an aggregation of other role mappers.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">logical-role-mapper</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A role mapper definition for a role mapper that
performs a logical operation using two referenced role mappers.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">custom-role-mapper</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Definition of a custom role mapper</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">mapped-role-mapper</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A role mapper definition for a role mapper that uses
configured mapping of role names to map role names.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">regex-role-mapper</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A role mapper definition for a role mapper that
performs a regex matching and maps matching roles with provided pattern.
Regex can capture groups that replacement pattern can make use of.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="ssl-components"><a class="anchor" href="#ssl-components"></a>3.2.10. SSL Components</h4>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Component</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">client-ssl-context</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">An SSLContext for use on the client side of a
connection.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">filtering-key-store</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A filtering keystore definition, which provides a
keystore by filtering a key-store.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">key-manager</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A key manager definition for creating the key manager
list as used to create an SSL context.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">key-store</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A keystore definition.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ldap-key-store</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">An LDAP keystore definition, which loads a keystore
from an LDAP server.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">server-ssl-context</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">An SSL context for use on the server side of a
connection.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">trust-manager</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A trust manager definition for creating the
TrustManager list as used to create an SSL context.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">certificate-authority-account</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A certificate authority account which can
be used to obtain and revoke signed certificates.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="other"><a class="anchor" href="#other"></a>3.2.11. Other</h4>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Component</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">aggregate-providers</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">An aggregation of two or more Provider[]
resources.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">authentication-configuration</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">An individual authentication
configuration definition, which is used by clients deployed to WildFly
and other resources for authenticating when making a remote connection.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">authentication-context</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">An individual authentication context
definition, which is used to supply an ssl-context and
authentication-configuration when clients deployed to WildFly and other
resources make a remoting connection.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">credential-store</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Credential store to keep alias for sensitive
information such as passwords for external services.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">dir-context</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The configuration to connect to a directory (LDAP) server.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">provider-loader</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A definition for a provider loader.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">security-domain</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A security domain definition.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">security-property</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A definition of a security property to be set.</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect2">
<h3 id="out-of-the-box-configuration"><a class="anchor" href="#out-of-the-box-configuration"></a>3.3. Out of the Box Configuration</h3>
<div class="paragraph">
<p>WildFly provides a set of components configured by default. While these
components are ready to use, the legacy <em>security</em> subsystem and legacy
core management authentication is still used by default. To configure
WildFly to use the these configured components as well as create new
ones, see the <a href="#Using_the_Elytron_Subsystem">Using the Elytron
Subsystem</a> section.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Default Component</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ApplicationDomain</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The ApplicationDomain security domain uses
ApplicationRealm and groups-to-roles for authentication. It also uses
default-permission-mapper to assign the login permission.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ManagementDomain</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The ManagementDomain security domain uses two
security realms for authentication: ManagementRealm with groups-to-roles
and local with super-user-mapper. It also uses default-permission-mapper
to assign the login permission.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">local (security realm)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The local security realm does no authentication
and sets the identity of principals to $local</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ApplicationRealm</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The ApplicationRealm security realm is a properties
realm that authenticates principals using application-users.properties
and assigns roles using application-roles.properties. These files are
located under jboss.server.config.dir, which by default, maps to
EAP_HOME/standalone/configuration. They are also the same files used by
the legacy security default configuration.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ManagementRealm</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The ManagementRealm security realm is a properties
realm that authenticates principals using mgmt-users.properties and
assigns roles using mgmt-groups.properties. These files are located
under jboss.server.config.dir, which by default, maps to
EAP_HOME/standalone/configuration. They are also the same files used by
the legacy security default configuration.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">default-permission-mapper</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The default-permission-mapper mapper is a
simple permission mapper that uses the default-permissions permission set
to assign the full set of permissions that an identity would require to
access any services on the server. For example, the default-permission-mapper
mapper uses org.wildfly.extension.batch.jberet.deployment.BatchPermission
specified by the default-permissions permission set to assign permission for
batch jobs. The batch permissions are start, stop, restart, abandon, and read
which aligns with javax.batch.operations.JobOperator. The default-permission-mapper
mapper also uses org.wildfly.security.auth.permission.LoginPermission specified
by the the login-permission permission set to assign the login permission.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">local (mapper)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The local mapper is a constant role mapper that maps to
the local security realm. This is used to map authentication to the
local security realm.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">groups-to-roles</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The groups-to-roles mapper is a simple-role-decoder
that will decode the groups information of a principal and use it for
the role information.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">super-user-mapper</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The super-user-mapper mapper is a constant role
mapper that maps the SuperUser role to a principal.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">management-http-authentication</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The management-http-authentication
http-authentication-factory can be used for doing authentication over
http. It uses the global provider-http-server-mechanism-factory to
filter authentication mechanism and uses ManagementDomain for
authenticating principals. It accepts the DIGEST authentication
mechanisms and exposes it as ManagementRealm to applications.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">global (provider-http-server-mechanism-factory)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">This is the HTTP
server factory mechanism definition used to list the provided
authentication mechanisms when creating an http authentication factory.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">management-sasl-authentication</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The management-sasl-authentication
sasl-authentication-factory can be used for authentication using SASL.
It uses the configured sasl-server-factory to filter authentication
mechanisms, which also uses the global provider-sasl-server-factory to
filter by provider names. management-sasl-authentication uses the
ManagementDomain security domain for authentication of principals. It
also maps authentication using JBOSS-LOCAL-USER mechanisms using the
local realm mapper and authentication using DIGEST-MD5 to
ManagementRealm.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">application-sasl-authentication</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The application-sasl-authentication
sasl-authentication-factory can be used for authentication using SASL.
It uses the configured sasl-server-factory to filter authentication
mechanisms, which also uses the global provider-sasl-server-factory to
filter by provider names. application-sasl-authentication uses the
ApplicationDomain security domain for authentication of principals.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">global (provider-sasl-server-factory)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">This is the SASL server factory
definition used to create SASL authentication factories.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">elytron (mechanism-provider-filtering-sasl-server-factor)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">This is used
to filter which sasl-authentication-factory is used based on the
provider. In this case, elytron will match on the WildFlyElytron
provider name.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">configured (configurable-sasl-server-factory)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">This is used to filter
sasl-authentication-factory is used based on the mechanism name. In this
case, configured will match on JBOSS-LOCAL-USER and DIGEST-MD5. It also
sets the wildfly.sasl.local-user.default-user to $local.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">applicationSSC</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The <code>applicationSSC</code> server SSL context can be used
to automatically generate a self-signed certificate the first time
the HTTPS interface is accessed. This server SSL context should only
be used for testing purposes. It should never be used in a production
environment.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">combined-providers</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Is an aggregate provider that aggregates the elytron
and openssl provider loaders.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">elytron</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A provider loader</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">openssl</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A provider loader</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p><strong>Default WildFly Configuration</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-json hljs" data-lang="json">/subsystem=elytron:read-resource(recursive=true)
{
    "outcome" =&gt; "success",
    "result" =&gt; {
        "default-authentication-context" =&gt; undefined,
        "disallowed-providers" =&gt; ["OracleUcrypto"],
        "final-providers" =&gt; "combined-providers",
        "initial-providers" =&gt; undefined,
        "security-properties" =&gt; undefined,
        "add-prefix-role-mapper" =&gt; undefined,
        "add-suffix-role-mapper" =&gt; undefined,
        "aggregate-evidence-decoder" =&gt; undefined,
        "aggregate-http-server-mechanism-factory" =&gt; undefined,
        "aggregate-principal-decoder" =&gt; undefined,
        "aggregate-principal-transformer" =&gt; undefined,
        "aggregate-providers" =&gt; {"combined-providers" =&gt; {"providers" =&gt; [
            "elytron",
            "openssl"
        ]}},
        "aggregate-realm" =&gt; undefined,
        "aggregate-role-decoder" =&gt; undefined,
        "aggregate-role-mapper" =&gt; undefined,
        "aggregate-sasl-server-factory" =&gt; undefined,
        "aggregate-security-event-listener" =&gt; undefined,
        "authentication-configuration" =&gt; undefined,
        "authentication-context" =&gt; undefined,
        "caching-realm" =&gt; undefined,
        "case-principal-transformer" =&gt; undefined,
        "certificate-authority-account" =&gt; undefined,
        "chained-principal-transformer" =&gt; undefined,
        "client-ssl-context" =&gt; undefined,
        "concatenating-principal-decoder" =&gt; undefined,
        "configurable-http-server-mechanism-factory" =&gt; undefined,
        "configurable-sasl-server-factory" =&gt; {"configured" =&gt; {
            "filters" =&gt; undefined,
            "properties" =&gt; {"wildfly.sasl.local-user.default-user" =&gt; "$local"},
            "protocol" =&gt; undefined,
            "sasl-server-factory" =&gt; "elytron",
            "server-name" =&gt; undefined
        }},
        "constant-permission-mapper" =&gt; undefined,
        "constant-principal-decoder" =&gt; undefined,
        "constant-principal-transformer" =&gt; undefined,
        "constant-realm-mapper" =&gt; {"local" =&gt; {"realm-name" =&gt; "local"}},
        "constant-role-mapper" =&gt; {"super-user-mapper" =&gt; {"roles" =&gt; ["SuperUser"]}},
        "credential-store" =&gt; undefined,
        "custom-credential-security-factory" =&gt; undefined,
        "custom-evidence-decoder" =&gt; undefined,
        "custom-modifiable-realm" =&gt; undefined,
        "custom-permission-mapper" =&gt; undefined,
        "custom-principal-decoder" =&gt; undefined,
        "custom-principal-transformer" =&gt; undefined,
        "custom-realm" =&gt; undefined,
        "custom-realm-mapper" =&gt; undefined,
        "custom-role-decoder" =&gt; undefined,
        "custom-role-mapper" =&gt; undefined,
        "custom-security-event-listener" =&gt; undefined,
        "dir-context" =&gt; undefined,
        "file-audit-log" =&gt; {"local-audit" =&gt; {
            "format" =&gt; "JSON",
            "path" =&gt; "audit.log",
            "relative-to" =&gt; "jboss.server.log.dir",
            "synchronized" =&gt; true
        }},
        "filesystem-realm" =&gt; undefined,
        "filtering-key-store" =&gt; undefined,
        "http-authentication-factory" =&gt; {
            "management-http-authentication" =&gt; {
                "http-server-mechanism-factory" =&gt; "global",
                "mechanism-configurations" =&gt; [{
                    "mechanism-name" =&gt; "DIGEST",
                    "mechanism-realm-configurations" =&gt; [{"realm-name" =&gt; "ManagementRealm"}]
                }],
                "security-domain" =&gt; "ManagementDomain"
            }
        },
        "identity-realm" =&gt; {"local" =&gt; {
            "attribute-name" =&gt; undefined,
            "attribute-values" =&gt; undefined,
            "identity" =&gt; "$local"
        }},
        "jdbc-realm" =&gt; undefined,
        "kerberos-security-factory" =&gt; undefined,
        "key-manager" =&gt; {
            "applicationKM" =&gt; {
                "algorithm" =&gt; undefined,
                "alias-filter" =&gt; undefined,
                "credential-reference" =&gt; {"clear-text" =&gt; "password"},
                "generate-self-signed-certificate-host" =&gt; "localhost",
                "key-store" =&gt; "applicationKS",
                "provider-name" =&gt; undefined,
                "providers" =&gt; undefined
            }
        }
        "key-store" =&gt; {
            "applicationKS" =&gt; {
                "alias-filter" =&gt; undefined,
                "credential-reference" =&gt; {"clear-text" =&gt; "password"},
                "path" =&gt; "application.keystore",
                "relative-to" =&gt; "jboss.server.config.dir",
                "required" =&gt; false,
                "provider-name" =&gt; undefined,
                "providers" =&gt; undefined,
                "type" =&gt; "JKS"
            }
        },
        "key-store-realm" =&gt; undefined,
        "ldap-key-store" =&gt; undefined,
        "ldap-realm" =&gt; undefined,
        "logical-permission-mapper" =&gt; undefined,
        "logical-role-mapper" =&gt; undefined,
        "mapped-regex-realm-mapper" =&gt; undefined,
        "mapped-role-mapper" =&gt; undefined,
        "mechanism-provider-filtering-sasl-server-factory" =&gt; {"elytron" =&gt; {
            "enabling" =&gt; true,
            "filters" =&gt; [{"provider-name" =&gt; "WildFlyElytron"}],
            "sasl-server-factory" =&gt; "global"
        }},
        "periodic-rotating-file-audit-log" =&gt; undefined,
        "permission-set" =&gt; {
            "login-permission" =&gt; {"permissions" =&gt; [{"class-name" =&gt; "org.wildfly.security.auth.permission.LoginPermission"}]},
            "default-permissions" =&gt; {"permissions" =&gt; [
                {
                    "class-name" =&gt; "org.wildfly.extension.batch.jberet.deployment.BatchPermission",
                    "module" =&gt; "org.wildfly.extension.batch.jberet",
                    "target-name" =&gt; "*"
                },
                {
                    "class-name" =&gt; "org.wildfly.transaction.client.RemoteTransactionPermission",
                    "module" =&gt; "org.wildfly.transaction.client"
                },
                {
                    "class-name" =&gt; "org.jboss.ejb.client.RemoteEJBPermission",
                    "module" =&gt; "org.jboss.ejb-client"
                }
            ]}
        },
        "policy" =&gt; undefined,
        "properties-realm" =&gt; {
            "ApplicationRealm" =&gt; {
                "groups-attribute" =&gt; "groups",
                "groups-properties" =&gt; {
                    "path" =&gt; "application-roles.properties",
                    "relative-to" =&gt; "jboss.server.config.dir"
                },
                "users-properties" =&gt; {
                    "path" =&gt; "application-users.properties",
                    "relative-to" =&gt; "jboss.server.config.dir",
                    "digest-realm-name" =&gt; "ApplicationRealm"
                }
            },
            "ManagementRealm" =&gt; {
                "groups-attribute" =&gt; "groups",
                "groups-properties" =&gt; {
                    "path" =&gt; "mgmt-groups.properties",
                    "relative-to" =&gt; "jboss.server.config.dir"
                },
                "users-properties" =&gt; {
                    "path" =&gt; "mgmt-users.properties",
                    "relative-to" =&gt; "jboss.server.config.dir",
                    "digest-realm-name" =&gt; "ManagementRealm"
                }
            }
        },
        "provider-http-server-mechanism-factory" =&gt; {"global" =&gt; {"providers" =&gt; undefined}},
        "provider-loader" =&gt; {
            "elytron" =&gt; {
                "argument" =&gt; undefined,
                "class-names" =&gt; undefined,
                "configuration" =&gt; undefined,
                "module" =&gt; "org.wildfly.security.elytron",
                "path" =&gt; undefined,
                "relative-to" =&gt; undefined
            },
            "openssl" =&gt; {
                "argument" =&gt; undefined,
                "class-names" =&gt; undefined,
                "configuration" =&gt; undefined,
                "module" =&gt; "org.wildfly.openssl",
                "path" =&gt; undefined,
                "relative-to" =&gt; undefined
            }
        },
        "provider-sasl-server-factory" =&gt; {"global" =&gt; {"providers" =&gt; undefined}},
        "regex-role-mapper" =&gt; undefined,
        "regex-principal-transformer" =&gt; undefined,
        "regex-validating-principal-transformer" =&gt; undefined,
        "sasl-authentication-factory" =&gt; {
            "application-sasl-authentication" =&gt; {
                "mechanism-configurations" =&gt; [
                    {
                        "mechanism-name" =&gt; "JBOSS-LOCAL-USER",
                        "realm-mapper" =&gt; "local"
                    },
                    {
                        "mechanism-name" =&gt; "DIGEST-MD5",
                        "mechanism-realm-configurations" =&gt; [{"realm-name" =&gt; "ApplicationRealm"}]
                    }
                ],
                "sasl-server-factory" =&gt; "configured",
                "security-domain" =&gt; "ApplicationDomain"
            },
            "management-sasl-authentication" =&gt; {
                "mechanism-configurations" =&gt; [
                    {
                        "mechanism-name" =&gt; "JBOSS-LOCAL-USER",
                        "realm-mapper" =&gt; "local"
                    },
                    {
                        "mechanism-name" =&gt; "DIGEST-MD5",
                        "mechanism-realm-configurations" =&gt; [{"realm-name" =&gt; "ManagementRealm"}]
                    }
                ],
                "sasl-server-factory" =&gt; "configured",
                "security-domain" =&gt; "ManagementDomain"
            }
        },
        "security-domain" =&gt; {
            "ApplicationDomain" =&gt; {
                "default-realm" =&gt; "ApplicationRealm",
                "outflow-anonymous" =&gt; false,
                "outflow-security-domains" =&gt; undefined,
                "permission-mapper" =&gt; "default-permission-mapper",
                "post-realm-principal-transformer" =&gt; undefined,
                "pre-realm-principal-transformer" =&gt; undefined,
                "principal-decoder" =&gt; undefined,
                "realm-mapper" =&gt; undefined,
                "realms" =&gt; [
                    {
                        "realm" =&gt; "ApplicationRealm",
                        "role-decoder" =&gt; "groups-to-roles"
                    },
                    {"realm" =&gt; "local"}
                ],
                "role-mapper" =&gt; undefined,
                "security-event-listener" =&gt; undefined,
                "trusted-security-domains" =&gt; undefined
            },
            "ManagementDomain" =&gt; {
                "default-realm" =&gt; "ManagementRealm",
                "outflow-anonymous" =&gt; false,
                "outflow-security-domains" =&gt; undefined,
                "permission-mapper" =&gt; "default-permission-mapper",
                "post-realm-principal-transformer" =&gt; undefined,
                "pre-realm-principal-transformer" =&gt; undefined,
                "principal-decoder" =&gt; undefined,
                "realm-mapper" =&gt; undefined,
                "realms" =&gt; [
                    {
                        "realm" =&gt; "ManagementRealm",
                        "role-decoder" =&gt; "groups-to-roles"
                    },
                    {
                        "realm" =&gt; "local",
                        "role-mapper" =&gt; "super-user-mapper"
                    }
                ],
                "role-mapper" =&gt; undefined,
                "security-event-listener" =&gt; undefined,
                "trusted-security-domains" =&gt; undefined
            }
        },
        "server-ssl-context" =&gt; {
            "applicationSSC" =&gt; {
                "authentication-optional" =&gt; false,
                "cipher-suite-filter" =&gt; "DEFAULT",
                "cipher-suite-names" =&gt; undefined,
                "final-principal-transformer" =&gt; undefined,
                "key-manager" =&gt; "applicationKM",
                "maximum-session-cache-size" =&gt; -1,
                "need-client-auth" =&gt; false,
                "post-realm-principal-transformer" =&gt; undefined,
                "pre-realm-principal-transformer" =&gt; undefined,
                "protocols" =&gt; undefined,
                "provider-name" =&gt; undefined,
                "providers" =&gt; undefined,
                "realm-mapper" =&gt; undefined,
                "security-domain" =&gt; undefined,
                "session-timeout" =&gt; -1,
                "trust-manager" =&gt; undefined,
                "use-cipher-suites-order" =&gt; true,
                "want-client-auth" =&gt; false,
                "wrap" =&gt; false,
                "ssl-session" =&gt; undefined
            }
        },
        "service-loader-http-server-mechanism-factory" =&gt; undefined,
        "service-loader-sasl-server-factory" =&gt; undefined,
        "simple-permission-mapper" =&gt; {"default-permission-mapper" =&gt; {
            "mapping-mode" =&gt; "first",
            "permission-mappings" =&gt; [
                {
                    "principals" =&gt; ["anonymous"],
                    "permission-sets" =&gt; [{"permission-set" =&gt; "default-permissions"}]
                },
                {
                    "match-all" =&gt; true,
                    "permission-sets" =&gt; [
                        {"permission-set" =&gt; "login-permission"},
                        {"permission-set" =&gt; "default-permissions"}
                    ]
                }
            ]
        }},
        "simple-regex-realm-mapper" =&gt; undefined,
        "simple-role-decoder" =&gt; {"groups-to-roles" =&gt; {"attribute" =&gt; "groups"}},
        "size-rotating-file-audit-log" =&gt; undefined,
        "source-address-role-decoder" =&gt; undefined,
        "syslog-audit-log" =&gt; undefined,
        "token-realm" =&gt; undefined,
        "trust-manager" =&gt; undefined,
        "x500-attribute-principal-decoder" =&gt; undefined,
        "x500-subject-evidence-decoder" =&gt; undefined,
        "x509-subject-alt-name-evidence-decoder" =&gt; undefined
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="default-application-authentication-configuration"><a class="anchor" href="#default-application-authentication-configuration"></a>3.4. Default Application Authentication Configuration</h3>
<div class="paragraph">
<p>By default, applications are secured using legacy security domains.
Applications must specify a security domain in their <em>web.xml</em> as well
as the authentication method. If no security domain is specified by the
application, WildFly will use the provided <em>other</em> legacy security
domain.</p>
</div>
<div class="sect3">
<h4 id="update-wildfly-to-use-the-default-elytron-components-for-application-authentication"><a class="anchor" href="#update-wildfly-to-use-the-default-elytron-components-for-application-authentication"></a>3.4.1. Update WildFly to Use the Default Elytron Components for Application</h4>
<div class="paragraph">
<p>Authentication</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=undertow/application-security-domain=exampleApplicationDomain:add(http-authentication-factory=example-http-auth)</code></pre>
</div>
</div>
<div class="paragraph">
<p>For more information on configuring an http-authentication-factory, see <a href="#configure-an-http-authentication-factory">configure an http-authentication-factory</a></p>
</div>
<div class="paragraph">
<p>SSL/TLS</p>
</div>
<div class="paragraph">
<p>Undertow can be configured to make use of the <code>applicationSSC</code> server SSL context for <strong>testing purposes</strong>,
as shown below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">batch
/subsystem=undertow/server=default-server/https-listener=https:undefine-attribute(name=security-realm)
/subsystem=undertow/server=default-server/https-listener=https:write-attribute(name=ssl-context,value=applicationSSC)
run-batch
reload</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>applicationSSC</code> server SSL context references the <code>applicationKM</code> key manager:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=elytron/key-manager=applicationKM:read-resource()
{
    "outcome" =&gt; "success",
    "result" =&gt; {
        "algorithm" =&gt; undefined,
        "alias-filter" =&gt; undefined,
        "credential-reference" =&gt; {"clear-text" =&gt; "password"},
        "generate-self-signed-certificate-host" =&gt; "localhost",
        "key-store" =&gt; "applicationKS",
        "provider-name" =&gt; undefined,
        "providers" =&gt; undefined
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>When the <code>applicationSSC</code> server SSL context is used by Undertow, a self-signed certificate will automatically
be generated the first time the HTTPS interface is accessed if the file that backs the <code>applicationKS</code> key store
doesn&#8217;t exist. This self-signed certificate will then be persisted to the file that backs the <code>applicationKS</code> key
store. The <code>generate-self-signed-certificate-host</code> value, <code>localhost</code>, will be used as the Common Name (CN) value
in the generated self-signed certificate. The following messages will appear in the server log file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code>13:21:39,197 WARN  [org.wildfly.extension.elytron] (MSC service thread 1-6) WFLYELY01083: KeyStore /wildfly/standalone/configuration/application.keystore not found, it will be auto generated on first use with a self-signed certificate for host localhost
...
13:39:57,152 WARN  [org.wildfly.extension.elytron] (default task-1) WFLYELY01084: Generated self-signed certificate at /wildfly/dist/target/wildfly-21.0.0.Beta1-SNAPSHOT/standalone/configuration/application.keystore. Please note that self-signed certificates are not secure and should only be used for testing purposes. Do not use this self-signed certificate in production.
SHA-1 fingerprint of the generated key is fc:16:cf:bf:de:3a:6d:d6:fe:ec:f9:cd:9d:22:c9:3d:43:d7:e3:57
SHA-256 fingerprint of the generated key is 38:69:00:4e:39:e2:40:e2:ef:b6:95:58:c6:ba:d0:0f:56:c5:7c:5d:fc:d5:c3:b9:b0:94:80:9c:f5:45:9d:40</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>NOTE</strong> To disable the automatic self-signed certificate generation, undefine the <code>generate-self-signed-certificate-host</code>
attribute on the <code>applicationKM</code> key manager.</p>
</div>
<div class="paragraph">
<p><strong>WARNING</strong> This self-signed certificate is only intended to be used for testing purposes. This self-signed certificate
should never be used in a production environment. For more information on configuring an <code>ssl-context</code>,
see <a href="#configuring-a-server-sslcontext">Configuring a server SSLContext</a>. For more information on how to
easily obtain a signed certificate using the WildFly CLI, see <a href="#obtain-certificate">Obtain a signed certificate from Let&#8217;s Encrypt</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="default-elytron-application-domain-configuration"><a class="anchor" href="#default-elytron-application-domain-configuration"></a>3.4.2. Default Elytron ApplicationDomain Configuration</h4>
<div class="paragraph">
<p>The http-authentication-factory can be configured to use the <em>ApplicationDomain</em>
security domain.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=elytron/security-domain=ApplicationDomain:read-resource()
{
    "outcome" =&gt; "success",
    "result" =&gt; {
        "default-realm" =&gt; "ApplicationRealm",
        "permission-mapper" =&gt; "default-permission-mapper",
        "post-realm-principal-transformer" =&gt; undefined,
        "pre-realm-principal-transformer" =&gt; undefined,
        "principal-decoder" =&gt; undefined,
        "realm-mapper" =&gt; undefined,
        "realms" =&gt; [{
            "realm" =&gt; "ApplicationRealm",
            "role-decoder" =&gt; "groups-to-roles"
        }],
        "role-mapper" =&gt; undefined,
        "trusted-security-domains" =&gt; undefined
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <em>ApplicationDomain</em> security domain is backed by the
<em>ApplicationRealm</em> Elytron security realm, which is a properties-based
realm.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=elytron/properties-realm=ApplicationRealm:read-resource()
{
    "outcome" =&gt; "success",
    "result" =&gt; {
        "groups-attribute" =&gt; "groups",
        "groups-properties" =&gt; {
            "path" =&gt; "application-roles.properties",
            "relative-to" =&gt; "jboss.server.config.dir"
        },
        "users-properties" =&gt; {
            "path" =&gt; "application-users.properties",
            "relative-to" =&gt; "jboss.server.config.dir",
            "digest-realm-name" =&gt; "ApplicationRealm"
        }
    }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="default-management-authentication-configuration"><a class="anchor" href="#default-management-authentication-configuration"></a>3.5. Default Management Authentication Configuration</h3>
<div class="paragraph">
<p>By default, the WildFly management interfaces are secured by the legacy
core management authentication.</p>
</div>
<div class="paragraph">
<p><strong>Default Configuration</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-json hljs" data-lang="json">/core-service=management/management-interface=http-interface:read-resource()
{
    "outcome" =&gt; "success",
    "result" =&gt; {
        "allowed-origins" =&gt; undefined,
        "console-enabled" =&gt; true,
        "http-authentication-factory" =&gt; undefined,
        "http-upgrade" =&gt; {"enabled" =&gt; true},
        "http-upgrade-enabled" =&gt; true,
        "sasl-protocol" =&gt; "remote",
        "secure-socket-binding" =&gt; undefined,
        "security-realm" =&gt; "ManagementRealm",
        "server-name" =&gt; undefined,
        "socket-binding" =&gt; "management-http",
        "ssl-context" =&gt; undefined
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>WildFly does provide <em>management-http-authentication</em> and
<em>management-sasl-authentication</em> in the <em>elytron</em> subsystem for securing
the management interfaces as well.</p>
</div>
<div class="sect3">
<h4 id="update-wildfly-to-use-the-default-elytron-components-for-management-authentication"><a class="anchor" href="#update-wildfly-to-use-the-default-elytron-components-for-management-authentication"></a>3.5.1. Update WildFly to Use the Default Elytron Components for Management</h4>
<div class="paragraph">
<p>Authentication</p>
</div>
<div class="sect4">
<h5 id="set-http-authentication-factory-to-use-management-http-authentication"><a class="anchor" href="#set-http-authentication-factory-to-use-management-http-authentication"></a>Set http-authentication-factory to use</h5>
<div class="paragraph">
<p>management-http-authentication</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">/core-service=management/management-interface=http-interface:write-attribute( \
  name=http-authentication-factory, \
  value=management-http-authentication \
)</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="set-sasl-authentication-factory-to-use-management-sasl-authentication"><a class="anchor" href="#set-sasl-authentication-factory-to-use-management-sasl-authentication"></a>Set sasl-authentication-factory to use</h5>
<div class="paragraph">
<p>management-sasl-authentication</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">/core-service=management/management-interface=http-interface:write-attribute( \
  name=http-upgrade.sasl-authentication-factory, \
  value=management-sasl-authentication \
)</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="undefine-security-realm"><a class="anchor" href="#undefine-security-realm"></a>Undefine security-realm</h5>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">/core-service=management/management-interface=http-interface:undefine-attribute(name=security-realm)</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="reload-wildfly-for-the-changes-to-take-affect."><a class="anchor" href="#reload-wildfly-for-the-changes-to-take-affect."></a>Reload WildFly for the changes to take effect.</h5>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>reload</code></pre>
</div>
</div>
<div class="paragraph">
<p>The management interfaces are now secured using the default components
provided by the 'elytron' subsystem.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="default-elytron-management-http-authentication-configuration"><a class="anchor" href="#default-elytron-management-http-authentication-configuration"></a>3.5.2. Default Elytron Management HTTP Authentication Configuration</h4>
<div class="paragraph">
<p>When you access the management interface over HTTP, for example when
using the web-based management console, WildFly will use the
<em>management-http-authentication</em> http-authentication-factory.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=elytron/http-authentication-factory=management-http-authentication:read-resource()
{
    "outcome" =&gt; "success",
    "result" =&gt; {
        "http-server-mechanism-factory" =&gt; "global",
        "mechanism-configurations" =&gt; [{
            "mechanism-name" =&gt; "DIGEST",
            "mechanism-realm-configurations" =&gt; [{"realm-name" =&gt; "ManagementRealm"}]
        }],
        "security-domain" =&gt; "ManagementDomain"
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <em>management-http-authentication</em> http-authentication-factory, is
configured to use the <em>ManagementDomain</em> security domain.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=elytron/security-domain=ManagementDomain:read-resource()
{
    "outcome" =&gt; "success",
    "result" =&gt; {
        "default-realm" =&gt; "ManagementRealm",
        "outflow-anonymous" =&gt; false,
        "outflow-security-domains" =&gt; undefined,
        "permission-mapper" =&gt; "default-permission-mapper",
        "post-realm-principal-transformer" =&gt; undefined,
        "pre-realm-principal-transformer" =&gt; undefined,
        "principal-decoder" =&gt; undefined,
        "realm-mapper" =&gt; undefined,
        "realms" =&gt; [
            {
                "realm" =&gt; "ManagementRealm",
                "role-decoder" =&gt; "groups-to-roles"
            },
            {
                "realm" =&gt; "local",
                "role-mapper" =&gt; "super-user-mapper"
            }
        ],
        "role-mapper" =&gt; undefined,
        "security-event-listener" =&gt; undefined,
        "trusted-security-domains" =&gt; undefined
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <em>ManagementDomain</em> security domain is backed by the
<em>ManagementRealm</em> Elytron security realm, which is a properties-based
realm.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=elytron/properties-realm=ManagementRealm:read-resource()
{
    "outcome" =&gt; "success",
    "result" =&gt; {
        "groups-attribute" =&gt; "groups",
        "groups-properties" =&gt; {
            "path" =&gt; "mgmt-groups.properties",
            "relative-to" =&gt; "jboss.server.config.dir"
        },
        "plain-text" =&gt; false,
        "users-properties" =&gt; {
            "path" =&gt; "mgmt-users.properties",
            "relative-to" =&gt; "jboss.server.config.dir",
            "digest-realm-name" =&gt; "ManagementRealm"
        }
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="default-elytron-management-cli-authentication"><a class="anchor" href="#default-elytron-management-cli-authentication"></a>3.5.3. Default Elytron Management CLI Authentication</h4>
<div class="paragraph">
<p>By default, the management CLI ( <em>jboss-cli.sh</em>) is configured to
connect over <em>remote+http</em>.</p>
</div>
<div class="paragraph">
<p><strong>Default jboss-cli.xml</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;jboss-cli xmlns="urn:jboss:cli:3.3"&gt;

    &lt;default-protocol use-legacy-override="true"&gt;remote+http&lt;/default-protocol&gt;

    &lt;!-- The default controller to connect to when 'connect' command is executed w/o arguments --&gt;
    &lt;default-controller&gt;
        &lt;protocol&gt;remote+http&lt;/protocol&gt;
        &lt;host&gt;localhost&lt;/host&gt;
        &lt;port&gt;9990&lt;/port&gt;
    &lt;/default-controller&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>This will establish a connection over HTTP and use HTTP upgrade to
change the communication protocol to <em>native</em>. The HTTP upgrade
connection is secured in the <em>http-upgrade</em> section of the
<em>http-interface</em> using a <em>sasl-authentication-factory</em>.</p>
</div>
<div class="paragraph">
<p><strong>Example Configuration with Default Components</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-json hljs" data-lang="json">/core-service=management/management-interface=http-interface:read-resource()
{
    "outcome" =&gt; "success",
    "result" =&gt; {
        "allowed-origins" =&gt; undefined,
        "console-enabled" =&gt; true,
        "http-authentication-factory" =&gt; "management-http-authentication",
        "http-upgrade" =&gt; {
            "enabled" =&gt; true,
            "sasl-authentication-factory" =&gt; "management-sasl-authentication"
        },
        "http-upgrade-enabled" =&gt; true,
        "sasl-protocol" =&gt; "remote",
        "secure-socket-binding" =&gt; undefined,
        "security-realm" =&gt; undefined,
        "server-name" =&gt; undefined,
        "socket-binding" =&gt; "management-http",
        "ssl-context" =&gt; undefined
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The default sasl-authentication-factory is
<em>management-sasl-authentication</em>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=elytron/sasl-authentication-factory=management-sasl-authentication:read-resource()
{
    "outcome" =&gt; "success",
    "result" =&gt; {
        "mechanism-configurations" =&gt; [
            {
                "mechanism-name" =&gt; "JBOSS-LOCAL-USER",
                "realm-mapper" =&gt; "local"
            },
            {
                "mechanism-name" =&gt; "DIGEST-MD5",
                "mechanism-realm-configurations" =&gt; [{"realm-name" =&gt; "ManagementRealm"}]
            }
        ],
        "sasl-server-factory" =&gt; "configured",
        "security-domain" =&gt; "ManagementDomain"
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <em>management-sasl-authentication</em> sasl-authentication-factory
specifies <em>JBOSS-LOCAL-USER</em> and <em>DIGEST-MD5</em> mechanisms.</p>
</div>
<div class="paragraph">
<p><strong>JBOSS-LOCAL-USER Realm</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=elytron/identity-realm=local:read-resource()
{
    "outcome" =&gt; "success",
    "result" =&gt; {
        "attribute-name" =&gt; undefined,
        "attribute-values" =&gt; undefined,
        "identity" =&gt; "$local"
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <em>local</em> Elytron security realm is for handling silent authentication
for local users.</p>
</div>
<div class="paragraph">
<p>The <em>ManagementRealm</em> Elytron security realm is the same realm used in
the <em>management-http-authentication</em> http-authentication-factory.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="comparing-legacy-approaches-to-elytron-approaches"><a class="anchor" href="#comparing-legacy-approaches-to-elytron-approaches"></a>3.6. Comparing Legacy Approaches to Elytron Approaches</h3>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Legacy Approach</th>
<th class="tableblock halign-left valign-top">Elytron Approach</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">UsersRoles Login Module</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Configure Authentication with a Properties
File-Based Identity Store</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Database Login Module</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Configure Authentication with a Database
Identity Store</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Ldap, LdapExtended, AdvancedLdap, AdvancedADLdap Login Modules</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Configure Authentication with an LDAP-Based Identity Store</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Certificate, Certificate Roles Login Module</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Configure Authentication
with Certificates</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Kerberos, SPNEGO Login Modules</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Configure Authentication with a
Kerberos-Based Identity Store</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Kerberos, SPNEGO Login Modules with Fallback</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Configure Authentication
with a Form as a Fallback for Kerberos</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">RoleMapping Login Module</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Configure Authentication
with a Mapped Role Mapper</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Vault</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Create and Use a Credential Store</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Legacy Security Realms</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Secure the Management Interfaces with a New
Identity Store, Silent Authentication</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">RBAC</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Using RBAC with Elytron</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Legacy Security Realms for One-way and Two-way SSL/TLS for Applications</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Enable One-way SSL/TLS for Applications, Enable Two-way SSL/TLS in
WildFly for Applications</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Legacy Security Realms for One-way and Two-way SSL/TLS for Management
Interfaces</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Enable One-way for the Management Interfaces Using the
Elytron Subsystem, Enable Two-way SSL/TLS for the Management Interfaces
using the Elytron Subsystem</p></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="Using_the_Elytron_Subsystem"><a class="anchor" href="#Using_the_Elytron_Subsystem"></a>4. Using the Elytron Subsystem</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="set-up-and-configure-authentication-for-applications"><a class="anchor" href="#set-up-and-configure-authentication-for-applications"></a>4.1. Set Up and Configure Authentication for Applications</h3>
<div class="sect3">
<h4 id="configure-authentication-with-a-properties-file-based-identity-store"><a class="anchor" href="#configure-authentication-with-a-properties-file-based-identity-store"></a>4.1.1. Configure Authentication with a Properties File-Based Identity Store</h4>
<div class="sect4">
<h5 id="create-properties-files"><a class="anchor" href="#create-properties-files"></a>Create properties files:</h5>
<div class="paragraph">
<p>You need to create two properties files: one that maps user to passwords
and another that maps users to roles. Usually these files are located in
the <em>jboss.server.config.dir</em> directory and follow the naming convention
<em>*-users.properties</em> and <em>*-roles.properties</em>, but other locations and
names may be used. The <em>*-users.properties</em> file must also contain a
reference to the <em>properties-realm</em>, which you will create in the next
step: <em>#$REALM_NAME=YOUR_PROPERTIES_REALM_NAME$</em></p>
</div>
<div class="paragraph">
<p><strong>Example user to password file: example-users.properties</strong></p>
</div>
<div class="literalblock">
<div class="content">
<pre>#$REALM_NAME=examplePropRealm$
user1=password123
user2=password123</pre>
</div>
</div>
<div class="paragraph">
<p><strong>Example user to roles file: example-roles.properties</strong></p>
</div>
<div class="literalblock">
<div class="content">
<pre>user1=Admin
user2=Guest</pre>
</div>
</div>
<div class="paragraph">
<p>The Properties Realm also supports storing hashed passwords in the properties
files, namely DIGEST passwords. Learn how to specify the encoding and character set for these passwords
in the next section.</p>
</div>
</div>
<div class="sect4">
<h5 id="configure-a-properties-realm-in-wildfly"><a class="anchor" href="#configure-a-properties-realm-in-wildfly"></a>Configure a properties-realm in WildFly:</h5>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=elytron/properties-realm=examplePropRealm:add(groups-attribute=groups,groups-properties={path=example-roles.properties,relative-to=jboss.server.config.dir},users-properties={path=example-users.properties,relative-to=jboss.server.config.dir,plain-text=true})</code></pre>
</div>
</div>
<div class="paragraph">
<p>The name of the <em>properties-realm</em> is <em>examplePropRealm</em>, which is used
in the previous step in the <em>example-users.properties</em> file. Also, if
your properties files are located outside of <em>jboss.server.config.dir</em>,
then you need to change the <em>path</em> and <em>relative-to</em> values
appropriately.</p>
</div>
<div class="paragraph">
<p>Additionally, if storing hashed passwords in the properties file, you can specify the following
attributes:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>hash-encoding</code>: This attribute specifies the string format for the password if it is not stored in plain
text. It is set to <code>hex</code> encoding by default, but <code>base64</code> is also supported.</p>
</li>
<li>
<p><code>hash-charset</code>: This attribute specifies the character set to use when converting the password string to a
byte array. It is set to <code>UTF-8</code> by default.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For example, the following properties realm is configured to use <code>base64</code> encoding and the character set
<code>GB2312</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=elytron/properties-realm=examplePropRealm:add(groups-attribute=groups,groups-properties={path=example-roles.properties,relative-to=jboss.server.config.dir},users-properties={path=example-users.properties,relative-to=jboss.server.config.dir},hash-encoding=base64,hash-charset=GB2312)</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="configure-a-security-domain"><a class="anchor" href="#configure-a-security-domain"></a>Configure a security-domain:</h5>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=elytron/security-domain=exampleSD:add(realms=[{realm=examplePropRealm,role-decoder=groups-to-roles}],default-realm=examplePropRealm,permission-mapper=default-permission-mapper)</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="configure-an-http-authentication-factory"><a class="anchor" href="#configure-an-http-authentication-factory"></a>Configure an http-authentication-factory:</h5>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=elytron/http-authentication-factory=example-http-auth:add(http-server-mechanism-factory=global,security-domain=exampleSD,mechanism-configurations=[{mechanism-name=BASIC,mechanism-realm-configurations=[{realm-name=exampleApplicationDomain}]}])</code></pre>
</div>
</div>
<div class="paragraph">
<p>This example shows creating an <em>http-authentication-factory</em> using
<em>BASIC</em> authentication, but it could be updated to other mechanisms such
as <em>FORM</em>.</p>
</div>
</div>
<div class="sect4">
<h5 id="configure-an-application-security-domain-in-the-undertow-subsystem"><a class="anchor" href="#configure-an-application-security-domain-in-the-undertow-subsystem"></a>Configure an application-security-domain in the Undertow subsystem:</h5>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=undertow/application-security-domain=exampleApplicationDomain:add(http-authentication-factory=example-http-auth)</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="configure-your-applications-web.xml-and-jboss-web.xml."><a class="anchor" href="#configure-your-applications-web.xml-and-jboss-web.xml."></a>Configure your application&#8217;s web.xml and jboss-web.xml.</h5>
<div class="paragraph">
<p>Your application&#8217;s <em>web.xml</em> and <em>jboss-web.xml</em> must be updated to use
the <em>application-security-domain</em> you configured in WildFly. An example
of this is available in the
<a href="#configure-applications-to-use-elytron-or-legacy-security-for-authentication">Configure
Applications to Use Elytron or Legacy Security for Authentication</a>
section.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="configure-authentication-with-a-filesystem-based-identity-store"><a class="anchor" href="#configure-authentication-with-a-filesystem-based-identity-store"></a>4.1.2. Configure Authentication with a Filesystem-Based Identity Store</h4>
<div class="sect4">
<h5 id="chose-a-directory-for-users"><a class="anchor" href="#chose-a-directory-for-users"></a>Chose a directory for users:</h5>
<div class="paragraph">
<p>You need a directory where your users will be stored. In this example,
we are using a directory called <em>fs-realm-users</em> located in
<em>jboss.server.config.dir</em>.</p>
</div>
</div>
<div class="sect4">
<h5 id="configure-a-filesystem-realm-in-wildfly"><a class="anchor" href="#configure-a-filesystem-realm-in-wildfly"></a>Configure a filesystem-realm in WildFly:</h5>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=elytron/filesystem-realm=exampleFsRealm:add(path=fs-realm-users,relative-to=jboss.server.config.dir)</code></pre>
</div>
</div>
<div class="paragraph">
<p>If your directory is located outside of <em>jboss.server.config.dir</em>, then
you need to change the <em>path</em> and <em>relative-to</em> values appropriately.</p>
</div>
</div>
<div class="sect4">
<h5 id="add-a-user"><a class="anchor" href="#add-a-user"></a>Add a user:</h5>
<div class="paragraph">
<p>When using the <em>filesystem-realm</em>, you can add users using the
management CLI.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=elytron/filesystem-realm=exampleFsRealm:add-identity(identity=user1)
/subsystem=elytron/filesystem-realm=exampleFsRealm:set-password(clear={password="password123"}, identity=user1)
/subsystem=elytron/filesystem-realm=exampleFsRealm:add-identity-attribute(identity=user1, name=Roles, value=["Admin","Guest"])</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="add-a-simple-role-decoder"><a class="anchor" href="#add-a-simple-role-decoder"></a>Add a simple-role-decoder:</h5>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=elytron/simple-role-decoder=from-roles-attribute:add(attribute=Roles)</code></pre>
</div>
</div>
<div class="paragraph">
<p>This <em>simple-role-decoder</em> decodes a principal&#8217;s roles from the <em>Roles</em>
attribute. You can change this value if your roles are in a different
attribute.</p>
</div>
</div>
<div class="sect4">
<h5 id="configure-a-security-domain-1"><a class="anchor" href="#configure-a-security-domain-1"></a>Configure a security-domain:</h5>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=elytron/security-domain=exampleFsSD:add(realms=[{realm=exampleFsRealm,role-decoder=from-roles-attribute}],default-realm=exampleFsRealm,permission-mapper=default-permission-mapper)</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="configure-an-http-authentication-factory-1"><a class="anchor" href="#configure-an-http-authentication-factory-1"></a>Configure an http-authentication-factory:</h5>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=elytron/http-authentication-factory=example-fs-http-auth:add(http-server-mechanism-factory=global,security-domain=exampleFsSD,mechanism-configurations=[{mechanism-name=BASIC,mechanism-realm-configurations=[{realm-name=exampleApplicationDomain}]}])</code></pre>
</div>
</div>
<div class="paragraph">
<p>This example shows creating an <em>http-authentication-factory</em> using
<em>BASIC</em> authentication, but it could be updated to other mechanisms such
as <em>FORM</em>.</p>
</div>
</div>
<div class="sect4">
<h5 id="configure-an-application-security-domain-in-the-undertow-subsystem-1"><a class="anchor" href="#configure-an-application-security-domain-in-the-undertow-subsystem-1"></a>Configure an application-security-domain in the Undertow subsystem:</h5>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=undertow/application-security-domain=exampleApplicationDomain:add(http-authentication-factory=example-fs-http-auth)</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="configure-your-applications-web.xml-and-jboss-web.xml.-1"><a class="anchor" href="#configure-your-applications-web.xml-and-jboss-web.xml.-1"></a>Configure your application&#8217;s web.xml and jboss-web.xml.</h5>
<div class="paragraph">
<p>Your application&#8217;s <em>web.xml</em> and <em>jboss-web.xml</em> must be updated to use
the <em>application-security-domain</em> you configured in WildFly. An example
of this is available in the
<a href="#configure-applications-to-use-elytron-or-legacy-security-for-authentication">Configure
Applications to Use Elytron or Legacy Security for Authentication</a>
section.</p>
</div>
<div class="paragraph">
<p>Your application is now using a filesystem-based identity store for
authentication.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="configure-authentication-with-a-database-identity-store"><a class="anchor" href="#configure-authentication-with-a-database-identity-store"></a>4.1.3. Configure Authentication with a Database Identity Store</h4>
<div class="sect4">
<h5 id="determine-your-database-format-for-usernames-passwords-and-roles"><a class="anchor" href="#determine-your-database-format-for-usernames-passwords-and-roles"></a>Determine your database format for usernames, passwords, and roles:</h5>
<div class="paragraph">
<p>To set up authentication using a database for an identity store, you
need to determine how your usernames, passwords, and roles are stored in
that database. In this example, we are using a single table with the
following sample data:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">username</th>
<th class="tableblock halign-left valign-top">password</th>
<th class="tableblock halign-left valign-top">roles</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">user1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">password123</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Admin</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">user2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">password123</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Guest</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect4">
<h5 id="configure-a-datasource"><a class="anchor" href="#configure-a-datasource"></a>Configure a datasource:</h5>
<div class="paragraph">
<p>To connect to a database from WildFly, you must have the appropriate
database driver deployed as well as a datasource configured. This
example shows deploying the driver for postgres and configuring a
datasource in WildFly:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>deploy /path/to/postgresql-9.4.1210.jar

data-source add --name=examplePostgresDS --jndi-name=java:jboss/examplePostgresDS --driver-name=postgresql-9.4.1210.jar  --connection-url=jdbc:postgresql://localhost:5432/postgresdb --user-name=postgresAdmin --password=mysecretpassword</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="configure-a-jdbc-realm-in-wildfly"><a class="anchor" href="#configure-a-jdbc-realm-in-wildfly"></a>Configure a jdbc-realm in WildFly:</h5>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=elytron/jdbc-realm=exampleDbRealm:add(principal-query=[{sql="SELECT password,roles FROM wildfly_users WHERE username=?",data-source=examplePostgresDS,clear-password-mapper={password-index=1},attribute-mapping=[{index=2,to=groups}]}])</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>NOTE:</strong> The above example shows how to obtain passwords and roles from a
single <em>principal-query</em>. You can also create additional
<em>principal-query</em> with <em>attribute-mapping</em> attributes if you require
multiple queries to obtain roles or additional authentication or
authorization information.</p>
</div>
</div>
<div class="sect4">
<h5 id="configure-a-security-domain-2"><a class="anchor" href="#configure-a-security-domain-2"></a>Configure a security-domain:</h5>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=elytron/security-domain=exampleDbSD:add(realms=[{realm=exampleDbRealm,role-decoder=groups-to-roles}],default-realm=exampleDbRealm,permission-mapper=default-permission-mapper)</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="configure-an-http-authentication-factory-2"><a class="anchor" href="#configure-an-http-authentication-factory-2"></a>Configure an http-authentication-factory:</h5>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=elytron/http-authentication-factory=example-db-http-auth:add(http-server-mechanism-factory=global,security-domain=exampleDbSD,mechanism-configurations=[{mechanism-name=BASIC,mechanism-realm-configurations=[{realm-name=exampleDbSD}]}])</code></pre>
</div>
</div>
<div class="paragraph">
<p>This example shows creating an <em>http-authentication-factory</em> using
<em>BASIC</em> authentication, but it could be updated to other mechanisms such
as <em>FORM</em>.</p>
</div>
</div>
<div class="sect4">
<h5 id="configure-an-application-security-domain-in-the-undertow-subsystem-2"><a class="anchor" href="#configure-an-application-security-domain-in-the-undertow-subsystem-2"></a>Configure an application-security-domain in the Undertow subsystem:</h5>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=undertow/application-security-domain=exampleApplicationDomain:add(http-authentication-factory=example-db-http-auth)</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="configure-your-applications-web.xml-and-jboss-web.xml.-2"><a class="anchor" href="#configure-your-applications-web.xml-and-jboss-web.xml.-2"></a>Configure your application&#8217;s web.xml and jboss-web.xml.</h5>
<div class="paragraph">
<p>Your application&#8217;s <em>web.xml</em> and <em>jboss-web.xml</em> must be updated to use
the <em>application-security-domain</em> you configured in WildFly. An example
of this is available in the
<a href="#configure-applications-to-use-elytron-or-legacy-security-for-authentication">Configure
Applications to Use Elytron or Legacy Security for Authentication</a>
section.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="configure-authentication-with-an-ldap-based-identity-store"><a class="anchor" href="#configure-authentication-with-an-ldap-based-identity-store"></a>4.1.4. Configure Authentication with an LDAP-Based Identity Store</h4>
<div class="sect4">
<h5 id="determine-your-ldap-format-for-usernames-passwords-and-roles"><a class="anchor" href="#determine-your-ldap-format-for-usernames-passwords-and-roles"></a>Determine your LDAP format for usernames, passwords, and roles:</h5>
<div class="paragraph">
<p>To set up authentication using an LDAP server for an identity store, you
need to determine how your usernames, passwords, and roles are stored.
In this example, we are using the following structure:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">dn: dc=wildfly,dc=org
dc: wildfly
objectClass: top
objectClass: domain

dn: ou=Users,dc=wildfly,dc=org
objectClass: organizationalUnit
objectClass: top
ou: Users

dn: uid=jsmith,ou=Users,dc=wildfly,dc=org
objectClass: top
objectClass: person
objectClass: inetOrgPerson
cn: John Smith
sn: smith
uid: jsmith
userPassword: password123

dn: ou=Roles,dc=wildfly,dc=org
objectclass: top
objectclass: organizationalUnit
ou: Roles

dn: cn=Admin,ou=Roles,dc=wildfly,dc=org
objectClass: top
objectClass: groupOfNames
cn: Admin
member: uid=jsmith,ou=Users,dc=wildfly,dc=org</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="configure-a-dir-context"><a class="anchor" href="#configure-a-dir-context"></a>Configure a dir-context:</h5>
<div class="paragraph">
<p>To connect to the LDAP server from WildFly, you need to configure a
<em>dir-context</em> that provides the URL as well as the principal used to
connect to the server.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=elytron/dir-context=exampleDC:add(url="ldap://127.0.0.1:10389",principal="uid=admin,ou=system",credential-reference={clear-text="secret"})</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="configure-an-ldap-realm-in-wildfly"><a class="anchor" href="#configure-an-ldap-realm-in-wildfly"></a>Configure an ldap-realm in WildFly:</h5>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=elytron/ldap-realm=exampleLR:add(dir-context=exampleDC,identity-mapping={search-base-dn="ou=Users,dc=wildfly,dc=org",rdn-identifier="uid",user-password-mapper={from="userPassword"},attribute-mapping=[{filter-base-dn="ou=Roles,dc=wildfly,dc=org",filter="(&amp;(objectClass=groupOfNames)(member={1}))",from="cn",to="Roles"}]})</code></pre>
</div>
</div>
<div class="paragraph">
<p>Additionally, if storing hashed passwords in the LDIF file, you can specify the following
attributes:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>hash-encoding</code>: This attribute specifies the string format for the password if it is not stored in plain
text. It is set to <code>base64</code> encoding by default, but <code>hex</code> is also supported.</p>
</li>
<li>
<p><code>hash-charset</code>: This attribute specifies the character set to use when converting the password string to a
byte array. It is set to <code>UTF-8</code> by default.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For example, the following LDAP realm is storing hexadecimal encoded strings hashed using the <code>GB2312</code> character set:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=elytron/ldap-realm=exampleLR:add(dir-context=exampleDC,identity-mapping={...},hash-encoding=hex,hash-charset=GB2312)</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="add-a-simple-role-decoder-1"><a class="anchor" href="#add-a-simple-role-decoder-1"></a>Add a simple-role-decoder:</h5>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=elytron/simple-role-decoder=from-roles-attribute:add(attribute=Roles)</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="configure-a-security-domain-3"><a class="anchor" href="#configure-a-security-domain-3"></a>Configure a security-domain:</h5>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=elytron/security-domain=exampleLdapSD:add(realms=[{realm=exampleLR,role-decoder=from-roles-attribute}],default-realm=exampleLR,permission-mapper=default-permission-mapper)</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="configure-an-http-authentication-factory-3"><a class="anchor" href="#configure-an-http-authentication-factory-3"></a>Configure an http-authentication-factory:</h5>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=elytron/http-authentication-factory=example-ldap-http-auth:add(http-server-mechanism-factory=global,security-domain=exampleLdapSD,mechanism-configurations=[{mechanism-name=BASIC,mechanism-realm-configurations=[{realm-name=exampleApplicationDomain}]}])</code></pre>
</div>
</div>
<div class="paragraph">
<p>This example shows creating an <em>http-authentication-factory</em> using
<em>BASIC</em> authentication, but it could be updated to other mechanisms such
as <em>FORM</em>.</p>
</div>
</div>
<div class="sect4">
<h5 id="configure-an-application-security-domain-in-the-undertow-subsystem-3"><a class="anchor" href="#configure-an-application-security-domain-in-the-undertow-subsystem-3"></a>Configure an application-security-domain in the Undertow subsystem:</h5>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=undertow/application-security-domain=exampleApplicationDomain:add(http-authentication-factory=example-ldap-http-auth)</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="configure-your-applications-web.xml-and-jboss-web.xml.-3"><a class="anchor" href="#configure-your-applications-web.xml-and-jboss-web.xml.-3"></a>Configure your application&#8217;s web.xml and jboss-web.xml.</h5>
<div class="paragraph">
<p>Your application&#8217;s <em>web.xml</em> and <em>jboss-web.xml</em> must be updated to use
the <em>application-security-domain</em> you configured in WildFly. An example
of this is available in the
<a href="#configure-applications-to-use-elytron-or-legacy-security-for-authentication">Configure
Applications to Use Elytron or Legacy Security for Authentication</a>
section.</p>
</div>
<div class="paragraph">
<p><strong>IMPORTANT:</strong> In cases where you configure an LDAP server in the
<em>elytron</em> subsystem for authentication and that LDAP server then becomes
unreachable, WildFly will return a <em>500</em>, or internal server error,
error code when attempting authentication using that unreachable LDAP
server. This behavior differs from the legacy <em>security</em> subsystem,
which will return a <em>401</em>, or unauthorized, error code under the same
conditions.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="configure-authentication-with-certificates"><a class="anchor" href="#configure-authentication-with-certificates"></a>4.1.5. Configure Authentication with Certificates</h4>
<div class="paragraph">
<p><strong>IMPORTANT:</strong> Before you can set up certificate-based authentication, you
must have two-way SSL configured.</p>
</div>
<div class="sect4">
<h5 id="configure-a-key-store-realm."><a class="anchor" href="#configure-a-key-store-realm."></a>Configure a key-store-realm.</h5>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=elytron/key-store-realm=ksRealm:add(key-store=twoWayTS)</code></pre>
</div>
</div>
<div class="paragraph">
<p>You must configure this realm with a truststore that contains the
client&#8217;s certificate. The authentication process uses the same
certificate presented by the client during the two-way SSL handshake.</p>
</div>
</div>
<div class="sect4">
<h5 id="create-a-decoder."><a class="anchor" href="#create-a-decoder."></a>Create a Decoder.</h5>
<div class="paragraph">
<p>You need to create a <em>x500-attribute-principal-decoder</em> to decode the
principal you get from your certificate. The below example will decode
the principal based on the first <em>CN</em> value.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=elytron/x500-attribute-principal-decoder=CNDecoder:add(oid="2.5.4.3",maximum-segments=1)</code></pre>
</div>
</div>
<div class="paragraph">
<p>For example, if the full <em>DN</em> was
<em>CN=client,CN=client-certificate,DC=example,DC=jboss,DC=org</em>,
<em>CNDecoder</em> would decode the principal as <em>client</em>. This decoded
principal is used as the <em>alias</em> value to lookup a certificate in the
truststore configured in <em>ksRealm</em>.</p>
</div>
<div class="paragraph">
<p><strong>IMPORTANT:</strong> The decoded principal * <strong>MUST</strong>* must be the <em>alias</em> value
you set in your server&#8217;s truststore for the client&#8217;s certificate.</p>
</div>
</div>
<div class="sect4">
<h5 id="configure-an-evidence-decoder."><a class="anchor" href="#configure-an-evidence-decoder."></a>Configure an evidence-decoder</h5>
<div class="paragraph">
<p>By default, the principal associated with a certificate will be the subject name
from the certificate. This subject name will then be rewritten using any configured
principal decoders and principal transformers to obtain the name that should be used
when locating and loading the identity from the underlying identity store.</p>
</div>
<div class="paragraph">
<p>To specify that a subject alternative name from a certificate should be used as the
principal associated with that certificate, an <code>x509-subject-alt-name-evidence-decoder</code>
needs to be configured. This element has two attributes:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>alt-name-type</code> - The subject alternative name type to decode. This attribute is
required. Must be one of the subject alternative name types that can be represented
as a <code>String</code>:</p>
<div class="ulist">
<ul>
<li>
<p><code>rfc822Name</code></p>
</li>
<li>
<p><code>dNSName</code></p>
</li>
<li>
<p><code>uniformResourceIdentifier</code></p>
</li>
<li>
<p><code>iPAddress</code></p>
</li>
<li>
<p><code>registeredID</code></p>
</li>
<li>
<p><code>directoryName</code></p>
</li>
</ul>
</div>
</li>
<li>
<p><code>segment</code> - The 0-based occurrence of the subject alternative name to map. This
attribute is optional and only used when there is more than one subject alternative
name of the given <code>alt-name-type</code>. The default value is <code>0</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For example, consider the following X.509 v3 Subject Alternative Name extension from
the first certificate in an X.509 certificate chain:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">X509v3 Subject Alternative Name:
DNS:one.example.org, IP Address:127.0.0.1</code></pre>
</div>
</div>
<div class="paragraph">
<p>To associate the certificate chain evidence with the principal "one.example.org", the
following <code>x509-subject-alt-name-evidence-decoder</code> could be configured:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=elytron/x509-subject-alt-name-evidence-decoder=exampleDnsDecoder:add(alt-name-type=dNSName)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Next, consider the following X.509 v3 Subject Alternative Name extension from the first
certificate in an X.509 certificate chain:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">X509v3 Subject Alternative Name:
DNS:one.example.org, DNS:two.example.org, IP Address:127.0.0.1</code></pre>
</div>
</div>
<div class="paragraph">
<p>To associate the evidence with the principal "two.example.org", the following
<code>x509-subject-alt-name-evidence-decoder</code> could be configured:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=elytron/x509-subject-alt-name-evidence-decoder=anotherDnsDecoder:add(alt-name-type=dNSName, segment=1)</code></pre>
</div>
</div>
<div class="paragraph">
<p>It is also possible to configure an <code>x500-subject-evidence-decoder</code>. This evidence decoder
will extract the subject from the first certificate in the certificate chain, as an <code>X500Principal</code>.
Example configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=elytron/x500-subject-evidence-decoder=exampleSubjectDecoder:add()</code></pre>
</div>
</div>
<div class="paragraph">
<p>To make use of a custom <code>org.wildfly.security.auth.server.EvidenceDecoder</code> implementation, a
<code>custom-evidence-decoder</code> can be configured. The custom implementation class needs to first be
packaged in a JAR. A module can then be added to WildFly that contains this JAR. See
<a href="#Custom_Components.adoc" class="page unresolved">Custom Components</a> for more information on how to add a custom Elytron
component to WildFly.</p>
</div>
<div class="paragraph">
<p>Example configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=elytron/custom-evidence-decoder=myCustomEvidenceDecoder:add(module=org.wildfly.security.examples, class-name=org.wildfly.security.examples.MyCustomEvidenceDecoder)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Finally, it is also possible to configure an <code>aggregate-evidence-decoder</code>. This consists of
two or more <code>evidence-decoder</code> elements where each element is reference to a configured
evidence decoder. Given evidence, these evidence decoders will be attempted in order until
one returns a non-null principal or until there are no more evidence decoders left to try.</p>
</div>
<div class="paragraph">
<p>Example configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=elytron/x509-subject-alt-name-evidence-decoder=emailDecoder:add(alt-name-type=rfc822Name)
/subsystem=elytron/x509-subject-alt-name-evidence-decoder=dnsDecoder:add(alt-name-type=dNSName)
/subsystem=elytron/x500-subject-evidence-decoder=subjectDecoder:add()
/subsystem=elytron/aggregate-evidence-decoder=aggregateDecoder:add(evidence-decoders=[emailDecoder,subjectDecoder,dnsDecoder])</code></pre>
</div>
</div>
<div class="paragraph">
<p>Once an <code>evidence-decoder</code> has been configured, it can be referenced from a <code>security-domain</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=elytron/security-domain=exampleCertSD:add(..., evidence-decoder=aggregateDecoder)</code></pre>
</div>
</div>
<div class="paragraph">
<p>If no <code>evidence-decoder</code> is specified for a <code>security-domain</code>, then the principal associated with the evidence will
just be the default principal for the evidence type, i.e., for an X.509 certificate chain, this would continue to
default to the subject from the first certificate in the certificate chain.</p>
</div>
</div>
<div class="sect4">
<h5 id="add-a-constant-role-mapper-for-assigning-roles."><a class="anchor" href="#add-a-constant-role-mapper-for-assigning-roles."></a>Add a constant-role-mapper for assigning roles.</h5>
<div class="paragraph">
<p>This is example uses a <em>constant-role-mapper</em> to assign roles to a
principal from <em>ksRealm</em> but other approaches may also be used.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=elytron/constant-role-mapper=constantClientCertRole:add(roles=[Admin,Guest])</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="configure-a-security-domain."><a class="anchor" href="#configure-a-security-domain."></a>Configure a security-domain.</h5>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=elytron/security-domain=exampleCertSD:add(realms=[{realm=ksRealm}],default-realm=ksRealm,permission-mapper=default-permission-mapper,principal-decoder=CNDecoder,role-mapper=constantClientCertRole)</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="configure-an-http-authentication-factory."><a class="anchor" href="#configure-an-http-authentication-factory."></a>Configure an http-authentication-factory.</h5>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=elytron/http-authentication-factory=exampleCertHttpAuth:add(http-server-mechanism-factory=global,security-domain=exampleCertSD,mechanism-configurations=[{mechanism-name=CLIENT_CERT,mechanism-realm-configurations=[{realm-name=exampleApplicationDomain}]}])</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="configure-an-application-security-domain-in-the-undertow-subsystem."><a class="anchor" href="#configure-an-application-security-domain-in-the-undertow-subsystem."></a>Configure an application-security-domain in the Undertow subsystem.</h5>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=undertow/application-security-domain=exampleApplicationDomain:add(http-authentication-factory=exampleCertHttpAuth)</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="update-server-ssl-context."><a class="anchor" href="#update-server-ssl-context."></a>Update server-ssl-context.</h5>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=elytron/server-ssl-context=twoWaySSC:write-attribute(name=security-domain,value=exampleCertSD)
/subsystem=elytron/server-ssl-context=twoWaySSC:write-attribute(name=authentication-optional, value=true)</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="configure-your-applications-web.xml-and-jboss-web.xml.-4"><a class="anchor" href="#configure-your-applications-web.xml-and-jboss-web.xml.-4"></a>Configure your application&#8217;s web.xml and jboss-web.xml.</h5>
<div class="paragraph">
<p>Your application&#8217;s <em>web.xml</em> and <em>jboss-web.xml</em> must be updated to use
the <em>application-security-domain</em> you configured in WildFly. An example
of this is available in the
<a href="#configure-applications-to-use-elytron-or-legacy-security-for-authentication">Configure
Applications to Use Elytron or Legacy Security for Authentication</a>
section.</p>
</div>
<div class="paragraph">
<p>In addition, you need to update your <em>web.xml</em> to use <em>CLIENT-CERT</em> as
its authentication method.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;login-config&gt;
  &lt;auth-method&gt;CLIENT-CERT&lt;/auth-method&gt;
  &lt;realm-name&gt;exampleApplicationDomain&lt;/realm-name&gt;
&lt;/login-config&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="configure-authentication-with-a-kerberos-based-identity-store"><a class="anchor" href="#configure-authentication-with-a-kerberos-based-identity-store"></a>4.1.6. Configure Authentication with a Kerberos-Based Identity Store</h4>
<div class="paragraph">
<p><strong>IMPORTANT</strong>: The following steps assume you have a working KDC and
Kerberos domain as well as your client browsers configured.</p>
</div>
<div class="sect4">
<h5 id="configure-a-kerberos-security-factory."><a class="anchor" href="#configure-a-kerberos-security-factory."></a>Configure a kerberos-security-factory.</h5>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=elytron/kerberos-security-factory=krbSF:add(principal="HTTP/host@REALM",path="/path/to/http.keytab",mechanism-oids=[1.2.840.113554.1.2.2,1.3.6.1.5.5.2])</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="configure-the-system-properties-for-kerberos."><a class="anchor" href="#configure-the-system-properties-for-kerberos."></a>Configure the system properties for Kerberos.</h5>
<div class="paragraph">
<p>Depending on how your environment is configured, you will need to set
some of the system properties below.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">System Property</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">java.security.krb5.kdc</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The host name of the KDC.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">java.security.krb5.realm</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The name of the realm.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">java.security.krb5.conf</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The path to the configuration krb5.conf file.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">sun.security.krb5.debug</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If true, debugging mode will be enabled.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>To configure a system property in WildFly:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">/system-property=java.security.krb5.conf:add(value="/path/to/krb5.conf")</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="configure-an-eltyron-security-realm-for-assigning-roles."><a class="anchor" href="#configure-an-eltyron-security-realm-for-assigning-roles."></a>Configure an Elytron security realm for assigning roles.</h5>
<div class="paragraph">
<p>The the client&#8217;s Kerberos token will provide the principal, but you need
a way to map that principal to a role for your application. There are
several ways to accomplish this, but this example creates a
<em>filesystem-realm</em>, adds a user to the realm that matches the principal
from the Kerberos token, and assigns roles to that user.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=elytron/filesystem-realm=exampleFsRealm:add(path=fs-realm-users,relative-to=jboss.server.config.dir)
/subsystem=elytron/filesystem-realm=exampleFsRealm:add-identity(identity=user1@REALM)
/subsystem=elytron/filesystem-realm=exampleFsRealm:add-identity-attribute(identity=user1@REALM,name=Roles,value=["Admin","Guest"])</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="add-a-simple-role-decoder."><a class="anchor" href="#add-a-simple-role-decoder."></a>Add a simple-role-decoder.</h5>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=elytron/simple-role-decoder=from-roles-attribute:add(attribute=Roles)</code></pre>
</div>
</div>
<div class="paragraph">
<p>This <em>simple-role-decoder</em> decodes a principal&#8217;s roles from the <em>Roles</em>
attribute. You can change this value if your roles are in a different
attribute.</p>
</div>
</div>
<div class="sect4">
<h5 id="configure-a-security-domain.-1"><a class="anchor" href="#configure-a-security-domain.-1"></a>Configure a security-domain.</h5>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=elytron/security-domain=exampleFsSD:add(realms=[{realm=exampleFsRealm,role-decoder=from-roles-attribute}],default-realm=exampleFsRealm,permission-mapper=default-permission-mapper)</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="configure-an-http-authentication-factory-that-uses-the-kerberos-security-factory."><a class="anchor" href="#configure-an-http-authentication-factory-that-uses-the-kerberos-security-factory."></a>Configure an http-authentication-factory that uses the</h5>
<div class="paragraph">
<p>kerberos-security-factory.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=elytron/http-authentication-factory=example-krb-http-auth:add(http-server-mechanism-factory=global,security-domain=exampleFsSD,mechanism-configurations=[{mechanism-name=SPNEGO,mechanism-realm-configurations=[{realm-name=exampleFsSD}],credential-security-factory=krbSF}])</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="configure-an-application-security-domain-in-the-undertow-subsystem-4"><a class="anchor" href="#configure-an-application-security-domain-in-the-undertow-subsystem-4"></a>Configure an application-security-domain in the Undertow subsystem:</h5>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=undertow/application-security-domain=exampleApplicationDomain:add(http-authentication-factory=example-krb-http-auth)</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="configure-your-applications-web.xml-jboss-web.xml-and-jboss-deployment-structure.xml."><a class="anchor" href="#configure-your-applications-web.xml-jboss-web.xml-and-jboss-deployment-structure.xml."></a>Configure your application&#8217;s web.xml, jboss-web.xml and</h5>
<div class="paragraph">
<p>jboss-deployment-structure.xml.</p>
</div>
<div class="paragraph">
<p>Your application&#8217;s <em>web.xml</em> and <em>jboss-web.xml</em> must be updated to use
the <em>application-security-domain</em> you configured in WildFly. An example
of this is available in the
<a href="#configure-applications-to-use-elytron-or-legacy-security-for-authentication">Configure
Applications to Use Elytron or Legacy Security for Authentication</a>
section.</p>
</div>
<div class="paragraph">
<p>In addition, you need to update your <em>web.xml</em> to use <em>SPNEGO</em> as its
authentication method.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;login-config&gt;
  &lt;auth-method&gt;SPNEGO&lt;/auth-method&gt;
  &lt;realm-name&gt;exampleApplicationDomain&lt;/realm-name&gt;
&lt;/login-config&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="configure-authentication-with-a-form-as-a-fallback-for-kerberos"><a class="anchor" href="#configure-authentication-with-a-form-as-a-fallback-for-kerberos"></a>4.1.7. Configure Authentication with a Form as a Fallback for Kerberos</h4>
<div class="sect4">
<h5 id="configure-kerberos-based-authentication."><a class="anchor" href="#configure-kerberos-based-authentication."></a>Configure kerberos-based authentication.</h5>
<div class="paragraph">
<p>Configuring kerberos-based authentication is covered in a previous
section.</p>
</div>
</div>
<div class="sect4">
<h5 id="add-a-mechanism-for-form-authentication-in-the-http-authentication-factory."><a class="anchor" href="#add-a-mechanism-for-form-authentication-in-the-http-authentication-factory."></a>Add a mechanism for FORM authentication in the</h5>
<div class="paragraph">
<p>http-authentication-factory.</p>
</div>
<div class="paragraph">
<p>You can use the existing <em>http-authentication-factory</em> you configured
for kerberos-based authentication and and an additional mechanism for
<em>FORM</em> authentication.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=elytron/http-authentication-factory=example-krb-http-auth:list-add(name=mechanism-configurations, value={mechanism-name=FORM})</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="add-additional-fallback-principals."><a class="anchor" href="#add-additional-fallback-principals."></a>Add additional fallback principals.</h5>
<div class="paragraph">
<p>The existing configuration for kerberos-based authentication should
already have a security realm configured for mapping principals from
kerberos token to roles for the application. You can add additional
users for fallback authentication to that realm. For example if you used
a <em>filesystem-realm</em>, you can simply create a new user with the
appropriate roles:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=elytron/filesystem-realm=exampleFsRealm:add-identity(identity=fallbackUser1)
/subsystem=elytron/filesystem-realm=exampleFsRealm:set-password(identity=fallbackUser1,clear={password="password123"})
/subsystem=elytron/filesystem-realm=exampleFsRealm:add-identity-attribute(identity=fallbackUser1,name=Roles,value=["Admin","Guest"])</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="update-the-web.xml-for-form-fallback."><a class="anchor" href="#update-the-web.xml-for-form-fallback."></a>Update the web.xml for FORM fallback.</h5>
<div class="paragraph">
<p>You need to update the <em>web.xml</em> to use the value <em>SPNEGO,FORM</em> for the
<em>auth-method</em>, which will use <em>FORM</em> as a fallback authentication method
if <em>SPNEGO</em> fails. You also need to specify the location of your login
and error pages.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;login-config&gt;
  &lt;auth-method&gt;SPNEGO,FORM&lt;/auth-method&gt;
  &lt;realm-name&gt;exampleApplicationDomain&lt;/realm-name&gt;
  &lt;form-login-config&gt;
    &lt;form-login-page&gt;/login.jsp&lt;/form-login-page&gt;
    &lt;form-error-page&gt;/error.jsp&lt;/form-error-page&gt;
  &lt;/form-login-config&gt;
&lt;/login-config&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="configure-applications-to-use-elytron-or-legacy-security-for-authentication"><a class="anchor" href="#configure-applications-to-use-elytron-or-legacy-security-for-authentication"></a>4.1.8. Configure Applications to Use Elytron or Legacy Security for</h4>
<div class="paragraph">
<p>Authentication</p>
</div>
<div class="paragraph">
<p>After you have configured the <em>elytron</em> or legacy <em>security</em> subsystems
for authentication, you need to configure your application to use it.</p>
</div>
<div class="sect4">
<h5 id="configure-your-applications-web.xml."><a class="anchor" href="#configure-your-applications-web.xml."></a>Configure your application&#8217;s web.xml.</h5>
<div class="paragraph">
<p>Your application&#8217;s <em>web.xml</em> needs to be configured to use the
appropriate authentication method. When using <em>elytron</em>, this is defined
in the <em>http-authentication-factory</em> you created. When using the legacy
<em>security</em> subsystem, this depends on your login module and the type of
authentication you want to configure.</p>
</div>
<div class="paragraph">
<p>Example <em>web.xml</em> with <em>BASIC</em> Authentication</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;web-app&gt;
  &lt;security-constraint&gt;
    &lt;web-resource-collection&gt;
      &lt;web-resource-name&gt;secure&lt;/web-resource-name&gt;
      &lt;url-pattern&gt;/secure/*&lt;/url-pattern&gt;
    &lt;/web-resource-collection&gt;
    &lt;auth-constraint&gt;
      &lt;role-name&gt;Admin&lt;/role-name&gt;
    &lt;/auth-constraint&gt;
  &lt;/security-constraint&gt;
  &lt;security-role&gt;
    &lt;description&gt;The role that is required to log in to /secure/*&lt;/description&gt;
    &lt;role-name&gt;Admin&lt;/role-name&gt;
  &lt;/security-role&gt;
  &lt;login-config&gt;
    &lt;auth-method&gt;BASIC&lt;/auth-method&gt;
    &lt;realm-name&gt;exampleApplicationDomain&lt;/realm-name&gt;
  &lt;/login-config&gt;
&lt;/web-app&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p><em>BASIC</em> Authentication can be configured to be silent</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;auth-method&gt;BASIC?silent=true&lt;/auth-method&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Basic authentication in silent mode will send challenge to authenticate only if the request
contained authorization header, otherwise it is assumed another method will send the challenge.</p>
</div>
</div>
<div class="sect4">
<h5 id="configure-your-application-to-use-a-security-domain."><a class="anchor" href="#configure-your-application-to-use-a-security-domain."></a>Configure your application to use a security domain.</h5>
<div class="paragraph">
<p>You can configure your application&#8217;s <em>jboss-web.xml</em> to specify the
security domain you want to use for authentication. When using the
<em>elytron</em> subsystem, this is defined when you created the
<em>application-security-domain</em>. When using the legacy <em>security</em>
subsystem, this is the name of the legacy security domain.</p>
</div>
<div class="paragraph">
<p>Example <em>jboss-web.xml</em></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;jboss-web&gt;
  &lt;security-domain&gt;exampleApplicationDomain&lt;/security-domain&gt;
&lt;/jboss-web&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Using <em>jboss-web.xml</em> allows you to configure the security domain for a
single application only. Alternatively, you can specify a default
security domain for all applications using the <em>undertow</em> subsystem.
This allows you to omit using <em>jboss-web.xml</em> to configure a security
domain for an individual application.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=undertow:write-attribute(name=default-security-domain, value="exampleApplicationDomain")</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>IMPORTANT</strong>: Setting <em>default-security-domain</em> in the <em>undertow</em>
subsystem will apply to <strong>ALL</strong> applications. If <em>default-security-domain</em>
is set and an application specifies a security domain in a
<em>jboss-web.xml</em> file, the configuration in <em>jboss-web.xml</em> will override
the <em>default-security-domain</em> in the <em>undertow</em> subsystem.</p>
</div>
</div>
<div class="sect4">
<h5 id="using-elytron-and-legacy-security-subsystems-in-parallel"><a class="anchor" href="#using-elytron-and-legacy-security-subsystems-in-parallel"></a>Using Elytron and Legacy Security Subsystems in Parallel</h5>
<div class="paragraph">
<p>You can define authentication in both the <em>elytron</em> and legacy
<em>security</em> subsystems and use them in parallel. If you use both
<em>jboss-web.xml</em> and <em>default-security-domain</em> in the <em>undertow</em>
subsystem, WildFly will first try to match the configured security
domain in the <em>elytron</em> subsystem. If a match is not found, then WildFly
will attempt to match the security domain with one configured in the
legacy <em>security</em> subsystem. If the <em>elytron</em> and legacy <em>security</em>
subsystem each have a security domain with the same name, the <em>elytron</em>
security domain is used.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="override-an-applications-authentication-configuration"><a class="anchor" href="#override-an-applications-authentication-configuration"></a>4.1.9. Override an Application&#8217;s Authentication Configuration</h4>
<div class="paragraph">
<p>You can override the authentication configuration of an application with
one configured in WildFly. To do this, use the
<em>override-deployment-configuration</em> property in the
<em>application-security-domain</em> section of the <em>undertow</em> subsystem:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=undertow/application-security-domain=exampleApplicationDomain:write-attribute(name=override-deployment-config,value=true)</code></pre>
</div>
</div>
<div class="paragraph">
<p>For example, an application is configured to use <em>FORM</em> authentication
with the <em>exampleApplicationDomain</em> in its <em>jboss-web.xml</em>.</p>
</div>
<div class="paragraph">
<p><em>Example jboss-web.xml</em></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;login-config&gt;
  &lt;auth-method&gt;FORM&lt;/auth-method&gt;
  &lt;realm-name&gt;exampleApplicationDomain&lt;/realm-name&gt;
&lt;/login-config&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>By enabling <em>override-deployment-configuration</em>, you can create a new
<em>http-authentication-factory</em> that specifies a different authentication
mechanism such as <em>BASIC</em>.</p>
</div>
<div class="paragraph">
<p><em>Example http-authentication-factory</em></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=elytron/http-authentication-factory=exampleHttpAuth:read-resource()
{
    "outcome" =&gt; "success",
    "result" =&gt; {
        "http-server-mechanism-factory" =&gt; "global",
        "mechanism-configurations" =&gt; [{
            "mechanism-name" =&gt; "BASIC",
            "mechanism-realm-configurations" =&gt; [{"realm-name" =&gt; "exampleApplicationDomain"}]
        }],
        "security-domain" =&gt; "exampleSD"
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This will override the authentication mechanism defined in the
application&#8217;s <em>jboss-web.xml</em> and attempt to authenticate a user using
<em>BASIC</em> instead of <em>FORM</em>.</p>
</div>
</div>
<div class="sect3">
<h4 id="create-and-use-a-credential-store"><a class="anchor" href="#create-and-use-a-credential-store"></a>4.1.10. Create and Use a Credential Store</h4>
<div class="sect4">
<h5 id="create-credential-store."><a class="anchor" href="#create-credential-store."></a>Create credential store.</h5>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=elytron/credential-store=exampleCS:add(relative-to=jboss.server.data.dir, location=example.jceks,create=true,credential-reference={clear-text=cs-secret})</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="add-a-credential-to-a-credential-store."><a class="anchor" href="#add-a-credential-to-a-credential-store."></a>Add a credential to a credential store.</h5>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=elytron/credential-store=exampleCS:add-alias(alias=keystorepw,secret-value=secret)</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="list-all-credentials-in-a-credential-store."><a class="anchor" href="#list-all-credentials-in-a-credential-store."></a>List all credentials in a credential store.</h5>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=elytron/credential-store=exampleCS:read-aliases()
{
    "outcome" =&gt; "success",
    "result" =&gt; ["keystorepw"]
}</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="remove-a-credential-from-a-credential-store."><a class="anchor" href="#remove-a-credential-from-a-credential-store."></a>Remove a credential from a credential store.</h5>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=elytron/credential-store=exampleCS:remove-alias(alias=keystorepw)</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="use-a-credential-store."><a class="anchor" href="#use-a-credential-store."></a>Use a credential store.</h5>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=elytron/key-store=twoWayKS:write-attribute(name=credential-reference,value={store=exampleCS,alias=keystorepw})</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="set-up-and-configure-authentication-for-the-management-interfaces"><a class="anchor" href="#set-up-and-configure-authentication-for-the-management-interfaces"></a>4.2. Set up and Configure Authentication for the Management Interfaces</h3>
<div class="sect3">
<h4 id="secure-the-management-interfaces-with-a-new-identity-store"><a class="anchor" href="#secure-the-management-interfaces-with-a-new-identity-store"></a>4.2.1. Secure the Management Interfaces with a New Identity Store</h4>
<div class="sect4">
<h5 id="create-a-security-domain-and-any-supporting-security-realms-decoders-or-mappers-for-your-identity-store."><a class="anchor" href="#create-a-security-domain-and-any-supporting-security-realms-decoders-or-mappers-for-your-identity-store."></a>Create a security domain and any supporting security realms,</h5>
<div class="paragraph">
<p>decoders, or mappers for your identity store.</p>
</div>
<div class="paragraph">
<p>This process is covered in a previous section. For example, if you
wanted to secure the management interfaces using a filesystem-based
identity store, you would follow the steps in
<a href="#configure-authentication-with-a-filesystem-based-identity-store">Configure
Authentication with a Filesystem-Based Identity Store</a>.</p>
</div>
</div>
<div class="sect4">
<h5 id="create-an-http-authentication-factory-or-sasl-authentication-factory."><a class="anchor" href="#create-an-http-authentication-factory-or-sasl-authentication-factory."></a>Create an http-authentication-factory or</h5>
<div class="paragraph">
<p>sasl-authentication-factory.</p>
</div>
<div class="paragraph">
<p>Example <em>http-authentication-factory</em></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=elytron/http-authentication-factory=example-http-auth:add(http-server-mechanism-factory=global,security-domain=exampleSD,mechanism-configurations=[{mechanism-name=DIGEST,mechanism-realm-configurations=[{realm-name=exampleManagementRealm}]}])</code></pre>
</div>
</div>
<div class="paragraph">
<p>Example <em>sasl-authentication-factory</em></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=elytron/sasl-authentication-factory=example-sasl-auth:add(sasl-server-factory=configured,security-domain=exampleSD,mechanism-configurations=[{mechanism-name=DIGEST-MD5,mechanism-realm-configurations=[{realm-name=exampleManagementRealm}]}])</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="update-the-management-interfaces-to-use-your-http-authentication-factory-or-sasl-authentication-factory."><a class="anchor" href="#update-the-management-interfaces-to-use-your-http-authentication-factory-or-sasl-authentication-factory."></a>Update the management interfaces to use your</h5>
<div class="paragraph">
<p>http-authentication-factory or sasl-authentication-factory.</p>
</div>
<div class="paragraph">
<p>Example update <em>http-authentication-factory</em></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/core-service=management/management-interface=http-interface:write-attribute(name=http-authentication-factory, value=example-http-auth)
{
   "outcome" =&gt; "success",
   "response-headers" =&gt; {
       "operation-requires-reload" =&gt; true,
       "process-state" =&gt; "reload-required"
   }
}

reload</code></pre>
</div>
</div>
<div class="paragraph">
<p>Example update <em>sasl-authentication-factory</em></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/core-service=management/management-interface=http-interface:write-attribute(name=http-upgrade.sasl-authentication-factory, value=example-sasl-auth)
{
   "outcome" =&gt; "success",
   "response-headers" =&gt; {
       "operation-requires-reload" =&gt; true,
       "process-state" =&gt; "reload-required"
   }
}

reload</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="silent-authentication"><a class="anchor" href="#silent-authentication"></a>4.2.2. Silent Authentication</h4>
<div class="paragraph">
<p>By default, WildFly provides an authentication mechanism for local
users, also know as silent authentication, through the <em>local</em> security
realm.</p>
</div>
<div class="paragraph">
<p>Silent authentication must be used via a <em>sasl-authentication-factory</em>.</p>
</div>
<div class="paragraph">
<p><strong>IMPORTANT</strong>: When enabling silent authentication, you must ensure the
security domain referenced by your <em>sasl-authentication-factory</em>
references a security realm that contains the <em>$local</em> user. By default,
WildFly provides the <em>local</em> identity realm that provides this user.</p>
</div>
<div class="sect4">
<h5 id="add-silent-authentication-to-an-existing-sasl-authentication-factory."><a class="anchor" href="#add-silent-authentication-to-an-existing-sasl-authentication-factory."></a>Add silent authentication to an existing</h5>
<div class="paragraph">
<p>sasl-authentication-factory.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=elytron/sasl-authentication-factory=example-sasl-auth:list-add(name=mechanism-configurations, value={mechanism-name=JBOSS-LOCAL-USER, realm-mapper=local})

reload</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="create-a-new-sasl-server-factory-with-silent-authentication."><a class="anchor" href="#create-a-new-sasl-server-factory-with-silent-authentication."></a>Create a new sasl-server-factory with silent authentication.</h5>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=elytron/sasl-authentication-factory=example-sasl-auth:add(sasl-server-factory=configured,security-domain=exampleSD,mechanism-configurations=[{mechanism-name=DIGEST-MD5,mechanism-realm-configurations=[{realm-name=exampleManagementRealm}]},{mechanism-name=JBOSS-LOCAL-USER, realm-mapper=local}])

reload</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="remove-silent-authentication-from-an-existing-sasl-server-factory"><a class="anchor" href="#remove-silent-authentication-from-an-existing-sasl-server-factory"></a>Remove silent authentication from an existing sasl-server-factory:</h5>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=elytron/sasl-authentication-factory=managenet-sasl-authentication:read-resource
{
    "outcome" =&gt; "success",
    "result" =&gt; {
        "mechanism-configurations" =&gt; [
            {
                "mechanism-name" =&gt; "JBOSS-LOCAL-USER",
                "realm-mapper" =&gt; "local"
            },
            {
                "mechanism-name" =&gt; "DIGEST-MD5",
                "mechanism-realm-configurations" =&gt; [{"realm-name" =&gt; "ManagementRealm"}]
            }
        ],
        "sasl-server-factory" =&gt; "configured",
        "security-domain" =&gt; "ManagementDomain"
    }
}

/subsystem=elytron/sasl-authentication-factory=temp-sasl-authentication:list-remove(name=mechanism-configurations,index=0)

reload</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="using-rbac-with-elytron"><a class="anchor" href="#using-rbac-with-elytron"></a>4.2.3. Using RBAC with Elytron</h4>
<div class="paragraph">
<p>RBAC can be configured to automatically assign or exclude roles for
users that are members of groups. This is configured in the
<em>access-control</em> section of the core management. When the management
interfaces are secured with the <em>elytron</em> subsystem, and users are
assigned groups when they authenticate. You can also configure roles to
be assigned to authenticated users in a variety of ways using the
<em>elytron</em> subsystem, for example using a role mapper or a role decoder.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="configure-ssltls"><a class="anchor" href="#configure-ssltls"></a>4.3. Configure SSL/TLS</h3>
<div class="sect3">
<h4 id="enable-one-way-ssltls-for-applications"><a class="anchor" href="#enable-one-way-ssltls-for-applications"></a>4.3.1. Enable One-way SSL/TLS for Applications</h4>
<div class="paragraph">
<p>There are a couple ways to enable one-way SSL/TLS for deployed applications.</p>
</div>
<div class="sect4">
<h5 id="one-way-ssl-applications-using-security-command"><a class="anchor" href="#one-way-ssl-applications-using-security-command"></a>Using a security command:</h5>
<div class="paragraph">
<p>The <em>security enable-ssl-http-server</em> command can be used to enable one-way
SSL/TLS for deployed applications. Example of wizard usage:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">security enable-ssl-http-server --interactive
Please provide required pieces of information to enable SSL:
Key-store file name (default default-server.keystore): keystore.jks
Password (blank generated): secret
What is your first and last name? [Unknown]: localhost
What is the name of your organizational unit? [Unknown]:
What is the name of your organization? [Unknown]:
What is the name of your City or Locality? [Unknown]:
What is the name of your State or Province? [Unknown]:
What is the two-letter country code for this unit? [Unknown]:
Is CN=Unknown, OU=Unknown, O=Unknown, L=Unknown, ST=Unknown, C=Unknown correct y/n [y]?
Validity (in days, blank default): 365
Alias (blank generated): localhost
Enable SSL Mutual Authentication y/n (blank n): n

SSL options:
key store file: keystore.jks
distinguished name: CN=localhost, OU=Unknown, O=Unknown, L=Unknown, ST=Unknown, C=Unknown
password: secret
validity: 365
alias: localhost
Server keystore file keystore.jks, certificate file keystore.pem and keystore.csr file
will be generated in server configuration directory.
Do you confirm y/n: y</code></pre>
</div>
</div>
<div class="paragraph">
<p>NB: Once the command is executed, the CLI will reload the server.</p>
</div>
<div class="paragraph">
<p>HTTPS is now enabled for applications.</p>
</div>
</div>
<div class="sect4">
<h5 id="one-way-ssl-applications-using-elytron-subsystem-commands"><a class="anchor" href="#one-way-ssl-applications-using-elytron-subsystem-commands"></a>Using Elytron subsystem commands:</h5>
<div class="paragraph">
<p>You can also use the Elytron subsystem, along with the Undertow subsystem, to
enable HTTPS for deployed applications.</p>
</div>
<div class="sect5">
<h6 id="configure-a-key-store-in-wildfly"><a class="anchor" href="#configure-a-key-store-in-wildfly"></a>Configure a key-store in WildFly:</h6>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=elytron/key-store=httpsKS:add(path=/path/to/keystore.jks,credential-reference={clear-text=secret},type=JKS)</code></pre>
</div>
</div>
<div class="paragraph">
<p>The previous command uses an absolute path to the keystore.
Alternatively you can use the <em>relative-to</em> attribute to specify the
base directory variable and <em>path</em> specify a relative path.
Also, in case of file-based keystore the <em>type</em> attribute can be omitted and
the keystore type will be automatically detected.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=elytron/key-store=httpsKS:add(path=keystore.jks,relative-to=jboss.server.config.dir,credential-reference={clear-text=secret},type=JKS)</code></pre>
</div>
</div>
<div class="paragraph">
<p>If the keystore file does not exist yet, the following commands can be used to
generate an example key pair:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=elytron/key-store=httpsKS:generate-key-pair(alias=localhost,algorithm=RSA,key-size=1024,validity=365,credential-reference={clear-text=secret},distinguished-name="CN=localhost")
/subsystem=elytron/key-store=httpsKS:store()</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="configure-a-key-manager-in-that-references-your-key-store"><a class="anchor" href="#configure-a-key-manager-in-that-references-your-key-store"></a>Configure a key-manager that references your key-store:</h6>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=elytron/key-manager=httpsKM:add(key-store=httpsKS,credential-reference={clear-text=secret})</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="configure-a-server-ssl-context-in-that-references-your-key-manager"><a class="anchor" href="#configure-a-server-ssl-context-in-that-references-your-key-manager"></a>Configure a server-ssl-context that references your key-manager:</h6>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=elytron/server-ssl-context=httpsSSC:add(key-manager=httpsKM,protocols=["TLSv1.2"])</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>IMPORTANT</strong>: You need to determine what SSL/TLS protocols you want to
support. The example commands above uses <em>TLSv1.2</em>.</p>
</div>
</div>
<div class="sect5">
<h6 id="check-and-see-if-the-https-listener-is-configured-to-use-a-legacy-security-realm-for-its-ssl-configuration"><a class="anchor" href="#check-and-see-if-the-https-listener-is-configured-to-use-a-legacy-security-realm-for-its-ssl-configuration"></a>Check and see if the https-listener is configured to use a legacy security realm for its SSL configuration:</h6>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=undertow/server=default-server/https-listener=https:read-attribute(name=security-realm)
{
    "outcome" =&gt; "success",
    "result" =&gt; "ApplicationRealm"
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The above command shows that the <em>https-listener</em> is configured to use
the <em>ApplicationRealm</em> legacy security realm for its SSL configuration.
Undertow cannot reference both a legacy security realm and an
<em>ssl-context</em> in Elytron at the same time so you must remove the
reference to the legacy security realm. Also there has to be always
configured either <em>ssl-context</em> or <em>security-realm</em>. Thus when changing
between those, you have to use batch operation:</p>
</div>
<div class="paragraph">
<p><strong>Remove the reference to the legacy security realm and update the</strong>
<strong><em>https-listener</em></strong> <strong>to use the</strong> <strong><em>ssl-context</em></strong> <strong>from Elytron</strong> <strong>:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>batch
/subsystem=undertow/server=default-server/https-listener=https:undefine-attribute(name=security-realm)
/subsystem=undertow/server=default-server/https-listener=https:write-attribute(name=ssl-context,value=httpsSSC)
run-batch</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="reload-the-server"><a class="anchor" href="#reload-the-server"></a>Reload the server:</h6>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>reload</code></pre>
</div>
</div>
<div class="paragraph">
<p>HTTPS is now enabled for applications.</p>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="enable-two-way-ssltls-in-wildfly-for-applications"><a class="anchor" href="#enable-two-way-ssltls-in-wildfly-for-applications"></a>4.3.2. Enable Two-way SSL/TLS in WildFly for Applications</h4>
<div class="paragraph">
<p>First, obtain or generate your client keystore.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>$ keytool -genkeypair -alias client -keyalg RSA -keysize 1024 -validity 365 -keystore client.keystore.jks -dname "CN=client" -keypass secret -storepass secret</code></pre>
</div>
</div>
<div class="paragraph">
<p>Export the client certificate:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>$ keytool -exportcert  -keystore client.keystore.jks -alias client -keypass secret -storepass secret -file /path/to/client.cer</code></pre>
</div>
</div>
<div class="paragraph">
<p>There are a couple ways to enable two-way SSL/TLS for deployed applications.</p>
</div>
<div class="sect4">
<h5 id="two-way-ssl-applications-using-security-command"><a class="anchor" href="#two-way-ssl-applications-using-security-command"></a>Using a security command:</h5>
<div class="paragraph">
<p>The <em>security enable-ssl-http-server</em> command can be used to enable two-way
SSL/TLS for the deployed applications. Example of wizard usage:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">security enable-ssl-http-server --interactive
Please provide required pieces of information to enable SSL:
Key-store file name (default default-server.keystore): server.keystore.jks
Password (blank generated): secret
What is your first and last name? [Unknown]: localhost
What is the name of your organizational unit? [Unknown]:
What is the name of your organization? [Unknown]:
What is the name of your City or Locality? [Unknown]:
What is the name of your State or Province? [Unknown]:
What is the two-letter country code for this unit? [Unknown]:
Is CN=Unknown, OU=Unknown, O=Unknown, L=Unknown, ST=Unknown, C=Unknown correct y/n [y]?
Validity (in days, blank default): 365
Alias (blank generated): localhost
Enable SSL Mutual Authentication y/n (blank n): y
Client certificate (path to pem file): /path/to/client.cer
Validate certificate y/n (blank y):
Trust-store file name (management.truststore): server.truststore.jks
Password (blank generated): secret

SSL options:
key store file: server.keystore.jks
distinguished name: CN=localhost, OU=Unknown, O=Unknown, L=Unknown, ST=Unknown, C=Unknown
password: secret
validity: 365
alias: localhost
client certificate: /path/to/client.cer
trust store file: server.trustore.jks
trust store password: secret
Server keystore file server.keystore.jks, certificate file server.pem and server.csr file will be generated in server configuration directory.
Server truststore file server.trustore.jks will be generated in server configuration directory.
Do you confirm y/n: y</code></pre>
</div>
</div>
<div class="paragraph">
<p>NB: Once the command is executed, the CLI will reload the server. To complete
the two-way SSL/TLS authentication, you need to
<a href="#import-server-certificate-into-client-truststore-applications">import the server certificate</a>
into the client truststore and
<a href="#configure-your-client-to-use-the-client-certificate-applications">configure your client</a>
to present the client certificate.</p>
</div>
</div>
<div class="sect4">
<h5 id="two-way-ssl-applications-using-elytron-subsystem-commands"><a class="anchor" href="#two-way-ssl-applications-using-elytron-subsystem-commands"></a>Using Elytron subsystem commands:</h5>
<div class="paragraph">
<p>You can also use the Elytron subsystem, along with the Undertow subsystem,
to enable two-way SSL/TLS for deployed applications.</p>
</div>
<div class="sect5">
<h6 id="obtain-or-generate-your-keystores-applications"><a class="anchor" href="#obtain-or-generate-your-keystores-applications"></a>Obtain or generate your key stores:</h6>
<div class="paragraph">
<p>Before enabling HTTPS in WildFly, you must obtain or generate the server key
store and trust store you plan on using. To generate an example key store and
trust store, use the following commands.</p>
</div>
<div class="paragraph">
<p>Create a server key-store:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=elytron/key-store=twoWayKS:add(path=/path/to/server.keystore.jks,credential-reference={clear-text=secret},type=JKS)
/subsystem=elytron/key-store=twoWayKS:generate-key-pair(alias=localhost,algorithm=RSA,key-size=1024,validity=365,credential-reference={clear-text=secret},distinguished-name="CN=localhost")
/subsystem=elytron/key-store=twoWayKS:store()</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>NOTE</strong><br>
The first command above uses an absolute path to the keystore.
Alternatively you can use the <em>relative-to</em> attribute to specify the
base directory variable and <em>path</em> specify a relative path.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=elytron/key-store=twoWayKS:add(path=server.keystore.jks,relative-to=jboss.server.config.dir,credential-reference={clear-text=secret},type=JKS)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Export the server certificate:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=elytron/key-store=twoWayKS:export-certificate(alias=localhost,path=/path/to/server.cer,pem=true)</code></pre>
</div>
</div>
<div id="import-client-certificate" class="paragraph">
<p>Create a key-store for the server truststore and import the client certificate
into the server truststore:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=elytron/key-store=twoWayTS:add(path=/path/to/server.truststore.jks,credential-reference={clear-text=secret},type=JKS)
/subsystem=elytron/key-store=twoWayTS:import-certificate(alias=client,path=/path/to/client.cer,credential-reference={clear-text=secret},trust-cacerts=true)
/subsystem=elytron/key-store=twoWayTS:store()</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="configure-a-key-manager-in-that-references-your-key-store-key-store"><a class="anchor" href="#configure-a-key-manager-in-that-references-your-key-store-key-store"></a>Configure a key-manager that references your key store key-store:</h6>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=elytron/key-manager=twoWayKM:add(key-store=twoWayKS,credential-reference={clear-text=secret})</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="configure-a-trust-manager-in-that-references-your-truststore-key-store"><a class="anchor" href="#configure-a-trust-manager-in-that-references-your-truststore-key-store"></a>Configure a trust-manager that references your truststore key-store:</h6>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=elytron/trust-manager=twoWayTM:add(key-store=twoWayTS)</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="configure-a-server-ssl-context-in-that-references-your-key-manager-trust-manager-and-enables-client-authentication"><a class="anchor" href="#configure-a-server-ssl-context-in-that-references-your-key-manager-trust-manager-and-enables-client-authentication"></a>Configure a server-ssl-context that references your key-manager, trust-manager, and enables client authentication:</h6>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=elytron/server-ssl-context=twoWaySSC:add(key-manager=twoWayKM,protocols=["TLSv1.2"],trust-manager=twoWayTM,need-client-auth=true)</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>IMPORTANT</strong><br>
You need to determine what SSL/TLS protocols you want to support. The
example commands above uses <em>TLSv1.2</em>.</p>
</div>
</div>
<div class="sect5">
<h6 id="check-and-see-if-the-https-listener-is-configured-to-use-a-legacy-security-realm-for-its-ssl-configuration-1"><a class="anchor" href="#check-and-see-if-the-https-listener-is-configured-to-use-a-legacy-security-realm-for-its-ssl-configuration-1"></a>Check and see if the https-listener is configured to use a legacy security realm for its SSL configuration:</h6>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=undertow/server=default-server/https-listener=https:read-attribute(name=security-realm)
{
    "outcome" =&gt; "success",
    "result" =&gt; "ApplicationRealm"
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The above command shows that the <em>https-listener</em> is configured to use
the <em>ApplicationRealm</em> legacy security realm for its SSL configuration.
Undertow cannot reference both a legacy security realm and an
<em>ssl-context</em> in Elytron at the same time so you must remove the
reference to the legacy security realm. Also there has to be always
configured either <em>ssl-context</em> or <em>security-realm</em>. Thus when changing
between those, you have to use batch operation:</p>
</div>
</div>
<div class="sect5">
<h6 id="remove-the-reference-to-the-legacy-security-realm-and-update-the-https-listener-to-use-the-ssl-context-from-elytron"><a class="anchor" href="#remove-the-reference-to-the-legacy-security-realm-and-update-the-https-listener-to-use-the-ssl-context-from-elytron"></a>Remove the reference to the legacy security realm and update the</h6>
<div class="paragraph">
<p>https-listener to use the ssl-context from Elytron:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>batch
/subsystem=undertow/server=default-server/https-listener=https:undefine-attribute(name=security-realm)
/subsystem=undertow/server=default-server/https-listener=https:write-attribute(name=ssl-context,value=twoWaySSC)
run-batch</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="reload-the-server-1"><a class="anchor" href="#reload-the-server-1"></a>Reload the server</h6>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>reload</code></pre>
</div>
</div>
<div class="paragraph">
<p>To complete the two-way SSL/TLS authentication, you need to
<a href="#import-server-certificate-into-client-truststore-applications">import the server certificate</a>
into the client truststore and
<a href="#configure-your-client-to-use-the-client-certificate-applications">configure your client</a>
to present the client certificate.</p>
</div>
</div>
</div>
<div class="sect4">
<h5 id="import-server-certificate-into-client-truststore-applications"><a class="anchor" href="#import-server-certificate-into-client-truststore-applications"></a>Import the server certificate into the client truststore</h5>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>$ keytool -importcert -keystore client.truststore.jks -storepass secret -alias localhost -trustcacerts -file /path/to/server.cer</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="configure-your-client-to-use-the-client-certificate-applications"><a class="anchor" href="#configure-your-client-to-use-the-client-certificate-applications"></a>Configure your client to use the client certificate</h5>
<div class="paragraph">
<p>You need to configure your client to present the trusted client
certificate to the server to complete the two-way SSL/TLS
authentication. For example, if using a browser, you need to import the
trusted certificate into the browser&#8217;s truststore.</p>
</div>
<div class="paragraph">
<p>Two-Way HTTPS is now enabled for applications.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="configure-certificate-revocation-in-trust-manager"><a class="anchor" href="#configure-certificate-revocation-in-trust-manager"></a>4.3.3. Configure certificate revocation in trust-manager</h4>
<div class="sect4">
<h5 id="configure-certificate-revocation-list"><a class="anchor" href="#configure-certificate-revocation-list"></a>Configure Certificate Revocation List:</h5>
<div class="paragraph">
<p>You can configure your trust-manager to use certificate-revocation-list (CRL) to check revocation status of obtained certificates.</p>
</div>
<div class="paragraph">
<p>The supported attributes for a certificate-revocation-list include:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>path: The path to the configuration file that is used to initialize the certificate revocation list.</p>
</li>
<li>
<p>relative-to: The base path of the certificate revocation list file.</p>
</li>
<li>
<p>maximum-cert-path: The maximum number of non-self-issued intermediate certificates that can exist in a certification path.
The default value is 5. (Deprecated. Use maximum-cert-path in trust-manager).</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=elytron/trust-manager=twoWayTM:write-attribute(name=certificate-revocation-list, value={})</code></pre>
</div>
</div>
<div class="paragraph">
<p>This will use CRLs obtained from distribution points referenced in your certificates.</p>
</div>
<div class="paragraph">
<p><strong>NOTE:</strong> To use a CRL your trust store must contain the certificate chain in order to check validity of both CRL list.</p>
</div>
<div class="sect5">
<h6 id="override-crl-location-obtained-from-certificates"><a class="anchor" href="#override-crl-location-obtained-from-certificates"></a>Override CRL location obtained from certificates:</h6>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=elytron/trust-manager=twoWayTM:write-attribute(name=certificate-revocation-list.path, value=intermediate.crl.pem)</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="_configure_multiple_certificate_revocation_lists"><a class="anchor" href="#_configure_multiple_certificate_revocation_lists"></a>Configure multiple certificate revocation lists</h6>
<div class="paragraph">
<p>Alternatively, you can configure multiple certificate revocation lists in your trust-manager using
the certificate-revocation-lists attribute as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=elytron/trust-manager=twoWayTM:write-attribute(name=certificate-revocation-lists, value=[{path="PATH/TO/CRL"}, {path="PATH/TO/OTHER/CRL"}])</code></pre>
</div>
</div>
<div class="paragraph">
<p>The supported attributes for certificate-revocation-lists include a list of certificate-revocation-list objects containing:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>path: The path to the configuration file that is used to initialize the certificate revocation list.</p>
</li>
<li>
<p>relative-to: The base path of the certificate revocation list file.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect4">
<h5 id="configure-ocsp-certificate-revocation"><a class="anchor" href="#configure-ocsp-certificate-revocation"></a>Configure OCSP certificate revocation:</h5>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=elytron/trust-manager=twoWayTM:write-attribute(name=ocsp, value={})</code></pre>
</div>
</div>
<div class="paragraph">
<p>This will enable OCSP certificate revocation by using OCSP responder inside the certificate. In case the responder is known but OCSP revocation status is unknown, the verification will fail.</p>
</div>
<div class="sect5">
<h6 id="override-ocsp-responder-uri-extracted-from-certificate"><a class="anchor" href="#override-ocsp-responder-uri-extracted-from-certificate"></a>Override OCSP responder URI extracted from certificate:</h6>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=elytron/trust-manager=twoWayTM:write-attribute(name=ocsp.responder, value="http://example.com/ocsp-responder")</code></pre>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="configure-order-of-certificate-revocation-mechanisms"><a class="anchor" href="#configure-order-of-certificate-revocation-mechanisms"></a>Configure order of revocation mechanisms:</h5>
<div class="paragraph">
<p>If both CRL and OCSP are defined, Elytron will use OCSP for obtaining revocation status as first by default. In case you want to prefer CRL:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=elytron/trust-manager=twoWayTM:write-attribute(name=ocsp.prefer-crls, value="true")</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="other-trust-manager-configuration"><a class="anchor" href="#other-trust-manager-configuration"></a>Other trust-manager configuration:</h5>
<div class="sect5">
<h6 id="configure-trust-manager-to-only-check-leaf-certificates-for-revocation-status"><a class="anchor" href="#configure-trust-manager-to-only-check-leaf-certificates-for-revocation-status"></a>Configure trust-manager to only check leaf certificates for revocation status</h6>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=elytron/trust-manager=twoWayTM:write-attribute(name=only-leaf-cert, value="true")</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="configure-trust-manager-to-accept-certificates-with-unknown-revocation-status"><a class="anchor" href="#configure-trust-manager-to-accept-certificates-with-unknown-revocation-status"></a>Configure trust-manager to accept certificates with unknown revocation status</h6>
<div class="paragraph">
<p>In case you want to accept certificates with unknown revocation status, you can enable soft-fail behaviour in your trust-manager.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=elytron/trust-manager=twoWayTM:write-attribute(name=soft-fail, value=true)</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="set-maximum-number-of-intermediate-certificates-of-trust-manager"><a class="anchor" href="#set-maximum-number-of-intermediate-certificates-of-trust-manager"></a>Set maximum number of intermediate certificates of trust-manager</h6>
<div class="paragraph">
<p>Sets the value of the maximum number of non-self-issued intermediate certificates that may exist in a certification path with default value of 5.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=elytron/trust-manager=twoWayTM:write-attribute(name=maximum-cert-path, value=10)</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="enable-one-way-ssltls-for-the-management-interfaces"><a class="anchor" href="#enable-one-way-ssltls-for-the-management-interfaces"></a>4.3.4. Enable One-way SSL/TLS for the Management Interfaces</h4>
<div class="paragraph">
<p>There are a couple ways to enable one-way SSL/TLS for the management interfaces.</p>
</div>
<div class="sect4">
<h5 id="one-way-ssl-management-interfaces-using-security-command"><a class="anchor" href="#one-way-ssl-management-interfaces-using-security-command"></a>Using a security command:</h5>
<div class="paragraph">
<p>The <em>security enable-ssl-management</em> command can be used to enable one-way
SSL/TLS for the management interfaces. Example of wizard usage:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">security enable-ssl-management --interactive
Please provide required pieces of information to enable SSL:
Key-store file name (default management.keystore): keystore.jks
Password (blank generated): secret
What is your first and last name? [Unknown]: localhost
What is the name of your organizational unit? [Unknown]:
What is the name of your organization? [Unknown]:
What is the name of your City or Locality? [Unknown]:
What is the name of your State or Province? [Unknown]:
What is the two-letter country code for this unit? [Unknown]:
Is CN=Unknown, OU=Unknown, O=Unknown, L=Unknown, ST=Unknown, C=Unknown correct y/n [y]?
Validity (in days, blank default): 365
Alias (blank generated): localhost
Enable SSL Mutual Authentication y/n (blank n): n

SSL options:
key store file: keystore.jks
distinguished name: CN=localhost, OU=Unknown, O=Unknown, L=Unknown, ST=Unknown, C=Unknown
password: secret
validity: 365
alias: localhost
Server keystore file keystore.jks, certificate file keystore.pem and keystore.csr file
will be generated in server configuration directory.
Do you confirm y/n :y</code></pre>
</div>
</div>
<div class="paragraph">
<p>NB: Once the command is executed, the CLI will reload the server and reconnect to it.</p>
</div>
<div class="paragraph">
<p>HTTPS is now enabled for the management interfaces.</p>
</div>
</div>
<div class="sect4">
<h5 id="one-way-ssl-management-interfaces-using-elytron-subsystem-commands"><a class="anchor" href="#one-way-ssl-management-interfaces-using-elytron-subsystem-commands"></a>Using Elytron subsystem commands:</h5>
<div class="paragraph">
<p>Elytron subsystem commands can also be used to enable one-way SSL/TLS for the
management interfaces.</p>
</div>
<div class="sect5">
<h6 id="configure-key-store"><a class="anchor" href="#configure-key-store"></a>Configure a key-store:</h6>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=elytron/key-store=httpsKS:add(path=keystore.jks,relative-to=jboss.server.config.dir,credential-reference={clear-text=secret},type=JKS)</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>NOTE:</strong> The above command uses <em>relative-to</em> to reference the location
of the keystore file. Alternatively, you can specify the full path to
the keystore in <em>path</em> and omit <em>relative-to</em>.</p>
</div>
<div class="paragraph">
<p>If the keystore file does not exist yet, the following commands can be used to
generate an example key pair:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=elytron/key-store=httpsKS:generate-key-pair(alias=localhost,algorithm=RSA,key-size=1024,validity=365,credential-reference={clear-text=secret},distinguished-name="CN=localhost")
/subsystem=elytron/key-store=httpsKS:store()</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="create-a-key-manager-and-server-ssl-context"><a class="anchor" href="#create-a-key-manager-and-server-ssl-context"></a>Create a key-manager and server-ssl-context.</h6>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=elytron/key-manager=httpsKM:add(key-store=httpsKS,credential-reference={clear-text=secret})

/subsystem=elytron/server-ssl-context=httpsSSC:add(key-manager=httpsKM,protocols=["TLSv1.2"])</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>IMPORTANT:</strong> You need to determine what SSL/TLS protocols you want to
support. The example commands above uses <em>TLSv1.2</em>.</p>
</div>
</div>
<div class="sect5">
<h6 id="enable-https-on-the-management-interface."><a class="anchor" href="#enable-https-on-the-management-interface."></a>Enable HTTPS on the management interface.</h6>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/core-service=management/management-interface=http-interface:write-attribute(name=ssl-context, value=httpsSSC)

/core-service=management/management-interface=http-interface:write-attribute(name=secure-socket-binding, value=management-https)</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="reload-the-wildfly-instance."><a class="anchor" href="#reload-the-wildfly-instance."></a>Reload the WildFly instance.</h6>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>reload</code></pre>
</div>
</div>
<div class="paragraph">
<p>HTTPS is now enabled for the management interfaces.</p>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="enable-two-way-ssltls-for-the-management-interfaces"><a class="anchor" href="#enable-two-way-ssltls-for-the-management-interfaces"></a>4.3.5. Enable Two-way SSL/TLS for the Management Interfaces</h4>
<div class="paragraph">
<p>First, obtain or generate your client keystore.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>$ keytool -genkeypair -alias client -keyalg RSA -keysize 1024 -validity 365 -keystore client.keystore.jks -dname "CN=client" -keypass secret -storepass secret</code></pre>
</div>
</div>
<div class="paragraph">
<p>Export your client certificate.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>$ keytool -exportcert  -keystore client.keystore.jks -alias client -keypass secret -storepass secret -file /path/to/client.cer</code></pre>
</div>
</div>
<div class="paragraph">
<p>There are a couple ways to enable two-way SSL/TLS for the management interfaces.</p>
</div>
<div class="sect4">
<h5 id="two-way-ssl-management-interfaces-using-security-command"><a class="anchor" href="#two-way-ssl-management-interfaces-using-security-command"></a>Using a security command:</h5>
<div class="paragraph">
<p>The <em>security enable-ssl-management</em> command can be used to enable two-way
SSL/TLS for the management interfaces. Example of wizard usage:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">security enable-ssl-management --interactive
Please provide required pieces of information to enable SSL:
Key-store file name (default management.keystore): server.keystore.jks
Password (blank generated): secret
What is your first and last name? [Unknown]: localhost
What is the name of your organizational unit? [Unknown]:
What is the name of your organization? [Unknown]:
What is the name of your City or Locality? [Unknown]:
What is the name of your State or Province? [Unknown]:
What is the two-letter country code for this unit? [Unknown]:
Is CN=Unknown, OU=Unknown, O=Unknown, L=Unknown, ST=Unknown, C=Unknown correct y/n [y]?
Validity (in days, blank default): 365
Alias (blank generated): localhost
Enable SSL Mutual Authentication y/n (blank n): y
Client certificate (path to pem file): /path/to/client.cer
Validate certificate y/n (blank y):
Trust-store file name (management.truststore): server.truststore.jks
Password (blank generated): secret

SSL options:
key store file: server.keystore.jks
distinguished name: CN=localhost, OU=Unknown, O=Unknown, L=Unknown, ST=Unknown, C=Unknown
password: secret
validity: 365
alias: localhost
client certificate: /path/to/client.cer
trust store file: server.trustore.jks
trust store password: secret
Server keystore file server.keystore.jks, certificate file server.pem and server.csr file will be generated in server configuration directory.
Server truststore file server.trustore.jks will be generated in server configuration directory.
Do you confirm y/n: y</code></pre>
</div>
</div>
<div class="paragraph">
<p>NB: Once the command is executed, the CLI will reload the server and
attempt to reconnect to it. To complete the two-way SSL/TLS authentication,
you need to <a href="#import-server-certificate-into-client-truststore-management">import the server certificate</a>
into the client truststore and
<a href="#configure-your-client-to-use-the-client-certificate-management">configure your client</a>
to present the client certificate.</p>
</div>
</div>
<div class="sect4">
<h5 id="two-way-ssl-management-interfaces-using-elytron-subsystem-commands"><a class="anchor" href="#two-way-ssl-management-interfaces-using-elytron-subsystem-commands"></a>Using Elytron subsystem commands:</h5>
<div class="paragraph">
<p>Elytron subsystem commands can also be used to enable two-way SSL/TLS for the
management interfaces.</p>
</div>
<div class="sect5">
<h6 id="obtain-or-generate-your-key-stores-management"><a class="anchor" href="#obtain-or-generate-your-key-stores-management"></a>Obtain or generate your key stores.</h6>
<div class="paragraph">
<p>Before enabling HTTPS in WildFly, you must obtain or generate the server
key store and trust store you plan on using. To generate an example key
store and trust store, use the following commands.</p>
</div>
<div class="paragraph">
<p>Configure a key-store.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=elytron/key-store=twoWayKS:add(path=server.keystore.jks,relative-to=jboss.server.config.dir,credential-reference={clear-text=secret},type=JKS)

/subsystem=elytron/key-store=twoWayKS:generate-key-pair(alias=localhost,algorithm=RSA,key-size=1024,validity=365,credential-reference={clear-text=secret},distinguished-name="CN=localhost")

/subsystem=elytron/key-store=twoWayKS:store()</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>NOTE:</strong> The above command uses <em>relative-to</em> to reference the location
of the keystore file. Alternatively, you can specify the full path to
the keystore in <em>path</em> and omit <em>relative-to</em>.</p>
</div>
<div class="paragraph">
<p>Export your server certificate.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=elytron/key-store=twoWayKS:export-certificate(alias=localhost,path=/path/to/server.cer,pem=true)</code></pre>
</div>
</div>
<div id="import-client-certificate-into-server-truststore" class="paragraph">
<p>Create a key-store for the server trust store and import the client certificate
into the server trust store.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=elytron/key-store=twoWayTS:add(path=server.truststore.jks,relative-to=jboss.server.config.dir,credential-reference={clear-text=secret},type=JKS)

/subsystem=elytron/key-store=twoWayTS:import-certificate(alias=client,path=/path/to/client.cer,credential-reference={clear-text=secret},trust-cacerts=true)

/subsystem=elytron/key-store=twoWayTS:store()</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="configure-a-key-manager-trust-manager-and-server-ssl-context-for-the-server-key-store-and-trust-store"><a class="anchor" href="#configure-a-key-manager-trust-manager-and-server-ssl-context-for-the-server-key-store-and-trust-store"></a>Configure a key-manager, trust-manager, and server-ssl-context for the server key store and trust store.</h6>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=elytron/key-manager=twoWayKM:add(key-store=twoWayKS,credential-reference={clear-text=secret})

/subsystem=elytron/trust-manager=twoWayTM:add(key-store=twoWayTS)

/subsystem=elytron/server-ssl-context=twoWaySSC:add(key-manager=twoWayKM,protocols=["TLSv1.2"],trust-manager=twoWayTM,want-client-auth=true,need-client-auth=true)</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>IMPORTANT:</strong> You need to determine what SSL/TLS protocols you want to
support. The example commands above uses <em>TLSv1.2</em>.</p>
</div>
</div>
<div class="sect5">
<h6 id="enable-https-on-the-management-interface.-1"><a class="anchor" href="#enable-https-on-the-management-interface.-1"></a>Enable HTTPS on the management interface.</h6>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/core-service=management/management-interface=http-interface:write-attribute(name=ssl-context, value=twoWaySSC)

/core-service=management/management-interface=http-interface:write-attribute(name=secure-socket-binding, value=management-https)</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="reload-the-wildfly-instance.-1"><a class="anchor" href="#reload-the-wildfly-instance.-1"></a>Reload the WildFly instance.</h6>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>reload</code></pre>
</div>
</div>
<div class="paragraph">
<p>To complete the two-way SSL/TLS authentication, you need to
<a href="#import-server-certificate-into-client-truststore-management">import the server certificate</a>
into the client truststore and
<a href="#configure-your-client-to-use-the-client-certificate-management">configure your client</a>
to present the client certificate.</p>
</div>
</div>
</div>
<div class="sect4">
<h5 id="import-server-certificate-into-client-truststore-management"><a class="anchor" href="#import-server-certificate-into-client-truststore-management"></a>Import the server certificate into the client truststore.</h5>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>$ keytool -importcert -keystore client.truststore.jks -storepass secret -alias localhost -trustcacerts -file /path/to/server.cer</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="configure-your-client-to-use-the-client-certificate-management"><a class="anchor" href="#configure-your-client-to-use-the-client-certificate-management"></a>Configure your client to use the client certificate.</h5>
<div class="paragraph">
<p>You need to configure your client to present the trusted client
certificate to the server to complete the two-way SSL/TLS
authentication. For example, if using a browser, you need to import the
trusted certificate into the browser&#8217;s trust store.</p>
</div>
<div class="paragraph">
<p>Two-way SSL/TLS is now enabled for the management interfaces.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="keystore-manipulation-operations"><a class="anchor" href="#keystore-manipulation-operations"></a>4.3.6. KeyStore manipulation operations</h4>
<div class="paragraph">
<p>It is possible to perform various KeyStore manipulation operations on an
Elytron key-store resource using the management CLI.</p>
</div>
<div class="sect4">
<h5 id="generate-key-pair"><a class="anchor" href="#generate-key-pair"></a>Generate a key pair</h5>
<div class="paragraph">
<p>The <em>generate-key-pair</em> command generates a key pair and wraps the resulting
public key in a self-signed X.509 certificate. The generated private key and
self-signed certificate will be added to the KeyStore.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=elytron/key-store=httpsKS:generate-key-pair(alias=example,algorithm=RSA,key-size=1024,validity=365,credential-reference={clear-text=secret},distinguished-name="CN=www.example.com")</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="generate-certificate-signing-request"><a class="anchor" href="#generate-certificate-signing-request"></a>Generate a certificate signing request</h5>
<div class="paragraph">
<p>The <em>generate-certificate-signing-request</em> command generates a PKCS #10
certificate signing request using a PrivateKeyEntry from the KeyStore. The
generated certificate signing request will be output to a file.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=elytron/key-store=httpsKS:generate-certificate-signing-request(alias=example,path=server.csr,relative-to=jboss.server.config.dir,distinguished-name="CN=www.example.com",extensions=[{critical=false,name=KeyUsage,value=digitalSignature}],credential-reference={clear-text=secret})</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="import-certificate"><a class="anchor" href="#import-certificate"></a>Import a certificate or certificate chain</h5>
<div class="paragraph">
<p>The <em>import-certificate</em> command imports a certificate or certificate chain
from a file into an entry in the KeyStore.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=elytron/key-store=httpsKS:import-certificate(alias=example,path=/path/to/certificate_or_chain/file,relative-to=jboss.server.config.dir,credential-reference={clear-text=secret},trust-cacerts=true)</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="export-certificate"><a class="anchor" href="#export-certificate"></a>Export a certificate</h5>
<div class="paragraph">
<p>The <em>export-certificate</em> command exports a certificate from an entry in the
KeyStore to a file.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=elytron/key-store=httpsKS:export-certificate(alias=example,path=serverCert.cer,relative-to=jboss.server.config.dir,pem=true)</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="change-alias"><a class="anchor" href="#change-alias"></a>Change an alias</h5>
<div class="paragraph">
<p>The <em>change-alias</em> command moves an existing KeyStore entry to a new alias.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=elytron/key-store=httpsKS:change-alias(alias=example,new-alias=newExample,credential-reference={clear-text=secret})</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="store-changes"><a class="anchor" href="#store-changes"></a>Store changes made to key-stores</h5>
<div class="paragraph">
<p>The <em>store</em> command persists any changes that have been made to the file that
backs the KeyStore.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=elytron/key-store=httpsKS:store()</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="obtain-certificate"><a class="anchor" href="#obtain-certificate"></a>Obtain a signed certificate from Let&#8217;s Encrypt</h5>
<div class="paragraph">
<p>Before obtaining a signed certificate from Let&#8217;s Encrypt, you must configure
a Let&#8217;s Encrypt account using the following commands.</p>
</div>
<div class="sect5">
<h6 id="create-le-account-key-store"><a class="anchor" href="#create-le-account-key-store"></a>Create a key-store to hold your Let&#8217;s Encrypt account key.</h6>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=elytron/key-store=accountsKS:add(path=accounts.keystore.jks,relative-to=jboss.server.config.dir,credential-reference={clear-text=secret},type=JKS)</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="configure-le-account"><a class="anchor" href="#configure-le-account"></a>Configure a Let&#8217;s Encrypt account</h6>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=elytron/certificate-authority-account=myLEAccount:add(alias=example,key-store=accountsKS,contact-urls=[mailto:admin@example.org])</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Note:</strong> Let&#8217;s Encrypt is the default certificate authority and therefore the <code>certificate-authority</code> attribute can be omitted when creating a <code>certificate-authority-account</code>.
It is also possible to configure an account with different certificate authority than Let&#8217;s Encrypt by adding custom <code>certificate-authority</code> resource and passing it to <code>certificate-authority-account</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=elytron/certificate-authority=myCA:add(url="https://my.example.url/acme/directory", staging-url="https://my.example.staging.url/acme/directory")
/subsystem=elytron/certificate-authority-account=myCAAccount:add(certificate-authority=myCA,alias=example,key-store=accountsKS,contact-urls=[mailto:admin@example.org])</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="obtain-signed-certificate"><a class="anchor" href="#obtain-signed-certificate"></a>Obtain a signed certificate from Let&#8217;s Encrypt</h6>
<div class="paragraph">
<p>The <em>obtain-certificate</em> command creates an account with Let&#8217;s Encrypt, if such an account does not already exist,
obtains a signed certificate from Let&#8217;s Encrypt, and stores it in the KeyStore.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=elytron/key-store=httpsKS:obtain-certificate(alias=server,domain-names=[www.example.org],certificate-authority-account=myLEAccount,agree-to-terms-of-service=true,algorithm=RSA,key-size=1024,credential-reference={clear-text=secret})</code></pre>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="revoke-certificate"><a class="anchor" href="#revoke-certificate"></a>Revoke a signed certificate</h5>
<div class="paragraph">
<p>The <em>revoke-certificate</em> command revokes a certificate that was issued by Let&#8217;s Encrypt.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=elytron/key-store=httpsKS:revoke-certificate(alias=server,reason=keyCompromise,certificate-authority-account=myLEAccount)</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="should-renew-certificate"><a class="anchor" href="#should-renew-certificate"></a>Check if a certificate is due for renewal</h5>
<div class="paragraph">
<p>The <em>should-renew-certificate</em> command checks if a certificate is due for renewal. In particular, it will return true if the certificate expires in less than the given number of days and false otherwise.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=elytron/key-store=httpsKS:should-renew-certificate(alias=server,expiration=7)</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="certificate-authority-account-operations"><a class="anchor" href="#certificate-authority-account-operations"></a>4.3.7. Certificate authority account operations</h4>
<div class="paragraph">
<p>It is possible to perform various operations on an Elytron certificate-authority-account
resource using the management CLI.</p>
</div>
<div class="sect4">
<h5 id="create-account"><a class="anchor" href="#create-account"></a>Create an account with the certificate authority</h5>
<div class="paragraph">
<p>The <em>create-account</em> command creates an account with the certificate authority if one does not already exist.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=elytron/certificate-authority-account=myLEAccount:create-account(agree-to-terms-of-service=true)</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="update-account"><a class="anchor" href="#update-account"></a>Update an account with the certificate authority</h5>
<div class="paragraph">
<p>The <em>update-account</em> command updates an account with the certificate authority.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=elytron/certificate-authority-account=myLEAccount:update-account(agree-to-terms-of-service=true)</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="change-account-key"><a class="anchor" href="#change-account-key"></a>Change the account key</h5>
<div class="paragraph">
<p>The <em>change-account-key</em> command changes the key associated with the certificate authority account.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=elytron/certificate-authority-account=myLEAccount:change-account-key()</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="deactivate-account"><a class="anchor" href="#deactivate-account"></a>Deactivate the account</h5>
<div class="paragraph">
<p>The <em>deactivate-account</em> command deactivates the certificate authority account.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=elytron/certificate-authority-account=myLEAccount:deactivate-account()</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="get-metadata"><a class="anchor" href="#get-metadata"></a>Get metadata</h5>
<div class="paragraph">
<p>The <em>get-metadata</em> command retrieves the metadata (e.g., terms of service URL, website URL, CAA identities,
and whether or not an external account is required), if any, associated with the certificate authority.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=elytron/certificate-authority-account=myLEAccount:get-metadata()</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="using-an-ldap-key-store"><a class="anchor" href="#using-an-ldap-key-store"></a>4.3.8. Using an ldap-key-store</h4>
<div class="paragraph">
<p>An <em>ldap-key-store</em> allows you to use a keystore stored in an LDAP
server. You can use an <em>ldap-key-store</em> in same way you can use a
<em>key-store</em>.</p>
</div>
<div class="paragraph">
<p>To create and use an <em>ldap-key-store</em>:</p>
</div>
<div class="sect4">
<h5 id="configure-a-dir-context."><a class="anchor" href="#configure-a-dir-context."></a>Configure a dir-context.</h5>
<div class="paragraph">
<p>To connect to the LDAP server from WildFly, you need to configure a
<em>dir-context</em> that provides the URL as well as the principal used to
connect to the server.</p>
</div>
<div class="paragraph">
<p><strong>Example dir-context</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=elytron/dir-context=exampleDC:add( \
  url="ldap://127.0.0.1:10389", \
  principal="uid=admin,ou=system", \
  credential-reference={clear-text=secret} \
)</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="configure-an-ldap-key-store."><a class="anchor" href="#configure-an-ldap-key-store."></a>Configure an ldap-key-store.</h5>
<div class="paragraph">
<p>When configure an <em>ldap-key-store</em>, you need to specify both the
<em>dir-context</em> used to connect to the LDAP server as well as how to
locate the keystore stored in the LDAP server. At a minimum, this
requires you specify a <em>search-path</em>.</p>
</div>
<div class="paragraph">
<p><strong>Example ldap-key-store</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=elytron/ldap-key-store=ldapKS:add( \
  dir-context=exampleDC, \
  search-path="ou=Keystores,dc=wildfly,dc=org" \
)</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="use-the-ldap-key-store."><a class="anchor" href="#use-the-ldap-key-store."></a>Use the ldap-key-store.</h5>
<div class="paragraph">
<p>Once you have defined your <em>ldap-key-store</em>, you can use it in the same
places where a <em>key-store</em> could be used. For example, you could use an
<em>ldap-key-store</em> when configuring HTTPS and Two-Way HTTPS for
applications.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="using-a-filtering-key-store"><a class="anchor" href="#using-a-filtering-key-store"></a>4.3.9. Using a filtering-key-store</h4>
<div class="paragraph">
<p>A <em>filtering-key-store</em> allows you to expose a subset of aliases from an
existing <em>key-store</em>, and use it in the same places you could use a
<em>key-store</em>. For example, if a keystore contained <em>alias1</em>, <em>alias2</em>,
and <em>alias3</em>, but you only wanted to expose <em>alias1</em> and <em>alias3</em>, a
<em>filtering-key-store</em> provides you several ways to do that.</p>
</div>
<div class="paragraph">
<p>To create a <em>filtering-key-store</em>:</p>
</div>
<div class="sect4">
<h5 id="configure-a-key-store."><a class="anchor" href="#configure-a-key-store."></a>Configure a key-store.</h5>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=elytron/key-store=myKS:add( \
  path=keystore.jks, \
  relative-to=jboss.server.config.dir, \
  credential-reference={ \
    clear-text=secret \
  }, \
  type=JKS \
)</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="configure-a-filtering-key-store."><a class="anchor" href="#configure-a-filtering-key-store."></a>Configure a filtering-key-store.</h5>
<div class="paragraph">
<p>When you configure a <em>filtering-key-store</em>, you specify which
<em>key-store</em> you want to filter and the <em>alias-filter</em> for filtering
aliases from the <em>key-store</em>. The filter can be specified in one of the
following formats:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>alias1,alias3</em>, which is a comma-delimited list of aliases to expose.</p>
</li>
<li>
<p><em>ALL:-alias2</em>, which exposes all aliases in the keystore except the
ones listed.</p>
</li>
<li>
<p><em>NONE:+alias1:+alias3</em>, which exposes no aliases in the keystore
except the ones listed.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This example uses a comma-delimted list to expose <em>alias1</em> and <em>alias3</em>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=elytron/filtering-key-store=filterKS:add( \
  key-store=myKS, \
  alias-filter="alias1,alias3" \
)</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="use-the-filtering-key-store."><a class="anchor" href="#use-the-filtering-key-store."></a>Use the filtering-key-store.</h5>
<div class="paragraph">
<p>Once you have defined your <em>filtering-key-store</em>, you can use it in the
same places where a <em>key-store</em> could be used. For example, you could
use a <em>filtering-key-store</em> when configuring HTTPS and Two-Way HTTPS for
applications.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="reload-a-keystore"><a class="anchor" href="#reload-a-keystore"></a>4.3.10. Reload a Keystore</h4>
<div class="paragraph">
<p>You can reload a keystore configured in WildFly from the management CLI.
This is useful in cases where you have made changes to certificates
referenced by a keystore.</p>
</div>
<div class="paragraph">
<p>To reload a keystore.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=elytron/key-store=httpsKS:load</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="reinitialize-a-key-manager"><a class="anchor" href="#reinitialize-a-key-manager"></a>4.3.11. Reinitialize a Key Manager</h4>
<div class="paragraph">
<p>You can reinitialize a key-manager configured in WildFly from the management CLI.
This is useful in cases where you have made changes in certificates provided by keystore
resource and you want to apply this change to new SSL connections without restarting the server.</p>
</div>
<div class="paragraph">
<p>If the key-store is file based then it must be loaded first.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=elytron/key-store=httpsKS:load()</code></pre>
</div>
</div>
<div class="paragraph">
<p>To reinitialize a key-manager.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=elytron/key-manager=httpsKM:init()</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="reinitialize-a-trust-manager"><a class="anchor" href="#reinitialize-a-trust-manager"></a>4.3.12. Reinitialize a Trust Manager</h4>
<div class="paragraph">
<p>You can reinitialize a trust-manager configured in WildFly from the management CLI.
This is useful in cases where you have made changes to certificates provided by keystore
resource and you want to apply this change to new SSL connections without restarting the server.</p>
</div>
<div class="paragraph">
<p>If the key-store is file based then it must be loaded first.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=elytron/key-store=httpsKS:load()</code></pre>
</div>
</div>
<div class="paragraph">
<p>To reinitialize a trust-manager.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=elytron/trust-manager=httpsTM:init()</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="check-the-content-of-a-keystore-by-alias"><a class="anchor" href="#check-the-content-of-a-keystore-by-alias"></a>4.3.13. Check the Content of a Keystore by Alias</h4>
<div class="paragraph">
<p>If you add a keystore to the <em>elytron</em> subsystem using the <em>key-store</em>
component, you can check the keystore&#8217;s contents using the <em>alias</em> child
element and reading its attributes.</p>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=elytron/key-store=httpsKS/alias=localhost:read-attribute(name=certificate-chain)
{
    "outcome" =&gt; "success",
    "result" =&gt; [{
        "type" =&gt; "X.509",
        "algorithm" =&gt; "RSA",
        "format" =&gt; "X.509",
        "public-key" =&gt; "30:81:9f:30:0d:06:09:2a:8......</code></pre>
</div>
</div>
<div class="paragraph">
<p>The following attributes can be read:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Attribute</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">certificate</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The certificate associated with the alias. If the alias
has a certificate chain this will always be undefined.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">certificate-chain</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The certificate chain associated with the alias.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">creation-date</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The creation date of the entry represented by this
alias.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">entry-type</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The type of the entry for this alias. Available types:
PasswordEntry, PrivateKeyEntry, SecretKeyEntry, TrustedCertificateEntry,
and Other. Unrecognized types will be reported as Other.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="custom-components"><a class="anchor" href="#custom-components"></a>4.3.14. Custom Components</h4>
<div class="paragraph">
<p>When configuring SSL/TLS in the <em>elytron</em> subsystem, you can provide and
use custom implementations of the following components:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>key-store</em></p>
</li>
<li>
<p><em>key-manager</em></p>
</li>
<li>
<p><em>trust-manager</em></p>
</li>
<li>
<p><em>client-ssl-context</em></p>
</li>
<li>
<p><em>server-ssl-context</em></p>
</li>
<li>
<p><em>certificate-authority-account</em></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>When creating custom implementations of Elytron components, they must
present the appropriate capabilities and requirements.</p>
</div>
</div>
<div class="sect3">
<h4 id="configuring-a-server-sslcontext"><a class="anchor" href="#configuring-a-server-sslcontext"></a>4.3.15. Configuring a server SSLContext</h4>
<div class="paragraph">
<p>Using the Elytron subsystem, it is possible to configure an <code>SSLContext</code> for use on the server side of a connection.</p>
</div>
<div class="paragraph">
<p>Adding a server <code>SSLContext</code> takes the general form:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=elytron/server-ssl-context=test-server-ssl-context:add(...)</code></pre>
</div>
</div>
<div class="paragraph">
<p>The following attributes can be specified when creating a <code>server-ssl-context</code>:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">security-domain</dt>
<dd>
<p><em>(Optional)</em> A reference to the <code>security-domain</code> to use for authentication during SSL session
establishment.</p>
</dd>
<dt class="hdlist1">key-manager</dt>
<dd>
<p><em>(Optional)</em> A reference to the <code>KeyManager</code> to be used by this <code>SSLContext</code>.</p>
</dd>
<dt class="hdlist1">trust-manager</dt>
<dd>
<p><em>(Optional)</em> A reference to the <code>TrustManager</code> to be used by this <code>SSLContext</code>.</p>
</dd>
<dt class="hdlist1">cipher-suite-filter</dt>
<dd>
<p><em>(Optional)</em> The filter to be applied to the cipher suites for TLSv1.2 and below made available
by this SSLContext. The format of this attribute is described in detail in
<a href="http://wildfly-security.github.io/wildfly-elytron/master/org/wildfly/security/ssl/CipherSuiteSelector.html#fromString-java.lang.String-">org.wildfly.security.ssl.CipherSuiteSelector.fromString(selector)</a>.
The default value is <code>DEFAULT</code>, which corresponds to all known cipher suites that do not have NULL encryption and
excludes any cipher suites that have no authentication.</p>
</dd>
<dt class="hdlist1">cipher-suite-names</dt>
<dd>
<p><em>(Optional)</em> The enabled cipher suites for TLSv1.3. The format of this attribute is a simple colon
(":") separated list of TLSv1.3 cipher suite names (e.g., <code>TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256:TLS_AES_128_GCM_SHA256</code>).
This attribute must be specified in order for TLSv1.3 to be enabled.</p>
</dd>
<dt class="hdlist1">protocols</dt>
<dd>
<p><em>(Optional)</em> A space separated list of the protocols to be supported by this <code>SSLContext</code>. The default value
is <code>TLSv1 TLSv1.1 TLSv1.2 TLSv1.3</code>. Note that the TLSv1.3 protocol will only be usable when running against JDK 11 or
higher.</p>
</dd>
<dt class="hdlist1">want-client-auth</dt>
<dd>
<p><em>(Optional)</em> To request (but not to require) a client certificate on SSL handshake. If a
<code>security-domain</code> is configured and supports X509 evidence, this will be set to <code>true</code> automatically. Ignored when
<code>need-client-auth</code> is set. The default value is <code>false</code>.</p>
</dd>
<dt class="hdlist1">need-client-auth</dt>
<dd>
<p><em>(Optional)</em> If <code>true</code>, a client certificate is required on SSL handshake. A connection without a
trusted client certificate will be rejected. The default value is <code>false</code>.</p>
</dd>
<dt class="hdlist1">authentication-optional</dt>
<dd>
<p><em>(Optional)</em> Rejection of the client certificate by the configured <code>security-domain</code> will not
prevent the connection. This allows a fall through to use other authentication mechanisms (like form login) when the
client certificate is rejected by the
<code>security-domain</code>. This has an effect only when the <code>security-domain</code> is configured. The default value is <code>false</code>.</p>
</dd>
<dt class="hdlist1">use-cipher-suites-order</dt>
<dd>
<p><em>(Optional)</em> If <code>true</code>, the cipher suites order defined on the server will be used. If <code>false</code>,
the cipher suites order presented by the client will be used. The default value is <code>true</code>.</p>
</dd>
<dt class="hdlist1">provider-name</dt>
<dd>
<p><em>(Optional)</em> The name of the provider to use. If not specified, all providers from <code>providers</code> will be
passed to the <code>SSLContext</code>.</p>
</dd>
<dt class="hdlist1">providers</dt>
<dd>
<p><em>(Optional)</em> The name of the providers to obtain the <code>Provider[]</code> to use to load the <code>SSLContext</code>.</p>
</dd>
<dt class="hdlist1">maximum-session-cache-size</dt>
<dd>
<p><em>(Optional)</em> The maximum number of SSL sessions to be cached. The default value <code>-1</code>
indicates that the JVM default value should be used. A value of <code>0</code> means there is no limit.</p>
</dd>
<dt class="hdlist1">session-timeout</dt>
<dd>
<p><em>(Optional)</em> The timeout for SSL sessions. The default value <code>-1</code> indicates that the JVM default value
should be used. A value of <code>0</code> means there is no limit.</p>
</dd>
<dt class="hdlist1">wrap</dt>
<dd>
<p><em>(Optional)</em> If <code>true</code>, the returned <code>SSLEngine</code>, <code>SSLSocket</code>, and <code>SSLServerSocket</code> instances will be wrapped to
protect against further modification. The default value is <code>false</code>.</p>
</dd>
<dt class="hdlist1">pre-realm-principal-transformer</dt>
<dd>
<p><em>(Optional)</em> A principal transformer to apply before the realm is selected.</p>
</dd>
<dt class="hdlist1">post-realm-principal-transformer</dt>
<dd>
<p><em>(Optional)</em> A principal transformer to apply after the realm is selected.</p>
</dd>
<dt class="hdlist1">final-principal-transformer</dt>
<dd>
<p><em>(Optional)</em> A final principal transformer to apply for this mechanism realm.</p>
</dd>
<dt class="hdlist1">realm-mapper</dt>
<dd>
<p><em>(Optional)</em> The realm mapper to be used for SSL authentication.</p>
</dd>
</dl>
</div>
</div>
<div class="sect3">
<h4 id="configuring-a-client-sslcontext"><a class="anchor" href="#configuring-a-client-sslcontext"></a>4.3.16. Configuring a client SSLContext</h4>
<div class="paragraph">
<p>Using the Elytron subsystem, it is possible to configure an <code>SSLContext</code> for use on the client side of a connection.</p>
</div>
<div class="paragraph">
<p>Adding a client <code>SSLContext</code> takes the general form:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=elytron/client-ssl-context=test-client-ssl-context:add(...)</code></pre>
</div>
</div>
<div class="paragraph">
<p>The following attributes can be specified when creating a <code>client-ssl-context</code>:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">key-manager</dt>
<dd>
<p><em>(Optional)</em> A reference to the <code>KeyManager</code> to be used by this <code>SSLContext</code>.</p>
</dd>
<dt class="hdlist1">trust-manager</dt>
<dd>
<p><em>(Optional)</em> A reference to the <code>TrustManager</code> to be used by this <code>SSLContext</code>.</p>
</dd>
<dt class="hdlist1">cipher-suite-filter</dt>
<dd>
<p><em>(Optional)</em> The filter to be applied to the cipher suites for TLSv1.2 and below made available
by this SSLContext. The format of this attribute is described in detail in
<a href="http://wildfly-security.github.io/wildfly-elytron/master/org/wildfly/security/ssl/CipherSuiteSelector.html#fromString-java.lang.String-">org.wildfly.security.ssl.CipherSuiteSelector.fromString(selector)</a>.
The default value is <code>DEFAULT</code>, which corresponds to all known cipher suites that do not have NULL encryption and
excludes any cipher suites that have no authentication.</p>
</dd>
<dt class="hdlist1">cipher-suite-names</dt>
<dd>
<p><em>(Optional)</em> The enabled cipher suites for TLSv1.3. The format of this attribute is a simple colon
(":") separated list of TLSv1.3 cipher suite names (e.g., <code>TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256:TLS_AES_128_GCM_SHA256</code>).
This attribute must be specified in order for TLSv1.3 to be enabled.</p>
</dd>
<dt class="hdlist1">protocols</dt>
<dd>
<p><em>(Optional)</em> A space separated list of the protocols to be supported by this <code>SSLContext</code>. The default value
is <code>TLSv1 TLSv1.1 TLSv1.2 TLSv1.3</code>. Note that the TLSv1.3 protocol will only be usable when running against JDK 11 or higher.</p>
</dd>
<dt class="hdlist1">provider-name</dt>
<dd>
<p><em>(Optional)</em> The name of the provider to use. If not specified, all providers from <code>providers</code> will be
passed to the <code>SSLContext</code>.</p>
</dd>
<dt class="hdlist1">providers</dt>
<dd>
<p><em>(Optional)</em> The name of the providers to obtain the <code>Provider[]</code> to use to load the <code>SSLContext</code>.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p><strong>WARNING</strong> It is possible to use TLSv1.3 with WildFly when running against JDK 11 or higher. However, if JDK 11
is in use and if there is a very large number of TLSv1.3 requests being made, it is possible that a drop in
performance (throughput and response time) will occur compared to TLSv1.2. Upgrading to newer JDK versions
should improve performance. For this reason, the use of TLSv1.3 is currently disabled by default. TLSv1.3 can
be enabled by configuring the new <code>cipher-suite-names</code> attribute in the SSL Context resource definition in the
Elytron subsystem as described in the previous two sections. It is recommended to test for performance
degradation prior to enabling TLSv1.3 in a production environment. See <a href="https://issues.redhat.com/browse/WFWIP-160">WFWIP-160</a>
for more details.</p>
</div>
<div class="paragraph">
<p><strong>Note:</strong> When using TLSv1.3, it is important to keep in mind that session IDs have become essentially obsolete.
This means that the session ID can no longer reliably be used to test if a session was resumed. Instead,
creation time can be used to test if a session was resumed. Currently, clients need to read from the server after
the first handshake in order to receive the <code>NewSessionTicket</code> that can be used for resumption. However, this may
change once <a href="https://bugs.openjdk.java.net/browse/JDK-8209953">JDK-8209953</a> is resolved.</p>
</div>
</div>
<div class="sect3">
<h4 id="_default_sslcontext"><a class="anchor" href="#_default_sslcontext"></a>4.3.17. Default SSLContext</h4>
<div class="paragraph">
<p>Many libraries that can be used within deployments may require SSL configuration for any connections they establish, these libraries tend to be configurable by the caller or if no configuration is provided fall back to using the default <code>SSLContext</code> for the process available from: -</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">javax.net.ssl.SSLContext.getDefault();</code></pre>
</div>
</div>
<div class="paragraph">
<p>By default this <code>SSLContext</code> is configured using system properties, however within the WildFly Elytron subsystem it is possible to specify that one of the configured contexts should be associated and used as the default.</p>
</div>
<div class="paragraph">
<p>To make use of this feature configure your <code>SSLContext</code> as normal, the following command can then be used to specify which <code>SSLContext</code> should be used as the default.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=elytron:write-attribute(name=default-ssl-context, value=client-context)</code></pre>
</div>
</div>
<div class="paragraph">
<p>As existing services and deployments could have cached the default <code>SSLContext</code> prior to this being set a reload is required to ensure the default gets set before the deployments are activated.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>:reload</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Note:</strong> If the <code>default-ssl-context</code> attribute is subsequently 'undefined' the standard APIs do not provide us with a mechanism to revert the default so in this situation the Java process would need be restarted.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=elytron:undefine-attribute(name=default-ssl-context)
{
    "outcome" =&gt; "success",
    "response-headers" =&gt; {
        "operation-requires-restart" =&gt; true,
        "process-state" =&gt; "restart-required"
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_configuring_sni"><a class="anchor" href="#_configuring_sni"></a>4.3.18. Configuring SNI</h4>
<div class="paragraph">
<p>Using the WildFly Elytron subsystem it is possible to configure an SSL context which supports SNI.  By supporting SNI if an SNI host name is available whilst the SSLSession is being negotiated a host specific SSLContext will be selected.  If no host specific SSLContext is identified either because no host name was received or because there is no match a default SSLContext will be used instead.  By identifying a host specific SSLContext it means that a certificate appropriate for that host can be used.</p>
</div>
<div class="paragraph">
<p>The following command demonstrates how an SNI aware SSLContext can be added: -</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>[standalone@localhost:9990 /] ./subsystem=elytron/server-ssl-sni-context=test-sni:add(default-ssl-context=jboss,host-context-map={localhost=localhost, wildfly.org=wildfly})
{"outcome" =&gt; "success"}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This example assumes that three SSLContexts have been previously defined following the steps available previously in this document, those contexts are <code>jboss</code>, <code>localhost</code>, and <code>wildfly</code>.</p>
</div>
<div class="paragraph">
<p>During negotiation of the SSLSession if the SNI host name received is <code>localhost</code> then the <code>localhost</code> SSLContext will be used, if the SNI host name is <code>wildfly.org</code> then the <code>wildfly</code> SSLContext will be used.  If no SNI host name is received or if we receive a name that does not match this will fallback and use the <code>jboss</code> SSLContext.</p>
</div>
<div class="paragraph">
<p>The resulting resource looks like: -</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>[standalone@localhost:9990 /] ./subsystem=elytron/server-ssl-sni-context=test-sni:read-resource
{
    "outcome" =&gt; "success",
    "result" =&gt; {
        "default-ssl-context" =&gt; "jboss",
        "host-context-map" =&gt; {
            "localhost" =&gt; "localhost",
            "wildfly.org" =&gt; "wildfly"
        }
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Within the <code>host-context-map</code> it is also possible to define wildcard mappings such as <code>&#42;</code> and <code>&#42;.wildfly.org</code>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="configuring-the-elytron-and-security-subsystems"><a class="anchor" href="#configuring-the-elytron-and-security-subsystems"></a>4.4. Configuring the Elytron and Security Subsystems</h3>
<div class="sect3">
<h4 id="enable-and-disable-the-elytron-subsystem"><a class="anchor" href="#enable-and-disable-the-elytron-subsystem"></a>4.4.1. Enable and Disable the Elytron Subsystem</h4>
<div class="sect4">
<h5 id="to-add-the-elytron-extension-required-for-the-elytron-subsystem"><a class="anchor" href="#to-add-the-elytron-extension-required-for-the-elytron-subsystem"></a>To add the elytron extension required for the elytron subsystem:</h5>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/extension=org.wildfly.extension.elytron:add()</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="to-enable-the-elytron-subsystem-in-wildfly"><a class="anchor" href="#to-enable-the-elytron-subsystem-in-wildfly"></a>To enable the Elytron subsystem in WildFly:</h5>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=elytron:add

reload</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="to-disable-the-elytron-subsystem-in-wildfly"><a class="anchor" href="#to-disable-the-elytron-subsystem-in-wildfly"></a>To disable the Elytron subsystem in WildFly:</h5>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=elytron:remove

reload</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>IMPORTANT:</strong> Other subsystems within WildFly may have dependencies on
the <em>elytron</em> subsystem. If these dependencies are not resolved before
disabling it, you will see errors when starting WildFly.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="enable-and-disable-the-security-subsystem"><a class="anchor" href="#enable-and-disable-the-security-subsystem"></a>4.4.2. Enable and Disable the Security Subsystem</h4>
<div class="sect4">
<h5 id="to-disable-the-security-subsystem-in-wildfly"><a class="anchor" href="#to-disable-the-security-subsystem-in-wildfly"></a>To disable the security subsystem in WildFly:</h5>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=security:remove

reload</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>IMPORTANT:</strong> Other subsystems within WildFly may have dependencies on
the <em>security</em> subsystem. If these dependencies are not resolved before
disabling it, you will see errors when starting WildFly.</p>
</div>
</div>
<div class="sect4">
<h5 id="to-enable-the-security-subsystem-in-wildfly"><a class="anchor" href="#to-enable-the-security-subsystem-in-wildfly"></a>To enable the security subsystem in WildFly:</h5>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=security:add

reload</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="use-the-elytron-and-security-subsystems-in-parallel"><a class="anchor" href="#use-the-elytron-and-security-subsystems-in-parallel"></a>4.4.3. Use the Elytron and Security Subsystems in Parallel</h4>
<div class="paragraph">
<p>By default the <em>elytron</em> and <em>security</em> subsystems will run in parallel
if both are enabled. For authentication in applications, you can use the
<em>application-security-domain</em> property in the <em>undertow</em> subsystem to
configure a security domain in the <em>elytron</em> subsystem.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=undertow/application-security-domain=exampleApplicationDomain:add(http-authentication-factory=example-http-auth)</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>NOTE:</strong> This must match the <em>security-domain</em> configured in the
<em>jboss-web.xml</em> of your application.</p>
</div>
<div class="paragraph">
<p>If the <em>application-security-domain</em> is not set, WildFly will look for a
security domain configured in the <em>security</em> subsystem that matches the
<em>security-domain</em> configured in the <em>jboss-web.xml</em> of your application.</p>
</div>
<div class="paragraph">
<p>For enabling HTTPS using a legacy security realm, you can use the
<em>security-realm</em> attribute in the <em>https-listener</em> section of the
<em>undertow</em> subsystem:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=undertow/server=default-server/https-listener=https:read-attribute(name=security-realm)
{
    "outcome" =&gt; "success",
    "result" =&gt; "ApplicationRealm"
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>For enabling HTTPS using <em>elytron</em>, you need to undefine the
<em>security-realm</em> attribute and set the <em>ssl-context</em> attribute. As there
has to be always configured either <em>ssl-context</em> or <em>security-realm</em> you
have to use batch operation when changing between those:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>batch
/subsystem=undertow/server=default-server/https-listener=https:undefine-attribute(name=security-realm)
/subsystem=undertow/server=default-server/https-listener=https:write-attribute(name=ssl-context,value=httpsSSC)
run-batch</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="creating-elytron-subsystem-components"><a class="anchor" href="#creating-elytron-subsystem-components"></a>4.5. Creating Elytron Subsystem Components</h3>
<div class="sect3">
<h4 id="create-an-elytron-security-realm"><a class="anchor" href="#create-an-elytron-security-realm"></a>4.5.1. Create an Elytron Security Realm</h4>
<div class="paragraph">
<p>Security realms in the Elytron subsystem, when used in conjunction with
security domains, are use for both core management authentication as
well as for authentication with applications. Security realms are also
specifically typed based on their identity store, for example
<em>jdbc-realm</em>, <em>filesystem-realm</em>, <em>properties-realm</em>, etc.</p>
</div>
<div class="paragraph">
<p>Adding a security realm takes the general form:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=elytron/type-of-realm=realmName:add(....)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Examples of adding specific realms, such as <em>jdbc-realm</em>,
<em>filesystem-realm</em>, and <em>properties-realm</em> can be found in previous
sections.</p>
</div>
</div>
<div class="sect3">
<h4 id="create-an-elytron-role-decoder"><a class="anchor" href="#create-an-elytron-role-decoder"></a>4.5.2. Create an Elytron Role Decoder</h4>
<div class="paragraph">
<p>A role decoder converts attributes from the identity provided by the
security realm into roles. Role decoders are also specifically typed
based on their functionality, for example <em>empty-role-decoder</em>,
<em>simple-role-decoder</em>, <em>custom-role-decoder</em>, and <em>aggregate-role-decoder</em>.</p>
</div>
<div class="paragraph">
<p>Adding a role decoder takes the general form:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=elytron/ROLE-DECODER-TYPE=roleDeoderName:add(....)</code></pre>
</div>
</div>
<div class="sect4">
<h5 id="_create_an_elytron_role_decoder_that_makes_use_of_the_ip_address_of_the_remote_client"><a class="anchor" href="#_create_an_elytron_role_decoder_that_makes_use_of_the_ip_address_of_the_remote_client"></a>Create an Elytron Role Decoder that makes use of the IP Address of the Remote Client</h5>
<div class="paragraph">
<p>A role decoder that is configured on a security realm assigns roles to
an identity based on attributes provided by the security realm. It is
also possible to configure a role decoder that makes use of the IP
address of the remote client when determining the roles associated
with an identity. As an example, we might want to make use of the IP
address of the remote client in order to assign a user a particular
role when establishing a connection to the server from a corporate
network and a different role when establishing a connection to the
server from a different network.</p>
</div>
<div class="paragraph">
<p>Adding a role decoder that makes use of the remote client&#8217;s IP
address takes the general form:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=elytron/source-address-role-decoder=roleDecoderName:add(source-address="...", pattern="...", roles=[...])</code></pre>
</div>
</div>
<div class="paragraph">
<p>In particular, a <em>source-address-role-decoder</em> has the following attributes:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>source-address</em> - The IP address of the remote client.</p>
</li>
<li>
<p><em>pattern</em> - A regular expression that specifies the IP address to match.</p>
</li>
<li>
<p><em>roles</em> - The list of roles to assign if the source IP address matches the given address.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Only one of <em>source-address</em> and <em>pattern</em> should be specified.</p>
</div>
<div class="paragraph">
<p>For example, the following <em>source-address-role-decoder</em> could be configured to specify
that a user should be assigned the "Administrator" role when establishing a connection
to the server from the 10.10.10.10 IP address:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=elytron/source-address-role-decoder=decoder1:add(source-address="10.10.10.10", roles=["Administrator"])</code></pre>
</div>
</div>
<div class="paragraph">
<p>Once a <em>source-address-role-decoder</em> has been configured, it can be referenced from a <em>security-domain</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=elytron/security-domain=exampleSD:add(..., role-decoder=decoder1)</code></pre>
</div>
</div>
<div class="paragraph">
<p>It is also possible to assign permissions to an identity based on its roles using a
<a href="Using_the_Elytron_Subsystem.html#create-an-elytron-permission-mapper">simple permission mapper</a>.</p>
</div>
<div class="paragraph">
<p>Example configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=elytron/source-address-role-decoder=decoder1:add(source-address="10.10.10.10", roles=["Administrator"])
/subsystem=elytron/simple-permission-mapper=ipPermissionMapper:add(permission-mappings=[{roles=["Administrator"], permission-sets=[{permission-set=login-permission}]}])
/subsystem=elytron/security-domain=exampleSD:add(..., role-decoder=decoder1, permission-mapper=ipPermissionMapper)</code></pre>
</div>
</div>
<div class="paragraph">
<p>The above example configures a security domain with a source address role decoder that
will assign the "Administrator" role when the IP address of the remote client matches
the configured address and a simple permission mapper that only assigns the
"LoginPermission" if the identity has the "Administrator" role. Thus, authentication
will succeed if the IP address of the remote client matches the configured address.</p>
</div>
<div class="paragraph">
<p>It is also possible to configure an <em>aggregate-role-decoder</em>. This consists of
two or more <em>role-decoder</em> elements where each element is a reference to a configured
role decoder. Each role decoder will be applied and the returned value will be a union of
the roles returned by each decoder.</p>
</div>
<div class="paragraph">
<p>Example configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=elytron/source-address-role-decoder=decoder1:add(source-address="10.10.10.10", roles=["Administrator"])
/subsystem=elytron/source-address-role-decoder=decoder2:add(source-address="12.12.12.12", roles=["Users"])
/subsystem=elytron/aggregate-role-decoder=aggregateDecoder:add(role-decoders=[decoder1, decoder2])</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="create-an-elytron-permission-set"><a class="anchor" href="#create-an-elytron-permission-set"></a>4.5.3. Create an Elytron Permission Set</h4>
<div class="paragraph">
<p>Permission sets can be used to assign permissions to an identity.</p>
</div>
<div class="paragraph">
<p>Adding a permission set takes the general form:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=elytron/permission-set=PermissionSetName:add(permissions=[{class-name="...", module="...", target-name="...", action="..."}...])</code></pre>
</div>
</div>
<div class="paragraph">
<p>where <em>permissions</em> consists of a set of permissions, where each permission has the following attributes:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>class-name</em> is the fully qualified class name of the permission. This is the only permission attribute that is required.</p>
</li>
<li>
<p><em>module</em> is the optional module to use to load the permission.</p>
</li>
<li>
<p><em>target-name</em> is the optional target name to pass to the permission as it is constructed.</p>
</li>
<li>
<p><em>action</em> is the optional action to pass to the permission as it is constructed.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="create-an-elytron-permission-mapper"><a class="anchor" href="#create-an-elytron-permission-mapper"></a>4.5.4. Create an Elytron Permission Mapper</h4>
<div class="paragraph">
<p>In addition to roles being assigned to a identity, permissions may also
be assigned. A permission mapper assigns permissions to an identity.
Permission mappers are also specifically typed based on their
functionality, for example <em>logical-permission-mapper</em>,
<em>simple-permission-mapper</em>, and <em>custom-permission-mapper</em>.</p>
</div>
<div class="paragraph">
<p>Adding a permission mapper takes the general form:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=elytron/simple-permission-mapper=PermissionMapperName:add(...)</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="create-an-elytron-role-mapper"><a class="anchor" href="#create-an-elytron-role-mapper"></a>4.5.5. Create an Elytron Role Mapper</h4>
<div class="paragraph">
<p>A role mapper maps roles after they have been decoded to other roles.
Examples include normalizing role names or adding and removing specific
roles from principals after they have been decoded. Role mappers are
also specifically typed based on their functionality, for example
<em>add-prefix-role-mapper</em>, <em>add-suffix-role-mapper</em>, and
<em>constant-role-mapper</em>.</p>
</div>
<div class="paragraph">
<p>Adding a role mapper takes the general form:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=elytron/ROLEM-MAPPER-TYPE=roleMapperName:add(...)</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="create-an-elytron-security-domain"><a class="anchor" href="#create-an-elytron-security-domain"></a>4.5.6. Create an Elytron Security Domain</h4>
<div class="paragraph">
<p>Security domains in the Elytron subsystem, when used in conjunction with
security realms, are use for both core management authentication as well
as for authentication with applications.</p>
</div>
<div class="paragraph">
<p>Adding a security domain takes the general form:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=elytron/security-domain=domainName:add(realms=[{realm=realmName,role-decoder=roleDecoderName}],default-realm=realmName,permission-mapper=permissionMapperName,role-mapper=roleMapperName,...)</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="create-an-elytron-authentication-factory"><a class="anchor" href="#create-an-elytron-authentication-factory"></a>4.5.7. Create an Elytron Authentication Factory</h4>
<div class="paragraph">
<p>An authentication factory is an authentication policy used for specific
authentication mechanisms. Authentication factories are specifically
based on the authentication mechanism, for example
<em>http-authentication-factory</em> and<br>
<em>sasl-authentication-factory</em> and <em>kerberos-security-factory</em>.</p>
</div>
<div class="paragraph">
<p>Adding an authentication factory takes the general form:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=elytron/AUTH-FACTORY-TYPE=authFactoryName:add(....)</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="create-an-elytron-policy-provider"><a class="anchor" href="#create-an-elytron-policy-provider"></a>4.5.8. Create an Elytron Policy Provider</h4>
<div class="paragraph">
<p>Elytron subsystem provides a specific resource definition that can be
used to configure a default ruby Policy provider. The subsystem allows
you to define multiple policy providers but select a single one as the
default:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=elytron/policy=policy-provider-a:add(custom-policy=\[{name=policy-provider-a, class-name=MyPolicyProviderA, module=x.y.z}\])</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="create-an-elytron-case-principal-transformer"><a class="anchor" href="#create-an-elytron-case-principal-transformer"></a>4.5.9. Create an Elytron Case Principal Transformer</h4>
<div class="paragraph">
<p>Principal transformers can take a name and map it to another representation of the name or perform
some normalisation. A <code>case-principal-transformer</code> converts a principal to upper or lower case.
As an example, we might want to convert our principal to upper case if the identities in our realm
are stored in upper case.</p>
</div>
<div class="paragraph">
<p>Adding a <code>case-principal-transformer</code> that converts a principal to upper/lower case takes the
general form:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code>/subsystem=elytron/case-principal-transformer=transformerName:add(upper-case="...")</code></pre>
</div>
</div>
<div class="paragraph">
<p>In particular, a <code>case-principal-transformer</code> has the following attribute:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>upper-case</code> - A boolean value to indicate whether the principal should be converted to upper case.
Indicating <code>false</code> for this attribute converts the principal to lower case.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For example, the following <code>case-principal-transformer</code> could be configured to specify that
a principal should be transformed to lower case:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=elytron/case-principal-transformer=transformer1:add(upper-case="false")</code></pre>
</div>
</div>
<div class="paragraph">
<p>On the other hand, a <code>case-principal-transformer</code> could be configured by omitting the
<code>upper-case</code> attribute, which is then set to <code>true</code> by default:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=elytron/case-principal-transformer=transformer2:add()</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_component_documentation"><a class="anchor" href="#_component_documentation"></a>4.6. Component Documentation</h3>
<div class="sect3">
<h4 id="_security_realms"><a class="anchor" href="#_security_realms"></a>4.6.1. Security Realms</h4>
<div class="paragraph">
<p>The primary responsibility of a security realm is the ability to load identities with associated attributes, these identities are then used within the authentication process for credential validation and subsequently wrapped to represent the <code>SecurityIdentity</code> instances using within applications for authorization.</p>
</div>
<div class="paragraph">
<p>Generally a security realm operates in one of three modes, in the first mode on loading an identity from its store the security realm also loads one or more credential representations from the store and holds these within the identity.  During authentication the credentials within the identity can be used to verify the connection attempt.  The reason multiple credentials are loaded is because specific types may be applicable to specific mechanisms so an appropriate credential representation can be selected at the time of authentication.</p>
</div>
<div class="paragraph">
<p>In the second mode the identity is loaded as in the first mode however no credentials are loaded, in this mode evidence can be passed in to the identity for verification.  This mode is sometimes the only mode available where it is not possible to load the representation of a credential from its store.</p>
</div>
<div class="paragraph">
<p>In the third mode evidence is passed to the security realm and used to construct the resulting identity, this mode is predominantly used with certificate and token based authentication mechanisms where the verified certificate or token can be used to construct the resulting identity.</p>
</div>
<div class="paragraph">
<p>Once an identity has been loaded for authorization decisions the identity will have a set of associated attributes, these will subsequent be mapped using role decoders, role mappers, and permission mappers as required for identity specific authorization decisions.</p>
</div>
</div>
<div class="sect3">
<h4 id="aggregate-security-realm"><a class="anchor" href="#aggregate-security-realm"></a>4.6.2. Aggregate Security Realm</h4>
<div class="paragraph">
<p>The aggregate security realm allows for two or more security realms to be aggregated into a single security realm allowing one to be used during the authentication steps and one or more to be used to assemble the identity used for authorization decisions and aggregating any associated attributes.</p>
</div>
<div class="paragraph">
<p>The <code>aggregate-realm</code> resource contains the following attributes: -</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>authentication-realm</code> - This realm use used to load the credentials of the identity or perform evidence verification.</p>
</li>
<li>
<p><code>authorization-realm</code> - The realm to use to load the identities attributes used for authorization.</p>
</li>
<li>
<p><code>authorization-realms</code> - A list of one or more realms to use to load the identities attributes and aggregate into a single set of attributes.</p>
</li>
<li>
<p><code>principal-transformer</code> - A principal transformer that can be used to transform the principal after loading the credentials
for authentication but before loading the identities attributes for authorization. This attribute is optional.</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<code>authorization-realm</code> and <code>authorization-realms</code> are mutually exclusive so exactly one of these must be specified.
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="_defining_a_simple_aggregation"><a class="anchor" href="#_defining_a_simple_aggregation"></a>Defining a Simple Aggregation</h5>
<div class="paragraph">
<p>Assuming two realms <code>properties-realm</code> and <code>jdbc-realm</code> already exist an <code>aggregate-realm</code> combining these two can be created with the following command.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=elytron/aggregate-realm=combined:add(
    authentication-realm=properties-realm,
    authorization-realm=jdbc-realm)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Where this realm is used the <code>properties-realm</code> will be used to load an identity&#8217;s credentials and the <code>jdbc-realm</code> will be used to load the attributes for the identity.</p>
</div>
<div class="paragraph">
<p>The following command is exactly the same except the <code>authorization-realms</code> attribute is used instead.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=elytron/aggregate-realm=combined:add(
    authentication-realm=properties-realm,
    authorization-realms=[jdbc-realm])</code></pre>
</div>
</div>
<div class="paragraph">
<p>The following command will reference a principal transformer defined in the mappers configuration to be used to transform the principal
after authentication.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=elytron/aggregate-realm=combined:add(
    authentication-realm=properties-realm,
    authorization-realms=[jdbc-realm],
    principal-transformer=custom-transformer)</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_aggregating_attributes"><a class="anchor" href="#_aggregating_attributes"></a>Aggregating Attributes</h5>
<div class="paragraph">
<p>If a third realm <code>ldap-realm</code> also exists that shoud also be used for the loading of attributes an <code>aggregate-realm</code> can be defined using the following command: -</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=elytron/aggregate-realm=combined:add(
    authentication-realm=properties-realm,
    authorization-realms=[jdbc-realm, ldap-realm])</code></pre>
</div>
</div>
<div class="paragraph">
<p>As before the <code>properties-realm</code> will be used to load the identity&#8217;s credentials or perform evidence verification but the attributes for the identity will be loaded both from the <code>jdbc-realm</code> and <code>ldap-realm</code> then combined together.</p>
</div>
<div class="paragraph">
<p>The approach taken to combine attributes makes use of the first instance of each attribute, if the same attribute is loaded by multiple realms only the first occurrence will be used. Later occurrences of an existing attribtue will be ignored.</p>
</div>
<div class="paragraph">
<p>As an example if the following attributes were loaded from the <code>jdbc-realm</code>: -</p>
</div>
<table class="tableblock frame-all grid-all" style="width: 33%;">
<caption class="title">Table 1. JDBC Attributes</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">ATTRIBUTE</th>
<th class="tableblock halign-left valign-top">VALUES</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">e-mail</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="mailto:example@wildfly.org">example@wildfly.org</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">groups</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Supervisor, User</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>And the following attributes were loaded from the <code>ldap-realm</code>: -</p>
</div>
<table class="tableblock frame-all grid-all" style="width: 33%;">
<caption class="title">Table 2. LDAP Attributes</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">ATTRIBUTE</th>
<th class="tableblock halign-left valign-top">VALUES</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">e-mail</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="mailto:administrator@wildfly.org">administrator@wildfly.org</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">phone</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0000 0000 0000</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The resulting attributes would be: -</p>
</div>
<table class="tableblock frame-all grid-all" style="width: 33%;">
<caption class="title">Table 3. Combined Attributes</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">ATTRIBUTE</th>
<th class="tableblock halign-left valign-top">VALUES</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">e-mail</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="mailto:example@wildfly.org">example@wildfly.org</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">groups</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Supervisor, User</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">phone</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0000 0000 0000</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect3">
<h4 id="filesystem-security-realm"><a class="anchor" href="#filesystem-security-realm"></a>4.6.3. Filesystem Security Realm</h4>
<div class="paragraph">
<p>The filesystem security realm is a security realm developed to support storing of identities in a filesystem with the option of associating multiple credentials and multiple attributes with each identity. Both credentials and attributes can contain multiple values.</p>
</div>
<div class="sect4">
<h5 id="_create_and_populate_filesystem_security_realm"><a class="anchor" href="#_create_and_populate_filesystem_security_realm"></a>Create and Populate Filesystem Security Realm</h5>
<div class="paragraph">
<p>Every identity is stored in an XML file where the name of the file is the name of the identity. It is sufficient to just specify the path to the directory where identity files will be stored. There are other optional attributes.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>path</code> The actual filesystem path. Treated as an absolute path, unless the 'relative-to' attribute is specified, in which case the value is treated as relative to that path.</p>
</li>
<li>
<p><code>relative-to</code> If 'relative-to' is provided, the value of the 'path' attribute is treated as relative to the path specified by this attribute.</p>
</li>
<li>
<p><code>levels</code> The number of levels of directory hashing to apply. When this attribute is set to positive value, filesystem realm will store identities in directory structure where the name of subdirectories will be derived from first characters of identity name. For example, location of identity named "alex" could be <code>a/l/alex.xml</code>. This is useful not only because some filesystems can limit the amount of files that can be stored in a single directory, but also for performance reasons, because that might be influenced by the number of entries in a single directory as well. Default value is 2.</p>
</li>
<li>
<p><code>encoded</code> When encoding is set to true, the identity names will be BASE32 encoded before they are used as filenames. This is beneficial, because some filesystems are case-insensitive or might restrict set of characters allowed in a filename. Default value is true.</p>
</li>
<li>
<p><code>hash-encoding</code> specifies the string format for the password if it is not stored in plain text. Set to BASE64 bt default, but HEX is also supported.</p>
</li>
<li>
<p><code>hash-charset</code> specifies the character set to use when converting the password string to a byte array. Set to UTF-8 by default.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Filesystem security realm can be added with WildFly management CLI or with Elytron API.</p>
</div>
<div class="sect5">
<h6 id="_wildfly_management_cli"><a class="anchor" href="#_wildfly_management_cli"></a>WildFly management CLI</h6>
<div class="paragraph">
<p>The following command creates realm with name <code>fsRealm</code> that resides in directory <code>fs-realm-users</code> inside the base configuration directory defined by <code>jboss.server.config.dir</code> property. The levels number is 2 and encoded value is true.
The charset is UTF-8 and the string encoding is BASE64.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=elytron/filesystem-realm=fsRealm:add(path=fs-realm-users, relative-to=jboss.server.config.dir)</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Although identities stored within the same realm can be hashed using different algorithms, they are all
hashed using the same character set and stored using the same string encoding across the whole realm.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To add identity with the name "alex" to this filesystem realm:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=elytron/filesystem-realm=fsRealm:add-identity(identity=alex)</code></pre>
</div>
</div>
<div class="paragraph">
<p>To delete existing identity from filesystem realm:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=elytron/filesystem-realm=fsRealm:remove-identity(identity=alex)</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="_programmatic_approach"><a class="anchor" href="#_programmatic_approach"></a>Programmatic approach</h6>
<div class="paragraph">
<p>When creating filesystem realm with Elytron API, you can specify <code>name rewriter</code> in the constructor. The name rewriter will be applied to identity names to transform them from one form to another. It can be used to normalize the case, trim extra whitespaces, map one naming scheme to another, remove realm component from identity name (e.g. "user@realm" to "user") or to perform validation step on the syntax of the name.</p>
</div>
<div class="paragraph">
<p>Class <code>org.wildfly.security.auth.realm.FileSystemSecurityRealm</code> is used to instantiate the realm.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>FileSystemSecurityRealm fsRealm = new FileSystemSecurityRealm(fsRealmPath, NameRewriter.IDENTITY_REWRITER, 2, true);</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>org.wildfly.security.auth.server.NameRewriter.IDENTITY_REWRITER</code> is a simple identity name rewriter that does no rewriting. You can implement the <code>NameRewriter</code> interface and use your own rewriter.</p>
</div>
<div class="paragraph">
<p>Class <code>org.wildfly.security.auth.principal.NamePrincipal</code> represents principal comprised of a simple name. Handle for the identity can be obtained by passing the <code>NamePrincipal</code> instance to the <code>getRealmIdentity</code> or <code>getRealmIdentityForUpdate</code> method. Received identity for the given principal might or might not exist in the filesystem realm. Method <code>exists</code> can be called to check whether the received identity exists. If it does not, you cannot modify its credentials or attributes.</p>
</div>
<div class="paragraph">
<p>To add non existent identity to the filesystem realm, <code>create</code> method must be called. After this call, credentials and roles of this identity are empty. The exception will be thrown if method <code>create</code> is called on an existing identity.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>ModifiableRealmIdentity modifiableIdentity = fsRealm.getRealmIdentityForUpdate(new NamePrincipal("alex"));
if (!modifiableIdentity.exists()) {
    modifiableIdentity.create();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>To obtain read only instance of identity:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">RealmIdentity identity = fsRealm.getRealmIdentity(identityPrincipal);</code></pre>
</div>
</div>
<div class="paragraph">
<p>To obtain identity that can be modified:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">ModifiableRealmIdentity modifiableIdentity = fsRealm.getRealmIdentityForUpdate(identityPrincipal);</code></pre>
</div>
</div>
<div class="paragraph">
<p>ModifiableRealmIdentity handle must be cleaned up by a call to <code>dispose</code> when the modifying is done:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>modifiableIdentity.dispose();</code></pre>
</div>
</div>
<div class="paragraph">
<p>To delete the identity from the realm:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>identity.delete();</code></pre>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_credentials"><a class="anchor" href="#_credentials"></a>Credentials</h5>
<div class="paragraph">
<p>Supported password types for identity in filesystem realm are <code>Bcrypt</code>, <code>Clear</code>, <code>Simple Digest</code>, <code>Salted Simple Digest</code>, <code>Scram Digest</code>, <code>Digest</code> and <code>OTP</code>.</p>
</div>
<div class="sect5">
<h6 id="_wildfly_management_cli_2"><a class="anchor" href="#_wildfly_management_cli_2"></a>WildFly management CLI</h6>
<div class="paragraph">
<p>To set clear password to the identity:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=elytron/filesystem-realm=fsRealm:set-password(clear={password="alexPassword"}, identity=alex)</code></pre>
</div>
</div>
<div class="paragraph">
<p>The above command will store password in clear text in identity&#8217;s file. It is not recommended to use clear passwords in a production set up.</p>
</div>
<div class="paragraph">
<p>To set digest password to the identity:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=elytron/filesystem-realm=fsRealm:set-password(digest={algorithm=digest-md5,password="demoPassword",realm=demoRealm},identity=alex)</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Note:</strong> Operation set-password` replaces any existing credential(s) with the new value.</p>
</div>
</div>
<div class="sect5">
<h6 id="_programmatic_approach_2"><a class="anchor" href="#_programmatic_approach_2"></a>Programmatic approach</h6>
<div class="paragraph">
<p>When using Elytron API, working with passwords require interaction with the <code>org.wildfly.security.password.PasswordFactory</code> API. Here is the simplest example that will store password in clear text in identity&#8217;s file. Examples on how to work with other types of passwords can be found in <a href="#Passwords">Passwords</a> section of this documentation.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>PasswordFactory passwordFactory = PasswordFactory.getInstance(ClearPassword.ALGORITHM_CLEAR);
PasswordCredential clearPassword = new PasswordCredential(passwordFactory.generatePassword(new ClearPasswordSpec("alexPassword".toCharArray())));
identity.setCredentials(Collections.singleton(clearPassword));</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Note:</strong> Operation <code>setCredentials</code> replaces any existing credential(s) with the new value.</p>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_attributes"><a class="anchor" href="#_attributes"></a>Attributes</h5>
<div class="paragraph">
<p>Attributes associated with identities can be read and updated through CLI as well as programmatically.</p>
</div>
<div class="sect5">
<h6 id="_wildfly_management_cli_3"><a class="anchor" href="#_wildfly_management_cli_3"></a>WildFly management CLI</h6>
<div class="paragraph">
<p>To add attribute to the identity, you have to specify the name of the attribute and its values (values are of type LIST):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=elytron/filesystem-realm=fsRealm:add-identity-attribute(
    identity="alex",
    name=Email,
    value=["alex@email.com", "alex_email@email.com"])
{"outcome" =&gt; "success"}</code></pre>
</div>
</div>
<div class="paragraph">
<p>To read the identity with its attributes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=elytron/filesystem-realm=fsRealm:read-identity(identity="alex")
{
    "outcome" =&gt; "success",
    "result" =&gt; {
        "name" =&gt; "alex",
        "attributes" =&gt; {"Email" =&gt; [
            "alex@email.com",
            "alex_email@email.com"
        ]}
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>To remove individual values of the attribute:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=elytron/filesystem-realm=fsRealm:remove-identity-attribute(
    identity=alex,
    name=Email,
    value=[alex@email.com])
{"outcome" =&gt; "success"}
/subsystem=elytron/filesystem-realm=fsRealm:read-identity(identity="alex")
{
    "outcome" =&gt; "success",
    "result" =&gt; {
        "name" =&gt; "alex",
        "attributes" =&gt; {"Email" =&gt; ["alex_email@email.com"]}
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>To remove the whole attribute:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=elytron/filesystem-realm=fsRealm:remove-identity-attribute(identity=alex, name=Email)
{"outcome" =&gt; "success"}
/subsystem=elytron/filesystem-realm=fsRealm:read-identity(identity=alex)
{
    "outcome" =&gt; "success",
    "result" =&gt; {
        "name" =&gt; "alex",
        "attributes" =&gt; undefined
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="_programmatic_approach_3"><a class="anchor" href="#_programmatic_approach_3"></a>Programmatic approach</h6>
<div class="paragraph">
<p>Interface <code>org.wildfly.security.authz.Attributes</code> represents collection of string attributes. To get attributes associated with specific identity:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">Attributes identityAttributes = identity.getAttributes();</code></pre>
</div>
</div>
<div class="paragraph">
<p>To update attributes you can use <code>ModifiableRealmIdentity</code> instance. Class <code>org.wildfly.security.authz.MapAttributes</code> represents collection of attributes backed by <code>java.util.Map</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">ModifiableRealmIdentity modifiableIdentity = fsRealm.getRealmIdentityForUpdate(identityPrincipal);
MapAttributes attributes = new MapAttributes();
attributes.addLast("email","alex@email.com");
modifiableIdentity.setAttributes(attributes);
modifiableIdentity.dispose();</code></pre>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_converting_legacy_properties_file_into_filesystem_realm"><a class="anchor" href="#_converting_legacy_properties_file_into_filesystem_realm"></a>Converting legacy properties file into Filesystem realm</h5>
<div class="paragraph">
<p>WildFly can use authentication with a properties file based identity store. One properties file maps users to passwords and another maps users to roles. You can use <code>Elytron Tool</code> to convert these properties files into a filesystem realm. Below is an example of how to run this tool from the command line:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>$JBOSS_HOME/bin/elytron-tool.sh filesystem-realm -u conf/users.properties -r conf/roles.properties --output-location realms/example --summary -f example-fs-realm</code></pre>
</div>
</div>
<div class="paragraph">
<p>This command creates new filesystem realm with users taken from users.properties file and roles taken from roles.properties file. Script <code>example-fs-realm.sh</code> that contains the commands for WildFly CLI is generated as well. The script adds this filesystem realm to the Elytron subsystem and also adds new security domain that uses this filesystem realm as a default realm.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="jdbc-security-realm"><a class="anchor" href="#jdbc-security-realm"></a>4.6.4. JDBC Security Realm</h4>
<div class="paragraph">
<p>The JDBC security realm is a security realm developed to support loading identities from a database with the option of multiple credentials and multiple attributes each with the option of containing multiple values.</p>
</div>
<div class="paragraph">
<p>When defining the JDBC security realm one or more principal queries can be defined, each of these can load a credential and / or attributes for the resulting identity.  Each defined principal query is associated with it&#8217;s own datasource, this means quite a complex configuration can be created loading the different aspects of an identity from multiple locations.</p>
</div>
<div class="paragraph">
<p>Each of the examples documented within this section will be making use of pre-configured datasources, please refer to the datasources subsystem documentation for more information relating to how to define datasources.</p>
</div>
<div class="sect4">
<h5 id="_loading_a_single_clear_text_password"><a class="anchor" href="#_loading_a_single_clear_text_password"></a>Loading a Single Clear Text Password</h5>
<div class="paragraph">
<p>The simplest configuration is to load a clear text password for an identity.  This approach would not be recommended at all in a production set up, however it does make a suitable starting point to illustrate how the JDBC security realm can be configured.</p>
</div>
<table class="tableblock frame-all grid-all" style="width: 33%;">
<caption class="title">Table 4. Example Table</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">NAME</th>
<th class="tableblock halign-left valign-top">PASSWORD</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">test</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">myPassword</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>A JDBC security realm can be defined as: -</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=elytron/jdbc-realm=demo-realm:add(
    principal-query=[{data-source=Identities,
                      sql="select PASSWORD from IDENTITIES where NAME = ?",
                      clear-password-mapper={password-index=1}}])</code></pre>
</div>
</div>
<div class="paragraph">
<p>This realm is defined within a single <code>principal-query</code> against the <code>Identities</code> datasource.  For the user <code>test</code> the result of the query would be: -</p>
</div>
<table class="tableblock frame-all grid-all" style="width: 25%;">
<caption class="title">Table 5. Query Results</caption>
<colgroup>
<col style="width: 100%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">1</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">myPassword</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The principal query can be defined with password mappers which define which columns should be used to construct the password for the identity being loaded, in this example a <code>clear-password-mapper</code> is used: -</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>clear-password-mapper={password-index=1}</code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
The index of the first column is 1
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="_alternative_password_mappers"><a class="anchor" href="#_alternative_password_mappers"></a>Alternative Password Mappers</h5>
<div class="paragraph">
<p>The WildFly Elytron project supports a variety of password types as described within <a href="#Passwords">Passwords</a>, some of these password types require multiple values to be loaded from the database to reconstruct the password so alternative password mappers are made available.  More than one password mapper can be defined on a single <code>principal-query</code> to support loading multiple passwords simultaneously.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Where the various password mappers load encoded representations of passwords and salts from the database these can either be encoded using Base64 or Hexadecimal, by default unless specified Base64 is assumed.
</td>
</tr>
</table>
</div>
<div class="sect5">
<h6 id="_clear_password_mapper"><a class="anchor" href="#_clear_password_mapper"></a>clear-password-mapper</h6>
<div class="paragraph">
<p>This mapper is used to load a clear text password directly from the database.</p>
</div>
<div class="paragraph">
<p>The following attribute is supported for this password mapper: -</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>password-index</code> - The index of the column containing the clear text password.</p>
</li>
</ul>
</div>
</div>
<div class="sect5">
<h6 id="_bcrypt_password_mapper"><a class="anchor" href="#_bcrypt_password_mapper"></a>bcrypt-password-mapper</h6>
<div class="paragraph">
<p>The <code>bcrypt-password-mapper</code> can be used for passwords to be loaded using the <a href="#bcrypt">bcrypt</a> algorithm, as an iterated salted password type the iteration count and salt are also loaded from the database query.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>password-index</code> - The index of the column containing the encoded password.</p>
</li>
<li>
<p><code>hash-encoding</code> - The encoding of the hash, either <code>base64</code> or <code>hex</code>.</p>
</li>
<li>
<p><code>salt-index</code> - The index of the column containing the encoded salt.</p>
</li>
<li>
<p><code>salt-encoding</code> - The encoding of the salt, either <code>base64</code> or <code>hex</code>.</p>
</li>
<li>
<p><code>iteration-count-index</code> - The index of the column containing the iteration count.</p>
</li>
</ul>
</div>
</div>
<div class="sect5">
<h6 id="_modular_crypt_mapper"><a class="anchor" href="#_modular_crypt_mapper"></a>modular-crypt-mapper</h6>
<div class="paragraph">
<p>The <code>modular-crypt-mapper</code> can be used for passwords encoded using modular crypt, this encoding allows for multiple pieces of information to be encoded in single String such as the password type, the hash or digest, the salt, and the iteraction count.</p>
</div>
<div class="paragraph">
<p>Information on how to encode and decode modular crypt representations can be seen in <a href="#modular-crypt">Modular Crypt Encoding</a>.</p>
</div>
<div class="paragraph">
<p>The following attribute is supported for this password mapper: -</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>password-index</code> - The index of the column containing the modular crypt encoded password.</p>
</li>
</ul>
</div>
</div>
<div class="sect5">
<h6 id="_salted_simple_digest_mapper"><a class="anchor" href="#_salted_simple_digest_mapper"></a>salted-simple-digest-mapper</h6>
<div class="paragraph">
<p>The <code>salted-simple-digest-mapper</code> supports the password types hashed with a salt as described in <a href="#salted-digest">Salted Digest</a>, for this type of password the encoded form of the password is loaded in addition to the salt.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>algorithm</code> - The algorithm of the password type, the supported values are listed at <a href="#salted-digest">Salted Digest</a>.</p>
</li>
<li>
<p><code>password-index</code> - The index of the column containing the encoded password.</p>
</li>
<li>
<p><code>hash-encoding</code> - The encoding of the hash, either <code>base64</code> or <code>hex</code>.</p>
</li>
<li>
<p><code>salt-index</code> - The index of the column containing the encoded salt.</p>
</li>
<li>
<p><code>salt-encoding</code> - The encoding of the salt, either <code>base64</code> or <code>hex</code>.</p>
</li>
</ul>
</div>
</div>
<div class="sect5">
<h6 id="_simple_digest_mapper"><a class="anchor" href="#_simple_digest_mapper"></a>simple-digest-mapper</h6>
<div class="paragraph">
<p>The <code>simple-digest-mapper</code> supports the loading of passwords which have been simply hashed without any salt as described in <a href="#simple-digest">Simple Digest</a>.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>algorithm</code> - The algorithm of the password type, the supported values are listed at <a href="#simple-digest">Simple Digest</a>.</p>
</li>
<li>
<p><code>password-index</code> - The index of the column containing the encoded password.</p>
</li>
<li>
<p><code>hash-encoding</code> - The encoding of the hash, either <code>base64</code> or <code>hex</code>.</p>
</li>
</ul>
</div>
</div>
<div class="sect5">
<h6 id="_scram_mapper"><a class="anchor" href="#_scram_mapper"></a>scram-mapper</h6>
<div class="paragraph">
<p>The <code>scram-mapper</code> supports the loading of SCRAM passwords which use both a salt and an interation count as described in <a href="#scram">Scram</a>.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>algorithm</code> - The algorithm of the password type, the supported values are listed at <a href="#scram">Scram</a>.</p>
</li>
<li>
<p><code>password-index</code> - The index of the column containing the encoded password.</p>
</li>
<li>
<p><code>hash-encoding</code> - The encoding of the hash, either <code>base64</code> or <code>hex</code>.</p>
</li>
<li>
<p><code>salt-index</code> - The index of the column containing the encoded salt.</p>
</li>
<li>
<p><code>salt-encoding</code> - The encoding of the salt, either <code>base64</code> or <code>hex</code>.</p>
</li>
<li>
<p><code>iteration-count-index</code> - The index of the column containing the iteration count.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_hash_character_sets"><a class="anchor" href="#_hash_character_sets"></a>Hash Character Sets</h5>
<div class="paragraph">
<p>The various password mappers allow loading multiples values from the database to hash the client provided password in order
to compare against the password stored in the database.</p>
</div>
<div class="paragraph">
<p>The JDBC realm supports specifying the character set via the attribute <code>hash-charset</code> to use when converting
the client provided password string to a byte array. This is useful when our database is storing
hashed passwords using a charset other than <code>UTF-8</code>, as the JDBC realm assumes that is the charset being used by default.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Although more than one password mapper can be defined on a single <code>principal-query</code>, only one <code>hash-charset</code>
can be defined across the whole realm.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>For example, the following JDBC realm is configured using the GB2312 charset:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code> /subsystem=elytron/jdbc-realm=exampleDbRealm:add(principal-query=[{sql="SELECT password FROM all_users WHERE user=?",data-source=exampleDS,simple-digest-mapper={algorithm=password-salt-digest-md5,password-index=1}}])</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_using_a_hashed_password_representation"><a class="anchor" href="#_using_a_hashed_password_representation"></a>Using a Hashed Password Representation</h5>
<div class="paragraph">
<p>The same approach can be taken for all hashed password representations, for illustration purposes this section will illustrate how a <a href="#bcrypt">bcrypt</a> password can be prepared to be stored in a database and the subsequent realm configuration to make use of it.  Examples uising the APIs for the different password types can be found in the <a href="#Passwords">Passwords</a> section of this documentation.</p>
</div>
<div class="paragraph">
<p>The following example takes the password <code>myPassword</code>, generates a random salt an produces a <code>bcrypt</code> representation of the password.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">static final Provider ELYTRON_PROVIDER = new WildFlyElytronProvider();

static final String TEST_PASSWORD = "myPassword";

public static void main(String[] args) throws Exception {
    PasswordFactory passwordFactory = PasswordFactory.getInstance(BCryptPassword.ALGORITHM_BCRYPT, ELYTRON_PROVIDER);

    int iterationCount = 10;

    byte[] salt = new byte[BCryptPassword.BCRYPT_SALT_SIZE];
    SecureRandom random = new SecureRandom();
    random.nextBytes(salt);

    IteratedSaltedPasswordAlgorithmSpec iteratedAlgorithmSpec = new IteratedSaltedPasswordAlgorithmSpec(iterationCount, salt);
    EncryptablePasswordSpec encryptableSpec = new EncryptablePasswordSpec(TEST_PASSWORD.toCharArray(), iteratedAlgorithmSpec);

    BCryptPassword original = (BCryptPassword) passwordFactory.generatePassword(encryptableSpec);

    byte[] hash = original.getHash();

    Encoder encoder = Base64.getEncoder();
    System.out.println("Encoded Salt = " + encoder.encodeToString(salt));
    System.out.println("Encoded Hash = " + encoder.encodeToString(hash));
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This produces the following output, as the salt is randomly generated the output would differ each time the above code is executed.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>Encoded Salt = 3bFOQwRU75to+yJ8Cv0g8w==
Encoded Hash = x9P/0cxfNz+Pf3HCinZ3dLCbNMnBeiU=</code></pre>
</div>
</div>
<div class="paragraph">
<p>This could now be stored in a database table: -</p>
</div>
<table class="tableblock frame-all grid-all" style="width: 33%;">
<caption class="title">Table 6. Example Table</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">NAME</th>
<th class="tableblock halign-left valign-top">PASSWORD</th>
<th class="tableblock halign-left valign-top">SALT</th>
<th class="tableblock halign-left valign-top">ITERATION_COUNT</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">test</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">x9P/0cxfNz+Pf3HCinZ3dLCbNMnBeiU=</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3bFOQwRU75to+yJ8Cv0g8w==</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">10</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The JDBC security realm can instead be created with the following CLI command: -</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=elytron/jdbc-realm=demo-realm:add(
    principal-query=[{data-source=Identities,
                      sql="select PASSWORD, SALT, ITERATION_COUNT from IDENTITIES where NAME = ?",
                      bcrypt-mapper={password-index=1, salt-index=2, iteration-count-index=3}}])</code></pre>
</div>
</div>
<div class="paragraph">
<p>For the user <code>test</code> the result of the query would be: -</p>
</div>
<table class="tableblock frame-all grid-all" style="width: 25%;">
<caption class="title">Table 7. Query Results</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">1</th>
<th class="tableblock halign-left valign-top">2</th>
<th class="tableblock halign-left valign-top">3</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">x9P/0cxfNz+Pf3HCinZ3dLCbNMnBeiU=</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3bFOQwRU75to+yJ8Cv0g8w==</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">10</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The <code>bcrypt-password-mapper</code> is defined to load the encoded password, encoded salt and iteration count from the relevent columns in the query result.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>bcrypt-mapper={password-index=1, salt-index=2, iteration-count-index=3}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Had the values been encoding using hexadecimal instead of Base64 the <code>bcrypt-mapper</code> could have been defined as: -</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>bcrypt-mapper={password-index=1, hash-encoding=hex, salt-index=2, salt-encoding=hex, iteration-count-index=3}</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
It is worth noting that as the <code>hash-encoding</code> and <code>salt-encoding</code> are specified separately one could use Base64 whilst the other uses hexadecimal.
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="_loading_passwords_from_different_queries_datasources"><a class="anchor" href="#_loading_passwords_from_different_queries_datasources"></a>Loading Passwords from Different Queries / Datasources</h5>
<div class="paragraph">
<p>It is also possible to combine both of the example so far and define two separate <code>principal-query</code> instances to attempt to load both password types from different locations.</p>
</div>
<div class="paragraph">
<p>Here is an example configuration loading a clear text password from one datasource / table and loading a bcrypt password from a second datasource / table.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=elytron/jdbc-realm=demo-realm:add(
    principal-query=[
        {data-source=LegacyIdentities,
         sql="select PASSWORD from LEGACY_IDENTITIES where NAME = ?",
         clear-password-mapper={password-index=1}},
        {data-source=NewIdentities,
         sql="select PASSWORD, SALT, ITERATION_COUNT from NEW_IDENTITIES where NAME = ?",
         bcrypt-mapper={password-index=1, salt-index=2, iteration-count-index=3}}
                    ])</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
It is not required that the identity is found from both of the queries, this can be useful in situations where identities are being migrated from one location to another or for aggregating two together.
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="_loading_attributes"><a class="anchor" href="#_loading_attributes"></a>Loading Attributes</h5>
<div class="paragraph">
<p>The examples so far have focussed on the loading of passwords from the database, the principal queries can also be used to load attributes for the resulting identities.</p>
</div>
<div class="paragraph">
<p>The loading of attributes can either be defined to happen within the principal queries being used to load the passwords or attribute specific principal queries can be defined, as each <code>principal-query</code> can be defined with it&#8217;s own <code>datasource</code> reference this means attributes can also be loaded from alternative locations.</p>
</div>
<div class="paragraph">
<p>The loaded attributes can then be used for mapping to roles and permissions which should be granted to the identity or they can be obtained programatically within the deployment to identify information about the currently authenticated identity.</p>
</div>
<div class="sect5">
<h6 id="_loading_attributes_with_passwords"><a class="anchor" href="#_loading_attributes_with_passwords"></a>Loading Attributes with Passwords</h6>
<div class="paragraph">
<p>For single valued attributes these can often be loaded using the same <code>principal-query</code> used to load an identities password, as an example if an identities e-mail address or department is to be loaded from the database these can be loaded at the same time as the password.</p>
</div>
<div class="paragraph">
<p>A table for this example could look like: -</p>
</div>
<table class="tableblock frame-all grid-all" style="width: 33%;">
<caption class="title">Table 8. Example Table</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">NAME</th>
<th class="tableblock halign-left valign-top">PASSWORD</th>
<th class="tableblock halign-left valign-top">E_MAIL</th>
<th class="tableblock halign-left valign-top">Department</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">test</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">myPassword</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="mailto:test@example.com">test@example.com</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sales</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The realm can now be defined as: -</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=elytron/jdbc-realm=demo-realm:add(
    principal-query=[
        {data-source=Identities,
         sql="select PASSWORD, E_MAIL, DEPARTMENT from IDENTITIES where NAME = ?",
         clear-password-mapper={password-index=1},
         attribute-mapping=[{index=2, to=email},{index=3,to=department}]
        }])</code></pre>
</div>
</div>
<div class="paragraph">
<p>For the user <code>test</code> the result of the query would be: -</p>
</div>
<table class="tableblock frame-all grid-all" style="width: 25%;">
<caption class="title">Table 9. Query Results</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">1</th>
<th class="tableblock halign-left valign-top">2</th>
<th class="tableblock halign-left valign-top">3</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">myPassword</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="mailto:test@example.com">test@example.com</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sales</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The configuration contained the following attribute mappings: -</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>attribute-mapping=[{index=2, to=email},{index=3,to=department}]</code></pre>
</div>
</div>
<div class="paragraph">
<p>This means the contents of column 2 will be mapped to the <code>email</code> attribute and the contents of column 3 will be mapped to the <code>department</code> attribute.</p>
</div>
</div>
<div class="sect5">
<h6 id="_loading_attributes_separately"><a class="anchor" href="#_loading_attributes_separately"></a>Loading Attributes Separately.</h6>
<div class="paragraph">
<p>For multi-valued attributes such as a list of groups it can often make sense to define a separate principal query.</p>
</div>
<div class="paragraph">
<p>A list of groups could be represented as follows in a table.</p>
</div>
<table class="tableblock frame-all grid-all" style="width: 33%;">
<caption class="title">Table 10. Example Table</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">NAME</th>
<th class="tableblock halign-left valign-top">TEAM</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">test</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Users</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">test</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Supervisors</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>A realm can now be defined with a second principal query to load the groups into an attribute.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=elytron/jdbc-realm=demo-realm:add(
    principal-query=[
        {data-source=Identities,
         sql="select PASSWORD from IDENTITIES where NAME = ?",
         clear-password-mapper={password-index=1}
        },{data-source=Identities,
         sql="select TEAM from MEMBERSHIP where NAME = ?",
         attribute-mapping=[{index=1, to=groups}]
        }])</code></pre>
</div>
</div>
<div class="paragraph">
<p>Within this definition the second <code>principal-query</code> will load the attribute <code>groups</code>: -</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>{data-source=Identities,
 sql="select TEAM from MEMBERSHIP where NAME = ?",
 attribute-mapping=[{index=1, to=groups}]
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>For the user <code>test</code> the results would be: -</p>
</div>
<table class="tableblock frame-all grid-all" style="width: 25%;">
<caption class="title">Table 11. Query Results</caption>
<colgroup>
<col style="width: 100%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">1</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Users</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Supervisors</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The end result would be that the identity contains the attribute <code>groups</code> with the values <code>Users</code>, and <code>Supervisors</code></p>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="Using_WildFly_Elytron_with_WildFly"><a class="anchor" href="#Using_WildFly_Elytron_with_WildFly"></a>5. Using Elytron within WildFly</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="using-the-out-of-the-box-elytron-components"><a class="anchor" href="#using-the-out-of-the-box-elytron-components"></a>5.1. Using the Out of the Box Elytron Components</h3>
<div class="sect3">
<h4 id="securing-management-interfaces"><a class="anchor" href="#securing-management-interfaces"></a>5.1.1. Securing Management Interfaces</h4>
<div class="paragraph">
<p>You can find more details on the enabling WildFly to use the out of the
box Elytron components for securing the management interfaces in the
<a href="#default-management-authentication-configuration">Default
Management Authentication Configuration</a> section.</p>
</div>
</div>
<div class="sect3">
<h4 id="securing-applications"><a class="anchor" href="#securing-applications"></a>5.1.2. Securing Applications</h4>
<div class="paragraph">
<p>The <em>elytron</em> subsystem provides <em>application-security-domain</em> by
default which can be used to secure applications. For more details on
how <em>application-security-domain</em> is configured, see the
<a href="#default-application-authentication-configuration">Default
Application Authentication Configuration</a> section.</p>
</div>
<div class="paragraph">
<p>To configure applications to use <em>application-security-domain</em>, see
<a href="#set-up-and-configure-authentication-for-applications">Set Up and Configure Authentication for Applications</a>. You
can also override the default behavior of all applications using the
steps in
<a href="#override-an-applications-authentication-configuration">Override an Application&#8217;s Authentication Configuration</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="using-ssltls"><a class="anchor" href="#using-ssltls"></a>5.1.3. Using SSL/TLS</h4>
<div class="paragraph">
<p>WildFly does provide a default one-way SSL/TLS configuration using the
legacy core management authentication but does not provide one in the
<em>elytron</em> subsystem. You can find more details on configuring SSL/TLS
using the <em>elytron</em> subsystem for both the management interfaces as well
as for applications in
<a href="#configure-ssltls">Configure
SSL/TLS</a></p>
</div>
</div>
<div class="sect3">
<h4 id="using-elytron-with-other-subsystems"><a class="anchor" href="#using-elytron-with-other-subsystems"></a>5.1.4. Using Elytron with Other Subsystems</h4>
<div class="paragraph">
<p>In addition to securing applications and management interfaces, Elytron
also integrates with other subsystems in WildFly.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Subsystem</th>
<th class="tableblock halign-left valign-top">Details</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">batch-jberet</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">You can configure the batch-jberet to run batch jobs
using an Elytron security domain.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">datasources</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">You can use a credential store or an Elytron security
domain to provide authentication information in a datasource definition.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">messaging-activemq</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">You can secure remote connections to the remote
connections used by the messaging-activemq subsystem.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">iiop-openjdk</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">You can use the elytron subsystem to configure SSL/TLS
between clients and servers using the iiop-openjdk subsystem.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">mail</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">You can use a credential store to provide authentication
information in a server definition in the mail subsystem.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">undertow</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">You can use the elytron subsystem to configure both SSL/TLS
and application authentication.</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect2">
<h3 id="undertow-subsystem"><a class="anchor" href="#undertow-subsystem"></a>5.2. Undertow Subsystem</h3>
<div class="paragraph">
<p>As a web application is deployed the name of the security domain required by that application will be identified, this will either be from within the deployment or if the deployment does not have a security domain the <code>default-security-domain</code> as defined on the Undertow subsystem will be assumed.  By default it is assumed that the security domain maps to a PicketBox domain defined in the legacy security subsystem, however an <code>application-security-domain</code> resource can be added to the Undertow subsystem which maps from the name of the security domain required by the application to the appropriate WildFly Elytron configuration.</p>
</div>
<div class="paragraph">
<p>As an example in it&#8217;s simplest form a mapping can be added as: -</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=undertow/application-security-domain=MyAppSecurity:add(security-domain=ApplicationDomain)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Which results in: -</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;subsystem xmlns="urn:jboss:domain:undertow:7.0" ... default-security-domain="other"&gt;
...
    &lt;application-security-domains&gt;
        &lt;application-security-domain name="MyAppSecurity" security-domain="ApplicationDomain"/&gt;
    &lt;/application-security-domains&gt;
...
&lt;/subsystem&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note: If the deployment was already deployed at this point the
application server should be reloaded or the deployment redeployed for
the application security domain mapping to take effect.</em></p>
</div>
<div class="paragraph">
<p>Here we are mapping from the applications security domain <code>MyAppSecurity</code> to the WildFly Elytron defined domain <code>ApplicationDomain</code>.</p>
</div>
<div class="paragraph">
<p>This simple form is suitable where a deployment is using the standard HTTP mechanisms as defined within the Servlet specification i.e. <code>BASIC</code>, <code>CLIENT_CERT</code>, <code>DIGEST</code>, <code>FORM</code> and authentication will be performed against the <code>ApplicationDomain</code> security domain.  This form is also suitable where an application is not using any authentication mechanisms and instead is using programatic authentication or even wishes to obtain the SecurityDomain associated with the deployment and use it directly.</p>
</div>
<div class="paragraph">
<p>An advanced form of the mapping can be added as: -</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=undertow/application-security-domain=MyAppSecurity:add(http-authentication-factory=application-http-authentication)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Which results in: -</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;subsystem xmlns="urn:jboss:domain:undertow:7.0" ... default-security-domain="other"&gt;
...
    &lt;application-security-domains&gt;
        &lt;application-security-domain name="MyAppSecurity" http-authentication-factory="application-http-authentication"/&gt;
    &lt;/application-security-domains&gt;
...
&lt;/subsystem&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this form of the configuration instead of referencing a security domain a <code>http-authentication-factory</code> is referenced instead, this is the factory that will be used to obtain the instances of the authentication mechansisms and is in turn associated with the security domain.  The standard mechanisms as defined in the Servlet specification can be used in this way but this approach also allows for other mechanisms to be used such as <code>SPNEGO</code> which requires additional configuration or even plug-in custom mechanism implementations.</p>
</div>
<div class="paragraph">
<p>When the advanced form of the mapping is used a further configuration option is available: -</p>
</div>
<div class="ulist">
<ul>
<li>
<p>override-deployment-config</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The referenced <code>http-authentication-factory</code> can return a complete set of authentication mechanisms, by default these are filtered to just match the mechanisms requested by the application - if this option is set to <code>true</code> then the mechanisms offered by the factory will override the mechanisms requested by the application.  One example of where this could be useful is say an application has been developed to support <code>FORM</code> authentication, by overriding the mechanisms the application could be updated to support <code>SPNEGO</code>, and <code>FORM</code> authentication without any modifications to the deployment.</p>
</div>
<div class="paragraph">
<p>The <code>application-security-domain</code> resource also has one additional option <code>enable-jacc</code>, if this is set to true JACC will be enabled for any deployments matching against this mapping.</p>
</div>
<div class="sect3">
<h4 id="_runtime_information"><a class="anchor" href="#_runtime_information"></a>5.2.1. Runtime Information</h4>
<div class="paragraph">
<p>Where an <code>application-security-domain</code> mapping is in use it can be useful to double check that deployments did match against it as expected, if the resource is read with <code>include-runtime=true</code> the deployments that are associated with the mapping will also be shown: -</p>
</div>
<div class="listingblock">
<div class="content">
<pre>[standalone@localhost:9990 /] /subsystem=undertow/application-security-domain=MyAppSecurity:read-resource(include-runtime=true)
{
    "outcome" =&gt; "success",
    "result" =&gt; {
        "enable-jacc" =&gt; false,
        "http-authentication-factory" =&gt; undefined,
        "override-deployment-config" =&gt; false,
        "referencing-deployments" =&gt; ["simple-webapp.war"],
        "security-domain" =&gt; "ApplicationDomain",
        "setting" =&gt; undefined
    }
}</pre>
</div>
</div>
<div class="paragraph">
<p>In this output the <code>referencing-deployments</code> attribute shows that the deployment <code>simple-webapp.war</code> has been deployed using this mapping.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="Jakarta-Enterprise-Beans-subsystem"><a class="anchor" href="#Jakarta-Enterprise-Beans-subsystem"></a>5.3. Jakarta Enterprise Beans Subsystem</h3>
<div class="paragraph">
<p>Configuration can be added to the Jakarta Enterprise Beans subsystem to map a security domain
name referenced in a deployment to an Elytron security domain:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=ejb3/application-security-domain=MyAppSecurity:add(security-domain=ApplicationDomain)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Which results in:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;subsystem xmlns="urn:jboss:domain:ejb3:5.0"&gt;
...
    &lt;application-security-domains&gt;
        &lt;application-security-domain name="MyAppSecurity" security-domain="ApplicationDomain"/&gt;
    &lt;/application-security-domains&gt;
...
&lt;/subsystem&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note: If the deployment was already deployed at this point the
application server should be reloaded or the deployment redeployed for
the application security domain mapping to take effect.</em></p>
</div>
<div class="paragraph">
<p>An <code>application-security-domain</code> has two main attributes:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>name - the name of the security domain as specified in a deployment</p>
</li>
<li>
<p>security-domain - a reference to the Elytron security domain that
should be used</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>There is another attribute called <code>legacy-compliant-principal-propagation</code>.
If it is set to true and there is no incoming run-as identity,
then the principal of the local unsecured bean is the current authenticated identity. This was the case
for legacy PicketBox security. If this attribute is set to false, the behaviour will comply with the Elytron&#8217;s previous
behaviour and if there is no incoming run-as identity then the principal of the local unsecured bean is anonymous.
This attribute is optional and the default value is true.</p>
</div>
<div class="paragraph">
<p>When an application security domain mapping is configured for a bean in
a deployment, this indicates that security should be handled by Elytron.</p>
</div>
</div>
<div class="sect2">
<h3 id="webservices-subsystem"><a class="anchor" href="#webservices-subsystem"></a>5.4. WebServices Subsystem</h3>
<div class="paragraph">
<p>There is adapter in webservices subsystem to make authentication works
for elytron security domain automatically. Like configure with legacy
security domain, you can configure elytron security domain in deployment
descriptor or annotation to secure webservice endpoint.</p>
</div>
<div class="paragraph">
<p>When Elytron security is enabled, JAAS subject or principal can be pushed
to jbossws-cxf endpoint’s SecurityContext to propagate authenticated
identity to Jakarta Enterprise Beans container. Here is a CXF interceptor example to
propagate authenticated information to Jakarta Enterprise Beans container :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">public class PropagateSecurityInterceptor extends WSS4JInInterceptor {

   public PropagateSecurityInterceptor() {
      super();
      getAfter().add(PolicyBasedWSS4JInInterceptor.class.getName());
   }

   @Override
   public void handleMessage(SoapMessage message) throws Fault {
      ...
      final Endpoint endpoint = message.getExchange().get(Endpoint.class);
      final SecurityDomainContext securityDomainContext = endpoint.getSecurityDomainContext();
      //push subject principal retrieved from CXF to ElytronSecurityDomainContext
      securityDomainContext.pushSubjectContext(subject, principal, null)
   }

}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="legacy-security-subsystem"><a class="anchor" href="#legacy-security-subsystem"></a>5.5. Legacy Security Subsystem</h3>
<div class="paragraph">
<p>As previously described, Elytron based security is configured by
chaining together different capability references to form a complete
security policy. To allow an incremental migration from the legacy
Security subsystem some of the major components of this subsystem can be
mapped to Elytron capabilities and used within an Elytron based set up.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="Client_Authentication_with_Elytron_Client"><a class="anchor" href="#Client_Authentication_with_Elytron_Client"></a>6. Client Authentication with Elytron Client</h2>
<div class="sectionbody">
<div class="paragraph">
<p>WildFly Elytron uses the Elytron Client project to enable remote clients
to authenticate using Elytron. Elytron Client has the following
components:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Component</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Authentication Configuration</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Contains authentication information such
as usernames, passwords, allowed SASL mechanisms, and the security realm
to use during digest authentication.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">MatchRule</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Rule used for deciding which authentication configuration to
use.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Authentication Context</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set of rules and authentication configurations
to use with a client for establishing a connection.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>When a connection is established, the client makes use of an
authentication context, which gives rules that match which
authentication configuration is used with an outbound connection. For
example, you could have a rule that use one authentication
configuration when connecting to <em>server1</em> and another authentication
configuration when connecting with <em>server2</em>. The authentication context
is comprised of a set of authentication configurations and a set of
rules that define how they are selected when establishing a connection.
An authentication context can also reference <em>ssl-context</em> and can be
matched with rules.</p>
</div>
<div class="paragraph">
<p>To create a client that uses security information when establishing a
connection:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Create one or more authentication configurations.</p>
</li>
<li>
<p>Create an authentication context by creating rule and authentication
configuration pairs.</p>
</li>
<li>
<p>Create a runnable for establishing your connection.</p>
</li>
<li>
<p>Use your authentication context to run your runnable.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>When you establish your connection, Elytron Client will use the set of
rules provided by the authentication context to match the correct
authentication configuration to use during authentication.</p>
</div>
<div class="paragraph">
<p>You can use one of the following approaches to use security information
when establishing a client connection.</p>
</div>
<div class="paragraph">
<p><strong>IMPORTANT</strong>: When using Elytron Client to make Jakarta Enterprise Beans calls, any hard-coded
programatic authentication information, such as setting
<em>Context.SECURITY_PRINCIPAL</em> in the <em>javax.naming.InitialContext</em>, will
override the Elytron Client configuration.</p>
</div>
<div class="sect2">
<h3 id="the-configuration-file-approach"><a class="anchor" href="#the-configuration-file-approach"></a>6.1. The Configuration File Approach</h3>
<div class="paragraph">
<p>The configuration file approach involves creating an XML file with your
authentication configuration, authentication context, and match rules.</p>
</div>
<div class="paragraph">
<p><strong>custom-config.xml</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;configuration&gt;
    &lt;authentication-client xmlns="urn:elytron:1.0"&gt;
        &lt;authentication-rules&gt;
            &lt;rule use-configuration="monitor"&gt;
                &lt;match-host name="127.0.0.1" /&gt;
            &lt;/rule&gt;
            &lt;rule use-configuration="administrator"&gt;
                &lt;match-host name="localhost" /&gt;
            &lt;/rule&gt;
        &lt;/authentication-rules&gt;
        &lt;authentication-configurations&gt;
            &lt;configuration name="monitor"&gt;
                &lt;allow-sasl-mechanisms names="DIGEST-MD5" /&gt;
                 &lt;use-service-loader-providers /&gt;
                 &lt;set-user-name name="monitor" /&gt;
                 &lt;credentials&gt;
                     &lt;clear-password password="password1!" /&gt;
                 &lt;/credentials&gt;
                 &lt;set-mechanism-realm name="ManagementRealm" /&gt;
             &lt;/configuration&gt;

             &lt;configuration name="administrator"&gt;
                &lt;allow-sasl-mechanisms names="DIGEST-MD5" /&gt;
                 &lt;use-service-loader-providers /&gt;
                 &lt;set-user-name name="administrator" /&gt;
                 &lt;credentials&gt;
                     &lt;clear-password password="password1!" /&gt;
                 &lt;/credentials&gt;
                 &lt;set-mechanism-realm name="ManagementRealm" /&gt;
             &lt;/configuration&gt;
        &lt;/authentication-configurations&gt;
    &lt;/authentication-client&gt;
&lt;/configuration&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The above example shows how the password for authentication can be specified in the clear. However, it&#8217;s also possible
to use a masked password instead.</p>
</div>
<div class="paragraph">
<p><strong>custom-config.xml</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;configuration&gt;
    &lt;authentication-client xmlns="urn:elytron:1.4"&gt;
        &lt;authentication-rules&gt;
            &lt;rule use-configuration="monitor"&gt;
                &lt;match-host name="127.0.0.1" /&gt;
            &lt;/rule&gt;
            &lt;rule use-configuration="administrator"&gt;
                &lt;match-host name="localhost" /&gt;
            &lt;/rule&gt;
        &lt;/authentication-rules&gt;
        &lt;authentication-configurations&gt;
            &lt;configuration name="monitor"&gt;
                &lt;allow-sasl-mechanisms names="DIGEST-MD5" /&gt;
                 &lt;use-service-loader-providers /&gt;
                 &lt;set-user-name name="monitor" /&gt;
                 &lt;credentials&gt;
                     &lt;masked-password iteration-count="100" salt="12345678" masked-password="/Nym2s/dssMrabfdIGsZfQ==" /&gt;
                 &lt;/credentials&gt;
                 &lt;set-mechanism-realm name="ManagementRealm" /&gt;
             &lt;/configuration&gt;

             &lt;configuration name="administrator"&gt;
                &lt;allow-sasl-mechanisms names="DIGEST-MD5" /&gt;
                 &lt;use-service-loader-providers /&gt;
                 &lt;set-user-name name="administrator" /&gt;
                 &lt;credentials&gt;
                     &lt;masked-password iteration-count="100" salt="12345678" masked-password="/Nym2s/dssMrabfdIGsZfQ==" /&gt;
                 &lt;/credentials&gt;
                 &lt;set-mechanism-realm name="ManagementRealm" /&gt;
             &lt;/configuration&gt;
        &lt;/authentication-configurations&gt;
    &lt;/authentication-client&gt;
&lt;/configuration&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can then reference that file in your client&#8217;s code by setting a system property when running your client.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>$ java -Dwildfly.config.url=/path/to/the.xml .....</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>IMPORTANT</strong>: If you use the
<a href="#the-programmatic-approach">The
Programmatic Approach</a>, it will override any provided configuration
files even if the <em>wildfly.config.url</em> system property is set.</p>
</div>
<div class="paragraph">
<p>When creating rules, you can look for matches on various parameters such
as hostname, port, protocol, or username. A full list of options for
<em>MatchRule</em> are available in the
<a href="http://wildfly-security.github.io/wildfly-elytron/master/org/wildfly/security/auth/client/MatchRule.html">Javadocs</a>.
Rules are evaluated in the order in which they are configured.</p>
</div>
<div class="paragraph">
<p><strong>Common Rules</strong></p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Rule</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">match-domain</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Takes a single name attribute specifying the security
domain to match against.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">match-host</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Takes a single name attribute specifying the hostname to
match against. For example, the host 127.0.0.1 would match on
<a href="http://127.0.0.1:9990/my/path" class="bare">http://127.0.0.1:9990/my/path</a> .</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">match-no-user</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Matches against URIs with no user.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">match-path</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Takes a single name attribute specifying the path to match
against. For example, the path /my/path/ would match on
<a href="http://127.0.0.1:9990/my/path" class="bare">http://127.0.0.1:9990/my/path</a> .</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">match-port</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Takes a single name attribute specifying the port to match
against. For example, the port 9990 would match on
<a href="http://127.0.0.1:9990/my/path" class="bare">http://127.0.0.1:9990/my/path</a> .</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">match-protocol</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Takes a single name attribute specifying the protocol
to match against. For example, the protocol http would match on
<a href="http://127.0.0.1:9990/my/path" class="bare">http://127.0.0.1:9990/my/path</a> .</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">match-purpose</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Takes a names attribute specifying the list of purposes
to match against.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">match-urn</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Takes a single name attribute specifying the URN to match
against.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">match-user</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Takes a single name attribute specifying the user
to match against.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="the-programmatic-approach"><a class="anchor" href="#the-programmatic-approach"></a>6.2. The Programmatic Approach</h3>
<div class="paragraph">
<p>The programatic approach configures all the Elytron Client configuration
in the client&#8217;s code:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">//create your authentication configuration
AuthenticationConfiguration adminConfig =
    AuthenticationConfiguration.EMPTY
      .useProviders(() -&gt; new Provider[] { new WildFlyElytronProvider() })
      .allowSaslMechanisms("DIGEST-MD5")
      .useRealm("ManagementRealm")
      .useName("administrator")
      .usePassword("password1!");

//create your authentication context
AuthenticationContext context = AuthenticationContext.empty();
context = context.with(MatchRule.ALL.matchHost("127.0.0.1"), adminConfig);


//create your runnable for establishing a connection
Runnable runnable =
    new Runnable() {
      public void run() {
        try {
           //Establish your connection and do some work
        } catch (Exception e) {
          e.printStackTrace();
        }
      }
    };

//use your authentication context to run your client
context.run(runnable);</code></pre>
</div>
</div>
<div class="paragraph">
<p>The above example shows how the password for authentication can be specified in the clear. However, it&#8217;s also possible
to use a masked password instead.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">//create your authentication configuration
AuthenticationConfiguration adminConfig =
    AuthenticationConfiguration.EMPTY
      .useProviders(() -&gt; new Provider[] { new WildFlyElytronProvider() })
      .allowSaslMechanisms("DIGEST-MD5")
      .useRealm("ManagementRealm")
      .useName("administrator")
      .usePassword("/Nym2s/dssMrabfdIGsZfQ==", null, null, "100", "12345678", null);

//create your authentication context
AuthenticationContext context = AuthenticationContext.empty();
context = context.with(MatchRule.ALL.matchHost("127.0.0.1"), adminConfig);


//create your runnable for establishing a connection
Runnable runnable =
    new Runnable() {
      public void run() {
        try {
           //Establish your connection and do some work
        } catch (Exception e) {
          e.printStackTrace();
        }
      }
    };

//use your authentication context to run your client
context.run(runnable);</code></pre>
</div>
</div>
<div class="paragraph">
<p>When adding configuration details to <em>AuthenticationConfiguration</em> and
<em>AuthenticationContext</em>, each method call returns a new instance of that
object. For example, if you wanted separate configurations when
connecting over different hostnames, you could do the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">//create your authentication configuration
AuthenticationConfiguration commonConfig =
    AuthenticationConfiguration.EMPTY
      .useProviders(() -&gt; new Provider[] { new WildFlyElytronProvider() })
      .allowSaslMechanisms("DIGEST-MD5")
      .useRealm("ManagementRealm");

AuthenticationConfiguration administrator =
    commonConfig
      .useName("administrator")
      .usePassword("password1!");


AuthenticationConfiguration monitor =
    commonConfig
      .useName("monitor")
      .usePassword("password1!");


//create your authentication context
AuthenticationContext context = AuthenticationContext.empty();
context = context.with(MatchRule.ALL.matchHost("127.0.0.1"), administrator);
context = context.with(MatchRule.ALL.matchHost("localhost"), monitor);</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Common Rules</strong></p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Rule</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">matchLocalSecurityDomain(String name)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">This is the same as match-domain
in the configuration file approach.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">matchNoUser()</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">This is the same as match-no-user in the configuration
file approach.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">matchPath(String pathSpec)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">This is the same as match-path in the
configuration file approach.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">matchPort(int port)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">This is the same as match-port in the
configuration file approach.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">matchProtocol(String protoName)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">This is the same as match-port in the
configuration file approach.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">matchPurpose(String purpose)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Create a new rule which is the same as
this rule, but also matches the given purpose name.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">matchPurposes(String&#8230;&#8203; purposes)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">This is the same as match-purpose in
the configuration file approach.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">matchUrnName(String name)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">This is the same as match-urn in the
configuration file approach.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">matchUser(String userSpec)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">This is the same as match-user in the
configuration file approach.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Also, instead of starting with an empty authentication configuration,
you can start with the current configured one by using
<em>captureCurrent()</em>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">//create your authentication configuration
AuthenticationConfiguration commonConfig = AuthenticationConfiguration.captureCurrent();</code></pre>
</div>
</div>
<div class="paragraph">
<p>Using <em>captureCurrent()</em> will capture any previously established
authentication context and use it as your new base configuration.
An authentication context is established once it&#8217;s been activated by calling
<em>run()</em>. If <em>captureCurrent()</em> is called and no context is currently
active, it will try and use the default authentication if available. You
can find more details about this in
<a href="#the-configuration-file-approach">The
Configuration File Approach</a>,
<a href="#the-default-configuration-approach">The
Default Configuration Approach</a>, and
<a href="#using-elytron-client-with-clients-deployed-to-wildfly">Using Elytron Client
with Clients Deployed to WildFly</a> sections.</p>
</div>
<div class="paragraph">
<p>Using <em>AuthenticationConfiguration.EMPTY</em> should only be used as a base
to build a configuration on top of and should not be used on its own. It
provides a configuration that uses the JVM-wide registered providers and
enables anonymous authentication.</p>
</div>
<div class="paragraph">
<p>When specifying the providers on top of the
<em>AuthenticationConfiguration.EMPTY</em> configuration, you can specify a
custom list, but most users should use <em>WildFlyElytronProvider()</em>
providers.</p>
</div>
<div class="paragraph">
<p>When creating an authentication context, using the <em>context.with(&#8230;&#8203;)</em>
will create a new context that merges the rules and authentication
configuration from the current context with the provided rule and
authentication configuration. The provided rule and authentication
configuration will appear after the ones in the current context.</p>
</div>
</div>
<div class="sect2">
<h3 id="the-default-configuration-approach"><a class="anchor" href="#the-default-configuration-approach"></a>6.3. The Default Configuration Approach</h3>
<div class="paragraph">
<p>The default configuration approach relies completely on the
configuration provided by Elytron Client:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">//create your runnable for establishing a connection
Runnable runnable =
    new Runnable() {
      public void run() {
        try {
           //Establish your connection and do some work
        } catch (Exception e) {
          e.printStackTrace();
        }
      }
    };

// run runnable directly
runnable.run();</code></pre>
</div>
</div>
<div class="paragraph">
<p>To provide a default configuration, Elytron Client tries to
auto-discover a <em>wildfly-config.xml</em> file on the filesystem. It looks in
the following locations:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Location specified by the <em>wildfly.config.url</em> system property set
outside of the client code.</p>
</li>
<li>
<p>The classpath root directory.</p>
</li>
<li>
<p>The <em>META-INF</em> directory on the classpath.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If it does not find one, it will try and use the default
<em>wildfly-config.xml</em> provided in the
<em>$WILDFLY_HOME/bin/client/jboss-client.jar</em>.</p>
</div>
<div class="paragraph">
<p><strong>default wildfly-config.xml</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;configuration&gt;
  &lt;authentication-client xmlns="urn:elytron:1.0"&gt;
    &lt;authentication-rules&gt;
      &lt;rule use-configuration="default" /&gt;
    &lt;/authentication-rules&gt;
    &lt;authentication-configurations&gt;
      &lt;configuration name="default"&gt;
        &lt;allow-all-sasl-mechanisms /&gt;
        &lt;set-mechanism-properties&gt;
          &lt;property key="wildfly.sasl.local-user.quiet-auth" value="true" /&gt;
        &lt;/set-mechanism-properties&gt;
        &lt;use-service-loader-providers /&gt;
      &lt;/configuration&gt;
    &lt;/authentication-configurations&gt;
  &lt;/authentication-client&gt;
&lt;/configuration&gt;</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="using-elytron-client-with-clients-deployed-to-wildfly"><a class="anchor" href="#using-elytron-client-with-clients-deployed-to-wildfly"></a>6.4. Using Elytron Client with Clients Deployed to WildFly</h3>
<div class="paragraph">
<p>Clients deployed to WildFly can also make use of Elytron Client. In
cases where you have included a <em>wildfly-config.xml</em> with your
deployment or the system property has been set, an
<em>AuthenticationContext</em> is automatically parsed and created from that
file.</p>
</div>
<div class="paragraph">
<p>To load a configuration file outside of the deployment, you can use the
<em>parseAuthenticationClientConfiguration(URI)</em> method. This method will
return an <em>AuthenticationContext</em> which you can then use in your client&#8217;s
code using the
<a href="#the-programmatic-approach">The
Programmatic Approach</a>.</p>
</div>
<div class="paragraph">
<p>Additionally, clients will also automatically parse and create an
AuthenticationContext from the client configuration provided by the
<em>elytron</em> subsystem. The client configuration in the <em>elytron</em> subsystem
can also take advantage of other components defined in the <em>elytron</em>
subsystem such as credential stores. If client configuration is provided
by BOTH the deployment and the <em>elytron</em> subsystem, the <em>elytron</em>
subsystem&#8217;s configuration is used.</p>
</div>
</div>
<div class="sect2">
<h3 id="Configuring_other_clients_using_wildfly-config"><a class="anchor" href="#Configuring_other_clients_using_wildfly-config"></a>6.5. Client configuration using wildfly-config.xml</h3>
<div class="paragraph">
<p>Prior to WildFly 11, many WildFly client libraries used different configuration strategies. WildFly 11 introduces a new <code>wildfly-config.xml</code> file which unifies all client configuration in a single place. In addition to being able to configure authentication using Elytron as described in the previous section, a <code>wildfly-config.xml</code> file can also be used to:</p>
</div>
<div class="sect3">
<h4 id="_configure_jakarta_enterprise_beans_client_connections_global_interceptors_and_invocation_timeout"><a class="anchor" href="#_configure_jakarta_enterprise_beans_client_connections_global_interceptors_and_invocation_timeout"></a>6.5.1. Configure Jakarta Enterprise Beans client connections, global interceptors, and invocation timeout</h4>
<div class="paragraph">
<p>Schema location: [<a href="https://github.com/wildfly/jboss-ejb-client/blob/4.0.2.Final/src/main/resources/schema/wildfly-client-ejb_3_0.xsd" class="bare">https://github.com/wildfly/jboss-ejb-client/blob/4.0.2.Final/src/main/resources/schema/wildfly-client-ejb_3_0.xsd</a>]</p>
</div>
<div class="paragraph">
<p>Example configuration:</p>
</div>
<div class="listingblock">
<div class="title">wildfly-config.xml</div>
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;configuration&gt;
...
    &lt;jboss-ejb-client xmlns="urn:jboss:wildfly-client-ejb:3.0"&gt;
        &lt;invocation-timeout seconds="10"/&gt;
        &lt;connections&gt;
            &lt;connection uri="remote+http://10.20.30.40:8080"/&gt;
        &lt;/connections&gt;
        &lt;global-interceptors&gt;
            &lt;interceptor class="org.jboss.example.ExampleInterceptor"/&gt;
        &lt;/global-interceptors&gt;
    &lt;/jboss-ejb-client&gt;
...
&lt;/configuration&gt;</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_configure_http_client"><a class="anchor" href="#_configure_http_client"></a>6.5.2. Configure HTTP client</h4>
<div class="paragraph">
<p>Schema location:[<a href="https://github.com/wildfly/wildfly-http-client/blob/1.0.2.Final/common/src/main/resources/schema/wildfly-http-client_1_0.xsd" class="bare">https://github.com/wildfly/wildfly-http-client/blob/1.0.2.Final/common/src/main/resources/schema/wildfly-http-client_1_0.xsd</a>]</p>
</div>
<div class="paragraph">
<p>Example configuration:</p>
</div>
<div class="listingblock">
<div class="title">wildfly-config.xml</div>
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;configuration&gt;
...
    &lt;http-client xmlns="urn:wildfly-http-client:1.0"&gt;
        &lt;defaults&gt;
            &lt;eagerly-acquire-session value="true" /&gt;
            &lt;buffer-pool buffer-size="2000" max-size="10" direct="true" thread-local-size="1" /&gt;
        &lt;/defaults&gt;
    &lt;/http-client&gt;
...
&lt;/configuration&gt;</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_configure_a_remoting_endpoint"><a class="anchor" href="#_configure_a_remoting_endpoint"></a>6.5.3. Configure a remoting endpoint</h4>
<div class="paragraph">
<p>Schema location:[<a href="https://github.com/jboss-remoting/jboss-remoting/blob/5.0.1.Final/src/main/resources/schema/jboss-remoting_5_0.xsd" class="bare">https://github.com/jboss-remoting/jboss-remoting/blob/5.0.1.Final/src/main/resources/schema/jboss-remoting_5_0.xsd</a>]</p>
</div>
<div class="paragraph">
<p>Example configuration:</p>
</div>
<div class="listingblock">
<div class="title">wildfly-config.xml</div>
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;configuration&gt;
...
    &lt;endpoint xmlns="urn:jboss-remoting:5.0"&gt;
        &lt;connections&gt;
            &lt;connection destination="remote+http://10.20.30.40:8080" read-timeout="50" write-timeout="50" heartbeat-interval="10000"/&gt;
        &lt;/connections&gt;
    &lt;/endpoint&gt;
...
&lt;/configuration&gt;</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_configure_the_default_xnio_worker"><a class="anchor" href="#_configure_the_default_xnio_worker"></a>6.5.4. Configure the default XNIO worker</h4>
<div class="paragraph">
<p>Schema location:[<a href="https://github.com/xnio/xnio/blob/3.5.1.Final/api/src/main/resources/schema/xnio_3_5.xsd" class="bare">https://github.com/xnio/xnio/blob/3.5.1.Final/api/src/main/resources/schema/xnio_3_5.xsd</a>]</p>
</div>
<div class="paragraph">
<p>Example configuration:</p>
</div>
<div class="paragraph">
<p><strong>wildfly-config.xml</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;configuration&gt;
...
    &lt;worker xmlns="urn:xnio:3.5"&gt;
        &lt;io-threads value="10"/&gt;
        &lt;task-keepalive value="100"/&gt;
        &lt;stack-size value="5000"/&gt;
    &lt;/worker&gt;
...
&lt;/configuration&gt;</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_configure_resteasy_client"><a class="anchor" href="#_configure_resteasy_client"></a>6.5.5. Configure RESTEasy client</h4>
<div class="paragraph">
<p>RESTEasy client will automatically load credentials, bearer token and SSL context from <code>wildfly-config.xml</code>. Credentials will be used for HTTP Basic authentication and bearer token for Bearer token authentication.</p>
</div>
<div class="paragraph">
<p>Example configuration:</p>
</div>
<div class="paragraph">
<p><strong>wildfly-config.xml</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;configuration&gt;
    &lt;authentication-client xmlns="urn:elytron:client:1.4"&gt;
    ...
        &lt;set-user-name name="administrator" /&gt;
        &lt;credentials&gt;
            &lt;bearer-token value="bearerTokenValue"/&gt;
        &lt;/credentials&gt;
        &lt;key-stores&gt;
            &lt;key-store name="truststore" type="JKS"&gt;
                &lt;file name="src/test/resources/org/jboss/resteasy/test/security/client-different-cert.truststore"/&gt;
            &lt;/key-store&gt;
        &lt;/key-stores&gt;
        &lt;ssl-contexts&gt;
            &lt;ssl-context name="client-context"&gt;
                &lt;trust-store key-store-name="truststore"/&gt;
            &lt;/ssl-context&gt;
        &lt;/ssl-contexts&gt;
        &lt;ssl-context-rules&gt;
            &lt;rule use-ssl-context="client-context"/&gt;
        &lt;/ssl-context-rules&gt;
    ...
    &lt;/authentication-client&gt;
&lt;/configuration&gt;</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Note that WildFly client libraries do have reasonable default configuration. Thus, adding configuration for these clients to <code>wildfly-config.xml</code> isn’t mandatory.
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="Elytron_and_Java_Authorization_Contract_for_Containers-JACC"><a class="anchor" href="#Elytron_and_Java_Authorization_Contract_for_Containers-JACC"></a>7. Elytron and Java Authorization Contract for Containers (JACC)</h2>
<div class="sectionbody">
<div class="quoteblock abstract">
<blockquote>
This document will guide you on how to enable JACC using Elytron
Subsystem.
</blockquote>
</div>
<div class="sect2">
<h3 id="disabling-jacc-in-legacy-security-subsystem-picketbox"><a class="anchor" href="#disabling-jacc-in-legacy-security-subsystem-picketbox"></a>7.1. Disabling JACC in Legacy Security Subsystem (PicketBox)</h3>
<div class="paragraph">
<p>By default, the application server uses the legacy security subsystem
(PicketBox) to configure the JACC policy provider and factory. The
default configuration maps to implementations from PicketBox.</p>
</div>
<div class="paragraph">
<p>In order to use Elytron to manage JACC configuration (or any other
policy you want to install to the application server) you must first
disable JACC in legacy security subsystem. For that, please execute the
following CLI command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=security:write-attribute(name=initialize-jacc, value=false)</code></pre>
</div>
</div>
<div class="paragraph">
<p>The command above tells the legacy security subsystem to not initialize
any JACC related configuration, but rely on the policies defined via
Elytron subsystem as we&#8217;ll see in the next sections.</p>
</div>
</div>
<div class="sect2">
<h3 id="defining-a-jacc-policy-provider"><a class="anchor" href="#defining-a-jacc-policy-provider"></a>7.2. Defining a JACC Policy Provider</h3>
<div class="paragraph">
<p>Elytron subsystem provides a built-in policy provider based on JACC
specification. To create the policy provider you can execute a CLI
command as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>[standalone@localhost:9990 /] /subsystem=elytron/policy=jacc:add(jacc-policy={})</code></pre>
</div>
</div>
<div class="paragraph">
<p>After executing the command above, please reload the server
configuration as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>[standalone@localhost:9990 /] reload</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="enabling-jacc-to-a-web-deployment"><a class="anchor" href="#enabling-jacc-to-a-web-deployment"></a>7.3. Enabling JACC to a Web Deployment</h3>
<div class="paragraph">
<p>Once JACC Policy Provider is defined you can enable JACC to web
deployments by executing the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>[standalone@localhost:9990 /] /subsystem=undertow/application-security-domain=other:add(http-authentication-factory=application-http-authentication,enable-jacc=true)</code></pre>
</div>
</div>
<div class="paragraph">
<p>The command above defines a default security domain for applications if
none is provided in <strong>jboss-web.xml.</strong> In case you already have a
<strong>application-security-domain</strong> defined and just want to enable JACC you
can execute a command as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>[standalone@localhost:9990 /] /subsystem=undertow/application-security-domain=my-security-domain:write-attribute(name=enable-jacc,value=true)</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="enabling-jacc-to-a-ejb-deployment"><a class="anchor" href="#enabling-jacc-to-a-ejb-deployment"></a>7.4. Enabling JACC to a EJB Deployment</h3>
<div class="paragraph">
<p>Once JACC Policy Provider is defined you can enable JACC to EJB
deployments by executing the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>[standalone@localhost:9990 /] /subsystem=ejb3/application-security-domain=other:add(security-domain=ApplicationDomain,enable-jacc=true)</code></pre>
</div>
</div>
<div class="paragraph">
<p>The command above defines a default security domain for EJBs. In case
you already have a *application-security-domain *defined and just want
to enable JACC you can execute a command as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>[standalone@localhost:9990 /] /subsystem=ejb3/application-security-domain=my-security-domain:write-attribute(name=enable-jacc,value=true)</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
References in this document to Java Authorization Contract for Containers (JACC) refer to Jakarta Authorization unless otherwise noted.
      References in this document to Enterprise JavaBeans(EJB) refer to the Jakarta Enterprise Beans unless otherwise noted.
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="Elytron_and_Java_Authentication_SPI_for_Containers-JASPI"><a class="anchor" href="#Elytron_and_Java_Authentication_SPI_for_Containers-JASPI"></a>9. Elytron and Java Authentication SPI for Containers (JASPI)</h2>
<div class="sectionbody">
<div class="sect1">
<h2 id="_introduction"><a class="anchor" href="#_introduction"></a>8. Introduction</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Starting from WildFly 15 an implementation of the Servlet profile from the Java Authentication SPI for Containers (JSR-196 / JASPI) is also provided by the WildFly Elytron subsystem allowing tighter integration with the security features provided by WildFly Elytron.  This JASPI implementation is available out of the box with minimal steps required to use it for deployments, this section of the documentation describes how to make use of it and the features it provides.</p>
</div>
<div class="sect2">
<h3 id="_activation"><a class="anchor" href="#_activation"></a>8.1. Activation</h3>
<div class="paragraph">
<p>Presently it is the Servlet profile from the JASPI specification which is supported by this integration, the following information applies to web applications deployed to WildFly.</p>
</div>
<div class="paragraph">
<p>For the JASPI integration to be enabled for a web application that web application needs to be associated with either an Elytron <code>http-authentication-factory</code> or a <code>security-domain</code> - by doing this the WildFly Elytron security handlers will be installed for the deployment and the WildFly Elytron security framework activated for the deployment.  This is all that is required for a deployment to be 'securable' using a JASPI configuration.</p>
</div>
<div class="paragraph">
<p>Once the WildFly Elytron security framework is activate for a deployment at the time requests are being handled the globally registered <code>AuthConfigFactory</code> will be queried to identify if an <code>AuthConfigProvider</code> has been registered which should be used for that deployment - if an <code>AuthConfigProvider</code> is found then JASPI authentication will be used instead of the deployments authentication configuration.  If no <code>AuthConfigProvider</code> is found then the authentication configuration for the deployment will be used instead, this could mean authentication mechanisms from a <code>http-authentication-factory</code> are used or mechanisms specified in the <code>web.xml</code> are used or it could even mean no authentication is performed if the application does not have any mechanisms defined.</p>
</div>
<div class="paragraph">
<p>Any updates made to the <code>AuthConfigFactory</code> are immediately available, this means that if an <code>AuthConfigProvider</code> is registered which is a match for an existing application it will start to be used immediately without requiring redeployment of the application.</p>
</div>
<div class="paragraph">
<p>All web applications deployed to WildFly have a security domain which will be resolved in the following order: -</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>From the deployment descriptors / annotations of the deployment being deployed.</p>
</li>
<li>
<p>The value defined on the <code>default-security-domain</code> attribute on the Undertow subsystem.</p>
</li>
<li>
<p>Default to 'other'.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>We assume that this security domain is a reference to a PicketBox security domain so the final step in activation is ensuring this is mapped to WildFly Elytron using an <code>application-security-domain</code> resource in the Undertow subsystem.  This mapping can either reference a WildFly Elytron security domain directly or it can reference a <code>http-authentication-factory</code> resource to obtain instances of authentication mechanisms.</p>
</div>
<div class="paragraph">
<p>e.g.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=undertow/application-security-domain=MyAppSecurity:add(security-domain=ApplicationDomain)</code></pre>
</div>
</div>
<div class="paragraph">
<p>or</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=undertow/application-security-domain=MyAppSecurity:add(http-authentication-factory=application-http-authentication)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Although this latter form references a <code>http-authentication-factory</code> that in turn will reference a security domain - for both examples the referenced security domain is associated with the deployment.</p>
</div>
<div class="paragraph">
<p>The minimal steps to enable the JASPI integration are: -
 . Leave the <code>default-security-domain</code> attribute on the Undertow subsystem undefined so it defaults to 'other'.
 . Add an <code>application-security-domain</code> mapping from 'other' to a WildFly Elytron security domain.</p>
</div>
<div class="paragraph">
<p>All deployments that do not specify their own security domain will be assigned this default mapping automatically which will activate the WildFly Elytron handlers and subsequently make JASPI available for that deployment.</p>
</div>
<div class="paragraph">
<p>The security domain associated with a deployment in these steps is the security domain that will be wrapped in a CallbackHandler to be passed into the <code>ServerAuthModule</code> instances used for authentication.</p>
</div>
<div class="sect3">
<h4 id="_additional_options"><a class="anchor" href="#_additional_options"></a>8.1.1. Additional Options</h4>
<div class="paragraph">
<p>On the <code>application-security-domain</code> resource two additional attributes have been added to allow some further control of the JASPI behaviour.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>enable-jaspi</strong> - Can be set to <code>false</code> to disable JASPI support for all deployments using this mapping.</p>
</li>
<li>
<p><strong>integrated-jaspi</strong> - By default all identities are loaded from the security domain, if set to <code>false</code> ad-hoc identities will be created instead.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_subsystem_configuration"><a class="anchor" href="#_subsystem_configuration"></a>8.2. Subsystem Configuration</h3>
<div class="paragraph">
<p>One way to register a configuration which will result in an <code>AuthConfigProvider</code> being returned for a deployment is to register a <code>jaspi-configuration</code> in the Elytron subsystem.</p>
</div>
<div class="paragraph">
<p>The following command demonstrates how to add a configuration containing two <code>ServerAuthModule</code> definitions: -</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>./subsystem=elytron/jaspi-configuration=simple-configuration:add(layer=HttpServlet, application-context="default-host /webctx", \
        description="Elytron Test Configuration", \
        server-auth-modules=[{class-name=org.wildfly.security.examples.jaspi.SimpleServerAuthModule, module=org.wildfly.security.examples.jaspi, flag=OPTIONAL, options={a=b, c=d}}, \
            {class-name=org.wildfly.security.examples.jaspi.SecondServerAuthModule, module=org.wildfly.security.examples.jaspi}])</code></pre>
</div>
</div>
<div class="paragraph">
<p>This results in the following configuration being persisted: -</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;jaspi&gt;
    &lt;jaspi-configuration name="simple-configuration" layer="HttpServlet" application-context="default-host /webctx" description="Elytron Test Configuration"&gt;
        &lt;server-auth-modules&gt;
            &lt;server-auth-module class-name="org.wildfly.security.examples.jaspi.SimpleServerAuthModule" module="org.wildfly.security.examples.jaspi" flag="OPTIONAL"&gt;
                &lt;options&gt;
                    &lt;property name="a" value="b"/&gt;
                    &lt;property name="c" value="d"/&gt;
                &lt;/options&gt;
            &lt;/server-auth-module&gt;
            &lt;server-auth-module class-name="org.wildfly.security.examples.jaspi.SecondServerAuthModule" module="org.wildfly.security.examples.jaspi"/&gt;
        &lt;/server-auth-modules&gt;
    &lt;/jaspi-configuration&gt;
&lt;/jaspi&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>name</code> attribute is just a name that allows the resource to be referenced in the management model.</p>
</div>
<div class="paragraph">
<p>The <code>layer</code> and <code>application-context</code> attributes are used when registering this configuration with the <code>AuthConfigFactory</code> - both of these attributes can be omitted allowing wildcard matching.  The <code>description</code> attribute is also optional and is used to provide a description to the <code>AuthConfigFactory</code>.</p>
</div>
<div class="paragraph">
<p>Within the configuration one or more <code>server-auth-module</code> instances can be defined with the following attributes.
 * <strong>class-name</strong> - The fully qualified class name of the <code>ServerAuthModule</code>.
 * <strong>module</strong> - The module to load the <code>ServerAuthModule</code> from.
 * <strong>flag</strong> - The control flag to indicate how this module operates in relation to the other modules.
 * <strong>options</strong> - Configuration options to be passed into the <code>ServerAuthModule</code> on initialisation.</p>
</div>
<div class="paragraph">
<p>Configuration defined in this way is immediately registered with the <code>AuthConfigFactory</code> so any existing deployments using the WildFly Elytron security framework that match against the <code>layer</code> and <code>application-context</code> will immediately start to make use of the configuration.</p>
</div>
</div>
<div class="sect2">
<h3 id="_programatic_configuration"><a class="anchor" href="#_programatic_configuration"></a>8.3. Programatic Configuration</h3>
<div class="paragraph">
<p>The APIs defined within the JASPI specification allow for applications to dynamically register custom <code>AuthConfigProvider</code> instances, however the specification does not provide the actual implementations to use or a standard way to create instances of the implementations, the WildFly Elytron project contains a simple utility that can be used by deployments to help with this: -</p>
</div>
<div class="paragraph">
<p><code>org.wildfly.security.auth.jaspi.JaspiConfigurationBuilder</code></p>
</div>
<div class="paragraph">
<p>The following piece of code illustrates how this API can be used to register a similar configuration to the one illustrated in the subsystem.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">String registraionId = JaspiConfigurationBuilder.builder("HttpServlet", servletContext.getVirtualServerName() + " " + servletContext.getContextPath())
    .addAuthModuleFactory(SimpleServerAuthModule::new, Flag.OPTIONAL, Collections.singletonMap("a", "b"))
    .addAuthModuleFactory(SecondServerAuthModule::new)
.register();</code></pre>
</div>
</div>
<div class="paragraph">
<p>As an example this code could be executed within the init() method of a Servlet to register the <code>AuthConfigProvider</code> specific for that deployment, in this code example the application context has also been assembled by consulting the <code>ServletContext</code>.</p>
</div>
<div class="paragraph">
<p>The register method returns the resulting registration ID that can also be used to subsequently remove this registration directly from the <code>AuthConfigFactory</code>.</p>
</div>
<div class="paragraph">
<p>As with the subsystem configuration this call has an immediate effect and will be live for all web applications using the WildFly Elytron security framework immediately.</p>
</div>
</div>
<div class="sect2">
<h3 id="_authentication_process"><a class="anchor" href="#_authentication_process"></a>8.4. Authentication Process</h3>
<div class="sect3">
<h4 id="_callbackhandler"><a class="anchor" href="#_callbackhandler"></a>8.4.1. CallbackHandler</h4>
<div class="paragraph">
<p>Based on the configuration on the <code>application-security-domain</code> resource in the Undertow subsystem the CallbackHandler passed to the ServerAuthModule in an integrated or non-integrated mode.</p>
</div>
</div>
<div class="sect3">
<h4 id="_integrated"><a class="anchor" href="#_integrated"></a>8.4.2. Integrated</h4>
<div class="paragraph">
<p>When operating in integrated mode although the ServerAuthModule instances will be handling the actual authentication the resulting identity will be loaded from the referenced SecurityDomain using the SecurityRealms referenced by that SecurityDomain, it is still possible in this mode to override the roles that will be assigned within the Servlet container.</p>
</div>
<div class="paragraph">
<p>The advantage of this mode is that ServerAuthModules are able to take advantage of the WildFly Elytron configuration for the loading of identities so identities stored in usual locations such as databases and LDAP can be loaded without the ServerAuthModule needing to be aware of these locations, additionally other WildFly Elytron configuration can be applied such as role and permission mapping.  The referenced SecurityDomain can also be referenced in other places such as for SASL authentication or other non JASPI applications all backed by a common repository of identities.</p>
</div>
<div class="paragraph">
<p>In this mode the CallbackHandlers operate as follows: -</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>PasswordValidationCallback</strong></p>
<div class="literalblock">
<div class="content">
<pre>The username and password will be used with the SecurityDomain to perform an authentication, if successful there is now an authenticated identity.</pre>
</div>
</div>
</li>
<li>
<p><strong>CallerPrincipalCallback</strong></p>
<div class="literalblock">
<div class="content">
<pre>This Callback is used to establish the authorized identity / the identity that will be seen once the request reached the web application.</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>If an authenticated identity has already been established via the PasswordValidationCallback this Callback is interpreted as a run-as request and authorization checks are performed to ensure the authenticated identity is authorized to run as the identity specified in this Callback.  If no authenticated identity has been established by a PasswordValidationCallback it is assumed the ServerAuthModule has handled the authentication step so this Callback will cause the specified identity to be loaded from the SecurityDomain and an authorization check to verify this identity has the LoginPermission.</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>If a Callback is received with a null Principal and name then if an authenticated identity has already been established authorization will be performed as that identity, if no identity has been established then authorization of the anonymous identity will be performed.  Where authorization of the anonymous identity is performed the SecurityDomain must have been configured to grant the anonymous identity the LoginPermission otherwise authorization will fail.</pre>
</div>
</div>
</li>
<li>
<p><strong>GroupPrincipalCallback</strong></p>
<div class="literalblock">
<div class="content">
<pre>By default in this mode the attribute loading, role decoding, and role mapping configured on the security domain will be used to establish the identity - if this Callback is received the groups specified will be taken as the roles that will be assigned to the identity whilst the request is in the servlet container.  These roles will be visible in the servlet container only.</pre>
</div>
</div>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_non_integrated"><a class="anchor" href="#_non_integrated"></a>8.4.3. Non Integrated</h4>
<div class="paragraph">
<p>When operating in non-integrated mode the ServerAuthModules are completely responsible for all authentication <strong>AND</strong> identity management, the Callbacks specified in the specification can be used to establish an identity.  The resulting identity will be created on the SecurityDomain but it will be independent of any identities stored in referenced SecurityRealms.</p>
</div>
<div class="paragraph">
<p>The advantage of this mode is that JASPI configurations that are able to 100% handle the identities can be deployed to the application server without requiring anything beyond a simple SecurityDomain definitions, there is no need for this SecurityDomain to actually contain the identities that will be used at runtime.  The disadvantage of this mode is that the ServerAuthModule is now reposible for all identity handling potenitally making the implementation much more complex.</p>
</div>
<div class="paragraph">
<p>In this mode the CallbackHandlers operate as follows: -</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>PasswordValidationCallback</strong></p>
<div class="literalblock">
<div class="content">
<pre>The Callback is not supported in this mode, the purpose of this mode is for the ServerAuthModule to operate independently of the referenced SecurityDomain so requesting a password to be validated would not be suitable.</pre>
</div>
</div>
</li>
<li>
<p><strong>CallerPrincipalCallback</strong></p>
<div class="literalblock">
<div class="content">
<pre>This Callback is used to establish the Principal for the resulting identity, as the ServerAuthModule is handling all of the identity checking requirements no checks are performed to verify if the identity exists in the security domain and no authorization checks are performed.</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>If a Callback is received with a null Principal and name then then the identity will be established as the anonymous identity, as the ServerAuthModule is making the decisions no authorizaton check will be performed with the SecurityDomain.</pre>
</div>
</div>
</li>
<li>
<p><strong>GroupPrincipalCallback</strong></p>
<div class="literalblock">
<div class="content">
<pre>As the identity is created in this mode without loading from the SecurityDomain it will by default have no roles assigned, if this Callback is received the groups will be taken and assigned to the resulting identity whilst the request is in the servlet container. These roles will be visible in the servlet container only.</pre>
</div>
</div>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_validaterequest"><a class="anchor" href="#_validaterequest"></a>8.4.4. validateRequest</h4>
<div class="paragraph">
<p>During the call to <code>validateRequest</code> on the <code>ServerAuthContext</code> the individual <code>ServerAuthModule</code> instances will be called in the order they are defined.  A control flag can also be specified for each module, this defines how the response should be interpreted and if processing should continue to the next auth module or return immediately.</p>
</div>
<div class="sect4">
<h5 id="_control_flags"><a class="anchor" href="#_control_flags"></a>Control Flags</h5>
<div class="paragraph">
<p>Where the configuration was provided either within the WildFly Elytron subsystem or using the <code>JaspiConfigurationBuilder</code> API it is possible to associate a control flag with each <code>ServerAuthModule</code> - if one is not specified we assume <code>REQUIRED</code>.  The flags have the following meanings depending on their result.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Flag</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>AuthStatus.SEND_SUCCESS</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>AuthStatus.SEND_FAILURE, AuthStatus.SEND_CONTINUE</strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Required</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Validation will continue to the remaining modules, provided the requirements of the remaining modules are satisfied the request will be allowed to proceed to authorization.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Validation will continue to the remaining modules, however regardless of their outcome the validation is not successful so control will return to the client.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Requisite</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Validation will continue to the remaining modules, provided the requirements of the remaining modules are satisfied the request will be allowed to proceed to authorization.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The request will return immediately to the client.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sufficient</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Validation is deemed successful and complete, provided no previous Required or Requisite module has returned an AuthStatus other than AuthStatus.SUCCESS the request will proceed to authorization of the secured resource.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Validation will continue down the list of remaining modules, this status will only affect the decision if there are no REQUIRED or REQUISITE modules.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Optional</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Validation will continue to the remaining modules, provided no 'Required' or 'Requisite' modules have not returned SUCCESS this will be sufficient for validation to be deemed successful and for the request to proceed to the authorization stage and the secured resource.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Validation will continue down the list of remaining modules, this status will only affect the decision if there are no REQUIRED or REQUISITE modules.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>For all <code>ServerAuthModule</code> instances if they throw an <code>AuthException</code> an error will be immediately reported to the client without further modules being called.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_secureresponse"><a class="anchor" href="#_secureresponse"></a>8.4.5. secureResponse</h4>
<div class="paragraph">
<p>During the call to <code>secureResponse</code> each <code>ServerAuthMdoule</code> is called but this time in reverse order.  Where a module only undertakes an action in <code>secureResponse</code> if it undertook an action in <code>validateResponse</code> it is the responsibility of the module to track this.</p>
</div>
<div class="paragraph">
<p>The control flag has no effect on <code>secureResponse</code> processing, processing ends when one of the following is true: -
. All of the <code>ServerAuthModule</code> instances have been called.
. A module returns <code>AuthStatus.SEND_FAILURE</code>.
. A module throws an <code>AuthException</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_securityidentity"><a class="anchor" href="#_securityidentity"></a>8.4.6. SecurityIdentity</h4>
<div class="paragraph">
<p>Once the authentication process has completed a <code>org.wildfly.security.auth.server.SecurityIdentity</code> for the deployments SecurityDomain will have been created as a result of the Callbacks to the CallbackHandler, depending on the Callbacks this will either be an identity loaded directly from the SecurityDomain or will be an ad-hoc identity described by the callbacks.  This SecurityIdentity will be associated with the request as we do for other authentication mechanisms</p>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="Elytron_and_Java_EE_Security"><a class="anchor" href="#Elytron_and_Java_EE_Security"></a>11. Elytron and Jakarta EE Security</h2>
<div class="sectionbody">
<div class="sect1">
<h2 id="_introduction_2"><a class="anchor" href="#_introduction_2"></a>10. Introduction</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Starting from WildFly 15 an implementation of the Servlet Profile from Java Authentication SPI for Containers (JSR-196 / JASPI) specification has been included in the application server, in addition to making JASPI available for deployments using WildFly Elytron it also makes it possible to make use of EE Security with WildFly Elytron.</p>
</div>
<div class="sect2">
<h3 id="_activation_2"><a class="anchor" href="#_activation_2"></a>10.1. Activation</h3>
<div class="paragraph">
<p>EE Security with WildFly Elytron is available out of the box with just a couple of small steps required.</p>
</div>
<div class="sect3">
<h4 id="_define_jacc_policy"><a class="anchor" href="#_define_jacc_policy"></a>10.1.1. Define JACC Policy</h4>
<div class="paragraph">
<p>The <code>SecurityContext</code> API makes use of JACC to access the current authenticated identity, if deployments are going to make use of this API then a JACC policy needs to be activated in the WildFly Elytron subsystem.  If this API is not being used then the activation can be skipped.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-ruby hljs" data-lang="ruby">/subsystem=security:write-attribute(name=initialize-jacc, value=false)
/subsystem=elytron/policy=jacc:add(jacc-policy={})
:reload</code></pre>
</div>
</div>
<div class="paragraph">
<p>As is shown in the example no specific configuration is required other than the presence of a default JACC policy, additionally after making these changes the server needs to be reloaded to ensure the new policy activates correctly.</p>
</div>
</div>
<div class="sect3">
<h4 id="_add_application_security_domain_mapping"><a class="anchor" href="#_add_application_security_domain_mapping"></a>10.1.2. Add <code>application-security-domain</code> mapping</h4>
<div class="paragraph">
<p>As with all deployments a mapping is required from the security domain defined for the deployment to either a WildFly Elytron security domain or http authentication factory to activate security backed by WildFly Elytron.</p>
</div>
<div class="paragraph">
<p>All web applications deployed to WildFly have a security domain which will be resolved in the following order: -</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>From the deployment descriptors / annotations of the deployment being deployed.</p>
</li>
<li>
<p>The value defined on the <code>default-security-domain</code> attribute on the Undertow subsystem.</p>
</li>
<li>
<p>Default to 'other'.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>An <code>application-security-domain</code> resource then needs to be added to map from the deployment&#8217;s security domain.</p>
</div>
<div class="paragraph">
<p>The simplest approach is to add a mapping for <code>other</code>, then no further configuration will be required and provided the deployment does not define it&#8217;s own security domain and provided no alternative default is specified all deployments will match this mapping.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-ruby hljs" data-lang="ruby">/subsystem=undertow/application-security-domain=other:add(security-domain=ApplicationDomain, integrated-jaspi=false)</code></pre>
</div>
</div>
<div class="paragraph">
<p>The EE Security API is built on JASPI.  Within JASPI we support two different modes of operation 'integrated', and 'non-integrated'.  In integrated mode any identity being established during authentication is expected to exist in the associated security domain.  With the EE Security APIs however it is quite likely an alternative store will be in use so configuration the mapping to use 'non-integrated' JASPI allows for identities to be dynamically created as required.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
References in this document to Java Authorization Contract for Containers (JACC) refer to the Jakarta Authorization unless otherwise noted
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="Keycloak_Integration"><a class="anchor" href="#Keycloak_Integration"></a>12. Using Keycloak with WildFly Elytron</h2>
<div class="sectionbody">
<div class="paragraph">
<p>When securing deployments using a Keycloak server a set of client side adapters provided by Keycloak need to be
installed to WildFly including a new subsystem to support configuring the client side adapters.  Depending on how
you are installing WildFly you have some different options available to install the adapters.</p>
</div>
<div class="sect2">
<h3 id="_zip_installation"><a class="anchor" href="#_zip_installation"></a>12.1. Zip Installation</h3>
<div class="paragraph">
<p>If you have installed a zip distribution of WildFly you can obtain a zip containing the Keycloak adapters directly
from the Keycloak project at
<a href="https://www.keycloak.org/docs/latest/securing_apps/index.html#_jboss_adapter">www.keycloak.org</a>.</p>
</div>
<div class="paragraph">
<p>Please follow the instructions at the previous link for the installation and configuration, these will guide you to
unzip the adapter distribution on top of your WildFly installation and to execute a CLI script to complete the set
up and define the Keycloak subsystem.</p>
</div>
</div>
<div class="sect2">
<h3 id="_galleon_installation"><a class="anchor" href="#_galleon_installation"></a>12.2. Galleon Installation</h3>
<div class="paragraph">
<p>The Keycloak project now also publishes a Galleon feature pack which can be used to install the Keycloak client
adapters onto a WildFly installation being maintained using Galleon.</p>
</div>
<div class="paragraph">
<p>More information can be found in the <a href="Galleon_Guide.html#Galleon_Guide" class="page">Provisioning WildFly with Galleon</a> documentation, but
assuming you have provisioned a WildFly installation containing the <code>web-server</code> layer with a command similar to
the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code>galleon.sh install wildfly:current \
    --layers=web-server --dir=wildfly</code></pre>
</div>
</div>
<div class="paragraph">
<p>The Keycloak adapters can be added to the WildFly installation with the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code>galleon.sh install org.keycloak:keycloak-adapter-galleon-pack:12.0.1 --layers=keycloak-client-oidc --dir=wildfly</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Unlike the WildFly feature pack the Keycloak feature pack is not part of a universe and so a fully
qualified <code>group:artifact:version</code> reference to the feature pack is required.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>From this point applications can be configured as described on
<a href="https://www.keycloak.org/docs/latest/securing_apps/index.html#_jboss_adapter">www.keycloak.org</a>
in exactly the same way as if you had used the zip approach to install WildFly and the adapters.</p>
</div>
</div>
<div class="sect2">
<h3 id="_bootable_jar"><a class="anchor" href="#_bootable_jar"></a>12.3. Bootable Jar</h3>
<div class="paragraph">
<p>The third installation option is if you are creating a bootable jar for your deployment and wish to add the Keycloak
client adapters to secure the deployment.  More details about bootable jar support can be found in the
<a href="Bootable_Guide.html#wildfly_bootable_JAR_development" class="page">Bootable JAR Guide</a>.</p>
</div>
<div class="paragraph">
<p>The following is an example plug-in configuration to create a bootable jar for a web application using both the
<code>web-server</code> and <code>keycloak-client-oidc</code> layers:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;plugin&gt;
    &lt;groupId&gt;org.wildfly.plugins&lt;/groupId&gt;
    &lt;artifactId&gt;wildfly-jar-maven-plugin&lt;/artifactId&gt;
    &lt;version&gt;${version.wildfly.jar.maven.plugin}&lt;/version&gt;
    &lt;configuration&gt;
        &lt;feature-packs&gt;
            &lt;feature-pack&gt;
                &lt;location&gt;wildfly@maven(org.jboss.universe:community-universe):current&lt;/location&gt;
            &lt;/feature-pack&gt;
            &lt;feature-pack&gt;
                &lt;groupId&gt;org.keycloak&lt;/groupId&gt;
                &lt;artifactId&gt;keycloak-adapter-galleon-pack&lt;/artifactId&gt;
                &lt;version&gt;12.0.1&lt;/version&gt;
            &lt;/feature-pack&gt;
        &lt;/feature-packs&gt;
        &lt;layers&gt;
            &lt;layer&gt;web-server&lt;/layer&gt;
            &lt;layer&gt;keycloak-client-oidc&lt;/layer&gt;
        &lt;/layers&gt;
        &lt;context-root&gt;simple-webapp&lt;/context-root&gt;
        &lt;cli-sessions&gt;
            &lt;cli-session&gt;
                &lt;script-files&gt;
                    &lt;script&gt;configure-oidc.cli&lt;/script&gt;
                &lt;/script-files&gt;
            &lt;/cli-session&gt;
        &lt;/cli-sessions&gt;
    &lt;/configuration&gt;
    &lt;executions&gt;
        &lt;execution&gt;
            &lt;goals&gt;
                &lt;goal&gt;package&lt;/goal&gt;
            &lt;/goals&gt;
        &lt;/execution&gt;
    &lt;/executions&gt;
&lt;/plugin&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>A couple of points are worth mentioning here, as with using the CLI the latest version of WildFly in the universe can be
dynamically selected but the Keycloak feature pack requires the complete <code>groupId</code>, <code>artifactId</code>, and <code>version</code> to be
specified.</p>
</div>
<div class="paragraph">
<p>The approaches to configure the web application are the same as described at
<a href="https://www.keycloak.org/docs/latest/securing_apps/index.html#_jboss_adapter">www.keycloak.org</a>.  In this example a CLI script
<code>configure-oidc.cli</code> is executed to update the Keycloak subsystem with the relevent configuration.</p>
</div>
<div class="paragraph">
<p>The contents of this script are:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code>/subsystem=keycloak/secure-deployment=simple-webapp.war:add( \
    realm=WildFly, \
    resource=simple-webapp, \
    public-client=true, \
    auth-server-url=http://localhost:8080/auth/, \
    ssl-required=EXTERNAL)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Alternatively the <code>auth-method</code> of the web application could have been set to <code>KEYCLOAK</code> and adapter configuration
provided in <code>keycloak.json</code> descriptor placed within the <code>WEB-INF</code> directory of the deployment.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="Bearer_Token_Authorization"><a class="anchor" href="#Bearer_Token_Authorization"></a>13. Bearer Token Authorization</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Bearer Token Authorization is the process of authorizing HTTP requests based on the existence and validity of a bearer
token representing a subject and his access context, where the token provides valuable information to determine the subject of the call as well whether or not a HTTP resource
can be accessed.</p>
</div>
<div class="paragraph">
<p>Elytron supports bearer token authorization by providing a <code>BEARER_TOKEN</code> HTTP authentication mechanism based on <a href="https://tools.ietf.org/html/rfc6750">RFC-6750</a> and
an specific <code>realm</code> implementation, the <code>token-realm</code>, to validate tokens using the JWT format (for instance, OpenID Connect ID Tokens) or opaque tokens issued by any OAuth2 compliant
authorization server.</p>
</div>
<div class="sect2">
<h3 id="_how_it_works"><a class="anchor" href="#_how_it_works"></a>13.1. How it Works</h3>
<div class="paragraph">
<p>When a HTTP request arrives to your application, the <code>BEARER_TOKEN</code> mechanism will check if a bearer token was provided by checking the existence of an <code>Authorization</code> HTTP header with the following format:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">GET /resource HTTP/1.1
Host: server.example.com
Authorization: Bearer mF_9.B5f-4.1JqM</code></pre>
</div>
</div>
<div class="paragraph">
<p>If no bearer token was provided, the mechanism will respond with a <code>401</code> HTTP status code as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">HTTP/1.1 401 Unauthorized
WWW-Authenticate: Bearer realm="example"</code></pre>
</div>
</div>
<div class="paragraph">
<p>When a bearer token is provided, the mechanism will extract the token from the request (in the example above, the token is represented by the string <code>mF_9.B5f-4.1JqM</code>) and pass it over
to the <code>token-realm</code> in order to check if the token is valid and can be used to build a security context based on its information. Note that the <code>BEARER_TOKEN</code> mechanism is only responsible to
check and extract bearer tokens from an HTTP request, whereas the <code>token-realm</code> is the one responsible for validating the token.</p>
</div>
<div class="paragraph">
<p>If validation succeeds, a security context will be created based on the information represented by the token and the application can use the newly created
security context to obtain information about the subject making the request as well decide whether or not the request should be full filled. In case the validation fails,
the mechanism will respond with a <code>403</code> HTTP status code as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">HTTP/1.1 403 Forbidden</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_validating_jwt_tokens"><a class="anchor" href="#_validating_jwt_tokens"></a>13.2. Validating JWT Tokens</h3>
<div class="paragraph">
<p>Elytron provides built-in support for JWT tokens, which can be enabled by defining a <code>realm</code> in the Elytron subsystem as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml"> &lt;token-realm name="JwtRealm" principal-claim="sub"&gt;
    &lt;jwt issuer="as.example.com"
         audience="api.example.com"
         public-key="-----BEGIN PUBLIC KEY-----MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQCqGKukO1De7zhZj6+H0qtjTkVxwTCpvKe4eCZ0FPqri0cb2JZfXJ/DgYSF6vUpwmJG8wVQZKjeGcjDOL5UlsuusFncCzWBQ7RKNUSesmQRMSGkVb1/3j+skZ6UtW+5u09lHNsj6tQ51s1SPrCBkedbNf0Tp0GbMJDyR4e9T04ZZwIDAQAB-----END PUBLIC KEY-----"/&gt;
 &lt;/token-realm&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the example above, the <code>token-realm</code> is defined with a <code>principal-claim</code> attribute. This attribute specifies which claim
within the token should be used to identity the principal. If you have a token as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json"> {
   "iss": "as.example.com",
   "sub": "24400320",
   "aud": "s6BhdRkqt3",
   "exp": 1311281970,
   "nbf": 1311280970,
  }</code></pre>
</div>
</div>
<div class="paragraph">
<p>Elytron will use the value associated with the <code>sub</code> claim as the identifier of the subject represented by the token.</p>
</div>
<div class="paragraph">
<p>The <code>jwt</code> element within the <code>token-realm</code> specifies that tokens should be validated as JWT and provides different configuration options on how they
should be validated:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>issuer</strong></p>
<div class="paragraph">
<p>A list of strings representing the issuers supported by this configuration. During validation JWT tokens must have an "iss" claim that contains one of the values defined here</p>
</div>
</li>
<li>
<p><strong>audience</strong></p>
<div class="paragraph">
<p>A list of strings representing the audiences supported by this configuration. During validation JWT tokens must have an "aud" claim that contains one of the values defined here</p>
</div>
</li>
<li>
<p><strong>public-key</strong></p>
<div class="paragraph">
<p>A public key in PEM Format. During validation, if a public key is provided, signature will be verified based on the key you provided here. Alternatively,
you can define a <code>key-store</code> and <code>certificate</code> attributes to configure the public key. This key will be used to verify tokens without "kid" claim.</p>
</div>
</li>
<li>
<p><strong>key-store</strong></p>
<div class="paragraph">
<p>As an alternative to <code>public-key</code>, you can also define a key store from where the certificate with a public key should be loaded from</p>
</div>
</li>
<li>
<p><strong>certificate</strong></p>
<div class="paragraph">
<p>The name of the certificate with a public key to load from the key store in case you defined the <code>key-store</code> attribute</p>
</div>
</li>
<li>
<p><strong>client-ssl-context</strong></p>
<div class="paragraph">
<p>The SSL context to be used if if you want to use remote JSON Web Keys. This enables you to use url from "jku" token claim to
fetch public keys for token verification.</p>
</div>
</li>
<li>
<p><strong>host-name-verification-policy</strong></p>
<div class="paragraph">
<p>A policy that defines how host names should be verified when using remote JSON Web Keys. Allowed values: "ANY", "DEFAULT".</p>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>For being able to use different key pairs for signing / verification and for easier key rotation you can define key map. This will take the "kid" claim
from the token and use corresponding public key for verification.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml"> &lt;token-realm name="JwtRealm" principal-claim="sub"&gt;
    &lt;jwt issuer="as.example.com" audience="api.example.com"&gt;
        &lt;key kid="1" public-key="-----BEGIN PUBLIC KEY-----MFwwDQYJKoZIhvcNAQEBBQADSwAwSAJBANc4VlnN6oZwe1PoQQeJsTwu7LGS+eEbgYMNYXahidga4+BhdGKwzMZU54ABFQ11tUMJSENQ6o3n1YKVgMnxvcMCAwEAAQ==-----END PUBLIC KEY-----"/&gt;
        &lt;key kid="2" public-key="-----BEGIN PUBLIC KEY-----MFswDQYJKoZIhvcNAQEBBQADSgAwRwJAcNpXy6psxC21DdnTtAdlgsEwEuJh/earH3q7xJPjmsygmrlpC66MG4/A/J9Gai2Hp+QdCSEVpBWkIoVff3sIlwIDAQAB-----END PUBLIC KEY-----"/&gt;
    &lt;/jwt&gt;
 &lt;/token-realm&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>This <code>token-realm</code> will verify tokens with "kid" claims of value "1" or "2" using corresponding key.</p>
</div>
<div class="paragraph">
<p>Tokens without "kid" claim will be verified using the 'public-key' attribute of 'jwt', or in this case invalidated, as there is
no key specified.</p>
</div>
<div class="paragraph">
<p>The <code>jwt</code> validator performs different checks in order to determine the validity of a JWT:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Expiration checks based on the values of the <code>exp</code> and <code>nbf</code> claims</p>
</li>
<li>
<p>Signature checks based on the public key provided via <code>public-key</code> or <code>certificate</code> attributes, key map with named public keys, or by fetching remote JSON Web Key Set
using provided <code>client-ssl-context</code>. You can skip token signature verification by not defining any of these.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>It is strongly recommended that you use signed JWTs in order to guarantee authenticity of tokens and make sure they were not tampered.</p>
</div>
</div>
<div class="sect2">
<h3 id="_validating_oauth2_bearer_tokens"><a class="anchor" href="#_validating_oauth2_bearer_tokens"></a>13.3. Validating OAuth2 Bearer Tokens</h3>
<div class="paragraph">
<p>Elytron provides built-in support for tokens issued by an OAuth2 compliant authorization server, where these tokens are validated
using a token introspection endpoint as defined by OAuth2 specification.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;token-realm name="OAuth2Realm" principal-claim="sub"&gt;
    &lt;oauth2-introspection client-id="my-client-id"
                          client-secret="keep_it_secret"
                          introspection-url="https://as.example.com/token/introspect"
                          client-ssl-context="user-defined-ssl-context"
                          host-name-verification-policy="ANY" /&gt;
&lt;/token-realm&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>auth2-introspection</code> element within the <code>token-realm</code> specifies that tokens should be validated using an OAuth2 Token Introspection Endpoint and provides different configuration options on how they
should be validated:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>client-id</strong></p>
<div class="paragraph">
<p>The identifier of the client on the OAuth2 Authorization Server</p>
</div>
</li>
<li>
<p><strong>client-secret</strong></p>
<div class="paragraph">
<p>The secret of the client</p>
</div>
</li>
<li>
<p><strong>introspection-url</strong></p>
<div class="paragraph">
<p>The URL of token introspection endpoint</p>
</div>
</li>
<li>
<p><strong>client-ssl-context</strong></p>
<div class="paragraph">
<p>The SSL context to be used if the introspection endpoint is using HTTPS.</p>
</div>
</li>
<li>
<p><strong>host-name-verification-policy</strong></p>
<div class="paragraph">
<p>A policy that defines how host names should be verified when using HTTPS. Allowed values: "ANY", "DEFAULT".</p>
</div>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_quickstarts"><a class="anchor" href="#_quickstarts"></a>13.4. Quickstarts</h3>
<div class="ulist">
<ul>
<li>
<p><a href="https://github.com/wildfly/quickstart/tree/master/jaxrs-jwt">Jakarta RESTful Web Services secured using JSON Web Tokens</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_cli_examples_on_how_to_create_a_token_realm"><a class="anchor" href="#_cli_examples_on_how_to_create_a_token_realm"></a>13.5. CLI Examples on How to Create a Token Realm</h3>
<div class="listingblock">
<div class="title">Create a Token Realm to validate JWT tokens using a key store to retrieve the public key</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash"># Create a Key Store
/subsystem=elytron/key-store=my-keystore:add(path=/path/to/keystore.jks,credential-reference={clear-text=secret},type=JKS)

# Create the realm
/subsystem=elytron/token-realm=jwt-realm:add(principal-claim=sub, jwt={issuer=["as.example.com"], audience=["api.example.com"], key-store=my-keystore, certificate=as.example.com})</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Create a Token Realm to validate OAuth2 tokens</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash"># Create a Client SSLContext
/subsystem=elytron/key-store=default-trust-store:add(path=/path/to/keystore.jks,credential-reference={clear-text=secret},type=JKS)
/subsystem=elytron/trust-manager=default-trust-manager:add(algorithm=PKIX, key-store=default-trust-store)
/subsystem=elytron/client-ssl-context=default-client-ssl-context:add(trust-manager=default-trust-manager)

# Create the realm
/subsystem=elytron/token-realm=oauth2-realm:add(principal-claim=preferred_username, oauth2-introspection={client-id=my-client-id, client-secret=keep_it_secret, client-ssl-context=default-client-ssl-context, introspection-url=https://as.example.com/token/introspect})</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="OpenSSL"><a class="anchor" href="#OpenSSL"></a>14. OpenSSL</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_configuring_wildfly_to_use_the_openssl_tls_provider"><a class="anchor" href="#_configuring_wildfly_to_use_the_openssl_tls_provider"></a>14.1. Configuring WildFly to use the OpenSSL TLS provider</h3>
<div class="paragraph">
<p>There are a couple ways you can configure WildFly to use the OpenSSL TLS provider.</p>
</div>
<div class="sect3">
<h4 id="_configure_the_elytron_subsystem_to_use_the_openssl_tls_provider_by_default"><a class="anchor" href="#_configure_the_elytron_subsystem_to_use_the_openssl_tls_provider_by_default"></a>14.1.1. Configure the Elytron subsystem to use the OpenSSL TLS provider by default</h4>
<div class="paragraph">
<p>The following commands can be used to configure the Elytron subsystem so that the OpenSSL TLS
provider is used by default:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=elytron:write-attribute(name=initial-providers, value=combined-providers)
/subsystem=elytron:undefine-attribute(name=final-providers)
reload</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_configure_the_openssl_tls_provider_on_an_ssl_context"><a class="anchor" href="#_configure_the_openssl_tls_provider_on_an_ssl_context"></a>14.1.2. Configure the OpenSSL TLS provider on an SSL context</h4>
<div class="paragraph">
<p>Instead of configuring the Elytron subsystem to use the OpenSSL TLS provider by default,
it is also possible to specify that the OpenSSL TLS provider should be used for a specific
SSL context. For example, the following command can be used to create a <code>server-ssl-context</code>
that will use the OpenSSL TLS provider:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=elytron/server-ssl-context=httpsSSC:add(providers=openssl, ...)
reload</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_openssl_library_location"><a class="anchor" href="#_openssl_library_location"></a>14.2. OpenSSL Library Location</h3>
<div class="paragraph">
<p>WildFly will search for the OpenSSL library using the standard system library search path. If you&#8217;d like to specify a
custom location for the OpenSSL library, the <code>org.wildfly.openssl.path</code> property can be specified during WildFly startup.</p>
</div>
<div class="paragraph">
<p>If OpenSSL was loaded successfully, a message similar to the one below will occur in the <code>server.log</code> file on startup:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>15:37:59,814 INFO [org.wildfly.openssl.SSL] (MSC service thread 1-7) WFOPENSSL0002 OpenSSL Version OpenSSL 1.1.1d FIPS  10 Sep 2019</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_enabling_tlsv1_3"><a class="anchor" href="#_enabling_tlsv1_3"></a>14.3. Enabling TLSv1.3</h3>
<div class="paragraph">
<p><strong>WARNING</strong> It is possible to use TLSv1.3 with the OpenSSL TLS provider when using OpenSSL 1.1.1 or higher and
when running against JDK 11 or higher. However, if JDK 11 is in use and if there is a very large number of
TLSv1.3 requests being made, it is possible that a drop in performance (throughput and response time) will occur
compared to TLSv1.2. For this reason, the use of TLSv1.3 is currently disabled by default. TLSv1.3 can be enabled
by configuring the <code>cipher-suite-names</code> attribute for an SSL context. See the sections on
<a href="#configuring-a-server-sslcontext">Configuring a server SSLContext</a> and
<a href="#configuring-a-client-sslcontext">Configuring a client SSLContext</a> for more details. It is recommended to test
for performance degradation prior to enabling TLSv1.3 in a production environment.</p>
</div>
</div>
<div class="sect2">
<h3 id="_adding_additional_native_libraries"><a class="anchor" href="#_adding_additional_native_libraries"></a>14.4. Adding Additional Native Libraries</h3>
<div class="paragraph">
<p>By default, WildFly includes WildFly OpenSSL native libraries for commonly used platforms (Linux x86_64, Windows x86_64,
Mac OS X x86_64, and Linux s390). However, the <a href="https://github.com/wildfly-security/wildfly-openssl-natives">WildFly OpenSSL Natives project</a>
contains modules that can be used to build WildFly OpenSSL native libraries for other platforms as well. The steps needed to build and make
use of a WildFly OpenSSL native library for a different platform than the ones provided by default will be described below.</p>
</div>
<div class="sect3">
<h4 id="_building_the_native_library"><a class="anchor" href="#_building_the_native_library"></a>14.4.1. Building the Native Library</h4>
<div class="paragraph">
<p>Make sure you have cloned the <a href="https://github.com/wildfly-security/wildfly-openssl-natives">WildFly OpenSSL Natives</a> project
locally. We&#8217;ll use <code>$WILDFLY_OPENSSL_NATIVES</code> to denote the path to this project. Next, <code>cd</code> to the module that you want
to build. In this example, we&#8217;ll use the <code>linux-i386</code> module but similar steps can be used to build and make use of another
module instead.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">cd $WILDFLY_OPENSSL_NATIVES/linux-i386
mvn clean install</code></pre>
</div>
</div>
<div class="paragraph">
<p>Notice that this now results in a <code>wildfly-openssl-linux-i386-VERSION.jar</code> in the <code>$WILDFLY_OPENSSL_NATIVES/linux-i386/target</code> directory.
We&#8217;ll make use of this in the next step.</p>
</div>
</div>
<div class="sect3">
<h4 id="_overriding_the_existing_wildfly_openssl_module"><a class="anchor" href="#_overriding_the_existing_wildfly_openssl_module"></a>14.4.2. Overriding the Existing WildFly OpenSSL Module</h4>
<div class="paragraph">
<p>We&#8217;re going to add a new module that will override the existing WildFly OpenSSL module that&#8217;s found in the
<code>$WILDFLY_HOME/modules/system/layers/base/org/wildfly/openssl</code> directory. Notice that the existing module
contains a Java artifact in its <code>main</code> directory and native libraries for the default platforms in its
<code>main/lib</code> directory.</p>
</div>
<div class="paragraph">
<p>First, create a new module that contains the WildFly OpenSSL Java artifact from the existing module:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">module add --name=org.wildfly.openssl --resources=$WILDFLY_HOME/modules/system/layers/base/org/wildfly/openssl/main/wildfly-openssl-java-VERSION.jar --dependencies=java.logging,jdk.unsupported</code></pre>
</div>
</div>
<div class="paragraph">
<p>Next, add the native library that we already built to this newly created module:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">mkdir $WILDFLY_HOME/modules/org/wildfly/openssl/main/lib
cd $WILDFLY_HOME/modules/org/wildfly/openssl/main/lib
jar xvf $WILDFLY_OPENSSL_NATIVES/linux-i386/target/wildfly-openssl-linux-i386-VERSION.jar linux-i386</code></pre>
</div>
</div>
<div class="paragraph">
<p>You should now see a <code>libwfssl.so</code> file in the <code>$WILDFLY_HOME/modules/org/wildfly/openssl/main/lib/linux-i386</code> directory.</p>
</div>
<div class="paragraph">
<p>That&#8217;s it, WildFly will now make use of the newly added WildFly OpenSSL module instead of the existing one,
allowing it to make use of the new native library when running on the Linux i386 platform. Additional
native libraries can be added to the <code>$WILDFLY_HOME/modules/org/wildfly/openssl/main/lib</code> directory
if desired.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="Web_Single_Sign_On"><a class="anchor" href="#Web_Single_Sign_On"></a>15. Web Single Sign-On</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This document will guide on how to enable single sign-on across different applications deployed into different servers, where these applications belong to same security domain.</p>
</div>
<div class="sect2">
<h3 id="_create_a_server_configuration_template"><a class="anchor" href="#_create_a_server_configuration_template"></a>15.1. Create a Server Configuration Template</h3>
<div class="paragraph">
<p>For this document, you&#8217;ll need to run at least two server instances in order to check single sign-on and how it affect usability in your applications. Users should be able to log in once and have access to any application using the same security domain.</p>
</div>
<div class="paragraph">
<p>All configuration described in the next sections should be done with a server instance using <strong>standalone-ha.xml</strong> (or standalone-full-ha.xml).</p>
</div>
<div class="paragraph">
<p>Run a server instance using the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>bin/standalone.sh -c standalone-ha.xml</pre>
</div>
</div>
<div class="sect3">
<h4 id="_create_a_http_authentication_factory"><a class="anchor" href="#_create_a_http_authentication_factory"></a>15.1.1. Create a HTTP Authentication Factory</h4>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
If you already have a <em>http-authentication-factory</em>&nbsp;defined in Elytron subsystem and just want to use it to enable single sign-on to your applications, please skip this section.{info}
First, you need a <em>security-domain</em> which we&#8217;ll use to authenticate users. Please, execute the following CLI commands:
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre># Creates a FileSystem Realm, an identity store where users are stored in the local filesystem
/subsystem=elytron/filesystem-realm=example-realm:add(path=/tmp/example-realm)

# Creates a Security Domain
/subsystem=elytron/security-domain=example-domain:add(default-realm=example-realm, permission-mapper=default-permission-mapper,realms=[{realm=example-realm, role-decoder=groups-to-roles}]

# Creates an user that you can use to access your applications
/subsystem=elytron/filesystem-realm=example-realm:add-identity(identity=alice)
/subsystem=elytron/filesystem-realm=example-realm:add-identity-attribute(identity=alice, name=groups, value=["user"])
/subsystem=elytron/filesystem-realm=example-realm:set-password(identity=alice, clear={password=alice})</pre>
</div>
</div>
<div class="paragraph">
<p>Now you can create a <em>http-authentication-factory</em> that you&#8217;ll use to actually protect your web applications using Undertow:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code># Create a Http Authentication Factory
/subsystem=elytron/http-authentication-factory=example-http-authentication:add(security-domain=example-domain, http-server-mechanism-factory=global, mechanism-configurations=[{mechanism-name=FORM}]</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_create_a_application_security_domain_in_undertow"><a class="anchor" href="#_create_a_application_security_domain_in_undertow"></a>15.1.2. Create a Application Security Domain in Undertow</h4>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
If you already have a&nbsp;_application-security-domain_&nbsp;defined in Undertow subsystem and just want to use it to enable single sign-on to your applications, please skip this section.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In order to protect applications using the configuration defined in Elytron subsystem, you should create a application-security-domain definition in Undertow subsystem as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>/subsystem=undertow/application-security-domain=other:add(http-authentication-factory=example-http-authentication)</pre>
</div>
</div>
<div class="paragraph">
<p>By default, if your application does not define any specific <em>security-domain</em> in <em>jboss-web.xml</em>, the application server will choose one with a name <strong>other</strong>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_create_a_key_store"><a class="anchor" href="#_create_a_key_store"></a>15.1.3. Create a Key Store</h4>
<div class="paragraph">
<p>In order to create a <em>key-store</em> in Elytron subsystem, first create a Java Key Store as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>keytool -genkeypair -alias localhost -keyalg RSA -keysize 1024 -validity 365 -keystore keystore.jks -dname "CN=localhost" -keypass secret -storepass secret</code></pre>
</div>
</div>
<div class="paragraph">
<p>Once the <em>keystore.jks</em> file is created, execute the following CLI commands to create a <em>key-store</em> definition in Elytron:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=elytron/key-store=example-keystore:add(path=keystore.jks, relative-to=jboss.server.config.dir, credential-reference={clear-text=secret}, type=JKS)</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_enable_single_sign_on"><a class="anchor" href="#_enable_single_sign_on"></a>15.1.4. Enable Single Sign-On</h4>
<div class="paragraph">
<p>Single Sign-On is enabled to a specific <em>application-security-domain</em> definition in Undertow subsystem. It is important that the servers you will be using to deploy applications are using the same configuration.</p>
</div>
<div class="paragraph">
<p>To enable single-sign on, just change an existing application-security-domain in Undertow subsystem as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=undertow/application-security-domain=other/setting=single-sign-on:add(key-store=example-keystore, key-alias=localhost, domain=localhost, credential-reference={clear-text=secret})</code></pre>
</div>
</div>
<div class="paragraph">
<p>After restarting the servers, users should be able to log in once and have access to any application using the same <em>application-security-domain</em>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_create_two_server_instances"><a class="anchor" href="#_create_two_server_instances"></a>15.2. Create Two Server Instances</h3>
<div class="paragraph">
<p>All configuration you did so far should be reflected in <em>$JBOSS_HOME</em>/<em>standalone/standalone-ha.xml.</em> You can now create two distinct server configuration directories_:\_</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>cp -r standalone standalone-a
cp -r standalone standalone-b</code></pre>
</div>
</div>
<div class="paragraph">
<p>And you can run the two instances using the command below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$JBOSS_HOME/bin/standalone.sh -c standalone-ha.xml -Djboss.node.name=node-a -Djboss.socket.binding.port-offset=200 -Djboss.server.base.dir=$JBOSS_HOME/standalone-a
$JBOSS_HOME/bin/standalone.sh -c standalone-ha.xml -Djboss.node.name=node-b -Djboss.socket.binding.port-offset=300 -Djboss.server.base.dir=$JBOSS_HOME/standalone-b ----</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_deploy_an_application"><a class="anchor" href="#_deploy_an_application"></a>15.3. Deploy an Application</h3>
<div class="paragraph">
<p>For the sake of simplicity, these are the minimum files you need in your application:</p>
</div>
<div class="listingblock">
<div class="title">WEB-INF/web.xml</div>
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;web-app version="3.1" xmlns="http://xmlns.jcp.org/xml/ns/javaee"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://xmlns.jcp.org/xml/ns/javaee http://xmlns.jcp.org/xml/ns/javaee/web-app_3_1.xsd"&gt;

    &lt;security-constraint&gt;
        &lt;display-name&gt;SecurityConstraint&lt;/display-name&gt;
        &lt;web-resource-collection&gt;
            &lt;web-resource-name&gt;All Resources&lt;/web-resource-name&gt;
            &lt;url-pattern&gt;/*&lt;/url-pattern&gt;
        &lt;/web-resource-collection&gt;
        &lt;auth-constraint&gt;
            &lt;role-name&gt;user&lt;/role-name&gt;
        &lt;/auth-constraint&gt;
    &lt;/security-constraint&gt;

    &lt;login-config&gt;
        &lt;auth-method&gt;FORM&lt;/auth-method&gt;
        &lt;form-login-config&gt;
            &lt;form-login-page&gt;/login.html&lt;/form-login-page&gt;
            &lt;form-error-page&gt;/login.html&lt;/form-error-page&gt;
        &lt;/form-login-config&gt;
    &lt;/login-config&gt;

    &lt;security-role&gt;
        &lt;role-name&gt;user&lt;/role-name&gt;
    &lt;/security-role&gt;
&lt;/web-app&gt;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">login.html</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-html hljs" data-lang="html">&lt;html&gt;
    &lt;body&gt;
        &lt;form method="post" action="j_security_check"&gt;
            &lt;input type="text" name="j_username"&gt;
            &lt;input type="password" name="j_password"&gt;
            &lt;input type="submit" value="Log In"&gt;
        &lt;/form&gt;
    &lt;/body&gt;
&lt;/html&gt;</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Make sure you have at least a welcome file (e.g.: index.html\|jsp).
</td>
</tr>
</table>
</div>
<div class="openblock">
<div class="content">
<div class="paragraph">
<p>Deploy your application into both server instances and try to log in using the user you created at the beginning of this document:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Username: <strong>alice</strong></p>
</li>
<li>
<p>Password: <strong>alice</strong></p>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="Audit"><a class="anchor" href="#Audit"></a>16. Audit</h2>
<div class="sectionbody">
<div class="paragraph">
<p>WildFly Elytron supports audit using security event listeners - components
which captures security events, like successful or unsuccessful login attempts.</p>
</div>
<div class="sect2">
<h3 id="_file_audit_log"><a class="anchor" href="#_file_audit_log"></a>16.1. File audit log</h3>
<div class="paragraph">
<p>File audit log logs security events into a local file.
It requires to define <code>path</code> to the log file, which can be <code>relative-to</code> a system property.
It also allows to set the file format - human readable <code>SIMPLE</code> or <code>JSON</code>.
While in WildFly 14 there was only one attribute <code>synchronized</code>, which had influence on data reliability, now there is possible more fine grained performance and reliability tunning:
* <code>autoflush</code> defines whether should be output stream flushed after every audit event (guarantees that the log message is passed to the operating system immediately)
* <code>synchonized</code> defines whether should be file descriptor synchronized after every audit event (guarantees that all system buffers are synchronized with the underlying device)</p>
</div>
</div>
<div class="sect2">
<h3 id="_syslog_audit_logging"><a class="anchor" href="#_syslog_audit_logging"></a>16.2. Syslog Audit Logging</h3>
<div class="paragraph">
<p>Syslog audit logging logs security events to a syslog server using a transmission protocol.
WildFly Elytron supports using UDP, TCP, or TCP with SSL, with the latter protocol requiring
a <code><code>SSLContext</code></code> to be defined. When syslog audit logging is first defined, Elytron will send
an <code><code>INFORMATIONAL</code></code> priority event to the defined syslog server containing the message
"Elytron audit logging enabled with RFC format: &lt;format&gt;", where <code><code>&lt;format&gt;</code></code> is the
RFC format that the audit logging handler has been defined with, defaulting to <code><code>RFC5424</code></code>.
If the given syslog server is not defined, resulting in Elytron being unable to send the
message, then Elytron will keep track of the amount of attempts that sending a message has
failed, up to a maximum defined by the <code><code>reconnect-attempts</code></code> parameter, before
closing the endpoint and reporting an error. It is possible to define this value
as infinite, by specifying <code><code>-1</code></code>, in which case Elytron will never close the
endpoint and so will always attempt to send audit messages despite previous failures.</p>
</div>
<div class="sect3">
<h4 id="_required_parameters"><a class="anchor" href="#_required_parameters"></a>16.2.1. Required Parameters</h4>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 30%;">
<col style="width: 70%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Parameter</th>
<th class="tableblock halign-left valign-top">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code><code>server-address</code></code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String consisting of the IP address, or a name recognized by Java&#8217;s InetAddress.getByName(), of the syslog server</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code><code>port</code></code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code><code>int</code></code> of the listening port on the syslog server</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code><code>host-name</code></code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String of the host name that will be embedded into all events sent to the syslog server</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code><code>ssl-context</code></code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The <code><code>SSLContext</code></code> used to connect to the syslog server, only required if <code><code>transport</code></code> is set to <code><code>SSL_TCP</code></code></p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="_optional_parameters"><a class="anchor" href="#_optional_parameters"></a>16.2.2. Optional Parameters</h4>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 10%;">
<col style="width: 60%;">
<col style="width: 20%;">
<col style="width: 10%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Parameter</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Possible Values</th>
<th class="tableblock halign-left valign-top">Default Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code><code>transport</code></code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The transport protocol to be used to connect to the syslog server</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String of: <code><code>UDP</code></code>, <code><code>TCP</code></code>, or <code><code>SSL_TCP</code></code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code><code>TCP</code></code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code><code>format</code></code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The format that audit events should be recorded in</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String of <code><code>SIMPLE</code></code> or <code><code>JSON</code></code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code><code>SIMPLE</code></code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code><code>syslog-format</code></code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The RFC format to be used for describing the audit event</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String of <code><code>RFC5424</code></code> or <code><code>RFC3164</code></code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code><code>RFC5424</code></code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code><code>reconnect-attempts</code></code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The maximum number of times that elytron will attempt to send successive messages to a syslog server before closing the endpoint to disallow further attempts to send messages.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code><code>int</code></code> of <code><code>-1</code></code> (infinite attempts) or higher</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code><code>0</code></code></p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="_defining_syslog_audit_logging"><a class="anchor" href="#_defining_syslog_audit_logging"></a>16.2.3. Defining Syslog Audit Logging</h4>
<div class="paragraph">
<p>Syslog audit logging can be defined under the <code><code>elytron</code></code> subsystem resource. Some
examples syslog audit logging resources can be created with the following commands:</p>
</div>
<div class="sect4">
<h5 id="_minimum_resource_definition"><a class="anchor" href="#_minimum_resource_definition"></a>Minimum Resource Definition</h5>
<div class="paragraph">
<p>Using the following command will generate a syslog audit logging resource that connects with
TCP, records audit events in a simple format, and uses RFC5424 to describe the audit event.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=elytron/syslog-audit-log=syslog-example:add(
    server-address=127.0.0.1,
    port=10857,
    host-name=localhost
)</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_default_format_and_reconnect_attempts_with_udp_and_rfc3164"><a class="anchor" href="#_default_format_and_reconnect_attempts_with_udp_and_rfc3164"></a>Default Format and Reconnect Attempts with UDP and RFC3164</h5>
<div class="paragraph">
<p>Using the following command will generate a syslog audit logging resource that connects with
UDP, does not send any further messages to the syslog server if there is an error sending,
records audit events in a simple format, and uses RFC3164 to describe the audit event.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=elytron/syslog-audit-log=syslog-example:add(
    server-address=127.0.0.1,
    port=10837,
    host-name=localhost,
    transport=UDP,
    syslog-format=RFC3164
)</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_full_udp_definition_with_rfc5424_explicitly_set_and_10_reconnect_attempts"><a class="anchor" href="#_full_udp_definition_with_rfc5424_explicitly_set_and_10_reconnect_attempts"></a>Full UDP Definition with RFC5424 Explicitly Set and 10 Reconnect Attempts</h5>
<div class="paragraph">
<p>Using the following command will generate a syslog audit logging resource that connects with
UDP, attempts to send messages 10 times if there is an error sending before no longer sending messages,
records audit events in a simple format, and uses RFC5424 to describe the audit event.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=elytron/syslog-audit-log=syslog-example:add(
    server-address=127.0.0.1,
    port=10837,
    host-name=localhost,
    transport=UDP,
    syslog-format=RFC5424,
    reconnect-attempts=10
)</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_full_udp_definition_with_infinite_reconnect_attempts_and_json_format"><a class="anchor" href="#_full_udp_definition_with_infinite_reconnect_attempts_and_json_format"></a>Full UDP Definition with Infinite Reconnect Attempts and JSON Format</h5>
<div class="paragraph">
<p>Using the following command will generate a syslog audit logging resource that connects with
UDP, always attempts to send messages despite previous failures sending messages, records audit
events in a JSON format, and uses RFC5424 to describe the audit event.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=elytron/syslog-audit-log=syslog-example:add(
    server-address=127.0.0.1,
    port=10837,
    host-name=localhost,
    transport=UDP,
    format=JSON,
    reconnect-attempts=-1
)</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="CredentialStore"><a class="anchor" href="#CredentialStore"></a>17. Credential Store</h2>
<div class="sectionbody">
<div class="paragraph">
<p>One new component included with WildFly Elytron for the secure storage of credentials is the Credential Store.  Previous versions of the application server made use of the Vault which was used for the secure storage of clear text strings; the credential store moves forward a step to focus on the secure storage of credentials.  As with the Vault the stored credentials could be clear text passwords however other formats are also supported.</p>
</div>
<div class="paragraph">
<p>WildFly Elytron contains two default credential store implementations.  The first implementation is the <code>KeyStoreCredentialStore</code> which is an
implementation backed by a <code>KeyStore</code>.  The <code>KeyStoreCredentialStore</code> implementation supports the storage of various credential types,
<code>PasswordCredential</code>, <code>KeyPairCredential</code>, and <code>SecretKeyCredential</code>.  The second implementation is the <code>PropertiesCredentialStore</code>.  This credential
store is dedicated to the storage of <code>SecretKeyCredential</code> instances using a properties file.  The <code>PropertiesCredentialStore</code> does not offer any protection
of the credentials it stores so its primary purpose is to provide an initial key to a server environment.</p>
</div>
<div class="paragraph">
<p>This documentation is primarily focused on the <code>KeyStoreCredentialStore</code> and <code>PropertiesCredentialStore</code>; however the section <a href="#Custom_CredentialStore">Custom CredentialStore</a> describes the SPIs for implementing a custom credential store and the section <a href="#Migrating_Existing_Vaults">Migrating Existing Vaults</a> describes how to convert a vault to a credential store.</p>
</div>
<div class="paragraph">
<p>It is possible to operate on credential stores using either a standalone command line tool <code>elytron-tool.sh</code> which is included with WildFly or by using management operations through the <code>jboss-cli.sh</code>, management console or other management client calling the management interface directly.</p>
</div>
<div class="paragraph">
<p>The <code>elytron-tool.sh</code> script to execute the command line tool can be found within the <code>bin</code> folder of the application server installation.</p>
</div>
<div class="paragraph">
<p>The WildFly Elytron tool supports a number of commands, one of which being <code>credential-store</code> which operates on a credential store.  The commands in this documentation are making use of the <code>.sh</code> script on linux; the <code>elytron-tool.bat</code> and <code>elytron-tools.ps1</code> scripts can be used on Microsoft Windows.</p>
</div>
<div class="paragraph">
<p>The following command provides a summary of the command line arguments which can be used with the <code>credential-store</code> command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>]$ bin/elytron-tool.sh credential-store</code></pre>
</div>
</div>
<div class="sect2">
<h3 id="_credential_store_creation"><a class="anchor" href="#_credential_store_creation"></a>17.1. Credential Store Creation</h3>
<div class="sect3">
<h4 id="_keystorecredentialstore_credential_store"><a class="anchor" href="#_keystorecredentialstore_credential_store"></a>17.1.1. KeyStoreCredentialStore / credential-store</h4>
<div class="paragraph">
<p>The <code>KeyStoreCredentialStore</code> supports the largest number of credential types which can be stored within a credential store, additionally as the implementation is backed by a Java KeyStore the storage is protected using the mechanisms provided by the KeyStore implementations.</p>
</div>
<div class="sect4">
<h5 id="_command_line"><a class="anchor" href="#_command_line"></a>Command Line</h5>
<div class="paragraph">
<p>When using the <code>credential-store</code> command of the <code>elytron-tool.sh</code> script by default, this command assumes the type of the store is a <code>KeyStoreCredentialStore</code> backed by a <code>JCEKS</code> <code>KeyStore</code>.</p>
</div>
<div class="paragraph">
<p>A new credential store can be created using the following command: -</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>]$ bin/elytron-tool.sh credential-store --create --location=standalone/configuration/mycredstore.cs
Credential store password:
Confirm credential store password:
Credential Store has been successfully created</code></pre>
</div>
</div>
<div class="paragraph">
<p>This command prompts twice for the password that should be used to secure the store.  Alternatively the password can be passed in using the <code>--password</code> argument however that may mean the password is cached in the local command history or visible to other users viewing the list of running processes.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The command line tool only creates the instance of the credential store on the underlying file system; the management operation is still required to define the credential store in the <code>elytron</code> subsystem.
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="_management_operation"><a class="anchor" href="#_management_operation"></a>Management Operation</h5>
<div class="paragraph">
<p>It is also possible to operate on a credential store using management operations against a running server using the application server&#8217;s CLI.</p>
</div>
<div class="paragraph">
<p>The following operation can be used to add a <code>credential-store</code> resource to the <code>elytron</code> subsystem referencing this newly created credential store.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/] /subsystem=elytron/credential-store=mycredstore:add(path=mycredstore.cs, relative-to=jboss.server.config.dir, credential-reference={clear-text=StorePassword})
{"outcome" =&gt; "success"}</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this example the resource was added to reference an existing credential store, however with a small change this command can also automatically create the store if it does not exist.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/] /subsystem=elytron/credential-store=mycredstore:add(path=mycredstore.cs, relative-to=jboss.server.config.dir, credential-reference={clear-text=StorePassword}, create=true)
{"outcome" =&gt; "success"}</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The file representing the credential store is not created immediately, it will instead be created the first time a credential is added.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Previous versions of the application server supported a single vault definition only; credential stores however are cross-referenced by name so multiple credential stores can be defined simultaneously.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_propertiescredentialstore_secret_key_credential_store"><a class="anchor" href="#_propertiescredentialstore_secret_key_credential_store"></a>17.1.2. PropertiesCredentialStore / secret-key-credential-store</h4>
<div class="paragraph">
<p>This is a simple credential store implementation which can only be used to store <code>SecretKey</code> instances.  This credential store also does not offer any protection of the contents.
Within an application server environment it is always possible to get into a cycle of how is an initial secret provided to unlock further resources, this is primarily the purpose
of this credential store.  The strategy in the past had been to use masking of a password using password based encryption, the down side of this approach was the password used for
the masking was stored in the source code and being an open source project this means the password is well known.  By using the <code>PropertiesCredentialStore</code> installations are back
in control of the initial secret.  Although this credential store does not offer its own protection filesystem level access control can still be used to restrict access ideally to
just the application server process.</p>
</div>
<div class="sect4">
<h5 id="_command_line_2"><a class="anchor" href="#_command_line_2"></a>Command Line</h5>
<div class="paragraph">
<p>A new credential store can be created using the following command: -</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>]$ bin/elytron-tool.sh credential-store --create --location=standalone/configuration/propcredstore.cs --type PropertiesCredentialStore
Credential Store has been successfully created</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_management_operation_2"><a class="anchor" href="#_management_operation_2"></a>Management Operation</h5>
<div class="paragraph">
<p>It is also possible to operate on a credential store using management operations against a running server using the application server&#8217;s CLI.</p>
</div>
<div class="paragraph">
<p>The following operation can be used to add a <code>secret-key-credential-store</code> resource to the <code>elytron</code> subsystem referencing this newly created credential store.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/] /subsystem=elytron/secret-key-credential-store=mycredstore:add(path=propcredstore.cs, relative-to=jboss.server.config.dir, create=false, populate=false)
{"outcome" =&gt; "success"}</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this example the resource was added to reference an existing credential store, however with a small change this command can also automatically create the store if it does not exist, and
populate it with a generated SecretKey under the alias <code>key</code> if it does not already exist.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/] /subsystem=elytron/secret-key-credential-store=mycredstore:add(path=propcredstore.cs, relative-to=jboss.server.config.dir)
{"outcome" =&gt; "success"}</code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
If you rely on automatic generation of a <code>SecretKey</code> be sure to create a backup of the key as soon as possible.  If you were to loose the key we do not have a mechanism to decrypt anything
encrypted with the lost key.
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_credential_manipulation"><a class="anchor" href="#_credential_manipulation"></a>17.2. Credential Manipulation</h3>
<div class="paragraph">
<p>The contents of the credential stores can be manipulated using either the command line tool or by using management operations.  Unlike key stores the credential store APIs allow for multiple entries to be stored under a single alias provided each entry is of a different credential type.</p>
</div>
<div class="sect3">
<h4 id="_adding_credentials"><a class="anchor" href="#_adding_credentials"></a>17.2.1. Adding Credentials</h4>
<div class="paragraph">
<p>The different credential store implementations support different credential types as illustrated in this table.</p>
</div>
<table class="tableblock frame-all grid-all stripes-even fit-content">
<colgroup>
<col>
<col>
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Credential Type</th>
<th class="tableblock halign-left valign-top">KeyStoreCredentialStore</th>
<th class="tableblock halign-left valign-top">PropertiesCredentialStore</th>
</tr>
</thead>
<tbody>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock">PasswordCredential</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock">Supported</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Unsupported</p></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock">KeyPairCredential</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock">Supported</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Unsupported</p></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock">SecretKeyCredential</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock">Supported</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Supported</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>As with all the manipulation options it is possible to use either the command line tool or management operations against a running server to modify the contents of the store.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Care should be taken when using the command line tool to ensure the store is not currently in use by any other processes.  If the store is in use by another process which updates the contents of the store changes made by the tool could be lost.
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="_passwordcredential"><a class="anchor" href="#_passwordcredential"></a>PasswordCredential</h5>
<div class="paragraph">
<p>Using the tooling it is possible to add a clear text password as a credential.</p>
</div>
<div class="sect5">
<h6 id="_command_line_3"><a class="anchor" href="#_command_line_3"></a>Command Line</h6>
<div class="paragraph">
<p>The following command adds a new credential with an alias of <code>example</code> to the store using the command line tool: -</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>]$ bin/elytron-tool.sh credential-store --add=example --location=standalone/configuration/mycredstore.cs
Credential store password:
Confirm credential store password:
Secret to store:
Confirm secret to store:
Alias "example" has been successfully stored</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="_management_operation_3"><a class="anchor" href="#_management_operation_3"></a>Management Operation</h6>
<div class="paragraph">
<p>Using a management operation the following command can be used to add a new alias of <code>example</code> to the credential store.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>[standalone@localhost:9990 /] /subsystem=elytron/credential-store=mycredstore:add-alias(alias=example, secret-value=ExamplePassword)
{
    "outcome" =&gt; "success",
    "result" =&gt; undefined
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_keypaircredential"><a class="anchor" href="#_keypaircredential"></a>KeyPairCredential</h5>
<div class="sect5">
<h6 id="_command_line_4"><a class="anchor" href="#_command_line_4"></a>Command Line</h6>
<div class="paragraph">
<p>The following command allows you to import a key pair credential with an alias of <code>example</code> from a file containing
a private key in OpenSSH format:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>]$ bin/elytron-tool.sh credential-store --import-key-pair example --private-key-location /home/user/.ssh/id_rsa --location=standalone/configuration/mycredstore.cs
Credential store password:
Confirm credential store password:
Passphrase to be used to decrypt private key (can be nothing if no passphrase was used to encrypt the key): secret
Confirm passphrase to be used to decrypt private key (can be nothing if no passphrase was used to encrypt the key): secret
Alias "example" has been successfully stored</code></pre>
</div>
</div>
<div class="paragraph">
<p>The following command allows you to import a key pair credential with an alias of <code>example</code> by specifying a private key in OpenSSH format :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>]$ bin/elytron-tool.sh credential-store --import-key-pair example --private-key-string="-----BEGIN OPENSSH PRIVATE KEY-----
                                                   b3BlbnNzaC1rZXktdjEAAAAACmFlczI1Ni1jdHIAAAAGYmNyeXB0AAAAGAAAABCdRswttV
                                                   UNQ6nKb6ojozTGAAAAEAAAAAEAAABoAAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlz
                                                   dHAyNTYAAABBBAKxnsRT7n6qJLKoD3mFfAvcH5ZFUyTzJVW8t60pNgNaXO4q5S4qL9yCCZ
                                                   cKyg6QtVgRuVxkUSseuR3fiubyTnkAAADQq3vrkvuSfm4n345STr/i/29FZEFUd0qD++B2
                                                   ZoWGPKU/xzvxH7S2GxREb5oXcIYO889jY6mdZT8LZm6ZZig3rqoEAqdPyllHmEadb7hY+y
                                                   jwcQ4Wr1ekGgVwNHCNu2in3cYXxbrYGMHc33WmdNrbGRDUzK+EEUM2cwUiM7Pkrw5s88Ff
                                                   IWI0V+567Ob9LxxIUO/QvSbKMJGbMM4jZ1V9V2Ti/GziGJ107CBudZr/7wNwxIK86BBAEg
                                                   hfnrhYBIaOLrtP8R+96i8iu4iZAvcIbQ==
                                                   -----END OPENSSH PRIVATE KEY-----"
                                                   --location=standalone/configuration/mycredstore.cs
Credential store password:
Confirm credential store password:
Passphrase to be used to decrypt private key (can be nothing if no passphrase was used to encrypt the key): secret
Confirm passphrase to be used to decrypt private key (can be nothing if no passphrase was used to encrypt the key): secret
Alias "example" has been successfully stored</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If specifying your key in PKCS format rather than OpenSSH format, you must specify both the private and public key. The
PKCS private key must also not be encrypted with a passphrase.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Alternatively to importing, you may use the command line tool to generate and store a key pair credential in a credential store.
The following command allows you to generate and store a key pair credential under the alias <code>example</code> using the ecdsa algorithm:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>]$ bin/elytron-tool.sh credential-store --generate-key-pair example --algorithm EC --location=standalone/configuration/mycredstore.cs
Credential store password:
Confirm credential store password:
Alias "example" has been successfully stored</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can then export the public key generated in OpenSSH format using the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>]$ bin/elytron-tool.sh credential-store --export-key-pair-public-key example
Credential store password:
Confirm credential store password:
ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBMfncZuHmR7uglb0M96ieArRFtp42xPn9+ugukbY8dyjOXoi
cZrYRyy9+X68fylEWBMzyg+nhjWkxJlJ2M2LAGY=</code></pre>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_secretkeycredential"><a class="anchor" href="#_secretkeycredential"></a>SecretKeyCredential</h5>
<div class="sect5">
<h6 id="_command_line_5"><a class="anchor" href="#_command_line_5"></a>Command Line</h6>
<div class="paragraph">
<p>Each of the examples in this section uses the <code>KeyStoreCredentialStore</code> to use the <code>PropertiesCredentialStore</code> this can be specified on the command line by adding the <code>--type PropertiesCredentialStore</code> parameter to the command line.</p>
</div>
<div class="paragraph">
<p>A new secret key can be generated with the following command.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>]$ bin/elytron-tool.sh credential-store --generate-secret-key=example --location=standalone/configuration/mycredstore.cs
Credential store password:
Alias "example" has been successfully stored</code></pre>
</div>
</div>
<div class="paragraph">
<p>By default this will create a 256 bit secret key, if either a 128 bit or 192 bit secret key is desired this can be specified with the <code>--size=128</code> or <code>--size=192</code> parameters respectively.</p>
</div>
<div class="paragraph">
<p>An existing secret key can be exported with the following command.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>]$ bin/elytron-tool.sh credential-store --export-secret-key=example --location=standalone/configuration/mycredstore.cs
Credential store password:
Exported SecretKey for alias example=RUxZAUucgH8RSMNvoUj/rMz+pBZddttGCuT9of4TgfYLnN5Z1w==</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The exported key uses a custom representation to allow Elytron to recognise exported keys.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Finally a previously exported secret key can be imported with the following command.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>]$ bin/elytron-tool.sh credential-store --import-secret-key=imported --location=standalone/configuration/mycredstore.cs
Credential store password:
SecretKey to import: RUxZAUucgH8RSMNvoUj/rMz+pBZddttGCuT9of4TgfYLnN5Z1w==
Alias "imported" has been successfully stored</code></pre>
</div>
</div>
<div class="paragraph">
<p>It is possible to also specify the key to import on the command line e.g. <code>--key=RUxZAUucgH8RSMNvoUj/rMz+pBZddttGCuT9of4TgfYLnN5Z1w==</code> but this would be vieweable by others users that can consult running processes and might also be cached in the history of the shell executing the commands.</p>
</div>
</div>
<div class="sect5">
<h6 id="_management_operations"><a class="anchor" href="#_management_operations"></a>Management Operations</h6>
<div class="paragraph">
<p>For secret key manipulation the same set of command are available for both the <code>credential-store</code> resource and the <code>secret-key-credential-store</code> resource.</p>
</div>
<div class="paragraph">
<p>A new secret key can be generated with the following command.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>[standalone@localhost:9990 /] /subsystem=elytron/credential-store=mycredstore:generate-secret-key(alias=example)
{"outcome" =&gt; "success"}</code></pre>
</div>
</div>
<div class="paragraph">
<p>To generate either a 128 bit key or 192 bit key the parameter <code>key-size=128</code> or <code>key-size=192</code> can be specified respectively.</p>
</div>
<div class="paragraph">
<p>An existing secret key can be exported with the following command.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>[standalone@localhost:9990 /] /subsystem=elytron/credential-store=mycredstore:export-secret-key(alias=example)
{
    "outcome" =&gt; "success",
    "result" =&gt; {"key" =&gt; "RUxZAUs+Y1CzEPw0g2AHHOZ+oTKhT9osSabWQtoxR+O+42o11g=="}
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>Finally a previously exported secret key can be imported with the following commands.

[standalone@localhost:9990 /] history --disable
[standalone@localhost:9990 /] /subsystem=elytron/credential-store=mycredstore:import-secret-key(alias=imported, key="RUxZAUs+Y1CzEPw0g2AHHOZ+oTKhT9osSabWQtoxR+O+42o11g==")
{"outcome" =&gt; "success"}
[standalone@localhost:9990 /] history --enable</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this last example we also temporarily disable the history in the CLI to prevent the key from being cached in the CLI hisory.</p>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_listing_aliases"><a class="anchor" href="#_listing_aliases"></a>17.2.2. Listing Aliases</h4>
<div class="paragraph">
<p>It is possible to list the aliases contained within the credential store, however it is not possible to list the actual values stored.</p>
</div>
<div class="sect4">
<h5 id="_command_line_6"><a class="anchor" href="#_command_line_6"></a>Command Line</h5>
<div class="paragraph">
<p>Using the command line tool will show a list of aliases stored within the credential store:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>]$ bin/elytron-tool.sh credential-store --aliases --location=standalone/configuration/mycredstore.cs
Credential store password:
Confirm credential store password:
Credential store contains following aliases: example</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_management_operation_4"><a class="anchor" href="#_management_operation_4"></a>Management Operation</h5>
<div class="paragraph">
<p>The following management operation will also show the aliases contained within the credential store.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/] /subsystem=elytron/credential-store=mycredstore:read-aliases
{
    "outcome" =&gt; "success",
    "result" =&gt; ["example"]
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_removing_credentials"><a class="anchor" href="#_removing_credentials"></a>17.2.3. Removing Credentials</h4>
<div class="paragraph">
<p>Finally, it is also possible to remove an alias from the credential store.</p>
</div>
<div class="sect4">
<h5 id="_command_line_7"><a class="anchor" href="#_command_line_7"></a>Command Line</h5>
<div class="paragraph">
<p>Using the WildFly Elytron Tool the following command will remove an alias from the store.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>]$ bin/elytron-tool.sh credential-store --remove=example --location=standalone/configuration/mycredstore.cs
Credential store password:
Confirm credential store password:
Alias "example" has been successfully removed</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_management_operation_5"><a class="anchor" href="#_management_operation_5"></a>Management Operation</h5>
<div class="paragraph">
<p>The following management operation can be used to remove an alias from the credential store.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/] /subsystem=elytron/credential-store=mycredstore:remove-alias(alias=example)
{
    "outcome" =&gt; "success",
    "result" =&gt; undefined,
    "response-headers" =&gt; {"warnings" =&gt; [{
        "warning" =&gt; "Update dependent resources as alias 'example' does not exist anymore",
        "level" =&gt; "WARNING",
        "operation" =&gt; {
            "address" =&gt; [
                ("subsystem" =&gt; "elytron"),
                ("credential-store" =&gt; "mycredstore")
            ],
            "operation" =&gt; "remove-alias"
        }
    }]}
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>By default the <code>credential-store</code> resource assumes the type to be removed is <code>PasswordCredential</code>.  If a different type is to be removed it can be specified with the <code>entry-type=SecretKeyCredential</code> parameter.  The <code>secret-key-credential-store</code> only holds secret keys so the entry type never needs to be specified.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_referencing_credentials"><a class="anchor" href="#_referencing_credentials"></a>17.3. Referencing Credentials</h3>
<div class="paragraph">
<p>After being able to populate and manipulate a credential store the next step is being able to reference the stored credential so that it can be used.</p>
</div>
<div class="sect3">
<h4 id="_management_model_references"><a class="anchor" href="#_management_model_references"></a>17.3.1. Management Model References</h4>
<div class="paragraph">
<p>Various resources that make use of credentials across the application server&#8217;s management model contain <code>credential-reference</code> attributes that can be used either to specify a <code>clear-password</code> or to cross-reference a credential from within a configured credential store.</p>
</div>
<div class="paragraph">
<p>The following is an example of how to define a <code>key-store</code> within the Elytron subsystem specifying a clear text password to access the store.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/] /subsystem=elytron/key-store=exampleKS:add(relative-to=jboss.server.config.dir, path=example.keystore,    \
                                              type=JCEKS, credential-reference={clear-text=ExamplePassword})
{"outcome" =&gt; "success"}</code></pre>
</div>
</div>
<div class="paragraph">
<p>To reference a credential from the previously defined credential store the following command could be used instead.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/] /subsystem=elytron/key-store=exampleKS:add(relative-to=jboss.server.config.dir, path=example.keystore, type=JCEKS, credential-reference={store=mycredstore, alias=example})
{"outcome" =&gt; "success"}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The above command assumes that the referenced credential already exists in the previously defined credential store.
The next section will describe how credentials can automatically be added to the previously defined credential store.</p>
</div>
</div>
<div class="sect3">
<h4 id="_automatic_updates_of_credential_stores"><a class="anchor" href="#_automatic_updates_of_credential_stores"></a>17.3.2. Automatic Updates of Credential Stores</h4>
<div class="paragraph">
<p>Instead of needing to add a credential to a previously defined credential store in order to reference it from a <code>credential-reference</code>,
it is possible to have the credential get added automatically to the previously defined credential store by specifying both
the <code>store</code> and <code>clear-text</code> attributes for the <code>credential-reference</code>. In particular, when adding a new <code>credential-reference</code>
with both the <code>store</code> and <code>clear-text</code> attributes specified:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>If the <code>alias</code> attribute is also specified, then one of the following will occur:</p>
<div class="ulist">
<ul>
<li>
<p>If the previously defined credential store does not contain an entry for the given alias, a new entry will be added
to the credential store to hold the clear text password that was specified. The <code>clear-text</code> attribute will then be
removed from the management model.</p>
</li>
<li>
<p>If the credential store does contain an entry for the given alias, the existing credential will be replaced with the
clear text password that was specified. The <code>clear-text</code> attribute will then be removed from the management model.</p>
</li>
</ul>
</div>
</li>
<li>
<p>If the <code>alias</code> attribute is not specified, an alias will be generated and a new entry will be added to the credential
store to hold the clear text password that was specified. The <code>clear-text</code> attribute will then be removed from the
management model.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>As an example, the following CLI command will result in a new entry being added to the previously defined credential
store, <code>mycredstore</code>, with alias <code>myNewAlias</code> and credential <code>myNewPassword</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=elytron/key-store=exampleKS:add(relative-to=jboss.server.config.dir, path=example.keystore, type=JCEKS, credential-reference={store=mycredstore, alias=myNewAlias, clear-text=myNewPassword})
{
    "outcome" =&gt; "success",
    "result" =&gt; {"credential-store-update" =&gt; {
        "status" =&gt; "new-entry-added",
        "new-alias" =&gt; "myNewAlias"
    }}
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>When updating an existing <code>credential-reference</code> that contains both the <code>alias</code> and <code>store</code> attributes to also specify
the <code>clear-text</code> attribute:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The existing credential in the previously defined credential store will be replaced with the clear text password that
was specified. The <code>clear-text</code> attribute will then be removed from the management model.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>As an example, the following CLI command will result in updating the credential for the <code>myNewAlias</code> entry that was just
added to the previously defined credential store:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=elytron/key-store=exampleKS:write-attribute(name=credential-reference.clear-text,value=myUpdatedPassword)
{
    "outcome" =&gt; "success",
    "result" =&gt; {"credential-store-update" =&gt; {"status" =&gt; "existing-entry-updated"}},
    "response-headers" =&gt; {
        "operation-requires-reload" =&gt; true,
        "process-state" =&gt; "reload-required"
    }
}</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If an operation that includes a <code><code>credential-reference</code></code> parameter fails for any reason,
      no automatic credential store update will take place, i.e., any credential store that was
      specified via the <code><code>credential-reference</code></code> attribute will contain the same contents as it
      did before the operation was executed.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_wildfly_config_xml"><a class="anchor" href="#_wildfly_config_xml"></a>17.3.3. wildfly-config.xml</h4>
<div class="paragraph">
<p>If you are making use of the <code>wildfly-config.xml</code> descriptor it is also possible to define a credential store within this descriptor to obtain credentials without requiring them to be in-lined within the configuration.</p>
</div>
<div class="paragraph">
<p>As an example the CLI can be executed with a configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>]$ bin/jboss-cli.sh -c -Dwildfly.config.url=bin/wildfly-config.xml</code></pre>
</div>
</div>
<div class="paragraph">
<p>Without using a credential store the username and credential can be specified in the clear e.g.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;?xml version="1.0" encoding="UTF-8"?&gt;

&lt;configuration&gt;
    &lt;authentication-client xmlns="urn:elytron:1.0"&gt;
        &lt;authentication-rules&gt;
                    &lt;rule use-configuration="default" /&gt;
        &lt;/authentication-rules&gt;
        &lt;authentication-configurations&gt;
            &lt;configuration name="default"&gt;
                &lt;sasl-mechanism-selector selector="DIGEST-MD5" /&gt;
                &lt;providers&gt;
                    &lt;use-service-loader/&gt;
                &lt;/providers&gt;
                &lt;set-user-name name="User" /&gt;
                &lt;credentials&gt;
                    &lt;clear-password password="UserPassword" /&gt;
                &lt;/credentials&gt;
             &lt;/configuration&gt;
        &lt;/authentication-configurations&gt;
    &lt;/authentication-client&gt;
&lt;/configuration&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>However, it is possible to move this password to the credential store and update the configuration to load it from the store e.g.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;?xml version="1.0" encoding="UTF-8"?&gt;

&lt;configuration&gt;
    &lt;authentication-client xmlns="urn:elytron:1.0"&gt;
        &lt;credential-stores&gt;
            &lt;credential-store name="mycredstore"&gt;
                &lt;attributes&gt;
                    &lt;attribute name="keyStoreType" value="JCEKS" /&gt;
                    &lt;attribute name="location" value="standalone/configuration/mycredstore.cs" /&gt;
                &lt;/attributes&gt;
                &lt;protection-parameter-credentials&gt;
                    &lt;clear-password password="StorePassword" /&gt;
                &lt;/protection-parameter-credentials&gt;
            &lt;/credential-store&gt;
        &lt;/credential-stores&gt;

        &lt;authentication-rules&gt;
                    &lt;rule use-configuration="default" /&gt;
        &lt;/authentication-rules&gt;
        &lt;authentication-configurations&gt;
            &lt;configuration name="default"&gt;
                &lt;sasl-mechanism-selector selector="DIGEST-MD5" /&gt;
                &lt;providers&gt;
                    &lt;use-service-loader/&gt;
                &lt;/providers&gt;
                &lt;set-user-name name="User" /&gt;
                &lt;credentials&gt;
                    &lt;credential-store-reference store="mycredstore" alias="User" /&gt;
                &lt;/credentials&gt;
             &lt;/configuration&gt;
        &lt;/authentication-configurations&gt;
    &lt;/authentication-client&gt;
&lt;/configuration&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Within this second example the key changes being the addition of the <code>&lt;credential-stores /&gt;</code> section and updating the <code>&lt;credentials/&gt;</code> section to use a <code>&lt;credential-store-reference/&gt;</code> to specify which credential store should be used and which alias from that credential store should be used.</p>
</div>
<div class="paragraph">
<p>In the above example, the credential store&#8217;s protection parameter is specified as a clear password, but it is also possible
to specify it as a masked password.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;?xml version="1.0" encoding="UTF-8"?&gt;

&lt;configuration&gt;
    &lt;authentication-client xmlns="urn:elytron:1.4"&gt;
        &lt;credential-stores&gt;
            &lt;credential-store name="mycredstore"&gt;
                &lt;attributes&gt;
                    &lt;attribute name="keyStoreType" value="JCEKS" /&gt;
                    &lt;attribute name="location" value="standalone/configuration/mycredstore.cs" /&gt;
                &lt;/attributes&gt;
                &lt;protection-parameter-credentials&gt;
                    &lt;masked-password masked-password="M3loEZ7uua1X1PiYCYJDpg==" iteration-count="100" salt="12345678"/&gt;
                &lt;/protection-parameter-credentials&gt;
            &lt;/credential-store&gt;
        &lt;/credential-stores&gt;

        &lt;authentication-rules&gt;
                    &lt;rule use-configuration="default" /&gt;
        &lt;/authentication-rules&gt;
        &lt;authentication-configurations&gt;
            &lt;configuration name="default"&gt;
                &lt;sasl-mechanism-selector selector="DIGEST-MD5" /&gt;
                &lt;providers&gt;
                    &lt;use-service-loader/&gt;
                &lt;/providers&gt;
                &lt;set-user-name name="User" /&gt;
                &lt;credentials&gt;
                    &lt;credential-store-reference store="mycredstore" alias="User" /&gt;
                &lt;/credentials&gt;
             &lt;/configuration&gt;
        &lt;/authentication-configurations&gt;
    &lt;/authentication-client&gt;
&lt;/configuration&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_credentialstore_apis"><a class="anchor" href="#_credentialstore_apis"></a>17.4. CredentialStore APIs</h3>
<div class="paragraph">
<p>It is also possible to make use of the CredentialStore APIs directly.  This could be useful for applications that require access to securely stored credentials.  This could also be an option for an application to populate a credential store for use elsewhere.</p>
</div>
<div class="paragraph">
<p>The following code demonstrates how to obtain an initialised instance of <code>KeyStoreCredentialStore</code> so it can be used to store and retrieve credentials.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">Password storePassword = ClearPassword.createRaw(ClearPassword.ALGORITHM_CLEAR, "StorePassword".toCharArray());
ProtectionParameter protectionParameter = new CredentialSourceProtectionParameter(IdentityCredentials.NONE.withCredential(new PasswordCredential(storePassword)));

CredentialStore credentialStore = CredentialStore.getInstance("KeyStoreCredentialStore", CREDENTIAL_STORE_PROVIDER);

Map&lt;String, String&gt; configuration = new HashMap&lt;&gt;();
configuration.put("location", "mystore.cs");
configuration.put("create", "true");

credentialStore.initialize(configuration, protectionParameter);</code></pre>
</div>
</div>
<div class="paragraph">
<p>The following code illustrates how a couple of different credential types can be added to a credential store:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">Password clearPassword = ClearPassword.createRaw(ClearPassword.ALGORITHM_CLEAR, "ExamplePassword".toCharArray());
credentialStore.store("clearPassword", new PasswordCredential(clearPassword));

KeyGenerator keyGenerator = KeyGenerator.getInstance("AES");
keyGenerator.init(256);
SecretKey secretKey = keyGenerator.generateKey();
credentialStore.store("secretKey", new SecretKeyCredential(secretKey));</code></pre>
</div>
</div>
<div class="paragraph">
<p>These credentials can then be obtained again from the store:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">Password password = credentialStore.retrieve("clearPassword", PasswordCredential.class).getPassword();
SecretKey secretKey = credentialStore.retrieve("secretKey", SecretKeyCredential.class).getSecretKey();</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
As the type is specified when retrieving a credential it is possible to store multiple credentials under the same alias.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Please use the published javadoc for more information in relation to the APIs and the credential types supported within WildFly Elytron.</p>
</div>
</div>
<div class="sect2">
<h3 id="Migrating_Existing_Vaults"><a class="anchor" href="#Migrating_Existing_Vaults"></a>17.5. Migrating Existing Vaults</h3>
<div class="paragraph">
<p>If migrating from a prior version of the application server it is possible that you already are making use of a PicketBox vault for the storage of clear text passwords.  The tooling provided can be used to convert the vault to the format used by the <code>KeyStoreCredentialStore</code>.</p>
</div>
<div class="paragraph">
<p>Within the WildFly Elytron command line tool an additional command <code>vault</code> is available specifically for the conversion of legacy vaults to a credential store.  A complete vault can be converted to a credential store with the following command: -</p>
</div>
<div class="paragraph">
<p>The following command can be used to convert a single entry from a vault to a credential store: -</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>]$ bin/elytron-tool.sh vault --enc-dir standalone/configuration/vault --keystore standalone/configuration/vault.keystore --iteration 44 --salt 00000000 --alias vault \
    --location standalone/configuration/newcredstore.cs
Vault password:
Confirm vault password:
Vault (enc-dir="standalone/configuration/vault";keystore="standalone/configuration/vault.keystore") converted to credential store "standalone/configuration/newcredstore.cs"</code></pre>
</div>
</div>
<div class="paragraph">
<p>When executing this command the destination credential store must not already exist.  The password used for the credential store will be the password originally used for the vault.</p>
</div>
<div class="paragraph">
<p>Entries stored within the vault would have been stored specifying a "block" and "alias" value; within the credential store the new alias will be <code>block::alias</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="Custom_CredentialStore"><a class="anchor" href="#Custom_CredentialStore"></a>17.6. Custom Credential Store</h3>
<div class="paragraph">
<p>It is also possible to provide custom credential store implementations.  Overall the pattern to implementing a custom credential store is very similar to the pattern that would be followed to implement a custom key store.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Extend the SPI</p>
</li>
<li>
<p>Implement a <code>java.security.Provider</code> to register the implementation.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The SPI to be extended is <code>org.wildfly.security.credential.store.CredentialStoreSpi</code>.  The custom implementation will be required to implement the following methods.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">public abstract void initialize(Map&lt;String, String&gt; attributes, CredentialStore.ProtectionParameter protectionParameter, Provider[] providers) throws CredentialStoreException;</code></pre>
</div>
</div>
<div class="paragraph">
<p>This method is required to perform the initialisation of the credential store, by taking in a <code>Map</code> of attributes it allows for custom configuration to be provided as required by the store.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">public abstract boolean isModifiable();</code></pre>
</div>
</div>
<div class="paragraph">
<p>A credential store needs to advertise if it supports modifications so clients can determine if the modification APIs can be used.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">public abstract &lt;C extends Credential&gt; C retrieve(String credentialAlias, Class&lt;C&gt; credentialType, String credentialAlgorithm, AlgorithmParameterSpec parameterSpec, CredentialStore.ProtectionParameter protectionParameter) throws CredentialStoreException;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>retrieve</code> method is essential for all credential store implementations to retrieve credentials of a specific type using the alias specified.</p>
</div>
<div class="paragraph">
<p>In addition to <code>retrieve</code> there are two more methods that can optionally be implemented.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">public boolean exists(String credentialAlias, Class&lt;? extends Credential&gt; credentialType) throws CredentialStoreException;

public Set&lt;String&gt; getAliases() throws UnsupportedOperationException, CredentialStoreException;</code></pre>
</div>
</div>
<div class="paragraph">
<p>A default implementation of <code>exists</code> already is implemented which checks if a call to <code>retrieve</code> returns a credential as requested.  However it could be optimal to check the existence of a credential without actually loading it.  The <code>getAliases</code> method is optional as some implementations may only be able to retrieve a credential by name rather than query all available credentials.</p>
</div>
<div class="paragraph">
<p>The next set of methods to implement are the methods needed for updates to be applied to the underlying credential store.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">public abstract void store(String credentialAlias, Credential credential, CredentialStore.ProtectionParameter protectionParameter)
            throws CredentialStoreException, UnsupportedCredentialTypeException;

public abstract void remove(String credentialAlias, Class&lt;? extends Credential&gt; credentialType, String credentialAlgorithm, AlgorithmParameterSpec parameterSpec) throws CredentialStoreException;

public void flush() throws CredentialStoreException;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>store</code> and <code>remove</code> methods either add credentials to a credential store or remove them.  Implementing the <code>flush</code> method is optional but this method can be used as a trigger for a store to persist its state.</p>
</div>
<div class="paragraph">
<p>The final stage is to provide an implementation of <code>java.security.Provider</code> which can return an instance of the SPI for the <code>CredentialStore</code> service type.  The WildFly Elytron provider which makes the Elytron implementations available is <code>org.wildfly.security.credential.store.WildFlyElytronCredentialStoreProvider</code>.  The source code for this provider can be used as an example.</p>
</div>
</div>
<div class="sect2">
<h3 id="_reference"><a class="anchor" href="#_reference"></a>17.7. Reference</h3>
<div class="paragraph">
<p>The previous sections have made use of either the WildFly Elytron Tool or the management operations and specified the arguments and configuration options required for the action being performed.  These operations and tools however support a variety of other options so this section provides some additional detail.</p>
</div>
<div class="sect3">
<h4 id="_elytron_tool_credential_store_command"><a class="anchor" href="#_elytron_tool_credential_store_command"></a>17.7.1. Elytron Tool - <code>credential-store</code> Command</h4>
<div class="paragraph">
<p>Examples of how to structure calling the <code>credential-store</code> command were provided earlier.  When using the <code>credential-store</code> command the following actions are possible: -</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 12. credential-store Actions</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Action</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">-a,--add &lt;alias&gt;</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Add a new entry to the credential store using the specified alias.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">-c,--create</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Create a new credential store instance.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">-e,--exists &lt;alias&gt;</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Test if the specified alias already exists in the credential store.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">-r,--remove &lt;alias&gt;</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Remove the alias specified from the credential store.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">-g,--generate-key-pair &lt;alias&gt;</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Generate a new key pair credential and add it as an entry to the credential store using the specified alias.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">--generate-secret-key &lt;alias&gt;</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Generate a new secret key credential and add it as an entry to the credential store using the specified alias.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">--export-secret-key &lt;alias&gt;</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Export a secret key credential identified using the specified alias.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">-xp,--export-key-pair-public-key &lt;alias&gt;</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Display the public key of a key pair credential entry under the specified alias in OpenSSH format.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">--import-secret-key &lt;alias&gt;</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Import a secret key credential and add it as an entry to the credential store using the specified alias.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">-ikp,--import-key-pair &lt;alias&gt;</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Add a new key pair credential entry to the credential store using the specified alias.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">--encrypt &lt;alias&gt;</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Encrypt a clear text string using the secret key stored under the specified alias.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">-v,--aliases</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Display all aliases</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">-f,--summary</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Print summary, especially command how to create this credential store</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">-h,--help</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Get help with usage of this command</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The following parameters can be provided for each action to specify how to load the store.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 13. credential-store Parameters</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Parameter</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">-d,--debug</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Print stack trace when error occurs.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">-i,--iteration &lt;arg&gt;</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Iteration count for final masked password of the credential store</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">-l,--location &lt;loc&gt;</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Location of credential store storage file</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">-n,--entry-type &lt;type&gt;</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Type of entry in credential store</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">-o,--other-providers &lt;providers&gt;</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Comma separated list of Jakarta Connectors provider names. Providers will be supplied to the credential store instance.  Each provider must be installed through java.security file or through service loader from properly packaged jar file on classpath.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">-p,--password &lt;pwd&gt;</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Password for credential store</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">-q,--credential-store-provider &lt;cs-provider&gt;</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Provider name containing CredentialStoreSpi implementation.  Provider must be installed through java.security file or through service loader from properly packaged jar file on classpath.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">-s,--salt &lt;arg&gt;</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Salt to apply for final masked password of the credential store</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">-t,--type &lt;type&gt;</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Credential store type</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">-u,--properties &lt;arg&gt;</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Implementation properties for credential store type in form of "prop1=value1; &#8230;&#8203; ;propN=valueN"</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">-x,--secret &lt;secret to store&gt;</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Password credential value</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The following parameters can be provided for the <code>generate-key-pair</code> command:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 14. generate-key-pair Parameters</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Parameter</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Default Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">-k, --algorithm &lt;algorithm name&gt;</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The encryption algorithm to be used. One of: RSA, DSA, or EC</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">RSA</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">-j,--size &lt;size in bytes&gt;</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Size of the private key in bytes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">RSA: 2048, DSA: 2048, EC: 256</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The following parameter can be provided for the <code>generate-secret-key</code> command:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 15. generate-secret-key Parameter</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Parameter</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Default Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">--size</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Size of the secret key in bits, can be one of 128, 192, or 256.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">256</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The following parameters can be provided for the <code>import-key-pair</code> command:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 16. import-key-pair Parameters</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Parameter</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">-pvk, --private-key-string &lt;private key to store&gt;</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The private key as a string. Alternative to <code>private-key-location</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">-pvl, --private-key-location &lt;path&gt;</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The path to a file containing a private key. Alternative to <code>private-key-string</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">-pbk, --public-key-string &lt;public key to store&gt;</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The public key as a string. Alternative to <code>public-key-location</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">-pbl, --public-key-location &lt;path&gt;</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The path to a file containing a public key. Alternative to <code>public-key-string</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">-kp, --key-passphrase &lt;passphrase&gt;</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The passphrase used to decrypt the private key if needed. Can also be specified via prompt</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The following parameter can be provided for the <code>import-secret-key</code> command:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 17. import-secret-key Parameter</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Parameter</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Default Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">--key</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The secret key to be imported, if not specified the key will be prompted for.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">N/A</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The following parameters can be provided for the <code>encrypt</code> command:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 18. encrypt Parameters</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Parameter</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Default Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">--clear-text &lt;clear text&gt;</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The clear text string to encrypt, if omitted this wil be prompted for.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">N/AThe following parameters can be provided for the <code>generate-key-pair</code> command:</p>
<p class="tableblock">.generate-key-pair Parameters</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>|Parameter |Description |Default Value</p>
</div>
<div class="paragraph">
<p>|-k, --algorithm &lt;algorithm name&gt;
|The encryption algorithm to be used. One of: RSA, DSA, or EC
|RSA</p>
</div>
</div>
<div class="sect3">
<h4 id="_elytron_tool_vault_command"><a class="anchor" href="#_elytron_tool_vault_command"></a>17.7.2. Elytron Tool - <code>vault</code> Command</h4>
<div class="paragraph">
<p>The <code>vault</code> command is used to convert a legacy vault to a credential store and supports the following parameters.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 19. vault Parameters</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Parameter</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">-b,--bulk-convert &lt;description file&gt;</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Bulk conversion with options listed in description file.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">-d,--debug</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Print stack trace when error occurs.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">-e,--enc-dir &lt;dir&gt;</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Vault directory containing encrypted files (defaults to "vault")</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">-f,--summary</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Print summary of conversion</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">-h,--help</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Get help with usage of this command</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">-i,--iteration &lt;arg&gt;</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Iteration count (defaults to "23")</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">-k,--keystore &lt;keystore&gt;</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Vault keystore URL (defaults to "vault.keystore")</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">-l,--location &lt;loc&gt;</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Location of credential store storage file (defaults to "converted-vault.cr-store" in vault encryption directory)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">-o,--other-providers &lt;providers&gt;</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Comma separated list of Jakarta Connectors provider names. Providers will be supplied to the credential store instance.  Each provider must be installed through java.security file or through service loader from properly packaged jar file on classpath.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">-p,--keystore-password &lt;pwd&gt;</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Vault keystore password, used to open original vault key store, and used as password for new converted credential store</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">-q,--credential-store-provider &lt;cs-provider&gt;</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Provider name containing CredentialStoreSpi implementation.  Provider must be installed through java.security file or through service loader from properly packaged jar file on classpath.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">-s,--salt &lt;salt&gt;</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">8 character salt (defaults to "12345678")</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">-t,--type &lt;type&gt;</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Converted credential store type (defaults to "KeyStoreCredentialStore")</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">-u,--properties &lt;arg&gt;</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Configuration parameters for credential store in form of: "parameter1=value1; &#8230;&#8203; ;parameterN=valueN"</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">-v,--alias &lt;arg&gt;</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Vault master key alias within key store (defaults to "vault")</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="_keystorecredentialstore"><a class="anchor" href="#_keystorecredentialstore"></a>17.7.3. KeyStoreCredentialStore</h4>
<div class="paragraph">
<p>When configuring the <code>KeyStoreCredentialStore</code> the following configuration options are supported.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 20. KeyStoreCredentialStore Configuration</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Name</th>
<th class="tableblock halign-left valign-top">Default</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">create</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If the credential store does not exist should it be created?</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">cryptographicAlgorithm</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">AES/CBC/NoPadding</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The algorithm to use when using an external store.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">external</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Should external storage be used?</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">externalPath</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">N/A</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Path to external storage.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">keyAlias</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">cs_key</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The alias to use from the KeyStore when working with external storage.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">keyStoreType</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>KeyStore.getDefault()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The type of the key store used for the credential store.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">location</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">N/A</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The location of the credential store.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">modifiable</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">true</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Should the store be modifiable via the exposed API.</p></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="EncryptedExpressions"><a class="anchor" href="#EncryptedExpressions"></a>18. Encrypted Expressions</h2>
<div class="sectionbody">
<div class="paragraph">
<p>WildFly Elytron provides support for handling encrypted expressions in the management model using a <code>SecretKey</code> from a <code>CredentialStore</code> to decrypt the expression at runtime.</p>
</div>
<div class="paragraph">
<p>For information regarding how to create, configure, and populate credential stores including the manipulation of secret keys please refer to the <a href="#CredentialStore">Credential Store</a> chapter.</p>
</div>
<div class="paragraph">
<p>Within the <code>elytron</code> subsystem one or more <code>resolvers</code> can be defined to handle the decryption of a previously encrypted expression.  Each resolver will reference a single secret key in a
single credential store which it will use to decrypt the expressions.  Encrypted expressions can take one of two forms:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>${ENC::ResolverName:RUxZAUMQXUj3qP1hbXyO5PpmsbgkepjoscIf3tKXvGiPDXYqNAc=}</code></p>
</li>
<li>
<p><code>${ENC::RUxZAUMQXUj3qP1hbXyO5PpmsbgkepjoscIf3tKXvGiPDXYqNAc=}</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In both cases the <code>ENC</code> prefix is used to identify the expression is an encrypted expression.  This prefix is the default however it is possible to define an alternative prefix for use
across the configuration.</p>
</div>
<div class="paragraph">
<p>Within the first example the <code>ResolverName</code> is the name of an individual resolver definition.  The name of the resolver has been omitted in the second example as it is also possible
to define a default resolver which will be used if no resolver is specified within the expression.</p>
</div>
<div class="sect2">
<h3 id="_expressionencryption_resource"><a class="anchor" href="#_expressionencryption_resource"></a>18.1. expression=encryption resource</h3>
<div class="paragraph">
<p>Support for decrypting expressions is enabled by defining a singleton <code>expression=encryption</code> resource within the <code>elytron</code> subsystem.</p>
</div>
<div class="paragraph">
<p>This resource can be defined with the following attributes.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>prefix</code> (Default <code>ENC</code>) - The prefix used within the encrypted expressions.</p>
</li>
<li>
<p><code>default-resolver</code> (Optional) - For expressions that do not define a resolver, the default resolver to use.</p>
</li>
<li>
<p><code>resolvers</code> - A lit of one more named resolver definitions.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>An individual resolver is defined with three attributes:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>name</code> - The name of the individual configuration used to reference it.</p>
</li>
<li>
<p><code>credential-store</code> - Reference to the credential store instance that contains the secret key this resolver will use.</p>
</li>
<li>
<p><code>secret-key</code> - The alias of the secret key within the credential store to use.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The following is an example CLI command to define an <code>expression=encryption</code> resource in the <code>elytron</code> subsystem with two resolver definitions one if which is a
default and an alternative prefix.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>[standalone@localhost:9990 /] /subsystem=elytron/expression=encryption:add(prefix=ENCRYPTED, default-resolver=one, \
    resolvers=[{name=one, credential-store=store-one, secret-key=key}, \
               {name=two, credential-store=store-two,secret-key=key}])
{"outcome" =&gt; "success"}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_creating_expressions"><a class="anchor" href="#_creating_expressions"></a>18.2. Creating Expressions</h3>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The following section illustrates how to create an encrypted expression.  If you repeat the same command for the same clear text it is normal that a different
result is returned for the same key.  This is because a unique initialisation vector is used for each call.
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="_management_operation_6"><a class="anchor" href="#_management_operation_6"></a>18.2.1. Management Operation</h4>
<div class="paragraph">
<p>Once the <code>expression=encryption</code> resource has been defined the <code>create-expression</code> management operation can be called to generate an expression using the referenced
secret key.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
When using management operations to create expressions from a <code>clear-text</code> string remember to disable the history in the CLI first otherwise the clear text string will be cached.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In these examples the <code>expression=encryption</code> resource has been configured to use the default prefix.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>[standalone@localhost:9990 /] history --disable
[standalone@localhost:9990 /] /subsystem=elytron/expression=encryption:create-expression(resolver=two, clear-text=MyPassword)
{
    "outcome" =&gt; "success",
    "result" =&gt; {"expression" =&gt; "${ENC::two:RUxZAUMQcUVLxqjt8zh8FabcA+wcnux+mqfLE27sfmHfKNG9BcY=}"}
}

[standalone@localhost:9990 /] history --enable</code></pre>
</div>
</div>
<div class="paragraph">
<p>When using the <code>create-expression</code> operation the <code>resolver</code> attribute can be ommited, in that case the <code>default-resolver</code> will be used instead.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>[standalone@localhost:9990 /] history --disable
[standalone@localhost:9990 /] /subsystem=elytron/expression=encryption:create-expression(clear-text=MyPassword)
{
    "outcome" =&gt; "success",
    "result" =&gt; {"expression" =&gt; "${ENC::RUxZAUMQu7biKBAwtUi+to+BlQnbjK3URUHMUDh8ReTlN0Alao0=}"}
}

[standalone@localhost:9990 /] history --enable</code></pre>
</div>
</div>
<div class="paragraph">
<p>In both cases the resulting expression can be used on any attribute of a resource which supports the use of expressions.</p>
</div>
</div>
<div class="sect3">
<h4 id="_command_line_tool"><a class="anchor" href="#_command_line_tool"></a>18.2.2. Command Line Tool</h4>
<div class="paragraph">
<p>Once a credential store has been populated with a secret key the <code>credential-store</code> command of the <code>elytron-tool</code> can also be used to create the encrypted string to include in an expression.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>]$ bin/elytron-tool.sh credential-store --location standalone/configuration/store-one.cs --type PropertiesCredentialStore --encrypt key
Clear text value:
Confirm clear text value:
Clear text encrypted to token 'RUxZAUMQvGzk6Vaadp2cahhZ6rlPhHOZcWyjXALlAthrENvRTvQ=' using alias 'key'.</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>--encrypt</code> action is used with the <code>credential-store</code> command, the argument to this action is the alias of the secret key to use.  In this form the tool will prompt
twice for the clear text which is being encrypted.  When using the command line tool the output is just the Base64 encoded encrypted ciphertext.  To use this in the management model
it will need to be included in an expression as described earlier i.e. using the appropriate prefix and if required resolver name.</p>
</div>
<div class="paragraph">
<p>When using the <code>--encrypt</code> action it is also possible to pass in <code>--clear-text</code> parameter to pass in the clear text directly but this may be visible to other users and may also
be cached in the command history of your shell.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_domain_mode"><a class="anchor" href="#_domain_mode"></a>18.3. Domain Mode</h3>
<div class="paragraph">
<p>When using encrypted expressions in domain mode things are slightly different to how the legacy vault may have been used in the past.</p>
</div>
<div class="paragraph">
<p>To make use of encrypted expressions in the host controller configuration the <code>expression=encryption</code> resource and relevant <code>*credential-store</code> definitions must be defined
within the <code>elytron</code> subsystem definition of the host controller i.e. in the same <code>host.xml</code> configuration.</p>
</div>
<div class="paragraph">
<p>For expressions within a domain profile being used to configure one or more servers the <code>expression=encryption</code> resource and relevant <code>*credential-store</code> definitions must be defined within the <code>elytron</code> subsystem
definition of the same profile.</p>
</div>
<div class="paragraph">
<p>The runtime management operations are not supported against the <code>expression=encryption</code> or <code>*credential-store</code> when defined within a domain profile so for these environments the credential store and relevant
expressions should be created offline before defining in the model.  It is possible to reference a common credential store file shared between the host controller management model and the domain profile but after making
any updates to the credential store from the host controller the application server processes will need to be restarted to force them to reload the credential store.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="Custom_Components"><a class="anchor" href="#Custom_Components"></a>19. Custom Components</h2>
<div class="sectionbody">
<div class="paragraph">
<p>WildFly Elytron subsystem allows adding custom implementation of different
components in form of WildFly modules into the WildFly instance and use them
by the same way as built-in Elytron subsystem components.
For example, you can create custom security event listener to develop custom
audit mechanisms and store information about user authentication attempts in
custom storage structure. Or you can create custom security realm to
authenticate users against your own identities storage.</p>
</div>
<div class="paragraph">
<p>To find what types of custom components you can implement you can use Tab
completion:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>[standalone@localhost:9990 /] /subsystem=elytron/custom-
custom-credential-security-factory  custom-realm
custom-evidence-decoder             custom-realm-mapper
custom-modifiable-realm             custom-role-decoder
custom-permission-mapper            custom-role-mapper
custom-principal-decoder            custom-security-event-listener
custom-principal-transformer</pre>
</div>
</div>
<div class="sect2">
<h3 id="_security_event_listener"><a class="anchor" href="#_security_event_listener"></a>19.1. Security event listener</h3>
<div class="paragraph">
<p>This section describes how to add a custom security event listener. Similar steps can be followed to add another
custom component type.</p>
</div>
<div class="paragraph">
<p>To create custom security event listener you need to implement <code>java.util.function.Consumer&lt;org.wildfly.security.auth.server.event.SecurityEvent&gt;</code> interface.
Resulting class needs to be packed into JAR and WildFly module created.
You can create appropriate directory structure and module descriptor manually, or you can use following command of WildFly CLI:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>bin/jboss-cli.sh
module add --name=my.module --resources=my-listener.jar --dependencies=org.wildfly.security.elytron</pre>
</div>
</div>
<div class="paragraph">
<p>Check
<a href="Developer_Guide.html#Class_Loading_in_WildFly">Class loading doc</a>
for more information how to create WildFly module.</p>
</div>
<div class="paragraph">
<p>When appropriate module is on place, you can start using it by adding Elytron subsystem resource:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>/subsystem=elytron/custom-security-event-listener=myListener:add(
        module=my.module, class-name=my.module.MyAuditListener)</pre>
</div>
</div>
<div class="paragraph">
<p>Now you can start to use it as any other security event listener - typically to set it as listener of <code>ApplicationDomain</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>/subsystem=elytron/security-domain=ApplicationDomain:write-attribute(name=security-event-listener, value=myListener)</pre>
</div>
</div>
<div class="paragraph">
<p>After server reload the listener will receive all security events from given security domain.</p>
</div>
</div>
<div class="sect2">
<h3 id="_configurable_custom_components"><a class="anchor" href="#_configurable_custom_components"></a>19.2. Configurable custom components</h3>
<div class="paragraph">
<p>You can also provide some component configuration from the subsystem, if class of your component will implement following method:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>public void initialize(Map&lt;String, String&gt; configuration)</pre>
</div>
</div>
<div class="paragraph">
<p>Afterwards you can provide configuration into your component from the subsystem using attribute <code>configuration</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>/subsystem=elytron/custom-...=my-component:add(module=..., class-name=..., configuration={myAttribute="myValue"})</pre>
</div>
</div>
<div class="paragraph">
<p>After the component construction, the <code>initialize</code> method will be called with the configuration.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="Migrate_Legacy_Security_to_Elytron_Security"><a class="anchor" href="#Migrate_Legacy_Security_to_Elytron_Security"></a>20. Migrate Legacy Security to Elytron Security</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_authentication_configuration"><a class="anchor" href="#_authentication_configuration"></a>20.1. Authentication Configuration</h3>

</div>
<div class="sect2">
<h3 id="Properties_File_Based_Authentication_Migration"><a class="anchor" href="#Properties_File_Based_Authentication_Migration"></a>20.2. Properties Based Authentication / Authorization</h3>
<div class="sect3">
<h4 id="picketbox-based-configuration"><a class="anchor" href="#picketbox-based-configuration"></a>20.2.1. PicketBox Based Configuration</h4>
<div class="paragraph">
<p>This migration example assumes a deployed web application is configured
to require authentication using FORM based authentication and is
referencing a PicketBox based security domain using the
UsersRolesLoginModule to load user information from a pair or properties
files.</p>
</div>
<div class="sect4">
<h5 id="original-configuration"><a class="anchor" href="#original-configuration"></a>Original Configuration</h5>
<div class="paragraph">
<p>A security domain can be defined in the legacy security subsystem using
the following management operations: -</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>./subsystem=security/security-domain=application-security:add
./subsystem=security/security-domain=application-security/authentication=classic:add(login-modules=[{code=UsersRoles, flag=Required, module-options={usersProperties=file://${jboss.server.config.dir}/example-users.properties, rolesProperties=file://${jboss.server.config.dir}/example-roles.properties}}])</code></pre>
</div>
</div>
<div class="paragraph">
<p>This would result in a security domain definition: -</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">  &lt;security-domain name="application-security"&gt;
    &lt;authentication&gt;
      &lt;login-module code="UsersRoles" flag="required"&gt;
        &lt;module-option name="usersProperties" value="file://${jboss.server.config.dir}/example-users.properties"/&gt;
        &lt;module-option name="rolesProperties" value="file://${jboss.server.config.dir}/example-roles.properties"/&gt;
      &lt;/login-module&gt;
    &lt;/authentication&gt;
  &lt;/security-domain&gt;</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="intermediate-configuration"><a class="anchor" href="#intermediate-configuration"></a>Intermediate Configuration</h5>
<div class="paragraph">
<p>It is possible to take a previously defined PicketBox security domain
and expose it as an Elytron security realm so it can be wired into a
complete Elytron based configuration, if only properties based
authentication was to be migrated it would be recommended to jump to the
fully migration configuration and avoid the unnecessary dependency on
the legacy security subsystem but for situations where that is not
immediately possible these commands illustrate an intermediate solution.</p>
</div>
<div class="paragraph">
<p>These steps assume the original configuration is already in place.</p>
</div>
<div class="paragraph">
<p>The first step is to add a mapping to an Elytron security realm within
the legacy security subsystem.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>./subsystem=security/elytron-realm=application-security:add(legacy-jaas-config=application-security)</code></pre>
</div>
</div>
<div class="paragraph">
<p>This results in the following configuration.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">  &lt;subsystem xmlns="urn:jboss:domain:security:2.0"&gt;
    ...
    &lt;elytron-integration&gt;
      &lt;security-realms&gt;
        &lt;elytron-realm name="application-security" legacy-jaas-config="application-security"/&gt;
      &lt;/security-realms&gt;
    &lt;/elytron-integration&gt;
    ...
  &lt;/subsystem&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Within the Elytron subsystem a security domain can be defined which
references the exported security realm and also a http authentication
factory which supports FORM based authentication.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>./subsystem=elytron/security-domain=application-security:add(realms=[{realm=application-security}], default-realm=application-security, permission-mapper=default-permission-mapper)
./subsystem=elytron/http-authentication-factory=application-security-http:add(http-server-mechanism-factory=global, security-domain=application-security, mechanism-configurations=[{mechanism-name=FORM}])</code></pre>
</div>
</div>
<div class="paragraph">
<p>And the resulting configuration: -</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">  &lt;subsystem xmlns="urn:wildfly:elytron:1.0" final-providers="combined-providers" disallowed-providers="OracleUcrypto"&gt;
    ...
    &lt;security-domains&gt;
      ...
      &lt;security-domain name="application-security" default-realm="application-security" permission-mapper="default-permission-mapper"&gt;
        &lt;realm name="application-security"/&gt;
      &lt;/security-domain&gt;
    &lt;/security-domains&gt;
    ...
    &lt;http&gt;
      ...
      &lt;http-authentication-factory name="application-security-http" http-server-mechanism-factory="global" security-domain="application-security"&gt;
        &lt;mechanism-configuration&gt;
          &lt;mechanism mechanism-name="FORM"/&gt;
        &lt;/mechanism-configuration&gt;
      &lt;/http-authentication-factory&gt;
      ...
    &lt;/http&gt;
    ...
  &lt;/subsystem&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Finally configuration needs to be added to the Undertow subsystem to map
the security domain referenced by the deployment to the newly defined
http authentication factory.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>./subsystem=undertow/application-security-domain=application-security:add(http-authentication-factory=application-security-http)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Which results in: -</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">  &lt;subsystem xmlns="urn:jboss:domain:undertow:4.0"&gt;
    ...
    &lt;application-security-domains&gt;
      &lt;application-security-domain name="application-security" http-authentication-factory="application-security-http"/&gt;
    &lt;/application-security-domains&gt;
    ...
  &lt;/subsystem&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note: If the deployment was already deployed at this point the
application server should be reloaded or the deployment redeployed for
the application security domain mapping to take effect.</em></p>
</div>
<div class="paragraph">
<p>The following command can then be used to verify the mapping was applied
to the deployment.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>[standalone@localhost:9990 /] ./subsystem=undertow/application-security-domain=application-security:read-resource(include-runtime=true)
{
    "outcome" =&gt; "success",
    "result" =&gt; {
        "enable-jacc" =&gt; false,
        "http-authentication-factory" =&gt; "application-security-http",
        "override-deployment-config" =&gt; false,
        "referencing-deployments" =&gt; ["HelloWorld.war"],
        "setting" =&gt; undefined
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The deployment being tested here is 'HelloWorld.war' and the output from
the previous command shows this deployment is referencing the mapping.</p>
</div>
<div class="paragraph">
<p>At this stage the previously defined security domain is used for it&#8217;s
LoginModule configuration but this is wrapped by Elytron components
which take over authentication.</p>
</div>
</div>
<div class="sect4">
<h5 id="fully-migrated-configuration"><a class="anchor" href="#fully-migrated-configuration"></a>Fully Migrated Configuration</h5>
<div class="paragraph">
<p>Alternatively the configuration can be completely defined within the
Elytron subsystem, in this case it is assumed none of the previous
commands have been executed and this is started from a clean
configuration - however if the security domain definition does exist in
the legacy security subsystem that will remain completely independent.</p>
</div>
<div class="paragraph">
<p>First a new security realm can be defined within the Elytron subsystem
referencing the files referenced previously: -</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>./subsystem=elytron/properties-realm=application-properties:add(users-properties={path=example-users.properties, relative-to=jboss.server.config.dir, plain-text=true, digest-realm-name="Application Security"}, groups-properties={path=example-roles.properties, relative-to=jboss.server.config.dir}, groups-attribute=Roles)</code></pre>
</div>
</div>
<div class="paragraph">
<p>As before a security domain and http authentication factory can be
defined.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>./subsystem=elytron/security-domain=application-security:add(realms=[{realm=application-properties}], default-realm=application-properties, permission-mapper=default-permission-mapper)
./subsystem=elytron/http-authentication-factory=application-security-http:add(http-server-mechanism-factory=global, security-domain=application-security, mechanism-configurations=[{mechanism-name=FORM}])</code></pre>
</div>
</div>
<div class="paragraph">
<p>This results in the following overall configuration.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">  &lt;subsystem xmlns="urn:wildfly:elytron:1.0" final-providers="combined-providers" disallowed-providers="OracleUcrypto"&gt;
    ...
    &lt;security-domains&gt;
      ...
      &lt;security-domain name="application-security" default-realm="application-properties" permission-mapper="default-permission-mapper"&gt;
        &lt;realm name="application-properties"/&gt;
      &lt;/security-domain&gt;
    &lt;/security-domains&gt;
    &lt;security-realms&gt;
      ...
      &lt;properties-realm name="application-properties" groups-attribute="Roles"&gt;
        &lt;users-properties path="example-users.properties" relative-to="jboss.server.config.dir" digest-realm-name="Application Security" plain-text="true"/&gt;
        &lt;groups-properties path="example-roles.properties" relative-to="jboss.server.config.dir"/&gt;
      &lt;/properties-realm&gt;
    &lt;/security-realms&gt;
    ...
    &lt;http&gt;
      ...
      &lt;http-authentication-factory name="application-security-http" http-server-mechanism-factory="global" security-domain="application-security"&gt;
        &lt;mechanism-configuration&gt;
          &lt;mechanism mechanism-name="FORM"/&gt;
        &lt;/mechanism-configuration&gt;
      &lt;/http-authentication-factory&gt;
      ...
    &lt;/http&gt;
    ...
  &lt;/subsystem&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>As before the application-security-domain mapping should be added to the
Undertow subsystem and the server reloaded or the deployment redeployed
as required.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>./subsystem=undertow/application-security-domain=application-security:add(http-authentication-factory=application-security-http)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Which results in: -</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">  &lt;subsystem xmlns="urn:jboss:domain:undertow:4.0"&gt;
    ...
    &lt;application-security-domains&gt;
      &lt;application-security-domain name="application-security" http-authentication-factory="application-security-http"/&gt;
    &lt;/application-security-domains&gt;
    ...
  &lt;/subsystem&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>At this stage the authentication is the equivalent of the original
configuration however now Elytron components are used exclusively.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="FileSystemRealm_Based_Authentication_Migration"><a class="anchor" href="#FileSystemRealm_Based_Authentication_Migration"></a>20.2.2. Migrating to FileSystemRealm Based Authentication</h4>
<div class="paragraph">
<p>An alternative to using a legacy properties-realm in Elytron is to use
the new filesystem-realm. An Elytron filesystem-realm will use file-backed
authentication methods to secure the server. It is now easy to migrate from a
legacy properties-realm to an Elytron filesystem-realm by using the
Elytron Tool. The new Elytron Tool command, FileSystemRealmCommand, will convert
the given properties files and create an Elytron FileSystemRealm, along with a script
with the WildFly CLI commands for registering the FileSystemRealm and Security Domain
on the WildFly server. After using the tool, it will still be necessary to configure
an authentication-factory and an application-security-domain, as in the steps
above.</p>
</div>
<div class="sect4">
<h5 id="filesystem-realm-single-conversion"><a class="anchor" href="#filesystem-realm-single-conversion"></a>Single User-Roles Conversion</h5>
<div class="paragraph">
<p>To convert a single user-roles properties files combination, the parameters
can be passed directly into the command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">./bin/elytron-tool.sh filesystem-realm --users-file users.properties --roles-file roles.properties --output-location filesystem_realm_dir</code></pre>
</div>
</div>
<div class="paragraph">
<p>This will then configure a filesystem-realm in filesystem_realm_dir and
will create a script converted-properties-filesystem-realm.sh in
filesystem_realm_dir with the WildFly CLI commands to register the filesystem-realm
and the security-domain, with the security-domain named
converted-properties-security-domain. To customize the filesystem-realm name
and the security-domain name, the --filesystem-realm-name and
--security-domain-name parameters can be used.</p>
</div>
<div class="paragraph">
<p>Use elytron-tool.sh filesystem-realm --help to get description of all parameters.</p>
</div>
<div class="sect5">
<h6 id="filesystem_realm_single_notes"><a class="anchor" href="#filesystem_realm_single_notes"></a>Notes:</h6>
<div class="ulist">
<ul>
<li>
<p>The short form options, as shown in the --help option, can be used, such as
-u in place of --users-file.</p>
</li>
<li>
<p>When the --summary parameter is specified, an output of operations performed
during conversion, including warnings and errors, will be shown once the
command finishes conversion.</p>
</li>
<li>
<p>When the --silent parameter is specified, Elytron Tool will not give no
information output, as compared to normal operation where warnings are shown.
The --silent command will not override --summary, resulting in the ability to
hide output until the command finishes conversion.</p>
</li>
<li>
<p>Elytron Tool will not configure the filesystem-realm and security-domain
within WildFly itself, it will just provide the necessary commands in the
output script file.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect4">
<h5 id="filesystem-realm-bulk-conversion"><a class="anchor" href="#filesystem-realm-bulk-conversion"></a>Bulk User-Roles Conversion</h5>
<div class="paragraph">
<p>It is possible to convert multiple users-roles files combinations at once
by using --bulk-convert parameter with a descriptor file.</p>
</div>
<div class="paragraph">
<p>An example descriptor-file from our tests is:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-text hljs" data-lang="text">users-file:/home/jucook/Documents/WildFly/Git_Projects/WildFly-Elytron/wildfly-elytron-tool/target/test-classes/filesystem-realm/users/users-5.properties
roles-file:/home/jucook/Documents/WildFly/Git_Projects/WildFly-Elytron/wildfly-elytron-tool/target/test-classes/filesystem-realm/roles/roles-5.properties
output-location:./target/test-classes/filesystem-realm/output-5-bulk
filesystem-realm-name:nameOfFileSystemRealm5
security-domain-name:nameOfSecurityDomain5

users-file:/home/jucook/Documents/WildFly/Git_Projects/WildFly-Elytron/wildfly-elytron-tool/target/test-classes/filesystem-realm/users/users-6.properties
roles-file:/home/jucook/Documents/WildFly/Git_Projects/WildFly-Elytron/wildfly-elytron-tool/target/test-classes/filesystem-realm/roles/roles-6.properties
output-location:/home/jucook/Documents/WildFly/Git_Projects/WildFly-Elytron/wildfly-elytron-tool/target/test-classes/filesystem-realm/output-6-bulk
filesystem-realm-name:nameOfFileSystemRealm6
security-domain-name:nameOfSecurityDomain6</code></pre>
</div>
</div>
<div class="paragraph">
<p>Each blank line starts a new conversion operation. As with a single conversion,
the users-file, roles-file, and output-location are required parameters while
the filesystem-realm-name and security-domain-name are optional parameters.</p>
</div>
<div class="paragraph">
<p>Execute the following command to convert with the descriptor file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">./bin/elytron-tool.sh filesystem-realm --bulk-convert descriptor-file</code></pre>
</div>
</div>
<div class="sect5">
<h6 id="filesystem_realm_bulk_notes"><a class="anchor" href="#filesystem_realm_bulk_notes"></a>Notes:</h6>
<div class="ulist">
<ul>
<li>
<p>For bulk conversion, only the long form option can be used, unlike the CLI
mode where both long and short form options can be used.</p>
</li>
<li>
<p>The --summary and --silent parameters can be used here too. However, they
must be specified while executing the command and apply to all conversions
specified in the descriptor file.</p>
</li>
<li>
<p>If the --summary parameter is used, then a summary will be provided
after each execution as opposed to after the command finishes all conversions.</p>
</li>
<li>
<p>As with the single conversion, absolute or relative paths can be used for
users-file, roles-file, and output-location.</p>
</li>
<li>
<p>Each execution of the command will produce a separate script in the given
output-location directory.</p>
</li>
<li>
<p>Repeated output-location paths can result in an error</p>
</li>
<li>
<p>If there is an error in one users-roles files combination then Elytron Tool
will report the issue, such as a missing required parameter, and continue
with the conversion of all remaining combinations.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="legacy-security-realm"><a class="anchor" href="#legacy-security-realm"></a>20.2.3. Legacy Security Realm</h4>
<div class="sect4">
<h5 id="original-configuration-1"><a class="anchor" href="#original-configuration-1"></a>Original Configuration</h5>
<div class="paragraph">
<p>A legacy security realm can be defined using the following commands to
load users passwords and group information from properties files.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>./core-service=management/security-realm=ApplicationSecurity:add
./core-service=management/security-realm=ApplicationSecurity/authentication=properties:add(relative-to=jboss.server.config.dir, path=example-users.properties, plain-text=true)
./core-service=management/security-realm=ApplicationSecurity/authorization=properties:add(relative-to=jboss.server.config.dir, path=example-roles.properties)</code></pre>
</div>
</div>
<div class="paragraph">
<p>This results in the following realm definition.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">  &lt;security-realm name="ApplicationSecurity"&gt;
    &lt;authentication&gt;
      &lt;properties path="example-users.properties" relative-to="jboss.server.config.dir" plain-text="true"/&gt;
    &lt;/authentication&gt;
    &lt;authorization&gt;
      &lt;properties path="example-roles.properties" relative-to="jboss.server.config.dir"/&gt;
    &lt;/authorization&gt;
  &lt;/security-realm&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>A legacy security realm would typically be used to secure either the
management interfaces or remoting connectors.</p>
</div>
</div>
<div class="sect4">
<h5 id="migrated-configuration"><a class="anchor" href="#migrated-configuration"></a>Migrated Configuration</h5>
<div class="paragraph">
<p>One of the motivations for adding the Elytron based security to the
application server is to allow a consistent security solution to be used
across the server, to replace the security realm the same steps as
described in the previous 'Fully Migrated' section can be followed again
up until the http-authentication-factory is defined.</p>
</div>
<div class="paragraph">
<p>A legacy security realm can also be used for SASL based authentication
so a sasl-authentication-factory should also be defined.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>./subsystem=elytron/sasl-authentication-factory=application-security-sasl:add(sasl-server-factory=elytron, security-domain=application-security, mechanism-configurations=[{mechanism-name=PLAIN}])</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">  &lt;subsystem xmlns="urn:wildfly:elytron:1.0" final-providers="combined-providers" disallowed-providers="OracleUcrypto"&gt;
    ...
    &lt;sasl&gt;
      ...
      &lt;sasl-authentication-factory name="application-security-sasl" sasl-server-factory="elytron" security-domain="application-security"&gt;
        &lt;mechanism-configuration&gt;
          &lt;mechanism mechanism-name="PLAIN"/&gt;
        &lt;/mechanism-configuration&gt;
      &lt;/sasl-authentication-factory&gt;
      ...
    &lt;/sasl&gt;
  &lt;/subsystem&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>This can be associated with a Remoting connector to use for
authentication and the existing security realm reference cleared.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>./subsystem=remoting/http-connector=http-remoting-connector:write-attribute(name=sasl-authentication-factory, value=application-security-sasl)
./subsystem=remoting/http-connector=http-remoting-connector:undefine-attribute(name=security-realm)</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">  &lt;subsystem xmlns="urn:jboss:domain:remoting:4.0"&gt;
    ...
    &lt;http-connector name="http-remoting-connector" connector-ref="default" sasl-authentication-factory="application-security-sasl"/&gt;
  &lt;/subsystem&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>If this new configuration was to be used to secure the management
interfaces more suitable names should be chosen but the following
commands illustrate how to set the two authentication factories and
clear the existing security realm reference.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>./core-service=management/management-interface=http-interface:write-attribute(name=http-authentication-factory, value=application-security-http)
./core-service=management/management-interface=http-interface:write-attribute(name=http-upgrade.sasl-authentication-factory, value=application-security-sasl)
./core-service=management/management-interface=http-interface:undefine-attribute(name=security-realm)</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">  &lt;management-interfaces&gt;
    &lt;http-interface http-authentication-factory="application-security-http"&gt;
      &lt;http-upgrade enabled="true" sasl-authentication-factory="application-security-sasl"/&gt;
      &lt;socket-binding http="management-http"/&gt;
    &lt;/http-interface&gt;
  &lt;/management-interfaces&gt;</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="LDAP_Based_Authentication_Migration"><a class="anchor" href="#LDAP_Based_Authentication_Migration"></a>20.3. LDAP Authentication Migration</h3>
<div class="paragraph">
<p>The section describing how to migrate from properties based
authentication using either PicketBox or legacy security realms to
Elytron also contained a lot of additional information regarding
defining security domains, authentication factories, and how these are
mapped to be used for authentication. This section will illustrate some
equivalent LDAP configuration using legacy security realms and PicketBox
security domains and show the equivalent configuration using Elytron but
will not repeat the steps to wire it all together covered in the
previous section.</p>
</div>
<div class="paragraph">
<p>These configuration examples are developed against a test LDAP sever
with user entries like: -</p>
</div>
<div class="literalblock">
<div class="content">
<pre>dn: uid=TestUserOne,ou=users,dc=group-to-principal,dc=wildfly,dc=org
objectClass: top
objectClass: inetOrgPerson
objectClass: uidObject
objectClass: person
objectClass: organizationalPerson
cn: Test User One
sn: Test User One
uid: TestUserOne
userPassword: {SSHA}UG8ov2rnrnBKakcARVvraZHqTa7mFWJZlWt2HA==</pre>
</div>
</div>
<div class="paragraph">
<p>The group entries then look like: -</p>
</div>
<div class="literalblock">
<div class="content">
<pre>dn: uid=GroupOne,ou=groups,dc=group-to-principal,dc=wildfly,dc=org
objectClass: top
objectClass: groupOfUniqueNames
objectClass: uidObject
cn: Group One
uid: GroupOne
uniqueMember: uid=TestUserOne,ou=users,dc=group-to-principal,dc=wildfly,dc=org</pre>
</div>
</div>
<div class="paragraph">
<p>For authentication purposes the username will be matched against the
'uid' attribute, also the resulting group name will be taken from the
'uid' attribute of the group entry.</p>
</div>
<div class="sect3">
<h4 id="legacy-security-realm-ldap"><a class="anchor" href="#legacy-security-realm-ldap"></a>20.3.1. Legacy Security Realm</h4>
<div class="paragraph">
<p>A connection to the LDAP server and related security realm can be
created with the following commands: -</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>batch
./core-service=management/ldap-connection=MyLdapConnection:add(url="ldap://localhost:10389", search-dn="uid=admin,ou=system", search-credential="secret")

./core-service=management/security-realm=LDAPRealm:add
./core-service=management/security-realm=LDAPRealm/authentication=ldap:add(connection="MyLdapConnection", username-attribute=uid, base-dn="ou=users,dc=group-to-principal,dc=wildfly,dc=org")


./core-service=management/security-realm=LDAPRealm/authorization=ldap:add(connection=MyLdapConnection)
./core-service=management/security-realm=LDAPRealm/authorization=ldap/username-to-dn=username-filter:add(attribute=uid, base-dn="ou=users,dc=group-to-principal,dc=wildfly,dc=org")
./core-service=management/security-realm=LDAPRealm/authorization=ldap/group-search=group-to-principal:add(base-dn="ou=groups,dc=group-to-principal,dc=wildfly,dc=org", iterative=true, prefer-original-connection=true, principal-attribute=uniqueMember, search-by=DISTINGUISHED_NAME, group-name=SIMPLE, group-name-attribute=uid)
run-batch</code></pre>
</div>
</div>
<div class="paragraph">
<p>This results in the following configuration.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">  &lt;management&gt;
    &lt;security-realms&gt;
      ...
      &lt;security-realm name="LDAPRealm"&gt;
        &lt;authentication&gt;
          &lt;ldap connection="MyLdapConnection" base-dn="ou=users,dc=group-to-principal,dc=wildfly,dc=org"&gt;
            &lt;username-filter attribute="uid"/&gt;
          &lt;/ldap&gt;
        &lt;/authentication&gt;
        &lt;authorization&gt;
          &lt;ldap connection="MyLdapConnection"&gt;
            &lt;username-to-dn&gt;
              &lt;username-filter base-dn="ou=users,dc=group-to-principal,dc=wildfly,dc=org" attribute="uid"/&gt;
            &lt;/username-to-dn&gt;
            &lt;group-search group-name="SIMPLE" iterative="true" group-name-attribute="uid"&gt;
              &lt;group-to-principal search-by="DISTINGUISHED_NAME" base-dn="ou=groups,dc=group-to-principal,dc=wildfly,dc=org" prefer-original-connection="true"&gt;
                &lt;membership-filter principal-attribute="uniqueMember"/&gt;
              &lt;/group-to-principal&gt;
            &lt;/group-search&gt;
          &lt;/ldap&gt;
        &lt;/authorization&gt;
      &lt;/security-realm&gt;
    &lt;/security-realms&gt;
    &lt;outbound-connections&gt;
      &lt;ldap name="MyLdapConnection" url="ldap://localhost:10389" search-dn="uid=admin,ou=system" search-credential="secret"/&gt;
    &lt;/outbound-connections&gt;
    ...
  &lt;/management&gt;</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="picketbox-ldapextloginmodule"><a class="anchor" href="#picketbox-ldapextloginmodule"></a>20.3.2. PicketBox LdapExtLoginModule</h4>
<div class="paragraph">
<p>The following commands can create a PicketBox security domain configured
to use the LdapExtLoginModule to verify a username and password.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>./subsystem=security/security-domain=application-security:add
./subsystem=security/security-domain=application-security/authentication=classic:add(login-modules=[{code=LdapExtended, flag=Required, module-options={ \
java.naming.factory.initial=com.sun.jndi.ldap.LdapCtxFactory, \
java.naming.provider.url=ldap://localhost:10389, \
java.naming.security.authentication=simple, \
bindDN="uid=admin,ou=system", \
bindCredential=secret, \
baseCtxDN="ou=users,dc=group-to-principal,dc=wildfly,dc=org", \
baseFilter="(uid={0})", \
rolesCtxDN="ou=groups,dc=group-to-principal,dc=wildfly,dc=org",\
roleFilter="(uniqueMember={1})", \
roleAttributeID="uid" \
}}])</code></pre>
</div>
</div>
<div class="paragraph">
<p>This results in the following configuration.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">  &lt;subsystem xmlns="urn:jboss:domain:security:2.0"&gt;
    ...
    &lt;security-domains&gt;
      ...
      &lt;security-domain name="application-security"&gt;
        &lt;authentication&gt;
          &lt;login-module code="LdapExtended" flag="required"&gt;
            &lt;module-option name="java.naming.factory.initial" value="com.sun.jndi.ldap.LdapCtxFactory"/&gt;
            &lt;module-option name="java.naming.provider.url" value="ldap://localhost:10389"/&gt;
            &lt;module-option name="java.naming.security.authentication" value="simple"/&gt;
            &lt;module-option name="bindDN" value="uid=admin,ou=system"/&gt;
            &lt;module-option name="bindCredential" value="secret"/&gt;
            &lt;module-option name="baseCtxDN" value="ou=users,dc=group-to-principal,dc=wildfly,dc=org"/&gt;
            &lt;module-option name="baseFilter" value="(uid={0})"/&gt;
            &lt;module-option name="rolesCtxDN" value="ou=groups,dc=group-to-principal,dc=wildfly,dc=org"/&gt;
            &lt;module-option name="roleFilter" value="(uniqueMember={1})"/&gt;
            &lt;module-option name="roleAttributeID" value="uid"/&gt;
          &lt;/login-module&gt;
        &lt;/authentication&gt;
      &lt;/security-domain&gt;
    &lt;/security-domains&gt;
  &lt;/subsystem&gt;</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="migrated"><a class="anchor" href="#migrated"></a>20.3.3. Migrated</h4>
<div class="paragraph">
<p>Within the Elytron subsystem a directory context can be defined for the
connection to LDAP: -</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>./subsystem=elytron/dir-context=ldap-connection:add(url=ldap://localhost:10389, principal="uid=admin,ou=system", credential-reference={clear-text=secret})</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then a security realm can be created to search LDAP and verify the
supplied password: -</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>./subsystem=elytron/ldap-realm=ldap-realm:add(dir-context=ldap-connection, \
direct-verification=true, \
identity-mapping={search-base-dn="ou=users,dc=group-to-principal,dc=wildfly,dc=org", \
rdn-identifier="uid", \
attribute-mapping=[{filter-base-dn="ou=groups,dc=group-to-principal,dc=wildfly,dc=org",filter="(uniqueMember={1})",from="uid",to="Roles"}]})</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the prior two examples information is loaded from LDAP to use
directly as groups or roles, in the Elytron case information can be
loaded from LDAP to associate with the identity as attributes - these
can subsequently be mapped to roles but attributes can be loaded for
other purposes as well.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
By default, if no <code>role-decoder</code> is defined for given <code>security-domain</code>,
identity attribute " `Roles`" is mapped to the identity roles.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>This leads to the following configuration.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">  &lt;subsystem xmlns="urn:wildfly:elytron:1.0" final-providers="combined-providers" disallowed-providers="OracleUcrypto"&gt;
    ...
    &lt;security-realms&gt;
      ...
      &lt;ldap-realm name="ldap-realm" dir-context="ldap-connection" direct-verification="true"&gt;
        &lt;identity-mapping rdn-identifier="uid" search-base-dn="ou=users,dc=group-to-principal,dc=wildfly,dc=org"&gt;
          &lt;attribute-mapping&gt;
            &lt;attribute from="uid" to="Roles" filter="(uniqueMember={1})" filter-base-dn="ou=groups,dc=group-to-principal,dc=wildfly,dc=org"/&gt;
          &lt;/attribute-mapping&gt;
        &lt;/identity-mapping&gt;
      &lt;/ldap-realm&gt;
    &lt;/security-realms&gt;
    ...
    &lt;dir-contexts&gt;
      &lt;dir-context name="ldap-connection" url="ldap://localhost:10389" principal="uid=admin,ou=system"&gt;
        &lt;credential-reference clear-text="secret"/&gt;
      &lt;/dir-context&gt;
    &lt;/dir-contexts&gt;
  &lt;/subsystem&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="Composite_Stores_Migration"><a class="anchor" href="#Composite_Stores_Migration"></a>20.4. Composite Stores Migration</h3>
<div class="paragraph">
<p>When using either PicketBox or the legacy security realms it is possible to define a configuration where authentication is performed against one identity store whilst the information used for authorization is loaded from a different store, when using WildFly Elytron this can be achieved by using an aggregate security realm.</p>
</div>
<div class="paragraph">
<p>The example here makes use of a properties file for authentication and then searches LDAP to load group / role information. Both of these are based on the previous examples within this document so the environmental information is not repeated here.</p>
</div>
<div class="sect3">
<h4 id="_picketbox_based_configuration"><a class="anchor" href="#_picketbox_based_configuration"></a>20.4.1. PicketBox Based Configuration</h4>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>./subsystem=security/security-domain=application-security:add
./subsystem=security/security-domain=application-security/authentication=classic:add(login-modules=[ \
{code=UsersRoles, flag=Required, module-options={ \
password-stacking=useFirstPass, \
usersProperties=file://${jboss.server.config.dir}/example-users.properties, \
rolesProperties=file://${jboss.server.config.dir}/example-roles.properties}} \
{code=LdapExtended, flag=Required, module-options={ \
password-stacking=useFirstPass, \
java.naming.factory.initial=com.sun.jndi.ldap.LdapCtxFactory, \
java.naming.provider.url=ldap://localhost:10389, \
java.naming.security.authentication=simple, \
bindDN="uid=admin,ou=system", \
bindCredential=secret, \
baseCtxDN="ou=users,dc=group-to-principal,dc=wildfly,dc=org", \
baseFilter="(uid={0})", \
rolesCtxDN="ou=groups,dc=group-to-principal,dc=wildfly,dc=org",\
roleFilter="(uniqueMember={1})", \
roleAttributeID="uid" \
}}])</code></pre>
</div>
</div>
<div class="paragraph">
<p>This results in the following domain definition</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;security-domain name="application-security"&gt;
  &lt;authentication&gt;
    &lt;login-module code="UsersRoles" flag="required"&gt;
      &lt;module-option name="password-stacking" value="useFirstPass"/&gt;
      &lt;module-option name="usersProperties" value="file://${jboss.server.config.dir}/example-users.properties"/&gt;
      &lt;module-option name="rolesProperties" value="file://${jboss.server.config.dir}/example-roles.properties"/&gt;
    &lt;/login-module&gt;
    &lt;login-module code="LdapExtended" flag="required"&gt;
      &lt;module-option name="password-stacking" value="useFirstPass"/&gt;
      &lt;module-option name="java.naming.factory.initial" value="com.sun.jndi.ldap.LdapCtxFactory"/&gt;
      &lt;module-option name="java.naming.provider.url" value="ldap://localhost:10389"/&gt;
      &lt;module-option name="java.naming.security.authentication" value="simple"/&gt;
      &lt;module-option name="bindDN" value="uid=admin,ou=system"/&gt;
      &lt;module-option name="bindCredential" value="secret"/&gt;
      &lt;module-option name="baseCtxDN" value="ou=users,dc=group-to-principal,dc=wildfly,dc=org"/&gt;
      &lt;module-option name="baseFilter" value="(uid={0})"/&gt;
      &lt;module-option name="rolesCtxDN" value="ou=groups,dc=group-to-principal,dc=wildfly,dc=org"/&gt;
      &lt;module-option name="roleFilter" value="(uniqueMember={1})"/&gt;
      &lt;module-option name="roleAttributeID" value="uid"/&gt;
    &lt;/login-module&gt;
  &lt;/authentication&gt;
&lt;/security-domain&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>During an authentication attempt the 'UsersRoles' login module will first be called to perform authentication based on the supplied credential, then the 'LdapExtLoginModule' will be called which will proceed to query LDAP to load the roles for the identity.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>./core-service=management/ldap-connection=MyLdapConnection:add(url="ldap://localhost:10389", search-dn="uid=admin,ou=system", search-credential="secret")

./core-service=management/security-realm=ApplicationSecurity:add
./core-service=management/security-realm=ApplicationSecurity/authentication=properties:add(path=example-users.properties, relative-to=jboss.server.config.dir, plain-text=true)

batch
./core-service=management/security-realm=ApplicationSecurity/authorization=ldap:add(connection=MyLdapConnection)
./core-service=management/security-realm=ApplicationSecurity/authorization=ldap/username-to-dn=username-filter:add(attribute=uid, base-dn="ou=users,dc=group-to-principal,dc=wildfly,dc=org")
./core-service=management/security-realm=ApplicationSecurity/authorization=ldap/group-search=group-to-principal:add(base-dn="ou=groups,dc=group-to-principal,dc=wildfly,dc=org", iterative=true, prefer-original-connection=true, principal-attribute=uniqueMember, search-by=DISTINGUISHED_NAME, group-name=SIMPLE, group-name-attribute=uid)
run-batch</code></pre>
</div>
</div>
<div class="paragraph">
<p>This results in the following realm definition:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;security-realm name="ApplicationSecurity"&gt;
  &lt;authentication&gt;
    &lt;properties path="example-users.properties" relative-to="jboss.server.config.dir" plain-text="true"/&gt;
  &lt;/authentication&gt;
  &lt;authorization&gt;
    &lt;ldap connection="MyLdapConnection"&gt;
      &lt;username-to-dn&gt;
        &lt;username-filter base-dn="ou=users,dc=group-to-principal,dc=wildfly,dc=org" attribute="uid"/&gt;
      &lt;/username-to-dn&gt;
      &lt;group-search group-name="SIMPLE" iterative="true" group-name-attribute="uid"&gt;
        &lt;group-to-principal search-by="DISTINGUISHED_NAME" base-dn="ou=groups,dc=group-to-principal,dc=wildfly,dc=org" prefer-original-connection="true"&gt;
          &lt;membership-filter principal-attribute="uniqueMember"/&gt;
        &lt;/group-to-principal&gt;
      &lt;/group-search&gt;
    &lt;/ldap&gt;
  &lt;/authorization&gt;
&lt;/security-realm&gt;

&lt;outbound-connections&gt;
  &lt;ldap name="MyLdapConnection" url="ldap://localhost:10389" search-dn="uid=admin,ou=system" search-credential="secret"/&gt;
&lt;/outbound-connections&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>As with the PicketBox example, authentication is first performed using the properties file - then group searching is performed against LDAP.</p>
</div>
</div>
<div class="sect3">
<h4 id="_migrated_wildfly_elytron_configuration"><a class="anchor" href="#_migrated_wildfly_elytron_configuration"></a>20.4.2. Migrated WildFly Elytron Configuration</h4>
<div class="paragraph">
<p>The equivalent WildFly Elytron configuration can be defined with the following commands:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>./subsystem=elytron/dir-context=ldap-connection:add(url=ldap://localhost:10389, principal="uid=admin,ou=system", credential-reference={clear-text=secret})

./subsystem=elytron/ldap-realm=ldap-realm:add(dir-context=ldap-connection, \
direct-verification=true, \
identity-mapping={search-base-dn="ou=users,dc=group-to-principal,dc=wildfly,dc=org", \
rdn-identifier="uid", \
attribute-mapping=[{filter-base-dn="ou=groups,dc=group-to-principal,dc=wildfly,dc=org",filter="(uniqueMember={1})",from="uid",to="Roles"}]})

./subsystem=elytron/properties-realm=application-properties:add(users-properties={path=example-users.properties, relative-to=jboss.server.config.dir, plain-text=true, digest-realm-name="Application Security"}, groups-properties={path=example-roles.properties, relative-to=jboss.server.config.dir}, groups-attribute=Roles)

./subsystem=elytron/aggregate-realm=combined-realm:add(authentication-realm=application-properties, authorization-realm=ldap-realm)

./subsystem=elytron/security-domain=application-security:add(realms=[{realm=combined-realm}], default-realm=combined-realm, permission-mapper=default-permission-mapper)
./subsystem=elytron/http-authentication-factory=application-security-http:add(http-server-mechanism-factory=global, security-domain=application-security, mechanism-configurations=[{mechanism-name=BASIC}])</code></pre>
</div>
</div>
<div class="paragraph">
<p>This results in the following realm definition:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;subsystem xmlns="urn:wildfly:elytron:1.1" final-providers="combined-providers" disallowed-providers="OracleUcrypto"&gt;
  ...
  &lt;security-domains&gt;
    ...
    &lt;security-domain name="application-security" default-realm="combined-realm" permission-mapper="default-permission-mapper"&gt;
      &lt;realm name="combined-realm"/&gt;
    &lt;/security-domain&gt;
  &lt;/security-domains&gt;
  &lt;security-realms&gt;
    &lt;aggregate-realm name="combined-realm" authentication-realm="application-properties" authorization-realm="ldap-realm"/&gt;
      ...
      &lt;properties-realm name="application-properties" groups-attribute="Roles"&gt;
        &lt;users-properties path="example-users.properties" relative-to="jboss.server.config.dir" digest-realm-name="Application Security" plain-text="true"/&gt;
        &lt;groups-properties path="example-roles.properties" relative-to="jboss.server.config.dir"/&gt;
      &lt;/properties-realm&gt;
      &lt;ldap-realm name="ldap-realm" dir-context="ldap-connection" direct-verification="true"&gt;
        &lt;identity-mapping rdn-identifier="uid" search-base-dn="ou=users,dc=group-to-principal,dc=wildfly,dc=org"&gt;
          &lt;attribute-mapping&gt;
            &lt;attribute from="uid" to="Roles" filter="(uniqueMember={1})" filter-base-dn="ou=groups,dc=group-to-principal,dc=wildfly,dc=org"/&gt;
          &lt;/attribute-mapping&gt;
        &lt;/identity-mapping&gt;
      &lt;/ldap-realm&gt;
  &lt;/security-realms&gt;
  ...
  &lt;http&gt;
    ...
    &lt;http-authentication-factory name="application-security-http" http-server-mechanism-factory="global" security-domain="application-security"&gt;
      &lt;mechanism-configuration&gt;
        &lt;mechanism mechanism-name="BASIC"/&gt;
      &lt;/mechanism-configuration&gt;
    &lt;/http-authentication-factory&gt;
    ...
  &lt;/http&gt;
  ...
  &lt;dir-contexts&gt;
    &lt;dir-context name="ldap-connection" url="ldap://localhost:10389" principal="uid=admin,ou=system"&gt;
      &lt;credential-reference clear-text="secret"/&gt;
    &lt;/dir-context&gt;
  &lt;/dir-contexts&gt;
&lt;/subsystem&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Within the WildFly Elytron example a new security realm 'aggregate-realm' has been defined, this definition specifies which of the defined security realms should be used for the authentication step and which of the security realms should be used for the loading of the identity used for subsequent authorization decisions.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="Database_Authentication_Migration"><a class="anchor" href="#Database_Authentication_Migration"></a>20.5. Database Authentication</h3>
<div class="paragraph">
<p>The section describing how to migrate from database accessible via JDBC
datasource based authentication using PicketBox to Elytron. This section
will illustrate some equivalent configuration using PicketBox security
domains and show the equivalent configuration using Elytron but will not
repeat the steps to wire it all together covered in the previous
sections.</p>
</div>
<div class="paragraph">
<p>These configuration examples are developed against a test database with
users table like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sql hljs" data-lang="sql">CREATE TABLE User (
    id BIGINT NOT NULL,
    username VARCHAR(255),
    password VARCHAR(255),
    role ENUM('admin', 'manager', 'user'),
    PRIMARY KEY (id),
    UNIQUE (username)
)</code></pre>
</div>
</div>
<div class="paragraph">
<p>For authentication purposes the username will be matched against the '
`username&#8217; column, password will be expected in hex-encoded MD5 hash in
' `password&#8217; column. User role for authorization purposes will be taken
from ' `role&#8217; column.</p>
</div>
<div class="sect3">
<h4 id="picketbox-database-loginmodule"><a class="anchor" href="#picketbox-database-loginmodule"></a>20.5.1. PicketBox Database LoginModule</h4>
<div class="paragraph">
<p>The following commands can create a PicketBox security domain configured
to use database accessible via JDBC datasource to verify a username and
password and to assign roles.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>./subsystem=security/security-domain=application-security/:add
./subsystem=security/security-domain=application-security/authentication=classic:add(login-modules=[{code=Database, flag=Required, module-options={ \
    dsJndiName="java:jboss/datasources/ExampleDS", \
    principalsQuery="SELECT password FROM User WHERE username = ?", \
    rolesQuery="SELECT role, 'Roles' FROM User WHERE username = ?", \
    hashAlgorithm=MD5, \
    hashEncoding=base64 \
}}])</code></pre>
</div>
</div>
<div class="paragraph">
<p>This results in the following configuration.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">        &lt;subsystem xmlns="urn:jboss:domain:security:2.0"&gt;
            &lt;security-domains&gt;
                ...
                &lt;security-domain name="application-security"&gt;
                    &lt;authentication&gt;
                        &lt;login-module code="Database" flag="required"&gt;
                            &lt;module-option name="dsJndiName" value="java:jboss/datasources/ExampleDS"/&gt;
                            &lt;module-option name="principalsQuery" value="SELECT password FROM User WHERE username = ?"/&gt;
                            &lt;module-option name="rolesQuery" value="SELECT role, 'Roles' FROM User WHERE username = ?"/&gt;
                            &lt;module-option name="hashAlgorithm" value="MD5"/&gt;
                            &lt;module-option name="hashEncoding" value="base64"/&gt;
                        &lt;/login-module&gt;
                    &lt;/authentication&gt;
                &lt;/security-domain&gt;
            &lt;/security-domains&gt;
        &lt;/subsystem&gt;</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="migrated-jdbc"><a class="anchor" href="#migrated-jdbc"></a>20.5.2. Migrated</h4>
<div class="paragraph">
<p>Within the Elytron subsystem to use database accesible via JDBC you need
to define <code>jdbc-realm</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>./subsystem=elytron/jdbc-realm=jdbc-realm:add(principal-query=[{ \
    data-source=ExampleDS, \
    sql="SELECT role, password FROM User WHERE username = ?", \
    attribute-mapping=[{index=1, to=Roles}] \
    simple-digest-mapper={algorithm=simple-digest-md5, password-index=2}, \
}])</code></pre>
</div>
</div>
<div class="paragraph">
<p>This results in the following overall configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">        &lt;subsystem xmlns="urn:wildfly:elytron:1.0" final-providers="combined-providers" disallowed-providers="OracleUcrypto"&gt;
            ...
            &lt;security-realms&gt;
                ...
                &lt;jdbc-realm name="jdbc-realm"&gt;
                    &lt;principal-query sql="SELECT role, password FROM User WHERE username = ?" data-source="ExampleDS"&gt;
                        &lt;attribute-mapping&gt;
                            &lt;attribute to="Roles" index="1"/&gt;
                        &lt;/attribute-mapping&gt;
                        &lt;simple-digest-mapper password-index="2"/&gt;
                    &lt;/principal-query&gt;
                &lt;/jdbc-realm&gt;
                ...
            &lt;/security-realms&gt;
            ...
        &lt;/subsystem&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>In comparison with PicketBox solution, Elytron <code>jdbc-realm</code> use one SQL
query to obtain all user attributes and credentials. Their extraction
from SQL result specifies mappers.</p>
</div>
</div>
<div class="sect3">
<h4 id="_n_m_relation_beetween_user_and_roles"><a class="anchor" href="#_n_m_relation_beetween_user_and_roles"></a>20.5.3. N-M relation beetween user and roles</h4>
<div class="paragraph">
<p>When using a n:m-relation beetween user and roles (which means: the user has multiple roles), the previous configuration does not work.</p>
</div>
<div class="paragraph">
<p>The database:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sql hljs" data-lang="sql">CREATE TABLE User (
id BIGINT NOT NULL,
username VARCHAR(255),
password VARCHAR(255),
PRIMARY KEY (id),
UNIQUE (username)
)

CREATE TABLE Role(
id BIGINT NOT NULL,
rolename VARCHAR(255),
PRIMARY KEY (id),
UNIQUE (rolename)
)

CREATE TABLE Userrole(
userid BIGINT not null,
roleid BIGINT not null,
PRIMARY KEY (userid, roleid),
FOREIGN KEY (userid) references User(id,
FOREIGN KEY (roleid) references Role(id)
)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Here you need two configure two principal queries:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;jdbc-realm name="jdbc-realm"&gt;
    &lt;principal-query sql="SELECT PASSWORD FROM USER WHERE USERNAME = ?" data-source="ExampleDS"&gt;
        &lt;clear-password-mapper password-index="1"/&gt;
    &lt;/principal-query&gt;
    &lt;principal-query sql="SELECT R.ROLENAME from ROLE AS R, USERROLE AS UR, USER AS U WHERE U.USERNAME=? AND UR.ROLEID = R.ID AND UR.USERID = U.ID" data-source="ExampleDS"&gt;
        &lt;attribute-mapping&gt;
            &lt;attribute to="roles" index="1"/&gt;
        &lt;/attribute-mapping&gt;
    &lt;/principal-query&gt;
&lt;/jdbc-realm&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The second query needs an attribute mapping to decode the selected rolename column (index 1):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;mappers&gt;
...
&lt;simple-role-decoder name="from-roles-attribute" attribute="roles"/&gt;
...
&lt;/mappers&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The role decoder is referenced by the security domain:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;security-domain name="MyDomain" default-realm="jdbc-realm" permission-mapper="default-permission-mapper"&gt;
&lt;realm name="MyDbRealm" role-decoder="from-roles-attribute"/&gt;
&lt;/security-domain&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="Kerberos_Based_Authentication_Migration"><a class="anchor" href="#Kerberos_Based_Authentication_Migration"></a>20.6. Kerberos Authentication Migration</h3>
<div class="paragraph">
<p>When working with Kerberos configuration it is possible for the
application server to rely on configuration from the environment or the
key configuration can be specified using system properties, for the
purpose of these examples I define system properties - these properties
are applicable to both the legacy configuration and the migrated Elytron
configuration.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>./system-property=sun.security.krb5.debug:add(value=true)
./system-property=java.security.krb5.realm:add(value=ELYTRON.ORG)
./system-property=java.security.krb5.kdc:add(value=kdc.elytron.org)</code></pre>
</div>
</div>
<div class="paragraph">
<p>The first line makes debugging easier but the last two lines specify the
Kerberos realm in use and the address of the KDC.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">  &lt;system-properties&gt;
    &lt;property name="sun.security.krb5.debug" value="true"/&gt;
    &lt;property name="java.security.krb5.realm" value="ELYTRON.ORG"/&gt;
    &lt;property name="java.security.krb5.kdc" value="kdc.elytron.org"/&gt;
  &lt;/system-properties&gt;</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="http-authentication-kerberos"><a class="anchor" href="#http-authentication-kerberos"></a>20.6.1. HTTP Authentication</h4>
<div class="sect4">
<h5 id="legacy-security-realm-kerberos"><a class="anchor" href="#legacy-security-realm-kerberos"></a>Legacy Security Realm</h5>
<div class="paragraph">
<p>A legacy security realm can be define so that SPNEGO authentication can
be enabled for the HTTP management interface.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>./core-service=management/security-realm=Kerberos:add
./core-service=management/security-realm=Kerberos/server-identity=kerberos:add
./core-service=management/security-realm=Kerberos/server-identity=kerberos/keytab=HTTP\/test-server.elytron.org@ELYTRON.ORG:add(path=/home/darranl/src/kerberos/test-server.keytab, debug=true)
./core-service=management/security-realm=Kerberos/authentication=kerberos:add(remove-realm=true)</code></pre>
</div>
</div>
<div class="paragraph">
<p>This results in the following configuration: -</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">  &lt;security-realms&gt;
    ...
    &lt;security-realm name="Kerberos"&gt;
      &lt;server-identities&gt;
        &lt;kerberos&gt;
          &lt;keytab principal="HTTP/test-server.elytron.org@ELYTRON.ORG" path="/home/darranl/src/kerberos/test-server.keytab" debug="true"/&gt;
        &lt;/kerberos&gt;
      &lt;/server-identities&gt;
      &lt;authentication&gt;
        &lt;kerberos remove-realm="true"/&gt;
      &lt;/authentication&gt;
    &lt;/security-realm&gt;
  &lt;/security-realms&gt;</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="application-spnego"><a class="anchor" href="#application-spnego"></a>Application SPNEGO</h5>
<div class="paragraph">
<p>Alternatively deployed applications would make use of a pair of security
domains.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">./subsystem=security/security-domain=host:add
./subsystem=security/security-domain=host/authentication=classic:add
./subsystem=security/security-domain=host/authentication=classic/login-module=1:add(code=Kerberos, flag=Required, module-options={storeKey=true, useKeyTab=true, principal=HTTP/test-server.elytron.org@ELYTRON.ORG, keyTab=/home/darranl/src/kerberos/test-server.keytab, debug=true}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>./subsystem=security/security-domain=SPNEGO:add
./subsystem=security/security-domain=SPNEGO/authentication=classic:add
./subsystem=security/security-domain=SPNEGO/authentication=classic/login-module=1:add(code=SPNEGO, flag=requisite,  module-options={password-stacking=useFirstPass, serverSecurityDomain=host})
./subsystem=security/security-domain=SPNEGO/authentication=classic/login-module=1:write-attribute(name=module, value=org.jboss.security.negotiation)
./subsystem=security/security-domain=SPNEGO/authentication=classic/login-module=2:add(code=UsersRoles, flag=required, module-options={password-stacking=useFirstPass, usersProperties=file:///home/darranl/src/kerberos/spnego-users.properties, rolesProperties=file:///home/darranl/src/kerberos/spnego-roles.properties, defaultUsersProperties=file:///home/darranl/src/kerberos/spnego-users.properties, defaultRolesProperties=file:///home/darranl/src/kerberos/spnego-roles.properties})</code></pre>
</div>
</div>
<div class="paragraph">
<p>This results in: -</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">  &lt;subsystem xmlns="urn:jboss:domain:security:2.0"&gt;
    &lt;security-domains&gt;
      ...
      &lt;security-domain name="host"&gt;
        &lt;authentication&gt;
          &lt;login-module name="1" code="Kerberos" flag="required"&gt;
            &lt;module-option name="storeKey" value="true"/&gt;
            &lt;module-option name="useKeyTab" value="true"/&gt;
            &lt;module-option name="principal" value="HTTP/test-server.elytron.org@ELYTRON.ORG"/&gt;
            &lt;module-option name="keyTab" value="/home/darranl/src/kerberos/test-server.keytab"/&gt;
            &lt;module-option name="debug" value="true"/&gt;
          &lt;/login-module&gt;
        &lt;/authentication&gt;
      &lt;/security-domain&gt;
      &lt;security-domain name="SPNEGO"&gt;
        &lt;authentication&gt;
          &lt;login-module name="1" code="SPNEGO" flag="requisite" module="org.jboss.security.negotiation"&gt;
            &lt;module-option name="password-stacking" value="useFirstPass"/&gt;
            &lt;module-option name="serverSecurityDomain" value="host"/&gt;
          &lt;/login-module&gt;
          &lt;login-module name="2" code="UsersRoles" flag="required"&gt;
            &lt;module-option name="password-stacking" value="useFirstPass"/&gt;
            &lt;module-option name="usersProperties" value="file:///home/darranl/src/kerberos/spnego-users.properties"/&gt;
            &lt;module-option name="rolesProperties" value="file:///home/darranl/src/kerberos/spnego-roles.properties"/&gt;
            &lt;module-option name="defaultUsersProperties" value="file:///home/darranl/src/kerberos/spnego-users.properties"/&gt;
            &lt;module-option name="defaultRolesProperties" value="file:///home/darranl/src/kerberos/spnego-roles.properties"/&gt;
          &lt;/login-module&gt;
        &lt;/authentication&gt;
      &lt;/security-domain&gt;
    &lt;/security-domains&gt;
  &lt;/subsystem&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>An application can now be deployed referencing the SPNEGO security
domain and secured with SPNEGO mechanism.</p>
</div>
</div>
<div class="sect4">
<h5 id="migrated-spnego"><a class="anchor" href="#migrated-spnego"></a>Migrated SPNEGO</h5>
<div class="paragraph">
<p>The equivalent configuration can be achieved with WildFly Elytron by
first defining a security realm which will be used to load identity
information.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>./subsystem=elytron/properties-realm=spnego-properties:add(users-properties={path=/home/darranl/src/kerberos/spnego-users.properties, plain-text=true, digest-realm-name=ELYTRON.ORG}, groups-properties={path=/home/darranl/src/kerberos/spnego-roles.properties})</code></pre>
</div>
</div>
<div class="paragraph">
<p>Next a Kerberos security factory is defined which allows the server to
load it&#8217;s own Kerberos identity.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>./subsystem=elytron/kerberos-security-factory=test-server:add(path=/home/darranl/src/kerberos/test-server.keytab, principal=HTTP/test-server.elytron.org@ELYTRON.ORG, debug=true)</code></pre>
</div>
</div>
<div class="paragraph">
<p>As with the previous examples we define a security realm to pull
together the policy as well as a HTTP authentication factory for the
authentication policy.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>./subsystem=elytron/security-domain=SPNEGODomain:add(default-realm=spnego-properties, realms=[{realm=spnego-properties, role-decoder=groups-to-roles}], permission-mapper=default-permission-mapper)
./subsystem=elytron/http-authentication-factory=spnego-http-authentication:add(security-domain=SPNEGODomain, http-server-mechanism-factory=global,mechanism-configurations=[{mechanism-name=SPNEGO, credential-security-factory=test-server}])</code></pre>
</div>
</div>
<div class="paragraph">
<p>Overall this results in the following configuration: -</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">  &lt;subsystem xmlns="urn:wildfly:elytron:1.0" final-providers="combined-providers" disallowed-providers="OracleUcrypto"&gt;
    ...
    &lt;security-domains&gt;
    ...
      &lt;security-domain name="SPNEGODomain" default-realm="spnego-properties" permission-mapper="default-permission-mapper"&gt;
        &lt;realm name="spnego-properties" role-decoder="groups-to-roles"/&gt;
      &lt;/security-domain&gt;
    &lt;/security-domains&gt;
    &lt;security-realms&gt;
      ...
      &lt;properties-realm name="spnego-properties"&gt;
        &lt;users-properties path="/home/darranl/src/kerberos/spnego-users.properties" digest-realm-name="ELYTRON.ORG" plain-text="true"/&gt;
        &lt;groups-properties path="/home/darranl/src/kerberos/spnego-roles.properties"/&gt;
      &lt;/properties-realm&gt;
    &lt;/security-realms&gt;
    &lt;credential-security-factories&gt;
      &lt;kerberos-security-factory name="test-server" principal="HTTP/test-server.elytron.org@ELYTRON.ORG" path="/home/darranl/src/kerberos/test-server.keytab" debug="true"/&gt;
    &lt;/credential-security-factories&gt;
    ...
    &lt;http&gt;
      ...
      &lt;http-authentication-factory name="spnego-http-authentication" http-server-mechanism-factory="global" security-domain="SPNEGODomain"&gt;
        &lt;mechanism-configuration&gt;
          &lt;mechanism mechanism-name="SPNEGO" credential-security-factory="test-server"/&gt;
        &lt;/mechanism-configuration&gt;
      &lt;/http-authentication-factory&gt;
      ...
    &lt;/http&gt;
    ...
  &lt;/subsystem&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now, to enable SPNEGO authentication for the HTTP management interface,
update this interface to reference the <code>http-authentication-factory</code>
defined above, as described in the
<a href="https://docs.jboss.org/author/display/WFLY/Migrate+Legacy+Security+to+Elytron+Security#MigrateLegacySecuritytoElytronSecurity-MigratedConfiguration">properties
authentication section</a>.</p>
</div>
<div class="paragraph">
<p>Alternatively, to secure an application using SPNEGO authentication, an
application security domain can be defined in the Undertow subsystem to
map security domains to the <code>http-authentication-factory</code> defined above,
as described in the
<a href="https://docs.jboss.org/author/display/WFLY/Migrate+Legacy+Security+to+Elytron+Security#MigrateLegacySecuritytoElytronSecurity-FullyMigratedConfiguration">properties
authentication section</a>.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="remoting-sasl-authentication"><a class="anchor" href="#remoting-sasl-authentication"></a>20.6.2. Remoting / SASL Authentication</h4>
<div class="sect4">
<h5 id="legacy-security-realm-kerberos-1"><a class="anchor" href="#legacy-security-realm-kerberos-1"></a>Legacy Security Realm</h5>
<div class="paragraph">
<p>It is also possible to define a legacy security realm for Kerberos /
GSSAPI SASL authenticatio for Remoting authentication such as the native
management interface.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>./core-service=management/security-realm=Kerberos:add
./core-service=management/security-realm=Kerberos/server-identity=kerberos:add
./core-service=management/security-realm=Kerberos/server-identity=kerberos/keytab=remote\/test-server.elytron.org@ELYTRON.ORG:add(path=/home/darranl/src/kerberos/remote-test-server.keytab, debug=true)
./core-service=management/security-realm=Kerberos/authentication=kerberos:add(remove-realm=true)</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">  &lt;management&gt;
    &lt;security-realms&gt;
      ...
      &lt;security-realm name="Kerberos"&gt;
        &lt;server-identities&gt;
          &lt;kerberos&gt;
            &lt;keytab principal="remote/test-server.elytron.org@ELYTRON.ORG" path="/home/darranl/src/kerberos/remote-test-server.keytab" debug="true"/&gt;
          &lt;/kerberos&gt;
        &lt;/server-identities&gt;
        &lt;authentication&gt;
          &lt;kerberos remove-realm="true"/&gt;
        &lt;/authentication&gt;
      &lt;/security-realm&gt;
    &lt;/security-realms&gt;
    ...
  &lt;/management&gt;</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="migrated-gssapi"><a class="anchor" href="#migrated-gssapi"></a>Migrated GSSAPI</h5>
<div class="paragraph">
<p>The steps to define the equivalent Elytron configuration are very
similar to the HTTP example.</p>
</div>
<div class="paragraph">
<p>First define the security realm to load the identity from: -</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>./path=kerberos:add(relative-to=user.home, path=src/kerberos)
./subsystem=elytron/properties-realm=kerberos-properties:add(users-properties={path=kerberos-users.properties, relative-to=kerberos, digest-realm-name=ELYTRON.ORG}, groups-properties={path=kerberos-groups.properties, relative-to=kerberos})</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then define the Kerberos security factory for the server&#8217;s identity.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>./subsystem=elytron/kerberos-security-factory=test-server:add(relative-to=kerberos, path=remote-test-server.keytab, principal=remote/test-server.elytron.org@ELYTRON.ORG)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Finally define the security domain and this time a SASL authentication
factory.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>./subsystem=elytron/security-domain=KerberosDomain:add(default-realm=kerberos-properties, realms=[{realm=kerberos-properties, role-decoder=groups-to-roles}], permission-mapper=default-permission-mapper)
./subsystem=elytron/sasl-authentication-factory=gssapi-authentication-factory:add(security-domain=KerberosDomain, sasl-server-factory=elytron, mechanism-configurations=[{mechanism-name=GSSAPI, credential-security-factory=test-server}])</code></pre>
</div>
</div>
<div class="paragraph">
<p>This results in the following subsystem configuration: -</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">  &lt;subsystem xmlns="urn:wildfly:elytron:1.0" final-providers="combined-providers" disallowed-providers="OracleUcrypto"&gt;
    ...
    &lt;security-domains&gt;
      ...
      &lt;security-domain name="KerberosDomain" default-realm="kerberos-properties" permission-mapper="default-permission-mapper"&gt;
        &lt;realm name="kerberos-properties" role-decoder="groups-to-roles"/&gt;
      &lt;/security-domain&gt;
    &lt;/security-domains&gt;
    &lt;security-realms&gt;
     ...
       &lt;properties-realm name="kerberos-properties"&gt;
         &lt;users-properties path="kerberos-users.properties" relative-to="kerberos" digest-realm-name="ELYTRON.ORG"/&gt;
         &lt;groups-properties path="kerberos-groups.properties" relative-to="kerberos"/&gt;
       &lt;/properties-realm&gt;
     &lt;/security-realms&gt;
     &lt;credential-security-factories&gt;
       &lt;kerberos-security-factory name="test-server" principal="remote/test-server.elytron.org@ELYTRON.ORG" path="remote-test-server.keytab" relative-to="kerberos"/&gt;
     &lt;/credential-security-factories&gt;
     ...
     &lt;sasl&gt;
       ...
       &lt;sasl-authentication-factory name="gssapi-authentication-factory" sasl-server-factory="elytron" security-domain="KerberosDomain"&gt;
         &lt;mechanism-configuration&gt;
           &lt;mechanism mechanism-name="GSSAPI" credential-security-factory="test-server"/&gt;
         &lt;/mechanism-configuration&gt;
       &lt;/sasl-authentication-factory&gt;
       ...
     &lt;/sasl&gt;
   &lt;/subsystem&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The management interface or Remoting connectors can now be updated to
reference the SASL authentication factory.</p>
</div>
<div class="paragraph">
<p>The two Elytron examples defined here could also be combined into one to
use a shared security domain and security realm and just use protocol
specific authentication factories each referencing their own Kerberos
security factory.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="Caching_Migration"><a class="anchor" href="#Caching_Migration"></a>20.7. Caching Migration</h3>
<div class="paragraph">
<p>Where a PicketBox based security domain is defined it is possible to enable caching for that security domain, this enables subsequent hits to the identity store to be avoided as an in memory cache can be used instead, this example demonstrates how caching can be used with a WildFly Elytron based configuration.</p>
</div>
<div class="paragraph">
<p>The purpose of this chapter is to highlight the migration of a configuration with caching enabled, this example is based in the previous LDAP example but with caching enabled.</p>
</div>
<div class="sect3">
<h4 id="_picketbox_example"><a class="anchor" href="#_picketbox_example"></a>20.7.1. PicketBox Example</h4>
<div class="paragraph">
<p>A PicketBox based security domain can be defined with the following commands.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>./subsystem=security/security-domain=application-security:add(cache-type=default)
./subsystem=security/security-domain=application-security/authentication=classic:add(login-modules=[{code=LdapExtended, flag=Required, module-options={ \
java.naming.factory.initial=com.sun.jndi.ldap.LdapCtxFactory, \
java.naming.provider.url=ldap://localhost:10389, \
java.naming.security.authentication=simple, \
bindDN="uid=admin,ou=system", \
bindCredential=secret, \
baseCtxDN="ou=users,dc=group-to-principal,dc=wildfly,dc=org", \
baseFilter="(uid={0})", \
rolesCtxDN="ou=groups,dc=group-to-principal,dc=wildfly,dc=org",\
roleFilter="(uniqueMember={1})", \
roleAttributeID="uid" \
}}])</code></pre>
</div>
</div>
<div class="paragraph">
<p>Resulting in the following security domain definition:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;subsystem xmlns="urn:jboss:domain:security:2.0"&gt;
  &lt;security-domains&gt;
    ...
    &lt;security-domain name="application-security" cache-type="default"&gt;
      &lt;authentication&gt;
        &lt;login-module code="LdapExtended" flag="required"&gt;
          &lt;module-option name="java.naming.factory.initial" value="com.sun.jndi.ldap.LdapCtxFactory"/&gt;
          &lt;module-option name="java.naming.provider.url" value="ldap://localhost:10389"/&gt;
          &lt;module-option name="java.naming.security.authentication" value="simple"/&gt;
          &lt;module-option name="bindDN" value="uid=admin,ou=system"/&gt;
          &lt;module-option name="bindCredential" value="secret"/&gt;
          &lt;module-option name="baseCtxDN" value="ou=users,dc=group-to-principal,dc=wildfly,dc=org"/&gt;
          &lt;module-option name="baseFilter" value="(uid={0})"/&gt;
          &lt;module-option name="rolesCtxDN" value="ou=groups,dc=group-to-principal,dc=wildfly,dc=org"/&gt;
          &lt;module-option name="roleFilter" value="(uniqueMember={1})"/&gt;
          &lt;module-option name="roleAttributeID" value="uid"/&gt;
        &lt;/login-module&gt;
      &lt;/authentication&gt;
    &lt;/security-domain&gt;
  &lt;/security-domains&gt;
&lt;/subsystem&gt;</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_migrated_example"><a class="anchor" href="#_migrated_example"></a>20.7.2. Migrated Example</h4>
<div class="paragraph">
<p>When using WildFly Elytron where caching is required the individual security realm is wrapped using a cache, a migrated configuration can be defined with the following commands:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>./subsystem=elytron/dir-context=ldap-connection:add(url=ldap://localhost:10389, principal="uid=admin,ou=system", credential-reference={clear-text=secret})
./subsystem=elytron/ldap-realm=ldap-realm:add(dir-context=ldap-connection, \
direct-verification=true, \
identity-mapping={search-base-dn="ou=users,dc=group-to-principal,dc=wildfly,dc=org", \
rdn-identifier="uid", \
attribute-mapping=[{filter-base-dn="ou=groups,dc=group-to-principal,dc=wildfly,dc=org",filter="(uniqueMember={1})",from="uid",to="Roles"}]})
./subsystem=elytron/caching-realm=cached-ldap:add(realm=ldap-realm)</code></pre>
</div>
</div>
<div class="paragraph">
<p>These can then be used in a security domain and subsequently an authentication factory.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>./subsystem=elytron/security-domain=application-security:add(realms=[{realm=cached-ldap}], default-realm=cached-ldap, permission-mapper=default-permission-mapper)
./subsystem=elytron/http-authentication-factory=application-security-http:add(http-server-mechanism-factory=global, security-domain=application-security, mechanism-configurations=[{mechanism-name=BASIC}])</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this final step it is very important that the caching-realm is referenced rather than the original realm otherwise caching will be bypassed.</p>
</div>
<div class="paragraph">
<p>This results in the following definitions:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;subsystem xmlns="urn:wildfly:elytron:1.1" final-providers="combined-providers" disallowed-providers="OracleUcrypto"&gt;
  ...
  &lt;security-domains&gt;
    ...
    &lt;security-domain name="application-security" default-realm="cached-ldap" permission-mapper="default-permission-mapper"&gt;
      &lt;realm name="cached-ldap"/&gt;
    &lt;/security-domain&gt;
  &lt;/security-domains&gt;
  &lt;security-realms&gt;
    ...
    &lt;ldap-realm name="ldap-realm" dir-context="ldap-connection" direct-verification="true"&gt;
      &lt;identity-mapping rdn-identifier="uid" search-base-dn="ou=users,dc=group-to-principal,dc=wildfly,dc=org"&gt;
        &lt;attribute-mapping&gt;
          &lt;attribute from="uid" to="Roles" filter="(uniqueMember={1})" filter-base-dn="ou=groups,dc=group-to-principal,dc=wildfly,dc=org"/&gt;
        &lt;/attribute-mapping&gt;
      &lt;/identity-mapping&gt;
    &lt;/ldap-realm&gt;
    &lt;caching-realm name="cached-ldap" realm="ldap-realm"/&gt;
  &lt;/security-realms&gt;
  ...
  &lt;http&gt;
    ...
    &lt;http-authentication-factory name="application-security-http" http-server-mechanism-factory="global" security-domain="application-security"&gt;
      &lt;mechanism-configuration&gt;
        &lt;mechanism mechanism-name="BASIC"/&gt;
      &lt;/mechanism-configuration&gt;
    &lt;/http-authentication-factory&gt;
    ...
  &lt;/http&gt;
  ...
  &lt;dir-contexts&gt;
    &lt;dir-context name="ldap-connection" url="ldap://localhost:10389" principal="uid=admin,ou=system"&gt;
      &lt;credential-reference clear-text="secret"/&gt;
    &lt;/dir-context&gt;
  &lt;/dir-contexts&gt;
&lt;/subsystem&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_clients"><a class="anchor" href="#_clients"></a>20.8. Clients</h3>

</div>
<div class="sect2">
<h3 id="Application_Client_Migration"><a class="anchor" href="#Application_Client_Migration"></a>20.9. Application Client Migration</h3>
<div class="sect3">
<h4 id="naming-client"><a class="anchor" href="#naming-client"></a>20.9.1. Naming Client</h4>
<div class="paragraph">
<p>This migration example assumes a client application performs a remote
JNDI lookup using an ﻿﻿ <code>InitialContext</code> backed by the
<code>org.jboss.naming.remote.client.InitialContextFactory</code> class.</p>
</div>
<div class="sect4">
<h5 id="original-configuration-app-client"><a class="anchor" href="#original-configuration-app-client"></a>Original Configuration</h5>
<div class="paragraph">
<p>An <code>InitialContext</code> backed by the
<code>org.jboss.naming.remote.client.InitialContextFactory</code> class can be
created by specifying properties that contain the URL of the naming
provider to connect to along with appropriate user credentials:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">Properties properties = new Properties();
properties.put(Context.INITIAL_CONTEXT_FACTORY, "org.jboss.naming.remote.client.InitialContextFactory");
properties.put(Context.PROVIDER_URL, "http-remoting://127.0.0.1:8080");
properties.put(Context.SECURITY_PRINCIPAL, "bob");
properties.put(Context.SECURITY_CREDENTIALS, "secret");
InitialContext context = new InitialContext(properties);
Bar bar = (Bar) context.lookup("foo/bar");
...</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="migrated-configuration-app-client"><a class="anchor" href="#migrated-configuration-app-client"></a>Migrated Configuration</h5>
<div class="paragraph">
<p>An <code>InitialContext</code> backed by the
<code>org.wildfly.naming.client.WildFlyInitialContextFactory</code> class can be
created by specifying a property that contains the URL of the naming
provider to connect to. The user credentials can be specified using a
WildFly client configuration file or programmatically.</p>
</div>
<div class="sect5">
<h6 id="configuration-file-approach"><a class="anchor" href="#configuration-file-approach"></a>Configuration File Approach</h6>
<div class="paragraph">
<p>A <code>wildfly-config.xml</code> file that contains the user credentials to use
when establishing a connection to the naming provider can be added to
the client application&#8217;s <code>META-INF</code> directory:</p>
</div>
<div class="paragraph">
<p><strong>wildfly-config.xml</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;configuration&gt;
    &lt;authentication-client xmlns="urn:elytron:1.0"&gt;
        &lt;authentication-rules&gt;
            &lt;rule use-configuration="namingConfig"&gt;
                &lt;match-host name="127.0.0.1"/&gt;
            &lt;/rule&gt;
        &lt;/authentication-rules&gt;
        &lt;authentication-configurations&gt;
            &lt;configuration name="namingConfig"&gt;
                &lt;set-user-name name="bob"/&gt;
                &lt;credentials&gt;
                    &lt;clear-password password="secret"/&gt;
                &lt;/credentials&gt;
            &lt;/configuration&gt;
        &lt;/authentication-configurations&gt;
    &lt;/authentication-client&gt;
&lt;/configuration&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>An <code>InitialContext</code> can then be created as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">Properties properties = new Properties();
properties.put(Context.INITIAL_CONTEXT_FACTORY, "org.wildfly.naming.client.WildFlyInitialContextFactory");
properties.put(Context.PROVIDER_URL, "remote+http://127.0.0.1:8080");
InitialContext context = new InitialContext(properties);
Bar bar = (Bar) context.lookup("foo/bar");
...</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="programmatic-approach"><a class="anchor" href="#programmatic-approach"></a>Programmatic Approach</h6>
<div class="paragraph">
<p>The user credentials to use when establishing a connection to the naming
provider can be specified directly in the client application&#8217;s code:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">// create your authentication configuration
AuthenticationConfiguration namingConfig = AuthenticationConfiguration.empty().useName("bob").usePassword("secret");

// create your authentication context
AuthenticationContext context = AuthenticationContext.empty().with(MatchRule.ALL.matchHost("127.0.0.1"), namingConfig);

// create a callable that creates and uses an InitialContext
Callable&lt;Void&gt; callable = () -&gt; {
    Properties properties = new Properties();
    properties.put(Context.INITIAL_CONTEXT_FACTORY, "org.wildfly.naming.client.WildFlyInitialContextFactory");
    properties.put(Context.PROVIDER_URL, "remote+http://127.0.0.1:8080");
    InitialContext context = new InitialContext(properties);
    Bar bar = (Bar) context.lookup("foo/bar");
    ...
    return null;
};

// use your authentication context to run your callable
context.runCallable(callable);</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="ejb-client"><a class="anchor" href="#ejb-client"></a>20.9.2. EJB Client</h4>
<div class="paragraph">
<p>This migration example assumes a client application is configured to
invoke an EJB deployed on a remote server using a
<code>jboss-ejb-client.properties</code> file.</p>
</div>
<div class="sect4">
<h5 id="original-configuration-app-client-1"><a class="anchor" href="#original-configuration-app-client-1"></a>Original Configuration</h5>
<div class="paragraph">
<p>A <code>jboss-ejb-client.properties</code> file that contains the information
needed to connect to the remote server can be specified in a client
application&#8217;s <code>META-INF</code> directory:</p>
</div>
<div class="paragraph">
<p><strong>jboss-ejb-client.properties</strong></p>
</div>
<div class="literalblock">
<div class="content">
<pre>remote.connectionprovider.create.options.org.xnio.Options.SSL_ENABLED=false
remote.connections=default
remote.connection.default.host=127.0.0.1
remote.connection.default.port = 8080
remote.connection.default.username=bob
remote.connection.default.password=secret</pre>
</div>
</div>
<div class="paragraph">
<p>An EJB can then be looked up and a method can be invoked on it as
follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">// create an InitialContext
Properties properties = new Properties();
properties.put(Context.INITIAL_CONTEXT_FACTORY, "org.jboss.naming.remote.client.InitialContextFactory");
properties.put(Context.URL_PKG_PREFIXES, "org.jboss.ejb.client.naming");
InitialContext context = new InitialContext(properties);

// look up an EJB and invoke one of its methods
RemoteCalculator statelessRemoteCalculator = (RemoteCalculator) context.lookup(
    "ejb:/ejb-remote-server-side//CalculatorBean!" + RemoteCalculator.class.getName());
int sum = statelessRemoteCalculator.add(101, 202);</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="migrated-configuration-1"><a class="anchor" href="#migrated-configuration-1"></a>Migrated Configuration</h5>
<div class="paragraph">
<p>The information needed to connect to the remote server can be specified
using a WildFly client configuration file or programmatically.</p>
</div>
<div class="sect5">
<h6 id="configuration-file-approach-1"><a class="anchor" href="#configuration-file-approach-1"></a>Configuration File Approach</h6>
<div class="paragraph">
<p>A <code>wildfly-config.xml</code> file that contains the information needed to
connect to the remote server can be added to the client application&#8217;s
<code>META-INF</code> directory:</p>
</div>
<div class="paragraph">
<p><strong>wildfly-config.xml</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;configuration&gt;
    &lt;authentication-client xmlns="urn:elytron:1.0"&gt;
        &lt;authentication-rules&gt;
            &lt;rule use-configuration="ejbConfig"&gt;
                &lt;match-host name="127.0.0.1"/&gt;
            &lt;/rule&gt;
        &lt;/authentication-rules&gt;
        &lt;authentication-configurations&gt;
            &lt;configuration name="ejbConfig"&gt;
                &lt;set-user-name name="bob"/&gt;
                &lt;credentials&gt;
                    &lt;clear-password password="secret"/&gt;
                &lt;/credentials&gt;
            &lt;/configuration&gt;
        &lt;/authentication-configurations&gt;
    &lt;/authentication-client&gt;
    &lt;jboss-ejb-client xmlns="urn:jboss:wildfly-client-ejb:3.0"&gt;
        &lt;connections&gt;
            &lt;connection uri="remote+http://127.0.0.1:8080" /&gt;
        &lt;/connections&gt;
    &lt;/jboss-ejb-client&gt;
&lt;/configuration&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>An EJB can then be looked up and a method can be invoked on it as
follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">// create an InitialContext
Properties properties = new Properties();
properties.put(Context.INITIAL_CONTEXT_FACTORY, "org.wildfly.naming.client.WildFlyInitialContextFactory");
InitialContext context = new InitialContext(properties);

// look up an EJB and invoke one of its methods (same as before)
RemoteCalculator statelessRemoteCalculator = (RemoteCalculator) context.lookup(
    "ejb:/ejb-remote-server-side//CalculatorBean!" + RemoteCalculator.class.getName());
int sum = statelessRemoteCalculator.add(101, 202);</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="programmatic-approach-1"><a class="anchor" href="#programmatic-approach-1"></a>Programmatic Approach</h6>
<div class="paragraph">
<p>The information needed to connect to the remote server can be specified
directly in the client application&#8217;s code:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">// create your authentication configuration
AuthenticationConfiguration ejbConfig = AuthenticationConfiguration.empty().useName("bob").usePassword("secret");

// create your authentication context
AuthenticationContext context = AuthenticationContext.empty().with(MatchRule.ALL.matchHost("127.0.0.1"), ejbConfig);

// create a callable that invokes an EJB
Callable&lt;Void&gt; callable = () -&gt; {

    // create an InitialContext
    Properties properties = new Properties();
    properties.put(Context.INITIAL_CONTEXT_FACTORY, "org.wildfly.naming.client.WildFlyInitialContextFactory");
    properties.put(Context.PROVIDER_URL, "remote+http://127.0.0.1:8080");
    InitialContext context = new InitialContext(properties);

    // look up an EJB and invoke one of its methods (same as before)
    RemoteCalculator statelessRemoteCalculator = (RemoteCalculator) context.lookup(
        "ejb:/ejb-remote-server-side//CalculatorBean!" + RemoteCalculator.class.getName());
    int sum = statelessRemoteCalculator.add(101, 202);
    ...
    return null;
};

// use your authentication context to run your callable
context.runCallable(callable);</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
References in this document to Enterprise JavaBeans(EJB) refer to the Jakarta Enterprise Beans unless otherwise noted.
:leveloffset: -1
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_general_utilities"><a class="anchor" href="#_general_utilities"></a>20.9.3. General Utilities</h4>

</div>
<div class="sect3">
<h4 id="Security_Vault_Migration"><a class="anchor" href="#Security_Vault_Migration"></a>20.9.4. Security Vault Migration</h4>
<div class="paragraph">
<p>Security Vault is primarily used in legacy configurations, a vault is
used to store sensitive strings outside of the configuration files.
WildFly server may only contain a single security vault.</p>
</div>
<div class="paragraph">
<p>Credential Store introduced in WildFly 11 is meant to expand Security
Vault in terms of storing different credential types and introduce easy
to implemnent SPI which allows to deploy custom implemenations of
CredentialStore SPI. Credentials are stored safely encrypted in storage
file outside WildFly configuration files. Each WildFly server may
contain multiple credential stores.</p>
</div>
<div class="paragraph">
<p>To easily migrate vault content into credential store we have added
"vault" command into WildFly Elytron Tool. The tool could be found at
$JBOSS_HOME/bin directory. It has several scripts named "elytron-tool.*"
dependent on your platform of choice. One can use also simple form "java
-jar $JBOSS_HOME/bin/wildfly-elytron-tool.jar &lt;command&gt; &lt;arguments&gt;" if
it better suites ones needs.</p>
</div>
<div class="sect4">
<h5 id="single-security-vault-conversion"><a class="anchor" href="#single-security-vault-conversion"></a>Single Security Vault Conversion</h5>
<div class="paragraph">
<p>To convert <strong>single</strong> security vault credential store use following
example:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>to get sample vault use testing resources of Elytron Tool project from
<a href="https://github.com/wildfly-security/wildfly-elytron-tool/tree/master/src/test/resources/vault-v1">GitHub</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Command to run actual conversion:</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="paragraph">
<p><code>./bin/elytron-tool.sh vault --enc-dir vault_data/ --keystore vault-jceks.keystore --keystore-password MASK-2hKo56F1a3jYGnJwhPmiF5 --iteration 34 --salt 12345678 --alias test --location cs-v1.store --summary</code></p>
</div>
</div>
</div>
<div class="paragraph">
<p>Output:</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="paragraph">
<p><code>Vault (enc-dir="vault_data/";keystore="vault-jceks.keystore") converted to credential store "cs-v1.store"</code><br>
<code>Vault Conversion summary:</code><br>
<code>--------------------------------------</code><br>
<code>Vault Conversion Successful</code><br>
<code>CLI command to add new credential store:</code><br>
<code>/subsystem=elytron/credential-store=test:add(relative-to=jboss.server.data.dir,create=true,modifiable=true,location="cs-v1.store",implementation-properties={"keyStoreType"&#8658;"JCEKS"},credential-reference={clear-text="MASK-2hKo56F1a3jYGnJwhPmiF5;12345678;34"})</code></p>
</div>
</div>
</div>
<div class="paragraph">
<p>Use elytron-tool.sh vault --help to get description of all parameters.</p>
</div>
<div class="sect5">
<h6 id="notes"><a class="anchor" href="#notes"></a>Notes:</h6>
<div class="ulist">
<ul>
<li>
<p>Elytron Tool cannot handle very first version of Security Vault data
file.<br></p>
</li>
<li>
<p>--keystore-password can come in two forms (1) masked as shown in the
example or (2) clear text. Parameter --salt and --iteration are there to
supply information to decrypt the masked password or to generate masked
password in output. In case --salt and --iteration are omitted default
values are used.<br></p>
</li>
<li>
<p>When --summary parameter is specified, one can see nice output with
CLI command to be used in WildFly console to add converted credential
store to the configuration.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect4">
<h5 id="bulk-security-vault-conversion"><a class="anchor" href="#bulk-security-vault-conversion"></a>Bulk Security Vault Conversion</h5>
<div class="paragraph">
<p>There is possibility to convert multiple vaults to credential store
using --bulk-convert parameter with description file.<br>
Example of description file from our <a href="https://github.com/wildfly-security/wildfly-elytron-tool/blob/master/src/test/java/org/wildfly/security/tool/VaultCommandTest.java">tests</a>:</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="paragraph">
<p><code># Bulk conversion descriptor</code><br>
<code>keystore:target/test-classes/vault-v1/vault-jceks.keystore</code><br>
<code>keystore-password:MASK-2hKo56F1a3jYGnJwhPmiF5</code><br>
<code>enc-dir:target/test-classes/vault-v1/vault_data/</code><br>
<code>salt:12345678</code><br>
<code>iteration:34</code><br>
<code>location:target/v1-cs-1.store</code><br>
<code>alias:test</code></p>
</div>
<div class="paragraph">
<p><code>keystore:target/test-classes/vault-v1/vault-jceks.keystore</code><br>
<code>keystore-password:secretsecret</code><br>
<code>enc-dir:target/test-classes/vault-v1/vault_data/</code><br>
<code>location:target/v1-cs-2.store</code><br>
<code>alias:test</code></p>
</div>
<div class="paragraph">
<p><code># different vault vault-v1-more</code><br>
<code>keystore:target/test-classes/vault-v1-more/vault-jceks.keystore</code><br>
<code>keystore-password:MASK-2hKo56F1a3jYGnJwhPmiF5</code><br>
<code>enc-dir:target/test-classes/vault-v1-more/vault_data/</code><br>
<code>salt:12345678</code><br>
<code>iteration:34</code><br>
<code>location:target/v1-cs-more.store</code><br>
<code>alias:test</code></p>
</div>
</div>
</div>
<div class="paragraph">
<p>After each "keystore:" option new conversion starts. All options are
mandatory except "salt:", "iteration:" and "properties:"</p>
</div>
<div class="paragraph">
<p>Execute following command:</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="paragraph">
<p><code>./bin/elytron-tool.sh vault --bulk-convert bulk-vault-conversion-desc --summary</code></p>
</div>
</div>
</div>
<div class="paragraph">
<p>Output:</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="paragraph">
<p><code>Vault (enc-dir="vault-v1/vault_data/";keystore="vault-v1/vault-jceks.keystore") converted to credential store "v1-cs-1.store"</code><br>
<code>Vault Conversion summary:</code><br>
<code>--------------------------------------</code><br>
<code>Vault Conversion Successful</code><br>
<code>CLI command to add new credential store:</code><br>
<code>/subsystem=elytron/credential-store=test:add(relative-to=jboss.server.data.dir,create=true,modifiable=true,location="v1-cs-1.store",implementation-properties={"keyStoreType"&#8658;"JCEKS"},credential-reference={clear-text="MASK-2hKo56F1a3jYGnJwhPmiF5;12345678;34"})</code><br>
<code>--------------------------------------</code></p>
</div>
<div class="paragraph">
<p><code>Vault (enc-dir="vault-v1/vault_data/";keystore="vault-v1/vault-jceks.keystore") converted to credential store "v1-cs-2.store"</code><br>
<code>Vault Conversion summary:</code><br>
<code>--------------------------------------</code><br>
<code>Vault Conversion Successful</code><br>
<code>CLI command to add new credential store:</code><br>
<code>/subsystem=elytron/credential-store=test:add(relative-to=jboss.server.data.dir,create=true,modifiable=true,location="v1-cs-2.store",implementation-properties={"keyStoreType"&#8658;"JCEKS"},credential-reference={clear-text="secretsecret"})</code><br>
<code>--------------------------------------</code></p>
</div>
<div class="paragraph">
<p><code>Vault (enc-dir="vault-v1-more/vault_data/";keystore="vault-v1-more/vault-jceks.keystore") converted to credential store "v1-cs-more.store"</code><br>
<code>Vault Conversion summary:</code><br>
<code>--------------------------------------</code><br>
<code>Vault Conversion Successful</code><br>
<code>CLI command to add new credential store:</code><br>
<code>/subsystem=elytron/credential-store=test:add(relative-to=jboss.server.data.dir,create=true,modifiable=true,location="v1-cs-more.store",implementation-properties={"keyStoreType"&#8658;"JCEKS"},credential-reference={clear-text="MASK-2hKo56F1a3jYGnJwhPmiF5;12345678;34"})</code><br>
<code>--------------------------------------</code></p>
</div>
</div>
</div>
<div class="paragraph">
<p>The result is conversion of all vaults with proper CLI commands.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="Security_Property_Migration"><a class="anchor" href="#Security_Property_Migration"></a>20.9.5. Security Properties</h4>
<div class="paragraph">
<p>Lets suppose security properties "a" and "c" defined in legacy security:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">        &lt;subsystem xmlns="urn:jboss:domain:security:2.0"&gt;
            ...
            &lt;security-properties&gt;
                &lt;property name="a" value="b" /&gt;
                &lt;property name="c" value="d" /&gt;
            &lt;/security-properties&gt;
        &lt;/subsystem&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>To define security properties in Elytron subsystem you need to set
attribute <code>security-properties</code> of the subsystem:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>./subsystem=elytron:write-attribute(name=security-properties, value={ \
    a = "b", \
    c = "d" \
})</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can also add or change one another property without modification of
others using map operations. Following command will set property "e":</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>./subsystem=elytron:map-put(name=security-properties, key=e, value=f)</code></pre>
</div>
</div>
<div class="paragraph">
<p>By the same way you can also remove one of properties - in example newly
created property "e":</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>./subsystem=elytron:map-remove(name=security-properties, key=e)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Output XML configuration will be:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">        &lt;subsystem xmlns="urn:wildfly:elytron:1.0" final-providers="combined-providers" disallowed-providers="OracleUcrypto"&gt;
            &lt;security-properties&gt;
                &lt;security-property name="a" value="b"/&gt;
                &lt;security-property name="c" value="d"/&gt;
            &lt;/security-properties&gt;
            ...
        &lt;/subsystem&gt;</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_ssl_migration"><a class="anchor" href="#_ssl_migration"></a>20.9.6. SSL Migration</h4>

</div>
<div class="sect3">
<h4 id="Simple_SSL_Migration"><a class="anchor" href="#Simple_SSL_Migration"></a>20.9.7. Simple SSL Migration</h4>
<div class="sect4">
<h5 id="simple-ssl-migration"><a class="anchor" href="#simple-ssl-migration"></a>Simple SSL Migration</h5>
<div class="paragraph">
<p>This section describe securing HTTP connections to the server using SSL
using Elytron.<br>
It suppose you have already configured SSL using legacy
<code>security-realm</code>, for example by
<a href="Admin_Guide.html#enable-ssl">Admin Guide#Enable
SSL</a>, and your configuration looks like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;security-realm name="ApplicationRealm"&gt;
  &lt;server-identities&gt;
    &lt;ssl&gt;
      &lt;keystore path="server.keystore" relative-to="jboss.server.config.dir" keystore-password="keystore_password" alias="server" key-password="key_password" /&gt;
    &lt;/ssl&gt;
  &lt;/server-identities&gt;
&lt;/security-realm&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>To switch to Elytron you need to:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Create Elytron <code>key-store</code> - specifying where is the keystore file
stored and password by which it is encrypted. Default type of keystore
generated using keytool is JKS:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=elytron/key-store=LocalhostKeyStore:add(path=server.keystore,relative-to=jboss.server.config.dir,credential-reference={clear-text="keystore_password"},type=JKS)</code></pre>
</div>
</div>
</li>
<li>
<p>Create Elytron <code>key-manager</code> - specifying keystore, alias (using
<code>alias-filter</code>) and password of key:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=elytron/key-manager=LocalhostKeyManager:add(key-store=LocalhostKeyStore,alias-filter=server,credential-reference={clear-text="key_password"})</code></pre>
</div>
</div>
</li>
<li>
<p>Create Elytron <code>server-ssl-context</code> - specifying only reference to
<code>key-manager</code> defined above:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=elytron/server-ssl-context=LocalhostSslContext:add(key-manager=LocalhostKeyManager)</code></pre>
</div>
</div>
</li>
<li>
<p>Switch <code>https-listener</code> from legacy <code>security-realm</code> to newly
created Elytron <code>ssl-context</code>:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=undertow/server=default-server/https-listener=https:undefine-attribute(name=security-realm)
/subsystem=undertow/server=default-server/https-listener=https:write-attribute(name=ssl-context,value=LocalhostSslContext)</code></pre>
</div>
</div>
</li>
<li>
<p>And reload the server:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>reload</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>Output XML configuration of Elytron subsystem should look like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">        &lt;subsystem xmlns="urn:wildfly:elytron:1.0" ...&gt;
            ...
            &lt;tls&gt;
                &lt;key-stores&gt;
                    &lt;key-store name="LocalhostKeyStore"&gt;
                        &lt;credential-reference clear-text="keystore_password"/&gt;
                        &lt;implementation type="JKS"/&gt;
                        &lt;file path="server.keystore" relative-to="jboss.server.config.dir"/&gt;
                    &lt;/key-store&gt;
                &lt;/key-stores&gt;
                &lt;key-managers&gt;
                    &lt;key-manager name="LocalhostKeyManager" key-store="LocalhostKeyStore"&gt;
                        &lt;credential-reference clear-text="key_password"/&gt;
                    &lt;/key-manager&gt;
                &lt;/key-managers&gt;
                &lt;server-ssl-contexts&gt;
                    &lt;server-ssl-context name="LocalhostSslContext" key-manager="LocalhostKeyManager"/&gt;
                &lt;/server-ssl-contexts&gt;
            &lt;/tls&gt;
        &lt;/subsystem&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Output <code>https-listener</code> in Undertow subsystem should be:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;https-listener name="https" socket-binding="https" ssl-context="LocalhostSslContext" enable-http2="true"/&gt;</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="client-cert-ssl-authentication-migration"><a class="anchor" href="#client-cert-ssl-authentication-migration"></a>Client-Cert SSL Authentication Migration</h5>
<div class="paragraph">
<p>This suppose you have already configured Client-Cert SSL authentication
using <code>truststore</code> in legacy <code>security-realm</code>, for example by
<a href="Admin_Guide.html#add-client-cert-to-ssl">Admin
Guide#Add Client-Cert to SSL</a>, and your configuration looks like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;security-realm name="ApplicationRealm"&gt;
  &lt;server-identities&gt;
    &lt;ssl&gt;
      &lt;keystore path="server.keystore" relative-to="jboss.server.config.dir" keystore-password="keystore_password" alias="server" key-password="key_password" /&gt;
    &lt;/ssl&gt;
  &lt;/server-identities&gt;
  &lt;authentication&gt;
    &lt;truststore path="server.truststore" relative-to="jboss.server.config.dir" keystore-password="truststore_password" /&gt;
    &lt;local default-user="$local"/&gt;
    &lt;properties path="application-users.properties" relative-to="jboss.server.config.dir"/&gt;
  &lt;/authentication&gt;
&lt;/security-realm&gt;</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Following configuration is sufficient to prevent users without valid
certificate and private key to access the server, but it does not
provide user identity to the application. That require to define
<code>CLIENT_CERT</code> HTTP mechanism / <code>EXTERNAL</code> SASL mechanism, which will be
described later.)
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>At first use steps above to migrate basic part of the configuration.
Then continue by following:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Create <code>key-store</code> of truststore - like for keystore above:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=elytron/key-store=TrustStore:add(path=server.truststore,relative-to=jboss.server.config.dir,credential-reference={clear-text="truststore_password"},type=JKS)</code></pre>
</div>
</div>
</li>
<li>
<p>Create <code>trust-manager</code> - specifying <code>key-store</code> of trustore, created
above:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=elytron/trust-manager=TrustManager:add(key-store=TrustStore)</code></pre>
</div>
</div>
</li>
<li>
<p>Modify <code>server-ssl-context</code> to use newly created trustmanager:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=elytron/server-ssl-context=LocalhostSslContext:write-attribute(name=trust-manager,value=TrustManager)</code></pre>
</div>
</div>
</li>
<li>
<p>Enable client authentication for <code>server-ssl-context</code>:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=elytron/server-ssl-context=LocalhostSslContext:write-attribute(name=need-client-auth,value=true)</code></pre>
</div>
</div>
</li>
<li>
<p>And reload the server:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>reload</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>Output XML configuration of Elytron subsystem should look like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;subsystem xmlns="urn:wildfly:elytron:1.0" ...&gt;
    ...
    &lt;tls&gt;
        &lt;key-stores&gt;
            &lt;key-store name="LocalhostKeyStore"&gt;
                &lt;credential-reference clear-text="keystore_password"/&gt;
                &lt;implementation type="JKS"/&gt;
                &lt;file path="server.keystore" relative-to="jboss.server.config.dir"/&gt;
            &lt;/key-store&gt;
            &lt;key-store name="TrustStore"&gt;
                &lt;credential-reference clear-text="truststore_password"/&gt;
                &lt;implementation type="JKS"/&gt;
                &lt;file path="server.truststore" relative-to="jboss.server.config.dir"/&gt;
            &lt;/key-store&gt;
        &lt;/key-stores&gt;
        &lt;key-managers&gt;
            &lt;key-manager name="LocalhostKeyManager" key-store="LocalhostKeyStore" alias-filter="server"&gt;
                &lt;credential-reference clear-text="key_password"/&gt;
            &lt;/key-manager&gt;
        &lt;/key-managers&gt;
        &lt;trust-managers&gt;
            &lt;trust-manager name="TrustManager" key-store="TrustStore"/&gt;
        &lt;/trust-managers&gt;
        &lt;server-ssl-contexts&gt;
            &lt;server-ssl-context name="LocalhostSslContext" need-client-auth="true" key-manager="LocalhostKeyManager" trust-manager="TrustManager"/&gt;
        &lt;/server-ssl-contexts&gt;
    &lt;/tls&gt;
&lt;/subsystem&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="SSL_with_Client_Cert_Migration"><a class="anchor" href="#SSL_with_Client_Cert_Migration"></a>20.9.8. SSL with Client Cert Migration</h4>
<div class="paragraph">
<p>As this documentation is primarily intended for users migrating to WildFly Elytron I am going to jump straight into the configuration required with WildFly Elytron.</p>
</div>
<div class="paragraph">
<p>This section will cover how to create the various resources required to achieve CLIENT_CERT authentication with fallback to username / password authentication for both HTTP and SASL (i.e. Remoting) - both are being covered at the same time as predominantly they require the same core configuration, it is not until the definition of the authentication factories that the configuration becomes really specific.</p>
</div>
<div class="paragraph">
<p>This suppose you have configured legacy Client-Cert SSL authentication using <code>truststore</code> in legacy <code>security-realm</code>, for example by <a href="Admin_Guide.html#add-client-cert-to-ssl">Admin Guide#Add Client-Cert to SSL</a>, and your configuration looks like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;security-realm name="ManagementRealm"&gt;
  &lt;server-identities&gt;
    &lt;ssl&gt;
      &lt;keystore path="server.keystore" relative-to="jboss.server.config.dir" keystore-password="keystore_password" alias="server" key-password="key_password" /&gt;
    &lt;/ssl&gt;
  &lt;/server-identities&gt;
  &lt;authentication&gt;
    &lt;truststore path="server.truststore" relative-to="jboss.server.config.dir" keystore-password="truststore_password" /&gt;
    &lt;local default-user="$local"/&gt;
    &lt;properties path="mgmt-users.properties" relative-to="jboss.server.config.dir"/&gt;
  &lt;/authentication&gt;
&lt;/security-realm&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>This also suppose you have already followed <a href="#Simple_SSL_Migration">Simple SSL Migration</a> section, so your partialy migrated configuration looks like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;subsystem xmlns="urn:wildfly:elytron:1.0" ...&gt;
    ...
    &lt;tls&gt;
        &lt;key-stores&gt;
            &lt;key-store name="LocalhostKeyStore"&gt;
                &lt;credential-reference clear-text="keystore_password"/&gt;
                &lt;implementation type="JKS"/&gt;
                &lt;file path="server.keystore" relative-to="jboss.server.config.dir"/&gt;
            &lt;/key-store&gt;
            &lt;key-store name="TrustStore"&gt;
                &lt;credential-reference clear-text="truststore_password"/&gt;
                &lt;implementation type="JKS"/&gt;
                &lt;file path="server.truststore" relative-to="jboss.server.config.dir"/&gt;
            &lt;/key-store&gt;
        &lt;/key-stores&gt;
        &lt;key-managers&gt;
            &lt;key-manager name="LocalhostKeyManager" key-store="LocalhostKeyStore" alias-filter="server"&gt;
                &lt;credential-reference clear-text="key_password"/&gt;
            &lt;/key-manager&gt;
        &lt;/key-managers&gt;
        &lt;trust-managers&gt;
            &lt;trust-manager name="TrustManager" key-store="TrustStore"/&gt;
        &lt;/trust-managers&gt;
        &lt;server-ssl-contexts&gt;
            &lt;server-ssl-context name="LocalhostSslContext" need-client-auth="true" key-manager="LocalhostKeyManager" trust-manager="TrustManager"/&gt;
        &lt;/server-ssl-contexts&gt;
    &lt;/tls&gt;
&lt;/subsystem&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>However following steps are needed to be user identity provided to your applications or management console.</p>
</div>
<div class="sect4">
<h5 id="_realms_and_domains"><a class="anchor" href="#_realms_and_domains"></a>Realms and Domains</h5>
<div class="paragraph">
<p>We use users stored in standard properties files, so we can predefined Elytron security domain <code>ManagementDomain</code> and realm <code>ManagementRealm</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">    &lt;security-domains&gt;
        &lt;security-domain name="ManagementDomain" default-realm="ManagementRealm" permission-mapper="default-permission-mapper"&gt;
            &lt;realm name="ManagementRealm" role-decoder="groups-to-roles"/&gt;
            &lt;realm name="local"/&gt;
        &lt;/security-domain&gt;
    &lt;/security-domains&gt;
    &lt;security-realms&gt;
        &lt;properties-realm name="ManagementRealm"&gt;
            &lt;users-properties path="mgmt-users.properties" relative-to="jboss.server.config.dir" digest-realm-name="ManagementRealm"/&gt;
            &lt;groups-properties path="mgmt-groups.properties" relative-to="jboss.server.config.dir"/&gt;
        &lt;/properties-realm&gt;
    &lt;/security-realms&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The security realm will be used in two situations:
* Authentication in password fallback case, when certificate authentication fails
* Authorization in both - password and certificate auth - cases - the realm will provide roles of individual users</p>
</div>
<div class="paragraph">
<p>This mean, for any client certificate there have to exists user in the security realm.</p>
</div>
</div>
<div class="sect4">
<h5 id="_principal_decoder"><a class="anchor" href="#_principal_decoder"></a>Principal decoder</h5>
<div class="paragraph">
<p>When certificate authentication is used and the security realm accepts usernames to resolve an identity, there have to be defined way to obtain username from a client certificate.
In this case we will use first CN attribute in certificate subject:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>./subsystem=elytron/x500-attribute-principal-decoder=x500-decoder:add(attribute-name=CN, maximum-segments=1)</pre>
</div>
</div>
<div class="paragraph">
<p>Resulting in: -</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;subsystem xmlns="urn:wildfly:elytron:1.1" final-providers="combined-providers" disallowed-providers="OracleUcrypto"&gt;
  ...
  &lt;mappers&gt;
    ...
    &lt;x500-attribute-principal-decoder name="x500-decoder" attribute-name="CN" maximum-segments="1"/&gt;
    ...
  &lt;/mappers&gt;
  ...
&lt;/subsystem&gt;</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_http_authentication_factory"><a class="anchor" href="#_http_authentication_factory"></a>HTTP Authentication Factory</h5>
<div class="paragraph">
<p>For the HTTP connections we now define a HTTP authentication factory using the previously defined resources and it is configured to support CLIENT_CERT and DIGEST authentication.</p>
</div>
<div class="paragraph">
<p>Because our security realm is not able to verify client certificates (properties realm verifies passwords only), we need to add configuring mechanism factory first, which will disable certificate verification against the security realm:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>/subsystem=elytron/configurable-http-server-mechanism-factory=configured-cert:add(http-server-mechanism-factory=global, properties={org.wildfly.security.http.skip-certificate-verification=true})</pre>
</div>
</div>
<div class="paragraph">
<p>As following, we can create HTTP authentication alone:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>./subsystem=elytron/http-authentication-factory=client-cert-digest:add(http-server-mechanism-factory=configured-cert, \
  security-domain=ManagementDomain, \
 mechanism-configurations=[{ \
  mechanism-name=CLIENT_CERT, \
  pre-realm-principal-transformer=x500-decoder}, \
 {mechanism-name=DIGEST, mechanism-realm-configurations=[{realm-name=ManagementRealm}]}])</pre>
</div>
</div>
<div class="paragraph">
<p>Resulting in: -</p>
</div>
<div class="listingblock">
<div class="content">
<pre>&lt;subsystem xmlns="urn:wildfly:elytron:1.1" final-providers="combined-providers" disallowed-providers="OracleUcrypto"&gt;
  ...
  &lt;http&gt;
    ...
    &lt;http-authentication-factory name="client-cert-digest" http-server-mechanism-factory="global" security-domain="ManagementDomain"&gt;
      &lt;mechanism-configuration&gt;
        &lt;mechanism mechanism-name="CLIENT_CERT" pre-realm-principal-transformer="x500-decoder"/&gt;
        &lt;mechanism mechanism-name="DIGEST"&gt;
          &lt;mechanism-realm realm-name="ManagementRealm"/&gt;
        &lt;/mechanism&gt;
      &lt;/mechanism-configuration&gt;
    &lt;/http-authentication-factory&gt;
    ...
    &lt;configurable-http-server-mechanism-factory name="configured-cert" http-server-mechanism-factory="global"&gt;
        &lt;properties&gt;
            &lt;property name="org.wildfly.security.http.skip-certificate-verification" value="true"/&gt;
        &lt;/properties&gt;
    &lt;/configurable-http-server-mechanism-factory&gt;
    ...
  &lt;/http&gt;
  ...
&lt;/subsystem&gt;</pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_sasl_authentication_factory"><a class="anchor" href="#_sasl_authentication_factory"></a>SASL Authentication Factory</h5>
<div class="paragraph">
<p>The architecture of the two authentication factories if very similar so a SASL authentication factory can be defined in the same way as the HTTP equivalent.
However, as EXTERNAL SASL mechanism does not do any certificate verification, there is no need for configuring SASL server factory.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>./subsystem=elytron/sasl-authentication-factory=client-cert-digest:add(sasl-server-factory=elytron, \
  security-domain=ManagementDomain, \
  mechanism-configurations=[{mechanism-name=EXTERNAL, \
  pre-realm-principal-transformer=x500-decoder}, \
  {mechanism-name=DIGEST-MD5, mechanism-realm-configurations=[{realm-name=ManagementRealm}]}])</pre>
</div>
</div>
<div class="paragraph">
<p>This results in: -</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;subsystem xmlns="urn:wildfly:elytron:1.1" final-providers="combined-providers" disallowed-providers="OracleUcrypto"&gt;
  ...
  &lt;sasl&gt;
    ...
    &lt;sasl-authentication-factory name="client-cert-digest" sasl-server-factory="elytron" security-domain="ManagementDomain"&gt;
      &lt;mechanism-configuration&gt;
        &lt;mechanism mechanism-name="EXTERNAL" pre-realm-principal-transformer="x500-decoder"/&gt;
        &lt;mechanism mechanism-name="DIGEST-MD5"&gt;
          &lt;mechanism-realm realm-name="ManagementRealm"/&gt;
        &lt;/mechanism&gt;
      &lt;/mechanism-configuration&gt;
    &lt;/sasl-authentication-factory&gt;
    ...
  &lt;/sasl&gt;
  ...
&lt;/subsystem&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>There is used the same principal transformer as defined for HTTP.</p>
</div>
</div>
<div class="sect4">
<h5 id="_ssl_context"><a class="anchor" href="#_ssl_context"></a>SSL Context</h5>
<div class="paragraph">
<p>The SSL context was already defined, but we need to modify it to not fail on client certificate authentication failure, but to fallback to password authentication.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>./subsystem=elytron/server-ssl-context=LocalhostSslContext:write-attribute(name=need-client-auth, value=false)
./subsystem=elytron/server-ssl-context=LocalhostSslContext:write-attribute(name=want-client-auth, value=true)</pre>
</div>
</div>
<div class="paragraph">
<p>Resulting in: -</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;subsystem xmlns="urn:wildfly:elytron:1.1" final-providers="combined-providers" disallowed-providers="OracleUcrypto"&gt;
  ...
  &lt;tls&gt;
    ...
    &lt;server-ssl-contexts&gt;
      &lt;server-ssl-context name="LocalhostSslContext" want-client-auth="true" need-client-auth="false" key-manager="LocalhostKeyManager" trust-manager="TrustManager"/&gt;
    &lt;/server-ssl-contexts&gt;
  &lt;/tls&gt;
&lt;/subsystem&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>As we will be supporting fallback to username/password authentication need-client-auth is set to false. This allows connections to be established but an alternative form of authentication will be required.</p>
</div>
</div>
<div class="sect4">
<h5 id="_using_for_management"><a class="anchor" href="#_using_for_management"></a>Using for Management</h5>
<div class="paragraph">
<p>At this point the management interfaces can be updated to use the newly defined resources, we need to add references to the two new authentication factories and the SSL context, we can also remove the existing reference to the legacy security realm. As this is modifying existing interfaces a server reload will also be required.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>./core-service=management/management-interface=http-interface:write-attribute(name=ssl-context, value=LocalhostSslContext)
./core-service=management/management-interface=http-interface:write-attribute(name=secure-socket-binding, value=management-https)
./core-service=management/management-interface=http-interface:write-attribute(name=http-authentication-factory, value=client-cert-digest)
./core-service=management/management-interface=http-interface:write-attribute(name=http-upgrade.sasl-authentication-factory, value=client-cert-digest)
./core-service=management/management-interface=http-interface:undefine-attribute(name=security-realm)
:reload</pre>
</div>
</div>
<div class="paragraph">
<p>The management interface configuration then becomes: -</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;management&gt;
  ...
  &lt;management-interfaces&gt;
    &lt;http-interface http-authentication-factory="client-cert-digest" ssl-context="LocalhostSslContext"&gt;
      &lt;http-upgrade enabled="true" sasl-authentication-factory="client-cert-digest"/&gt;
      &lt;socket-binding http="management-http" https="management-https"/&gt;
    &lt;/http-interface&gt;
  &lt;/management-interfaces&gt;
  ...
&lt;/management&gt;</code></pre>
</div>
</div>
<div class="sect5">
<h6 id="_admin_clients"><a class="anchor" href="#_admin_clients"></a>Admin Clients</h6>
<div class="paragraph">
<p>At this stage assuming the same files have been used as in this example it should be possible to connect to the management interface of the server either using a web browser or the JBoss CLI with username and password from your original <code>mgmt-users.properties</code> file.</p>
</div>
<div class="paragraph">
<p>For certificate based authentication certificates signed by your CA, whose subject DN resolves to username existing in properties realm will be accepted.</p>
</div>
<div class="sect6">
<h7 id="_cli_client_configuration"><a class="anchor" href="#_cli_client_configuration"></a>CLI Client Configuration</h7>
<div class="paragraph">
<p>This suppose you have used following configuration in <code>bin/jboss-cli.xml</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;ssl&gt;
  &lt;alias&gt;adminalias&lt;/alias&gt;
  &lt;key-store&gt;admin.keystore&lt;/key-store&gt;
  &lt;key-store-password&gt;keystore_password&lt;/key-store-password&gt;
  &lt;trust-store&gt;ca.truststore&lt;/trust-store&gt;
  &lt;trust-store-password&gt;truststore_password&lt;/trust-store-password&gt;
&lt;/ssl&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can stay using this configuration, but since the integration of WildFly Elytron it is possible with the CLI to use a configuration file wildfly-config.xml to define the security settings including the settings for the client side SSL context.</p>
</div>
<div class="paragraph">
<p>In such case, following wildfly-config.xml can be created in the location the JBoss CLI is being started from: -</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;?xml version="1.0" encoding="UTF-8"?&gt;

&lt;configuration&gt;
    &lt;authentication-client xmlns="urn:elytron:1.0"&gt;
        &lt;key-stores&gt;
            &lt;key-store name="admin" type="jks" &gt;
                &lt;file name="admin.keystore"/&gt;
                &lt;key-store-clear-password password="keystore_password" /&gt;
            &lt;/key-store&gt;
            &lt;key-store name="ca" type="jks"&gt;
                &lt;file name="ca.truststore"/&gt;
                &lt;key-store-clear-password password="truststore_password" /&gt;
            &lt;/key-store&gt;
        &lt;/key-stores&gt;
        &lt;ssl-context-rules&gt;
            &lt;rule use-ssl-context="default" /&gt;
        &lt;/ssl-context-rules&gt;
        &lt;ssl-contexts&gt;
            &lt;ssl-context name="default"&gt;
                &lt;key-store-ssl-certificate key-store-name="admin" alias="adminalias"&gt;
                    &lt;key-store-clear-password password="key_password" /&gt;
                &lt;/key-store-ssl-certificate&gt;
                &lt;trust-store key-store-name="ca" /&gt;
            &lt;/ssl-context&gt;
        &lt;/ssl-contexts&gt;
    &lt;/authentication-client&gt;
&lt;/configuration&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The CLI can now be started using the following command: -</p>
</div>
<div class="listingblock">
<div class="content">
<pre>./jboss-cli.sh -c -Dwildfly.config.url=wildfly-config.xml</pre>
</div>
</div>
<div class="paragraph">
<p>The :whoami command can be used within the CLI to double check the current identity.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>[standalone@localhost:9993 /] :whoami(verbose=true)
{
    "outcome" =&gt; "success",
    "result" =&gt; {
        "identity" =&gt; {"username" =&gt; "admin"},
        "mapped-roles" =&gt; ["SuperUser"]
    }
}</pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="documentation-still-needed"><a class="anchor" href="#documentation-still-needed"></a>20.9.9. Documentation Still Needed</h4>
<div class="ulist">
<ul>
<li>
<p>How to migrate application which uses different identity store for
authentication and authorization (migration to Elytron aggregate-realm).</p>
</li>
<li>
<p>How migrate to using cache (migration to caching-realm)</p>
</li>
<li>
<p>Limitations for migration from PicketBox/legacy security to Elytron,
for example, Infinispan cache cannot be used, any others?</p>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
</article>
  </div>
</main>
</div>
<footer class="footer">
  <p>This page was built using the Antora default UI.</p>
  <p>The source code for this UI is licensed under the terms of the MPL-2.0 license.</p>
</footer>
<script src="../_/js/site.js"></script>
<script async src="../_/js/vendor/highlight.js"></script>
  </body>
</html>
