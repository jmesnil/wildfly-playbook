<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Developer Guide :: My Demo Site</title>
    <link rel="canonical" href="https://docs.demo.com/wildfly/Developer_Guide.html">
    <meta name="generator" content="Antora 2.3.4">
    <link rel="stylesheet" href="../_/css/site.css">
    <script>var uiRootPath = '../_'</script>
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://docs.demo.com">My Demo Site</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="#">Home</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Products</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Product A</a>
            <a class="navbar-item" href="#">Product B</a>
            <a class="navbar-item" href="#">Product C</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Services</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Service A</a>
            <a class="navbar-item" href="#">Service B</a>
            <a class="navbar-item" href="#">Service C</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Resources</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Resource A</a>
            <a class="navbar-item" href="#">Resource B</a>
            <a class="navbar-item" href="#">Resource C</a>
          </div>
        </div>
        <div class="navbar-item">
          <span class="control">
            <a class="button is-primary" href="#">Download</a>
          </span>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="wildfly" data-version="master">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-explore is-active" data-panel="explore">
  <div class="context">
    <span class="title">WildFly</span>
    <span class="version">master</span>
  </div>
  <ul class="components">
    <li class="component">
      <a class="title" href="../wildfly-operator/user-guide.html">Kubernetes Operator for WildFly</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../wildfly-operator/user-guide.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component is-current">
      <a class="title" href="index.html">WildFly</a>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="index.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../wildfly-cloud/main/index.html">WildFly on the Cloud</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../wildfly-cloud/main/index.html">main</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
</nav>
  <div class="edit-this-page"><a href="https://github.com/jmesnil/wildfly/edit/antora/docs/modules/ROOT/pages/Developer_Guide.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<h1 class="page">Developer Guide</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>&#169; 2017 The original authors.</p>
</div>
<div id="toc" class="toc">
<div id="toctitle" class="title">WildFly Developer guide</div>
<ul class="sectlevel1">
<li><a href="#Class_Loading_in_WildFly">1. Class Loading in WildFly</a>
<ul class="sectlevel2">
<li><a href="#deployment-module-names">1.1. Deployment Module Names</a></li>
<li><a href="#automatic-dependencies">1.2. Automatic Dependencies</a></li>
<li><a href="#class-loading-precedence">1.3. Class Loading Precedence</a></li>
<li><a href="#war-class-loading">1.4. WAR Class Loading</a></li>
<li><a href="#ear-class-loading">1.5. EAR Class Loading</a></li>
<li><a href="#global-modules">1.6. Global Modules</a></li>
<li><a href="#global-directory">1.7. Global Directory</a></li>
<li><a href="#jboss-deployment-structure-file">1.8. JBoss Deployment Structure File</a></li>
<li><a href="#accessing-jdk-classes">1.9. Accessing JDK classes</a></li>
<li><a href="#the-jboss.api-property-and-application-use-of-modules-shipped-with-wildfly">1.10. The "jboss.api" property and application use of modules shipped with WildFly</a></li>
<li><a href="#how-to-list-the-module-dependencies-of-a-deployed-application">1.11. How to list the module dependencies of a deployed application</a></li>
</ul>
</li>
<li><a href="#Implicit_module_dependencies_for_deployments">2. Implicit module dependencies for deployments</a>
<ul class="sectlevel2">
<li><a href="#whats-an-implicit-module-dependency">2.1. What&#8217;s an implicit module dependency?</a></li>
<li><a href="#how-and-when-is-an-implicit-module-dependency-added">2.2. How and when is an implicit module dependency added?</a></li>
<li><a href="#which-are-the-implicit-module-dependencies">2.3. Which are the implicit module dependencies?</a></li>
</ul>
</li>
<li><a href="#Deployment_Descriptors_used_In_WildFly">3. Deployment Descriptors used In WildFly</a></li>
<li><a href="#Development_Guidelines_and_Recommended_Practices">4. Development Guidelines and Recommended Practices</a></li>
<li><a href="#Application_Client_Reference">5. Application Client Reference</a>
<ul class="sectlevel2">
<li><a href="#getting-started">5.1. Getting Started</a></li>
<li><a href="#connecting-to-more-than-one-host">5.2. Connecting to more than one host</a></li>
<li><a href="#example-application-client-reference">5.3. Example</a></li>
</ul>
</li>
<li><a href="#embedded-api">6. Embedded API</a>
<ul class="sectlevel2">
<li><a href="#standalone-api">6.1. Standalone API</a></li>
<li><a href="#host-controller-api">6.2. Host Controller API</a></li>
</ul>
</li>
<li><a href="#CDI_Reference">7. CDI Reference</a>
<ul class="sectlevel2">
<li><a href="#using-cdi-beans-from-outside-the-deployment">7.1. Using CDI Beans from outside the deployment</a></li>
<li><a href="#suppressing-implicit-bean-archives">7.2. Suppressing implicit bean archives</a></li>
<li><a href="#development-mode">7.3. Development mode</a></li>
<li><a href="#non-portable-mode">7.4. Non-portable mode</a></li>
</ul>
</li>
<li><a href="#EE_Concurrency_Utilities">8. EE Concurrency Utilities</a>
<ul class="sectlevel2">
<li><a href="#context-service">8.1. Context Service</a></li>
<li><a href="#managed-thread-factory">8.2. Managed Thread Factory</a></li>
<li><a href="#managed-executor-service">8.3. Managed Executor Service</a></li>
<li><a href="#managed-scheduled-executor-service">8.4. Managed Scheduled Executor Service</a></li>
</ul>
</li>
<li><a href="#Jakarta_Enterprise_Beans_3_Reference_Guide">9. Jakarta Enterprise Beans 3 Reference Guide</a>
<ul class="sectlevel2">
<li><a href="#resource-adapter-for-message-driven-beans">9.1. Resource Adapter for Message Driven Beans</a></li>
<li><a href="#run-as-principal">9.2. Run-as Principal</a></li>
<li><a href="#security-domain-Jakarta-Enterprise-Beans-3-ref">9.3. Security Domain</a></li>
<li><a href="#transaction-timeout">9.4. Transaction Timeout</a></li>
<li><a href="#timer-service">9.5. Timer service</a></li>
<li><a href="#Container_interceptors">9.6. Container interceptors</a></li>
<li><a href="#Jakarta_Enterprise_Beans_Clustered_Database_Timers">9.7. Jakarta Enterprise Beans 3 Clustered Database Timers</a></li>
<li><a href="#Jakarta_Enterprise_Beans_IIOP_Guide">9.8. Jakarta Enterprise Beans IIOP Guide</a></li>
<li><a href="#Jakarta_Enterprise_Beans_over_HTTP">9.9. Jakarta Enterprise Beans over HTTP</a></li>
<li><a href="#jboss-ejb3">9.10. jboss-ejb3.xml Reference</a></li>
<li><a href="#Message_Driven_Beans_Controlled_Delivery">9.11. Message Driven Beans Controlled Delivery</a></li>
<li><a href="#Securing_Jakarta_Enterprise_Beans">9.12. Securing Jakarta Enterprise Beans</a></li>
<li><a href="#jakarta-enterprise-beans-client-interceptors">9.13. Jakarta Enterprise Beans Client Interceptors</a></li>
<li><a href="#Jakarta_Enterprise_Beans_on_Kubernetes">9.14. Jakarta Enterprise Beans on Kubernetes</a></li>
<li><a href="#Jakarta_Enterprise_Beans_Deployment_Runtime_Resources">9.15. Jakarta Enterprise Beans Deployment Runtime Resources</a></li>
</ul>
</li>
<li><a href="#JPA_Reference_Guide">10. JPA Reference Guide</a>
<ul class="sectlevel2">
<li><a href="#introduction">10.1. Introduction</a></li>
<li><a href="#update-your-persistence.xml-for-hibernate">10.2. Update your Persistence.xml for Hibernate</a></li>
<li><a href="#entity-manager">10.3. Entity manager</a></li>
<li><a href="#container-managed-entity-manager">10.4. Container-managed entity manager</a></li>
<li><a href="#application-managed-entity-manager">10.5. Application-managed entity manager</a></li>
<li><a href="#persistence-context">10.6. Persistence Context</a></li>
<li><a href="#transaction-scoped-persistence-context">10.7. Transaction-scoped Persistence Context</a></li>
<li><a href="#extended-persistence-context">10.8. Extended Persistence Context</a></li>
<li><a href="#entities">10.9. Entities</a></li>
<li><a href="#deployment">10.10. Deployment</a></li>
<li><a href="#troubleshooting">10.11. Troubleshooting</a></li>
<li><a href="#using-the-infinispan-second-level-cache">10.12. Using the Infinispan second level cache</a></li>
<li><a href="#using-hibernate-search">10.13. Using Hibernate Search</a></li>
<li><a href="#packaging-the-hibernate-jpa-persistence-provider-with-your-application">10.14. Packaging the Hibernate JPA persistence provider with your application</a></li>
<li><a href="#migrating-from-openjpa">10.15. Migrating from OpenJPA</a></li>
<li><a href="#migrating-from-eclipselink">10.16. Migrating from EclipseLink</a></li>
<li><a href="#native-hibernate-use">10.17. Native Hibernate use</a></li>
<li><a href="#injection-of-hibernate-session-and-sessionfactoryinjection-of-hibernate-session-and-sessionfactory">10.18. Injection of Hibernate Session and SessionFactory</a></li>
<li><a href="#hibernate-transformer">10.19. Hibernate ORM 5.1 native API bytecode transformer</a></li>
<li><a href="#hibernate-properties">10.20. Hibernate properties</a></li>
<li><a href="#persistence-unit-properties">10.21. Persistence unit properties</a></li>
<li><a href="#determine-the-persistence-provider-module">10.22. Determine the persistence provider module</a></li>
<li><a href="#binding-entitymanagerfactoryentitymanager-to-jndi">10.23. Binding EntityManagerFactory/EntityManager to JNDI</a></li>
<li><a href="#tips-for-using-the-latest-hibernate-orm">10.24. Tips for using the latest Hibernate ORM</a></li>
</ul>
</li>
<li><a href="#JTA_Reference">11. JTA Reference</a>
<ul class="sectlevel2">
<li><a href="#transactions-in-enterprise-java-applications">11.1. Transactions in Enterprise Java applications</a></li>
<li><a href="#classloading">11.2. Transactions subsystem class loading</a></li>
<li><a href="#troubleshooting">11.3. Transactions troubleshooting</a></li>
<li><a href="#transactions-configuration">11.4. Transactions configuration</a></li>
</ul>
</li>
<li><a href="#JNDI_Reference">12. JNDI Reference</a></li>
<li><a href="#JNDI_Local_Reference">13. Local JNDI</a>
<ul class="sectlevel2">
<li><a href="#binding-entries-to-jndi">13.1. Binding entries to JNDI</a></li>
<li><a href="#retrieving-entries-from-jndi">13.2. Retrieving entries from JNDI</a></li>
</ul>
</li>
<li><a href="#JNDI_Remote_Reference">14. Remote JNDI Access</a>
<ul class="sectlevel2">
<li><a href="#http-remoting">14.1. http-remoting:</a></li>
<li><a href="#ejb">14.2. ejb:</a></li>
</ul>
</li>
<li><a href="#Jakarta_RESTful_Web_Services_Reference_Guide">15. Jakarta RESTful Web Services Reference Guide</a>
<ul class="sectlevel2">
<li><a href="#subclassing-javax.ws.rs.core.application-and-using-applicationpath">15.1. Subclassing javax.ws.rs.core.Application and using @ApplicationPath</a></li>
<li><a href="#subclassing-javax.ws.rs.core.application-and-using-web.xml">15.2. Subclassing javax.ws.rs.core.Application and using web.xml</a></li>
<li><a href="#using-web.xml">15.3. Using web.xml</a></li>
</ul>
</li>
<li><a href="#Jakarta_XML_Web_Services_Reference_guide">16. Webservices reference guide</a>
<ul class="sectlevel2">
<li><a href="#Jakarta_XML_Web_Services_User_Guide">16.1. Jakarta XML Web Services User Guide</a></li>
<li><a href="#Jakarta_XML_Web_Services_Tools">16.2. Jakarta XML Web Services Tools</a></li>
<li><a href="#wsconsume">16.3. wsconsume</a></li>
<li><a href="#wsprovide">16.4. wsprovide</a></li>
<li><a href="#Jakarta_XML_Web_Services_Advanced_User_Guide">16.5. Jakarta XML Web Services Advanced User Guide</a></li>
<li><a href="#JAX_WS_JBoss_Modules_and_WS_applications">16.6. JBoss Modules and WS applications</a></li>
</ul>
</li>
<li><a href="#Scoped_EJB_client_contexts">17. Scoped EJB client contexts</a>
<ul class="sectlevel2">
<li><a href="#potential-shortcomings-of-a-single-ejb-client-context">17.1. Potential shortcomings of a single EJB client context</a></li>
<li><a href="#scoped-ejb-client-contexts">17.2. Scoped EJB client contexts</a></li>
<li><a href="#lifecycle-management-of-scoped-ejb-client-contexts">17.3. Lifecycle management of scoped EJB client contexts</a></li>
</ul>
</li>
<li><a href="#EJB_invocations_from_a_remote_client_using_JNDI">18. EJB invocations from a remote client using JNDI</a>
<ul class="sectlevel2">
<li><a href="#deploying-your-ejbs-on-the-server-side">18.1. Deploying your EJBs on the server side:</a></li>
<li><a href="#writing-a-remote-client-application-for-accessing-and-invoking-the-ejbs-deployed-on-the-server">18.2. Writing a remote client application for accessing and invoking the</a></li>
<li><a href="#setting-up-ejb-client-context-properties">18.3. Setting up EJB client context properties</a></li>
<li><a href="#summary">Summary</a></li>
</ul>
</li>
<li><a href="#EJB_invocations_from_a_remote_server_instance">19. EJB invocations from a remote server instance</a>
<ul class="sectlevel2">
<li><a href="#application-packaging">19.1. Application packaging</a></li>
<li><a href="#beans">19.2. Beans</a></li>
<li><a href="#security">19.3. Security</a></li>
<li><a href="#configuring-a-user-on-the-destination-server">19.4. Configuring a user on the "Destination Server"</a></li>
<li><a href="#start-the-destination-server">19.5. Start the "Destination Server"</a></li>
<li><a href="#deploying-the-application">19.6. Deploying the application</a></li>
<li><a href="#configuring-the-client-server-to-point-to-the-ejb-remoting-connector-on-the-destination-server">19.7. Configuring the "Client Server" to point to the EJB remoting connector</a></li>
<li><a href="#start-the-client-server">19.8. Start the "Client Server"</a></li>
<li><a href="#create-a-security-realm-on-the-client-server">19.9. Create a security realm on the client server</a></li>
<li><a href="#create-a-outbound-socket-binding-on-the-client-server">19.10. Create a outbound-socket-binding on the "Client Server"</a></li>
<li><a href="#create-a-remote-outbound-connection-which-uses-this-newly-created-outbound-socket-binding">19.11. Create a "remote-outbound-connection" which uses this newly created</a></li>
<li><a href="#packaging-the-client-application-on-the-client-server">19.12. Packaging the client application on the "Client Server"</a></li>
<li><a href="#contents-on-jboss-ejb-client.xml">19.13. Contents on jboss-ejb-client.xml</a></li>
<li><a href="#deploy-the-client-application">19.14. Deploy the client application</a></li>
<li><a href="#client-code-invoking-the-bean">19.15. Client code invoking the bean</a></li>
</ul>
</li>
<li><a href="#Remote_Jakarta_Enterprise_Beans_invocations_via_JNDI_-_Jakarta_Enterprise_Beans_client_API_or_wildfly-naming-client_project">20. Remote Jakarta Enterprise Beans invocations via JNDI - Jakarta Enterprise Beans client API or wildfly-naming-client project</a>
<ul class="sectlevel2">
<li><a href="#purpose">20.1. Purpose</a></li>
<li><a href="#overview">20.2. Overview</a></li>
<li><a href="#summary-remote-ejb-invocations">20.3. Summary</a></li>
<li><a href="#remote-ejb-invocations-backed-by-the-wildfly-naming-client-project">20.4. Remote EJB invocations backed by the wildfly-naming-client project</a></li>
<li><a href="#why-use-the-ejb-client-api-approach-then">20.5. Why use the EJB client API approach then?</a></li>
</ul>
</li>
<li><a href="#Migrated_to_WildFly_Example_Applications">21. Example Applications - Migrated to WildFly</a>
<ul class="sectlevel2">
<li><a href="#example-applications-migrated-from-previous-releases">21.1. Example Applications Migrated from Previous Releases</a></li>
<li><a href="#example-applications-based-on-ee6">21.2. Example Applications Based on EE6</a></li>
</ul>
</li>
<li><a href="#Migrate_Order_Application_from_EAP5">22. Porting the Order Application from EAP 5.1 to JBoss AS 7</a>
<ul class="sectlevel2">
<li><a href="#overview-of-the-application">22.1. Overview of the application</a></li>
<li><a href="#summary-of-changes-migrate-order-application">22.2. Summary of changes</a></li>
</ul>
</li>
<li><a href="#Spring_applications_development_and_migration_guide">23. Spring applications development and migration guide</a>
<ul class="sectlevel2">
<li><a href="#dependencies-and-modularity">23.1. Dependencies and Modularity</a></li>
<li><a href="#persistence-usage-guide">23.2. Persistence usage guide</a></li>
<li><a href="#native-springhibernate-applications">23.3. Native Spring/Hibernate applications</a></li>
<li><a href="#Jakarta-Persistence-based-applications">23.4. Jakarta Persistence based applications</a></li>
</ul>
</li>
<li><a href="#How_do_I_migrate_my_application_from_AS7_to_WildFly">24. How do I migrate my application from JBoss AS 7  to WildFly 10</a>
<ul class="sectlevel2">
<li><a href="#about-this-document">24.1. About this Document</a></li>
<li><a href="#overview-of-wildfly">24.2. Overview of WildFly</a></li>
<li><a href="#server-migration">24.3. Server Migration</a></li>
<li><a href="#application-migration">24.4. Application Migration</a></li>
</ul>
</li>
<li><a href="#How_do_I_migrate_my_application_from_WebLogic_to_WildFly">25. How do I migrate my application from WebLogic to WildFly</a>
<ul class="sectlevel2">
<li><a href="#introduction-weblogic-migration">25.1. Introduction</a></li>
</ul>
</li>
<li><a href="#How_do_I_migrate_my_application_from_WebSphere_to_WildFly">26. How do I migrate my application from WebSphere to WildFly</a>
<ul class="sectlevel2">
<li><a href="#introduction-websphere-migration">26.1. Introduction</a></li>
</ul>
</li>
</ul>
</div>
<div class="paragraph">
<div class="title">Target Audience</div>
<p>Java Developers</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="Class_Loading_in_WildFly"><a class="anchor" href="#Class_Loading_in_WildFly"></a>1. Class Loading in WildFly</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Since JBoss AS 7, Class loading is considerably different from previous
versions of JBoss AS. Class loading is based on the
<a href="#Class_Loading_in_WildFly">MODULES</a> project. Instead of the more familiar
hierarchical class loading environment, WildFly&#8217;s class loading is based
on modules that have to define explicit dependencies on other modules.
Deployments in WildFly are also modules, and do not have access to
classes that are defined in jars in the application server unless an
explicit dependency on those classes is defined.</p>
</div>
<div class="sect2">
<h3 id="deployment-module-names"><a class="anchor" href="#deployment-module-names"></a>1.1. Deployment Module Names</h3>
<div class="paragraph">
<p>Module names for top level deployments follow the format
<code>deployment.myarchive.war</code> while sub deployments are named like
<code>deployment.myear.ear.mywar.war</code>.</p>
</div>
<div class="paragraph">
<p>This means that it is possible for a deployment to import classes from
another deployment using the other deployments module name, the details
of how to add an explicit module dependency are explained below.</p>
</div>
</div>
<div class="sect2">
<h3 id="automatic-dependencies"><a class="anchor" href="#automatic-dependencies"></a>1.2. Automatic Dependencies</h3>
<div class="paragraph">
<p>Even though in WildFly modules are isolated by default, as part of the
deployment process some dependencies on modules defined by the
application server are set up for you automatically. For instance, if
you are deploying a Jakarta EE application a dependency on the Java EE
API&#8217;s will be added to your module automatically. Similarly if your
module contains a beans.xml file a dependency on
<a href="http://seamframework.org/Weld">Weld</a> will be added automatically, along
with any supporting modules that weld needs to operate.</p>
</div>
<div class="paragraph">
<p>For a complete list of the automatic dependencies that are added, please
see <a href="#Implicit_module_dependencies_for_deployments">Implicit module dependencies for deployments</a>.</p>
</div>
<div class="paragraph">
<p>Automatic dependencies can be excluded through the use of
<code>jboss-deployment-structure.xml</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="class-loading-precedence"><a class="anchor" href="#class-loading-precedence"></a>1.3. Class Loading Precedence</h3>
<div class="paragraph">
<p>A common source of errors in Java applications is including API classes
in a deployment that are also provided by the container. This can result
in multiple versions of the class being created and the deployment
failing to deploy properly. To prevent this in WildFly, module
dependencies are added in a specific order that should prevent this
situation from occurring.</p>
</div>
<div class="paragraph">
<p>In order of highest priority to lowest priority</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>System Dependencies - These are dependencies that are added to the
module automatically by the container, including the Jakarta EE api&#8217;s.</p>
</li>
<li>
<p>User Dependencies - These are dependencies that are added through
<code>jboss-deployment-structure.xml</code> or through the <code>Dependencies:</code> manifest
entry.</p>
</li>
<li>
<p>Local Resource - Class files packaged up inside the deployment
itself, e.g. class files from <code>WEB-INF/classes</code> or <code>WEB-INF/lib</code> of a
war.</p>
</li>
<li>
<p>Inter deployment dependencies - These are dependencies on other
deployments in an ear deployment. This can include classes in an ear&#8217;s
lib directory, or classes defined in other ejb jars.</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="war-class-loading"><a class="anchor" href="#war-class-loading"></a>1.4. WAR Class Loading</h3>
<div class="paragraph">
<p>The war is considered to be a single module, so classes defined in
<code>WEB-INF/lib</code> are treated the same as classes in <code>WEB-INF/classes</code>. All
classes packaged in the war will be loaded with the same class loader.</p>
</div>
</div>
<div class="sect2">
<h3 id="ear-class-loading"><a class="anchor" href="#ear-class-loading"></a>1.5. EAR Class Loading</h3>
<div class="paragraph">
<p>Ear deployments are multi-module deployments. This means that not all
classes inside an ear will necessarily have access to all other classes
in the ear, unless explicit dependencies have been defined. By default
the <code>EAR/lib</code> directory is a single module, and every WAR or EJB jar
deployment is also a separate module. Sub deployments (wars and
ejb-jars) always have a dependency on the parent module, which gives
them access to classes in <code>EAR/lib</code>, however they do not always have an
automatic dependency on each other. This behaviour is controlled via the
<code>ear-subdeployments-isolated</code> setting in the ee subsystem configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;subsystem xmlns="urn:jboss:domain:ee:1.0" &gt;
  &lt;ear-subdeployments-isolated&gt;false&lt;/ear-subdeployments-isolated&gt;
&lt;/subsystem&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>By default this is set to false, which allows the sub-deployments to see
classes belonging to other sub-deployments within the .ear.</p>
</div>
<div class="paragraph">
<p>For example, consider the following .ear deployment:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>myapp.ear
 |
 |--- web.war
 |
 |--- ejb1.jar
 |
 |--- ejb2.jar</pre>
</div>
</div>
<div class="paragraph">
<p>If the ear-subdeployments-isolated is set to false, then the classes in
web.war can access classes belonging to ejb1.jar and ejb2.jar.
Similarly, classes from ejb1.jar can access classes from ejb2.jar (and
vice-versa).</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The ear-subdeployments-isolated element value has no effect on the
isolated classloader of the .war file(s). i.e. irrespective of whether
this flag is set to true or false, the .war within a .ear will have an
isolated classloader and other sub-deployments within that .ear will not
be able to access classes from that .war. This is as per spec.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>If the ear-subdeployments-isolated is set to true then no automatic
module dependencies between the sub-deployments are set up. User must
manually setup the dependency with <code>Class-Path</code> entries, or by setting
up explicit module dependencies.</p>
</div>
<div class="paragraph">
<p>Portability</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
The Jakarta EE specification says that portable applications should not
rely on sub deployments having access to other sub deployments unless an
explicit Class-Path entry is set in the MANIFEST.MF. So portable
applications should always use Class-Path entry to explicitly state
their dependencies.
</td>
</tr>
</table>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
It is also possible to override the ear-subdeployments-isolated element
value at a per deployment level. See the section on
jboss-deployment-structure.xml below.
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="dependencies-manifest-entries"><a class="anchor" href="#dependencies-manifest-entries"></a>1.5.1. <code>Dependencies:</code> Manifest Entries</h4>
<div class="paragraph">
<p>Deployments (or more correctly modules within a deployment) may set up
dependencies on other modules by adding a <code>Dependencies:</code> manifest
entry. This entry consists of a comma separated list of module names
that the deployment requires. The available modules can be seen under
the <code>modules</code> directory in the application server distribution. For
example to add a dependency on javassist and apache velocity you can add
a manifest entry as follows:</p>
</div>
<div class="paragraph">
<p><code>Dependencies: org.javassist export,org.apache.velocity export services,org.antlr</code></p>
</div>
<div class="paragraph">
<p>Each dependency entry may also specify some of the following parameters
by adding them after the module name:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>export</code> This means that the dependencies will be exported, so any
module that depends on this module will also get access to the
dependency.</p>
</li>
<li>
<p><code>services</code> By default items in META-INF of a dependency are not
accessible, this makes items from <code>META-INF/services</code> accessible so
<a href="http://download.oracle.com/javase/6/docs/api/java/util/ServiceLoader.html">services</a> in
the modules can be loaded.</p>
</li>
<li>
<p><code>optional</code> If this is specified the deployment will not fail if the
module is not available.</p>
</li>
<li>
<p><code>meta-inf</code> This will make the contents of the <code>META-INF</code> directory
available (unlike <code>services</code>, which just makes <code>META-INF/services</code>
available). In general this will not cause any deployment descriptors in
META-INF to be processed, with the exception of <code>beans.xml</code>. If a
<code>beans.xml</code> file is present this module will be scanned by Weld and any
resulting beans will be available to the application.</p>
</li>
<li>
<p><code>annotations</code> If a jandex index has be created for the module these
annotations will be merged into the deployments annotation index. The
<a href="https://github.com/jbossas/jandex">Jandex</a> index can be generated using
the
<a href="https://github.com/jbossas/jandex/blob/master/src/main/java/org/jboss/jandex/JandexAntTask.java">Jandex
ant task</a>, and must be named <code>META-INF/jandex.idx</code>. Note that it is not
necessary to break open the jar being indexed to add this to the modules
class path, a better approach is to create a jar containing just this
index, and adding it as an additional resource root in the <code>module.xml</code>
file.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Adding a dependency to all modules in an EAR</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Using the <code>export</code> parameter it is possible to add a dependency to all
sub deployments in an ear. If a module is exported from a
<code>Dependencies:</code> entry in the top level of the ear (or by a jar in the
<code>ear/lib</code> directory) it will be available to all sub deployments as
well.
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
To generate a MANIFEST.MF entry when using maven put the following in
your pom.xml:
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">pom.xml</div>
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;build&gt;
   ...
   &lt;plugins&gt;
     &lt;plugin&gt;
       &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;
       &lt;artifactId&gt;maven-war-plugin&lt;/artifactId&gt;
       &lt;configuration&gt;
          &lt;archive&gt;
             &lt;manifestEntries&gt;
                &lt;Dependencies&gt;org.slf4j&lt;/Dependencies&gt;
             &lt;/manifestEntries&gt;
          &lt;/archive&gt;
       &lt;/configuration&gt;
     &lt;/plugin&gt;
   &lt;/plugins&gt;
&lt;/build&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>If your deployment is a jar you must use the <code>maven-jar-plugin</code> rather
than the <code>maven-war-plugin</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="class-path-entries"><a class="anchor" href="#class-path-entries"></a>1.5.2. Class Path Entries</h4>
<div class="paragraph">
<p>It is also possible to add module dependencies on other modules inside
the deployment using the <code>Class-Path</code> manifest entry. This can be used
within an ear to set up dependencies between sub deployments, and also
to allow modules access to additional jars deployed in an ear that are
not sub deployments and are not in the <code>EAR/lib</code> directory. If a jar in
the <code>EAR/lib</code> directory references a jar via <code>Class-Path:</code> then this
additional jar is merged into the parent ear&#8217;s module, and is accessible
to all sub deployments in the ear.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="global-modules"><a class="anchor" href="#global-modules"></a>1.6. Global Modules</h3>
<div class="paragraph">
<p>It is also possible to set up global modules, that are accessible to all
deployments. This is done by modifying the configuration file
(standalone/domain.xml).</p>
</div>
<div class="paragraph">
<p>For example, to add javassist to all deployments you can use the
following XML:</p>
</div>
<div class="listingblock">
<div class="title">standalone.xml/domain.xml</div>
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;subsystem xmlns="urn:jboss:domain:ee:1.0" &gt;
  &lt;global-modules&gt;
    &lt;module name="org.javassist" slot="main" /&gt;
  &lt;/global-modules&gt;
&lt;/subsystem&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that the <code>slot</code> field is optional and defaults to <code>main</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="global-directory"><a class="anchor" href="#global-directory"></a>1.7. Global Directory</h3>
<div class="paragraph">
<p>The EE subsystem allows the configuration of a global directory, which represents a directory tree scanned automatically to include .jar files and resources as a single additional dependency. This dependency is added as a system dependency to all deployed application. See <a href="Admin_Guide.html#global-directory">Subsystem EE Global Directory</a> to get more information about how to set up a global directory.</p>
</div>
</div>
<div class="sect2">
<h3 id="jboss-deployment-structure-file"><a class="anchor" href="#jboss-deployment-structure-file"></a>1.8. JBoss Deployment Structure File</h3>
<div class="paragraph">
<p><code>jboss-deployment-structure.xml</code> is a JBoss specific deployment
descriptor that can be used to control class loading in a fine grained
manner. It should be placed in the top level deployment, in <code>META-INF</code>
(or <code>WEB-INF</code> for web deployments). It can do the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Prevent automatic dependencies from being added</p>
</li>
<li>
<p>Add additional dependencies</p>
</li>
<li>
<p>Define additional modules</p>
</li>
<li>
<p>Change an EAR deployments isolated class loading behaviour</p>
</li>
<li>
<p>Add additional resource roots to a module</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>An example of a complete <code>jboss-deployment-structure.xml</code> file for an
ear deployment is as follows:</p>
</div>
<div class="listingblock">
<div class="title">jboss-deployment-structure.xml</div>
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;jboss-deployment-structure&gt;
  &lt;!-- Make sub deployments isolated by default, so they cannot see each others classes without a Class-Path entry --&gt;
  &lt;ear-subdeployments-isolated&gt;true&lt;/ear-subdeployments-isolated&gt;
  &lt;!-- This corresponds to the top level deployment. For a war this is the war's module, for an ear --&gt;
  &lt;!-- This is the top level ear module, which contains all the classes in the EAR's lib folder     --&gt;
  &lt;deployment&gt;
     &lt;!-- exclude-subsystem prevents a subsystems deployment unit processors running on a deployment --&gt;
     &lt;!-- which gives basically the same effect as removing the subsystem, but it only affects single deployment --&gt;
     &lt;exclude-subsystems&gt;
        &lt;subsystem name="resteasy" /&gt;
    &lt;/exclude-subsystems&gt;
    &lt;!-- Exclusions allow you to prevent the server from automatically adding some dependencies     --&gt;
    &lt;exclusions&gt;
        &lt;module name="org.javassist" /&gt;
    &lt;/exclusions&gt;
    &lt;!-- This allows you to define additional dependencies, it is the same as using the Dependencies: manifest attribute --&gt;
    &lt;dependencies&gt;
      &lt;module name="deployment.javassist.proxy" /&gt;
      &lt;module name="deployment.myjavassist" /&gt;
      &lt;!-- Import META-INF/services for ServiceLoader impls as well --&gt;
      &lt;module name="myservicemodule" services="import"/&gt;
    &lt;/dependencies&gt;
    &lt;!-- These add additional classes to the module. In this case it is the same as including the jar in the EAR's lib directory --&gt;
    &lt;resources&gt;
      &lt;resource-root path="my-library.jar" /&gt;
    &lt;/resources&gt;
  &lt;/deployment&gt;
  &lt;sub-deployment name="myapp.war"&gt;
    &lt;!-- This corresponds to the module for a web deployment --&gt;
    &lt;!-- it can use all the same tags as the &lt;deployment&gt; entry above --&gt;
    &lt;dependencies&gt;
      &lt;!-- Adds a dependency on a ejb jar. This could also be done with a Class-Path entry --&gt;
      &lt;module name="deployment.myear.ear.myejbjar.jar" /&gt;
    &lt;/dependencies&gt;
    &lt;!-- Set's local resources to have the lowest priority --&gt;
    &lt;!-- If the same class is both in the sub deployment and in another sub deployment that --&gt;
    &lt;!-- is visible to the war, then the Class from the other deployment will be loaded,  --&gt;
    &lt;!-- rather than the class actually packaged in the war. --&gt;
    &lt;!-- This can be used to resolve ClassCastExceptions  if the same class is in multiple sub deployments--&gt;
    &lt;local-last value="true" /&gt;
  &lt;/sub-deployment&gt;
  &lt;!-- Now we are going to define two additional modules --&gt;
  &lt;!-- This one is a different version of javassist that we have packaged --&gt;
  &lt;module name="deployment.myjavassist" &gt;
    &lt;resources&gt;
     &lt;resource-root path="javassist.jar" &gt;
       &lt;!-- We want to use the servers version of javassist.util.proxy.* so we filter it out--&gt;
       &lt;filter&gt;
         &lt;exclude path="javassist/util/proxy" /&gt;
       &lt;/filter&gt;
     &lt;/resource-root&gt;
    &lt;/resources&gt;
  &lt;/module&gt;
  &lt;!-- This is a module that re-exports the containers version of javassist.util.proxy --&gt;
  &lt;!-- This means that there is only one version of the Proxy classes defined          --&gt;
  &lt;module name="deployment.javassist.proxy" &gt;
    &lt;dependencies&gt;
      &lt;module name="org.javassist" &gt;
        &lt;imports&gt;
          &lt;include path="javassist/util/proxy" /&gt;
          &lt;exclude path="/**" /&gt;
        &lt;/imports&gt;
      &lt;/module&gt;
    &lt;/dependencies&gt;
  &lt;/module&gt;
&lt;/jboss-deployment-structure&gt;</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
The xsd for jboss-deployment-structure.xml is available at
<a href="https://github.com/wildfly/wildfly-core/blob/master/server/src/main/resources/schema/jboss-deployment-structure-1_2.xsd">https://github.com/wildfly/wildfly/blob/master/build/src/main/resources/docs/schema/jboss-deployment-structure-1_2.xsd</a>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="accessing-jdk-classes"><a class="anchor" href="#accessing-jdk-classes"></a>1.9. Accessing JDK classes</h3>
<div class="paragraph">
<p>Not all JDK classes are exposed to a deployment by default. If your
deployment uses JDK classes that are not exposed you can get access to
them using jboss-deployment-structure.xml with system dependencies:</p>
</div>
<div class="listingblock">
<div class="title">Using jboss-deployment-structure.xml to access JDK classes</div>
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;jboss-deployment-structure xmlns="urn:jboss:deployment-structure:1.2"&gt;
    &lt;deployment&gt;
        &lt;dependencies&gt;
            &lt;system export="true"&gt;
                &lt;paths&gt;
                    &lt;path name="com/sun/corba/se/spi/legacy/connection"/&gt;
                &lt;/paths&gt;
            &lt;/system&gt;
        &lt;/dependencies&gt;
    &lt;/deployment&gt;
&lt;/jboss-deployment-structure&gt;</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="the-jboss.api-property-and-application-use-of-modules-shipped-with-wildfly"><a class="anchor" href="#the-jboss.api-property-and-application-use-of-modules-shipped-with-wildfly"></a>1.10. The "jboss.api" property and application use of modules shipped with WildFly</h3>
<div class="paragraph">
<p>The WildFly distribution includes a large number of modules, a great
many of which are included for use by WildFly internals, with no testing
of the appropriateness of their direct use by applications or any
commitment to continue to ship those modules in future releases if they
are no longer needed by the internals. So how can a user know whether it
is advisable for their application to specify an explicit dependency on
a module WildFly ships? The "jboss.api" property specified in the
module&#8217;s module.xml file can tell you:</p>
</div>
<div class="listingblock">
<div class="title">Example declaration of the jboss.api property</div>
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;module xmlns="urn:jboss:module:1.5" name="com.google.guava"&gt;
    &lt;properties&gt;
        &lt;property name="jboss.api" value="private"/&gt;
    &lt;/properties&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>If a module does not have a property element like the above, then it&#8217;s
equivalent to one with a value of "public".</p>
</div>
<div class="paragraph">
<p>Following are the meanings of the various values you may see for the
jboss.api property:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;">
<col style="width: 75%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Value</th>
<th class="tableblock halign-left valign-top">Meaning</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">public</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">May be explicitly depended upon by end user applications. Will
continue to be available in future releases within the same major series
and should not have incompatible API changes in future releases within
the same minor series, and ideally not within the same major series.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">private</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Intended for internal use only. Only tested according to
internal usage. May not be safe for end user applications to use
directly.Could change significantly or be removed in a future release
without notice.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">unsupported</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If you see this value in a module.xml in a WildFly
release, please file a bug report, as it is not applicable in WildFly.
In EAP it has a meaning equivalent to "private" but that does not mean
the module is "private" in WildFly; it could very easily be "public".</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">preview</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">May be explicitly depended upon by end user applications, but
there are no guarantees of continued availability in future releases or
that there will not be incompatible API changes. This is not a common
classification in WildFly. It is not used in WildFly 10.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">deprecated</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">May be explicitly depended upon by end user applications.
Stable and reliable but an alternative should be sought. Will be removed
in a future major release.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Note that these definitions are only applicable to WildFly. In EAP and
other Red Hat products based on WildFly the same classifiers are used,
with generally similar meaning, but the precise meaning is per the
definitions on the Red Hat customer support portal.</p>
</div>
<div class="paragraph">
<p>If an application declares a direct dependency on a module marked
"private", "unsupported" or "deprecated", during deployment a WARN
message will be logged. The logging will be in log categories
"org.jboss.as.dependency.private", "org.jboss.as.dependency.unsupported"
and "org.jboss.as.dependency.deprecated" respectively. These categories
are not used for other purposes, so once you feel sufficiently warned
the logging can be safely suppressed by turning the log level for the
relevant category to ERROR or higher.</p>
</div>
<div class="paragraph">
<p>Other than the WARN messages noted above, declaring a direct dependency
on a non-public module has no impact on how WildFly processes the
deployment.</p>
</div>
</div>
<div class="sect2">
<h3 id="how-to-list-the-module-dependencies-of-a-deployed-application"><a class="anchor" href="#how-to-list-the-module-dependencies-of-a-deployed-application"></a>1.11. How to list the module dependencies of a deployed application</h3>
<div class="paragraph">
<p>In WildFly it is possible to list the module dependencies added by the container to your deployed application. This task can be achieved via the command line interface, where specific operations are available to list the module dependencies for deployments and ear-subdeployments.</p>
</div>
<div class="paragraph">
<p>You can list the module dependencies of a deployment using the <em>list-modules</em> operation as below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>[standalone@localhost:9990 /] /deployment=test-application.war:list-modules</code></pre>
</div>
</div>
<div class="paragraph">
<p>In case of ear-subdeployments, the <em>list-modules</em> operation is also available under the subdeployment resource:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>[standalone@localhost:9990 /] /deployment=test-application.ear/subdeployment=test-application.war:list-modules</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you are running WildFly in domain mode, this operation is available via the server resource at the host level:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>[domain@localhost:9990 /] /host=master/server=server-one/deployment=test-application.war:list-modules</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>[domain@localhost:9990 /] /host=master/server=server-one/deployment=test-application.ear/subdeployment=test-application.war:list-modules</code></pre>
</div>
</div>
<div class="paragraph">
<p>By default, the <em>list-modules</em> operation shows the list of dependencies in a compact view, including only the module name. You can control this output using the attribute <em>verbose=[false*|true]</em> to enable/disable a detailed response.</p>
</div>
<div class="paragraph">
<p>The following output shows an example of a detailed view:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>[standalone@localhost:9990 /] /deployment=test-application.ear:list-modules(verbose=true)
  {
      "outcome" =&gt; "success",
      "result" =&gt; {
          "system-dependencies" =&gt; [
              {
                  "name" =&gt; "com.fasterxml.jackson.datatype.jackson-datatype-jdk8",
                  "optional" =&gt; true,
                  "export" =&gt; false,
                  "import-services" =&gt; true
              },
              {
                  "name" =&gt; "com.fasterxml.jackson.datatype.jackson-datatype-jsr310",
                  "optional" =&gt; true,
                  "export" =&gt; false,
                  "import-services" =&gt; true
              },
              ...
          ],
          "local-dependencies" =&gt; [
              {
                "name" =&gt; "deployment.test-application.ear.test-application-ejb.jar",
                "optional" =&gt; false,
                "export" =&gt; false,
                "import-services" =&gt; true
              },
              ...
          ],
          "user-dependencies" =&gt; [
              {
                  "name" =&gt; "com.fasterxml.jackson.datatype.jackson-datatype-jdk8",
                  "optional" =&gt; false,
                  "export" =&gt; false,
                  "import-services" =&gt; false
              },
              {
                  "name" =&gt; "org.hibernate:4.1",
                  "optional" =&gt; false,
                  "export" =&gt; false,
                  "import-services" =&gt; false
              },
              ...
          ]
      }
  }</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <em>list_modules</em> operation shows information in three different categories:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>system-dependencies: These are the dependencies added implicitly by the server container.</p>
</li>
<li>
<p>local-dependencies: These are dependencies on other parts of the deployment.</p>
</li>
<li>
<p>user-dependencies: These are the dependencies defined by the user via a manifest file or deployment-structure.xml.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For each module, the following information is shown:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>name: The module name and, if the slot name is not the default "main" slot, the slot name is concatenated after a ":" character separator.</p>
</li>
<li>
<p>optional: If the dependency was added as an optional dependency.</p>
</li>
<li>
<p>export: If the dependency is being exported to other modules.</p>
</li>
<li>
<p>import-services: If the module for the deployment or subdeployment is allowed to import services from the dependency.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="Implicit_module_dependencies_for_deployments"><a class="anchor" href="#Implicit_module_dependencies_for_deployments"></a>2. Implicit module dependencies for deployments</h2>
<div class="sectionbody">
<div class="paragraph">
<p>As explained in the <a href="#Class_Loading_in_WildFly">Class Loading in WildFly</a> article,
WildFly 14 is based on module classloading. A class within a module B
isn&#8217;t visible to a class within a module A, unless module B adds a
dependency on module A. Module dependencies can be explicitly (as
explained in that classloading article) or can be "implicit". This
article will explain what implicit module dependencies mean and how,
when and which modules are added as implicit dependencies.</p>
</div>
<div class="sect2">
<h3 id="whats-an-implicit-module-dependency"><a class="anchor" href="#whats-an-implicit-module-dependency"></a>2.1. What&#8217;s an implicit module dependency?</h3>
<div class="paragraph">
<p>Consider an application deployment which contains Jakarta Enterprise Beans. Jakarta Enterprise Beans typically
need access to classes from the javax.ejb.* package and other Jakarta EE
API packages. The jars containing these packages are already shipped in
WildFly and are available as "modules". The module which contains the
javax.ejb.* classes has a specific name and so does the module which
contains all the Jakarta EE API classes. For an application to be able to
use these classes, it has to add a dependency on the relevant modules.
Forcing the application developers to add module dependencies like these
(i.e. dependencies which can be "inferred") isn&#8217;t a productive approach.
Hence, whenever an application is being deployed, the deployers within
the server, which are processing this deployment "implicitly" add these
module dependencies to the deployment so that these classes are visible
to the deployment at runtime. This way the application developer doesn&#8217;t
have to worry about adding them explicitly. How and when these implicit
dependencies are added is explained in the next section.</p>
</div>
</div>
<div class="sect2">
<h3 id="how-and-when-is-an-implicit-module-dependency-added"><a class="anchor" href="#how-and-when-is-an-implicit-module-dependency-added"></a>2.2. How and when is an implicit module dependency added?</h3>
<div class="paragraph">
<p>When a deployment is being processed by the server, it goes through a
chain of "deployment processors". Each of these processors will have a
way to check if the deployment meets a certain criteria and if it does,
the deployment processor adds an implicit module dependency to that
deployment. Let&#8217;s take an example - Consider (again) an Jakarta Enterprise Beans 3 deployment
which has the following class:</p>
</div>
<div class="listingblock">
<div class="title">MySuperDuperBean.java</div>
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">@Stateless
public class MySuperDuperBean {

...

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>As can be seen, we have a simple @Stateless Jakarta Enterprise Beans. When the deployment
containing this class is being processed, the Jakarta Enterprise Beans deployment processor
will see that the deployment contains a class with the @Stateless
annotation and thus identifies this as an Jakarta Enterprise Beans deployment. <strong>This is just
one of the several ways, various deployment processors can identify a
deployment of some specific type.</strong> The Jakarta Enterprise Beans deployment processor will
then add an implicit dependency on the Jakarta EE API module, so that all
the Jakarta EE API classes are visible to the deployment.</p>
</div>
<div class="paragraph">
<p>Some subsystems will always add API classes, even if the trigger
condition is not met. These are listed separately below.</p>
</div>
<div class="paragraph">
<p>In the next section, we&#8217;ll list down the implicit module dependencies
that are added to a deployment, by various deployers within WildFly.</p>
</div>
</div>
<div class="sect2">
<h3 id="which-are-the-implicit-module-dependencies"><a class="anchor" href="#which-are-the-implicit-module-dependencies"></a>2.3. Which are the implicit module dependencies?</h3>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Subsystem responsible for adding the implicit dependency</th>
<th class="tableblock halign-left valign-top">Dependencies
that are always added</th>
<th class="tableblock halign-left valign-top">Dependencies that are added if a trigger
condition is met</th>
<th class="tableblock halign-left valign-top">Trigger which leads to the implicit module dependency
being added</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Core Server</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">javax.api sun.jdk org.jboss.vfs</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Batch Subsystem</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">javax.batch.api</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">implicit</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">EE Subsystem</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">javaee.api</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Jakarta Enterprise Beans 3 subsystem</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">javaee.api</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The presence of ejb-jar.xml (in valid
locations in the deployment, as specified by spec) or the presence of
annotation based Jakarta Enterprise Beans (ex: @Stateless, @Stateful, @MessageDriven etc)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Jakarta RESTful Web Services (Resteasy) subsystem</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">javax.xml.bind.api</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">org.jboss.resteasy.resteasy-atom-provider
org.jboss.resteasy.resteasy-cdi org.jboss.resteasy.resteasy-jaxrs
org.jboss.resteasy.resteasy-jaxb-provider
org.jboss.resteasy.resteasy-jackson2-provider
org.jboss.resteasy.resteasy-jsapi
org.jboss.resteasy.resteasy-multipart-provider
org.jboss.resteasy.async-http-servlet-30</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The presence of Jakarta RESTful Web Services
annotations in the deployment</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Jakarta Connectors subsystem</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">javax.resource.api</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">javax.jms.api javax.validation.api
org.jboss.logging org.jboss.ironjacamar.api org.jboss.ironjacamar.impl
org.hibernate.validator</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If the deployment is a resource adaptor (RAR)
deployment.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Jakarta Persistence (Hibernate) subsystem</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">javax.persistence.api</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">javaee.api
org.jboss.as.jpa org.hibernate</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The presence of an @PersistenceUnit or
@PersistenceContext annotation, or a &lt;persistence-unit-ref&gt; or
&lt;persistence-context-ref&gt; in a deployment descriptor..</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Logging Subsystem</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">org.jboss.logging org.apache.commons.logging
org.apache.log4j org.apache.logging.log4j.api org.slf4j org.jboss.logging.jul-to-slf4j-stub</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">SAR Subsystem</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">org.jboss.logging org.jboss.modules</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The deployment
is a SAR archive</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Security Subsystem</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">org.picketbox</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Web Subsystem</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">javaee.api com.sun.jsf-impl org.hibernate.validator
org.jboss.as.web org.jboss.logging</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The deployment is a WAR archive. Jakarta Server Faces
is only added if used. Multiple version options exist for mojarra.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Web Services Subsystem</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">org.jboss.ws.api org.jboss.ws.spi</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Weld (CDI) Subsystem</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">javax.persistence.api javaee.api org.javassist
org.jboss.interceptor org.jboss.as.weld org.jboss.logging
org.jboss.weld.core org.jboss.weld.api org.jboss.weld.spi</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If a
beans.xml file is detected in the deployment</p></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="Deployment_Descriptors_used_In_WildFly"><a class="anchor" href="#Deployment_Descriptors_used_In_WildFly"></a>3. Deployment Descriptors used In WildFly</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This page gives a list and a description of all the valid deployment
descriptors that a WildFly deployment can use. This document is a work
in progress.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Descriptor</th>
<th class="tableblock halign-left valign-top">Location</th>
<th class="tableblock halign-left valign-top">Specification</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Info</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">jboss-deployment-structure.xml</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">META-INF or WEB-INF of the top level
deployment</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">This file can be used to control class loading for the
deployment</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Class Loading in WildFly</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">beans.xml</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">WEB-INF or META-INF</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Jakarta Contexts and Dependency Injection</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The presence of this descriptor
(even if empty) activates Jakarta Contexts and Dependency Injection</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Weld Reference Guide</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">web.xml</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">WEB-INF</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Servlet</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Web deployment descriptor</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">jboss-web.xml</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">WEB-INF</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">JBoss Web deployment descriptor. This can be
use to override settings from web.xml, and to set WildFly specific
options</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ejb-jar.xml</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">WEB-INF of a war, or META-INF of an Jakarta Enterprise Beans jar</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Jakarta Enterprise Beans</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The Jakarta Enterprise Beans
spec deployment descriptor</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ejb-jar.xml schema</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">jboss-ejb3.xml</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">WEB-INF of a war, or META-INF of an Jakarta Enterprise Beans jar</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The
JBoss Jakarta Enterprise Beans deployment descriptor, this can be used to override settings
from ejb-jar.xml, and to set WildFly specific settings</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">application.xml</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">META-INF of an EAR</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Jakarta EE Platform Specification</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">application.xml schema</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">jboss-app.xml</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">META-INF of an EAR</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">JBoss application deployment
descriptor, can be used to override settings application.xml, and to set
WildFly specific settings</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">persistence.xml</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">META-INF</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Jakarta Persistence</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Jakarta Persistence descriptor used for defining
persistence units</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Hibernate Reference Guide</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">jboss-ejb-client.xml</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">WEB-INF of a war, or META-INF of an Jakarta Enterprise Beans jar</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Remote Jakarta Enterprise Beans settings. This file is used to setup the Jakarta Enterprise Beans client context
for a deployment that is used for remote Jakarta Enterprise Beans invocations</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Jakarta Enterprise Beans
invocations from a remote server instance</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">jbosscmp-jdbc.xml</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">META-INF of an Jakarta Enterprise Beans jar</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">CMP deployment
descriptor. Used to map CMP entity beans to a database. The format is
largely unchanged from previous versions.</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ra.xml</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">META-INF of a rar archive</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Spec deployment descriptor for
resource adaptor deployments</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">IronJacamar Reference Guide Schema</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ironjacamar.xml</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">META-INF of a rar archive</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">JBoss deployment
descriptor for resource adaptor deployments</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">IronJacamar Reference Guide</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">*-jms.xml</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">META-INF or WEB-INF</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Jakarta Messaging message destination deployment
descriptor, used to deploy message destinations with a deployment</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">*-ds.xml</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">META-INF or WEB-INF</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Datasource deployment descriptor, use
to bundle datasources with a deployment</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">DataSource Configuration</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">application-client.xml</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">META-INF of an application client jar</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Jakarta EE
Platform Specification</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The spec deployment descriptor for application
client deployments</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">application-client.xml schema</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">jboss-client.xml</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">META-INF of an application client jar</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The WildFly
specific deployment descriptor for application client deployments</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">jboss-webservices.xml</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">META-INF for Jakarta Enterprise Beans webservice deployments or
WEB-INF for POJO webservice deployments/Jakarta Enterprise Beans webservice endpoints bundled
in .war</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The JBossWS 4.0.x specific deployment descriptor for
webservice endpoints</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect1">
<h2 id="Development_Guidelines_and_Recommended_Practices"><a class="anchor" href="#Development_Guidelines_and_Recommended_Practices"></a>4. Development Guidelines and Recommended Practices</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The purpose of this page is to document tips and techniques that will
assist developers in creating fast, secure, and reliable applications.
It is also a place to note what you should <strong>avoid</strong> doing when developing
applications.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="Application_Client_Reference"><a class="anchor" href="#Application_Client_Reference"></a>5. Application Client Reference</h2>
<div class="sectionbody">
<div class="paragraph">
<p>As a Jakarta EE compliant server, WildFly 14 contains an application
client. An application client is essentially a cut down server instance,
that allows you to use EE features such as injection in a client side
program.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
This article is not a tutorial on application client development, rather
it covers the specifics of the WildFly application client. There are
tutorials available elsewhere that cover application client basics, such
as
<a href="https://www.jasondl.ee/posts/2011/java-ees-buried-treasure-the-application-client-container.html">this
one</a>.
</td>
</tr>
</table>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Note that the application client is different from the Jakarta Enterprise Beans client
libraries, it is perfectly possible to write a client application that does
not use the application client, but instead uses the jboss-ejb-client
library directly.
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="getting-started"><a class="anchor" href="#getting-started"></a>5.1. Getting Started</h3>
<div class="paragraph">
<p>To launch the application client use the <code>appclient.sh</code> or
<code>appclient.bat</code> script in the bin directory. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>./appclient.sh --host=10.0.0.1 myear.ear#appClient.jar arg1</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>--host</code> argument tells the appclient the server to connect to. The
next argument is the application client deployment to use, application
clients can only run a single deployment, and this deployment must also
be deployed on the full server instance that the client is connecting
too.</p>
</div>
<div class="paragraph">
<p>Any arguments after the deployment to use are passed directly through to
the application clients <code>main</code> function.</p>
</div>
</div>
<div class="sect2">
<h3 id="connecting-to-more-than-one-host"><a class="anchor" href="#connecting-to-more-than-one-host"></a>5.2. Connecting to more than one host</h3>
<div class="paragraph">
<p>If you want to connect to more than one host or make use of the
clustering functionality then you need to specify a
jboss-ejb-client.properties file rather than a host:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>./appclient.sh --ejb-client-properties=my-jboss-ejb-client.properties myear.ear#appClient.jar arg1</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="example-application-client-reference"><a class="anchor" href="#example-application-client-reference"></a>5.3. Example</h3>
<div class="paragraph">
<p>A simple example of how to package an application client and use it with
WildFly can be within the quickstart
<a href="https://github.com/wildfly/quickstart/tree/master/app-client">appclient</a>
which is located on Github .</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="embedded-api"><a class="anchor" href="#embedded-api"></a>6. Embedded API</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The embedded API can be used to launch {appservername} within a currently running process.</p>
</div>
<div class="paragraph">
<p>The embedded server can be reinitialized with a different JBoss Home. However the module directory, <code>module.path</code>
system property, and the modules system packages, <code>jboss.modules.system.pkgs</code> system property, are effectively static.
This means that creating a new embedded server or host controller within the same VM will not allow overriding the
modules directory or the system packages.</p>
</div>
<div class="paragraph">
<p>You can also set a hint to indicate which log manager is being used. The hint attempts to ensure that JBoss Logging
will bind to the correct log manager. It also adds the hinted logging package to the modules system packages.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
If using the embedded API with Java 11 you&#8217;ll need to add <code>--add-module=java.se</code> to your JVM arguments. See
<a href="https://issues.redhat.com/browse/MODULES-372">MODULES-372</a> for details.
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="standalone-api"><a class="anchor" href="#standalone-api"></a>6.1. Standalone API</h3>
<div class="paragraph">
<p>A standalone server allows you to manage the lifecycle of a server within the currently running process. The server
can be configured in admin-only mode or fully started and applications can be deployed.</p>
</div>
<div class="sect3">
<h4 id="examples"><a class="anchor" href="#examples"></a>6.1.1. Examples</h4>
<div class="listingblock">
<div class="title">Simple Example</div>
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">final StandaloneServer server = EmbeddedProcessFactory.createStandaloneServer(Configuration.Builder.of(jbossHome).build());
server.start();

try {
    // Print the listening address
    final ModelControllerClient client = server.getModelControllerClient();
    final ModelNode address = Operations.createAddress("interface", "public");
    final ModelNode op = Operations.createReadAttributeOperation(address, "inet-address");
    op.get("resolve-expressions").set(true);
    final ModelNode result = client.execute(op);
    if (!Operations.isSuccessfulOutcome((result))) {
        throw new RuntimeException("Failed to get the public inet-address: " + Operations.getFailureDescription(result));
    }
    System.out.printf("Listening on %s%n", Operations.readResult(result).asString());
} finally {
    server.stop();
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Server in admin-only Example</div>
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">final StandaloneServer server = EmbeddedProcessFactory.createStandaloneServer(
    Configuration.Builder.of(jbossHome)
        .addCommandArgument("--admin-only")
        .build());
server.start();

try {
    // Print the listening address
    final ModelControllerClient client = server.getModelControllerClient();
    final ModelNode address = Operations.createAddress();
    final ModelNode op = Operations.createReadAttributeOperation(address, "running-mode");
    op.get("resolve-expressions").set(true);
    final ModelNode result = client.execute(op);
    if (!Operations.isSuccessfulOutcome((result))) {
        throw new RuntimeException("Failed to get the running-mode: " + Operations.getFailureDescription(result));
    }
    System.out.printf("Running mode is %s%n", Operations.readResult(result).asString());
} finally {
    server.stop();
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">log4j2 Hint</div>
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">final StandaloneServer server = EmbeddedProcessFactory.createStandaloneServer(Configuration.Builder.of(jbossHome)
        .setLoggerHint(Configuration.LoggerHint.LOG4J2)
        .build()
);
server.start();

try {
    // Print the listening address
    final ModelControllerClient client = server.getModelControllerClient();
    final ModelNode address = Operations.createAddress("interface", "public");
    final ModelNode op = Operations.createReadAttributeOperation(address, "inet-address");
    op.get("resolve-expressions").set(true);
    final ModelNode result = client.execute(op);
    if (!Operations.isSuccessfulOutcome((result))) {
        throw new RuntimeException("Failed to get the public inet-address: " + Operations.getFailureDescription(result));
    }
    org.apache.logging.log4j.LogManager.getFormatterLogger(Main.class).info("Listening on %s%n", Operations.readResult(result).asString());
} finally {
    server.stop();
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="host-controller-api"><a class="anchor" href="#host-controller-api"></a>6.2. Host Controller API</h3>
<div class="paragraph">
<p>The host controller API creates a host controller in the current process. The host controller is started in <code>admin-only</code>
mode therefore servers within the domain cannot be started. However the server configuration can be altered via
management operations.</p>
</div>
<div class="sect3">
<h4 id="example"><a class="anchor" href="#example"></a>6.2.1. Example</h4>
<div class="listingblock">
<div class="title">Simple Example</div>
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">final HostController server = EmbeddedProcessFactory.createHostController(Configuration.Builder.of(jbossHome).build());
server.start();

try {
    // Print the listening address
    final ModelControllerClient client = server.getModelControllerClient();
    final ModelNode address = new ModelNode().setEmptyList();
    final ModelNode op = Operations.createOperation(ClientConstants.READ_CHILDREN_NAMES_OPERATION, address);
    op.get(ClientConstants.CHILD_TYPE).set(ClientConstants.SERVER_GROUP);
    final ModelNode result = client.execute(op);
    if (!Operations.isSuccessfulOutcome(result)) {
        throw new RuntimeException("Failed to get the public inet-address: " + Operations.getFailureDescription(result));
    }
    System.out.println("Available server groups:");
    for (ModelNode value : Operations.readResult(result).asList()) {
        System.out.printf("\t%s%n", value.asString());
    }
} finally {
    server.stop();
}</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="CDI_Reference"><a class="anchor" href="#CDI_Reference"></a>7. CDI Reference</h2>
<div class="sectionbody">
<div class="paragraph">
<p>WildFly uses <a href="http://weld.cdi-spec.org/">Weld</a>, the CDI reference
implementation as its CDI provider. To activate CDI for a deployment
simply add a <code>beans.xml</code> file in any archive in the deployment.</p>
</div>
<div class="paragraph">
<p>This document is not intended to be a CDI tutorial, it only covers CDI
usage that is specific to WildFly. For some general information on CDI
see the below links:</p>
</div>
<div class="paragraph">
<p><a href="http://docs.jboss.org/cdi/spec/1.2/cdi-spec.html">CDI Specification</a><br>
<a href="http://docs.jboss.org/weld/reference/latest/en-US/html/">Weld Reference
Guide</a><br>
<a href="https://github.com/wildfly/quickstart/">The WildFly Quickstarts</a></p>
</div>
<div class="sect2">
<h3 id="using-cdi-beans-from-outside-the-deployment"><a class="anchor" href="#using-cdi-beans-from-outside-the-deployment"></a>7.1. Using CDI Beans from outside the deployment</h3>
<div class="paragraph">
<p>For WildFly 14 onwards, it is now possible to have classes outside the
deployment be picked up as CDI beans. In order for this to work, you must
add a dependency on the external deployment that your beans are coming
from, and make sure the META-INF directory of this deployment is
imported, so that your deployment has visibility to the <code>beans.xml</code> file
(To import beans from outside the deployment they must be in an archive
with a <code>beans.xml</code> file).</p>
</div>
<div class="paragraph">
<p>There are two ways to do this, either using the <code>MANIFEST.MF</code> or using
<code>jboss-deployment-structure.xml</code>.</p>
</div>
<div class="paragraph">
<p>Using <code>MANIFEST.MF</code> you need to add a <code>Dependencies</code> entry, with
meta-inf specified after the entry, e.g.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>Dependencies: com.my-cdi-module meta-inf, com.my-other-cdi-module meta-inf</pre>
</div>
</div>
<div class="paragraph">
<p>Using <code>jboss-deployment-structure.xml</code> you need to add a dependency
entry with <code>meta-inf="import"</code>, e.g.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;jboss-deployment-structure xmlns="urn:jboss:deployment-structure:1.2"&gt;
    &lt;deployment&gt;
        &lt;dependencies&gt;
            &lt;module name="deployment.d1.jar" meta-inf="import"/&gt;
        &lt;/dependencies&gt;
    &lt;/deployment&gt;
&lt;/jboss-deployment-structure&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that this can be used to create beans from both modules in the
<code>modules</code> directory, and from other deployments.</p>
</div>
<div class="paragraph">
<p>For more information on class loading and adding dependencies to your
deployment please see the <a href="#Class_Loading_in_WildFly">Class
Loading Guide</a></p>
</div>
</div>
<div class="sect2">
<h3 id="suppressing-implicit-bean-archives"><a class="anchor" href="#suppressing-implicit-bean-archives"></a>7.2. Suppressing implicit bean archives</h3>
<div class="paragraph">
<p>CDI 1.1 brings new options to packaging of CDI-enabled applications. In
addition to well-known explicit bean archives (basically any archive
containing the <strong>beans.xml</strong> file) the specification introduces <strong>implicit
bean archives</strong>.</p>
</div>
<div class="paragraph">
<p>An implicit bean archive is any archive that contains one or more
classes annotated with a bean defining annotation (scope annotation) or
one or more session beans. As a result, the beans.xml file is no longer
required for CDI to work in your application.</p>
</div>
<div class="paragraph">
<p>In an implicit bean archive <strong>only those classes</strong> that are either
annotated with bean defining annotations or are session beans are
recognized by CDI as beans (other classes cannot be injected).</p>
</div>
<div class="paragraph">
<p>This has a side-effect, though. Libraries exist that make use of scope
annotation (bean defining annotations) for their own convenience but are
not designed to run with CDI support. Guava would be an example of such
library. If your application bundles such library it will be recognized
as a CDI archive and may
<a href="https://code.google.com/p/guava-libraries/issues/detail?id=1433">fail the
deployment</a>.</p>
</div>
<div class="paragraph">
<p>Fortunately, WildFly makes it possible to suppress implicit bean
archives and only enable CDI in archives that bundle the beans.xml file.
There are two ways to achieve this:</p>
</div>
<div class="sect3">
<h4 id="per-deployment-configuration"><a class="anchor" href="#per-deployment-configuration"></a>7.2.1. Per-deployment configuration</h4>
<div class="paragraph">
<p>You can either set this up for your deployment only by adding the
following content to the <strong>META-INF/jboss-all.xml</strong> file of your
application:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;jboss xmlns="urn:jboss:1.0"&gt;
    &lt;weld xmlns="urn:jboss:weld:1.0" require-bean-descriptor="true"/&gt;
&lt;/jboss&gt;</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="global-configuration"><a class="anchor" href="#global-configuration"></a>7.2.2. Global configuration</h4>
<div class="paragraph">
<p>Alternatively, you may configure this for all deployments in your
WildFly instance by executing the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=weld:write-attribute(name=require-bean-descriptor,value=true)</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="development-mode"><a class="anchor" href="#development-mode"></a>7.3. Development mode</h3>
<div class="paragraph">
<p>WildFly 10 introduces a special mode for application development which
allows you to inspect and monitor your CDI deployments. This mode is
turned off by default and note that some features of the <strong>development
mode may have negative impact on the performance and/or functionality of
the application</strong>.</p>
</div>
<div class="sect3">
<h4 id="per-deployment-configuration-1"><a class="anchor" href="#per-deployment-configuration-1"></a>7.3.1. Per-deployment configuration</h4>
<div class="paragraph">
<p>You can enable it locally in your application <code>web.xml</code> by setting the
Servlet initialization parameter <code>org.jboss.weld.development</code> to <code>true:</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml"> &lt;context-param&gt;
   &lt;param-name&gt;org.jboss.weld.development&lt;/param-name&gt;
   &lt;param-value&gt;true&lt;/param-value&gt;
 &lt;/context-param&gt;</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="global-configuration-1"><a class="anchor" href="#global-configuration-1"></a>7.3.2. Global configuration</h4>
<div class="paragraph">
<p>Alternatively, you can enable it globally in Weld subsystem by setting
<code>development-mode</code> attribute to <code>true:</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=weld:write-attribute(name=development-mode,value=true)</code></pre>
</div>
</div>
<div class="paragraph">
<p>For more details and example you can check
<a href="http://docs.jboss.org/weld/reference/latest/en-US/html_single/#devmode">Weld
development mode</a>.</p>
</div>
<div class="paragraph">
<p>Once the development mode is enabled you can check your applications CDI
information using Weld Probe -
<a href="http://docs.jboss.org/weld/reference/latest/en-US/html_single/#probe">Weld
Probe</a>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="non-portable-mode"><a class="anchor" href="#non-portable-mode"></a>7.4. Non-portable mode</h3>
<div class="paragraph">
<p>CDI 1.1 clarifies some aspects of how CDI protable extensions work. As a
result, some extensions that do not use the API properly (but were
tolerated in CDI 1.0 environment) may stop working with CDI 1.1.If this
is the case of your application you will see an exception like this:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>org.jboss.weld.exceptions.IllegalStateException: WELD-001332: BeanManager method getBeans() is not available during application initialization</pre>
</div>
</div>
<div class="paragraph">
<p>Fortunatelly, there is a non-portable mode available in WildFly which
skips some of the API usage checks and therefore allows the legacy
extensions to work as before.</p>
</div>
<div class="paragraph">
<p>Again, there are two ways to enable the non-portable mode:</p>
</div>
<div class="sect3">
<h4 id="per-deployment-configuration-2"><a class="anchor" href="#per-deployment-configuration-2"></a>7.4.1. Per-deployment configuration</h4>
<div class="paragraph">
<p>You can either set this up for your deployment only by adding the
following content to the <strong>META-INF/jboss-all.xml</strong> file of your
application:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;jboss xmlns="urn:jboss:1.0"&gt;
    &lt;weld xmlns="urn:jboss:weld:1.0" non-portable-mode="true" /&gt;
&lt;/jboss&gt;</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="global-configuration-2"><a class="anchor" href="#global-configuration-2"></a>7.4.2. Global configuration</h4>
<div class="paragraph">
<p>Alternatively, you may configure this for all deployments in your
WildFly instance by executing the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=weld:write-attribute(name=non-portable-mode,value=true)</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Note that new portable extensions should always use the</strong>
<strong><a href="http://docs.jboss.org/cdi/api/1.1/javax/enterprise/inject/spi/BeanManager.html">BeanManager
API</a></strong> <strong>properly and thus never required the non-portable mode. The
non-portable mode only exists to preserve compatibility with legacy
extensions!</strong></p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
References in this document to CDI refer to Jakarta Contexts and Dependency Injection unless otherwise noted.
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="EE_Concurrency_Utilities"><a class="anchor" href="#EE_Concurrency_Utilities"></a>8. EE Concurrency Utilities</h2>
<div class="sectionbody">
<div class="quoteblock abstract">
<blockquote>
EE Concurrency Utilities (JSR 236) is a technology introduced with Java
EE 7, which adapts well known Java SE concurrency utilities to the Java
EE application environment specifics. The Jakarta EE application server is
responsible for the creation (and shutdown) of every instance of the EE
Concurrency Utilities, and provide these to the applications, ready to
use.
</blockquote>
</div>
<div class="paragraph">
<p>The EE Concurrency Utilities support the propagation of the invocation
context, capturing the existent context in the application threads to
use in their own threads, the same way a logged-in user principal is
propagated when a servlet invokes an Jakarta Enterprise Beans asynchronously. The propagation
of the invocation context includes, by default, the class loading, JNDI
and security contexts.</p>
</div>
<div class="paragraph">
<p>WildFly creates a single default instance of each EE Concurrency Utility
type in all configurations within the distribution, as mandated by the
specification, but additional instances, perhaps customised to better
serve a specific usage, may be created through WildFly&#8217;s EE Subsystem
Configuration. To learn how to configure EE Concurrency Utilities please
refer to <a href="Admin_Guide.html#EE_Concurrency_Utilities_Configuration">EE Concurrency
Utilities Configuration</a>. Additionally, the EE subsystem configuration
also includes the configuration of which instance should be considered
the default instance mandated by the Jakarta EE specification, and such
configuration is covered by
<a href="Default_EE_Bindings_Configuration.html">Default EE Bindings
Configuration</a>.</p>
</div>
<div class="sect2">
<h3 id="context-service"><a class="anchor" href="#context-service"></a>8.1. Context Service</h3>
<div class="paragraph">
<p>The Context Service ( <code>javax.enterprise.concurrent.ContextService</code>) is a
brand new concurrency utility, which applications may use to build
contextual proxies from existing objects.</p>
</div>
<div class="paragraph">
<p>A contextual proxy is an object that sets an invocation context, captured
when created, whenever is invoked, before delegating the invocation to
the original object.</p>
</div>
<div class="paragraph">
<p>Usage example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">public void onGet(...) {
  Runnable task = ...;
  Runnable contextualTask = contextService.createContextualProxy(task, Runnable.class);
  // ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>WildFly default configurations creates a single default instance of a
Context Service, which may be retrieved through <code>@Resource</code> injection:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">@Resource
private ContextService contextService;</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
To retrieve instead a non default Context Service instance,
<code>@Resource&#8217;s `lookup</code> attribute needs to specify the JNDI name used in
the wanted instance configuration. WildFly will always inject the
default instance, no matter what&#8217;s the <code>name</code> attribute value, if the
<code>lookup</code> attribute is not defined.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Applications may alternatively use instead the standard JNDI API:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">ContextService contextService = InitialContext.doLookup("java:comp/DefaultContextService");</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
As mandated by the Jakarta EE specification, the default Context Service
instance&#8217;s JNDI name is <code>java:comp/DefaultContextService</code>.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="managed-thread-factory"><a class="anchor" href="#managed-thread-factory"></a>8.2. Managed Thread Factory</h3>
<div class="paragraph">
<p>The Managed Thread Factory (
<code>javax.enterprise.concurrent.ManagedThreadFactory</code>) allows Java EE
applications to create Java threads. It is an extension of Java SE&#8217;s
Thread Factory ( <code>java.util.concurrent.ThreadFactory</code>) adapted to the
Jakarta EE platform specifics.</p>
</div>
<div class="paragraph">
<p>Managed Thread Factory instances are managed by the application server,
thus Jakarta EE applications are forbidden to invoke any lifecycle related
method.</p>
</div>
<div class="paragraph">
<p>In case the Managed Thread Factory is configured to use a Context
Service, the application&#8217;s thread context is captured when a thread
creation is requested, and such context is propagated to the thread&#8217;s
Runnable execution.</p>
</div>
<div class="paragraph">
<p>Managed Thread Factory threads implement
<code>javax.enterprise.concurrent.ManageableThread</code>, which allows an
application to learn about termination status.</p>
</div>
<div class="paragraph">
<p>Usage example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">public void onGet(...) {
  Runnable task = ...;
  Thread thread = managedThreadFactory.newThread(task);
  thread.start();
    // ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>WildFly default configurations creates a single default instance of a
Managed Thread Factory, which may be retrieved through <code>@Resource</code>
injection:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">@Resource
private ManagedThreadFactory managedThreadFactory;</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
To retrieve instead a non default Managed Thread Factory instance,
<code>@Resource&#8217;s `lookup</code> attribute needs to specify the JNDI name used in
the wanted instance configuration. WildFly will always inject the
default instance, no matter what&#8217;s the <code>name</code> attribute value, in case
the <code>lookup</code> attribute is not defined.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Applications may alternatively use instead the standard JNDI API:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">ManagedThreadFactory managedThreadFactory = InitialContext.doLookup("java:comp/DefaultManagedThreadFactory");</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
As mandated by the Jakarta EE specification, the default Managed Thread
Factory instance&#8217;s JNDI name is <code>java:comp/DefaultManagedThreadFactory</code>.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="managed-executor-service"><a class="anchor" href="#managed-executor-service"></a>8.3. Managed Executor Service</h3>
<div class="paragraph">
<p>The Managed Executor Service (
<code>javax.enterprise.concurrent.ManagedExecutorService</code>) allows Java EE
applications to submit tasks for asynchronous execution. It is an
extension of Java SE&#8217;s Executor Service (
<code>java.util.concurrent.ExecutorService</code>) adapted to the Jakarta EE platform
requirements.</p>
</div>
<div class="paragraph">
<p>Managed Executor Service instances are managed by the application
server, thus Jakarta EE applications are forbidden to invoke any lifecycle
related method.</p>
</div>
<div class="paragraph">
<p>In case the Managed Executor Service is configured to use a Context
Service, the application&#8217;s thread context is captured when the task is
submitted, and propagated to the executor thread responsible for the
task execution.</p>
</div>
<div class="paragraph">
<p>Usage example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">public void onGet(...) {
    Runnable task = ...;
    Future future = managedExecutorService.submit(task);
    // ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>WildFly default configurations creates a single default instance of a
Managed Executor Service, which may be retrieved through <code>@Resource</code>
injection:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">@Resource
private ManagedExecutorService managedExecutorService;</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
To retrieve instead a non default Managed Executor Service instance,
<code>@Resource&#8217;s `lookup</code> attribute needs to specify the JNDI name used in
the wanted instance configuration. WildFly will always inject the
default instance, no matter what&#8217;s the <code>name</code> attribute value, in case
the <code>lookup</code> attribute is not defined.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Applications may alternatively use instead the standard JNDI API:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">ManagedExecutorService managedExecutorService = InitialContext.doLookup("java:comp/DefaultManagedExecutorService");</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
As mandated by the Jakarta EE specification, the default Managed Executor
Service instance&#8217;s JNDI name is
<code>java:comp/DefaultManagedExecutorService</code>.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="managed-scheduled-executor-service"><a class="anchor" href="#managed-scheduled-executor-service"></a>8.4. Managed Scheduled Executor Service</h3>
<div class="paragraph">
<p>The Managed Scheduled Executor Service (
<code>javax.enterprise.concurrent.ManagedScheduledExecutorService</code>) allows
Jakarta EE applications to schedule tasks for asynchronous execution. It is
an extension of Java SE&#8217;s Executor Service (
<code>java.util.concurrent.ScheduledExecutorService</code>) adapted to the Java EE
platform requirements.</p>
</div>
<div class="paragraph">
<p>Managed Scheduled Executor Service instances are managed by the
application server, thus Jakarta EE applications are forbidden to invoke
any lifecycle related method.</p>
</div>
<div class="paragraph">
<p>In case the Managed Scheduled Executor Service is configured to use a
Context Service, the application&#8217;s thread context is captured when the
task is scheduled, and propagated to the executor thread responsible for
the task execution.</p>
</div>
<div class="paragraph">
<p>Usage example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">public void onGet(...) {
    Runnable task = ...;
    ScheduledFuture future = managedScheduledExecutorService.schedule(task, 60, TimeUnit.SECONDS);
    // ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>WildFly default configurations creates a single default instance of a
Managed Scheduled Executor Service, which may be retrieved through
<code>@Resource</code> injection:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">@Resource
private ManagedScheduledExecutorService managedScheduledExecutorService;</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
To retrieve instead a non default Managed Scheduled Executor Service
instance, <code>@Resource&#8217;s `lookup</code> attribute needs to specify the JNDI
name used in the wanted instance configuration. WildFly will always
inject the default instance, no matter what&#8217;s the <code>name</code> attribute
value, in case the <code>lookup</code> attribute is not defined.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Applications may alternatively use instead the standard JNDI API:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">ManagedScheduledExecutorService managedScheduledExecutorService = InitialContext.doLookup("java:comp/DefaultManagedScheduledExecutorService");</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
As mandated by the Jakarta EE specification, the default Managed Scheduled
Executor Service instance&#8217;s JNDI name is
<code>java:comp/DefaultManagedScheduledExecutorService</code>.
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="Jakarta_Enterprise_Beans_3_Reference_Guide"><a class="anchor" href="#Jakarta_Enterprise_Beans_3_Reference_Guide"></a>9. Jakarta Enterprise Beans 3 Reference Guide</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This chapter details the extensions that are available when developing
Enterprise Java Beans <sup>tm</sup> on WildFly 14.</p>
</div>
<div class="paragraph">
<p>Currently there is no support for configuring the extensions using an
implementation specific descriptor file.</p>
</div>
<div class="sect2">
<h3 id="resource-adapter-for-message-driven-beans"><a class="anchor" href="#resource-adapter-for-message-driven-beans"></a>9.1. Resource Adapter for Message Driven Beans</h3>
<div class="paragraph">
<p>Each Message Driven Bean must be connected to a resource adapter.</p>
</div>
<div class="sect3">
<h4 id="specification-of-resource-adapter-using-metadata-annotations"><a class="anchor" href="#specification-of-resource-adapter-using-metadata-annotations"></a>9.1.1. Specification of Resource Adapter using Metadata Annotations</h4>
<div class="paragraph">
<p>The <code>ResourceAdapter</code> annotation is used to specify the resource adapter
with which the MDB should connect.</p>
</div>
<div class="paragraph">
<p>The <code>value</code> of the annotation is the name of the deployment unit
containing the resource adapter. For example <code>jms-ra.rar</code>.</p>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">@MessageDriven(messageListenerInterface = PostmanPat.class)
@ResourceAdapter("ejb3-rar.rar")</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="run-as-principal"><a class="anchor" href="#run-as-principal"></a>9.2. Run-as Principal</h3>
<div class="paragraph">
<p>Whenever a run-as role is specified for a given method invocation the
default anonymous principal is used as the caller principal. This
principal can be overridden by specifying a run-as principal.</p>
</div>
<div class="sect3">
<h4 id="specification-of-run-as-principal-using-metadata-annotations"><a class="anchor" href="#specification-of-run-as-principal-using-metadata-annotations"></a>9.2.1. Specification of Run-as Principal using Metadata Annotations</h4>
<div class="paragraph">
<p>The <code>RunAsPrincipal</code> annotation is used to specify the run-as principal
to use for a given method invocation.</p>
</div>
<div class="paragraph">
<p>The <code>value</code> of the annotation specifies the name of the principal to
use. The actual type of the principal is undefined and should not be
relied upon.</p>
</div>
<div class="paragraph">
<p>Using this annotation without specifying a run-as role is considered an
error.</p>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">@RunAs("admin")
@RunAsPrincipal("MyBean")</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="security-domain-Jakarta-Enterprise-Beans-3-ref"><a class="anchor" href="#security-domain-Jakarta-Enterprise-Beans-3-ref"></a>9.3. Security Domain</h3>
<div class="paragraph">
<p>Each Enterprise Java Bean <sup>tm</sup> can be associated with a security domain.
Only when an Jakarta Enterprise Beans are associated with a security domain will
authentication and authorization be enforced.</p>
</div>
<div class="sect3">
<h4 id="specification-of-security-domain-using-metadata-annotations"><a class="anchor" href="#specification-of-security-domain-using-metadata-annotations"></a>9.3.1. Specification of Security Domain using Metadata Annotations</h4>
<div class="paragraph">
<p>The <code>SecurityDomain</code> annotation is used to specify the security domain
to associate with the Jakarta Enterprise Beans.</p>
</div>
<div class="paragraph">
<p>The <code>value</code> of the annotation is the name of the security domain to be
used.</p>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">@SecurityDomain("other")</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="transaction-timeout"><a class="anchor" href="#transaction-timeout"></a>9.4. Transaction Timeout</h3>
<div class="paragraph">
<p>For any newly started transaction a transaction timeout can be specified
in seconds.</p>
</div>
<div class="paragraph">
<p>When a transaction timeout of <code>0</code> is used, then the actual transaction
timeout will default to the domain configured default.<br>
<em>TODO: add link to tx subsystem</em></p>
</div>
<div class="paragraph">
<p>Although this is only applicable when using transaction attribute
<code>REQUIRED</code> or <code>REQUIRES_NEW</code> the application server will not detect
invalid setups.</p>
</div>
<div class="paragraph">
<p>New Transactions</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Take care that even when transaction attribute <code>REQUIRED</code> is specified,
the timeout will only be applicable if a <strong>new</strong> transaction is started.
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="specification-of-transaction-timeout-with-metadata-annotations"><a class="anchor" href="#specification-of-transaction-timeout-with-metadata-annotations"></a>9.4.1. Specification of Transaction Timeout with Metadata Annotations</h4>
<div class="paragraph">
<p>The <code>TransactionTimeout</code> annotation is used to specify the transaction
timeout for a given method.</p>
</div>
<div class="paragraph">
<p>The <code>value</code> of the annotation is the timeout used in the given <code>unit</code>
granularity. It must be a positive integer or 0. Whenever 0 is specified
the default domain configured timeout is used.</p>
</div>
<div class="paragraph">
<p>The <code>unit</code> specifies the granularity of the <code>value</code>. The actual value
used is converted to seconds. Specifying a granularity lower than
<code>SECONDS</code> is considered an error, even when the computed value will
result in an even amount of seconds.</p>
</div>
<div class="paragraph">
<p>For example:@TransactionTimeout(value = 10, unit = TimeUnit.SECONDS)</p>
</div>
</div>
<div class="sect3">
<h4 id="specification-of-transaction-timeout-in-the-deployment-descriptor"><a class="anchor" href="#specification-of-transaction-timeout-in-the-deployment-descriptor"></a>9.4.2. Specification of Transaction Timeout in the Deployment Descriptor</h4>
<div class="paragraph">
<p>The <code>trans-timeout</code> element is used to define the transaction timeout
for business, home, component, and message-listener interface methods;
no-interface view methods; web service endpoint methods; and timeout
callback methods.</p>
</div>
<div class="paragraph">
<p>The <code>trans-timeout</code> element resides in the <code>urn:trans-timeout</code> namespace
and is part of the standard <code>container-transaction</code> element as defined
in the jboss namespace.</p>
</div>
<div class="paragraph">
<p>For the rules when a <code>container-transaction</code> is applicable please refer
to EJB 3.1 FR 13.3.7.2.1.</p>
</div>
<div class="sect4">
<h5 id="example-of-trans-timeout"><a class="anchor" href="#example-of-trans-timeout"></a>Example of trans-timeout</h5>
<div class="paragraph">
<p>jboss-ejb3.xml</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;jboss:ejb-jar xmlns:jboss="http://www.jboss.com/xml/ns/javaee"
               xmlns="http://java.sun.com/xml/ns/javaee"
               xmlns:tx="urn:trans-timeout"
               xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
               xsi:schemaLocation="http://www.jboss.com/xml/ns/javaee http://www.jboss.org/j2ee/schema/jboss-ejb3-2_0.xsd
http://java.sun.com/xml/ns/javaee http://java.sun.com/xml/ns/javaee/ejb-jar_3_1.xsd
urn:trans-timeout http://www.jboss.org/j2ee/schema/trans-timeout-1_0.xsd"
               version="3.1"
               impl-version="2.0"&gt;
    &lt;assembly-descriptor&gt;
        &lt;container-transaction&gt;
            &lt;method&gt;
                &lt;ejb-name&gt;BeanWithTimeoutValue&lt;/ejb-name&gt;
                &lt;method-name&gt;*&lt;/method-name&gt;
                &lt;method-intf&gt;Local&lt;/method-intf&gt;
            &lt;/method&gt;
            &lt;tx:trans-timeout&gt;
                &lt;tx:timeout&gt;10&lt;/tx:timeout&gt;
                &lt;tx:unit&gt;Seconds&lt;/tx:unit&gt;
            &lt;/tx:trans-timeout&gt;
        &lt;/container-transaction&gt;
    &lt;/assembly-descriptor&gt;
&lt;/jboss:ejb-jar&gt;</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="timer-service"><a class="anchor" href="#timer-service"></a>9.5. Timer service</h3>
<div class="paragraph">
<p>The service is responsible to call the registered timeout methods of the
different session beans.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
A persistent timer will be identified by the name of the EAR, the name
of the sub-deployment JAR and the Bean&#8217;s name.<br>
If one of those names are changed (e.g. EAR name contain a version) the
timer entry became orphaned and the timer event will not longer be
fired.
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="single-event-timer"><a class="anchor" href="#single-event-timer"></a>9.5.1. Single event timer</h4>
<div class="paragraph">
<p>The timer is will be started once at the specified time.</p>
</div>
<div class="paragraph">
<p>In case of a server restart the timeout method of a persistent timer
will only be called directly if the specified time is elapsed.<br>
If the timer is not persistent, it will no longer be available
if JBoss is restarted or the application is redeployed.</p>
</div>
</div>
<div class="sect3">
<h4 id="recurring-timer"><a class="anchor" href="#recurring-timer"></a>9.5.2. Recurring timer</h4>
<div class="paragraph">
<p>The timer will be started at the specified first occurrence and after
that point at each time if the interval is elapsed.<br>
If the timer will be started during the last execution is not finished
the execution will be suppressed with a warning to avoid concurrent
execution.</p>
</div>
<div class="paragraph">
<p>In case of server downtime for a persistent timer, the timeout method
will be called only once if one, or more than one, interval is
elapsed.<br>
If the timer is not persistent, it will no longer be active
after the server is restarted or the application is redeployed.</p>
</div>
</div>
<div class="sect3">
<h4 id="calendar-timer"><a class="anchor" href="#calendar-timer"></a>9.5.3. Calendar timer</h4>
<div class="paragraph">
<p>The timer will be started if the schedule expression match. It will be
automatically deactivated and removed if there will be no next
expiration possible, i.e. If you set a specific year.</p>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">@Schedule( ... dayOfMonth="1", month="1", year="2012") +
// start once at 01-01-2012 00:00:00</code></pre>
</div>
</div>
<div class="sect4">
<h5 id="programmatic-calendar-timer"><a class="anchor" href="#programmatic-calendar-timer"></a>Programmatic calendar timer</h5>
<div class="paragraph">
<p>If the timer is persistent it will be fetched at server start and the
missed timeouts are called concurrent.<br>
If a persistent timer contains an end date it will be executed once
nevertheless how many times the execution was missed. Also a retry will
be suppressed if the timeout method throw an Exception.<br>
In case of such expired timer access to the given Timer object might
throw a NoMoreTimeoutExcption or NoSuchObjectException.</p>
</div>
<div class="paragraph">
<p>If the timer is non persistent it will not longer be active after the
server is restarted or the application is redeployed.</p>
</div>
<div class="paragraph">
<p><strong>TODO</strong>: clarify whether this should happen concurrently/blocked or even
fired only once like a recurring timer!</p>
</div>
</div>
<div class="sect4">
<h5 id="annotated-calendar-timer"><a class="anchor" href="#annotated-calendar-timer"></a>Annotated calendar timer</h5>
<div class="paragraph">
<p>If the timer is non persistent it will not activated for missed events
during the server is down. In case of server start the timer is
scheduled based on the @Schedule annotation.</p>
</div>
<div class="paragraph">
<p>If the timer is persistent (default if not deactivated by annotation)
all missed events are fetched at server start and the annotated timeout
method is called concurrent.</p>
</div>
<div class="paragraph">
<p><strong>TODO</strong>: clarify whether this should happen concurrently/blocked or even
fired only once like a recurring timer!</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="Container_interceptors"><a class="anchor" href="#Container_interceptors"></a>9.6. Container interceptors</h3>
<div class="quoteblock abstract">
<blockquote>
JBoss AS versions prior to WildFly8 allowed a JBoss specific way to
plug-in user application specific interceptors on the server side so
that those interceptors get invoked during an EJB invocation. Such
interceptors differed from the typical (portable) spec provided Jakarta EE
interceptors. The Jakarta Interceptors are expected to run after the
container has done necessary invocation processing which involves
security context propagation, transaction management and other such
duties. As a result, these Jakarta Interceptors come too late into the
picture, if the user applications have to intercept the call before
certain container specific interceptor(s) are run.
</blockquote>
</div>
<div class="sect3">
<h4 id="typical-ejb-invocation-call-path-on-the-server"><a class="anchor" href="#typical-ejb-invocation-call-path-on-the-server"></a>9.6.1. Typical EJB invocation call path on the server</h4>
<div class="paragraph">
<p>A typical EJB invocation looks like this:</p>
</div>
<div class="paragraph">
<p>Client application</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">MyBeanInterface bean = lookupBean();

bean.doSomething();</code></pre>
</div>
</div>
<div class="paragraph">
<p>The invocation on the bean.doSomething() triggers the following (only
relevant portion of the flow shown below):</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>WildFly specific interceptor (a.k.a container interceptor) 1</p>
</li>
<li>
<p>WildFly specific interceptor (a.k.a container interceptor) 2</p>
</li>
<li>
<p>&#8230;&#8203;.</p>
</li>
<li>
<p>WildFly specific interceptor (a.k.a container interceptor) N</p>
</li>
<li>
<p>User application specific Jakarta EE interceptor(s) (if any)</p>
</li>
<li>
<p>Invocation on the EJB instance&#8217;s method</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The WildFly specific interceptors include the security context
propagation, transaction management and other container provided
services. In some cases, the " `container interceptors`" (let&#8217;s call
them that) might even decide break the invocation flow and not let the
invocation proceed (for example: due to the invoking caller not being
among the allowed user roles who can invoke the method on the bean).</p>
</div>
<div class="paragraph">
<p>Previous versions of JBoss AS allowed a way to plug-in the user
application specific interceptors (which relied on JBoss AS specific
libraries) into this invocation flow so that they do run some
application specific logic before the control reaches step#5 above. For
example, AS5 allowed the use of JBoss AOP interceptors to do this.</p>
</div>
<div class="paragraph">
<p>As of WildFly 8, this feature was implemented.</p>
</div>
</div>
<div class="sect3">
<h4 id="configuring-container-interceptors"><a class="anchor" href="#configuring-container-interceptors"></a>9.6.2. Configuring container interceptors</h4>
<div class="paragraph">
<p>As you can see from the JIRA <a href="https://issues.redhat.com/browse/AS7-5897" class="bare">https://issues.redhat.com/browse/AS7-5897</a>,
one of the goals of this feature implementation was to make sure that we
don&#8217;t introduce any new WildFly specific library dependencies for the
container interceptors. So we decided to allow the Jakarta Interceptors
(which are just POJO classes with lifecycle callback annotations) to be
used as container interceptors. As such you won&#8217;t need any dependency on
any WildFly specific libraries. That will allow us to support this
feature for a longer time in future versions of WildFly.</p>
</div>
<div class="paragraph">
<p>Furthermore, configuring these container interceptors is similar to
configuring the Jakarta Interceptors for EJBs. In fact, it uses the same
xsd elements that are allowed in ejb-jar.xml for 3.1 version of ejb-jar
deployment descriptor.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Container interceptors can only be configured via deployment
descriptors. There&#8217;s no annotation based way to configure container
interceptors. This was an intentional decision, taken to avoid
introducing any WildFly specific library dependency for the annotation.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Configuring the container interceptors can be done in jboss-ejb3.xml
file, which then gets placed under the META-INF folder of the EJB
deployment, just like the ejb-jar.xml. Here&#8217;s an example of how the
container interceptor(s) can be configured in jboss-ejb3.xml:</p>
</div>
<div class="listingblock">
<div class="title">jboss-ejb3.xml</div>
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;jboss xmlns="http://www.jboss.com/xml/ns/javaee"
       xmlns:jee="http://java.sun.com/xml/ns/javaee"
       xmlns:ci ="urn:container-interceptors:1.0"&gt;

    &lt;jee:assembly-descriptor&gt;
        &lt;ci:container-interceptors&gt;
            &lt;!-- Default interceptor --&gt;
            &lt;jee:interceptor-binding&gt;
                &lt;ejb-name&gt;*&lt;/ejb-name&gt;
                &lt;interceptor-class&gt;org.jboss.as.test.integration.ejb.container.interceptor.ContainerInterceptorOne&lt;/interceptor-class&gt;
            &lt;/jee:interceptor-binding&gt;
            &lt;!-- Class level container-interceptor --&gt;
            &lt;jee:interceptor-binding&gt;
                &lt;ejb-name&gt;AnotherFlowTrackingBean&lt;/ejb-name&gt;
                &lt;interceptor-class&gt;org.jboss.as.test.integration.ejb.container.interceptor.ClassLevelContainerInterceptor&lt;/interceptor-class&gt;
            &lt;/jee:interceptor-binding&gt;
            &lt;!-- Method specific container-interceptor --&gt;
            &lt;jee:interceptor-binding&gt;
                &lt;ejb-name&gt;AnotherFlowTrackingBean&lt;/ejb-name&gt;
                &lt;interceptor-class&gt;org.jboss.as.test.integration.ejb.container.interceptor.MethodSpecificContainerInterceptor&lt;/interceptor-class&gt;
                &lt;method&gt;
                    &lt;method-name&gt;echoWithMethodSpecificContainerInterceptor&lt;/method-name&gt;
                &lt;/method&gt;
            &lt;/jee:interceptor-binding&gt;
            &lt;!-- container interceptors in a specific order --&gt;
            &lt;jee:interceptor-binding&gt;
                &lt;ejb-name&gt;AnotherFlowTrackingBean&lt;/ejb-name&gt;
                &lt;interceptor-order&gt;
                    &lt;interceptor-class&gt;org.jboss.as.test.integration.ejb.container.interceptor.ClassLevelContainerInterceptor&lt;/interceptor-class&gt;
                    &lt;interceptor-class&gt;org.jboss.as.test.integration.ejb.container.interceptor.MethodSpecificContainerInterceptor&lt;/interceptor-class&gt;
                    &lt;interceptor-class&gt;org.jboss.as.test.integration.ejb.container.interceptor.ContainerInterceptorOne&lt;/interceptor-class&gt;
                &lt;/interceptor-order&gt;
                &lt;method&gt;
                    &lt;method-name&gt;echoInSpecificOrderOfContainerInterceptors&lt;/method-name&gt;
                &lt;/method&gt;
            &lt;/jee:interceptor-binding&gt;
        &lt;/ci:container-interceptors&gt;
    &lt;/jee:assembly-descriptor&gt;
&lt;/jboss&gt;</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>The usage of urn:container-interceptors:1.0 namespace which allows the
container-interceptors elements to be configured</p>
</li>
<li>
<p>The container-interceptors element which contain the interceptor
bindings</p>
</li>
<li>
<p>The interceptor bindings themselves are the same elements as what the
EJB3.1 xsd allows for standard Jakarta Interceptors</p>
</li>
<li>
<p>The interceptors can be bound either to all EJBs in the deployment
(using the the * wildcard) or individual bean level (using the specific
EJB name) or at specific method level for the EJBs.</p>
</li>
</ul>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
The xsd for the urn:container-interceptors:1.0 namespace is available
here
<a href="https://github.com/jbossas/jboss-as/blob/master/ejb3/src/main/resources/jboss-ejb-container-interceptors_1_0.xsd" class="bare">https://github.com/jbossas/jboss-as/blob/master/ejb3/src/main/resources/jboss-ejb-container-interceptors_1_0.xsd</a>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The interceptor classes themselves are simple POJOs and use the
<code>@javax.annotation.AroundInvoke</code> to mark the around invoke method which
will get invoked during the invocation on the bean. Here&#8217;s an example of
the interceptor:</p>
</div>
<div class="listingblock">
<div class="title">Example of container interceptor</div>
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">public class ClassLevelContainerInterceptor {
    @AroundInvoke
    private Object iAmAround(final InvocationContext invocationContext) throws Exception {
        return this.getClass().getName() + " " + invocationContext.proceed();
    }

}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="container-interceptor-positioning-in-the-interceptor-chain"><a class="anchor" href="#container-interceptor-positioning-in-the-interceptor-chain"></a>9.6.3. Container interceptor positioning in the interceptor chain</h4>
<div class="paragraph">
<p>The container interceptors configured for a EJB are guaranteed to be run
before the WildFly provided security interceptors, transaction
management interceptors and other such interceptors thus allowing the
user application specific container interceptors to setup any relevant
context data before the invocation proceeds.</p>
</div>
</div>
<div class="sect3">
<h4 id="semantic-difference-between-container-interceptors-and-Jakarta-Interceptors-api"><a class="anchor" href="#semantic-difference-between-container-interceptors-and-Jakarta-Interceptors-api"></a>9.6.4. Semantic difference between container interceptor(s) and Jakarta Interceptors API</h4>
<div class="paragraph">
<p>Although the container interceptors are modeled to be similar to the
Jakarta Interceptors, there are some differences in the API semantics.
One such difference is that invoking on
javax.interceptor.InvocationContext.getTarget() method is illegal for
container interceptors since these interceptors are invoked way before
the EJB components are setup or instantiated.</p>
</div>
</div>
<div class="sect3">
<h4 id="testcase"><a class="anchor" href="#testcase"></a>9.6.5. Testcase</h4>
<div class="paragraph">
<p>This testcase in the WildFly codebase can be used for reference for
implementing container interceptors in user applications
<a href="https://github.com/wildfly/wildfly/blob/master/testsuite/integration/basic/src/test/java/org/jboss/as/test/integration/ejb/container/interceptor/ContainerInterceptorsTestCase.java" class="bare">https://github.com/wildfly/wildfly/blob/master/testsuite/integration/basic/src/test/java/org/jboss/as/test/integration/ejb/container/interceptor/ContainerInterceptorsTestCase.java</a></p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
References in this document to Enterprise JavaBeans(EJB) refer to the Jakarta Enterprise Beans unless otherwise noted.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="Jakarta_Enterprise_Beans_Clustered_Database_Timers"><a class="anchor" href="#Jakarta_Enterprise_Beans_Clustered_Database_Timers"></a>9.7. Jakarta Enterprise Beans 3 Clustered Database Timers</h3>
<div class="quoteblock abstract">
<blockquote>
WildFly now supports clustered database backed timers. The clustering
support is provided through the database, and as a result it is not
intended to be a super high performance solution that supports thousands
of timers going off a second, however properly tuned it should provide
sufficient performance for most use cases.
</blockquote>
</div>
<div class="paragraph">
<p>Note that database timers can also be used in non-clustered mode.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Note that for this to work correctly the underlying database must
support the READ_COMMITTED or SERIALIZABLE isolation mode and the
datasource must be configured accordingly
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="setup"><a class="anchor" href="#setup"></a>9.7.1. Setup</h4>
<div class="paragraph">
<p>In order to use clustered timers it is necessary to add a database
backed timer store. This can be done from the CLI with the following
command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=ejb3/service=timer-service/database-data-store=my-clustered-store:add(allow-execution=true, datasource-jndi-name='java:/MyDatasource', refresh-interval=60000, database='postgresql', partition='mypartition')</code></pre>
</div>
</div>
<div class="paragraph">
<p>An explanation of the parameters is below:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>allow-execution</strong> - If this node is allowed to execute timers. If this
is false then timers added on this node will be added to the database
for another node to execute. This allows you to limit timer execution to
a few nodes in a cluster, which can greatly reduce database load for
large clusters.</p>
</li>
<li>
<p><strong>datasource-jndi-name</strong> - The datasource to use</p>
</li>
<li>
<p><strong>refresh-interval</strong> - The refresh interval in milliseconds. This is the
period of time that must elapse before this node will check the database
for new timers added by other nodes. A smaller value means that timers
will be picked up more quickly, however it will result in more load on
the database. This is most important to tune if you are adding timers
that will expire quickly. If the node that added the timer cannot
execute it (e.g. because it has failed or because allow-execution is
false), this timer may not be executed until a node has refreshed.</p>
</li>
<li>
<p><strong>database</strong> - Define the type of database that is in use. Some SQL
statements are customised by database, and this tells the data store
which version of the SQL to use.<br>
Without this attribute the server try to detected the type
automatically, current supported types are <em>postgresql, mysql, oracle,
db2, hsql</em> and <em>h2</em>.<br>
Note that this SQL resides in the file
<em>modules/system/layers/base/org/jboss/as/ejb3/main/timers/timer-sql.properties</em><br>
And as such is it possible to modify the SQL that is executed or add
support for new databases by adding new DB specific SQL to this file (if
you do add support for a new database it would be greatly appreciated if
you could contribute the SQL back to the project).</p>
</li>
<li>
<p><strong>partition</strong> - A node will only see timers from other nodes that have
the same partition name. This allows you to break a large cluster up
into several smaller clusters, which should improve performance. e.g.
instead of having a cluster of 100 nodes, where all hundred are trying
to execute and refresh the same timers, you can create 20 clusters of 5
nodes by giving ever group of 5 a different partition name.</p>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="non-clustered-timers"><a class="anchor" href="#non-clustered-timers"></a>Non clustered timers</h5>
<div class="paragraph">
<p>Note that you can still use the database data store for non-clustered
timers, in which case set the refresh interval to zero and make sure
that every node has a unique partition name (or uses a different
database).</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="using-clustered-timers-in-a-deployment"><a class="anchor" href="#using-clustered-timers-in-a-deployment"></a>9.7.2. Using clustered timers in a deployment</h4>
<div class="paragraph">
<p>It is possible to use the data store as default for all applications by
changing the default-data-store within the ejb3 subsystem:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">    &lt;timer-service thread-pool-name="timer" default-data-store="clustered-store"&gt;
        &lt;data-stores&gt;
            &lt;database-data-store name="clustered-store" datasource-jndi-name="java:jboss/datasources/ExampleDS" partition="timer"/&gt;
        &lt;/data-stores&gt;
    &lt;/timer-service&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Another option is to use a separate data store for specific
applications, all that is required is to set the timer data store name
in jboss-ejb3.xml:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;?xml version="1.1" encoding="UTF-8"?&gt;
&lt;jboss:ejb-jar xmlns:jboss="http://www.jboss.com/xml/ns/javaee"
               xmlns="http://java.sun.com/xml/ns/javaee"
               xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
               xmlns:timer="urn:timer-service:1.0"
               xsi:schemaLocation="http://www.jboss.com/xml/ns/javaee http://www.jboss.org/j2ee/schema/jboss-ejb3-2_0.xsd
                     http://java.sun.com/xml/ns/javaee http://java.sun.com/xml/ns/javaee/ejb-jar_3_1.xsd"
               version="3.1"
               impl-version="2.0"&gt;
    &lt;assembly-descriptor&gt;
            &lt;timer:timer&gt;
                &lt;ejb-name&gt;*&lt;/ejb-name&gt;
                &lt;timer:persistence-store-name&gt;my-clustered-store&lt;/timer:persistence-store-name&gt;
            &lt;/timer:timer&gt;
        &lt;/assembly-descriptor&gt;
&lt;/jboss:ejb-jar&gt;</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="programmatically-refresh-timer"><a class="anchor" href="#programmatically-refresh-timer"></a>9.7.3. Programmatically Refresh Timer</h4>
<div class="paragraph">
<p>In a clustered deployment, multiple nodes updating timer datastore may cause the in-memory timer state to be temporarily
out of sync. Some application may find the <code>refresh-interval</code> configuration not sufficient in some cases, and
need to programmatically refresh timers. This can be done with Jakarta Interceptors configured for those business methods
that need this capability, as illustrated in the following steps:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Implement an Jakarta Interceptors that enables <code>wildfly.ejb.timer.refresh.enabled</code> to true. For example,</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">import javax.interceptor.AroundInvoke;
import javax.interceptor.Interceptor;
import javax.interceptor.InvocationContext;

/**
 * An interceptor to enable programmatic timer refresh across multiple nodes.
 */
@Interceptor
public class RefreshInterceptor {
    @AroundInvoke
    public Object intercept(InvocationContext context) throws Exception {
        context.getContextData().put("wildfly.ejb.timer.refresh.enabled", Boolean.TRUE);
        return context.proceed();
    }
}</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Configure the Jakarta Interceptors to the target stateless or singleton bean business methods.
When <code>wildfly.ejb.timer.refresh.enabled</code> is set to true, calling <code>TimerService.getAllTimers()</code>
will first refresh from timer datastore before returning timers. For example,</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">@Singleton
public class RefreshBean1 ... {

    @Interceptors(RefreshInterceptor.class)
    public void businessMethod1() {
        ...
        // since wildfly.ejb.timer.refresh.enabled is set to true in interceptor for this business method,
        // calling timerService.getAllTimers() will first refresh from timer datastore before returning timers.
        final Collection&lt;Timer&gt; allTimers = timerService.getAllTimers();
        ...
    }
}</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Applications may configure such an interceptor to certain business methods that require this capability.
Alternatively, applications may implement a dedicated business method to programmatically refresh timers, to
be invoked by other parts of the application when needed. For example,</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">    @Interceptors(RefreshInterceptor.class)
    public List&lt;Timer&gt; getAllTimerInfoWithRefresh() {
        return timerService.getAllTimers();
    }

    public void businessMethod1() {
        final LocalBusinessInterface businessObject = sessionContext.getBusinessObject(LocalBusinessInterface.class);
        businessObject.getAllTimerInfoWithRefresh();

        // timer has been programmatically refreshed from datastore.
        // continue with other business logic...
    }</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="technical-details"><a class="anchor" href="#technical-details"></a>9.7.4. Technical details</h4>
<div class="paragraph">
<p>Internally every node that is allowed to execute timers schedules a
timeout for every timer is knows about. When this timeout expires then
this node attempts to 'lock' the timer, by updating its state to
running. The query this executes looks like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>UPDATE JBOSS_EJB_TIMER SET TIMER_STATE=? WHERE ID=? AND TIMER_STATE&lt;&gt;? AND NEXT_DATE=?;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Due to the use of a transaction and READ_COMMITTED or SERIALIZABLE
isolation mode only one node will succeed in updating the row, and this
is the node that the timer will run on.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="Jakarta_Enterprise_Beans_IIOP_Guide"><a class="anchor" href="#Jakarta_Enterprise_Beans_IIOP_Guide"></a>9.8. Jakarta Enterprise Beans IIOP Guide</h3>
<div class="sect3">
<h4 id="enabling-iiop"><a class="anchor" href="#enabling-iiop"></a>9.8.1. Enabling IIOP</h4>
<div class="paragraph">
<p>To enable IIOP you must have the JacORB subsystem installed, and the
<code>&lt;iiop/&gt;</code> element present in the ejb3 subsystem configuration. The
<code>standalone-full.xml</code> configuration that comes with the distribution has
both of these enabled.</p>
</div>
<div class="paragraph">
<p>The <code>&lt;iiop/&gt;</code> element takes two attributes that control the default
behaviour of the server, for full details see <a href="Admin_Guide.html#EJB3">EJB3
subsystem configuration guide</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="enabling-jts"><a class="anchor" href="#enabling-jts"></a>9.8.2. Enabling JTS</h4>
<div class="paragraph">
<p>To enable JTS simply add a <code>&lt;jts/&gt;</code> element to the transactions
subsystem configuration.</p>
</div>
<div class="paragraph">
<p>It is also necessary to enable the JacORB transactions interceptor as
shown below.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;subsystem xmlns="urn:jboss:domain:jacorb:1.1"&gt;
  &lt;orb&gt;
    &lt;initializers transactions="on"/&gt;
  &lt;/orb&gt;
&lt;/subsystem&gt;</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="dynamic-stubs"><a class="anchor" href="#dynamic-stubs"></a>9.8.3. Dynamic Stub&#8217;s</h4>
<div class="paragraph">
<p>Downloading stubs directly from the server is no longer supported. If
you do not wish to pre-generate your stub classes JDK Dynamic stubs can
be used instead. The enable JDK dynamic stubs simply set the
<code>com.sun.CORBA.ORBUseDynamicStub</code> system property to <code>true</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="configuring-Jakarta-Enterprise-Beans-iiop-settings-via-jboss-ejb3.xml"><a class="anchor" href="#configuring-Jakarta-Enterprise-Beans-iiop-settings-via-jboss-ejb3.xml"></a>9.8.4. Configuring Jakarta Enterprise Beans IIOP settings via jboss-ejb3.xml</h4>
<div class="paragraph">
<p>TODO</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="Jakarta_Enterprise_Beans_over_HTTP"><a class="anchor" href="#Jakarta_Enterprise_Beans_over_HTTP"></a>9.9. Jakarta Enterprise Beans over HTTP</h3>
<div class="paragraph">
<p>Beginning with WildFly 11 it is now possible to use HTTP as the
transport (instead of remoting) for remote Jakarta Enterprise Beans and JNDI invocations.</p>
</div>
<div class="paragraph">
<p>Everything mentioned below is applicable for both JNDI and Jakarta Enterprise Beans
functionality.</p>
</div>
<div class="sect3">
<h4 id="server-configuration"><a class="anchor" href="#server-configuration"></a>9.9.1. Server Configuration</h4>
<div class="paragraph">
<p>In order to configure the server the http-invoker needs to be enabled on
each virtual host you wish to use in the Undertow subsystem. This is
enabled by default in standard configs, but if it has been removed it
can be added via:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>/subsystem=undertow/server=default-server/host=default-host/setting=http-invoker:add(http-authentication-factory=myfactory, path='/wildfly-services')</pre>
</div>
</div>
<div class="paragraph">
<p>The Hhttp-invoker takes two parameters, a path (which defaults to
/wildfly-services) and a http-authentication-factory which must be a
reference to an Elytron http-authentication-factory.</p>
</div>
<div class="paragraph">
<p>Note that any deployment that wishes to use this must use Elytron
security with the same security domain that corresponds to the HTTP
authentication factory.</p>
</div>
</div>
<div class="sect3">
<h4 id="performing-invocations"><a class="anchor" href="#performing-invocations"></a>9.9.2. Performing Invocations</h4>
<div class="paragraph">
<p>The mechanism for performing invocations is exactly the same as for the
remoting based Jakarta Enterprise Beans client, the only difference is that instead of a
'remote+http' URI you use a 'http' URI (which must include the path that
was configured in the invoker). For example if you are currently using
'remote+ <a href="http://localhost:8080'" class="bare">http://localhost:8080'</a> as the target URI, you would change this
to 'http://localhost:8080/wildfly-services'.</p>
</div>
</div>
<div class="sect3">
<h4 id="implementation-details"><a class="anchor" href="#implementation-details"></a>9.9.3. Implementation details</h4>
<div class="paragraph">
<p>The wire protocol is detailed at
<a href="https://github.com/wildfly/wildfly-http-client/blob/master/docs/src/main/asciidoc/wire-spec-v1.asciidoc" class="bare">https://github.com/wildfly/wildfly-http-client/blob/master/docs/src/main/asciidoc/wire-spec-v1.asciidoc</a></p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="jboss-ejb3"><a class="anchor" href="#jboss-ejb3"></a>9.10. jboss-ejb3.xml Reference</h3>
<div class="paragraph">
<p><code>jboss-ejb3.xml</code> is a custom deployment descriptor that can be placed in
either ejb-jar or war archives. If it is placed in an ejb-jar then it
must be placed in the <code>META-INF</code> folder, in a web archive it must be
placed in the <code>WEB-INF</code> folder.</p>
</div>
<div class="paragraph">
<p>The contents of <code>jboss-ejb3.xml</code> are merged with the contents of
<code>ejb-jar.xml</code>, with the <code>jboss-ejb3.xml</code> items taking precedence.</p>
</div>
<div class="sect3">
<h4 id="example-file"><a class="anchor" href="#example-file"></a>9.10.1. Example File</h4>
<div class="paragraph">
<p>A simple example is shown below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;?xml version="1.1" encoding="UTF-8"?&gt;
&lt;jboss:ejb-jar xmlns:jboss="http://www.jboss.com/xml/ns/javaee"
               xmlns="http://java.sun.com/xml/ns/javaee"
               xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
               xmlns:s="urn:security:1.1"
               xsi:schemaLocation="http://www.jboss.com/xml/ns/javaee http://www.jboss.org/j2ee/schema/jboss-ejb3-2_0.xsd http://java.sun.com/xml/ns/javaee http://www.jboss.org/j2ee/schema/jboss-ejb3-spec-2_0.xsd"
               version="3.1"
               impl-version="2.0"&gt;
    &lt;enterprise-beans&gt;
        &lt;message-driven&gt;
            &lt;ejb-name&gt;ReplyingMDB&lt;/ejb-name&gt;
            &lt;ejb-class&gt;org.jboss.as.test.integration.ejb.mdb.messagedestination.ReplyingMDB&lt;/ejb-class&gt;
            &lt;activation-config&gt;
                &lt;activation-config-property&gt;
                    &lt;activation-config-property-name&gt;destination&lt;/activation-config-property-name&gt;
                    &lt;activation-config-property-value&gt;java:jboss/mdbtest/messageDestinationQueue
                    &lt;/activation-config-property-value&gt;
                &lt;/activation-config-property&gt;
            &lt;/activation-config&gt;
        &lt;/message-driven&gt;
    &lt;/enterprise-beans&gt;
    &lt;assembly-descriptor&gt;
        &lt;s:security&gt;
            &lt;ejb-name&gt;DDMyDomainSFSB&lt;/ejb-name&gt;
            &lt;s:security-domain&gt;myDomain&lt;/s:security-domain&gt;
            &lt;s:run-as-principal&gt;myPrincipal&lt;/s:run-as-principal&gt;
        &lt;/s:security&gt;
    &lt;/assembly-descriptor&gt;
&lt;/jboss:ejb-jar&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see the format is largely similar to <code>ejb-jar.xml</code>, in fact
they even use the same namespaces, however <code>jboss-ejb3.xml</code> adds some
additional namespaces of its own to allow for configuring non-spec info.
The format of the standard <code><a href="http://java.sun.com/xml/ns/javaee" class="bare">http://java.sun.com/xml/ns/javaee</a></code> is well
documented elsewhere, this document will cover the non-standard
namespaces.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Namespace "http://www.jboss.com/xml/ns/javaee" is bound to "jboss-ejb3-spec-2_0.xsd": this file redefines some elements of "ejb-jar_3_1.xml"
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="the-root-namespace-httpwww.jboss.comxmlnsjavaee"><a class="anchor" href="#the-root-namespace-httpwww.jboss.comxmlnsjavaee"></a>The root namespace <a href="http://www.jboss.com/xml/ns/javaee" class="bare">http://www.jboss.com/xml/ns/javaee</a></h5>

</div>
<div class="sect4">
<h5 id="assembly-descriptor-namespaces"><a class="anchor" href="#assembly-descriptor-namespaces"></a>Assembly descriptor namespaces</h5>
<div class="paragraph">
<p>The following namespaces can all be used in the <code>&lt;assembly-descriptor&gt;</code>
element. They can be used to apply their configuration to a single bean,
or to all beans in the deployment by using <code>*</code> as the <code>ejb-name</code>.</p>
</div>
<div class="sect5">
<h6 id="the-security-namespace-urnsecurity"><a class="anchor" href="#the-security-namespace-urnsecurity"></a>The security namespace urn:security</h6>
<div class="paragraph">
<p>This allows you to set the security domain and the run-as principal for
an Jakarta Enterprise Beans.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;s:security&gt;
  &lt;ejb-name&gt;*&lt;/ejb-name&gt;
  &lt;s:security-domain&gt;myDomain&lt;/s:security-domain&gt;
  &lt;s:run-as-principal&gt;myPrincipal&lt;/s:run-as-principal&gt;
&lt;/s:security&gt;</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="the-resource-adaptor-namespace-urnresource-adapter-binding"><a class="anchor" href="#the-resource-adaptor-namespace-urnresource-adapter-binding"></a>The resource adaptor namespace urn:resource-adapter-binding</h6>
<div class="paragraph">
<p>This allows you to set the resource adaptor for an MDB.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;r:resource-adapter-binding&gt;
  &lt;ejb-name&gt;*&lt;/ejb-name&gt;
  &lt;r:resource-adapter-name&gt;myResourceAdaptor&lt;/r:resource-adapter-name&gt;
&lt;/r:resource-adapter-binding&gt;</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="the-iiop-namespace-urniiop"><a class="anchor" href="#the-iiop-namespace-urniiop"></a>The IIOP namespace urn:iiop</h6>
<div class="paragraph">
<p>The IIOP namespace is where IIOP settings are configured. As there are
quite a large number of options these are covered in the
<a href="#Jakarta_Enterprise_Beans_IIOP_Guide">IIOP guide</a>.</p>
</div>
</div>
<div class="sect5">
<h6 id="the-pool-namespace-urnejb-pool1.0"><a class="anchor" href="#the-pool-namespace-urnejb-pool1.0"></a>The pool namespace urn:ejb-pool:1.0</h6>
<div class="paragraph">
<p>This allows you to select the pool that is used by the SLSB or MDB.
Pools are defined in the server configuration (i.e. <code>standalone.xml</code> or
<code>domain.xml</code>)</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;p:pool&gt;
  &lt;ejb-name&gt;*&lt;/ejb-name&gt;
  &lt;p:bean-instance-pool-ref&gt;my-pool&lt;/p:bean-instance-pool-ref&gt;
&lt;/p:pool&gt;</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="the-cache-namespace-urnejb-cache1.0"><a class="anchor" href="#the-cache-namespace-urnejb-cache1.0"></a>The cache namespace urn:ejb-cache:1.0</h6>
<div class="paragraph">
<p>This allows you to select the cache that is used by the SFSB. Caches are
defined in the server configuration (i.e. <code>standalone.xml</code> or
<code>domain.xml</code>)</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;c:cache&gt;
  &lt;ejb-name&gt;*&lt;/ejb-name&gt;
  &lt;c:cache-ref&gt;my-cache&lt;/c:cache-ref&gt;
&lt;/c:cache&gt;</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="the-clustering-namespace-urnclustering1.0"><a class="anchor" href="#the-clustering-namespace-urnclustering1.0"></a>The clustering namespace urn:clustering:1.0</h6>
<div class="paragraph">
<p>This namespace is deprecated and as of WildFly 14 its use has no effect.
The clustering behavior of Jakarta Enterprise Beans are determined by the profile in use on
the server.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="Message_Driven_Beans_Controlled_Delivery"><a class="anchor" href="#Message_Driven_Beans_Controlled_Delivery"></a>9.11. Message Driven Beans Controlled Delivery</h3>
<div class="paragraph">
<p>There are three mechanisms in WildFly that allow controlling if a
specific MDB is actively receiving or not messages:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>delivery active</p>
</li>
<li>
<p>delivery groups</p>
</li>
<li>
<p>clustered singleton</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>We will see each one of them in the following sections.</p>
</div>
<div class="sect3">
<h4 id="delivery-active"><a class="anchor" href="#delivery-active"></a>9.11.1. Delivery Active</h4>
<div class="paragraph">
<p>Delivery active is simply an attribute associated with the MDB that
indicates if the MDB is receiving messages or not. If an MDB is not
currently receiving messages, the messages will be saved in the queue or
topic for later, according to the rules of the topic/queue.</p>
</div>
<div class="paragraph">
<p>You can configure delivery active using xml or annotations, and you can
change its value after deployment using the cli.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>jboss-ejb3.xml:</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In the jboss-ejb3 xml file, configure the value of active as false to
mark that the MDB will not be receiving messages as soon as it is
deployed:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;?xml version="1.1" encoding="UTF-8"?&gt;
&lt;jboss:ejb-jar xmlns:jboss="http://www.jboss.com/xml/ns/javaee"
               xmlns="http://java.sun.com/xml/ns/javaee"
               xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
               xmlns:d="urn:delivery-active:1.2"
               xsi:schemaLocation="http://www.jboss.com/xml/ns/javaee http://www.jboss.org/j2ee/schema/jboss-ejb3-2_0.xsd http://java.sun.com/xml/ns/javaee http://java.sun.com/xml/ns/javaee/ejb-jar_3_1.xsd"                version="3.1"
               impl-version="2.0"&gt;
    &lt;assembly-descriptor&gt;
        &lt;d:delivery&gt;
            &lt;ejb-name&gt;HelloWorldQueueMDB&lt;/ejb-name&gt;
            &lt;d:active&gt;false&lt;/d:active&gt;
        &lt;/d:delivery&gt;
    &lt;/assembly-descriptor&gt;
&lt;/jboss:ejb-jar&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can use a wildcard "*" in the place of ejb-name if you want to apply
that active value to all MDBs in your application.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>annotation</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Alternatively, you can use the org.jboss.ejb3.annotation.DeliveryActive
annotation, as in the example below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">@MessageDriven(name = "HelloWorldMDB", activationConfig = {

 @ActivationConfigProperty(propertyName = "destinationType", propertyValue = "javax.jms.Queue"),

 @ActivationConfigProperty(propertyName = "destination", propertyValue = "queue/HELLOWORLDMDBQueue"),

 @ActivationConfigProperty(propertyName = "acknowledgeMode", propertyValue = "Auto-acknowledge") })

@DeliveryActive(false)

public class HelloWorldMDB implements MessageListener {
    public void onMessage(Message rcvMessage) {
      // ...
    }
}</code></pre>
</div>
</div>
<div class="sect4">
<h5 id="start-delivery-and-stop-delivery"><a class="anchor" href="#start-delivery-and-stop-delivery"></a>Start-delivery and Stop-Delivery</h5>
<div class="paragraph">
<p>These management operations dynamically change the value of the active
attribute, enabling or disabling delivery for the MDB. at runtime To use
them, connect to the WildFly instance you want to manage, then enter the
path of the MDB you want to manage delivery for:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>[standalone@localhost:9990 /] cd deployment=jboss-helloworld-mdb.war/subsystem=ejb3/message-driven-bean=HelloWorldMDB

[standalone@localhost:9990 message-driven-bean=HelloWorldMDB] :stop-delivery
{"outcome" =&gt; "success"}

[standalone@localhost:9990 message-driven-bean=HelloWorldMDB] :start-delivery
{"outcome" =&gt; "success"}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="delivery-groups"><a class="anchor" href="#delivery-groups"></a>9.11.2. Delivery Groups</h4>
<div class="paragraph">
<p>Delivery groups provide a straightforward way to manage delivery for a
group of MDBs. Every MDB belonging to a delivery group has delivery
active if that group is active, and has delivery inactive
whenever the group is not active.</p>
</div>
<div class="paragraph">
<p>You can add a delivery group to the ejb3 subsystem using either the
subsystem xml or cli. Next, we will see examples of each case. In those
examples we will add only a single delivery group, but keep in mind that
you can add as many delivery groups as you need to a WildFly instance.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>the ejb3 subsystem xml (located in your configuration xml, such as
standalone.xml)</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;subsystem xmlns="urn:jboss:domain:ejb3:4.0"&gt;
    ...
    &lt;mdb&gt;
        ...
        &lt;delivery-groups&gt;
            &lt;delivery-group name="mdb-group-name" active="true"/&gt;
        &lt;/delivery-groups&gt;
    &lt;/mdb&gt;
    ...
&lt;/subsystem&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The example above adds a delivery group named "mdb-group-name" (you can
use whatever name suits you best as the group name). The "true" active
attribute indicates that all MDBs belonging to that group will have
delivery active right after deployment. If you mark that attribute as
false, you are indicating that every MDB belonging to the group will not
start receiving messages after deployment, a condition that will remain
until the group becomes active.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>jboss-cli</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>You can add a mdb-delivery-group using the add command as below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>[standalone@localhost:9990 /] ./subsystem=ejb3/mdb-delivery-group=mdb-group-name:add
{"outcome" =&gt; "success"}</code></pre>
</div>
</div>
<div class="sect4">
<h5 id="reading-and-writing-the-delivery-state-of-a-delivery-group"><a class="anchor" href="#reading-and-writing-the-delivery-state-of-a-delivery-group"></a>Reading and Writing the Delivery State of a Delivery Group</h5>
<div class="paragraph">
<p>You can check whether delivery is active for a group by reading the
active attribute, which defaults to true:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>[standalone@localhost:9990 /] ./subsystem=ejb3/mdb-delivery-group=mdb-group-name:read-attribute(name=active)
{ "outcome" =&gt; "success", "result" =&gt; true }</code></pre>
</div>
</div>
<div class="paragraph">
<p>To make the the delivery-group inactive, just write the active attribute
with a false value:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>[standalone@localhost:9990 /] ./subsystem=ejb3/mdb-delivery-group=mdb-group-name:write-attribute(name=active,value=false)
{"outcome" =&gt; "success"}

[standalone@localhost:9990 /] ./subsystem=ejb3/mdb-delivery-group=mdb-group-name:read-attribute(name=active)
{ "outcome" =&gt; "success", "result" =&gt; false }</code></pre>
</div>
</div>
<div class="paragraph">
<p>To make it active again, write the attribute with a true value:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>[standalone@localhost:9990 /] ./subsystem=ejb3/mdb-delivery-group=mdb-group-name:write-attribute(name=active,value=true)
{"outcome" =&gt; "success"}

[standalone@localhost:9990 /] ./subsystem=ejb3/mdb-delivery-group=mdb-group-name:read-attribute(name=active)
{ "outcome" =&gt; "success", "result" =&gt; true }</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="using-delivery-groups"><a class="anchor" href="#using-delivery-groups"></a>Using Delivery Groups</h5>
<div class="paragraph">
<p>To mark that an MDB belongs to a delivery-group, declare so in the
jboss-ejb3.xml file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;?xml version="1.1" encoding="UTF-8"?&gt;

&lt;jboss:ejb-jar xmlns:jboss="http://www.jboss.com/xml/ns/javaee"
               xmlns="http://java.sun.com/xml/ns/javaee"
               xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
               xmlns:d="urn:delivery-active:1.2"
               xsi:schemaLocation="http://www.jboss.com/xml/ns/javaee http://www.jboss.org/j2ee/schema/jboss-ejb3-2_0.xsd http://java.sun.com/xml/ns/javaee http://java.sun.com/xml/ns/javaee/ejb-jar_3_1.xsd"
               version="3.1"
               impl-version="2.0"&gt;
    &lt;assembly-descriptor&gt;
        &lt;d:delivery&gt;
            &lt;ejb-name&gt;HelloWorldMDB&lt;/ejb-name&gt;
            &lt;d:group&gt;mdb-delivery-group&lt;/d:group&gt;
        &lt;/d:delivery&gt;
    &lt;/assembly-descriptor&gt;
&lt;/jboss:ejb-jar&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can also use a wildcard to mark that all MDBs in your application
belong to a delivery-group. In the following example, we add all MDBs in
the application to group1, except for HelloWorldMDB, that is added to
group2:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;?xml version="1.1" encoding="UTF-8"?&gt;
&lt;jboss:ejb-jar xmlns:jboss="http://www.jboss.com/xml/ns/javaee"
               xmlns="http://java.sun.com/xml/ns/javaee"
               xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
               xmlns:d="urn:delivery-active:1.2"
               xsi:schemaLocation="http://www.jboss.com/xml/ns/javaee http://www.jboss.org/j2ee/schema/jboss-ejb3-2_0.xsd http://java.sun.com/xml/ns/javaee http://java.sun.com/xml/ns/javaee/ejb-jar_3_1.xsd"
               version="3.1"
               impl-version="2.0"&gt;
    &lt;assembly-descriptor&gt;
        &lt;d:delivery&gt;
            &lt;ejb-name&gt;*&lt;/ejb-name&gt;
            &lt;d:group&gt;group1&lt;/d:group&gt;
        &lt;/d:delivery&gt;
        &lt;d:delivery&gt;
            &lt;ejb-name&gt;HelloWorldMDB&lt;/ejb-name&gt;
            &lt;d:group&gt;group2&lt;/d:group&gt;
        &lt;/d:delivery&gt;
    &lt;/assembly-descriptor&gt;
&lt;/jboss:ejb-jar&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Another option is to use org.jboss.ejb3.annotation.DeliveryGroup
annotation on each MDB class belonging to a group:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">@MessageDriven(name = "HelloWorldQueueMDB", activationConfig = {
 @ActivationConfigProperty(propertyName = "destinationType", propertyValue = "javax.jms.Queue"),
 @ActivationConfigProperty(propertyName = "destination", propertyValue = "queue/HELLOWORLDMDBQueue"),
 @ActivationConfigProperty(propertyName = "acknowledgeMode", propertyValue = "Auto-acknowledge") })

@DeliveryGroup("group2")

public class HelloWorldMDB implements MessageListener {
    ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>A MDB can belong to more than one delivery group. See the following example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;?xml version="1.1" encoding="UTF-8"?&gt;

&lt;jboss:ejb-jar xmlns:jboss="http://www.jboss.com/xml/ns/javaee"
               xmlns="http://java.sun.com/xml/ns/javaee"
               xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
               xmlns:d="urn:delivery-active:1.2"
               xsi:schemaLocation="http://www.jboss.com/xml/ns/javaee http://www.jboss.org/j2ee/schema/jboss-ejb3-2_0.xsd http://java.sun.com/xml/ns/javaee http://java.sun.com/xml/ns/javaee/ejb-jar_3_1.xsd"
               version="3.1"
               impl-version="2.0"&gt;
    &lt;assembly-descriptor&gt;
        &lt;d:delivery&gt;
            &lt;ejb-name&gt;*&lt;/ejb-name&gt;
            &lt;d:group&gt;mdb-delivery-group1&lt;/d:group&gt;
        &lt;/d:delivery&gt;
        &lt;d:delivery&gt;
            &lt;ejb-name&gt;HelloWorldMDB&lt;/ejb-name&gt;
            &lt;d:group&gt;mdb-delivery-group2&lt;/d:group&gt;
            &lt;d:group&gt;mdb-delivery-group3&lt;/d:group&gt;
        &lt;/d:delivery&gt;
    &lt;/assembly-descriptor&gt;
&lt;/jboss:ejb-jar&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the example above, we use the wildcard to specify that every MDB in the
ejb-jar will belong to mdb-delivery-group1.
That means that, in order for delivery of messages to be active for those MDBs,
mdb-delivery-group1 must be active.</p>
</div>
<div class="paragraph">
<p>In addition, the configuration above specifies that HelloWorldMDB belongs also
to mdb-delivery-group2 and mdb-delivery-group3. So, delivery of messages to
 HelloWorldMDB will only be active when mdb-delivery-group1,
 mdb-delivery-group2, and mdb-delivery-group3 are all active.</p>
</div>
<div class="paragraph">
<p>The same could be specified using the @DeliveryGroup annotation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@MessageDriven(name = "HelloWorldQueueMDB", activationConfig = {
 @ActivationConfigProperty(propertyName = "destinationType", propertyValue = "javax.jms.Queue"),
 @ActivationConfigProperty(propertyName = "destination", propertyValue = "queue/HELLOWORLDMDBQueue"),
 @ActivationConfigProperty(propertyName = "acknowledgeMode", propertyValue = "Auto-acknowledge") })

@DeliveryGroup("mdb-delivery-group2")
@DeliveryGroup("mdb-delivery-group3")

public class HelloWorldMDB implements MessageListener {
    ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Notice that all the delivery-groups used by an application must be installed in
the WildFly server upon deployment, or the deployment will fail with a message
stating that the delivery-group is missing.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="clustered-singleton-delivery"><a class="anchor" href="#clustered-singleton-delivery"></a>9.11.3. Clustered Singleton Delivery</h4>
<div class="paragraph">
<p>Delivery can be marked as singleton in a clustered environment. In this
case, only one node in the cluster will have delivery active for that
MDB, whereas in all other nodes, delivery will be inactive. This option
can be used for applications that are deployed in all nodes of the
cluster. Such applications will be active in all nodes of the cluster,
except for the MDBs that are marked as clustered singleton. For those
MDBs, only one cluster node will be processing their messages. In case
that node stops, another node will have delivery activated, guaranteeing
that there is always one node processing the messages. This node is what
we call the MDB clustered singleton master node.</p>
</div>
<div class="paragraph">
<p>Notice that applications using clustered singleton delivery can only be
deployed in clustered WildFly servers (i.e., servers that are using the
ha configuration).</p>
</div>
<div class="paragraph">
<p>To mark delivery as clustered singleton, you can use the jboss-ejb3.xml
or the @ClusteredSingleton annotation:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>jboss-ejb3.xml:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;?xml version="1.1" encoding="UTF-8"?&gt;
&lt;jboss:ejb-jar xmlns:jboss="http://www.jboss.com/xml/ns/javaee"
               xmlns="http://java.sun.com/xml/ns/javaee"
               xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
               xmlns:c="urn:clustering:1.1"
               xsi:schemaLocation="http://www.jboss.com/xml/ns/javaee http://www.jboss.org/j2ee/schema/jboss-ejb3-2_0.xsd http://java.sun.com/xml/ns/javaee http://java.sun.com/xml/ns/javaee/ejb-jar_3_1.xsd"
               version="3.1"
               impl-version="2.0"&gt;
    &lt;assembly-descriptor&gt;
        &lt;c:clustering&gt;
            &lt;ejb-name&gt;HelloWorldMDB&lt;/ejb-name&gt;
            &lt;c:clustered-singleton&gt;true&lt;/c:clustered-singleton&gt;
        &lt;/c:clustering&gt;
    &lt;/assembly-descriptor&gt;
&lt;/jboss:ejb-jar&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>As in the previous jboss-ejb3.xml examples, a wildcard can be used in
the place of the ejb-name to indicate that all MDBs in the application
are singleton clustered.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>annotation</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>You can use the org.jboss.ejb3.annotation.ClusteredSingleton annotation
to mark an MDB as clustered singleton:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">@MessageDriven(name = "HelloWorldQueueMDB", activationConfig = {
 @ActivationConfigProperty(propertyName = "destinationType", propertyValue = "javax.jms.Queue"),
 @ActivationConfigProperty(propertyName = "destination", propertyValue = "queue/HELLOWORLDMDBQueue"),
 @ActivationConfigProperty(propertyName = "acknowledgeMode", propertyValue = "Auto-acknowledge") })

@ClusteredSingleton

public class HelloWorldMDB implements MessageListener { ... }</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="using-multiple-mdb-delivery-control-mechanisms"><a class="anchor" href="#using-multiple-mdb-delivery-control-mechanisms"></a>9.11.4. Using Multiple MDB Delivery Control Mechanisms</h4>
<div class="paragraph">
<p>The previous delivery control mechanisms can be used together in a
single MDB. In this case, they work as a set of restrictions for
delivery to be active in a MDB.</p>
</div>
<div class="paragraph">
<p>For example, if an MDB belongs to one or more delivery groups and is also a
clustered singleton MDB, the delivery will be active for that MDB only
if the delivery groups are active in the cluster node that was elected as
the singleton master.</p>
</div>
<div class="paragraph">
<p>Also, if you use jboss-cli to stopDelivery on a MDB that belongs to one or more
delivery groups, the MDB will stop receiving messages in case all groups
were active. If one or more of the groups associated with the MDB was not active,
the MDB will continue in the same, inactive state. But, once all groups become active,
the MDB will still be prevented from receiving messages, unless a startDelivery
operation is executed to revert the previously executed stopDelivery operation.</p>
</div>
<div class="paragraph">
<p>Invoking stopDelivery on an MDB that is marked as clustered singleton
will work in a similar way: no visible effect if the current node is not
the clustered singleton master; but it will stop delivery of messages
for that MDB if the current node is the clustered singleton master. If
the current node is not the master, but eventually becomes so, the
delivery of messages will not be active for that MDB, unless a
startDelivery operation is invoked.</p>
</div>
<div class="paragraph">
<p>In other words, when more than one delivery control mechanism is used in
conjunction, they act as a set of restrictions that need all to be true
in order for the MDB to receive messages:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>* MDB belongs to one delivery-group + stop-delivery was invoked*: the delivery group
needs to be active and the delivery needs to be restarted (via start-delivery) in order
for that MDB to start receiving messages;</p>
</li>
<li>
<p>* MDB belongs to one delivery-group + MDB is clustered singleton*: the delivery group
needs to be active and the current node needs to be the clustered singleton master
node in order for that MDB to start receiving messages;</p>
</li>
<li>
<p>* MDB belongs to one delivery-group + MDB is clustered singleton + stop-delivery was invoked*:
as above, the delivery-group has to be active, the current cluster node must be the
clustered singleton master node, plus, start-delivery needs to be invoked on that MDB,
only with these three factors being true the MDB will start receiving messages.</p>
</li>
<li>
<p>* MDB belongs to multiple delivery-groups + stop-delivery was invoked*: all the delivery
groups need to be active and the delivery needs to be restarted (via start-delivery) in
order for that MDB to start receiving messages;</p>
</li>
<li>
<p>* MDB belongs to multiple delivery-groups + MDB is clustered singleton*: all the delivery
groups need to be active and the current node needs to be the clustered singleton
master node in order for that MDB to start receiving messages;</p>
</li>
<li>
<p>* MDB belongs to multiple delivery-groups + MDB is clustered singleton + stop-delivery was
invoked*: as above, all delivery-groups must be active, and current cluster node has to be the
clustered singleton master node, plus, start-delivery needs to be invoked on that MDB, only
with these three factors being true the MDB will start receiving messages.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="Securing_Jakarta_Enterprise_Beans"><a class="anchor" href="#Securing_Jakarta_Enterprise_Beans"></a>9.12. Securing Jakarta Enterprise Beans</h3>
<div class="paragraph">
<p>The Jakarta EE spec specifies certain annotations (like @RolesAllowed,
@PermitAll, @DenyAll) which can be used on Jakarta Enterprise Beans implementation classes
and/or the business method implementations of the beans. Like with all
other configurations, these security related configurations can also be
done via the deployment descriptor (ejb-jar.xml). We <em>won&#8217;t</em> be going
into the details of Jakarta EE specific annotations/deployment descriptor
configurations in this chapter but instead will be looking at the vendor
specific extensions to the security configurations.</p>
</div>
<div class="sect3">
<h4 id="security-domain"><a class="anchor" href="#security-domain"></a>9.12.1. Security Domain</h4>
<div class="paragraph">
<p>The Jakarta EE spec doesn&#8217;t mandate a specific way to configure security
domain for a bean. It leaves it to the vendor implementations to allow
such configurations, the way they wish. In WildFly 14, the use of
<code>@org.jboss.ejb3.annotation.SecurityDomain</code> annotation allows the
developer to configure the security domain for a bean. Here&#8217;s an
example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">import org.jboss.ejb3.annotation.SecurityDomain;

import javax.ejb.Stateless;

@Stateless
@SecurityDomain("other")
﻿public class MyBean ...
{
   ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The use of @SecurityDomain annotation lets the developer to point the
container to the name of the security domain which is configured in the
Jakarta Enterprise Beans 3 subsystem in the standalone/domain configuration. The configuration
of the security domain in the Jakarta Enterprise Beans 3 subsystem is out of the scope of this
chapter.</p>
</div>
<div class="paragraph">
<p>An alternate way of configuring a security domain, instead of using
annotation, is to use jboss-ejb3.xml deployment descriptor. Here&#8217;s an
example of how the configuration will look like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;jboss:jboss
        xmlns="http://java.sun.com/xml/ns/javaee"
        xmlns:jboss="http://www.jboss.com/xml/ns/javaee"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xmlns:s="urn:security:1.1"
         xsi:schemaLocation="http://www.jboss.com/xml/ns/javaee http://www.jboss.org/j2ee/schema/jboss-ejb3-2_0.xsd http://java.sun.com/xml/ns/javaee http://www.jboss.org/j2ee/schema/jboss-ejb3-spec-2_0.xsd"
         version="3.1" impl-version="2.0"&gt;

    &lt;assembly-descriptor&gt;
        &lt;s:security&gt;
   &lt;!-- Even wildcard * is supported --&gt;
            &lt;ejb-name&gt;MyBean&lt;/ejb-name&gt;
            &lt;!-- Name of the security domain which is configured in the EJB3 subsystem --&gt;
            &lt;s:security-domain&gt;other&lt;/s:security-domain&gt;
        &lt;/s:security&gt;
    &lt;/assembly-descriptor&gt;
&lt;/jboss:jboss&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see we use the security-domain element to configure the
security domain.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
The jboss-ejb3.xml is expected to be placed in the .jar/META-INF folder
of a .jar deployment or .war/WEB-INF folder of a .war deployment.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="absence-of-security-domain-configuration-but-presence-of-other-security-metadata"><a class="anchor" href="#absence-of-security-domain-configuration-but-presence-of-other-security-metadata"></a>9.12.2. Absence of security domain configuration but presence of other</h4>
<div class="paragraph">
<p>security metadata</p>
</div>
<div class="paragraph">
<p>Let&#8217;s consider the following example bean:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">@Stateless
public class FooBean {

 @RolesAllowed("bar")
 public void doSomething() {
  ..
 }
...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see the <code>doSomething</code> method is configured to be accessible
for users with role "bar". However, the bean isn&#8217;t configured for any
specific security domain. Prior to WildFly 14, the absence of an
explicitly configured security domain on the bean would leave the bean
unsecured, which meant that even if the <code>doSomething</code> method was
configured with <code>@RolesAllowed("bar")</code> anyone even without the "bar"
role could invoke on the bean.</p>
</div>
<div class="paragraph">
<p>In WildFly 14, the presence of any security metadata (like @RolesAllowed,
@PermitAll, @DenyAll, @RunAs, @RunAsPrincipal) on the bean or any
business method of the bean, makes the bean secure, even in the absence
of an explicitly configured security domain. In such cases, the security
domain name is default to "other". Users can explicitly configure an
security domain for the bean if they want to using either the annotation
or deployment descriptor approach explained earlier.</p>
</div>
</div>
<div class="sect3">
<h4 id="access-to-methods-without-explicit-security-metadata-on-a-secured-bean"><a class="anchor" href="#access-to-methods-without-explicit-security-metadata-on-a-secured-bean"></a>9.12.3. Access to methods without explicit security metadata, on a secured</h4>
<div class="paragraph">
<p>bean</p>
</div>
<div class="paragraph">
<p>Consider this example bean:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">@Stateless
public class FooBean {

 @RolesAllowed("bar")
 public void doSomething() {
  ..
 }


 public void helloWorld() {
  ...
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see the <code>doSomething</code> method is marked for access for only
users with role "bar". That enables security on the bean (with security
domain defaulted to "other"). However, notice that the method
<code>helloWorld</code> doesn&#8217;t have any specific security configurations.</p>
</div>
<div class="paragraph">
<p>In WildFly 14, such methods which have no explicit security
configurations, in a secured bean, will be treated similar to a method
with <code>@DenyAll</code> configuration. What that means is, no one is allowed
access to the <code>helloWorld</code> method. This behaviour can be controlled via
the jboss-ejb3.xml deployment descriptor at a per bean level or a per
deployment level as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;jboss:jboss
        xmlns="http://java.sun.com/xml/ns/javaee"
        xmlns:jboss="http://www.jboss.com/xml/ns/javaee"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xmlns:s="urn:security:1.1"
        xsi:schemaLocation="http://www.jboss.com/xml/ns/javaee http://www.jboss.org/j2ee/schema/jboss-ejb3-2_0.xsd http://java.sun.com/xml/ns/javaee http://www.jboss.org/j2ee/schema/jboss-ejb3-spec-2_0.xsd"
        version="3.1" impl-version="2.0"&gt;

    &lt;assembly-descriptor&gt;
        &lt;s:security&gt;
   &lt;!-- Even wildcard * is supported where * is equivalent to all EJBs in the deployment --&gt;
            &lt;ejb-name&gt;FooBean&lt;/ejb-name&gt;
            &lt;s:missing-method-permissions-deny-access&gt;false&lt;/s:missing-method-permissions-deny-access&gt;
        &lt;/s:security&gt;
    &lt;/assembly-descriptor&gt;
&lt;/jboss:jboss&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Notice the use of <code>&lt;missing-method-permissions-deny-access&gt;</code> element.
The value for this element can either be true or false. If this element
isn&#8217;t configured then it is equivalent to a value of true i.e. no one is
allowed access to methods, which have no explicit security
configurations, on secured beans. Setting this to false allows access to
such methods for all users i.e. the behaviour will be switched to be
similar to <code>@PermitAll</code>.</p>
</div>
<div class="paragraph">
<p>This behaviour can also be configured at the Jakarta Enterprise Beans 3 subsystem level so
that it applies to all Jakarta Enterprise Beans 3 deployments on the server, as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;subsystem xmlns="urn:jboss:domain:ejb3:1.4"&gt;
...
            &lt;default-missing-method-permissions-deny-access value="true"/&gt;
...
&lt;/subsystem&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Again, the <code>default-missing-method-permissions-deny-access</code> element
accepts either a true or false value. A value of true makes the
behaviour similar to <code>@DenyAll</code> and a value of false makes it behave
like <code>@PermitAll</code></p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="jakarta-enterprise-beans-client-interceptors"><a class="anchor" href="#jakarta-enterprise-beans-client-interceptors"></a>9.13. Jakarta Enterprise Beans Client Interceptors</h3>
<div class="sect3">
<h4 id="implementing-client-interceptors"><a class="anchor" href="#implementing-client-interceptors"></a>9.13.1. Implementing Client Interceptors</h4>
<div class="paragraph">
<p>The Jakarta Enterprise Beans client supports the notion of client side interceptors. These are interceptors
that are run before an invocation is dispatched, and can modify various properties of
the request before it is sent, as well as modifying parameters and the return value.</p>
</div>
<div class="paragraph">
<p>These interceptors are represented by the class <code>org.jboss.ejb.client.EJBClientInterceptor</code>,
and are generally registered placing interceptor class names in
<code>META-INF/services/org.jboss.ejb.client.EJBClientInterceptor</code>.</p>
</div>
<div class="paragraph">
<p>For more details about what can be modified refer to the Jakarta Enterprise Beans client JavaDoc.</p>
</div>
</div>
<div class="sect3">
<h4 id="accessing-invocation-context-data"><a class="anchor" href="#accessing-invocation-context-data"></a>9.13.2. Accessing invocation context data</h4>
<div class="paragraph">
<p>It is possible for client interceptors to access data from the invocation context context data map used in the server
invocation (i.e. <code>InvocationContext.getContextData()</code>). To access a specific key you must call
<code>org.jboss.ejb.client.EJBClientInvocationContext.addReturnedContextDataKey(String key)</code> with
the name of the key you are interested in. This method must be called from the <code>handleInvocation</code> method
of the interceptor.</p>
</div>
<div class="paragraph">
<p>If there is data in the context map under this specific key then it will be send back to the client
and will be available in the handleInvocationResult in the client invocations context data map.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="Jakarta_Enterprise_Beans_on_Kubernetes"><a class="anchor" href="#Jakarta_Enterprise_Beans_on_Kubernetes"></a>9.14. Jakarta Enterprise Beans on Kubernetes</h3>
<div class="paragraph">
<p>If the WildFly server is deployed on Kubernetes then there are several
points that you need to bear in mind when you use EJBs.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
When deploying on Kubernetes you should consider the use of the <a href="https://github.com/wildfly/wildfly-operator">WildFly Operator</a>.
      It manages the Kubernetes objects in WildFly friendly way.
      For example, it uses StatefulSet for the correct handling of EJB remoting and transaction recovery processing.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The rest of this chapter assumes the <a href="https://kubernetes.io/docs/concepts/workloads/controllers/statefulset/"><code>StatefulSet</code></a> is used
as the Kubernetes API object for managing the WildFly server.</p>
</div>
<div class="paragraph">
<p>The StatefulSet provides a guarantee of persistent storage and network hostname stability
over the restarts of the pod.</p>
</div>
<div class="paragraph">
<p>These two guarantees are particularly important for the transaction manager which is a stateful component.
The persistent storage over restarts is needed as the transaction log is usually stored at the file system.
If the transaction manager creates a transaction log record it&#8217;s created only at the transaction log particular to the WildFly instance.
The hostname stability is needed as the WildFly may be contacted via EJB remote call with transaction propagation.
The WildFly has to be reachable under the same hostname even after pod restarts.
As the transaction log is bound to the particular WildFly instance it may be finished only there.</p>
</div>
<div class="sect3">
<h4 id="ejb-calls-on-kubernetes"><a class="anchor" href="#ejb-calls-on-kubernetes"></a>9.14.1. EJB calls on Kubernetes</h4>
<div class="paragraph">
<p>The EJB caller has two options on how to configure the remote call.
It can be defined either as a remote outbound connection (see details at <a href="Admin_guide.html#outbound-connections">Admin Guide, section Outbound Connections</a>)
or you may use a direct <code>InitialContext</code> lookup in your code.</p>
</div>
<div class="paragraph">
<p>If you use either case then for the Kubernetes you need to adjust the configuration of the target node.
For the target hostname, you need to use the DNS name of the very first pod managed by <code>StatefulSet</code>.</p>
</div>
<div class="paragraph">
<p>The <code>StatefulSet</code> guarantees depend on the ordering of the pods. The pods are named in the prescribed order.
If you scale your application up to 3 replicas you may expect
your pods will have names such as <code>wildfly-server-0</code>, <code>wildfly-server-1</code>, <code>wildfly-server-2</code>.</p>
</div>
<div class="paragraph">
<p>It&#8217;s expected a <a href="https://kubernetes.io/docs/concepts/services-networking/service/#headless-services">headless services</a>
to be used along with the <code>StatefulSet</code>. With the headless service, there is ensured the DNS hostname for the pod.
If the application uses the WildFly Operator, a headless service will be created with a name such as <code>wildfly-server-headless</code>.
Then the DNS name of the very first pod will be <code>wildfly-server-0.wildfly-server-headless</code>.</p>
</div>
<div class="paragraph">
<p>The use of the hosname <code>wildfly-server-0.wildfly-server-headless</code>
guarantees that the EJB call may reach any WildFly instance connected to the cluster.
It&#8217;s a bootstrap connection which is used to initialize the EJB client
which gathers the structure of the WildFly cluster as the next step.</p>
</div>
</div>
<div class="sect3">
<h4 id="ejb-kubernetes-configuration"><a class="anchor" href="#ejb-kubernetes-configuration"></a>9.14.2. EJB configuration for Kubernetes</h4>
<div class="paragraph">
<p>These are steps you need to process in order to run EJB remote calls.
Some steps are related to the server configuration, the other ones
on your application.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The clustering has to be set correctly, see the <a href="High_Availability_Guide.html#discovery-for-kubernetes">High Availability Guide, section of Kubernetes discovery</a>.</p>
</li>
<li>
<p>All the <code>socket-binding</code> must define the client mapping for the DNS value mapped by <code>StatefulSet</code> headless service.
For example if the application is named <code>wildfly-server</code> and the <code>StatefulSet</code> headless service is named <code>wildfly-server-headless</code>
then the <code>http</code> socket binding has to be defined in the following way:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;socket-binding name="http" port="${jboss.http.port:8080}"&gt;
   &lt;client-mapping destination-address="${jboss.node.name}.wildfly-server-headless"/&gt;
&lt;/socket-binding&gt;</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>A small workaround is needed for the remote EJB transaction recovery on Kubernetes
(the issue could be tracked at <a href="https://issues.redhat.com/browse/WFCORE-4668">WFCORE-4668</a>).
The WildFly application server has to be configured with property <code>wildfly.config.url</code>.
The <code>wildfly.config.url</code> points to a XML configuration file. If we consider one being placed at <code>$JBOSS_HOME/standalone/configuration/wildfly-config.xml</code>
then the property is setup as <code>JAVA_OPTS="$JAVA_OPTS -Dwildfly.config.url=$JBOSS_HOME/standalone/configuration/wildfly-config.xml"</code>.
The <code>wildfly-config.xml</code> defines the EJB recovery authentication to be used during transaction recovery for remote EJB calls.
The target server has to configure a user that is permitted to receive the EJB remote calls.
Such a user is then configured by standard means of <a href="Admin_Guide.html#application-realm">security configuration</a>.
Let’s say there is configured a user on the target server.
The user is created with script <code>$JBOSS_HOME/bin/add-user.sh</code> under the <code>ApplicationRealm</code>.
Then the caller WildFly uses the configuration in <code>wildfly-config.xml</code> this way
(you may copy the content below, but replace the <code>&gt;&gt;PASTE_&#8230;&#8203;_HERE&lt;&lt;</code> with user and password you configured):</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;configuration&gt;
  &lt;authentication-client xmlns="urn:elytron:1.0"&gt;
  &lt;authentication-rules&gt;
          &lt;rule use-configuration="jta"&gt;
              &lt;match-abstract-type name="jta" authority="jboss"/&gt;
      &lt;/rule&gt;
      &lt;/authentication-rules&gt;
      &lt;authentication-configurations&gt;
       &lt;configuration name="jta"&gt;
               &lt;sasl-mechanism-selector selector="DIGEST-MD5"/&gt;
               &lt;providers&gt;
                   &lt;use-service-loader /&gt;
           &lt;/providers&gt;
       &lt;set-user-name name="&gt;&gt;PASTE_USER_NAME_HERE&lt;&lt;"/&gt;
           &lt;credentials&gt;
                    &lt;clear-password password="&gt;&gt;PASTE_PASSWORD_HERE&lt;&lt;"/&gt;
           &lt;/credentials&gt;
               &lt;set-mechanism-realm name="ApplicationRealm" /&gt;
           &lt;/configuration&gt;
      &lt;/authentication-configurations&gt;
  &lt;/authentication-client&gt;
&lt;/configuration&gt;</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
References in this document to Enterprise JavaBeans(EJB) refer to the Jakarta Enterprise Beans unless otherwise noted.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="Jakarta_Enterprise_Beans_Deployment_Runtime_Resources"><a class="anchor" href="#Jakarta_Enterprise_Beans_Deployment_Runtime_Resources"></a>9.15. Jakarta Enterprise Beans Deployment Runtime Resources</h3>
<div class="paragraph">
<p>Enterprise bean deployment exposes certain management runtime resources to help users inspect enterprise bean metadata
and monitor invocation statistics. Bean metadata is configured in the application via deployment descriptor and
annotations. Stateless, stateful, singleton session beans and message-driven beans support a common set of resources,
and also resources specific to the bean type. For example, these are some of the common enterprise bean resources:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>jndi-names</p>
</li>
<li>
<p>component-class-name</p>
</li>
<li>
<p>declared-roles</p>
</li>
<li>
<p>transaction-type</p>
</li>
<li>
<p>stateful-timeout</p>
</li>
<li>
<p>activation-config</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Users can view these enterprise bean resources via WildFly CLI or Administration Console. The following sections
provides sample CLI and Administration Console output for each enterprise bean type. For complete details, refer to
<a href="https://wildscribe.github.io/">WildFly Model Reference Documentation</a></p>
</div>
<div class="sect3">
<h4 id="Stateless_Session_Bean_Runtime_Resources"><a class="anchor" href="#Stateless_Session_Bean_Runtime_Resources"></a>9.15.1. Stateless Session Bean Runtime Resources</h4>
<div class="paragraph">
<p>To view the management runtime resources for a deployed stateless session bean in CLI, run the following CLI command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code>/deployment=&lt;DEPLOYMENT-NAME&gt;/subsystem=ejb3/stateless-session-bean=&lt;BEAN-NAME&gt;:read-resource(include-runtime)</code></pre>
</div>
</div>
<div class="paragraph">
<p>The following is a sample output for a stateless session bean named <code>ManagedStatelessBean</code> in deployment <code>ejb-management.jar</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code>/deployment=ejb-management.jar/subsystem=ejb3/stateless-session-bean=ManagedStatelessBean:read-resource(include-runtime)
{
    "outcome" =&gt; "success",
    "result" =&gt; {
        "async-methods" =&gt; ["void async(int, int)"],
        "business-local" =&gt; ["sample.ManagedStatelessBean"],
        "business-remote" =&gt; ["sample.BusinessInterface"],
        "component-class-name" =&gt; "sample.ManagedStatelessBean",
        "declared-roles" =&gt; [
            "Role3",
            "Role2",
            "Role1"
        ],
        "execution-time" =&gt; 160L,
        "invocations" =&gt; 3L,
        "jndi-names" =&gt; [
            "java:global/ejb-management/ManagedStatelessBean!sample.BusinessInterface",
            "java:module/ManagedStatelessBean!sample.BusinessInterface",
            "java:app/ejb-management/ManagedStatelessBean!sample.BusinessInterface",
            "java:global/ejb-management/ManagedStatelessBean!sample.ManagedStatelessBean",
            "java:module/ManagedStatelessBean!sample.ManagedStatelessBean",
            "java:app/ejb-management/ManagedStatelessBean!sample.ManagedStatelessBean"
        ],
        "methods" =&gt; {"doIt" =&gt; {
            "execution-time" =&gt; 160L,
            "invocations" =&gt; 3L,
            "wait-time" =&gt; 10L
        }},
        "peak-concurrent-invocations" =&gt; 1L,
        "pool-available-count" =&gt; 64,
        "pool-create-count" =&gt; 1,
        "pool-current-size" =&gt; 1,
        "pool-max-size" =&gt; 64,
        "pool-name" =&gt; "slsb-strict-max-pool",
        "pool-remove-count" =&gt; 0,
        "run-as-role" =&gt; "Role3",
        "security-domain" =&gt; "other",
        "timeout-method" =&gt; "public void sample.ManagedStatelessBean.timeout(javax.ejb.Timer)",
        "timers" =&gt; [{
            "time-remaining" =&gt; 4735224L,
            "next-timeout" =&gt; 1577768415000L,
            "calendar-timer" =&gt; true,
            "persistent" =&gt; false,
            "info" =&gt; "timer1",
            "schedule" =&gt; {
                "year" =&gt; "*",
                "month" =&gt; "*",
                "day-of-month" =&gt; "*",
                "day-of-week" =&gt; "*",
                "hour" =&gt; "0",
                "minute" =&gt; "0",
                "second" =&gt; "15",
                "timezone" =&gt; undefined,
                "start" =&gt; undefined,
                "end" =&gt; undefined
            }
        }],
        "transaction-type" =&gt; "CONTAINER",
        "wait-time" =&gt; 10L,
        "service" =&gt; {"timer-service" =&gt; undefined}
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>To view it in WildFly Administration Console, go to the <code>Management Model</code> section of the target deployment. For example,</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="_images/ejb/stateless-management-resource.png" alt="images/ejb/stateless-management-resource.png"></span></p>
</div>
</div>
<div class="sect3">
<h4 id="Stateful_Session_Bean_Runtime_Resources"><a class="anchor" href="#Stateful_Session_Bean_Runtime_Resources"></a>9.15.2. Stateful Session Bean Runtime Resources</h4>
<div class="paragraph">
<p>To view the management runtime resources for a deployed stateful session bean in CLI, run the following CLI command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code>/deployment=&lt;DEPLOYMENT-NAME&gt;/subsystem=ejb3/stateful-session-bean=&lt;BEAN-NAME&gt;:read-resource(include-runtime)</code></pre>
</div>
</div>
<div class="paragraph">
<p>The following is a sample output for a stateful session bean named <code>ManagedStatefulBean2</code> in deployment <code>ejb-management.jar</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code>/deployment=ejb-management.jar/subsystem=ejb3/stateful-session-bean=ManagedStatefulBean2:read-resource(include-runtime)
{
    "outcome" =&gt; "success",
    "result" =&gt; {
        "after-begin-method" =&gt; "private void sample.ManagedStatefulBean2.afterBegin()",
        "after-completion-method" =&gt; "private void sample.ManagedStatefulBean2.afterCompletion()",
        "async-methods" =&gt; ["void async(int, int)"],
        "before-completion-method" =&gt; "private void sample.ManagedStatefulBean2.beforeCompletion()",
        "business-local" =&gt; ["sample.ManagedStatefulBean2"],
        "business-remote" =&gt; ["sample.BusinessInterface"],
        "cache-size" =&gt; 0,
        "component-class-name" =&gt; "sample.ManagedStatefulBean2",
        "declared-roles" =&gt; [
            "Role3",
            "Role2",
            "Role1"
        ],
        "execution-time" =&gt; 163L,
        "invocations" =&gt; 4L,
        "jndi-names" =&gt; [
            "java:app/ejb-management/ManagedStatefulBean2!sample.BusinessInterface",
            "java:global/ejb-management/ManagedStatefulBean2!sample.BusinessInterface",
            "java:module/ManagedStatefulBean2!sample.BusinessInterface",
            "java:app/ejb-management/ManagedStatefulBean2!sample.ManagedStatefulBean2",
            "java:global/ejb-management/ManagedStatefulBean2!sample.ManagedStatefulBean2",
            "java:module/ManagedStatefulBean2!sample.ManagedStatefulBean2"
        ],
        "methods" =&gt; {
            "doIt" =&gt; {
                "execution-time" =&gt; 163L,
                "invocations" =&gt; 3L,
                "wait-time" =&gt; 3L
            },
            "remove" =&gt; {
                "execution-time" =&gt; 0L,
                "invocations" =&gt; 1L,
                "wait-time" =&gt; 1L
            }
        },
        "passivated-count" =&gt; 0,
        "passivation-capable" =&gt; false,
        "peak-concurrent-invocations" =&gt; 1L,
        "remove-methods" =&gt; [
            {
                "bean-method" =&gt; "void remove()",
                "retain-if-exception" =&gt; false
            },
            {
                "bean-method" =&gt; "void removeTrue()",
                "retain-if-exception" =&gt; true
            },
            {
                "bean-method" =&gt; "void removeFalse()",
                "retain-if-exception" =&gt; false
            }
        ],
        "run-as-role" =&gt; "Role3",
        "security-domain" =&gt; "other",
        "stateful-timeout" =&gt; "2 HOURS",
        "total-size" =&gt; 0,
        "transaction-type" =&gt; "BEAN",
        "wait-time" =&gt; 4L,
        "service" =&gt; undefined
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>To view it in WildFly Administration Console, go to the <code>Management Model</code> section of the target deployment. For example,</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="_images/ejb/stateful-management-resource.png" alt="images/ejb/stateful-management-resource.png"></span></p>
</div>
</div>
<div class="sect3">
<h4 id="Singleton_Bean_Runtime_Resources"><a class="anchor" href="#Singleton_Bean_Runtime_Resources"></a>9.15.3. Singleton Bean Runtime Resources</h4>
<div class="paragraph">
<p>To view the management runtime resources for a deployed singleton bean in CLI, run the following CLI command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code>/deployment=&lt;DEPLOYMENT-NAME&gt;/subsystem=ejb3/singleton-bean=&lt;BEAN-NAME&gt;:read-resource(include-runtime)</code></pre>
</div>
</div>
<div class="paragraph">
<p>The following is a sample output for a singleton bean named <code>ManagedSingletonBean</code> in deployment <code>ejb-management.jar</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code>/deployment=ejb-management.jar/subsystem=ejb3/singleton-bean=ManagedSingletonBean:read-resource(include-runtime)
{
    "outcome" =&gt; "success",
    "result" =&gt; {
        "async-methods" =&gt; ["void async(int, int)"],
        "business-local" =&gt; ["sample.ManagedSingletonBean"],
        "business-remote" =&gt; ["sample.BusinessInterface"],
        "component-class-name" =&gt; "sample.ManagedSingletonBean",
        "concurrency-management-type" =&gt; undefined,
        "declared-roles" =&gt; [
            "Role3",
            "Role2",
            "Role1"
        ],
        "depends-on" =&gt; undefined,
        "execution-time" =&gt; 156L,
        "init-on-startup" =&gt; false,
        "invocations" =&gt; 3L,
        "jndi-names" =&gt; [
            "java:module/ManagedSingletonBean!sample.ManagedSingletonBean",
            "java:global/ejb-management/ManagedSingletonBean!sample.ManagedSingletonBean",
            "java:app/ejb-management/ManagedSingletonBean!sample.ManagedSingletonBean",
            "java:app/ejb-management/ManagedSingletonBean!sample.BusinessInterface",
            "java:global/ejb-management/ManagedSingletonBean!sample.BusinessInterface",
            "java:module/ManagedSingletonBean!sample.BusinessInterface"
        ],
        "methods" =&gt; {"doIt" =&gt; {
            "execution-time" =&gt; 156L,
            "invocations" =&gt; 3L,
            "wait-time" =&gt; 0L
        }},
        "peak-concurrent-invocations" =&gt; 1L,
        "run-as-role" =&gt; "Role3",
        "security-domain" =&gt; "other",
        "timeout-method" =&gt; "public void sample.ManagedSingletonBean.timeout(javax.ejb.Timer)",
        "timers" =&gt; [{
            "time-remaining" =&gt; 4304279L,
            "next-timeout" =&gt; 1577768415000L,
            "calendar-timer" =&gt; true,
            "persistent" =&gt; false,
            "info" =&gt; "timer1",
            "schedule" =&gt; {
                "year" =&gt; "*",
                "month" =&gt; "*",
                "day-of-month" =&gt; "*",
                "day-of-week" =&gt; "*",
                "hour" =&gt; "0",
                "minute" =&gt; "0",
                "second" =&gt; "15",
                "timezone" =&gt; undefined,
                "start" =&gt; undefined,
                "end" =&gt; undefined
            }
        }],
        "transaction-type" =&gt; "CONTAINER",
        "wait-time" =&gt; 0L,
        "service" =&gt; {"timer-service" =&gt; undefined}
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>To view it in WildFly Administration Console, go to the <code>Management Model</code> section of the target deployment. For example,</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="_images/ejb/singleton-management-resource.png" alt="images/ejb/singleton-management-resource.png"></span></p>
</div>
</div>
<div class="sect3">
<h4 id="Message_Driven_Bean_Runtime_Resources"><a class="anchor" href="#Message_Driven_Bean_Runtime_Resources"></a>9.15.4. Message-driven Bean Runtime Resources</h4>
<div class="paragraph">
<p>To view the management runtime resources for a deployed message-driven bean in CLI, run the following CLI command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code>/deployment=&lt;DEPLOYMENT-NAME&gt;/subsystem=ejb3/message-driven-bean=&lt;BEAN-NAME&gt;:read-resource(include-runtime)</code></pre>
</div>
</div>
<div class="paragraph">
<p>The following is a sample output for a message-driven bean named <code>ManagedMDB</code> in deployment <code>ejb-management.jar</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code>/deployment=ejb-management.jar/subsystem=ejb3/message-driven-bean=ManagedMDB:read-resource(include-runtime)
{
    "outcome" =&gt; "success",
    "result" =&gt; {
        "activation-config" =&gt; [
            ("destinationType" =&gt; "javax.jms.Queue"),
            ("destination" =&gt; "java:/queue/ManagedMDB-queue")
        ],
        "component-class-name" =&gt; "sample.ManagedMDB",
        "declared-roles" =&gt; [
            "Role3",
            "Role2",
            "Role1"
        ],
        "delivery-active" =&gt; true,
        "execution-time" =&gt; 0L,
        "invocations" =&gt; 0L,
        "message-destination-link" =&gt; undefined,
        "message-destination-type" =&gt; undefined,
        "messaging-type" =&gt; "javax.jms.MessageListener",
        "methods" =&gt; {},
        "peak-concurrent-invocations" =&gt; 0L,
        "pool-available-count" =&gt; 16,
        "pool-create-count" =&gt; 0,
        "pool-current-size" =&gt; 0,
        "pool-max-size" =&gt; 16,
        "pool-name" =&gt; "mdb-strict-max-pool",
        "pool-remove-count" =&gt; 0,
        "run-as-role" =&gt; "Role3",
        "security-domain" =&gt; "other",
        "timeout-method" =&gt; "public void sample.ManagedMDB.timeout(javax.ejb.Timer)",
        "timers" =&gt; [{
            "time-remaining" =&gt; 4213581L,
            "next-timeout" =&gt; 1577768415000L,
            "calendar-timer" =&gt; true,
            "persistent" =&gt; false,
            "info" =&gt; "timer1",
            "schedule" =&gt; {
                "year" =&gt; "*",
                "month" =&gt; "*",
                "day-of-month" =&gt; "*",
                "day-of-week" =&gt; "*",
                "hour" =&gt; "0",
                "minute" =&gt; "0",
                "second" =&gt; "15",
                "timezone" =&gt; undefined,
                "start" =&gt; undefined,
                "end" =&gt; undefined
            }
        }],
        "transaction-type" =&gt; "CONTAINER",
        "wait-time" =&gt; 0L,
        "service" =&gt; {"timer-service" =&gt; undefined}
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>To view it in WildFly Administration Console, go to the <code>Management Model</code> section of the target deployment. For example,</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="_images/ejb/mdb-management-resource.png" alt="images/ejb/mdb-management-resource.png"></span></p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="JPA_Reference_Guide"><a class="anchor" href="#JPA_Reference_Guide"></a>10. JPA Reference Guide</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="introduction"><a class="anchor" href="#introduction"></a>10.1. Introduction</h3>
<div class="paragraph">
<p>The WildFly JPA subsystem implements the JPA 2.2 container-managed
requirements. Deploys the persistence unit definitions, the persistence
unit/context annotations and persistence unit/context references in the
deployment descriptor. JPA Applications use the Hibernate (version 5.3)
persistence provider, which is included with WildFly. The JPA subsystem
uses the standard SPI (javax.persistence.spi.PersistenceProvider) to
access the Hibernate persistence provider and some additional extensions
as well.</p>
</div>
<div class="paragraph">
<p>During application deployment, JPA use is detected (e.g. persistence.xml
or @PersistenceContext/Unit annotations) and injects Hibernate
dependencies into the application deployment. This makes it easy to
deploy JPA applications.</p>
</div>
<div class="paragraph">
<p>In the remainder of this documentation, "entity manager" refers to an
instance of the <em>javax.persistence.EntityManager</em> class.
<a href="https://javaee.github.io/javaee-spec/javadocs/overview-summary.html">Javadoc
for the JPA interfaces</a>and <a href="https://jcp.org/en/jsr/detail?id=338">JPA 2.2
specification</a>.</p>
</div>
<div class="paragraph">
<p>The index of the Hibernate documentation is at
<a href="http://hibernate.org/orm/documentation/5.3/" class="bare">http://hibernate.org/orm/documentation/5.3/</a></p>
</div>
</div>
<div class="sect2">
<h3 id="update-your-persistence.xml-for-hibernate"><a class="anchor" href="#update-your-persistence.xml-for-hibernate"></a>10.2. Update your Persistence.xml for Hibernate</h3>
<div class="paragraph">
<p>The persistence provider class name in Hibernate is
<strong>org.hibernate.jpa.HibernatePersistenceProvider</strong>.</p>
</div>
<div class="paragraph">
<p>Your persistence.xml can specify:</p>
</div>
<div class="paragraph">
<p><strong>&lt;provider&gt;org.hibernate.jpa.HibernatePersistenceProvider&lt;/provider&gt;</strong></p>
</div>
<div class="paragraph">
<p>Or remove the persistence provider class name from your persistence.xml
(so the default provider will be used).</p>
</div>
</div>
<div class="sect2">
<h3 id="entity-manager"><a class="anchor" href="#entity-manager"></a>10.3. Entity manager</h3>
<div class="paragraph">
<p>The entity manager (javax.persistence.EntityManager class) is similar to
the Hibernate Session class; applications use it to
create/read/update/delete data (and related operations). Applications
can use application-managed or container-managed entity managers. Keep
in mind that the entity manager is not thread safe, don&#8217;t share the same
entity manager instance with multiple threads.</p>
</div>
<div class="paragraph">
<p>Internally, the entity manager, has a persistence context for managing
entities. You can think of the persistence context as being closely
associated with the entity manager.</p>
</div>
</div>
<div class="sect2">
<h3 id="container-managed-entity-manager"><a class="anchor" href="#container-managed-entity-manager"></a>10.4. Container-managed entity manager</h3>
<div class="paragraph">
<p>When you inject a container-managed entity managers into an application
variable, it is treated like an (EE container controlled) Java proxy
object, that will be associated with an underlying EntityManager
instance, for each started JTA transaction and is flushed/closed when
the JTA transaction commits. Such that when your application code
invokes EntityManager.anyMethod(), the current JTA transaction is
searched (using persistence unit name as key) for the underlying
EntityManager instance, if not found, a new EntityManager instance is
created and associated with the current JTA transaction, to be reused
for the next EntityManager invocation. Use the @PersistenceContext
annotation, to inject a container-managed entity manager into a
javax.persistence.EntityManager variable.</p>
</div>
</div>
<div class="sect2">
<h3 id="application-managed-entity-manager"><a class="anchor" href="#application-managed-entity-manager"></a>10.5. Application-managed entity manager</h3>
<div class="paragraph">
<p>An application-managed entity manager is kept around until the
application closes it. The scope of the application-managed entity
manager is from when the application creates it and lasts until the
application closes it. Use the <em>@PersistenceUnit</em> annotation, to inject
a persistence unit into a <em>javax.persistence.EntityManagerFactory
variable</em>. The EntityManagerFactory can return an application-managed
entity manager.</p>
</div>
</div>
<div class="sect2">
<h3 id="persistence-context"><a class="anchor" href="#persistence-context"></a>10.6. Persistence Context</h3>
<div class="paragraph">
<p>The JPA persistence context contains the entities managed by the entity
manager (via the JPA persistence provider). The underlying entity
manager maintains the persistence context. The persistence context acts
like a first level (transactional) cache for interacting with the
datasource. Loaded entities are placed into the persistence context
before being returned to the application. Entities changes are also
placed into the persistence context (to be saved in the database when
the transaction commits).</p>
</div>
</div>
<div class="sect2">
<h3 id="transaction-scoped-persistence-context"><a class="anchor" href="#transaction-scoped-persistence-context"></a>10.7. Transaction-scoped Persistence Context</h3>
<div class="paragraph">
<p>The transaction-scoped persistence context coordinates with the (active)
JTA transaction. When the transaction commits, the persistence context
is flushed to the datasource (entity objects are detached but may still
be referenced by application code). All entity changes that are expected
to be saved to the datasource, must be made during a transaction.
Entities read outside of a transaction will be detached when the entity
manager invocation completes. Example transaction-scoped persistence
context is below.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">@Stateful  // will use container managed transactions
public class CustomerManager {
  @PersistenceContext(unitName = "customerPU") // default type is PersistenceContextType.TRANSACTION
  EntityManager em;
  public customer createCustomer(String name, String address) {
    Customer customer = new Customer(name, address);
    em.persist(customer);  // persist new Customer when JTA transaction completes (when method ends).
                           // internally:
                           //    1. Look for existing "customerPU" persistence context in active JTA transaction and use if found.
                           //    2. Else create new "customerPU" persistence context (e.g. instance of org.hibernate.ejb.HibernatePersistence)
                           //       and put in current active JTA transaction.
    return customer;       // return Customer entity (will be detached from the persistence context when caller gets control)
  }  // Transaction.commit will be called, Customer entity will be persisted to the database and "customerPU" persistence context closed</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="extended-persistence-context"><a class="anchor" href="#extended-persistence-context"></a>10.8. Extended Persistence Context</h3>
<div class="paragraph">
<p>The (ee container managed) extended persistence context can span
multiple transactions and allows data modifications to be queued up
(without an active JTA transaction), to be applied
during completion of next JTA transaction. The Container-managed extended persistence
context can only be injected into a stateful session bean.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">@PersistenceContext(type = PersistenceContextType.EXTENDED, unitName = "inventoryPU")
EntityManager em;</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="extended-persistence-context-inheritance"><a class="anchor" href="#extended-persistence-context-inheritance"></a>10.8.1. Extended Persistence Context Inheritance</h4>
<div class="listingblock">
<div class="content">
<pre>JPA 2.2 specification section 7.6.3.1

If a stateful session bean instantiates a stateful session bean (executing in the same EJB container instance) which also has such an extended persistence context with the same synchronization type, the extended persistence context of the first stateful session bean is inherited by the second stateful session bean and bound to it, and this rule recursively applies independently of whether transactions are active or not at the point of the creation of the stateful session beans. If the stateful session beans differ in declared synchronization type, the EJBException is thrown by the container.  If the persistence context has been inherited by any stateful session beans, the container does not close the persistence context until all such stateful session beans have been removed or otherwise destroyed.</pre>
</div>
</div>
<div class="paragraph">
<p>By default, the current stateful session bean being created, will (
<strong>deeply</strong>) inherit the extended persistence context from any stateful
session bean executing in the current Java thread. The <strong>deep</strong>
inheritance of extended persistence context includes walking multiple
levels up the stateful bean call stack (inheriting from parent beans).
The <strong>deep</strong> inheritance of extended persistence context includes sibling
beans. For example, parentA references child beans beanBwithXPC &amp;
beanCwithXPC. Even though parentA doesn&#8217;t have an extended persistence
context, beanBwithXPC &amp; beanCwithXPC will share the same extended
persistence context.</p>
</div>
<div class="paragraph">
<p>Some other EE application servers, use <strong>shallow</strong> inheritance, where
stateful session bean only inherit from the parent stateful session bean
(if there is a parent bean). Sibling beans do not share the same
extended persistence context unless their (common) parent bean also has
the same extended persistence context.</p>
</div>
<div class="paragraph">
<p>Applications can include a (top-level) <strong>jboss-all.xml</strong> deployment
descriptor that specifies either the (default) <strong>DEEP</strong> extended
persistence context inheritance or <strong>SHALLOW</strong>.</p>
</div>
<div class="paragraph">
<p>The WF/docs/schema/jboss-jpa_1_0.xsd describes the <strong>jboss-jpa</strong>
deployment descriptor that may be included in the <strong>jboss-all.xml</strong>. Below
is an example of using <strong>SHALLOW</strong> extended persistence context
inheritance:</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>&lt;jboss&gt;<br>
&lt;jboss-jpa xmlns="http://www.jboss.com/xml/ns/javaee"&gt;<br>
&lt;extended-persistence inheritance="SHALLOW"/&gt;<br>
&lt;/jboss-jpa&gt;<br>
&lt;/jboss&gt;</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>Below is an example of using <strong>DEEP</strong> extended persistence inheritance:</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>&lt;jboss&gt;<br>
&lt;jboss-jpa xmlns="http://www.jboss.com/xml/ns/javaee"&gt;<br>
&lt;extended-persistence inheritance="DEEP"/&gt;<br>
&lt;/jboss-jpa&gt;<br>
&lt;/jboss&gt;</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>The AS console/cli can change the <strong>default</strong> extended persistence context
setting (DEEP or SHALLOW). The following cli commands will read the
current JPA settings and enable SHALLOW extended persistence context
inheritance for applications that do not include the <strong>jboss-jpa</strong>
deployment descriptor:</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<div class="title">/jboss-cli.sh<br></div>
<p>cd subsystem=jpa<br>
:read-resource<br>
:write-attribute(name=default-extended-persistence-inheritance,value="SHALLOW")</p>
</div>
</blockquote>
</div>
</div>
</div>
<div class="sect2">
<h3 id="entities"><a class="anchor" href="#entities"></a>10.9. Entities</h3>
<div class="paragraph">
<p>JPA allows use of your (pojo) plain old Java class to represent a
database table row.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">@PersistenceContext EntityManager em;
Integer bomPk = getIndexKeyValue();
BillOfMaterials bom = em.find(BillOfMaterials.class, bomPk); // read existing table row into BillOfMaterials class

BillOfMaterials createdBom = new BillOfMaterials("...");     // create new entity
em.persist(createdBom);  // createdBom is now managed and will be saved to database when the current JTA transaction completes</code></pre>
</div>
</div>
<div class="paragraph">
<p>The entity lifecycle is managed by the underlying persistence provider.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>New (transient): an entity is new if it has just been instantiated
using the new operator, and it is not associated with a persistence
context. It has no persistent representation in the database and no
identifier value has been assigned.</p>
</li>
<li>
<p>Managed (persistent): a managed entity instance is an instance with a
persistent identity that is currently associated with a persistence
context.</p>
</li>
<li>
<p>Detached: the entity instance is an instance with a persistent
identity that is no longer associated with a persistence context,
usually because the persistence context was closed or the instance was
evicted from the context.</p>
</li>
<li>
<p>Removed: a removed entity instance is an instance with a persistent
identity, associated with a persistence context, but scheduled for
removal from the database.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="deployment"><a class="anchor" href="#deployment"></a>10.10. Deployment</h3>
<div class="paragraph">
<p>The persistence.xml contains the persistence unit configuration (e.g.
datasource name) and as described in the JPA 2.0 spec (section 8.2), the
jar file or directory whose META-INF directory contains the
persistence.xml file is termed the root of the persistence unit. In Java
EE environments, the root of a persistence unit must be one of the
following (quoted directly from the JPA 2.0 specification):</p>
</div>
<div class="paragraph">
<p>"</p>
</div>
<div class="ulist">
<ul>
<li>
<p>an EJB-JAR file</p>
</li>
<li>
<p>the WEB-INF/classes directory of a WAR file</p>
</li>
<li>
<p>a jar file in the WEB-INF/lib directory of a WAR file</p>
</li>
<li>
<p>a jar file in the EAR library directory</p>
</li>
<li>
<p>an application client jar file</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The persistence.xml can specify either a JTA datasource or a non-JTA
datasource. The JTA datasource is expected to be used within the EE
environment (even when reading data without an active transaction). If a
datasource is not specified, the default-datasource will instead be used
(must be configured).</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Java Persistence 1.0 supported use of a jar file in the root of
the EAR as the root of a persistence unit. This use is no longer
supported. Portable applications should use the EAR library directory
for this case instead.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>"</p>
</div>
<div class="paragraph">
<p>Question: Can you have a EAR/META-INF/persistence.xml?</p>
</div>
<div class="paragraph">
<p>Answer: No, the above may deploy but it could include other archives
also in the EAR, so you may have deployment issues for other reasons.
Better to put the persistence.xml in an EAR/lib/somePuJar.jar.</p>
</div>
</div>
<div class="sect2">
<h3 id="troubleshooting"><a class="anchor" href="#troubleshooting"></a>10.11. Troubleshooting</h3>
<div class="paragraph">
<p>The <strong>org.jboss.as.jpa</strong> logging can be enabled to get the following
information:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>INFO - when persistence.xml has been parsed, starting of persistence
unit service (per deployed persistence.xml), stopping of persistence
unit service</p>
</li>
<li>
<p>DEBUG - informs about entity managers being injected, creating/reusing
transaction scoped entity manager for active transaction</p>
</li>
<li>
<p>TRACE - shows how long each entity manager operation took in
milliseconds, application searches for a persistence unit, parsing of
persistence.xml</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>To enable TRACE, open the as/standalone/configuration/standalone.xml (or
as/domain/configuration/domain.xml) file. Search for <strong>&lt;subsystem
xmlns="urn:jboss:domain:logging:1.0"&gt;</strong> and add the <strong>org.jboss.as.jpa</strong>
category. You need to change the console-handler level from <strong>INFO</strong> to
<strong>TRACE</strong>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">&lt;subsystem xmlns="urn:jboss:domain:logging:1.0"&gt;
     &lt;console-handler name="CONSOLE"&gt;
      &lt;level name="TRACE" /&gt;
      ...
     &lt;/console-handler&gt;

     &lt;/periodic-rotating-file-handler&gt;
     &lt;logger category="com.arjuna"&gt;
        &lt;level name="WARN" /&gt;
     &lt;/logger&gt;

     &lt;logger category="org.jboss.as.jpa"&gt;
        &lt;level name="TRACE" /&gt;
     &lt;/logger&gt;

     &lt;logger category="org.apache.tomcat.util.modeler"&gt;
        &lt;level name="WARN" /&gt;
     &lt;/logger&gt;
     ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>To see what is going on at the JDBC level, enable <strong>jboss.jdbc.spy</strong> TRACE
and add spy="true" to the datasource.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">&lt;datasource jndi-name="java:jboss/datasources/..." pool-name="..." enabled="true" spy="true"&gt;
&lt;logger category="jboss.jdbc.spy"&gt;
  &lt;level name="TRACE"/&gt;
&lt;/logger&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>To troubleshoot issues with the Hibernate second level cache, try
enabling trace for <strong>org.hibernate.SQL + org.hibernate.cache.infinispan<br>
org.infinispan:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">&lt;subsystem xmlns="urn:jboss:domain:logging:1.0"&gt;
     &lt;console-handler name="CONSOLE"&gt;
      &lt;level name="TRACE" /&gt;
      ...
     &lt;/console-handler&gt;

     &lt;/periodic-rotating-file-handler&gt;
     &lt;logger category="com.arjuna"&gt;
        &lt;level name="WARN" /&gt;
     &lt;/logger&gt;

     &lt;logger category="org.hibernate.SQL"&gt;
        &lt;level name="TRACE" /&gt;
     &lt;/logger&gt;

     &lt;logger category="org.hibernate"&gt;
        &lt;level name="TRACE" /&gt;
     &lt;/logger&gt;
      &lt;logger category="org.infinispan"&gt;
        &lt;level name="TRACE" /&gt;
     &lt;/logger&gt;

     &lt;logger category="org.apache.tomcat.util.modeler"&gt;
        &lt;level name="WARN" /&gt;
     &lt;/logger&gt;
     ...</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="using-the-infinispan-second-level-cache"><a class="anchor" href="#using-the-infinispan-second-level-cache"></a>10.12. Using the Infinispan second level cache</h3>
<div class="paragraph">
<p>To enable the second level cache with Hibernate, just set the
<strong>hibernate.cache.use_second_level_cache</strong> property to true or
set <strong>shared-cache-mode</strong> to one of the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>ENABLE_SELECTIVE</p>
</li>
<li>
<p>DISABLE_SELECTIVE</p>
</li>
<li>
<p>ALL</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Infinispan is the cache provider for <strong>JPA applications</strong>, so you don&#8217;t need to specify
anything in addition. The Infinispan version that is included in
WildFly is expected to work with the Hibernate version that is included
with WildFly. Example persistence.xml settings:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;?xml version="1.0" encoding="UTF-8"?&gt;&lt;persistence xmlns="http://java.sun.com/xml/ns/persistence" version="1.0"&gt;
&lt;persistence-unit name="2lc_example_pu"&gt;
   &lt;description&gt;example of enabling the second level cache.&lt;/description&gt;
   &lt;jta-data-source&gt;java:jboss/datasources/mydatasource&lt;/jta-data-source&gt;
   &lt;shared-cache-mode&gt;ENABLE_SELECTIVE&lt;/shared-cache-mode&gt;
&lt;/persistence-unit&gt;
&lt;/persistence&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Here is an example of enabling the second level cache for a Hibernate
native API hibernate.cfg.xml file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;property name="hibernate.cache.region.factory_class" value="org.infinispan.hibernate.cache.v53.InfinispanRegionFactory"/&gt;
&lt;property name="hibernate.cache.infinispan.shared" value="false"/&gt;
&lt;property name="hibernate.cache.use_second_level_cache" value="true"/&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The Hibernate native API application will also need a MANIFEST.MF:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>Dependencies: org.infinispan,org.hibernate</pre>
</div>
</div>
<div class="paragraph">
<p><a href="http://infinispan.org/docs/9.4.x/user_guide/user_guide.html#integrations_jpa_hibernate">Infinispan
Hibernate/JPA second level cache provider documentation</a> contains
advanced configuration information but you should bear in mind that when
Hibernate runs within WildFly 14, some of those configuration options,
such as region factory, are not needed. Moreover, the application server
providers you with option of selecting a different cache container for
Infinispan via <strong>hibernate.cache.infinispan.container</strong> persistence
property. To reiterate, this property is not mandatory and a default
container is already deployed for by the application server to host the
second level cache.</p>
</div>
<div class="paragraph">
<p>Here is an example of what the Hibernate cache settings may currently be
in your standalone.xml:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml"> &lt;cache-container name="hibernate" module="org.infinispan.hibernate-cache"&gt;
     &lt;local-cache name="entity"&gt;
         &lt;transaction mode="NON_XA"/&gt;
         &lt;object-memory size="10000"/&gt;
         &lt;expiration max-idle="100000"/&gt;
     &lt;/local-cache&gt;
     &lt;local-cache name="local-query"&gt;
         &lt;object-memory size="10000"/&gt;
         &lt;expiration max-idle="100000"/&gt;
     &lt;/local-cache&gt;
     &lt;local-cache name="timestamps"/&gt;
 &lt;/cache-container&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Below is an example of customizing the "entity", "immutable-entity",
"local-query", "pending-puts", "timestamps" cache configuration may look
like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml"> &lt;cache-container name="hibernate" module="org.infinispan.hibernate-cache" default-cache="immutable-entity"&gt;
    &lt;local-cache name="entity"&gt;
        &lt;transaction mode="NONE"/&gt;
        &lt;eviction max-entries="-1"/&gt;
        &lt;expiration max-idle="120000"/&gt;
    &lt;/local-cache&gt;
    &lt;local-cache name="immutable-entity"&gt;
        &lt;transaction mode="NONE"/&gt;
        &lt;eviction max-entries="-1"/&gt;
        &lt;expiration max-idle="120000"/&gt;
    &lt;/local-cache&gt;
    &lt;local-cache name="local-query"&gt;
        &lt;eviction max-entries="-1"/&gt;
        &lt;expiration max-idle="300000"/&gt;
    &lt;/local-cache&gt;
    &lt;local-cache name="pending-puts"&gt;
        &lt;transaction mode="NONE"/&gt;
        &lt;eviction strategy="NONE"/&gt;
        &lt;expiration max-idle="60000"/&gt;
    &lt;/local-cache&gt;
    &lt;local-cache name="timestamps"&gt;
        &lt;transaction mode="NONE"/&gt;
        &lt;eviction strategy="NONE"/&gt;
    &lt;/local-cache&gt;
&lt;/cache-container&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Persistence.xml to use the above custom settings:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;properties&gt;
    &lt;property name="hibernate.cache.use_second_level_cache" value="true"/&gt;
    &lt;property name="hibernate.cache.use_query_cache" value="true"/&gt;
    &lt;property name="hibernate.cache.infinispan.immutable-entity.cfg" value="immutable-entity"/&gt;
    &lt;property name="hibernate.cache.infinispan.timestamps.cfg" value="timestamps"/&gt;
    &lt;property name="hibernate.cache.infinispan.pending-puts.cfg" value="pending-puts"/&gt;
&lt;/properties&gt;</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="using-hibernate-search"><a class="anchor" href="#using-hibernate-search"></a>10.13. Using Hibernate Search</h3>
<div class="paragraph">
<p>WildFly includes Hibernate Search. If you want to use the bundled version of Hibernate Search, which requires to use the default Hibernate ORM persistence provider, this will be automatically enabled.  Having this enabled means that, provided your application includes any entity which is annotated with <strong>org.hibernate.search.annotations.Indexed</strong>, the module <strong>org.hibernate.search.orm:main</strong> will be made available to your deployment; this will also include the required version of Apache Lucene.</p>
</div>
<div class="paragraph">
<p>If you do not want this module to be exposed to your deployment, set the persistence property <strong>wildfly.jpa.hibernate.search.module</strong> to either <strong>none</strong> to not automatically inject any Hibernate Search module, or to any other module identifier to inject a different module. For example you could set <strong>wildfly.jpa.hibernate.search.module=org.hibernate.search.orm:5.11.0.Alpha1</strong> to use the experimental version 5.11.0.Alpha1 instead of the provided module; in this case you&#8217;ll have to download and add the custom modules to the application server as other versions are not included.  When setting <strong>wildfly.jpa.hibernate.search.module=none</strong> you might also opt to include Hibernate Search and its dependencies within your application but we highly recommend the modules approach.</p>
</div>
</div>
<div class="sect2">
<h3 id="packaging-the-hibernate-jpa-persistence-provider-with-your-application"><a class="anchor" href="#packaging-the-hibernate-jpa-persistence-provider-with-your-application"></a>10.14. Packaging the Hibernate JPA persistence provider with your application</h3>
<div class="paragraph">
<p>WildFly allows the packaging of Hibernate persistence provider jars with
the application. The JPA deployer will detect the presence of a
persistence provider in the application and
<strong>jboss.as.jpa.providerModule</strong> needs to be set to <strong>application</strong>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;?xml version="1.0" encoding="UTF-8"?&gt; +
&lt;persistence xmlns="http://java.sun.com/xml/ns/persistence"
version="1.0"&gt; +
&lt;persistence-unit name="myOwnORMVersion_pu"&gt; +
&lt;description&gt;Hibernate Persistence Unit.&lt;/description&gt; +
&lt;jta-data-source&gt;java:jboss/datasources/PlannerDS&lt;/jta-data-source&gt; +
&lt;properties&gt; +
&lt;property name="jboss.as.jpa.providerModule" value="application" /&gt; +
&lt;/properties&gt; +
&lt;/persistence-unit&gt; +
&lt;/persistence&gt;</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="migrating-from-openjpa"><a class="anchor" href="#migrating-from-openjpa"></a>10.15. Migrating from OpenJPA</h3>
<div class="paragraph">
<p>You need to copy the OpenJPA jar (e.g. openjpa-all.jar) into
the WildFly modules/org/apache/openjpa/main folder and update
modules/org/apache/openjpa/main/module.xml to include the same jar file
name that you copied in. This will help you get your application that
depends on OpenJPA, to deploy on WildFly.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java"> &lt;module xmlns="urn:jboss:module:1.1" name="org.apache.openjpa"&gt;
    &lt;resources&gt;
        &lt;resource-root path="jipijapa-openjpa-1.0.1.Final.jar"/&gt;
        &lt;resource-root path="openjpa-all.jar"&gt;
           &lt;filter&gt;
              &lt;exclude path="javax/**" /&gt;
           &lt;/filter&gt;
        &lt;/resource-root&gt;
    &lt;/resources&gt;

    &lt;dependencies&gt;
        &lt;module name="javax.annotation.api"/&gt;
        &lt;module name="javax.enterprise.api"/&gt;
        &lt;module name="javax.persistence.api"/&gt;
        &lt;module name="javax.transaction.api"/&gt;
        &lt;module name="javax.validation.api"/&gt;
        &lt;module name="javax.xml.bind.api"/&gt;
        &lt;module name="org.jboss.as.jpa.spi"/&gt;
        &lt;module name="org.jboss.logging"/&gt;
        &lt;module name="org.jboss.jandex"/&gt;
    &lt;/dependencies&gt;
&lt;/module&gt;</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="migrating-from-eclipselink"><a class="anchor" href="#migrating-from-eclipselink"></a>10.16. Migrating from EclipseLink</h3>
<div class="paragraph">
<p>You need to copy the EclipseLink jar (e.g. eclipselink-2.6.0.jar or
eclipselink.jar as in the example below) into the WildFly
modules/org/eclipse/persistence/main folder and update
modules/org/eclipse/persistence/main/module.xml to include the
EclipseLink jar (take care to use the jar name that you copied in). If
you happen to leave the EclipseLink version number in the jar name, the
module.xml should reflect that. This will help you get your application
that depends on EclipseLink, to deploy on WildFly.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml"> &lt;module xmlns="urn:jboss:module:1.1" name="org.eclipse.persistence"&gt;
    &lt;resources&gt;
        &lt;resource-root path="jipijapa-eclipselink-10.0.0.Final.jar"/&gt;
        &lt;resource-root path="eclipselink.jar"&gt;           &lt;filter&gt;
              &lt;exclude path="javax/**" /&gt;
           &lt;/filter&gt;
        &lt;/resource-root&gt;
    &lt;/resources&gt;

    &lt;dependencies&gt;
        &lt;module name="asm.asm"/&gt;
        &lt;module name="javax.api"/&gt;
        &lt;module name="javax.annotation.api"/&gt;
        &lt;module name="javax.enterprise.api"/&gt;
        &lt;module name="javax.persistence.api"/&gt;
        &lt;module name="javax.transaction.api"/&gt;
        &lt;module name="javax.validation.api"/&gt;
        &lt;module name="javax.xml.bind.api"/&gt;
        &lt;module name="org.antlr"/&gt;
        &lt;module name="org.apache.commons.collections"/&gt;
        &lt;module name="org.dom4j"/&gt;
        &lt;module name="org.jboss.as.jpa.spi"/&gt;
        &lt;module name="org.jboss.logging"/&gt;
        &lt;module name="org.jboss.vfs"/&gt;
    &lt;/dependencies&gt;
&lt;/module&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>You should then be able to deploy applications with persistence.xml that
include;</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;provider&gt;org.eclipse.persistence.jpa.PersistenceProvider&lt;/provider&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Also refer to page
<a href="https://community.jboss.org/wiki/HowToUseEclipseLinkWithAS7">how to use
EclipseLink with WildFly guide here</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="native-hibernate-use"><a class="anchor" href="#native-hibernate-use"></a>10.17. Native Hibernate use</h3>
<div class="paragraph">
<p>Applications that use the Hibernate API directly, can be referred to
as native Hibernate applications. Native Hibernate applications, can
choose to use the Hibernate jars included with WildFly or they can
package their own copy of the Hibernate jars. Applications that utilize
JPA will automatically have the Hibernate classes injected onto the
application deployment classpath. Meaning that JPA applications, should
expect to use the Hibernate jars included in WildFly.</p>
</div>
<div class="paragraph">
<p>Example MANIFEST.MF entry to add dependency for Hibernate native
applications:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>Manifest-Version: 1.0
...
Dependencies: org.hibernate</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="injection-of-hibernate-session-and-sessionfactoryinjection-of-hibernate-session-and-sessionfactory"><a class="anchor" href="#injection-of-hibernate-session-and-sessionfactoryinjection-of-hibernate-session-and-sessionfactory"></a>10.18. Injection of Hibernate Session and SessionFactory</h3>
<div class="paragraph">
<p>You can inject a org.hibernate.Session and org.hibernate.SessionFactory
directly, just as you can do with EntityManagers and
EntityManagerFactorys.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">import org.hibernate.Session;
import org.hibernate.SessionFactory;
@Stateful public class MyStatefulBean ... {
   @PersistenceContext(unitName="crm") Session session1;
   @PersistenceContext(unitName="crm2", type=EXTENDED) Session extendedpc;
   @PersistenceUnit(unitName="crm") SessionFactory factory;
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="hibernate-transformer"><a class="anchor" href="#hibernate-transformer"></a>10.19. Hibernate ORM 5.1 native API bytecode transformer</h3>
<div class="paragraph">
<p>The <strong>Hibernate ORM 5.1 native API bytecode transformer</strong>, can rewrite application bytecode,
to handle APIs that have changed between Hibernate ORM 5.1.x + 5.3.x.  For applications that use the Hibernate ORM 5.1
native APIs, you may either rewrite them for Hibernate ORM 5.3 or use the transformer, to rewrite your application byte-code
during application deployment (only the in-memory copy of your application is rewritten).  If your application is only using the
JPA specification APIs, you do not need to transform your application.</p>
</div>
<div class="paragraph">
<p>For details on the Hibernate 5.3 native API changes, review the <a href="https://github.com/hibernate/hibernate-orm/blob/5.2/migration-guide.adoc">ORM 5.2</a>
+ <a href="https://github.com/hibernate/hibernate-orm/blob/5.3/migration-guide.adoc">ORM 5.3</a> migration guides.</p>
</div>
<div class="paragraph">
<p>The Hibernate ORM 5.1 transformer is already deprecated, meaning it could be removed in the next release.
For this reason, we made it easy to enable the transformer via either a system property or jboss-deployment-structure change.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;jboss-deployment-structure&gt;
    &lt;deployment&gt;
        &lt;transformers&gt;
            &lt;transformer class="org.jboss.as.hibernate.Hibernate51CompatibilityTransformer"/&gt;
        &lt;/transformers&gt;
        &lt;dependencies&gt;
            &lt;module name="org.hibernate" export="true" /&gt;
        &lt;/dependencies&gt;
    &lt;/deployment&gt;
    &lt;sub-deployment name="main.war"&gt;
        &lt;transformers&gt;
            &lt;transformer class="org.jboss.as.hibernate.Hibernate51CompatibilityTransformer"/&gt;
        &lt;/transformers&gt;
    &lt;/sub-deployment&gt;
&lt;/jboss-deployment-structure&gt;</code></pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">If enabled, the following transformations will be made to application classes compiled with Hibernate 5.1: </dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>In user type classes, change methods with parameter type org.hibernate.engine.spi.SessionImplementor to instead use type org.hibernate.engine.spi.SharedSessionContractImplementor, this is done for implementations of:</p>
<div class="ulist">
<ul>
<li>
<p>org.hibernate.usertype.UserType.</p>
</li>
<li>
<p>org.hibernate.usertype.CompositeUserType.</p>
</li>
<li>
<p>org.hibernate.usertype.UserCollectionType.</p>
</li>
<li>
<p>org.hibernate.usertype.UserVersionType.</p>
</li>
<li>
<p>org.hibernate.type.Type.</p>
</li>
<li>
<p>org.hibernate.type.SingleColumnType.</p>
</li>
<li>
<p>org.hibernate.type.AbstractStandardBasicType.</p>
</li>
<li>
<p>org.hibernate.type.ProcedureParameterExtractionAware.</p>
</li>
<li>
<p>org.hibernate.type.ProcedureParameterNamedBinder.</p>
</li>
<li>
<p>org.hibernate.type.VersionType.</p>
</li>
</ul>
</div>
</li>
<li>
<p>In user type classes, when calling org.hibernate.* class methods, cast SessionImplementor to SharedSessionContractImplementor.</p>
</li>
<li>
<p>Change calls to org.hibernate.BasicQueryContract.getFlushMode(), <a href="https://github.com/hibernate/hibernate-orm/blob/5.2/migration-guide.adoc#misc">to instead call BasicQueryContract.getHibernateFlushMode()</a>.</p>
</li>
<li>
<p>Change calls to org.hibernate.Session.getFlushMode(), <a href="https://github.com/hibernate/hibernate-orm/blob/5.2/migration-guide.adoc#misc">to instead call Session.getHibernateFlushMode()</a>.</p>
</li>
<li>
<p>Change calls to org.hibernate.Query.getFirstResult(), to instead call Query.getHibernateFirstResult(), so null can be returned when the value is uninitialized (note that 0 is now returned instead of negative values).</p>
</li>
<li>
<p>Change calls to org.hibernate.Query.getMaxResults(), <a href="https://github.com/hibernate/hibernate-orm/blob/5.3/migration-guide.adoc#native-non-jpa-pagination-changes">to instead call Query.getHibernateMaxResults(), so that null will be returned when the value is uninitialized or org.hibernate.Query#setMaxResults() was called with a value &#8656; 0</a>.</p>
</li>
<li>
<p>Change calls to org.hibernate.Query.setFirstResult(), <a href="https://github.com/hibernate/hibernate-orm/blob/5.3/migration-guide.adoc#native-non-jpa-pagination-changes">to instead call Query.setHibernateFirstResult(), so that calls to set a value &lt; 0 results in pagination starting with the 0th row as was done in Hibernate ORM 5.1</a>.</p>
</li>
<li>
<p>Change calls to org.hibernate.Query.setMaxResults(), <a href="https://github.com/hibernate/hibernate-orm/blob/5.3/migration-guide.adoc#native-non-jpa-pagination-changes">to instead call Query.setHibernateMaxResults(), so that passed values &#8656; 0 are treated the same as uninitialized</a>.</p>
</li>
<li>
<p>Change references to NEVER field in enum org.hibernate.FlushMode, to instead reference FlushMode.MANUAL.</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="sidebarblock">
<div class="content">
<div class="paragraph">
<p>TRACE + DEBUG level logging can be enabled via the "org.jboss.as.hibernate.transformer" logger category.
Example output:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-text hljs" data-lang="text">Hibernate51CompatibilityTransformer transformed application classes in 'deployment.org.jboss.as.test.compat.jpa.hibernate.transformer.VerifyHibernate51CompatibilityPropertyAndJDSEnabledTransformerTestCase.ear', class 'org/jboss/as/test/compat/jpa/hibernate/transformer/BitSetType' is calling method org/hibernate/type/AbstractSingleColumnStandardBasicType.replace, which must be changed to use SharedSessionContractImplementor as parameter.</code></pre>
</div>
</div>
</div>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">System Property</th>
<th class="tableblock halign-left valign-top">Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Default</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Hibernate51CompatibilityTransformer</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">if true, the transformer will transform ORM 5.1.x native calls to, ORM 5.3 native calls, in every application deployment</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Hibernate51CompatibilityTransformer.disableAmbiguousChanges</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">disable transformation of org.hibernate.Query.setFirstResult(int) + org.hibernate.Query.setMaxResults(int), since these methods are in both Hibernate ORM 5.1.x + 5.3.x</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Hibernate51CompatibilityTransformer.showTransformedClassFolder</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">specifies the folder name to create bytecode level description of applications run through the transformer.  The specified folder must already exist.  If the transformer actually makes a change to your application, a (boolean) class variable will be added "$<em>org_jboss_as_hibernate_Hibernate51CompatibilityTransformer_transformed</em>$", that ensures that the application is only transformed once</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">disabled</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="hibernate-properties"><a class="anchor" href="#hibernate-properties"></a>10.20. Hibernate properties</h3>
<div class="paragraph">
<p>WildFly automatically sets the following Hibernate properties (if
not already set in persistence unit definition):</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Property</th>
<th class="tableblock halign-left valign-top">Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">hibernate.id.new_generator_mappings =true</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">New applications should let
this default to true, older applications with existing data might need
to set to false (see note below). It really depends on whether your
application uses the @GeneratedValue(AUTO) which will generates new key
values for newly created entities. The application can override this
value (in the persistence.xml).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">hibernate.transaction.jta.platform= instance of
org.hibernate.service.jta.platform.spi.JtaPlatform interface</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The
transaction manager, user transaction and transaction synchronization
registry is passed into Hibernate via this class.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">hibernate.ejb.resource_scanner = instance of
org.hibernate.ejb.packaging.Scanner interface</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Instance of entity
scanning class is passed in that knows how to use the AS annotation
indexer (for faster deployment).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">hibernate.transaction.manager_lookup_class</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">This property is removed if
found in the persistence.xml (could conflict with JtaPlatform)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">hibernate.session_factory_name = qualified persistence unit name</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Is
set to the application name + persistence unit name (application can
specify a different value but it needs to be unique across all
application deployments on the AS instance).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">hibernate.session_factory_name_is_jndi = false</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">only set if the
application didn&#8217;t specify a value for hibernate.session_factory_name.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">hibernate.ejb.entitymanager_factory_name = qualified persistence unit
name</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Is set to the application name + persistence unit name
(application can specify a different value but it needs to be unique
across all application deployments on the AS instance).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">hibernate.query.jpaql_strict_compliance=true</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">hibernate.auto_quote_keyword=false</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">hibernate.implicit_naming_strategy=org.hibernate.boot.model.naming.ImplicitNamingStrategyJpaCompliantImpl</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">hibernate.model.generator_name_as_sequence_name=true</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">hibernate.jpa.compliance.transaction=true</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">hibernate.jpa.compliance.closed=true</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">hibernate.jpa.compliance.query=true</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">hibernate.jpa.compliance.list=true</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">hibernate.jpa.compliance.caching=true</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">hibernate.jpa.compliance.proxy=true</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">hibernate.enable_lazy_load_no_trans=false</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">hibernate.jpa.compliance.global_id_generators=true</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">hibernate.search.index_uninverting_allowed=true</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>if <strong>hibernate.id.new_generator_mappings</strong> is <strong>true</strong>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>@GeneratedValue(AUTO) maps to
org.hibernate.id.enhanced.SequenceStyleGenerator</p>
</li>
<li>
<p>@GeneratedValue(TABLE) maps to
org.hibernate.id.enhanced.TableGenerator</p>
</li>
<li>
<p>@GeneratedValue(SEQUENCE) maps to
org.hibernate.id.enhanced.SequenceStyleGenerator</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>if <strong>hibernate.id.new_generator_mappings</strong> is <strong>false</strong>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>@GeneratedValue(AUTO) maps to Hibernate "native"</p>
</li>
<li>
<p>@GeneratedValue(TABLE) maps to
org.hibernate.id.MultipleHiLoPerTableGenerator</p>
</li>
<li>
<p>@GeneratedValue(SEQUENCE) to Hibernate "seqhilo"</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="persistence-unit-properties"><a class="anchor" href="#persistence-unit-properties"></a>10.21. Persistence unit properties</h3>
<div class="paragraph">
<p>The following properties are supported in the persistence unit
definition (in the persistence.xml file):</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Property</th>
<th class="tableblock halign-left valign-top">Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">jboss.as.jpa.providerModule</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">name of the persistence provider module
(default is org.hibernate). Should be application, if a persistence
provider is packaged with the application. See note below about some
module names that are built in (based on the provider).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">jboss.as.jpa.adapterModule</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">name of the integration classes that help
WildFly to work with the persistence provider.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">jboss.as.jpa.adapterClass</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">class name of the integration adapter.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">jboss.as.jpa.managed</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">set to false to disable container managed JPA
access to the persistence unit. The default is true, which enables
container managed JPA access to the persistence unit. This is typically
set to false for Spring applications.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">jboss.as.jpa.classtransformer</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">set to false to disable class
transformers for the persistence unit. Set to true, to allow entity
class enhancing/rewriting.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">wildfly.jpa.default-unit</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">set to true to choose the default persistence
unit in an application. This is useful if you inject a persistence
context without specifying the unitName (@PersistenceContext
EntityManager em) but have multiple persistence units specified in your
persistence.xml.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">wildfly.jpa.twophasebootstrap</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">persistence providers (like Hibernate
ORM 4.3+ via EntityManagerFactoryBuilder), allow a two phase persistence
unit bootstrap, which improves JPA integration with Jakarta Contexts and Dependency Injection. Setting the
wildfly.jpa.twophasebootstrap hint to false, disables the two phase
bootstrap (for the persistence unit that contains the hint).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">wildfly.jpa.applicationdatasource</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">set to true when using an application defined DataSource or resource reference to a global DataSource.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">wildfly.jpa.allowdefaultdatasourceuse</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">set to false to prevent
persistence unit from using the default data source. Defaults to true.
This is only important for persistence units that do not specify a
datasource.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">jboss.as.jpa.deferdetach</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Controls whether a transaction scoped
persistence context used in a non-JTA transaction thread will detach
loaded entities after each EntityManager invocation or when the
persistence context is closed (e.g. business method ends). Defaults to
false (entities are cleared after EntityManager invocation) and if set
to true, the detach is deferred until the context is closed.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">wildfly.jpa.skipquerydetach</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Controls whether a transaction scoped
persistence context used in a non-JTA transaction thread will detach
Query results immediately. Defaults to
false (Query results are detached immediately) and if set
to true, the detach is deferred until the persistence context is closed.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">wildfly.jpa.hibernate.search.module</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Controls which version of
Hibernate Search to include on classpath. Only makes sense when using
Hibernate as JPA implementation. The default is auto; other valid values
are none or a full module identifier to use an alternative version.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">jboss.as.jpa.scopedname</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specify the qualified (application scoped)
persistence unit name to be used. By default, this is internally set to
the application name + persistence unit name. The
hibernate.cache.region_prefix will default to whatever you set
jboss.as.jpa.scopedname to. Make sure you set the
jboss.as.jpa.scopedname value to a value not already in use by other
applications deployed on the same application server instance.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">wildfly.jpa.allowjoinedunsync</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If set to true, allows an
SynchronizationType.UNSYNCHRONIZED persistence context that has been
joined to the active JTA transaction, to be propagated into a
SynchronizationType.SYNCHRONIZED persistence context. Otherwise, an
IllegalStateException exception would of been thrown that complains that
an unsychronized persistence context cannot be propagated into a
synchronized persistence context. Defaults to false.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">wildfly.jpa.skipmixedsynctypechecking</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set to true to disable the
throwing of an IllegalStateException exception when propagating an
SynchronizationType.UNSYNCHRONIZED persistence context into a
SynchronizationType.SYNCHRONIZED persistence context. This is a
workaround intended to allow applications that used to incorrectly not
get IllegalStateException exception with extended persistence contexts,
to avoid the IllegalStateException, so they don&#8217;t have to change their
application right away (for compatibility purposes). This hint may be
deprecated in a future release. See WFLY-7108 for more details. Defaults
to false.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">wildfly.jpa.regionfactory</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Only applies to Hibernate ORM 5.3+, set to false to disable automatic use of Infinispan as second level cache (hibernate.cache.region.factory_class).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">wildfly.jpa.jtaplatform</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Only applies to Hibernate ORM 5.3+, set to false to disable automatic configuring of the JTA integration platform (hibernate.transaction.jta.platform).</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="determine-the-persistence-provider-module"><a class="anchor" href="#determine-the-persistence-provider-module"></a>10.22. Determine the persistence provider module</h3>
<div class="paragraph">
<p>As mentioned above, if the <strong>jboss.as.jpa.providerModule</strong> property is not
specified, the provider module name is determined by the <strong>provider</strong> name
specified in the persistence.xml. The mapping is:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Provider Name</th>
<th class="tableblock halign-left valign-top">Module name</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">blank</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">org.hibernate</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">org.hibernate.jpa.HibernatePersistenceProvider</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">org.hibernate</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">org.hibernate.ogm.jpa.HibernateOgmPersistence</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">org.hibernate.ogm</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">oracle.toplink.essentials.PersistenceProvider</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">oracle.toplink</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">oracle.toplink.essentials.ejb.cmp3.EntityManagerFactoryProvider</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">oracle.toplink</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">org.eclipse.persistence.jpa.PersistenceProvider</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">org.eclipse.persistence</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">org.datanucleus.api.jpa.PersistenceProviderImpl</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">org.datanucleus</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">org.datanucleus.store.appengine.jpa.DatastorePersistenceProvider</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">org.datanucleus:appengine</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">org.apache.openjpa.persistence.PersistenceProviderImpl</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">org.apache.openjpa</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="binding-entitymanagerfactoryentitymanager-to-jndi"><a class="anchor" href="#binding-entitymanagerfactoryentitymanager-to-jndi"></a>10.23. Binding EntityManagerFactory/EntityManager to JNDI</h3>
<div class="paragraph">
<p>By default WildFly does <strong>not</strong> bind the entity manager factory to JNDI.
However, you can explicitly configure this in the persistence.xml of
your application by setting the <code>jboss.entity.manager.factory.jndi.name</code>
<code>hint. The value of that property should be the JNDI name to which the entity manager factory should be bound.</code></p>
</div>
<div class="paragraph">
<p><code>You can also bind a container managed (transaction scoped) entity manager to JNDI as well, }}via hint</code>
<code>jboss.entity.manager.jndi.name</code>\{
<code>}{{. As a reminder, a transaction scoped entity manager (persistence context), acts as a proxy that always gets an unique underlying entity manager (at the persistence provider level).</code></p>
</div>
<div class="paragraph">
<p><code>Here&#8217;s an example:</code></p>
</div>
<div class="paragraph">
<p>persistence.xml</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;persistence version="2.0"
   xmlns="http://java.sun.com/xml/ns/persistence" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
   xsi:schemaLocation="
        http://java.sun.com/xml/ns/persistence
        http://java.sun.com/xml/ns/persistence/persistence_2_0.xsd"&gt;
   &lt;persistence-unit name="myPU"&gt;
      &lt;!-- If you are running in a production environment, add a managed
         data source, the example data source is just for proofs of concept! --&gt;
      &lt;jta-data-source&gt;java:jboss/datasources/ExampleDS&lt;/jta-data-source&gt;
      &lt;properties&gt;
         &lt;!-- Bind entity manager factory to JNDI at java:jboss/myEntityManagerFactory --&gt;
         &lt;property name="jboss.entity.manager.factory.jndi.name" value="java:jboss/myEntityManagerFactory" /&gt;
         &lt;property name="jboss.entity.manager.jndi.name" value="java:/myEntityManager"/&gt;
       &lt;/properties&gt;
   &lt;/persistence-unit&gt;
&lt;/persistence&gt;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">@Stateful
public class ExampleSFSB {
  public void createSomeEntityWithTransactionScopedEM(String name) {
    Context context = new InitialContext();
    javax.persistence.EntityManager entityManager = (javax.persistence.EntityManager) context.lookup("java:/myEntityManager");
    SomeEntity someEntity = new SomeEntity();
    someEntity.setName(name);    entityManager.persist(name);
  }
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="tips-for-using-the-latest-hibernate-orm"><a class="anchor" href="#tips-for-using-the-latest-hibernate-orm"></a>10.24. Tips for using the latest Hibernate ORM</h3>
<div class="paragraph">
<p><a href="http://docs.jboss.org/hibernate/stable/orm/topical/html_single/wildfly/Wildfly.html">Read about using Hibernate ORM feature packs on WildFly</a>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
References in this document to Java Transaction API(JTA) refer to Jakarta Transactions unless otherwise noted.
      References in this document to Java Persistence API(JPA) refer to the Jakarta Persistence unless otherwise noted.
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="JTA_Reference"><a class="anchor" href="#JTA_Reference"></a>11. JTA Reference</h2>
<div class="sectionbody">
<div class="paragraph">
<p>WildFly uses <a href="http://narayana.io">Narayana</a> as the implementation of the JTA specification.
Narayana manages transactions in the application server.</p>
</div>
<div class="sect2">
<h3 id="transactions-in-enterprise-java-applications"><a class="anchor" href="#transactions-in-enterprise-java-applications"></a>11.1. Transactions in Enterprise Java applications</h3>
<div class="paragraph">
<p>Transactions are one of the core functionalities provided by the container
for the applications. A developer can manage transactions either with
the programmatic approach - with API defined by JTA specification.
Or he can use annotations. There are two types.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>first - EJB annotations, their meaning and capabilities are defined under
EJB specification and are valid when used in the EJB component</p>
</li>
<li>
<p>second - CDI annotations, their meaning is defined under JTA specification</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="programmatic-jta"><a class="anchor" href="#programmatic-jta"></a>11.1.1. Transactions managed with programmatic JTA API</h4>
<div class="paragraph">
<p>The JTA API is defined under
<a href="https://javaee.github.io/javaee-spec/javadocs/javax/transaction/package-summary.html"><code>javax.transaction</code></a>
package. The package could be considered a bit misguiding as it presents classes
which are expected to be used by application developer. These classes
are intended as an API for the application server (as the WildFly is).</p>
</div>
<div class="paragraph">
<p>The user is expected to interact with
<a href="https://javaee.github.io/javaee-spec/javadocs/javax/transaction/UserTransaction.html"><code>javax.transaction.UserTransaction</code></a>
which defines the transaction boundaries. The <code>UserTransaction</code> could be used
in case the transaction is not defined by annotation at the method
- aka. the transaction is not managed by the container. Those are places like
servlets, CDI bean which is not annotated with <code>@Transactional</code> and
EJBs defined as bean managed.</p>
</div>
<div class="paragraph">
<p><code>UserTransaction</code> is available via CDI injection</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">@Inject
UserTransaction txn;</code></pre>
</div>
</div>
<div class="paragraph">
<p>or with EJB <code>@Resource</code> injection where you can additionally define the JNDI
name to be looked-up. The specification says it&#8217;s <code>java:comp/UserTransaction</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">@Resource(lookup = "java:comp/UserTransaction")
UserTransaction txn;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The code can then look like</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">@WebServlet(name="TestServlet", urlPatterns={"/"})
public class TestServlet extends HttpServlet {
    private static final Logger LOG = Logger.getLogger(TestServlet.class);

    @Inject
    private UserTransaction txn;

    @PersistenceContext
    private EntityManager em;

    @Override
    protected void doGet(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
        try {
            txn.begin();

            em.persist(new TestEntity(1, "Mr. Transaction"));

            txn.commit();
          } catch (NotSupportedException beginExceptions) {
              LOG.errorf(beginExceptions, "Cannot start transaction: '%s'", txn);
          } catch (SecurityException | IllegalStateException | RollbackException
                  | HeuristicMixedException | HeuristicRollbackException commitExceptions) {
              LOG.errorf(commitExceptions, "Cannot commit transaction: '%s'", txn);
          } catch (SystemException systemException) {
              LOG.errorf(systemException, "Unexpected error condition on work with transaction: '%s'", txn);
          }
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><a href="https://javaee.github.io/javaee-spec/javadocs/javax/transaction/TransactionManager.html"><code>javax.transaction.TransactionManager</code></a>
is not meant to be used by business logic but if you need to register
<a href="https://javaee.github.io/javaee-spec/javadocs/javax/transaction/Synchronization.html">a synchronization</a>
or you need to change transaction timeout (before the <code>begin()</code> method is called)
then it will be the option for you.</p>
</div>
<div class="paragraph">
<p>The <code>TransactionManager</code> could be taken with injection
and looked-up with the JNDI name</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">@Inject
TransactionManager tm;

// or

@Resource(lookup = "java:/TransactionManager")
TransactionManager tm;</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="in-cdi"><a class="anchor" href="#in-cdi"></a>11.1.2. Transactions in CDI beans</h4>
<div class="paragraph">
<p>If you start using CDI beans then you can manage transactions either programmatically
or you can use annotations.
The <a href="https://javaee.github.io/javaee-spec/javadocs/javax/transaction/Transactional.html"><code>@Transactional</code></a>
defines transaction boundaries
(start of the method starts the transaction, while the transaction is finished at its end).
If the method finishes sucessfully the transaction is committed.
If the transaction ends with <code>RuntimeException</code> then it&#8217;s rolled-back.</p>
</div>
<div class="paragraph">
<p>When you define the method to be <code>@Transactional</code> you define the behaviour
of incoming (or non-existent) transactional context.
Please refer the to documentation for
<a href="https://javaee.github.io/javaee-spec/javadocs/javax/transaction/Transactional.TxType.html"><code>Transactional.TxType</code></a>.</p>
</div>
<div class="paragraph">
<p>It&#8217;s important to note that the <code>TxType</code> influences the transaction management
<strong>only</strong> when called with the managed CDI bean. If you call the method directly -
without the CDI container wraps the invocation then the <code>TxType</code> has no effect.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">@RequestScope
public class MyCDIBean {
  @Inject
  MyCDIBean myBean;

  @Transactional(TxType.REQUIRED)
  public void mainMethod() {
    // CDI container does not wrap the invocation
    // no new transaction is started
    innerFunctionality();

    // CDI container starts a new transaction
    // the method uses TxType.REQUIRES_NEW and is called from the CDI bean
    myBean.innerFunctionality();
  }

  @Transactional(TxType.REQUIRES_NEW)
  private void innerFunctionality() {
    // some business logic
  }
}</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
the exception handling could be influenced by attributes
      <code>rollbackOn</code> and <code>dontRollbackOn</code> (of the <code>@Transactional</code> annotation)
</td>
</tr>
</table>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
if you use the <code>@Transactional</code> for managing transactions boundaries
         you won&#8217;t be permitted to use the <code>UserTransaction</code> methods.
         If you do so you can expect a runtime exception being thrown.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The CDI introduces as well a new scope for use with transactions -
<a href="https://javaee.github.io/javaee-spec/javadocs/javax/ejb/SessionContext.html"><code>@TransactionScoped</code></a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="in-ejbs"><a class="anchor" href="#in-ejbs"></a>11.1.3. Transactions in EJBs</h4>
<div class="paragraph">
<p>Transaction management in EJB is administered with two annotations:
<a href="https://javaee.github.io/javaee-spec/javadocs/javax/ejb/TransactionManagement.html"><code>@TransactionManagement</code></a>
 <a href="https://javaee.github.io/javaee-spec/javadocs/javax/ejb/TransactionAttribute.html"><code>@TransactionAttribute</code></a>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
you can define the same behaviour when you use the <code>ejb-jar.xml</code>
      descriptor instead of the annotations
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The WildFly provides specific annotation <code>org.jboss.ejb3.annotation.TransactionTimeout</code>
which gives you the chance to change the transaction timeout for a particular bean/method.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
when you use message-driven bean then the <code>@TransactionTimeout</code> does not work
      and you need to define the timeout through the <code>@ActivationConfigProperty</code>:
      <code>@ActivationConfigProperty(propertyName="transactionTimeout", propertyValue="1")</code>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The default behaviour of an EJB is to be</p>
</div>
<div class="ulist">
<ul>
<li>
<p>container managed - transaction boundaries are driven by annotations</p>
</li>
<li>
<p>when the EJB method is invoked - a new transaction is started when no transaction context is available,
or the method joins the existing transactions when the transaction context is passed by the call</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>It&#8217;s the same transactional behaviour as if the EJB is annotated with</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">@TransactionManagement(TransactionManagementType.CONTAINER)
@TransactionAttribute(TransactionAttributeType.REQUIRED)</code></pre>
</div>
</div>
<div class="sect4">
<h5 id="container-managed-transactions"><a class="anchor" href="#container-managed-transactions"></a>Container managed transactions</h5>
<div class="paragraph">
<p>Using the <code>@TransactionManagement(TransactionManagementType.CONTAINER)</code> means
the container is responsible to manage transactions. The boundary of the transaction
is defined by the start and end of the method and you influence the behaviour by using
<a href="https://javaee.github.io/javaee-spec/javadocs/javax/ejb/TransactionAttribute.html"><code>@TransactionAttribute</code></a>.</p>
</div>
<div class="paragraph">
<p>If <code>java.lang.RuntimeException</code> is thrown the transaction is rolled back.
<a href="https://javaee.github.io/javaee-spec/javadocs/javax/ejb/EJBContext.html">EJBContext</a>
could be used to define the transaction should be rolled-back
by the end of the method when <code>setRollbackOnly</code> is used.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">@Stateless
public class MyBean {
  @PersistenceContext
  private EntityManager em;

  @Resource
  EJBContext ctx;

  public void method() {
    em.persist(new TestEntity());
    // at the end of the method the rollback is called
    ctx.setRollbackOnly();
  }
}</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
the <code>EJBContext</code> let you get the <code>UserTransaction</code> but you are not allowed
      to do any operation with that when you run container managed transaction.
      You can expect to receive a runtime exception in such case.
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="bean-managed-transactions"><a class="anchor" href="#bean-managed-transactions"></a>Bean managed transactions</h5>
<div class="paragraph">
<p>Using the <code>@TransactionManagement(TransactionManagementType.BEAN)</code> means
the transaction will be managed manually with the use of the JTA API.
That&#8217;s with the <code>UserTransaction</code> injections and methods on it.
You can inject the <code>EJBContext</code> to get the <code>UserTransaction</code> instance too.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
if a call is made from the container-managed method,
      passing the transaction context to the bean managed method
      then the context is suspended. It&#8217;s similar(!) to
      call transaction managed bean annotated with
      <code>@TransactionAttribute(TransactionAttributeType.NOT_SUPPORTED)</code>
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="transaction-synchronization"><a class="anchor" href="#transaction-synchronization"></a>Transaction synchronization</h5>
<div class="paragraph">
<p>JTA API gives a chance to react to the event of a finishing transaction.
The definition says that transaction manager announces the even of <code>beforeCompletion</code> and <code>afterCompletion</code>
which are defined by the interface <a href="https://javaee.github.io/javaee-spec/javadocs/javax/transaction/Synchronization.html">javax.transaction.Synchronization</a>.
The <a href="https://javaee.github.io/javaee-spec/javadocs/javax/transaction/Synchronization.html#beforeCompletion--"><code>beforeCompletion</code></a>
callback is invoked at time the transaction manager starts to commit the global transaction. The invocation is processed in the transaction context.
The <a href="https://javaee.github.io/javaee-spec/javadocs/javax/transaction/Synchronization.html#afterCompletion-int-"><code>afterCompletion</code></a>
is invoked after the transaction is committed or rolled-back (and is processed outside of the transaction context).</p>
</div>
<div class="paragraph">
<p>The user needs just to create a simple Java POJO and implement the interface.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">public class MySynchronization
        implements javax.transaction.Synchronization {
  @Override
  public void beforeCompletion() {
    System.out.println("Transaction is about to be finished"):
  }

  @Override
  public void afterCompletion(int status) {
    System.out.println("Transaction finished with status " + status):
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>For registration of the synchronization callback, the user can inject the
<a href="https://docs.oracle.com/javaee/7/api/javax/transaction/TransactionSynchronizationRegistry.html">javax.transaction.TransactionSynchronizationRegistry</a>.
(the mandated JNDI location for the object is at <code>java:comp/TransactionSynchronizationRegistry</code>) and then to register
the synchronization instance. The instance is bound to the currently active transaction.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">@Resource
TransactionSynchronizationRegistry transactionSynchronizationRegistry;

public void method() {
  transactionSynchronizationRegistry
    .registerInterposedSynchronization(new MySynchronization());
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The transaction synchronization registry adds other useful methods which are <code>putResource(Object key, Object value)</code>
and <code>getResource(Object key)</code>. Their purpose is saving data objects alongside the transaction context.
When the transaction is active you can store and retrieve the saved data. When the transaction is finished
and there is no transaction context available (e.g. at <code>afterCompletion</code>) the <code>java.lang.IllegalStateException</code>
is thrown.</p>
</div>
<div class="paragraph">
<p>The other option for the user is to use <a href="https://javaee.github.io/javaee-spec/javadocs/javax/transaction/Transaction.html">the transaction object</a>
to register the synchronization.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">@Resource(lookup = "java:/TransactionManager")
TransactionManager tm;

public void method() {
tm.getTransaction().registerSynchronization(new MySynchronization());</code></pre>
</div>
</div>
<div class="paragraph">
<p>When the user runs the Stateful Session Bean he can implement
interface <a href="https://javaee.github.io/javaee-spec/javadocs/javax/ejb/SessionSynchronization.html">javax.ejb.SessionSynchronization</a>
(or to use annotations) for the definition of the synchronization callbacks onto the bean.
The session synchronization defines three methods.
Of these three methods <code>afterBegin</code> is not connected to the transaction synchronization so we will not discuss it further.
The  following example works with annotations but the bean may just implement the <code>SessionSynchronization</code>
interface and it would work the same way.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">// only(!) SFSB can use the capability of SessionSynchronization
@Stateful
public class MyStatefulBean {
  public void method() {
    System.out.println("Running an important business logic...");
    Thread.sleep(42000);
  }

  @BeforeCompletion
  public void beforeCompletion() {
    System.out.println("Transaction is about to be finished"):
  }

  @AfterCompletion
  public void afterCompletion(boolean committed) {
    System.out.println("Transaction finished with the outcome "
      + (committed ? "committed" : "rolled-back")):
  }
}</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
for more information about CDI and registration of transaction synchronization
      look at <a href="https://jbossts.blogspot.com/2019/04/jta-and-cdi-integration.html">the article about Narayana integration of CDI events</a>.
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="classloading"><a class="anchor" href="#classloading"></a>11.2. Transactions subsystem class loading</h3>
<div class="paragraph">
<p>The WildFly classloading is based
on the <a href="https://github.com/jboss-modules/jboss-modules">jboss modules</a>
which define the modular class loading system.
The transactions for CDI comes as the extension and because of it
this extension has to be available at the application classpath.
If the application/deployment uses annotations <code>@Transactional</code>
or <code>@TransactionScoped</code> then class loading handling is done automatically.</p>
</div>
<div class="paragraph">
<p>There is one limitation with the CDI with this approach.
If your application adds the transactional annotations dynamically
(you adds the annotations dynamically during runtime) then the
transaction module has to be
<a href="https://docs.jboss.org/author/display/WFLY/Class+Loading+in+WildFly">explicitly added</a>
to the application classpath.</p>
</div>
<div class="paragraph">
<p>This can be done with creating <code>META-INF/MANIFEST.MF</code> or
with use of <code>jboss-deployment-structure.xml</code> descriptor. The <code>MANIFEST.MF</code>
could look like</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code>Manifest-Version: 1.0
Dependencies: org.jboss.jts export services</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="troubleshooting"><a class="anchor" href="#troubleshooting"></a>11.3. Transactions troubleshooting</h3>
<div class="paragraph">
<p>The Narayana component is configured to log only messages with level <code>WARN</code>
(see category <code>com.arjuna</code> in the <code>standalone-*.xml</code>).
If you struggle issues of the transactional handling
you can get a better insight into transaction processing by setting the level to <code>TRACE</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">/subsystem=logging/logger=com.arjuna:write-attribute(name=level,value=TRACE)</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>TRACE</code> could overwhelm you with information from the transactions subsystem.
Let&#8217;s quickly review what are the most important points to look at in the log.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
It&#8217;s beneficial to understand how
      the <a href="https://developer.jboss.org/wiki/TwoPhaseCommit2PC">two-phase commit</a> works.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>An example of the log messages produces by Narayana is (the content is shortened for sake of brevity)</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code>[section 1]
2019-02-05 14:19:39,745 TRACE [com.arjuna.ats.jta] (default task-1) BaseTransaction.begin
2019-02-05 14:19:39,745 TRACE [com.arjuna.ats.arjuna] (default task-1) StateManager::StateManager( 2, 0 )
2019-02-05 14:19:39,745 TRACE [com.arjuna.ats.arjuna] (default task-1) BasicAction::BasicAction()
2019-02-05 14:19:39,745 TRACE [com.arjuna.ats.arjuna] (default task-1) BasicAction::Begin() for action-id 0:ffff0a28050c:-a09a5fe:5c598d64:3b
2019-02-05 14:19:39,745 TRACE [com.arjuna.ats.arjuna] (default task-1) BasicAction::actionInitialise() for action-id 0:ffff0a28050c:-a09a5fe:5c598d64:3b
2019-02-05 14:19:39,745 TRACE [com.arjuna.ats.arjuna] (default task-1) ActionHierarchy::ActionHierarchy(1)
2019-02-05 14:19:39,745 TRACE [com.arjuna.ats.arjuna] (default task-1) ActionHierarchy::add(0:ffff0a28050c:-a09a5fe:5c598d64:3b, 1)
2019-02-05 14:19:39,745 TRACE [com.arjuna.ats.arjuna] (default task-1) BasicAction::addChildThread () action 0:ffff0a28050c:-a09a5fe:5c598d64:3b adding Thread[default task-1,5,main]
2019-02-05 14:19:39,745 TRACE [com.arjuna.ats.arjuna] (default task-1) BasicAction::addChildThread () action 0:ffff0a28050c:-a09a5fe:5c598d64:3b adding Thread[default task-1,5,main] result = true
2019-02-05 14:19:39,745 TRACE [com.arjuna.ats.arjuna] (default task-1) TransactionReaper::insert ( BasicAction: 0:ffff0a28050c:-a09a5fe:5c598d64:3b status: ActionStatus.RUNNING, 300 )
2019-02-05 14:19:39,745 TRACE [com.arjuna.ats.arjuna] (default task-1) ReaperElement::ReaperElement ( BasicAction: 0:ffff0a28050c:-a09a5fe:5c598d64:3b status: ActionStatus.RUNNING, 300 )
2019-02-05 14:19:39,745 TRACE [com.arjuna.ats.jta] (default task-1) TransactionImple.registerSynchronization - Class: class org.wildfly.transaction.client.AbstractTransaction$AssociatingSynchronization HashCode: 1114413551 toString: org.wildfly.transaction.client.AbstractTransaction$AssociatingSynchronization@426c99ef


[section 2]
TRACE [com.arjuna.ats.jta] (default task-1) TransactionImple.enlistResource ( TestXAResource(TestXAResourceCommon(id:944, xid:null, timeout:299, prepareReturn:0)) )
TRACE [com.arjuna.ats.jta] (default task-1) TransactionImple.getStatus: javax.transaction.Status.STATUS_ACTIVE
TRACE [com.arjuna.ats.arjuna] (default task-1) OutputObjectState::OutputObjectState()
TRACE [com.arjuna.ats.arjuna] (default task-1) FileSystemStore.write_committed(0:ffff0a28050c:-a09a5fe:5c598d64:43, EISNAME)
TRACE [com.arjuna.ats.arjuna] (default task-1) ShadowingStore.write_state(0:ffff0a28050c:-a09a5fe:5c598d64:43, EISNAME, StateType.OS_ORIGINAL)
TRACE [com.arjuna.ats.arjuna] (default task-1) ShadowingStore.genPathName(0:ffff0a28050c:-a09a5fe:5c598d64:43, EISNAME, StateType.OS_ORIGINAL)
TRACE [com.arjuna.ats.arjuna] (default task-1) FileSystemStore.genPathName(0:ffff0a28050c:-a09a5fe:5c598d64:43, EISNAME, 11)
TRACE [com.arjuna.ats.arjuna] (default task-1) FileSystemStore.openAndLock(data/tx-object-store/ShadowNoFileLockStore/defaultStore/EISNAME/0_ffff0a28050c_-a09a5fe_5c598d64_43, FileLock.F_WRLCK, true)
TRACE [com.arjuna.ats.arjuna] (default task-1) FileSystemStore.closeAndUnlock(data/tx-object-store/ShadowNoFileLockStore/defaultStore/EISNAME/0_ffff0a28050c_-a09a5fe_5c598d64_43, null, java.io.FileOutputStream@72d0d91)
TRACE [com.arjuna.ats.arjuna] (default task-1) StateManager::StateManager( 1, 0 )
TRACE [com.arjuna.ats.arjuna] (default task-1) AbstractRecord::AbstractRecord (0:ffff0a28050c:-a09a5fe:5c598d64:45, 1)
TRACE [com.arjuna.ats.jta] (default task-1) XAResourceRecord.XAResourceRecord ( &lt; formatId=131077, gtrid_length=29, bqual_length=36, tx_uid=0:ffff0a28050c:-a09a5fe:5c598d64:3b, node_name=1, branch_uid=0:ffff0a28050c:-a09a5fe:5c598d64:44, subordinatenodename=null, eis_name=java:/TestXAResource &gt;, TestXAResource(TestXAResourceCommon(id:944, xid:null, timeout:300, prepareReturn:0)) ), record id=0:ffff0a28050c:-a09a5fe:5c598d64:45
TRACE [com.arjuna.ats.arjuna] (default task-1) RecordList::insert(RecordList: empty) : appending /StateManager/AbstractRecord/XAResourceRecord for 0:ffff0a28050c:-a09a5fe:5c598d64:45

[section 3]
TRACE [com.arjuna.ats.jta] (default task-1) BaseTransaction.commit
TRACE [com.arjuna.ats.jta] (default task-1) TransactionImple.commitAndDisassociate
TRACE [com.arjuna.ats.jta] (default task-1) TransactionImple.getStatus: javax.transaction.Status.STATUS_ACTIVE
TRACE [com.arjuna.ats.arjuna] (default task-1) BasicAction::End() for action-id 0:ffff0a28050c:-a09a5fe:5c598d64:3b

[section 4]
TRACE [com.arjuna.ats.arjuna] (default task-1) BasicAction::prepare () for action-id 0:ffff0a28050c:-a09a5fe:5c598d64:3b
TRACE [com.arjuna.ats.jta] (default task-1) XAResourceRecord.topLevelPrepare for XAResourceRecord &lt; resource:TestXAResource(TestXAResourceCommon(id:944, xid:&lt; formatId=131077, gtrid_length=29, bqual_length=36, tx_uid=0:ffff0a28050c:-a09a5fe:5c598d64:3b, node_name=1, branch_uid=0:ffff0a28050c:-a09a5fe:5c598d64:44, subordinatenodename=null, eis_name=java:/TestXAResource &gt;, timeout:300, prepareReturn:0)), txid:&lt; formatId=131077, gtrid_length=29, bqual_length=36, tx_uid=0:ffff0a28050c:-a09a5fe:5c598d64:3b, node_name=1, branch_uid=0:ffff0a28050c:-a09a5fe:5c598d64:44, subordinatenodename=null, eis_name=java:/TestXAResource &gt;, heuristic: TwoPhaseOutcome.FINISH_OK, product: Crash Recovery Test/EAP Test, jndiName: java:/TestXAResource com.arjuna.ats.internal.jta.resources.arjunacore.XAResourceRecord@6454bcb3 &gt;, record id=0:ffff0a28050c:-a09a5fe:5c598d64:45
TRACE [com.arjuna.ats.arjuna] (default task-1) BasicAction::doPrepare() result for action-id (0:ffff0a28050c:-a09a5fe:5c598d64:3b) on record id: (0:ffff0a28050c:-a09a5fe:5c598d64:45) is (TwoPhaseOutcome.PREPARE_OK) node id: (1)
TRACE [com.arjuna.ats.arjuna] (default task-1) RecordList::insert(RecordList: empty) : appending /StateManager/AbstractRecord/XAResourceRecord for 0:ffff0a28050c:-a09a5fe:5c598d64:45
TRACE [com.arjuna.ats.arjuna] (default task-1) OutputObjectState::OutputObjectState(0:ffff0a28050c:-a09a5fe:5c598d64:3b, /StateManager/BasicAction/TwoPhaseCoordinator/AtomicAction)
TRACE [com.arjuna.ats.arjuna] (default task-1) BasicAction::save_state ()
TRACE [com.arjuna.ats.arjuna] (default task-1) StateManager.packHeader for object-id 0:ffff0a28050c:-a09a5fe:5c598d64:3b birth-date 1549372780127
TRACE [com.arjuna.ats.arjuna] (default task-1) BasicAction::save_state - next record to pack is a 171 record /StateManager/AbstractRecord/XAResourceRecord should save it? = true

[section 5]
TRACE [com.arjuna.ats.arjuna] (default task-1) BasicAction::phase2Commit() for action-id 0:ffff0a28050c:-a09a5fe:5c598d64:3b
TRACE [com.arjuna.ats.arjuna] (default task-1) BasicAction::doCommit (XAResourceRecord &lt; resource:TestXAResource(TestXAResourceCommon(id:944, xid:&lt; formatId=131077, gtrid_length=29, bqual_length=36, tx_uid=0:ffff0a28050c:-a09a5fe:5c598d64:3b, node_name=1, branch_uid=0:ffff0a28050c:-a09a5fe:5c598d64:44, subordinatenodename=null, eis_name=java:/TestXAResource &gt;, timeout:300, prepareReturn:0)), txid:&lt; formatId=131077, gtrid_length=29, bqual_length=36, tx_uid=0:ffff0a28050c:-a09a5fe:5c598d64:3b, node_name=1, branch_uid=0:ffff0a28050c:-a09a5fe:5c598d64:44, subordinatenodename=null, eis_name=java:/TestXAResource &gt;, heuristic: TwoPhaseOutcome.FINISH_OK, product: Crash Recovery Test/EAP Test, jndiName: java:/TestXAResource com.arjuna.ats.internal.jta.resources.arjunacore.XAResourceRecord@6454bcb3 &gt;)
TRACE [com.arjuna.ats.jta] (default task-1) XAResourceRecord.topLevelCommit for XAResourceRecord &lt; resource:TestXAResource(TestXAResourceCommon(id:944, xid:&lt; formatId=131077, gtrid_length=29, bqual_length=36, tx_uid=0:ffff0a28050c:-a09a5fe:5c598d64:3b, node_name=1, branch_uid=0:ffff0a28050c:-a09a5fe:5c598d64:44, subordinatenodename=null, eis_name=java:/TestXAResource &gt;, timeout:300, prepareReturn:0)), txid:&lt; formatId=131077, gtrid_length=29, bqual_length=36, tx_uid=0:ffff0a28050c:-a09a5fe:5c598d64:3b, node_name=1, branch_uid=0:ffff0a28050c:-a09a5fe:5c598d64:44, subordinatenodename=null, eis_name=java:/TestXAResource &gt;, heuristic: TwoPhaseOutcome.FINISH_OK, product: Crash Recovery Test/EAP Test, jndiName: java:/TestXAResource com.arjuna.ats.internal.jta.resources.arjunacore.XAResourceRecord@6454bcb3 &gt;, record id=0:ffff0a28050c:-a09a5fe:5c598d64:45
TRACE [com.arjuna.ats.arjuna] (default task-1) BasicAction::doCommit() result for action-id (0:ffff0a28050c:-a09a5fe:5c598d64:3b) on record id: (0:ffff0a28050c:-a09a5fe:5c598d64:45) is (TwoPhaseOutcome.FINISH_OK) node id: (1)

[section 6]
TRACE [com.arjuna.ats.arjuna] (default task-1) BasicAction::updateState() for action-id 0:ffff0a28050c:-a09a5fe:5c598d64:3b
TRACE [com.arjuna.ats.arjuna] (default task-1) FileSystemStore.remove_committed(0:ffff0a28050c:-a09a5fe:5c598d64:3b, /StateManager/BasicAction/TwoPhaseCoordinator/AtomicAction)
TRACE [com.arjuna.ats.arjuna] (default task-1) ShadowingStore.remove_state(0:ffff0a28050c:-a09a5fe:5c598d64:3b, /StateManager/BasicAction/TwoPhaseCoordinator/AtomicAction, StateType.OS_ORIGINAL)
TRACE [com.arjuna.ats.arjuna] (default task-1) FileSystemStore.closeAndUnlock(data/tx-object-store/ShadowNoFileLockStore/defaultStore/StateManager/BasicAction/TwoPhaseCoordinator/AtomicAction/0_ffff0a28050c_-a09a5fe_5c598d64_3b, null, null)
TRACE [com.arjuna.ats.arjuna] (default task-1) BasicAction::End() result for action-id (0:ffff0a28050c:-a09a5fe:5c598d64:3b) is (TwoPhaseOutcome.FINISH_OK) node id: (1)
TRACE [com.arjuna.ats.jta] (default task-1) SynchronizationImple.afterCompletion - Class: class org.wildfly.transaction.client.AbstractTransaction$AssociatingSynchronization HashCode: 1685304571 toString: org.wildfly.transaction.client.AbstractTransaction$AssociatingSynchronization@6473b4fb
TRACE [com.arjuna.ats.jta] (default task-1) SynchronizationImple.afterCompletion - Class: class org.wildfly.transaction.client.provider.jboss.JBossLocalTransactionProvider$1 HashCode: 1429380276 toString: org.wildfly.transaction.client.provider.jboss.JBossLocalTransactionProvider$1@55329cb4
TRACE [com.arjuna.ats.arjuna] (default task-1) TransactionReaper::remove ( BasicAction: 0:ffff0a28050c:-a09a5fe:5c598d64:3b status: ActionStatus.COMMITTED )</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>It&#8217;s good to consider to follow with the thread id (in the log above it&#8217;s <code>default-task-1</code>).
The transaction could be suspended and started at the different thread
but it&#8217;s not usual.</p>
</li>
<li>
<p>The log shows the Narayana processes the two-phase commit. Bear in mind that the example above
shows only one resource to be part of the two-phase commit handling.
That&#8217;s intentional for the log not being too long.</p>
</li>
<li>
<p>the <code>section-1</code> refers to the point where the transaction is started. The
<a href="https://javaee.github.io/javaee-spec/javadocs/javax/transaction/Synchronization.html">JTA synchronizations</a>
are registered and the transaction is added to be handled by transaction reaper
(the transaction reaper is an independent thread taking care of transaction timeouts,
  see more at <a href="http://narayana.io/docs/project/index.html#d0e2032">section Transaction timeouts</a>
  in the Narayana documentation).</p>
</li>
<li>
<p>At this place consider the <code>BasicAction</code> (a Narayana abstraction for the transaction)
is identified by string <code>0:ffff0a28050c:-a09a5fe:5c598d64:3b</code>.
It refers to the transaction id. You can track it through the log and follow
what is happening with the particular transaction.</p>
</li>
<li>
<p>the <code>section-2</code> refers to the part of business logic processing. That&#8217;s the time
when a database insertion is run or Jakarta Messaging sends a message to a queue.
That&#8217;s where you spot message containing <code>enlistResource</code>. After the resource
is enlisted to the transaction the transaction manager saves a record
persistently under transaction log store.</p>
</li>
<li>
<p>the <code>section-3</code> refers to the time when the transaction is about to be committed.
That means all business logic was finished (that could be the time a method
annotated with <code>@Transactional</code> reached its end).</p>
</li>
<li>
<p>the <code>section-4</code> refers to the first phase of 2PC which is <em>prepare</em>. You can see
<code>XAResourceRecord.topLevelPrepare</code> informing what&#8217;s the global transaction id
(already defined at the start of the transaction) and the branch id
(particular to each resource). The resource is then prepared.</p>
</li>
<li>
<p>when whole prepare phase finishes Narayana saves the state into object store</p>
</li>
<li>
<p>the <code>section-5</code> refers to the second phase of 2PC which is <em>commit</em>. You can see
<code>XAResourceRecord.topLevelCommit</code> with similar information as for prepare.</p>
</li>
<li>
<p>the <code>section-6</code> shows the transaction is finished, information about the transaction
is removed from the Narayana object store and unregistered from the transaction reaper.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For more grained troubleshooting you can consider using
<a href="http://byteman.jboss.org">Byteman tool</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="transactions-configuration"><a class="anchor" href="#transactions-configuration"></a>11.4. Transactions configuration</h3>
<div class="paragraph">
<p>Configuration related to the behaviour of the Narayana transaction manager
is covered under <code>transactions</code> subsystem. For the details of the configuration
options please check the description in the transactions subsystem model
and see the <a href="http://narayana.io/documentation">Narayana documentation</a>.</p>
</div>
<div class="paragraph">
<p>To check the subsystem model you can use the <a href="wildscribe" target="_blank" rel="noopener">WildFly model reference</a>
or you can list all the configuration options of the subsystem in <code>jboss-cli</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">/subsystem=transactions:read-resource-description(recursive=true)</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
References in this document to CDI refer to Jakarta Contexts and Dependency Injection unless otherwise noted.
      References in this document to Java Transaction API(JTA) refer to Jakarta Transactions unless otherwise noted.
      References in this document to Enterprise JavaBeans(EJB) refer to the Jakarta Enterprise Beans unless otherwise noted.
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="JNDI_Reference"><a class="anchor" href="#JNDI_Reference"></a>12. JNDI Reference</h2>
<div class="sectionbody">
<div class="quoteblock abstract">
<blockquote>
WildFly offers several mechanisms to retrieve components by name. Every
WildFly instance has it&#8217;s own local JNDI namespace ( <code>java:</code>) which is
unique per JVM. The layout of this namespace is primarily governed by
the Jakarta EE specification. Applications which share the same WildFly
instance can use this namespace to intercommunicate. In addition to
local JNDI, a variety of mechanisms exist to access remote components.
</blockquote>
</div>
<div class="ulist">
<ul>
<li>
<p>Client JNDI - This is a mechanism by which remote components can be
accessed using the JNDI APIs, but <strong><em>without network round-trips</em></strong> . This
approach is the most efficient, and <strong><em>removes a potential single point
of failure</em></strong> . For this reason, it is highly recommended to use Client
JNDI over traditional remote JNDI access. However, to make this
possible, it does require that all names follow a strict layout, so user
customizations are not possible. Currently only access to remote Jakarta Enterprise Beans
are supported via the <code>ejb:</code> namespace. Future revisions will likely add a
Jakarta Messaging client JNDI namespace.</p>
</li>
<li>
<p>Traditional Remote JNDI - This is a more familiar approach to EE
application developers, where the client performs a remote component
name lookup against a server, and a proxy/stub to the component is
serialized as part of the name lookup and returned to the client. The
client then invokes a method on the proxy which results in another
remote network call to the underlying service. In a nutshell,
traditional remote JNDI involves two calls to invoke an EE component,
whereas Client JNDI requires one. It does however allow for customized
names, and for a centralised directory for multiple application servers.
This centralized directory is, however, <em>a single point of failure</em>.</p>
</li>
<li>
<p>EE Application Client / Server-To-Server Delegation - This approach is
where local names are bound as an <em>alias</em> to a remote name using one of
the above mechanisms. This is useful in that it allows applications to
only ever reference standard portable Jakarta EE names in both code and
deployment descriptors. It also allows for the application to be unaware
of network topology details/ This can even work with Java SE clients by
using the little known EE Application Client feature. This feature
allows you to run an extremely minimal AS server around your
application, so that you can take advantage of certain core services
such as naming and injection.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="JNDI_Local_Reference"><a class="anchor" href="#JNDI_Local_Reference"></a>13. Local JNDI</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The Jakarta EE platform specification defines the following JNDI contexts:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>java:comp</code> - The namespace is scoped to the current component (i.e.
Jakarta Enterprise Beans)</p>
</li>
<li>
<p><code>java:module</code> - Scoped to the current module</p>
</li>
<li>
<p><code>java:app</code> - Scoped to the current application</p>
</li>
<li>
<p><code>java:global</code> - Scoped to the application server</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In addition to the standard namespaces, WildFly also provides the
following two global namespaces:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>java:jboss</p>
</li>
<li>
<p>java:/</p>
</li>
</ul>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Only entries within the <code>java:jboss/exported</code> context are accessible
over remote JNDI.
</td>
</tr>
</table>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
For web deployments <code>java:comp</code> is aliased to <code>java:module</code>, so Jakarta Enterprise Beans&#8217;s
deployed in a war do not have their own comp namespace.
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="binding-entries-to-jndi"><a class="anchor" href="#binding-entries-to-jndi"></a>13.1. Binding entries to JNDI</h3>
<div class="paragraph">
<p>There are several methods that can be used to bind entries into JNDI in
WildFly.</p>
</div>
<div class="sect3">
<h4 id="using-a-deployment-descriptor"><a class="anchor" href="#using-a-deployment-descriptor"></a>13.1.1. Using a deployment descriptor</h4>
<div class="paragraph">
<p>For Jakarta EE applications the recommended way is to use a
<a href="#Deployment_Descriptors_used_In_WildFly">deployment descriptor</a> to create the binding. For
example the following <code>web.xml</code> binds the string <code>"Hello World"</code> to
<code>java:global/mystring</code> and the string <code>"Hello Module"</code> to
<code>java:comp/env/hello</code> (any non absolute JNDI name is relative to
<code>java:comp/env</code> context).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">&lt;web-app xmlns="http://xmlns.jcp.org/xml/ns/javaee"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://xmlns.jcp.org/xml/ns/javaee http://xmlns.jcp.org/xml/ns/javaee/web-app_3_1.xsd"
         version="3.1"&gt;
    &lt;env-entry&gt;
        &lt;env-entry-name&gt;java:global/mystring&lt;/env-entry-name&gt;
        &lt;env-entry-type&gt;java.lang.String&lt;/env-entry-type&gt;
        &lt;env-entry-value&gt;Hello World&lt;/env-entry-value&gt;
    &lt;/env-entry&gt;
    &lt;env-entry&gt;
        &lt;env-entry-name&gt;hello&lt;/env-entry-name&gt;
        &lt;env-entry-type&gt;java.lang.String&lt;/env-entry-type&gt;
        &lt;env-entry-value&gt;Hello Module&lt;/env-entry-value&gt;
    &lt;/env-entry&gt;
&lt;/web-app&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>For more details, see the <a href="http://jcp.org/en/jsr/detail?id=342">Java EE
Platform Specification</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="programmatically"><a class="anchor" href="#programmatically"></a>13.1.2. Programmatically</h4>
<div class="sect4">
<h5 id="java-ee-applications"><a class="anchor" href="#java-ee-applications"></a>Jakarta EE Applications</h5>
<div class="paragraph">
<p>Standard Jakarta EE applications may use the standard JNDI API, included
with Java SE, to bind entries in the global namespaces (the standard
<code>java:comp</code>, <code>java:module</code> and <code>java:app</code> namespaces are read-only, as
mandated by the Jakarta EE Platform Specification).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">  InitialContext initialContext = new InitialContext();
  initialContext.bind("java:global/a", 100);</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
There is no need to unbind entries created programmatically, since
WildFly tracks which bindings belong to a deployment, and the bindings
are automatically removed when the deployment is undeployed.
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="wildfly-modules-and-extensions"><a class="anchor" href="#wildfly-modules-and-extensions"></a>WildFly Modules and Extensions</h5>
<div class="paragraph">
<p>With respect to code in WildFly Modules/Extensions, which is executed
out of a Jakarta EE application context, using the standard JNDI API may
result in a UnsupportedOperationException if the target namespace uses a
WritableServiceBasedNamingStore. To work around that, the bind()
invocation needs to be wrapped using WildFly proprietary APIs:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">  InitialContext initialContext = new InitialContext();
  WritableServiceBasedNamingStore.pushOwner(serviceTarget);
  try {
    initialContext.bind("java:global/a", 100);
  } finally {
    WritableServiceBasedNamingStore.popOwner();
  }</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
The ServiceTarget removes the bind when uninstalled, thus using one out
of the module/extension domain usage should be avoided, unless entries
are removed using unbind().
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect3">
<h4 id="naming-subsystem-configuration"><a class="anchor" href="#naming-subsystem-configuration"></a>13.1.3. Naming Subsystem Configuration</h4>
<div class="paragraph">
<p>It is also possible to bind to one of the three global namespaces using
configuration in the naming subsystem. This can be done by either
editing the <code>standalone.xml/domain.xml</code> file directly, or through the
management API.</p>
</div>
<div class="paragraph">
<p>Four different types of bindings are supported:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Simple - A primitive or java.net.URL entry (default is
<code>java.lang.String</code>).</p>
</li>
<li>
<p>Object Factory - This allows to specify the
<code>javax.naming.spi.ObjectFactory</code> that is used to create the looked up
value.</p>
</li>
<li>
<p>External Context - An external context to federate, such as an LDAP
Directory Service</p>
</li>
<li>
<p>Lookup - The allows to create JNDI aliases, when this entry is looked
up it will lookup the target and return the result.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>An example standalone.xml might look like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">&lt;subsystem xmlns="urn:jboss:domain:naming:2.0" &gt;
  &lt;bindings&gt;
    &lt;simple name="java:global/a" value="100" type="int" /&gt;
    &lt;simple name="java:global/jbossDocs" value="https://docs.jboss.org" type="java.net.URL" /&gt;
    &lt;object-factory name="java:global/b" module="com.acme" class="org.acme.MyObjectFactory" /&gt;
    &lt;external-context name="java:global/federation/ldap/example" class="javax.naming.directory.InitialDirContext" cache="true"&gt;
      &lt;environment&gt;
        &lt;property name="java.naming.factory.initial" value="com.sun.jndi.ldap.LdapCtxFactory" /&gt;
        &lt;property name="java.naming.provider.url" value="ldap://ldap.example.com:389" /&gt;
        &lt;property name="java.naming.security.authentication" value="simple" /&gt;
        &lt;property name="java.naming.security.principal" value="uid=admin,ou=system" /&gt;
        &lt;property name="java.naming.security.credentials" value="secret" /&gt;
      &lt;/environment&gt;
    &lt;/external-context&gt;
    &lt;lookup name="java:global/c" lookup="java:global/b" /&gt;
 &lt;/bindings&gt;
&lt;/subsystem&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The CLI may also be used to bind an entry. As an example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">/subsystem=naming/binding=java\:global\/mybinding:add(binding-type=simple, type=long, value=1000)</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
WildFly&#8217;s Administrator Guide includes a section describing in detail
the Naming subsystem configuration.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="retrieving-entries-from-jndi"><a class="anchor" href="#retrieving-entries-from-jndi"></a>13.2. Retrieving entries from JNDI</h3>
<div class="sect3">
<h4 id="resource-injection"><a class="anchor" href="#resource-injection"></a>13.2.1. Resource Injection</h4>
<div class="paragraph">
<p>For Jakarta EE applications the recommended way to lookup a JNDI entry is
to use <code>@Resource</code> injection:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">  @Resource(lookup = "java:global/mystring")
  private String myString;

  @Resource(name = "hello")
  private String hello;

  @Resource
  ManagedExecutorService executor;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that <code>@Resource</code> is more than a JNDI lookup, it also binds an entry
in the component&#8217;s JNDI environment. The new bind JNDI name is defined
by <code>@Resource&#8217;s `name</code> attribute, which value, if unspecified, is the
Java type concatenated with <code>/</code> and the field&#8217;s name, for instance
<code>java.lang.String/myString</code>. More, similar to when using deployment
descriptors to bind JNDI entries. unless the name is an absolute JNDI
name, it is considered relative to <code>java:comp/env</code>. For instance, with
respect to the field named <code>myString</code> above, the <code>@Resource&#8217;s `lookup</code>
attribute instructs WildFly to lookup the value in
<code>java:global/mystring</code>, bind it in
<code>java:comp/env/java.lang.String/myString</code>, and then inject such value
into the field.</p>
</div>
<div class="paragraph">
<p>With respect to the field named <code>hello</code>, there is no <code>lookup</code> attribute
value defined, so the responsibility to provide the entry&#8217;s value is
delegated to the deployment descriptor. Considering that the deployment
descriptor was the <code>web.xml</code> previously shown, which defines an
environment entry with same <code>hello</code> name, then WildFly inject the valued
defined in the deployment descriptor into the field.</p>
</div>
<div class="paragraph">
<p>The <code>executor</code> field has no attributes specified, so the bind&#8217;s name
would default to
<code>java:comp/env/javax.enterprise.concurrent.ManagedExecutorService/executor</code>,
but there is no such entry in the deployment descriptor, and when that
happens it&#8217;s up to WildFly to provide a default value or null, depending
on the field&#8217;s Java type. In this particular case WildFly would inject
the default instance of a managed executor service, the value in
<code>java:comp/DefaultManagedExecutorService</code>, as mandated by the EE
Concurrency Utilities 1.0 Specification (JSR 236).</p>
</div>
</div>
<div class="sect3">
<h4 id="standard-java-se-jndi-api"><a class="anchor" href="#standard-java-se-jndi-api"></a>13.2.2. Standard Java SE JNDI API</h4>
<div class="paragraph">
<p>Jakarta EE applications may use, without any additional configuration
needed, the standard JNDI API to lookup an entry from JNDI:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">  String myString = (String) new InitialContext().lookup("java:global/mystring");</code></pre>
</div>
</div>
<div class="paragraph">
<p>or simply</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">  String myString = InitialContext.doLookup("java:global/mystring");</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="JNDI_Remote_Reference"><a class="anchor" href="#JNDI_Remote_Reference"></a>14. Remote JNDI Access</h2>
<div class="sectionbody">
<div class="paragraph">
<p>WildFly supports two different types of remote JNDI.</p>
</div>
<div class="sect2">
<h3 id="http-remoting"><a class="anchor" href="#http-remoting"></a>14.1. http-remoting:</h3>
<div class="paragraph">
<p>The <code>http-remoting:</code> protocol implementation is provided by JBoss Remote
Naming project, and uses http upgrade to lookup items from the servers
local JNDI. To use it, you must have the appropriate jars on the class
path, if you are maven user can be done simply by adding the following
to your <code>pom.xml</code> dependencies:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;dependency&gt;
  &lt;groupId&gt;org.wildfly&lt;/groupId&gt;
  &lt;artifactId&gt;wildfly-ejb-client-bom&lt;/artifactId&gt;
  &lt;version&gt;11.0.0.Final&lt;/version&gt;
  &lt;type&gt;pom&lt;/type&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you are not using maven a shaded jar that contains all required
classes<br>
can be found in the <code>bin/client</code> directory of WildFly&#8217;s distribution.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">final Properties env = new Properties();
env.put(Context.INITIAL_CONTEXT_FACTORY, "org.jboss.naming.remote.client.InitialContextFactory");
env.put(Context.PROVIDER_URL, "http-remoting://localhost:8080");
// the property below is required ONLY if there is no ejb client configuration loaded (such as a
// jboss-ejb-client.properties in the class path) and the context will be used to lookup EJBs
env.put("jboss.naming.client.ejb.context", true);
InitialContext remoteContext = new InitialContext(env);
RemoteCalculator ejb = (RemoteCalculator) remoteContext.lookup("wildfly-http-remoting-ejb/CalculatorBean!"
                + RemoteCalculator.class.getName());</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
The http-remoting client assumes JNDI names in remote lookups are
relative to java:jboss/exported namespace, a lookup of an absolute JNDI
name will fail.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="ejb"><a class="anchor" href="#ejb"></a>14.2. ejb:</h3>
<div class="paragraph">
<p>The ejb: namespace implementation is provided by the jboss-ejb-client
library, and allows the lookup of EJB&#8217;s using their application name,
module name, ejb name and interface type. To use it, you must have the
appropriate jars on the class path, if you are maven user can be done
simply by adding the following to your <code>pom.xml</code> dependencies:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;dependency&gt;
  &lt;groupId&gt;org.wildfly&lt;/groupId&gt;
  &lt;artifactId&gt;wildfly-ejb-client-bom&lt;/artifactId&gt;
  &lt;version&gt;11.0.0.Final&lt;/version&gt;
  &lt;type&gt;pom&lt;/type&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you are not using maven a shaded jar that contains all required
classes<br>
can be found in the <code>bin/client</code> directory of WildFly&#8217;s distribution.</p>
</div>
<div class="paragraph">
<p>This is a client side JNDI implementation. Instead of looking up an EJB
on the server the lookup name contains enough information for the client
side library to generate a proxy with the EJB information. When you
invoke a method on this proxy it will use the current EJB client context
to perform the invocation. If the current context does not have a
connection to a server with the specified EJB deployed then an error
will occur. Using this protocol it is possible to look up EJB&#8217;s that do
not actually exist, and no error will be thrown until the proxy is
actually used. The exception to this is stateful session beans, which
need to connect to a server when they are created in order to create the
session bean instance on the server.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">final Properties env = new Properties();
env.put(Context.URL_PKG_PREFIXES, "org.jboss.ejb.client.naming");
InitialContext remoteContext = new InitialContext(env);
MyRemoteInterface myRemote = (MyRemoteInterface) remoteContext.lookup("ejb:myapp/myejbjar/MyEjbName\!com.test.MyRemoteInterface");
MyStatefulRemoteInterface myStatefulRemote = (MyStatefulRemoteInterface) remoteContext.lookup("ejb:myapp/myejbjar/MyStatefulName\!comp.test.MyStatefulRemoteInterface?stateful");</code></pre>
</div>
</div>
<div class="paragraph">
<p>The first example is a lookup of a singleton, stateless or EJB 2.x home
interface. This lookup will not hit the server, instead a proxy will be
generated for the remote interface specified in the name. The second
example is for a stateful session bean, in this case the JNDI lookup
will hit the server, in order to tell the server to create the SFSB
session.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
For more details on how the server connections are configured, including
the <strong>required</strong> jboss ejb client setup, please see
<a href="#EJB_invocations_from_a_remote_client_using_JNDI">EJB invocations from a remote client using JNDI</a>.
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
References in this document to Enterprise JavaBeans(EJB) refer to the Jakarta Enterprise Beans unless otherwise noted.
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="Jakarta_RESTful_Web_Services_Reference_Guide"><a class="anchor" href="#Jakarta_RESTful_Web_Services_Reference_Guide"></a>15. Jakarta RESTful Web Services Reference Guide</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This page outlines the three options you have for deploying Jakarta RESTful Web Services
applications in WildFly 14. These three methods are specified in the
JAX-RS 2.0 specification in section 2.3.2.</p>
</div>
<div class="sect2">
<h3 id="subclassing-javax.ws.rs.core.application-and-using-applicationpath"><a class="anchor" href="#subclassing-javax.ws.rs.core.application-and-using-applicationpath"></a>15.1. Subclassing javax.ws.rs.core.Application and using @ApplicationPath</h3>
<div class="paragraph">
<p>This is the easiest way and does not require any xml configuration.
Simply include a subclass of <code>javax.ws.rs.core.Application</code> in your
application, and annotate it with the path that you want your JAX-RS
classes to be available. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">@ApplicationPath("/mypath")
public class MyApplication extends Application {
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This will make your Jakarta RESTful Web Services resources available under <code>/</code>
<code>mywebappcontext</code> <code>/mypath</code>.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Note that that the path is <code>/mypath</code> not <code>/mypath/*</code>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="subclassing-javax.ws.rs.core.application-and-using-web.xml"><a class="anchor" href="#subclassing-javax.ws.rs.core.application-and-using-web.xml"></a>15.2. Subclassing javax.ws.rs.core.Application and using web.xml</h3>
<div class="paragraph">
<p>If you do not wish to use <code>@ApplicationPath</code> but still need to subclass
<code>Application</code> you can set up the Jakarta RESTful Web Services mapping in web.xml:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">public class MyApplication extends Application {
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;servlet-mapping&gt;
   &lt;servlet-name&gt;com.acme.MyApplication&lt;/servlet-name&gt;
   &lt;url-pattern&gt;/hello/*&lt;/url-pattern&gt;
&lt;/servlet-mapping&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>This will make your Jakarta RESTful Web Services resources available under <code>/</code>
<code>mywebappcontext</code> <code>/hello</code>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
You can also use this approach to override an application path set with
the <code>@ApplicationPath</code> annotation.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="using-web.xml"><a class="anchor" href="#using-web.xml"></a>15.3. Using web.xml</h3>
<div class="paragraph">
<p>If you don&#8217;t wan&#8217;t to subclass <code>Application</code> you can set the Jakarta RESTful Web Services
mapping in web.xml as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;servlet-mapping&gt;
   &lt;servlet-name&gt;javax.ws.rs.core.Application&lt;/servlet-name&gt;
   &lt;url-pattern&gt;/hello/*&lt;/url-pattern&gt;
&lt;/servlet-mapping&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>This will make your Jakarta RESTful Web Services resources available under <code>/</code>
<code>mywebappcontext</code> <code>/hello</code>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Note that you only have to add the mapping, not the corresponding
servlet. The server is responsible for adding the corresponding servlet
automatically.
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
References in this document to Java API for RESTful Web Services(JAX-RS) refer to Jakarta RESTful Web Services unless otherwise noted.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>[[Web_(Undertow)_Reference_Guide]]
= Sharing sessions between wars in an ear</p>
</div>
<div class="paragraph">
<p>Undertow allows you to share sessions between wars in an ear, if it is
explicitly configured to do so. Note that if you use this feature your
applications may not be portable, as this is not a standard servlet
feature.</p>
</div>
<div class="paragraph">
<p>In order to enable this you must include a <code>shared-session-config</code>
element in the <code>jboss-all.xml</code> file in the META-INF directory of the
ear:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;jboss xmlns="urn:jboss:1.0"&gt;
    &lt;shared-session-config xmlns="urn:jboss:shared-session-config:2.0"&gt;
        &lt;session-config&gt;
            &lt;cookie-config&gt;
                &lt;path&gt;/&lt;/path&gt;
            &lt;/cookie-config&gt;
        &lt;/session-config&gt;
    &lt;/shared-session-config&gt;
&lt;/jboss&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>This element is used to configure the shared session manager that will
be used by all wars in the ear. For full details of all the options
provided by this file please see the schema at
<a href="https://github.com/wildfly/wildfly/blob/master/undertow/src/main/resources/schema/shared-session-config_2_0.xsd" class="bare">https://github.com/wildfly/wildfly/blob/master/undertow/src/main/resources/schema/shared-session-config_2_0.xsd</a>,
however in general it mimics the options that are available in
jboss-web.xml for configuring the session.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="Jakarta_XML_Web_Services_Reference_guide"><a class="anchor" href="#Jakarta_XML_Web_Services_Reference_guide"></a>16. Webservices reference guide</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The Web Services functionalities of WildFly are provided by the JBossWS
project integration.</p>
</div>
<div class="paragraph">
<p>The latest project documentation is available
<a href="https://docs.jboss.org/author/display/JBWS">here</a>.</p>
</div>
<div class="paragraph">
<p>This section covers the most relevant topics for the JBossWS version
available on WildFly 14.</p>
</div>
<div class="sect2">
<h3 id="Jakarta_XML_Web_Services_User_Guide"><a class="anchor" href="#Jakarta_XML_Web_Services_User_Guide"></a>16.1. Jakarta XML Web Services User Guide</h3>
<div class="paragraph">
<p>The <a href="http://www.jcp.org/en/jsr/detail?id=224">Java API for XML-Based Web
Services (JAX-WS / JSR-224)</a> defines the mapping between WSDL and Java
as well as the classes to be used for accessing webservices and
publishing them. JBossWS implements the latest JAX-WS specification,
hence users can reference it for any vendor agnostic webservice usage
need. Below is a brief overview of the most basic functionalities.</p>
</div>
<div class="sect3">
<h4 id="web-service-endpoints"><a class="anchor" href="#web-service-endpoints"></a>16.1.1. Web Service Endpoints</h4>
<div class="paragraph">
<p>Jakarta XML Web Services simplifies the development model for a web service endpoint a
great deal. In short, an endpoint implementation bean is annotated with
Jakarta XML Web Services annotations and deployed to the server. The server automatically
generates and publishes the abstract contract (i.e. wsdl+schema) for
client consumption. All marshalling/unmarshalling is delegated to
<a href="http://www.jcp.org/en/jsr/summary?id=jaxb">JAXB</a>.</p>
</div>
<div class="sect4">
<h5 id="plain-old-java-object-pojo"><a class="anchor" href="#plain-old-java-object-pojo"></a>Plain old Java Object (POJO)</h5>
<div class="paragraph">
<p>Let&#8217;s take a look at simple POJO endpoint implementation. All endpoint
associated metadata is provided via
<a href="http://www.jcp.org/en/jsr/summary?id=181">JSR-181</a> annotations</p>
</div>
<div class="literalblock">
<div class="content">
<pre>@WebService
@SOAPBinding(style = SOAPBinding.Style.RPC)
public class JSEBean01
{
   @WebMethod
   public String echo(String input)
   {
      ...
   }
}</pre>
</div>
</div>
<div class="sect5">
<h6 id="the-endpoint-as-a-web-application"><a class="anchor" href="#the-endpoint-as-a-web-application"></a>The endpoint as a web application</h6>
<div class="paragraph">
<p>A Jakarta XML Web Services java service endpoint (JSE) is deployed as a web application.
Here is a sample <em>web.xml</em> descriptor:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>&lt;web-app ...&gt;
  &lt;servlet&gt;
    &lt;servlet-name&gt;TestService&lt;/servlet-name&gt;
    &lt;servlet-class&gt;org.jboss.test.ws.jaxws.samples.jsr181pojo.JSEBean01&lt;/servlet-class&gt;
  &lt;/servlet&gt;
  &lt;servlet-mapping&gt;
    &lt;servlet-name&gt;TestService&lt;/servlet-name&gt;
    &lt;url-pattern&gt;/*&lt;/url-pattern&gt;
  &lt;/servlet-mapping&gt;
&lt;/web-app&gt;</pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="packaging-the-endpoint"><a class="anchor" href="#packaging-the-endpoint"></a>Packaging the endpoint</h6>
<div class="paragraph">
<p>A JSR-181 java service endpoint (JSE) is packaged as a web application
in a <em>war</em> file.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>&lt;war warfile="${build.dir}/libs/jbossws-samples-jsr181pojo.war" webxml="${build.resources.dir}/samples/jsr181pojo/WEB-INF/web.xml"&gt;
  &lt;classes dir="${build.dir}/classes"&gt;
    &lt;include name="org/jboss/test/ws/samples/jsr181pojo/JSEBean01.class"/&gt;
  &lt;/classes&gt;
&lt;/war&gt;</pre>
</div>
</div>
<div class="paragraph">
<p>Note, only the endpoint implementation bean and web.xml are required.</p>
</div>
</div>
<div class="sect5">
<h6 id="accessing-the-generated-wsdl"><a class="anchor" href="#accessing-the-generated-wsdl"></a>Accessing the generated WSDL</h6>
<div class="paragraph">
<p>A successfully deployed service endpoint will show up in the WildFly
managent console. You can get the deployed endpoint wsdl address there
too.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Note, it is also possible to generate the abstract contract off line
using JBossWS tools. For details of that please see Bottom-Up (Java to
WSDL).
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect4">
<h5 id="Jakarta-Enterprise-Beans-3-stateless-session-bean-slsb"><a class="anchor" href="#Jakarta-Enterprise-Beans-3-stateless-session-bean-slsb"></a>Jakarta Enterprise Beans 3 Stateless Session Bean (SLSB)</h5>
<div class="paragraph">
<p>The Jakarta XML Web Services programming model supports the same set of annotations on
Jakarta Enterprise Beans 3 stateless session beans as on POJO endpoints.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>@Stateless
@Remote(EJB3RemoteInterface.class)
@RemoteBinding(jndiBinding = "/ejb3/EJB3EndpointInterface")

@WebService
@SOAPBinding(style = SOAPBinding.Style.RPC)
public class EJB3Bean01 implements EJB3RemoteInterface
{
   @WebMethod
   public String echo(String input)
   {
      ...
   }
}</pre>
</div>
</div>
<div class="paragraph">
<p>Above you see an Enterprise Beans-3.0 stateless session bean that exposes one method
both on the remote interface and as an endpoint operation.</p>
</div>
<div class="sect5">
<h6 id="packaging-the-endpoint-1"><a class="anchor" href="#packaging-the-endpoint-1"></a>Packaging the endpoint</h6>
<div class="paragraph">
<p>A JSR-181 Jakarta Enterprise Beans service endpoint is packaged as an ordinary ejb
deployment.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>&lt;jar jarfile="${build.dir}/libs/jbossws-samples-jsr181ejb.jar"&gt;
  &lt;fileset dir="${build.dir}/classes"&gt;
    &lt;include name="org/jboss/test/ws/samples/jsr181ejb/EJB3Bean01.class"/&gt;
    &lt;include name="org/jboss/test/ws/samples/jsr181ejb/EJB3RemoteInterface.class"/&gt;
  &lt;/fileset&gt;
&lt;/jar&gt;</pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="accessing-the-generated-wsdl-1"><a class="anchor" href="#accessing-the-generated-wsdl-1"></a>Accessing the generated WSDL</h6>
<div class="paragraph">
<p>A successfully deployed service endpoint will show up in the WildFly
managent console. You can get the deployed endpoint wsdl address there
too.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Note, it is also possible to generate the abstract contract off line
using JBossWS tools. For details of that please see Bottom-Up (Java to
WSDL).
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect4">
<h5 id="endpoint-provider"><a class="anchor" href="#endpoint-provider"></a>Endpoint Provider</h5>
<div class="paragraph">
<p>Jakarta XML Web Services services typically implement a native Java service endpoint
interface (SEI), perhaps mapped from a WSDL port type, either directly
or via the use of annotations.</p>
</div>
<div class="paragraph">
<p>Java SEIs provide a high level Java-centric abstraction that hides the
details of converting between Java objects and their XML representations
for use in XML-based messages. However, in some cases it is desirable
for services to be able to operate at the XML message level. The
Provider interface offers an alternative to SEIs and may be implemented
by services wishing to work at the XML message level.</p>
</div>
<div class="paragraph">
<p>A Provider based service instances invoke method is called for each
message received for the service.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>@WebServiceProvider(wsdlLocation = "WEB-INF/wsdl/Provider.wsdl")
@ServiceMode(value = Service.Mode.PAYLOAD)
public class ProviderBeanPayload implements Provider&lt;Source&gt;
{
   public Source invoke(Source req)
   {
      // Access the entire request PAYLOAD and return the response PAYLOAD
   }
}</pre>
</div>
</div>
<div class="paragraph">
<p>Note, <code>Service.Mode.PAYLOAD</code> is the default and does not have to be
declared explicitly. You can also use <code>Service.Mode.MESSAGE</code> to access
the entire SOAP message (i.e. with <code>MESSAGE</code> the Provider can also see
SOAP Headers)</p>
</div>
<div class="paragraph">
<p>The abstract contract for a provider endpoint cannot be
derived/generated automatically. Therefore it is necessary to specify
the <em>wsdlLocation</em> with the <code>@</code> <code>WebServiceProvider</code> annotation.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="web-service-clients"><a class="anchor" href="#web-service-clients"></a>16.1.2. Web Service Clients</h4>
<div class="sect4">
<h5 id="service"><a class="anchor" href="#service"></a>Service</h5>
<div class="paragraph">
<p><code>Service</code> is an abstraction that represents a WSDL service. A WSDL
service is a collection of related ports, each of which consists of a
port type bound to a particular protocol and available at a particular
endpoint address.</p>
</div>
<div class="paragraph">
<p>For most clients, you will start with a set of stubs generated from the
WSDL. One of these will be the service, and you will create objects of
that class in order to work with the service (see "static case" below).</p>
</div>
<div class="sect5">
<h6 id="service-usage"><a class="anchor" href="#service-usage"></a>Service Usage</h6>
<div class="sect6">
<h7 id="static-case"><a class="anchor" href="#static-case"></a>Static case</h7>
<div class="paragraph">
<p>Most clients will start with a WSDL file, and generate some stubs using
JBossWS tools like <em>wsconsume</em>. This usually gives a mass of files, one
of which is the top of the tree. This is the service implementation
class.</p>
</div>
<div class="paragraph">
<p>The generated implementation class can be recognised as it will have two
public constructors, one with no arguments and one with two arguments,
representing the wsdl location (a <code>java.net.URL</code>) and the service name
(a <code>javax.xml.namespace.QName</code>) respectively.</p>
</div>
<div class="paragraph">
<p>Usually you will use the no-argument constructor. In this case the WSDL
location and service name are those found in the WSDL. These are set
implicitly from the <code>@WebServiceClient</code> annotation that decorates the
generated class.</p>
</div>
<div class="paragraph">
<p>The following code snippet shows the generated constructors from the
generated class:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>// Generated Service Class

@WebServiceClient(name="StockQuoteService", targetNamespace="http://example.com/stocks", wsdlLocation="http://example.com/stocks.wsdl")
public class StockQuoteService extends javax.xml.ws.Service
{
   public StockQuoteService()
   {
      super(new URL("http://example.com/stocks.wsdl"), new QName("http://example.com/stocks", "StockQuoteService"));
   }

   public StockQuoteService(String wsdlLocation, QName serviceName)
   {
      super(wsdlLocation, serviceName);
   }

   ...
}</pre>
</div>
</div>
<div class="paragraph">
<p>Section Dynamic Proxy explains how to obtain a port from the service and
how to invoke an operation on the port. If you need to work with the XML
payload directly or with the XML representation of the entire SOAP
message, have a look at <code>Dispatch</code>.</p>
</div>
</div>
<div class="sect6">
<h7 id="dynamic-case"><a class="anchor" href="#dynamic-case"></a>Dynamic case</h7>
<div class="paragraph">
<p>In the dynamic case, when nothing is generated, a web service client
uses <code>Service.create</code> to create Service instances, the following code
illustrates this process.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>URL wsdlLocation = new URL("http://example.org/my.wsdl");
QName serviceName = new QName("http://example.org/sample", "MyService");
Service service = Service.create(wsdlLocation, serviceName);</pre>
</div>
</div>
</div>
</div>
<div class="sect5">
<h6 id="handler-resolver"><a class="anchor" href="#handler-resolver"></a>Handler Resolver</h6>
<div class="paragraph">
<p>Jakarta XML Web Services provides a flexible plug-in framework for message processing
modules, known as handlers, that may be used to extend the capabilities
of a Jakarta XML Web Services runtime system. Handler Framework describes the handler
framework in detail. A Service instance provides access to a
<code>HandlerResolver</code> via a pair of <code>getHandlerResolver</code> /
<code>setHandlerResolver</code> methods that may be used to configure a set of
handlers on a per-service, per-port or per-protocol binding basis.</p>
</div>
<div class="paragraph">
<p>When a Service instance is used to create a proxy or a Dispatch instance
then the handler resolver currently registered with the service is used
to create the required handler chain. Subsequent changes to the handler
resolver configured for a Service instance do not affect the handlers on
previously created proxies, or Dispatch instances.</p>
</div>
</div>
<div class="sect5">
<h6 id="executor"><a class="anchor" href="#executor"></a>Executor</h6>
<div class="paragraph">
<p>Service instances can be configured with a
<code>java.util.concurrent.Executor</code>. The executor will then be used to
invoke any asynchronous callbacks requested by the application. The
<code>setExecutor</code> and <code>getExecutor</code> methods of <code>Service</code> can be used to
modify and retrieve the executor configured for a service.</p>
</div>
</div>
</div>
<div class="sect4">
<h5 id="dynamic-proxy"><a class="anchor" href="#dynamic-proxy"></a>Dynamic Proxy</h5>
<div class="paragraph">
<p>You can create an instance of a client proxy using one of <code>getPort</code>
methods on the <code>Service</code>.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>/**
 * The getPort method returns a proxy. A service client
 * uses this proxy to invoke operations on the target
 * service endpoint. The &lt;code&gt;serviceEndpointInterface&lt;/code&gt;
 * specifies the service endpoint interface that is supported by
 * the created dynamic proxy instance.
 **/
public &lt;T&gt; T getPort(QName portName, Class&lt;T&gt; serviceEndpointInterface)
{
   ...
}

/**
 * The getPort method returns a proxy. The parameter
 * &lt;code&gt;serviceEndpointInterface&lt;/code&gt; specifies the service
 * endpoint interface that is supported by the returned proxy.
 * In the implementation of this method, the Jakarta XML Web Services
 * runtime system takes the responsibility of selecting a protocol
 * binding (and a port) and configuring the proxy accordingly.
 * The returned proxy should not be reconfigured by the client.
 *
 **/
public &lt;T&gt; T getPort(Class&lt;T&gt; serviceEndpointInterface)
{
   ...
}</pre>
</div>
</div>
<div class="paragraph">
<p>The service endpoint interface (SEI) is usually generated using tools.
For details see Top Down (WSDL to Java)</p>
</div>
<div class="paragraph">
<p>A generated static Service usually also offers typed methods to get
ports. These methods also return dynamic proxies that implement the SEI.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>@WebServiceClient(name = "TestEndpointService", targetNamespace = "http://org.jboss.ws/wsref",
   wsdlLocation = "http://localhost.localdomain:8080/jaxws-samples-webserviceref?wsdl")

public class TestEndpointService extends Service
{
    ...

    public TestEndpointService(URL wsdlLocation, QName serviceName) {
        super(wsdlLocation, serviceName);
    }

    @WebEndpoint(name = "TestEndpointPort")
    public TestEndpoint getTestEndpointPort()
    {
        return (TestEndpoint)super.getPort(TESTENDPOINTPORT, TestEndpoint.class);
    }
}</pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="webserviceref"><a class="anchor" href="#webserviceref"></a>WebServiceRef</h5>
<div class="paragraph">
<p>The <code>@WebServiceRef</code> annotation is used to declare a reference to a Web
service. It follows the resource pattern exemplified by the
<code>javax.annotation.Resource</code> annotation in
<a href="http://www.jcp.org/en/jsr/summary?id=250">JSR-250</a>.</p>
</div>
<div class="paragraph">
<p>There are two uses to the WebServiceRef annotation:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>To define a reference whose type is a generated service class. In
this case, the type and value element will both refer to the generated
service class type. Moreover, if the reference type can be inferred by
the field/method declaration the annotation is applied to, the type and
value elements MAY have the default value (Object.class, that is). If
the type cannot be inferred, then at least the type element MUST be
present with a non-default value.</p>
</li>
<li>
<p>To define a reference whose type is a SEI. In this case, the type
element MAY be present with its default value if the type of the
reference can be inferred from the annotated field/method declaration,
but the value element MUST always be present and refer to a generated
service class type (a subtype of javax.xml.ws.Service). The wsdlLocation
element, if present, overrides theWSDL location information specified in
the WebService annotation of the referenced generated service class.</p>
<div class="literalblock">
<div class="content">
<pre>public class EJB3Client implements EJB3Remote
{
   @WebServiceRef
   public TestEndpointService service4;

   @WebServiceRef
   public TestEndpoint port3;</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect4">
<h5 id="dispatch"><a class="anchor" href="#dispatch"></a>Dispatch</h5>
<div class="paragraph">
<p>XMLWeb Services use XML messages for communication between services and
service clients. The higher level Jakarta XML Web Services APIs are designed to hide the
details of converting between Java method invocations and the
corresponding XML messages, but in some cases operating at the XML
message level is desirable. The Dispatch interface provides support for
this mode of interaction.</p>
</div>
<div class="paragraph">
<p><code>Dispatch</code> supports two usage modes, identified by the constants
<code>javax.xml.ws.Service.Mode.MESSAGE</code> and
<code>javax.xml.ws.Service.Mode.PAYLOAD</code> respectively:</p>
</div>
<div class="paragraph">
<p><strong><em>Message</em></strong> In this mode, client applications work directly with
protocol-specific message structures. E.g., when used with a SOAP
protocol binding, a client application would work directly with a SOAP
message.</p>
</div>
<div class="paragraph">
<p><strong><em>Message Payload</em></strong> In this mode, client applications work with the
payload of messages rather than the messages themselves. E.g., when used
with a SOAP protocol binding, a client application would work with the
contents of the SOAP Body rather than the SOAP message as a whole.</p>
</div>
<div class="paragraph">
<p>Dispatch is a low level API that requires clients to construct messages
or message payloads as XML and requires an intimate knowledge of the
desired message or payload structure. Dispatch is a generic class that
supports input and output of messages or message payloads of any type.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>Service service = Service.create(wsdlURL, serviceName);
Dispatch dispatch = service.createDispatch(portName, StreamSource.class, Mode.PAYLOAD);

String payload = "&lt;ns1:ping xmlns:ns1='http://oneway.samples.jaxws.ws.test.jboss.org/'/&gt;";
dispatch.invokeOneWay(new StreamSource(new StringReader(payload)));

payload = "&lt;ns1:feedback xmlns:ns1='http://oneway.samples.jaxws.ws.test.jboss.org/'/&gt;";
Source retObj = (Source)dispatch.invoke(new StreamSource(new StringReader(payload)));</pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="asynchronous-invocations"><a class="anchor" href="#asynchronous-invocations"></a>Asynchronous Invocations</h5>
<div class="paragraph">
<p>The <code>BindingProvider</code> interface represents a component that provides a
protocol binding for use by clients, it is implemented by proxies and is
extended by the <code>Dispatch</code> interface.</p>
</div>
<div class="paragraph">
<p><code>BindingProvider</code> instances may provide asynchronous operation
capabilities. When used, asynchronous operation invocations are
decoupled from the <code>BindingProvider</code> instance at invocation time such
that the response context is not updated when the operation completes.
Instead a separate response context is made available using the
<code>Response</code> interface.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>public void testInvokeAsync() throws Exception
{
   URL wsdlURL = new URL("http://" + getServerHost() + ":8080/jaxws-samples-asynchronous?wsdl");
   QName serviceName = new QName(targetNS, "TestEndpointService");
   Service service = Service.create(wsdlURL, serviceName);
   TestEndpoint port = service.getPort(TestEndpoint.class);
   Response response = port.echoAsync("Async");
   // access future
   String retStr = (String) response.get();
   assertEquals("Async", retStr);
}</pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="oneway-invocations"><a class="anchor" href="#oneway-invocations"></a>Oneway Invocations</h5>
<div class="paragraph">
<p><code>@Oneway</code> indicates that the given web method has only an input message
and no output. Typically, a oneway method returns the thread of control
to the calling application prior to executing the actual business
method.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>@WebService (name="PingEndpoint")
@SOAPBinding(style = SOAPBinding.Style.RPC)
public class PingEndpointImpl
{
   private static String feedback;

   @WebMethod
   @Oneway
   publicvoid ping()
   {
      log.info("ping");
      feedback = "ok";
   }

   @WebMethod
   public String feedback()
   {
      log.info("feedback");
      return feedback;
   }
}</pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="timeout-configuration"><a class="anchor" href="#timeout-configuration"></a>Timeout Configuration</h5>
<div class="paragraph">
<p>There are two properties to configure the http connection timeout and
client receive time out:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>public void testConfigureTimeout() throws Exception
{
   //Set timeout until a connection is established
   ((BindingProvider)port).getRequestContext().put("javax.xml.ws.client.connectionTimeout", "6000");

   //Set timeout until the response is received
   ((BindingProvider) port).getRequestContext().put("javax.xml.ws.client.receiveTimeout", "1000");

   port.echo("testTimeout");
}</pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="common-api"><a class="anchor" href="#common-api"></a>16.1.3. Common API</h4>
<div class="paragraph">
<p>This sections describes concepts that apply equally to Web Service
Endpoints and Web Service Clients.</p>
</div>
<div class="sect4">
<h5 id="handler-framework"><a class="anchor" href="#handler-framework"></a>Handler Framework</h5>
<div class="paragraph">
<p>The handler framework is implemented by a Jakarta XML Web Services protocol binding in
both client and server side runtimes. Proxies, and Dispatch instances,
known collectively as binding providers, each use protocol bindings to
bind their abstract functionality to specific protocols.</p>
</div>
<div class="paragraph">
<p>Client and server-side handlers are organized into an ordered list known
as a handler chain. The handlers within a handler chain are invoked each
time a message is sent or received. Inbound messages are processed by
handlers prior to binding provider processing. Outbound messages are
processed by handlers after any binding provider processing.</p>
</div>
<div class="paragraph">
<p>Handlers are invoked with a message context that provides methods to
access and modify inbound and outbound messages and to manage a set of
properties. Message context properties may be used to facilitate
communication between individual handlers and between handlers and
client and service implementations. Different types of handlers are
invoked with different types of message context.</p>
</div>
<div class="sect5">
<h6 id="logical-handler"><a class="anchor" href="#logical-handler"></a>Logical Handler</h6>
<div class="paragraph">
<p>Handlers that only operate on message context properties and message
payloads. Logical handlers are protocol agnostic and are unable to
affect protocol specific parts of a message. Logical handlers are
handlers that implement <code>javax.xml.ws.handler.LogicalHandler</code>.</p>
</div>
</div>
<div class="sect5">
<h6 id="protocol-handler"><a class="anchor" href="#protocol-handler"></a>Protocol Handler</h6>
<div class="paragraph">
<p>Handlers that operate on message context properties and protocol
specific messages. Protocol handlers are specific to a particular
protocol and may access and change protocol specific aspects of a
message. Protocol handlers are handlers that implement any interface
derived from <code>javax.xml.ws.handler.Handler</code> except
<code>javax.xml.ws.handler.LogicalHandler</code>.</p>
</div>
</div>
<div class="sect5">
<h6 id="service-endpoint-handlers"><a class="anchor" href="#service-endpoint-handlers"></a>Service endpoint handlers</h6>
<div class="paragraph">
<p>On the service endpoint, handlers are defined using the <code>@HandlerChain</code>
annotation.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>@WebService
@HandlerChain(file = "jaxws-server-source-handlers.xml")
public class SOAPEndpointSourceImpl
{
   ...
}</pre>
</div>
</div>
<div class="paragraph">
<p>The location of the handler chain file supports 2 formats</p>
</div>
<div class="paragraph">
<p>\1. An absolute java.net.URL in externalForm. (ex:
<a href="http://myhandlers.foo.com/handlerfile1.xml" class="bare">http://myhandlers.foo.com/handlerfile1.xml</a>)</p>
</div>
<div class="paragraph">
<p>\2. A relative path from the source file or class file. (ex:
bar/handlerfile1.xml)</p>
</div>
</div>
<div class="sect5">
<h6 id="service-client-handlers"><a class="anchor" href="#service-client-handlers"></a>Service client handlers</h6>
<div class="paragraph">
<p>On the client side, handler can be configured using the <code>@HandlerChain</code>
annotation on the SEI or dynamically using the API.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>Service service = Service.create(wsdlURL, serviceName);
Endpoint port = (Endpoint)service.getPort(Endpoint.class);

BindingProvider bindingProvider = (BindingProvider)port;
List&lt;Handler&gt; handlerChain = new ArrayList&lt;Handler&gt;();
handlerChain.add(new LogHandler());
handlerChain.add(new AuthorizationHandler());
handlerChain.add(new RoutingHandler());
bindingProvider.getBinding().setHandlerChain(handlerChain); // important!</pre>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="message-context"><a class="anchor" href="#message-context"></a>Message Context</h5>
<div class="paragraph">
<p><code>MessageContext</code> is the super interface for all Jakarta XML Web Services message contexts.
It extends <code>Map&lt;String,Object&gt;</code> with additional methods and constants to
manage a set of properties that enable handlers in a handler chain to
share processing related state. For example, a handler may use the put
method to insert a property in the message context that one or more
other handlers in the handler chain may subsequently obtain via the get
method.</p>
</div>
<div class="paragraph">
<p>Properties are scoped as either APPLICATION or HANDLER. All properties
are available to all handlers for an instance of an MEP on a particular
endpoint. E.g., if a logical handler puts a property in the message
context, that property will also be available to any protocol handlers
in the chain during the execution of an MEP instance. APPLICATION scoped
properties are also made available to client applications (see section
4.2.1) and service endpoint implementations. The defaultscope for a
property is HANDLER.</p>
</div>
<div class="sect5">
<h6 id="logical-message-context"><a class="anchor" href="#logical-message-context"></a>Logical Message Context</h6>
<div class="paragraph">
<p>Logical Handlers are passed a message context of type
<code>LogicalMessageContext</code> when invoked. <code>LogicalMessageContext</code> extends
<code>MessageContext</code> with methods to obtain and modify the message payload,
it does not provide access to the protocol specific aspects of amessage.
A protocol binding defines what component of a message are available via
a logical message context. The SOAP binding defines that a logical
handler deployed in a SOAP binding can access the contents of the SOAP
body but not the SOAP headers whereas the XML/HTTP binding defines that
a logical handler can access the entire XML payload of a message.</p>
</div>
</div>
<div class="sect5">
<h6 id="soap-message-context"><a class="anchor" href="#soap-message-context"></a>SOAP Message Context</h6>
<div class="paragraph">
<p>SOAP handlers are passed a <code>SOAPMessageContext</code> when invoked.
<code>SOAPMessageContext</code> extends <code>MessageContext</code> with methods to obtain and
modify the SOAP message payload.</p>
</div>
</div>
</div>
<div class="sect4">
<h5 id="fault-handling"><a class="anchor" href="#fault-handling"></a>Fault Handling</h5>
<div class="paragraph">
<p>An implementation may thow a <code>SOAPFaultException</code></p>
</div>
<div class="literalblock">
<div class="content">
<pre>public void throwSoapFaultException()
{
   SOAPFactory factory = SOAPFactory.newInstance();
   SOAPFault fault = factory.createFault("this is a fault string!", new QName("http://foo", "FooCode"));
   fault.setFaultActor("mr.actor");
   fault.addDetail().addChildElement("test");
   thrownew SOAPFaultException(fault);
}</pre>
</div>
</div>
<div class="paragraph">
<p>or an application specific user exception</p>
</div>
<div class="literalblock">
<div class="content">
<pre>public void throwApplicationException() throws UserException
{
   thrownew UserException("validation", 123, "Some validation error");
}</pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
In case of the latter, JBossWS generates the required fault wrapper
beans at runtime if they are not part of the deployment
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect3">
<h4 id="Jakarta-XML-Web-Services-annotations"><a class="anchor" href="#Jakarta-XML-Web-Services-annotations"></a>16.1.4. Jakarta XML Web Services Annotations</h4>
<div class="paragraph">
<p>For details, see <a href="http://www.jcp.org/en/jsr/detail?id=224">JSR-224 - Java
API for XML-Based Web Services (JAX-WS) 2.2</a></p>
</div>
<div class="sect4">
<h5 id="javax.xml.ws.servicemode"><a class="anchor" href="#javax.xml.ws.servicemode"></a>javax.xml.ws.ServiceMode</h5>
<div class="paragraph">
<p>The <code>ServiceMode</code> annotation is used to specify the mode for a provider
class, i.e. whether a provider wants to have access to protocol message
payloads (e.g. a SOAP body) or the entire protocol messages (e.g. a SOAP
envelope).</p>
</div>
</div>
<div class="sect4">
<h5 id="javax.xml.ws.webfault"><a class="anchor" href="#javax.xml.ws.webfault"></a>javax.xml.ws.WebFault</h5>
<div class="paragraph">
<p>The <code>WebFault</code> annotation is used when mapping WSDL faults to Java
exceptions, see section 2.5. It is used to capture the name of the fault
element used when marshalling the Jakarta XML Binding type generated from the global
element referenced by the WSDL fault message. It can also be used to
customize the mapping of service specific exceptions to WSDL faults.</p>
</div>
</div>
<div class="sect4">
<h5 id="javax.xml.ws.requestwrapper"><a class="anchor" href="#javax.xml.ws.requestwrapper"></a>javax.xml.ws.RequestWrapper</h5>
<div class="paragraph">
<p>The <code>RequestWrapper</code> annotation is applied to the methods of an SEI. It
is used to capture the Jakarta XML Binding generated request wrapper bean and the
element name and namespace for marshalling / unmarshalling the bean. The
default value of localName element is the operationName as defined in
<code>WebMethod</code> annotation and the default value for the targetNamespace
element is the target namespace of the SEI.When starting from Java, this
annotation is used to resolve overloading conflicts in document literal
mode. Only the className element is required in this case.</p>
</div>
</div>
<div class="sect4">
<h5 id="javax.xml.ws.responsewrapper"><a class="anchor" href="#javax.xml.ws.responsewrapper"></a>javax.xml.ws.ResponseWrapper</h5>
<div class="paragraph">
<p>The <code>ResponseWrapper</code> annotation is applied to the methods of an SEI. It
is used to capture the Jakarta XML Binding generated response wrapper bean and the
element name and namespace for marshalling / unmarshalling the bean. The
default value of the localName element is the operationName as defined
in the <code>WebMethod</code> appended with "Response" and the default value of the
targetNamespace element is the target namespace of the SEI. When
starting from Java, this annotation is used to resolve overloading
conflicts in document literal mode. Only the className element is
required in this case.</p>
</div>
</div>
<div class="sect4">
<h5 id="javax.xml.ws.webserviceclient"><a class="anchor" href="#javax.xml.ws.webserviceclient"></a>javax.xml.ws.WebServiceClient</h5>
<div class="paragraph">
<p>The <code>WebServiceClient</code> annotation is specified on a generated service
class (see 2.7). It is used to associate a class with a specific Web
service, identify by a URL to a WSDL document and the qualified name of
a wsdl:service element.</p>
</div>
</div>
<div class="sect4">
<h5 id="javax.xml.ws.webendpoint"><a class="anchor" href="#javax.xml.ws.webendpoint"></a>javax.xml.ws.WebEndpoint</h5>
<div class="paragraph">
<p>The <code>WebEndpoint</code> annotation is specified on the getPortName() methods
of a generated service class (see 2.7). It is used to associate a get
method with a specific wsdl:port, identified by its local name (a
NCName).</p>
</div>
</div>
<div class="sect4">
<h5 id="javax.xml.ws.webserviceprovider"><a class="anchor" href="#javax.xml.ws.webserviceprovider"></a>javax.xml.ws.WebServiceProvider</h5>
<div class="paragraph">
<p>The <code>WebServiceProvider</code> annotation is specified on classes that
implement a strongly typed <code>javax.xml.ws.Provider</code>. It is used to
declare that a class that satisfies the requirements for a provider (see
5.1) does indeed define a Web service endpoint, much like the
<code>WebService</code> annotation does for SEI-based endpoints.</p>
</div>
<div class="paragraph">
<p>The <code>WebServiceProvider</code> and <code>WebService</code> annotations are mutually
exclusive.</p>
</div>
</div>
<div class="sect4">
<h5 id="javax.xml.ws.bindingtype"><a class="anchor" href="#javax.xml.ws.bindingtype"></a>javax.xml.ws.BindingType</h5>
<div class="paragraph">
<p>The <code>BindingType</code> annotation is applied to an endpoint implementation
class. It specifies the binding to use when publishing an endpoint of
this type.</p>
</div>
<div class="paragraph">
<p>The default binding for an endpoint is the SOAP 1.1/HTTP one.</p>
</div>
</div>
<div class="sect4">
<h5 id="javax.xml.ws.webserviceref"><a class="anchor" href="#javax.xml.ws.webserviceref"></a>javax.xml.ws.WebServiceRef</h5>
<div class="paragraph">
<p>The <code>WebServiceRef</code> annotation is used to declare a reference to a Web
service. It follows the resource pattern exemplified by the
<code>javax.annotation.Resource</code> annotation in JSR-250 [JBWS:32]. The
<code>WebServiceRef</code> annotation is required to be honored when running on the
Jakarta EE platform, where it is subject to the common resource injection
rules described by the platform specification [JBWS:33].</p>
</div>
</div>
<div class="sect4">
<h5 id="javax.xml.ws.webservicerefs"><a class="anchor" href="#javax.xml.ws.webservicerefs"></a>javax.xml.ws.WebServiceRefs</h5>
<div class="paragraph">
<p>The <code>WebServiceRefs</code> annotation is used to declare multiple references
to Web services on a single class. It is necessary to work around the
limition against specifying repeated annotations of the same type on any
given class, which prevents listing multiple <code>javax.ws.WebServiceRef</code>
annotations one after the other. This annotation follows the resource
pattern exemplified by the <code>javax.annotation.Resources</code> annotation in
JSR-250.</p>
</div>
<div class="paragraph">
<p>Since no name and type can be inferred in this case, each
<code>WebServiceRef</code> annotation inside a WebServiceRefs MUST contain name and
type elements with non-default values. The <code>WebServiceRef</code> annotation is
required to be honored when running on the Jakarta EE platform, where it
is subject to the common resource injection rules described by the
platform specification.</p>
</div>
</div>
<div class="sect4">
<h5 id="javax.xml.ws.action"><a class="anchor" href="#javax.xml.ws.action"></a>javax.xml.ws.Action</h5>
<div class="paragraph">
<p>The <code>Action</code> annotation is applied to the methods of a SEI. It used to
generate the wsa:Action on wsdl:input and wsdl:output of each
wsdl:operation mapped from the annotated methods.</p>
</div>
</div>
<div class="sect4">
<h5 id="javax.xml.ws.faultaction"><a class="anchor" href="#javax.xml.ws.faultaction"></a>javax.xml.ws.FaultAction</h5>
<div class="paragraph">
<p>The <code>FaultAction</code> annotation is used within the <code>Action</code> annotation to
generate the wsa:Action element on the wsdl:fault element of each
wsdl:operation mapped from the annotated methods.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="jsr-181-annotations"><a class="anchor" href="#jsr-181-annotations"></a>16.1.5. JSR-181 Annotations</h4>
<div class="paragraph">
<p>JSR-181 defines the syntax and semantics of Java Web Service (JWS)
metadata and default values.</p>
</div>
<div class="paragraph">
<p>For details, see <a href="http://www.jcp.org/en/jsr/detail?id=181">JSR 181 - Web
Services Metadata for the Java Platform</a>.</p>
</div>
<div class="sect4">
<h5 id="javax.jws.webservice"><a class="anchor" href="#javax.jws.webservice"></a>javax.jws.WebService</h5>
<div class="paragraph">
<p>Marks a Java class as implementing a Web Service, or a Java interface as
defining a Web Service interface.</p>
</div>
</div>
<div class="sect4">
<h5 id="javax.jws.webmethod"><a class="anchor" href="#javax.jws.webmethod"></a>javax.jws.WebMethod</h5>
<div class="paragraph">
<p>Customizes a method that is exposed as a Web Service operation.</p>
</div>
</div>
<div class="sect4">
<h5 id="javax.jws.oneway"><a class="anchor" href="#javax.jws.oneway"></a>javax.jws.OneWay</h5>
<div class="paragraph">
<p>Indicates that the given web method has only an input message and no
output. Typically, a oneway method returns the thread of control to the
calling application prior to executing the actual business method. A
JSR-181 processor is REQUIRED to report an error if an operation marked
<code>@Oneway</code> has a return value, declares any checked exceptions or has any
INOUT or OUT parameters.</p>
</div>
</div>
<div class="sect4">
<h5 id="javax.jws.webparam"><a class="anchor" href="#javax.jws.webparam"></a>javax.jws.WebParam</h5>
<div class="paragraph">
<p>Customizes the mapping of an individual parameter to a Web Service
message part and XML element.</p>
</div>
</div>
<div class="sect4">
<h5 id="javax.jws.webresult"><a class="anchor" href="#javax.jws.webresult"></a>javax.jws.WebResult</h5>
<div class="paragraph">
<p>Customizes the mapping of the return value to a WSDL part and XML
element.</p>
</div>
</div>
<div class="sect4">
<h5 id="javax.jws.soapbinding"><a class="anchor" href="#javax.jws.soapbinding"></a>javax.jws.SOAPBinding</h5>
<div class="paragraph">
<p>Specifies the mapping of the Web Service onto the SOAP message protocol.</p>
</div>
<div class="paragraph">
<p>The <code>SOAPBinding</code> annotation has a target of <code>TYPE</code> and <code>METHOD</code>. The
annotation may be placed on a method if and only if the
<code>SOAPBinding.style</code> is <code>DOCUMENT</code>. Implementations MUST report an error
if the <code>SOAPBinding</code> annotation is placed on a method with a
<code>SOAPBinding.style</code> of <code>RPC</code>. Methods that do not have a <code>SOAPBinding</code>
annotation accept the <code>SOAPBinding</code> behavior defined on the type.</p>
</div>
</div>
<div class="sect4">
<h5 id="javax.jws.handlerchain"><a class="anchor" href="#javax.jws.handlerchain"></a>javax.jws.HandlerChain</h5>
<div class="paragraph">
<p>The <code>@HandlerChain</code> annotation associates the Web Service with an
externally defined handler chain.</p>
</div>
<div class="paragraph">
<p>It is an error to combine this annotation with the
<code>@SOAPMessageHandlers</code> annotation.</p>
</div>
<div class="paragraph">
<p>The <code>@HandlerChain</code> annotation MAY be present on the endpoint interface
and service implementation bean. The service implementation bean&#8217;s
<code>@HandlerChain</code> is used if <code>@HandlerChain</code> is present on both.</p>
</div>
<div class="paragraph">
<p>The <code>@HandlerChain</code> annotation MAY be specified on the type only. The
annotation target includes <code>METHOD</code> and <code>FIELD</code> for use by Jakarta XML Web Services Specification-2.x.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
References in this document to Java API for XML-Based Web Services(JAX-WS) refer to the Jakarta XML Web Services unless otherwise noted
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="Jakarta_XML_Web_Services_Tools"><a class="anchor" href="#Jakarta_XML_Web_Services_Tools"></a>16.2. Jakarta XML Web Services Tools</h3>
<div class="paragraph">
<p>The Jakarta XML Web Services tools provided by JBossWS can be used in a variety of ways.
First we will look at server-side development strategies, and then
proceed to the client.</p>
</div>
<div class="sect3">
<h4 id="server-side"><a class="anchor" href="#server-side"></a>16.2.1. Server side</h4>
<div class="paragraph">
<p>When developing a Web Service Endpoint (the server-side) you have the
option of starting from Java ( <em>bottom-up development</em>), or from the
abstact contract (WSDL) that defines your service ( <em>top-down
development</em>). If this is a new service (no existing contract), the
bottom-up approach is the fastest route; you only need to add a few
annotations to your classes to get a service up and running. However, if
you are developing a service with an already defined contract, it is far
simpler to use the top-down approach, since the provided tool will
generate the annotated code for you.</p>
</div>
<div class="paragraph">
<p>Bottom-up use cases:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Exposing an already existing Jakarta Enterprise Beans 3 bean as a Web Service</p>
</li>
<li>
<p>Providing a new service, and you want the contract to be generated for
you</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Top-down use cases:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Replacing the implementation of an existing Web Service, and you can&#8217;t
break compatibility with older clients</p>
</li>
<li>
<p>Exposing a service that conforms to a contract specified by a third
party (e.g. a vender that calls you back using an already defined
protocol).</p>
</li>
<li>
<p>Creating a service that adheres to the XML Schema and WSDL you
developed by hand up front</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The following Jakarta XML Web Services command line tools are included in JBossWS:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Command</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">wsprovide</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Generates Jakarta XML Web Services portable artifacts, and provides the
abstract contract. Used for bottom-up development.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">wsconsume</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Consumes the abstract contract (WSDL and Schema files), and
produces artifacts for both a server and client. Used for top-down and
client development</p></td>
</tr>
</tbody>
</table>
<div class="sect4">
<h5 id="bottom-up-using-wsprovide"><a class="anchor" href="#bottom-up-using-wsprovide"></a>Bottom-Up (Using wsprovide)</h5>
<div class="paragraph">
<p>The bottom-up strategy involves developing the Java code for your
service, and then annotating it using Jakarta XML Web Services annotations. These
annotations can be used to customize the contract that is generated for
your service. For example, you can change the operation name to map to
anything you like. However, all of the annotations have sensible
defaults, so only the @WebService annotation is required.</p>
</div>
<div class="paragraph">
<p>This can be as simple as creating a single class:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">package echo;

@javax.jws.WebService
public class Echo
{
   public String echo(String input)
   {
      return input;
   }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>A JSE or Jakarta Enterprise Beans 3 deployment can be built using this class, and it is the
only Java code needed to deploy on JBossWS. The WSDL, and all other Java
artifacts called "wrapper classes" will be generated for you at deploy
time. This actually goes beyond the Jakarta XML Web Services specification, which requires
that wrapper classes be generated using an offline tool. The reason for
this requirement is purely a vender implementation problem, and since we
do not believe in burdening a developer with a bunch of additional
steps, we generate these as well. However, if you want your deployment
to be portable to other application servers, you will unfortunately need
to use a tool and add the generated classes to your deployment.</p>
</div>
<div class="paragraph">
<p>This is the primary purpose of the <em>wsprovide</em> tool, to generate
portable Jakarta XML Web Services artifacts. Additionally, it can be used to "provide" the
abstract contract (WSDL file) for your service. This can be obtained by
invoking <em>wsprovide</em> using the "-w" option:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ javac -d . -classpath jboss-jaxws.jar Echo.java
$ wsprovide -w echo.Echo
Generating WSDL:
EchoService.wsdl
Writing Classes:
echo/jaxws/Echo.class
echo/jaxws/EchoResponse.class</pre>
</div>
</div>
<div class="paragraph">
<p>Inspecting the WSDL reveals a service called <em>EchoService</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;service name='EchoService'&gt;
 &lt;port binding='tns:EchoBinding' name='EchoPort'&gt;
  &lt;soap:address location='REPLACE_WITH_ACTUAL_URL'/&gt;
 &lt;/port&gt;
&lt;/service&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>As expected, this service defines one operation, " <em>echo</em>":</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;portType name='Echo'&gt;
 &lt;operation name='echo' parameterOrder='echo'&gt;
  &lt;input message='tns:Echo_echo'/&gt;
  &lt;output message='tns:Echo_echoResponse'/&gt;
 &lt;/operation&gt;
&lt;/portType&gt;</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Remember that when deploying on JBossWS you do not need to run this
tool. You only need it for generating portable artifacts and/or the
abstract contract for your service.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Let&#8217;s create a POJO endpoint for deployment on WildFly. A simple
<em>web.xml</em> needs to be created:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;web-app xmlns="http://java.sun.com/xml/ns/j2ee"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="http://java.sun.com/xml/ns/j2ee http://java.sun.com/xml/ns/j2ee/web-app_2_4.xsd"
  version="2.4"&gt;

  &lt;servlet&gt;
    &lt;servlet-name&gt;Echo&lt;/servlet-name&gt;
    &lt;servlet-class&gt;echo.Echo&lt;/servlet-class&gt;
  &lt;/servlet&gt;

  &lt;servlet-mapping&gt;
    &lt;servlet-name&gt;Echo&lt;/servlet-name&gt;
    &lt;url-pattern&gt;/Echo&lt;/url-pattern&gt;
  &lt;/servlet-mapping&gt;
&lt;/web-app&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <em>web.xml</em> and the single class can now be used to create a war:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ mkdir -p WEB-INF/classes
$ cp -rp echo WEB-INF/classes/
$ cp web.xml WEB-INF
$ jar cvf echo.war WEB-INF
added manifest
adding: WEB-INF/(in = 0) (out= 0)(stored 0%)
adding: WEB-INF/classes/(in = 0) (out= 0)(stored 0%)
adding: WEB-INF/classes/echo/(in = 0) (out= 0)(stored 0%)
adding: WEB-INF/classes/echo/Echo.class(in = 340) (out= 247)(deflated 27%)
adding: WEB-INF/web.xml(in = 576) (out= 271)(deflated 52%)</pre>
</div>
</div>
<div class="paragraph">
<p>The war can then be deployed to the JBoss Application Server.The war can
then be deployed to the JBoss Application Server; this will internally
invoke wsprovide, which will generate the WSDL. If deployment was
successful, and you are using the default settings, it should be
available in the server management console.</p>
</div>
<div class="paragraph">
<p>For a portable Jakarta XML Web Services deployment, the wrapper classes generated earlier
could be added to the deployment.</p>
</div>
</div>
<div class="sect4">
<h5 id="top-down-using-wsconsume"><a class="anchor" href="#top-down-using-wsconsume"></a>Top-Down (Using wsconsume)</h5>
<div class="paragraph">
<p>The top-down development strategy begins with the abstract contract for
the service, which includes the WSDL file and zero or more schema files.
The <em>wsconsume</em> tool is then used to consume this contract, and produce
annotated Java classes (and optionally sources) that define it.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
wsconsume may have problems with symlinks on Unix systems
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Using the WSDL file from the bottom-up example, a new Java
implementation that adheres to this service can be generated. The "-k"
option is passed to <em>wsconsume</em> to preserve the Java source files that
are generated, instead of providing just classes:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ wsconsume -k EchoService.wsdl
echo/Echo.java
echo/EchoResponse.java
echo/EchoService.java
echo/Echo_Type.java
echo/ObjectFactory.java
echo/package-info.java
echo/Echo.java
echo/EchoResponse.java
echo/EchoService.java
echo/Echo_Type.java
echo/ObjectFactory.java
echo/package-info.java</pre>
</div>
</div>
<div class="paragraph">
<p>The following table shows the purpose of each generated file:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">File</th>
<th class="tableblock halign-left valign-top">Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Echo.java</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Service Endpoint Interface</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Echo_Type.java</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Wrapper bean for request message</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">EchoResponse.java</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Wrapper bean for response message</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ObjectFactory.java</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Jakarta XML Binding XML Registry</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">package-info.java</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Holder for Jakarta XML Binding package annotations</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">EchoService.java</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Used only by Jakarta XML Web Services clients</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Examining the Service Endpoint Interface reveals annotations that are
more explicit than in the class written by hand in the bottom-up
example, however, these evaluate to the same contract:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">@WebService(name = "Echo", targetNamespace = "http://echo/")
public interface Echo {
    @WebMethod
    @WebResult(targetNamespace = "")
    @RequestWrapper(localName = "echo", targetNamespace = "http://echo/", className = "echo.Echo_Type")
    @ResponseWrapper(localName = "echoResponse", targetNamespace = "http://echo/", className = "echo.EchoResponse")
    public String echo(
        @WebParam(name = "arg0", targetNamespace = "")
        String arg0);

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The only missing piece (besides for packaging) is the implementation
class, which can now be written, using the above interface.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">package echo;

@javax.jws.WebService(endpointInterface="echo.Echo")
public class EchoImpl implements Echo
{
   public String echo(String arg0)
   {
      return arg0;
   }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="client-side"><a class="anchor" href="#client-side"></a>16.2.2. Client Side</h4>
<div class="paragraph">
<p>Before going to detail on the client-side it is important to understand
the decoupling concept that is central to Web Services. Web Services are
not the best fit for internal RPC, even though they can be used in this
way. There are much better technologies for this (CORBA, and RMI for
example). Web Services were designed specifically for interoperable
coarse-grained correspondence. There is no expectation or guarantee that
any party participating in a Web Service interaction will be at any
particular location, running on any particular OS, or written in any
particular programming language. So because of this, it is important to
clearly separate client and server implementations. The only thing they
should have in common is the abstract contract definition. If, for
whatever reason, your software does not adhere to this principal, then
you should not be using Web Services. For the above reasons, the
<strong><em>recommended methodology for developing a client is</em></strong> to follow <strong><em>the
top-down approach</em></strong> , even if the client is running on the same server.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s repeat the process of the top-down section, although using the
deployed WSDL, instead of the one generated offline by <em>wsprovide</em>. The
reason why we do this is just to get the right value for soap:address.
This value must be computed at deploy time, since it is based on
container configuration specifics. You could of course edit the WSDL
file yourself, although you need to ensure that the path is correct.</p>
</div>
<div class="paragraph">
<p>Offline version:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;service name='EchoService'&gt;
  &lt;port binding='tns:EchoBinding' name='EchoPort'&gt;
   &lt;soap:address location='REPLACE_WITH_ACTUAL_URL'/&gt;
  &lt;/port&gt;
&lt;/service&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Online version:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;service name="EchoService"&gt;
  &lt;port binding="tns:EchoBinding" name="EchoPort"&gt;
    &lt;soap:address location="http://localhost.localdomain:8080/echo/Echo"/&gt;
  &lt;/port&gt;
&lt;/service&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Using the online deployed version with <em>wsconsume</em>:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ wsconsume -k http://localhost:8080/echo/Echo?wsdl
echo/Echo.java
echo/EchoResponse.java
echo/EchoService.java
echo/Echo_Type.java
echo/ObjectFactory.java
echo/package-info.java
echo/Echo.java
echo/EchoResponse.java
echo/EchoService.java
echo/Echo_Type.java
echo/ObjectFactory.java
echo/package-info.java</pre>
</div>
</div>
<div class="paragraph">
<p>The one class that was not examined in the top-down section, was
<code>EchoService.java</code>. Notice how it stores the location the WSDL was
obtained from.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">@WebServiceClient(name = "EchoService", targetNamespace = "http://echo/", wsdlLocation = "http://localhost:8080/echo/Echo?wsdl")
public class EchoService extends Service
{
    private final static URL ECHOSERVICE_WSDL_LOCATION;

    static {
        URL url = null;
        try
        {
           url = new URL("http://localhost:8080/echo/Echo?wsdl");
        }
        catch (MalformedURLException e)
        {
           e.printStackTrace();
        }
        ECHOSERVICE_WSDL_LOCATION = url;
    }

    public EchoService(URL wsdlLocation, QName serviceName)
    {
         super(wsdlLocation, serviceName);
    }

    public EchoService()
    {
         super(ECHOSERVICE_WSDL_LOCATION, new QName("http://echo/", "EchoService"));
    }

    @WebEndpoint(name = "EchoPort")
    public Echo getEchoPort()
    {
         return (Echo)super.getPort(new QName("http://echo/", "EchoPort"), Echo.class);
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see, this generated class extends the main client entry point
in Jakarta XML Web Services, <code>javax.xml.ws.Service</code>. While you can use <code>Service</code> directly,
this is far simpler since it provides the configuration info for you.
The only method we really care about is the <code>getEchoPort()</code> method,
which returns an instance of our Service Endpoint Interface. Any WS
operation can then be called by just invoking a method on the returned
interface.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
It&#8217;s not recommended to refer to a remote WSDL URL in a production
application. This causes network I/O every time you instantiate the
Service Object. Instead, use the tool on a saved local copy, or use the
URL version of the constructor to provide a new WSDL location.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>All that is left to do, is write and compile the client:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">import echo.*;

public class EchoClient
{
   public static void main(String args[])
   {
      if (args.length != 1)
      {
          System.err.println("usage: EchoClient &lt;message&gt;");
          System.exit(1);
      }

      EchoService service = new EchoService();
      Echo echo = service.getEchoPort();
      System.out.println("Server said: " + echo.echo(args0));
   }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>It is easy to change the endpoint address of your operation at runtime,
setting the <em>ENDPOINT_ADDRESS_PROPERTY</em> as shown below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">EchoService service = new EchoService();
      Echo echo = service.getEchoPort();

      /* Set NEW Endpoint Location */
      String endpointURL = "http://NEW_ENDPOINT_URL";
      BindingProvider bp = (BindingProvider)echo;
      bp.getRequestContext().put(BindingProvider.ENDPOINT_ADDRESS_PROPERTY, endpointURL);

      System.out.println("Server said: " + echo.echo(args0));</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="wsconsume"><a class="anchor" href="#wsconsume"></a>16.3. wsconsume</h3>
<div class="paragraph">
<p><em>wsconsume</em> is a command line tool and ant task that "consumes" the
abstract contract (WSDL file) and produces portable Jakarta XML Web Services and
client artifacts.</p>
</div>
<div class="sect3">
<h4 id="command-line-tool"><a class="anchor" href="#command-line-tool"></a>16.3.1. Command Line Tool</h4>
<div class="paragraph">
<p>The command line tool has the following usage:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>usage: wsconsume [options] &lt;wsdl-url&gt;
options:
  -h, --help                  Show this help message
  -b, --binding=&lt;file&gt;        One or more Jakarta XML Web Services or Jakarta XML Binding binding files
  -k, --keep                  Keep/Generate Java source
  -c  --catalog=&lt;file&gt;        Oasis XML Catalog file for entity resolution
  -j  --clientjar=&lt;name&gt;      Create a jar file of the generated artifacts for calling the webservice
  -p  --package=&lt;name&gt;        The target package for generated source
  -w  --wsdlLocation=&lt;loc&gt;    Value to use for @WebServiceClient.wsdlLocation
  -o, --output=&lt;directory&gt;    The directory to put generated artifacts
  -s, --source=&lt;directory&gt;    The directory to put Java source
  -t, --target=&lt;2.0|2.1|2.2&gt;  The Jakarta XML Web Services specification target
  -q, --quiet                 Be somewhat more quiet
  -v, --verbose               Show full exception stack traces
  -l, --load-consumer         Load the consumer and exit (debug utility)
  -e, --extension             Enable SOAP 1.2 binding extension
  -a, --additionalHeaders     Enables processing of implicit SOAP headers
  -n, --nocompile             Do not compile generated sources</pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
The wsdlLocation is used when creating the Service to be used by clients
and will be added to the @WebServiceClient annotation, for an endpoint
implementation based on the generated service endpoint interface you
will need to manually add the wsdlLocation to the @WebService annotation
on your web service implementation and not the service endpoint
interface.
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="examples-wsconsume"><a class="anchor" href="#examples-wsconsume"></a>Examples</h5>
<div class="paragraph">
<p>Generate artifacts in Java class form only:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>wsconsume Example.wsdl</pre>
</div>
</div>
<div class="paragraph">
<p>Generate source and class files:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>wsconsume -k Example.wsdl</pre>
</div>
</div>
<div class="paragraph">
<p>Generate source and class files in a custom directory:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>wsconsume -k -o custom Example.wsdl</pre>
</div>
</div>
<div class="paragraph">
<p>Generate source and class files in the org.foo package:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>wsconsume -k -p org.foo Example.wsdl</pre>
</div>
</div>
<div class="paragraph">
<p>Generate source and class files using multiple binding files:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>wsconsume -k -b wsdl-binding.xml -b schema1-binding.xml -b schema2-binding.xml</pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="maven-plugin-wsconsume"><a class="anchor" href="#maven-plugin-wsconsume"></a>16.3.2. Maven Plugin</h4>
<div class="paragraph">
<p>The wsconsume tools is included in the
<strong>org.jboss.ws.plugins:jaxws-tools-maven-plugin</strong> plugin. The plugin has
two goals for running the tool, <em>wsconsume</em> and <em>wsconsume-test</em>, which
basically do the same during different maven build phases (the former
triggers the sources generation during <em>generate-sources</em> phase, the
latter during the <em>generate-test-sources</em> one).</p>
</div>
<div class="paragraph">
<p>The <em>wsconsume</em> plugin has the following parameters:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Attribute</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Default</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">bindingFiles</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Jakarta XML Web Services or Jakarta XML Binding binding file</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">true</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">classpathElements</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Each classpathElement provides alibrary file to be
added to classpath</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">$\{project.compileClasspathElements}or$\{project.testClasspathElements}</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">catalog</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Oasis XML Catalog file for entity resolution</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">none</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">targetPackage</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The target Java package for generated code.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">generated</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">bindingFiles</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">One or more Jakarta XML Web Services or Jakarta XML Binding binding file</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">none</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">wsdlLocation</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Value to use for @WebServiceClient.wsdlLocation</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">generated</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">outputDirectory</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The output directory for generated artifacts.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">$\{project.build.outputDirectory}or$\{project.build.testOutputDirectory}</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">sourceDirectory</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The output directory for Java source.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">$\{project.build.directory}/wsconsume/java</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">verbose</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Enables more informational output about command progress.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">wsdls</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The WSDL files or URLs to consume</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">n/a</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">extension</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Enable SOAP 1.2 binding extension.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">encoding</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The charset encoding to use for generated sources.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">$\{project.build.sourceEncoding}</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">argLine</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">An optional additional argline to be used when running in fork
mode;can be used to set endorse dir, enable debugging,
etc.Example&lt;argLine&gt;-Djava.endorsed.dirs=&#8230;&#8203;&lt;/argLine&gt;</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">none</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">fork</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Whether or not to run the generation task in a separate VM.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">target</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A preference for the Jakarta XML Web Services specification target</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Depends on
the underlying stack and endorsed dirs if any</p></td>
</tr>
</tbody>
</table>
<div class="sect4">
<h5 id="examples-wsconsume-1"><a class="anchor" href="#examples-wsconsume-1"></a>Examples</h5>
<div class="paragraph">
<p>You can use <em>wsconsume</em> in your own project build simply referencing the
<em>jaxws-tools-maven-plugin</em> in the configured plugins in your pom.xml
file.</p>
</div>
<div class="paragraph">
<p>The following example makes the plugin consume the test.wsdl file and
generate SEI and wrappers' java sources. The generated sources are then
compiled together with the other project classes.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;build&gt;
  &lt;plugins&gt;
    &lt;plugin&gt;
      &lt;groupId&gt;org.jboss.ws.plugins&lt;/groupId&gt;
      &lt;artifactId&gt;jaxws-tools-maven-plugin&lt;/artifactId&gt;
      &lt;version&gt;1.2.0.Beta1&lt;/version&gt;
      &lt;configuration&gt;
        &lt;wsdls&gt;
          &lt;wsdl&gt;${basedir}/test.wsdl&lt;/wsdl&gt;
        &lt;/wsdls&gt;
      &lt;/configuration&gt;
      &lt;executions&gt;
        &lt;execution&gt;
          &lt;goals&gt;
            &lt;goal&gt;wsconsume&lt;/goal&gt;
          &lt;/goals&gt;
        &lt;/execution&gt;
      &lt;/executions&gt;
    &lt;/plugin&gt;
  &lt;/plugins&gt;
&lt;/build&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can also specify multiple wsdl files, as well as force the target
package, enable SOAP 1.2 binding and turn the tool&#8217;s verbose mode on:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;build&gt;
  &lt;plugins&gt;
    &lt;plugin&gt;
      &lt;groupId&gt;org.jboss.ws.plugins&lt;/groupId&gt;
      &lt;artifactId&gt;jaxws-tools-maven-plugin&lt;/artifactId&gt;
      &lt;version&gt;1.2.0.Beta1&lt;/version&gt;
      &lt;configuration&gt;
       &lt;wsdls&gt;
        &lt;wsdl&gt;${basedir}/test.wsdl&lt;/wsdl&gt;
        &lt;wsdl&gt;${basedir}/test2.wsdl&lt;/wsdl&gt;
       &lt;/wsdls&gt;
       &lt;targetPackage&gt;foo.bar&lt;/targetPackage&gt;
       &lt;extension&gt;true&lt;/extension&gt;
       &lt;verbose&gt;true&lt;/verbose&gt;
      &lt;/configuration&gt;
      &lt;executions&gt;
        &lt;execution&gt;
          &lt;goals&gt;
            &lt;goal&gt;wsconsume&lt;/goal&gt;
          &lt;/goals&gt;
        &lt;/execution&gt;
      &lt;/executions&gt;
    &lt;/plugin&gt;
  &lt;/plugins&gt;
&lt;/build&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Finally, if the wsconsume invocation is required for consuming a wsdl to
be used in your testsuite only, you might want to use the
<em>wsconsume-test</em> goal as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;build&gt;
  &lt;plugins&gt;
    &lt;plugin&gt;
      &lt;groupId&gt;org.jboss.ws.plugins&lt;/groupId&gt;
      &lt;artifactId&gt;jaxws-tools-maven-plugin&lt;/artifactId&gt;
      &lt;version&gt;1.2.0.Beta1&lt;/version&gt;
      &lt;configuration&gt;
        &lt;wsdls&gt;
          &lt;wsdl&gt;${basedir}/test.wsdl&lt;/wsdl&gt;
        &lt;/wsdls&gt;
      &lt;/configuration&gt;
      &lt;executions&gt;
        &lt;execution&gt;
          &lt;goals&gt;
            &lt;goal&gt;wsconsume-test&lt;/goal&gt;
          &lt;/goals&gt;
        &lt;/execution&gt;
      &lt;/executions&gt;
    &lt;/plugin&gt;
  &lt;/plugins&gt;
&lt;/build&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Plugin stack dependencyThe plugin itself does not have an explicit
dependency to a JBossWS stack, as it&#8217;s meant for being used with
implementations of any supported version of the <em>JBossWS SPI</em>. So the
user is expected to set a dependency in his own <code>pom.xml</code> to the desired
<em>JBossWS</em> stack version. The plugin will rely on the that for using the
proper tooling.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;dependencies&gt;
  &lt;dependency&gt;
    &lt;groupId&gt;org.jboss.ws.cxf&lt;/groupId&gt;
    &lt;artifactId&gt;jbossws-cxf-client&lt;/artifactId&gt;
    &lt;version&gt;4.0.0.GA&lt;/version&gt;
  &lt;/dependency&gt;
&lt;/dependencies&gt;</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Be careful when using this plugin with the Maven War Plugin as that
include any project dependency into the generated application war
archive. You might want to set <code>&lt;scope&gt;provided&lt;/scope&gt;</code> for the
<em>JBossWS</em> stack dependency to avoid that.
</td>
</tr>
</table>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Up to version 1.1.2.Final, the <em>artifactId</em> of the plugin was
<strong>maven-jaxws-tools-plugin</strong>.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect3">
<h4 id="ant-task-wsconsume"><a class="anchor" href="#ant-task-wsconsume"></a>16.3.3. Ant Task</h4>
<div class="paragraph">
<p>The <em>wsconsume</em> Ant task ( <em>org.jboss.ws.tools.ant.WSConsumeTask</em>) has
the following attributes:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Attribute</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Default</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">fork</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Whether or not to run the generation task in a separate VM.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">true</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">keep</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Keep/Enable Java source code generation.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">catalog</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Oasis XML Catalog file for entity resolution</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">none</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">package</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The target Java package for generated code.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">generated</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">binding</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A Jakarta XML Web Services or Jakarta XML Binding binding file</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">none</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">wsdlLocation</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Value to use for @WebServiceClient.wsdlLocation</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">generated</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">encoding</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The charset encoding to use for generated sources</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">n/a</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">destdir</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The output directory for generated artifacts.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"output"</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">sourcedestdir</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The output directory for Java source.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">value of destdir</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">target</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The Jakarta XML Web Services specification target. Allowed values are 2.0, 2.1
and 2.2</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">verbose</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Enables more informational output about command progress.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">wsdl</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The WSDL file or URL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">n/a</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">extension</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Enable SOAP 1.2 binding extension.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">additionalHeaders</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Enables processing of implicit SOAP headers</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Users also need to put streamBuffer.jar and stax-ex.jar to the classpath
of the ant task to generate the appropriate artefacts.
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The wsdlLocation is used when creating the Service to be used by clients
and will be added to the @WebServiceClient annotation, for an endpoint
implementation based on the generated service endpoint interface you
will need to manually add the wsdlLocation to the @WebService annotation
on your web service implementation and not the service endpoint
interface.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Also, the following nested elements are supported:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Element</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Default</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">binding</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A Jakarta XML Web Services or Jakarta XML Binding binding file</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">none</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">jvmarg</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Allows setting of custom jvm arguments</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
</tbody>
</table>
<div class="sect4">
<h5 id="examples-wsconsume-2"><a class="anchor" href="#examples-wsconsume-2"></a>Examples</h5>
<div class="paragraph">
<p>Generate Jakarta XML Web Services source and classes in a separate JVM with separate
directories, a custom wsdl location attribute, and a list of binding
files from foo.wsdl:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;wsconsume
  fork="true"
  verbose="true"
  destdir="output"
  sourcedestdir="gen-src"
  keep="true"
  wsdllocation="handEdited.wsdl"
  wsdl="foo.wsdl"&gt;
  &lt;binding dir="binding-files" includes="*.xml" excludes="bad.xml"/&gt;
&lt;/wsconsume&gt;</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="wsprovide"><a class="anchor" href="#wsprovide"></a>16.4. wsprovide</h3>
<div class="paragraph">
<p><em>wsprovide</em> is a command line tool, Maven plugin and Ant task that
generates portable Jakarta XML Web Services artifacts for a service endpoint
implementation. It also has the option to "provide" the abstract
contract for offline usage.</p>
</div>
<div class="sect3">
<h4 id="command-line-tool-wsprovide"><a class="anchor" href="#command-line-tool-wsprovide"></a>16.4.1. Command Line Tool</h4>
<div class="paragraph">
<p>The command line tool has the following usage:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>usage: wsprovide [options] &lt;endpoint class name&gt;
options:
  -h, --help                  Show this help message
  -k, --keep                  Keep/Generate Java source
  -w, --wsdl                  Enable WSDL file generation
  -a, --address The generated port soap:address in wsdl
  -c. --classpath=&lt;path&gt;      The classpath that contains the endpoint
  -o, --output=&lt;directory&gt;    The directory to put generated artifacts
  -r, --resource=&lt;directory&gt;  The directory to put resource artifacts
  -s, --source=&lt;directory&gt;    The directory to put Java source
  -e, --extension             Enable SOAP 1.2 binding extension
  -q, --quiet                 Be somewhat more quiet
  -t, --show-traces           Show full exception stack traces</pre>
</div>
</div>
<div class="sect4">
<h5 id="examples-wsprovide"><a class="anchor" href="#examples-wsprovide"></a>Examples</h5>
<div class="paragraph">
<p>Generating wrapper classes for portable artifacts in the "generated"
directory:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>wsprovide -o generated foo.Endpoint</pre>
</div>
</div>
<div class="paragraph">
<p>Generating wrapper classes and WSDL in the "generated" directory</p>
</div>
<div class="literalblock">
<div class="content">
<pre>wsprovide -o generated -w foo.Endpoint</pre>
</div>
</div>
<div class="paragraph">
<p>Using an endpoint that references other jars</p>
</div>
<div class="literalblock">
<div class="content">
<pre>wsprovide -o generated -c application1.jar:application2.jar foo.Endpoint</pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="maven-plugin-wsprovide"><a class="anchor" href="#maven-plugin-wsprovide"></a>16.4.2. Maven Plugin</h4>
<div class="paragraph">
<p>The <em>wsprovide</em> tools is included in the
<strong>org.jboss.ws.plugins:jaxws-tools-</strong> <strong>maven-</strong> <strong>plugin</strong> plugin. The plugin
has two goals for running the tool, <em>wsprovide</em> and <em>wsprovide-test</em>,
which basically do the same during different Maven build phases (the
former triggers the sources generation during <em>process-classes</em> phase,
the latter during the <em>process-test-classes</em> one).</p>
</div>
<div class="paragraph">
<p>The <em>wsprovide</em> plugin has the following parameters:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Attribute</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Default</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">testClasspathElements</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Each classpathElement provides alibrary file to
be added to classpath</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">$\{project.compileClasspathElements}or$\{project.testClasspathElements}</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">outputDirectory</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The output directory for generated artifacts.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">$\{project.build.outputDirectory}or$\{project.build.testOutputDirectory}</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">resourceDirectory</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The output directory for resource artifacts
(WSDL/XSD).</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">$\{project.build.directory}/wsprovide/resources</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">sourceDirectory</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The output directory for Java source.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">$\{project.build.directory}/wsprovide/java</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">extension</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Enable SOAP 1.2 binding extension.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">generateWsdl</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Whether or not to generate WSDL.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">verbose</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Enables more informational output about command progress.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">portSoapAddress</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The generated port soap:address in the WSDL</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">endpointClass</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Service Endpoint Implementation.</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
</tbody>
</table>
<div class="sect4">
<h5 id="examples-wsprovide-1"><a class="anchor" href="#examples-wsprovide-1"></a>Examples</h5>
<div class="paragraph">
<p>You can use <em>wsprovide</em> in your own project build simply referencing the
<em>maven-jaxws-tools-plugin</em> in the configured plugins in your <em>pom.xml</em>
file.</p>
</div>
<div class="paragraph">
<p>The following example makes the plugin provide the wsdl file and
artifact sources for the specified endpoint class:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;build&gt;
  &lt;plugins&gt;
    &lt;plugin&gt;
      &lt;groupId&gt;org.jboss.ws.plugins&lt;/groupId&gt;
      &lt;artifactId&gt;jaxws-tools-maven-plugin&lt;/artifactId&gt;
      &lt;version&gt;1.2.0.Beta1&lt;/version&gt;
      &lt;configuration&gt;
        &lt;verbose&gt;true&lt;/verbose&gt;
        &lt;endpointClass&gt;org.jboss.test.ws.plugins.tools.wsprovide.TestEndpoint&lt;/endpointClass&gt;
        &lt;generateWsdl&gt;true&lt;/generateWsdl&gt;
      &lt;/configuration&gt;
      &lt;executions&gt;
        &lt;execution&gt;
          &lt;goals&gt;
            &lt;goal&gt;wsprovide&lt;/goal&gt;
          &lt;/goals&gt;
        &lt;/execution&gt;
      &lt;/executions&gt;
    &lt;/plugin&gt;
  &lt;/plugins&gt;
&lt;/build&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The following example does the same, but is meant for use in your own
testsuite:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;build&gt;
  &lt;plugins&gt;
    &lt;plugin&gt;
      &lt;groupId&gt;org.jboss.ws.plugins&lt;/groupId&gt;
      &lt;artifactId&gt;jaxws-tools-maven-plugin&lt;/artifactId&gt;
      &lt;version&gt;1.2.0.Beta1&lt;/version&gt;
      &lt;configuration&gt;
        &lt;verbose&gt;true&lt;/verbose&gt;
        &lt;endpointClass&gt;org.jboss.test.ws.plugins.tools.wsprovide.TestEndpoint2&lt;/endpointClass&gt;
        &lt;generateWsdl&gt;true&lt;/generateWsdl&gt;
      &lt;/configuration&gt;
      &lt;executions&gt;
        &lt;execution&gt;
          &lt;goals&gt;
            &lt;goal&gt;wsprovide-test&lt;/goal&gt;
          &lt;/goals&gt;
        &lt;/execution&gt;
      &lt;/executions&gt;
    &lt;/plugin&gt;
  &lt;/plugins&gt;
&lt;/build&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Plugin stack dependencyThe plugin itself does not have an explicit
dependency to a JBossWS stack, as it&#8217;s meant for being used with
implementations of any supported version of the <em>JBossWS SPI</em>. So the
user is expected to set a dependency in his own <code>pom.xml</code> to the desired
<em>JBossWS</em> stack version. The plugin will rely on the that for using the
proper tooling.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;dependencies&gt;
  &lt;dependency&gt;
    &lt;groupId&gt;org.jboss.ws.cxf&lt;/groupId&gt;
    &lt;artifactId&gt;jbossws-cxf-client&lt;/artifactId&gt;
    &lt;version&gt;5.0.0.CR1&lt;/version&gt;
  &lt;/dependency&gt;
&lt;/dependencies&gt;</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Be careful when using this plugin with the Maven War Plugin as that
include any project dependency into the generated application war
archive. You might want to set <code>&lt;scope&gt;provided&lt;/scope&gt;</code> for the
<em>JBossWS</em> stack dependency to avoid that.
</td>
</tr>
</table>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Up to version 1.1.2.Final, the <em>artifactId</em> of the plugin was
<strong>maven-jaxws-tools-plugin</strong>.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect3">
<h4 id="ant-task-wsprovide"><a class="anchor" href="#ant-task-wsprovide"></a>16.4.3. Ant Task</h4>
<div class="paragraph">
<p>The wsprovide ant task ( <em>org.jboss.ws.tools.ant.WSProvideTask</em>) has the
following attributes:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Attribute</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Default</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">fork</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Whether or not to run the generation task in a separate VM.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">true</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">keep</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Keep/Enable Java source code generation.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">destdir</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The output directory for generated artifacts.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"output"</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">resourcedestdir</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The output directory for resource artifacts
(WSDL/XSD).</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">value of destdir</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">sourcedestdir</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The output directory for Java source.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">value of destdir</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">extension</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Enable SOAP 1.2 binding extension.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">genwsdl</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Whether or not to generate WSDL.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">address</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The generated port soap:address in wsdl.</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">verbose</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Enables more informational output about command progress.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">sei</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Service Endpoint Implementation.</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">classpath</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The classpath that contains the service endpoint
implementation.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"."</p></td>
</tr>
</tbody>
</table>
<div class="sect4">
<h5 id="examples-wsprovide-2"><a class="anchor" href="#examples-wsprovide-2"></a>Examples</h5>
<div class="paragraph">
<p>Executing wsprovide in verbose mode with separate output directories for
source, resources, and classes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;target name="test-wsproivde" depends="init"&gt;
  &lt;taskdef name="wsprovide" classname="org.jboss.ws.tools.ant.WSProvideTask"&gt;
    &lt;classpath refid="core.classpath"/&gt;
  &lt;/taskdef&gt;
  &lt;wsprovide
    fork="false"
    keep="true"
    destdir="out"
    resourcedestdir="out-resource"
    sourcedestdir="out-source"
    genwsdl="true"
    verbose="true"
    sei="org.jboss.test.ws.jaxws.jsr181.soapbinding.DocWrappedServiceImpl"&gt;
    &lt;classpath&gt;
      &lt;pathelement path="${tests.output.dir}/classes"/&gt;
    &lt;/classpath&gt;
  &lt;/wsprovide&gt;
&lt;/target&gt;</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="Jakarta_XML_Web_Services_Advanced_User_Guide"><a class="anchor" href="#Jakarta_XML_Web_Services_Advanced_User_Guide"></a>16.5. Jakarta XML Web Services Advanced User Guide</h3>
<div class="sect3">
<h4 id="logging"><a class="anchor" href="#logging"></a>16.5.1. Logging</h4>
<div class="paragraph">
<p>Logging of inbound and outbound messages is a common need. Different
approaches are available for achieving that:</p>
</div>
<div class="sect4">
<h5 id="Jakarta-XML-Web-Services-handler-approach"><a class="anchor" href="#Jakarta-XML-Web-Services-handler-approach"></a>Jakarta XML Web Services Handler approach</h5>
<div class="paragraph">
<p>A portable way of performing logging is writing a simple Jakarta XML Web Services handler
dumping the messages that are passed in it; the handler can be added to
the desired client/endpoints (programmatically / using <code>@HandlerChain</code>
Jakarta XML Web Services annotation).</p>
</div>
<div class="paragraph">
<p>The <a href="#Predefined_client_and_endpoint_configurations">predefined client and endpoint configuration</a>
mechanism allows user to add the logging handler to any client/endpoint
or to some of them only (in which case the <code>@EndpointConfig</code> annotation
/ JBossWS API is required though).</p>
</div>
</div>
<div class="sect4">
<h5 id="apache-cxf-approach"><a class="anchor" href="#apache-cxf-approach"></a>Apache CXF approach</h5>
<div class="paragraph">
<p>Apache CXF also comes with logging interceptors that can be easily used
to log messages to the console or configured client/server log files.
Those interceptors can be added to client, endpoint and buses in
multiple ways:</p>
</div>
<div class="sect5">
<h6 id="system-property"><a class="anchor" href="#system-property"></a>System property</h6>
<div class="paragraph">
<p>Setting the <code>org.apache.cxf.logging.enabled</code> system property to true
causes the logging interceptors to be added to any <code>Bus</code> instance being
created on the JVM.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
On WildFly, the system property is easily set by adding what follows to
the standalone / domain server configuration just after the extensions
section:
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">&lt;system-properties&gt;
  &lt;property name="org.apache.cxf.logging.enabled" value="true"/&gt;
&lt;/system-properties&gt;</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="manual-interceptor-addition-and-logging-feature"><a class="anchor" href="#manual-interceptor-addition-and-logging-feature"></a>Manual interceptor addition and logging feature</h6>
<div class="paragraph">
<p>Logging interceptors can be selectively added to endpoints using the
Apache CXF annotations <code>@org.apache.cxf.interceptor.InInterceptors</code> and
<code>@org.apache.cxf.interceptor.OutInterceptors</code>. The same is achieved on
client side by programmatically adding new instances of the logging
interceptors to the client or the bus.</p>
</div>
<div class="paragraph">
<p>Alternatively, Apache CXF also comes with a
<code>org.apache.cxf.feature.LoggingFeature</code> that can be used on clients and
endpoints (either annotating them with
<code>@org.apache.cxf.feature.Features</code> or directly with
<code>@org.apache.cxf.annotations.Logging</code>).</p>
</div>
<div class="paragraph">
<p>Please refer to the
<a href="http://cxf.apache.org/docs/debugging-and-logging.html#DebuggingandLogging-LoggingMessages">Apache
CXF documentation</a> for more details.</p>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="ws--support"><a class="anchor" href="#ws--support"></a>16.5.2. WS-* support</h4>
<div class="paragraph">
<p>JBossWS includes most of the WS-* specification functionalities through
the integration with Apache CXF. In particular, the whole WS-Security
Policy framework is fully supported, enabling full contract driven
configuration of complex features like WS-Security.</p>
</div>
<div class="paragraph">
<p>In details information available further down in this documentation
book.</p>
</div>
</div>
<div class="sect3">
<h4 id="address-rewrite"><a class="anchor" href="#address-rewrite"></a>16.5.3. Address rewrite</h4>
<div class="paragraph">
<p>JBossWS allows users to configure the <em>soap:address</em> attribute in the
wsdl contract of deployed services.</p>
</div>
<div class="sect4">
<h5 id="server-configuration-options"><a class="anchor" href="#server-configuration-options"></a>Server configuration options</h5>
<div class="paragraph">
<p>The configuration options are part of the
<a href="https://docs.jboss.org/author/display/WFLY8/Web+services+configuration">webservices
subsystem section</a> of the application server domain model.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;subsystem xmlns="urn:jboss:domain:webservices:1.1" xmlns:javaee="http://java.sun.com/xml/ns/javaee"
  xmlns:jaxwsconfig="urn:jboss:jbossws-jaxws-config:4.0"&gt;
  &lt;wsdl-host&gt;localhost&lt;/wsdl-host&gt;
  &lt;modify-wsdl-address&gt;true&lt;/modify-wsdl-address&gt;
&lt;!--
  &lt;wsdl-port&gt;8080&lt;/wsdl-port&gt;
  &lt;wsdl-secure-port&gt;8443&lt;/wsdl-secure-port&gt;
--&gt;
&lt;/subsystem&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>If the content of <em>&lt;soap:address&gt;</em> in the wsdl is a valid URL, JBossWS
will not rewrite it unless <em>modify-wsdl-address</em> is true. If the content
of <em>&lt;soap:address&gt;</em> is not a valid URL instead, JBossWS will always
rewrite it using the attribute values given below. Please note that the
variable <em>$\{jboss.bind.address}</em> can be used to set the address which
the application is bound to at each startup.</p>
</div>
<div class="paragraph">
<p>The wsdl-secure-port and wsdl-port attributes are used to explicitly
define the ports to be used for rewriting the SOAP address. If these
attributes are not set, the ports will be identified by querying the
list of installed connectors. If multiple connectors are found the port
of the first connector is used.</p>
</div>
</div>
<div class="sect4">
<h5 id="dynamic-rewrite"><a class="anchor" href="#dynamic-rewrite"></a>Dynamic rewrite</h5>
<div class="paragraph">
<p>When the application server is bound to multiple addresses or
non-trivial real-world network architectures cause request for different
external addresses to hit the same endpoint, a static rewrite of the
soap:address may not be enough. JBossWS allows for both the soap:address
in the wsdl and the wsdl address in the console to be rewritten with the
host use in the client request. This way, users always get the right
wsdl address assuming they&#8217;re connecting to an instance having the
endpoint they&#8217;re looking for. To trigger this behaviour, the
<em>jbossws.undefined.host</em> value has to be specified for the <em>wsdl-host</em>
element.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>&lt;wsdl-host&gt;jbossws.undefined.host&lt;/wsdl-host&gt;
&lt;modify-wsdl-address&gt;true&lt;/modify-wsdl-address&gt;</pre>
</div>
</div>
<div class="paragraph">
<p>Of course, when a confidential transport address is required, the
addresses are always rewritten using https protocol and the port
currently configured for the https/ssl connector.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="configuration-through-deployment-descriptor"><a class="anchor" href="#configuration-through-deployment-descriptor"></a>16.5.4. Configuration through deployment descriptor</h4>
<div class="paragraph">
<p>The <code>jboss-webservices.xml</code> deployment descriptor can be used to provide
additional configuration for a given deployment. The expected location
of it is:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>META-INF/jboss-webservices.xml</code> for Jakarta Enterprise Beans webservice deployments</p>
</li>
<li>
<p><code>WEB-INF/jboss-webservices.xml</code> for POJO webservice deployments and
Jakarta Enterprise Beans webservice endpoints bundled in <code>war</code> archives</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The structure of file is the following (schemas are available
<a href="http://anonsvn.jboss.org/repos/jbossws/spi/trunk/src/main/resources/schema/">here</a>):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">&lt;webservices&gt;
  &lt;context-root/&gt;?
  &lt;config-name/&gt;?
  &lt;config-file/&gt;?
  &lt;property&gt;*
    &lt;name/&gt;
    &lt;value/&gt;
  &lt;/property&gt;
  &lt;port-component&gt;*
    &lt;ejb-name/&gt;
    &lt;port-component-name/&gt;
    &lt;port-component-uri/&gt;?
    &lt;auth-method/&gt;?
    &lt;transport-guarantee/&gt;?
    &lt;secure-wsdl-access/&gt;?
  &lt;/port-component&gt;
  &lt;webservice-description&gt;*
    &lt;webservice-description-name/&gt;
    &lt;wsdl-publish-location/&gt;?
  &lt;/webservice-description&gt;
&lt;/webservices&gt;</code></pre>
</div>
</div>
<div class="sect4">
<h5 id="context-root-element"><a class="anchor" href="#context-root-element"></a>context-root element</h5>
<div class="paragraph">
<p>Element <code>&lt;context-root&gt;</code> can be used to customize context root of
webservices deployment.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">&lt;webservices&gt;
  &lt;context-root&gt;foo&lt;/context-root&gt;
&lt;/webservices&gt;</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="config-name-and-config-file-elements"><a class="anchor" href="#config-name-and-config-file-elements"></a>config-name and config-file elements</h5>
<div class="paragraph">
<p>Elements <code>&lt;config-name&gt;</code> and <code>&lt;config-file&gt;</code> can be used to associate
any endpoint provided in the deployment with a given
<a href="#Predefined_client_and_endpoint_configurations">endpoint configuration</a>. Endpoint configuration are
either specified in the referenced config file or in the WildFly domain
model (webservices subsystem). For further details on the endpoint
configurations and their management in the domain model, please see the
related
<a href="https://docs.jboss.org/author/display/WFLY8/Web+services+configuration">documentation</a>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">&lt;webservices&gt;
  &lt;config-name&gt;Standard WSSecurity Endpoint&lt;/config-name&gt;
  &lt;config-file&gt;META-INF/custom.xml&lt;/config-file&gt;
&lt;/webservices&gt;</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="property-element"><a class="anchor" href="#property-element"></a>property element</h5>
<div class="paragraph">
<p><code>&lt;property&gt;</code> elements can be used to setup simple property values to
configure the ws stack behavior. Allowed property names and values are
mentioned in the guide under related topics.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">&lt;property&gt;
  &lt;name&gt;prop.name&lt;/name&gt;
  &lt;value&gt;prop.value&lt;/value&gt;
&lt;/property&gt;</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="port-component-element"><a class="anchor" href="#port-component-element"></a>port-component element</h5>
<div class="paragraph">
<p>Element <code>&lt;port-component&gt;</code> can be used to customize Jakarta Enterprise Beans endpoint target
URI or to configure security related properties.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">&lt;webservices&gt;
  &lt;port-component&gt;
    &lt;ejb-name&gt;TestService&lt;/ejb-name&gt;
    &lt;port-component-name&gt;TestServicePort&lt;/port-component-name&gt;
    &lt;port-component-uri&gt;/*&lt;/port-component-uri&gt;
    &lt;auth-method&gt;BASIC&lt;/auth-method&gt;
    &lt;transport-guarantee&gt;NONE&lt;/transport-guarantee&gt;
    &lt;secure-wsdl-access&gt;true&lt;/secure-wsdl-access&gt;
  &lt;/port-component&gt;
&lt;/webservices&gt;</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="webservice-description-element"><a class="anchor" href="#webservice-description-element"></a>webservice-description element</h5>
<div class="paragraph">
<p>Element <code>&lt;webservice-description&gt;</code> can be used to customize (override)
webservice WSDL publish location.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">&lt;webservices&gt;
  &lt;webservice-description&gt;
    &lt;webservice-description-name&gt;TestService&lt;/webservice-description-name&gt;
    &lt;wsdl-publish-location&gt;file:///bar/foo.wsdl&lt;/wsdl-publish-location&gt;
  &lt;/webservice-description&gt;
&lt;/webservices&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="schema-validation-of-soap-messages"><a class="anchor" href="#schema-validation-of-soap-messages"></a>16.5.5. Schema validation of SOAP messages</h4>
<div class="paragraph">
<p>Apache CXF has a feature for validating incoming and outgoing SOAP
messages on both client and server side. The validation is performed
against the relevant schema in the endpoint wsdl contract (server side)
or the wsdl contract used for building up the service proxy (client
side).</p>
</div>
<div class="paragraph">
<p>Schema validation can be turned on programmatically on client side</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">((BindingProvider)proxy).getRequestContext().put("schema-validation-enabled", true);</code></pre>
</div>
</div>
<div class="paragraph">
<p>or using the <code>@org.apache.cxf.annotations.SchemaValidation</code> annotation
on server side</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">import javax.jws.WebService;
import org.apache.cxf.annotations.SchemaValidation;

@WebService(...)
@SchemaValidation
public class ValidatingHelloImpl implements Hello {
   ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Alternatively, any endpoint and client running in-container can be
associated to a JBossWS <a href="#Predefined_client_and_endpoint_configurations">predefined configuration</a>
having the <code>schema-validation-enabled</code> property set to <code>true</code> in the
referenced config file.</p>
</div>
<div class="paragraph">
<p>Finally, JBossWS also allows for server-wide (default) setup of schema
validation by using the <em>Standard-Endpoint-Config</em> and
<em>Standard-Client-Config</em> special configurations (which apply to any
client / endpoint unless a different configuration is specified for
them)</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;subsystem xmlns="urn:jboss:domain:webservices:1.2"&gt;
    ...
    &lt;endpoint-config name="Standard-Endpoint-Config"&gt;
        &lt;property name="schema-validation-enabled" value="true"/&gt;
    &lt;/endpoint-config&gt;
    ...
    &lt;client-config name="Standard-Client-Config"&gt;
        &lt;property name="schema-validation-enabled" value="true"/&gt;
    &lt;/client-config&gt;
&lt;/subsystem&gt;</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="Jakarta-XML-Binding-introductions"><a class="anchor" href="#Jakarta-XML-Binding-introductions"></a>16.5.6. Jakarta XML Binding Introductions</h4>
<div class="paragraph">
<p>As Kohsuke Kawaguchi wrote on
<a href="http://weblogs.java.net/blog/kohsuke/archive/2007/07/binding_3rd_par.html">his
blog</a>, one common complaint from the Jakarta XML Binding users is the lack of support
for binding 3rd party classes. The scenario is this: you are trying to
annotate your classes with Jakarta XML Binding annotations to make it XML bindable, but
some of the classes are coming from libraries and JDK, and thus you
cannot put necessary Jakarta XML Binding annotations on it.</p>
</div>
<div class="paragraph">
<p>To solve this Jakarta XML Binding has been designed to provide hooks for programmatic
introduction of annotations to the runtime.</p>
</div>
<div class="paragraph">
<p>This is currently leveraged by the JBoss Jakarta XML Binding Introductions project,
using which users can define annotations in XML and make Jakarta XML Binding see those
as if those were in the class files (perhaps coming from 3rd party
libraries).</p>
</div>
<div class="paragraph">
<p>Take a look at the <a href="http://community.jboss.org/docs/DOC-10075">JAXB
Introductions page</a> on the wiki and at the examples in the sources.</p>
</div>
</div>
<div class="sect3">
<h4 id="wsdl-system-properties-expansion"><a class="anchor" href="#wsdl-system-properties-expansion"></a>16.5.7. WSDL system properties expansion</h4>
<div class="paragraph">
<p>See <a href="#Published_WSDL_customization">Published WSDL customization</a></p>
</div>
</div>
<div class="sect3">
<h4 id="Predefined_client_and_endpoint_configurations"><a class="anchor" href="#Predefined_client_and_endpoint_configurations"></a>16.5.8. Predefined client and endpoint configurations</h4>
<div class="quoteblock abstract">
<blockquote>
JBossWS permits extra setup configuration data to be predefined and
associated with an endpoint or a client. Configurations can include
Jakarta XML Web Services handlers and key/value property declarations that control JBossWS
and Apache CXF internals. Predefined configurations can be used for
Jakarta XML Web Services client and Jakarta XML Web Services endpoint setup.
</blockquote>
</div>
<div class="paragraph">
<p>Configurations can be defined in the webservice subsystem and in an
application&#8217;s deployment descriptor file. There can be many
configuration definitions in the webservice subsystem and in an
application. Each configuration must have a name that is unique within
the server. Configurations defined in an application are local to the
application. Endpoint implementations declare the use of a specific
configuration through the use of the
<code>org.jboss.ws.api.annotation.EndpointConfig</code> annotation. An endpoint
configuration defined in the webservices subsystem is available to all
deployed applications on the server container and can be referenced by
name in the annotation. An endpoint configuration defined in an
application must be referenced by both deployment descriptor file name
and configuration name by the annotation.</p>
</div>
<div class="paragraph">
<p><strong>Handlers</strong></p>
</div>
<div class="paragraph">
<p>Each endpoint configuration may be associated with zero or more PRE and
POST handler chains. Each handler chain may include JAXWS handlers. For
outbound messages the PRE handler chains are executed before any handler
that is attached to the endpoint using the standard means, such as with
annotation @HandlerChain, and POST handler chains are executed after
those objects have executed. For inbound messages the POST handler
chains are executed before any handler that is attached to the endpoint
using the standard means and the PRE handler chains are executed after
those objects have executed.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>* Server inbound messages
Client --&gt; ... --&gt; POST HANDLER --&gt; ENDPOINT HANDLERS --&gt; PRE HANDLERS --&gt; Endpoint

* Server outbound messages
Endpoint --&gt; PRE HANDLER --&gt; ENDPOINT HANDLERS --&gt; POST HANDLERS --&gt; ... --&gt; Client</pre>
</div>
</div>
<div class="paragraph">
<p>The same applies for client configurations.</p>
</div>
<div class="paragraph">
<p><strong>Properties</strong></p>
</div>
<div class="paragraph">
<p>Key/value properties are used for controlling both some Apache CXF
internals and some JBossWS options. Specific supported values are
mentioned where relevant in the rest of the documentation.</p>
</div>
<div class="sect4">
<h5 id="assigning-configurations"><a class="anchor" href="#assigning-configurations"></a>Assigning configurations</h5>
<div class="paragraph">
<p>Endpoints and clients are assigned configuration through different
means. Users can explicitly require a given configuration or rely on
container defaults. The assignment process can be split up as follows:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Explicit assignment through annotations (for endpoints) or API
programmatic usage (for clients)</p>
</li>
<li>
<p>Automatic assignment of configurations from default descriptors</p>
</li>
<li>
<p>Automatic assignment of configurations from container</p>
</li>
</ul>
</div>
<div class="sect5">
<h6 id="endpoint-configuration-assignment"><a class="anchor" href="#endpoint-configuration-assignment"></a>Endpoint configuration assignment</h6>
<div class="paragraph">
<p>The explicit configuration assignment is meant for developer that know
in advance their endpoint or client has to be setup according to a
specified configuration. The configuration is either coming from a
descriptor that is included in the application deployment, or is
included in the application server webservices subsystem management
model.</p>
</div>
</div>
<div class="sect5">
<h6 id="endpoint-configuration-deployment-descriptor"><a class="anchor" href="#endpoint-configuration-deployment-descriptor"></a>Endpoint Configuration Deployment Descriptor</h6>
<div class="paragraph">
<p>Jakarta EE archives that can contain Jakarta XML Web Services client and endpoint
implementations can also contain predefined client and endpoint
configuration declarations. All endpoint/client configuration
definitions for a given archive must be provided in a single deployment
descriptor file, which must be an implementation of schema
<a href="http://anonsvn.jboss.org/repos/jbossws/spi/tags/jbossws-spi-2.1.0.Final/src/main/resources/schema/jbossws-jaxws-config_4_0.xsd">jbossws-jaxws-config</a>.
Many endpoint/client configurations can be defined in the deployment
descriptor file. Each configuration must have a name that is unique
within the server on which the application is deployed. The
configuration name can&#8217;t be referred to by endpoint/client
implementations outside the application. Here is an example of a
descriptor, containing two endpoint configurations:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;jaxws-config xmlns="urn:jboss:jbossws-jaxws-config:4.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:javaee="http://java.sun.com/xml/ns/javaee"
xsi:schemaLocation="urn:jboss:jbossws-jaxws-config:4.0 schema/jbossws-jaxws-config_4_0.xsd"&gt;
&lt;endpoint-config&gt;
&lt;config-name&gt;org.jboss.test.ws.jaxws.jbws3282.Endpoint4Impl&lt;/config-name&gt;
&lt;pre-handler-chains&gt;
&lt;javaee:handler-chain&gt;
&lt;javaee:handler&gt;
&lt;javaee:handler-name&gt;Log Handler&lt;/javaee:handler-name&gt;
&lt;javaee:handler-class&gt;org.jboss.test.ws.jaxws.jbws3282.LogHandler&lt;/javaee:handler-class&gt;
&lt;/javaee:handler&gt;
&lt;/javaee:handler-chain&gt;
&lt;/pre-handler-chains&gt;
&lt;post-handler-chains&gt;
&lt;javaee:handler-chain&gt;
&lt;javaee:handler&gt;
&lt;javaee:handler-name&gt;Routing Handler&lt;/javaee:handler-name&gt;
&lt;javaee:handler-class&gt;org.jboss.test.ws.jaxws.jbws3282.RoutingHandler&lt;/javaee:handler-class&gt;
&lt;/javaee:handler&gt;
&lt;/javaee:handler-chain&gt;
&lt;/post-handler-chains&gt;
&lt;/endpoint-config&gt;
&lt;endpoint-config&gt;
&lt;config-name&gt;EP6-config&lt;/config-name&gt;
&lt;post-handler-chains&gt;
&lt;javaee:handler-chain&gt;
&lt;javaee:handler&gt;
&lt;javaee:handler-name&gt;Authorization Handler&lt;/javaee:handler-name&gt;
&lt;javaee:handler-class&gt;org.jboss.test.ws.jaxws.jbws3282.AuthorizationHandler&lt;/javaee:handler-class&gt;
&lt;/javaee:handler&gt;
&lt;/javaee:handler-chain&gt;
&lt;/post-handler-chains&gt;
&lt;/endpoint-config&gt;
&lt;/jaxws-config&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Similarly, client configurations can be specified in descriptors (still
implementing the schema mentioned above):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;jaxws-config xmlns="urn:jboss:jbossws-jaxws-config:4.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:javaee="http://java.sun.com/xml/ns/javaee"
xsi:schemaLocation="urn:jboss:jbossws-jaxws-config:4.0 schema/jbossws-jaxws-config_4_0.xsd"&gt;
&lt;client-config&gt;
&lt;config-name&gt;Custom Client Config&lt;/config-name&gt;
&lt;pre-handler-chains&gt;
&lt;javaee:handler-chain&gt;
&lt;javaee:handler&gt;
&lt;javaee:handler-name&gt;Routing Handler&lt;/javaee:handler-name&gt;
&lt;javaee:handler-class&gt;org.jboss.test.ws.jaxws.clientConfig.RoutingHandler&lt;/javaee:handler-class&gt;
&lt;/javaee:handler&gt;
&lt;javaee:handler&gt;
&lt;javaee:handler-name&gt;Custom Handler&lt;/javaee:handler-name&gt;
&lt;javaee:handler-class&gt;org.jboss.test.ws.jaxws.clientConfig.CustomHandler&lt;/javaee:handler-class&gt;
&lt;/javaee:handler&gt;
&lt;/javaee:handler-chain&gt;
&lt;/pre-handler-chains&gt;
&lt;/client-config&gt;
&lt;client-config&gt;
&lt;config-name&gt;Another Client Config&lt;/config-name&gt;
&lt;post-handler-chains&gt;
&lt;javaee:handler-chain&gt;
&lt;javaee:handler&gt;
&lt;javaee:handler-name&gt;Routing Handler&lt;/javaee:handler-name&gt;
&lt;javaee:handler-class&gt;org.jboss.test.ws.jaxws.clientConfig.RoutingHandler&lt;/javaee:handler-class&gt;
&lt;/javaee:handler&gt;
&lt;/javaee:handler-chain&gt;
&lt;/post-handler-chains&gt;
&lt;/client-config&gt;
&lt;/jaxws-config&gt;</code></pre>
</div>
</div>
<div class="sect6">
<h7 id="application-server-configurations"><a class="anchor" href="#application-server-configurations"></a>Application server configurations</h7>
<div class="paragraph">
<p>WildFly allows declaring JBossWS client and server predefined
configurations in the <em>webservices</em> subsystem section of the server
model. As a consequence it is possible to declare server-wide handlers
to be added to the chain of each endpoint or client assigned to a given
configuration.</p>
</div>
<div class="paragraph">
<p>Please refer to the
<a href="https://docs.jboss.org/author/display/WFLY9/Web+services+configuration">WildFly
documentation</a> for details on managing the <em>webservices</em> subsystem such
as adding, removing and modifying handlers and properties.</p>
</div>
<div class="paragraph">
<p>The allowed contents in the <em>webservices</em> subsystem are defined by the
<a href="https://github.com/jbossas/jboss-as/blob/7.2.0.Final/build/src/main/resources/docs/schema/jboss-as-webservices_1_2.xsd">schema</a>
included in the application server.</p>
</div>
<div class="sect7">
<h8 id="standard-configurations"><a class="anchor" href="#standard-configurations"></a>Standard configurations</h8>
<div class="paragraph">
<p>Clients running in-container as well as endpoints are assigned standard
configurations by default. The defaults are used unless different
configurations are set as described on this page. This enables
administrators to tune the default handler chains for client and
endpoint configurations. The names of the default client and endpoint
configurations, used in the webservices subsystem are
<code>Standard-Client-Config</code> and <code>Standard-Endpoint-Config</code> respectively.</p>
</div>
</div>
<div class="sect7">
<h8 id="handlers-classloading"><a class="anchor" href="#handlers-classloading"></a>Handlers classloading</h8>
<div class="paragraph">
<p>When setting a server-wide handler, please note the handler class needs
to be available through each ws deployment classloader. As a consequence
proper module dependencies might need to be specified in the deployments
that are going to leverage a given predefined configuration. A shortcut
is to add a dependency to the module containing the handler class in one
of the modules which are already automatically set as dependencies to
any deployment, for instance <code>org.jboss.ws.spi</code>.</p>
</div>
</div>
<div class="sect7">
<h8 id="examples-predefined-endpoint"><a class="anchor" href="#examples-predefined-endpoint"></a>Examples</h8>
<div class="listingblock">
<div class="title">JBoss AS 7.2 default configurations</div>
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;subsystem xmlns="urn:jboss:domain:webservices:2.0"&gt;
&lt;!-- ... --&gt;
&lt;endpoint-config name="Standard-Endpoint-Config"/&gt;
&lt;endpoint-config name="Recording-Endpoint-Config"&gt;
&lt;pre-handler-chain name="recording-handlers" protocol-bindings="##SOAP11_HTTP ##SOAP11_HTTP_MTOM ##SOAP12_HTTP ##SOAP12_HTTP_MTOM"&gt;
&lt;handler name="RecordingHandler" class="org.jboss.ws.common.invocation.RecordingServerHandler"/&gt;
&lt;/pre-handler-chain&gt;
&lt;/endpoint-config&gt;
&lt;client-config name="Standard-Client-Config"/&gt;
&lt;/subsystem&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">A configuration file for a deployment specific ws-security endpoint</div>
<p>setup</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;jaxws-config xmlns="urn:jboss:jbossws-jaxws-config:4.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
xmlns:javaee="http://java.sun.com/xml/ns/javaee" xsi:schemaLocation="urn:jboss:jbossws-jaxws-config:4.0 schema/jbossws-jaxws-config_4_0.xsd"&gt;
&lt;endpoint-config&gt;
&lt;config-name&gt;Custom WS-Security Endpoint&lt;/config-name&gt;
&lt;property&gt;
&lt;property-name&gt;ws-security.signature.properties&lt;/property-name&gt;
&lt;property-value&gt;bob.properties&lt;/property-value&gt;
&lt;/property&gt;
&lt;property&gt;
&lt;property-name&gt;ws-security.encryption.properties&lt;/property-name&gt;
&lt;property-value&gt;bob.properties&lt;/property-value&gt;
&lt;/property&gt;
&lt;property&gt;
&lt;property-name&gt;ws-security.signature.username&lt;/property-name&gt;
&lt;property-value&gt;bob&lt;/property-value&gt;
&lt;/property&gt;
&lt;property&gt;
&lt;property-name&gt;ws-security.encryption.username&lt;/property-name&gt;
&lt;property-value&gt;alice&lt;/property-value&gt;
&lt;/property&gt;
&lt;property&gt;
&lt;property-name&gt;ws-security.callback-handler&lt;/property-name&gt;
&lt;property-value&gt;org.jboss.test.ws.jaxws.samples.wsse.policy.basic.KeystorePasswordCallback&lt;/property-value&gt;
&lt;/property&gt;
&lt;/endpoint-config&gt;
&lt;/jaxws-config&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">JBoss AS 7.2 default configurations modified to default to SOAP</div>
<p>messages schema-validation on</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;subsystem xmlns="urn:jboss:domain:webservices:2.0"&gt;
&lt;!-- ... --&gt;
&lt;endpoint-config name="Standard-Endpoint-Config"&gt;
&lt;property name="schema-validation-enabled" value="true"/&gt;
&lt;/endpoint-config&gt;
&lt;!-- ... --&gt;
&lt;client-config name="Standard-Client-Config"&gt;
&lt;property name="schema-validation-enabled" value="true"/&gt;
&lt;/client-config&gt;
&lt;/subsystem&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="sect6">
<h7 id="endpointconfig-annotation"><a class="anchor" href="#endpointconfig-annotation"></a>EndpointConfig annotation</h7>
<div class="paragraph">
<p>Once a configuration is available to a given application, the
<code>org.jboss.ws.api.annotation.EndpointConfig</code> annotation is used to
assign an endpoint configuration to a Jakarta XML Web Services endpoint implementation.
When assigning a configuration that is defined in the webservices
subsystem only the configuration name is specified. When assigning a
configuration that is defined in the application, the relative path to
the deployment descriptor and the configuration name must be specified.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">@EndpointConfig(configFile = "WEB-INF/my-endpoint-config.xml", configName = "Custom WS-Security Endpoint")
public class ServiceImpl implements ServiceIface
{
public String sayHello()
{
return "Secure Hello World!";
}
}</code></pre>
</div>
</div>
</div>
<div class="sect6">
<h7 id="jaxws-feature"><a class="anchor" href="#jaxws-feature"></a>JAXWS Feature</h7>
<div class="paragraph">
<p>The most practical way of setting a configuration is using
<code>org.jboss.ws.api.configuration.ClientConfigFeature</code>, a JAXWS <code>Feature</code>
extension provided by JBossWS:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">import org.jboss.ws.api.configuration.ClientConfigFeature;

...

Service service = Service.create(wsdlURL, serviceName);
Endpoint port = service.getPort(Endpoint.class, new ClientConfigFeature("META-INF/my-client-config.xml", "Custom Client Config"));
port.echo("Kermit");

... or ....

port = service.getPort(Endpoint.class, new ClientConfigFeature("META-INF/my-client-config.xml", "Custom Client Config"), true); //setup properties too from the configuration
port.echo("Kermit");
... or ...

port = service.getPort(Endpoint.class, new ClientConfigFeature(null, testConfigName)); //reads from current container configurations if available
port.echo("Kermit");</code></pre>
</div>
</div>
<div class="paragraph">
<p>JBossWS parses the specified configuration file. The configuration file
must be found as a resource by the classloader of the current thread.
The
<a href="http://anonsvn.jboss.org/repos/jbossws/spi/tags/jbossws-spi-2.1.0.Beta1/src/main/resources/schema/jbossws-jaxws-config_4_0.xsd">jbossws-jaxws-config
schema</a> defines the descriptor contents and is included in the
<em>jbossws-spi</em> artifact.</p>
</div>
</div>
<div class="sect6">
<h7 id="explicit-setup-through-api"><a class="anchor" href="#explicit-setup-through-api"></a>Explicit setup through API</h7>
<div class="paragraph">
<p>Alternatively, JBossWS API comes with facility classes that can be used
for assigning configurations when building a client. JAXWS handlers read
from client configurations as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">import org.jboss.ws.api.configuration.ClientConfigUtil;
import org.jboss.ws.api.configuration.ClientConfigurer;

...

Service service = Service.create(wsdlURL, serviceName);
Endpoint port = service.getPort(Endpoint.class);
BindingProvider bp = (BindingProvider)port;
ClientConfigUtil.setConfigHandlers(bp, "META-INF/my-client-config.xml", "Custom Client Config 1");
port.echo("Kermit");

...

ClientConfigurer configurer = ClientConfigUtil.resolveClientConfigurer();
configurer.setConfigHandlers(bp, "META-INF/my-client-config.xml", "Custom Client Config 2");
port.echo("Kermit");

...

configurer.setConfigHandlers(bp, "META-INF/my-client-config.xml", "Custom Client Config 3");
port.echo("Kermit");


...

configurer.setConfigHandlers(bp, null, "Container Custom Client Config"); //reads from current container configurations if available
port.echo("Kermit");</code></pre>
</div>
</div>
<div class="olist lowerroman">
<ol class="lowerroman" type="i">
<li>
<p>similarly, properties are read from client configurations as
follows:</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">import org.jboss.ws.api.configuration.ClientConfigUtil;
import org.jboss.ws.api.configuration.ClientConfigurer;

...

Service service = Service.create(wsdlURL, serviceName);
Endpoint port = service.getPort(Endpoint.class);

ClientConfigUtil.setConfigProperties(port, "META-INF/my-client-config.xml", "Custom Client Config 1");
port.echo("Kermit");

...

ClientConfigurer configurer = ClientConfigUtil.resolveClientConfigurer();
configurer.setConfigProperties(port, "META-INF/my-client-config.xml", "Custom Client Config 2");
port.echo("Kermit");

...

configurer.setConfigProperties(port, "META-INF/my-client-config.xml", "Custom Client Config 3");
port.echo("Kermit");


...

configurer.setConfigProperties(port, null, "Container Custom Client Config"); //reads from current container configurations if available
port.echo("Kermit");

...

configurer.setConfigProperties(port, null, null); //reads from current Elytron client configuration if available
port.echo("Kermit");</code></pre>
</div>
</div>
<div class="paragraph">
<p>The default <code>ClientConfigurer</code> implementation parses the specified
configuration file, if any, after having resolved it as a resources
using the current thread context classloader. The
<a href="http://anonsvn.jboss.org/repos/jbossws/spi/tags/jbossws-spi-2.1.0.Beta1/src/main/resources/schema/jbossws-jaxws-config_4_0.xsd">jbossws-jaxws-config
schema</a> defines the descriptor contents and is included in the
<em>jbossws-spi</em> artifact.</p>
</div>
<div class="paragraph">
<p>If WildFly Elytron client configuration is present, the client will automatically use SSL context and credentials (for HTTP Basic authentication or Username Token Profile) from this configuration if these were not already configured.</p>
</div>
</div>
</div>
<div class="sect5">
<h6 id="automatic-configuration-from-default-descriptors"><a class="anchor" href="#automatic-configuration-from-default-descriptors"></a>Automatic configuration from default descriptors</h6>
<div class="paragraph">
<p>In some cases, the application developer might not be aware of the
configuration that will need to be used for its client and endpoint
implementation, perhaps because that&#8217;s a concern of the application
deployer. In other cases, explicit usage (compile time dependency) of
JBossWS API might not be accepted. To cope with such scenarios, JBossWS
allows including default client ( <code>jaxws-client-config.xml</code>) and
endpoint ( <code>jaxws-endpoint-config.xml</code>) descriptor within the
application (in its root), which are parsed for getting configurations
any time a configuration file name is not specified.</p>
</div>
<div class="paragraph">
<p>If the configuration name is also not specified, JBossWS automatically
looks for a configuration named the same as</p>
</div>
<div class="ulist">
<ul>
<li>
<p>the endpoint implementation class (full qualified name), in case of
Jakarta XML Web Services endpoints;</p>
</li>
<li>
<p>the service endpoint interface (full qualified name), in case of
Jakarta XML Web Services clients.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>No automatic configuration name is selected for <code>Dispatch</code> clients.</p>
</div>
<div class="paragraph">
<p>So, for instance, an endpoint implementation class
<code>org.foo.bar.EndpointImpl</code> for which no pre-defined configuration is
explicitly set will cause JBossWS to look for a
<em>org.foo.bar.EndpointImpl</em> named configuration within a
<em>jaxws-endpoint-config.xml</em> descriptor in the root of the application
deployment. Similarly, on client side, a client proxy implementing
<code>org.foo.bar.Endpoint</code> interface (SEI) will have the setup read from a
<em>org.foo.bar.Endpoint</em> named configuration in <em>jaxws-client-config.xml</em>
descriptor.</p>
</div>
</div>
<div class="sect5">
<h6 id="automatic-configuration-assignment-from-container-setup"><a class="anchor" href="#automatic-configuration-assignment-from-container-setup"></a>Automatic configuration assignment from container setup</h6>
<div class="paragraph">
<p>JBossWS fall-backs to getting predefined configurations from the
container setup whenever no explicit configuration has been provided and
the default descriptors are either not available or do not contain
relevant configurations. This gives additional control on the Jakarta XML Web Services
client and endpoint setup to administrators, as the container setup can
be managed independently from the deployed applications.<br>
JBossWS hence accesses the webservices subsystem the same as explained
above for explicitly named configuration; the default configuration
names used for look are</p>
</div>
<div class="ulist">
<ul>
<li>
<p>the endpoint implementation class (full qualified name), in case of
Jakarta XML Web Services endpoints;</p>
</li>
<li>
<p>the service endpoint interface (full qualified name), in case of
Jakarta XML Web Services clients.<br>
<code>Dispatch</code> clients are not automatically configured. If no configuration
is found using names computed as above, the <code>Standard-Client-Config</code> and
<code>Standard-Endpoint-Config</code> configurations are used for clients and
endpoints respectively</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="Jakarta-XML-Web-Services-Authentication"><a class="anchor" href="#Jakarta-XML-Web-Services-Authentication"></a>16.5.9. Authentication</h4>
<div class="sect4">
<h5 id="Jakarta-XML-Web-Services-authentication"><a class="anchor" href="#Jakarta-XML-Web-Services-authentication"></a>Authentication</h5>
<div class="paragraph">
<p>Here the simplest way to authenticate a web service user with JBossWS is
explained.</p>
</div>
<div class="paragraph">
<p>First we secure the access to the SLSB as we would do for normal (non
web service) invocations: this can be easily done through the
@RolesAllowed, @PermitAll, @DenyAll annotation. The allowed user roles
can be set with these annotations both on the bean class and on any of
its business methods.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">@Stateless
@RolesAllowed("friend")
public class EndpointEJB implements EndpointInterface
{
  ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Similarly POJO endpoints are secured the same way as we do for normal
web applications in web.xml:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;security-constraint&gt;
  &lt;web-resource-collection&gt;
    &lt;web-resource-name&gt;All resources&lt;/web-resource-name&gt;
    &lt;url-pattern&gt;/*&lt;/url-pattern&gt;
  &lt;/web-resource-collection&gt;
  &lt;auth-constraint&gt;
    &lt;role-name&gt;friend&lt;/role-name&gt;
  &lt;/auth-constraint&gt;
&lt;/security-constraint&gt;

&lt;security-role&gt;
  &lt;role-name&gt;friend&lt;/role-name&gt;
&lt;/security-role&gt;</code></pre>
</div>
</div>
<div class="sect5">
<h6 id="specify-the-security-domain"><a class="anchor" href="#specify-the-security-domain"></a>Specify the security domain</h6>
<div class="paragraph">
<p>Next, specify the security domain for this deployment. This is performed
using the <code>@SecurityDomain</code> annotation for EJB3 endpoints</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">@Stateless
@SecurityDomain("JBossWS")
@RolesAllowed("friend")
public class EndpointEJB implements EndpointInterface
{
  ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>or modifying the jboss-web.xml for POJO endpoints</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;jboss-web&gt;
&lt;security-domain&gt;JBossWS&lt;/security-domain&gt;
&lt;/jboss-web&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The security domain as well as its the authentication and authorization
mechanisms are defined differently depending on the application server
version in use.</p>
</div>
</div>
<div class="sect5">
<h6 id="use-bindingprovider-to-set-principalcredential"><a class="anchor" href="#use-bindingprovider-to-set-principalcredential"></a>Use BindingProvider to set principal/credential</h6>
<div class="paragraph">
<p>A web service client may use the <code>javax.xml.ws.BindingProvider</code>
interface to set the username/password combination</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">URL wsdlURL = new File("resources/jaxws/samples/context/WEB-INF/wsdl/TestEndpoint.wsdl").toURL();
QName qname = new QName("http://org.jboss.ws/jaxws/context", "TestEndpointService");
Service service = Service.create(wsdlURL, qname);
port = (TestEndpoint)service.getPort(TestEndpoint.class);

BindingProvider bp = (BindingProvider)port;
bp.getRequestContext().put(BindingProvider.USERNAME_PROPERTY, "kermit");
bp.getRequestContext().put(BindingProvider.PASSWORD_PROPERTY, "thefrog");</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="using-http-basic-auth-for-security"><a class="anchor" href="#using-http-basic-auth-for-security"></a>Using HTTP Basic Auth for security</h6>
<div class="paragraph">
<p>To enable HTTP Basic authentication you use the <code>@WebContext</code> annotation
on the bean class</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">@Stateless
@SecurityDomain("JBossWS")
@RolesAllowed("friend")
@WebContext(contextRoot="/my-cxt", urlPattern="/*", authMethod="BASIC", transportGuarantee="NONE", secureWSDLAccess=false)
public class EndpointEJB implements EndpointInterface
{
  ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>For POJO endpoints, we modify the <em>web.xml</em> adding the auth-method
element:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;login-config&gt;
  &lt;auth-method&gt;BASIC&lt;/auth-method&gt;
  &lt;realm-name&gt;Test Realm&lt;/realm-name&gt;
&lt;/login-config&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="jaspi-authentication"><a class="anchor" href="#jaspi-authentication"></a>JASPI Authentication</h5>
<div class="paragraph">
<p>A Java Authentication SPI (JASPI) provider can be configured in WildFly
security subsystem to authenticate SOAP messages:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;security-domain name="jaspi"&gt;
&lt;authentication-jaspi&gt;
&lt;login-module-stack name="jaas-lm-stack"&gt;
&lt;login-module code="UsersRoles" flag="required"&gt;
&lt;module-option name="usersProperties" value="jbossws-users.properties"/&gt;
&lt;module-option name="rolesProperties" value="jbossws-roles.properties"/&gt;
&lt;/login-module&gt;
&lt;/login-module-stack&gt;
&lt;auth-module code="org.jboss.wsf.stack.cxf.jaspi.module.UsernameTokenServerAuthModule" login-module-stack-ref="jaas-lm-stack"/&gt;
&lt;/authentication-jaspi&gt;
&lt;/security-domain&gt;</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
For further information on configuring security domains in WildFly,
please refer to
<a href="https://docs.jboss.org/author/display/WFLY9/Security+subsystem+configuration">here</a>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Here
<code>org.jboss.wsf.stack.cxf.jaspi.module.UsernameTokenServerAuthModule</code> is
the class implementing
<code>javax.security.auth.message.module.ServerAuthModule</code>, which delegates
to the proper login module to perform authentication using the
credentials from WS-Security UsernameToken in the incoming SOAP message.
Alternative implementations of <code>ServerAuthModule</code> can be implemented and
configured.</p>
</div>
<div class="paragraph">
<p>To enable JASPI authentication, the endpoint deployment needs to specify
the security domain to use; that can be done in two different ways:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Setting the <code>jaspi.security.domain</code> property in the
<code>jboss-webservices.xml</code> descriptor</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;?xml version="1.1" encoding="UTF-8"?&gt;
&lt;webservices
xmlns="http://www.jboss.com/xml/ns/javaee"
xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
version="1.2"
xsi:schemaLocation="http://www.jboss.com/xml/ns/javaee"&gt;

&lt;property&gt;
&lt;name&gt;jaspi.security.domain&lt;/name&gt;
&lt;value&gt;jaspi&lt;/value&gt;
&lt;/property&gt;

&lt;/webservices&gt;</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Referencing (through <code>@EndpointConfig</code> annotation) an endpoint config
that sets the <code>jaspi.security.domain</code> property</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">@EndpointConfig(configFile = "WEB-INF/jaxws-endpoint-config.xml", configName = "jaspiSecurityDomain")
public class ServiceEndpointImpl implements ServiceIface {</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>jaspi.security.domain</code> property is specified as follows in the
referenced descriptor:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;jaxws-config xmlns="urn:jboss:jbossws-jaxws-config:4.0"
xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:javaee="http://java.sun.com/xml/ns/javaee"
xsi:schemaLocation="urn:jboss:jbossws-jaxws-config:4.0 schema/jbossws-jaxws-config_4_0.xsd"&gt;
&lt;endpoint-config&gt;
&lt;config-name&gt;jaspiSecurityDomain&lt;/config-name&gt;
&lt;property&gt;
&lt;property-name&gt;jaspi.security.domain&lt;/property-name&gt;
&lt;property-value&gt;jaspi&lt;/property-value&gt;
&lt;/property&gt;
&lt;/endpoint-config&gt;
&lt;/jaxws-config&gt;</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If the JASPI security domain is specified in both
<code>jboss-webservices.xml</code> and config file referenced by <code>@EndpointConfig</code>
annotation, the JASPI security domain specified in
<code>jboss-webservices.xml</code> will take precedence.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect3">
<h4 id="Apache_CXF_integration"><a class="anchor" href="#Apache_CXF_integration"></a>16.5.10. Apache CXF integration</h4>
<div class="sect4">
<h5 id="jbossws-integration-layer-with-apache-cxf"><a class="anchor" href="#jbossws-integration-layer-with-apache-cxf"></a>JBossWS integration layer with Apache CXF</h5>
<div class="paragraph">
<p>All Jakarta XML Web Services functionalities provided by JBossWS on top of WildFly are
currently served through a proper integration of the JBoss Web Services
stack with most of the <a href="http://cxf.apache.org/">Apache CXF</a> project
modules.</p>
</div>
<div class="paragraph">
<p>Apache CXF is an open source services framework. It allows building and
developing services using frontend programming APIs (including Jakarta XML Web Services),
with services speaking a variety of protocols such as SOAP and XML/HTTP
over a variety of transports such as HTTP and Jakarta Messaging.</p>
</div>
<div class="paragraph">
<p>The integration layer ( <em>JBossWS-CXF</em> in short hereafter) is mainly
meant for:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>allowing using standard webservices APIs (including Jakarta XML Web Services) on
WildFly; this is performed internally leveraging Apache CXF without
requiring the user to deal with it;</p>
</li>
<li>
<p>allowing using Apache CXF advanced features (including WS-*) on top of
WildFly without requiring the user to deal with / setup / care about the
required integration steps for running in such a container.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In order for achieving the goals above, the JBossWS-CXF integration
supports the JBoss ws endpoint deployment mechanism and comes with many
internal customizations on top of Apache CXF.</p>
</div>
<div class="paragraph">
<p>In the next sections a list of technical suggestions and notes on the
integration is provided; please also refer to the
<a href="http://cxf.apache.org/docs/index.html">Apache CXF official documentation</a>
for in-depth details on the CXF architecture.</p>
</div>
</div>
<div class="sect4">
<h5 id="building-ws-applications-the-jboss-way"><a class="anchor" href="#building-ws-applications-the-jboss-way"></a>Building WS applications the JBoss way</h5>
<div class="paragraph">
<p>The Apache CXF client and endpoint configuration as explained in the
<a href="http://cxf.apache.org/docs/index.html">Apache CXF official user guide</a> is
heavily based on Spring. Apache CXF basically parses Spring <code>cxf.xml</code>
descriptors; those may contain any basic bean plus specific ws client
and endpoint beans which CXF has custom parsers for. Apache CXF can be
used to deploy webservice endpoints on any servlet container by
including its libraries in the deployment; in such a scenario Spring
basically serves as a convenient configuration option, given direct
Apache CXF API usage won&#8217;t be very handy. Similar reasoning applies on
client side, where a Spring based descriptor offers a shortcut for
setting up Apache CXF internals.</p>
</div>
<div class="paragraph">
<p>This said, nowadays almost any Apache CXF functionality can be
configured and used through direct API usage, without Spring. As a
consequence of that and given the considerations in the sections below,
the JBossWS integration with Apache CXF does not rely on Spring
descriptors.</p>
</div>
<div class="sect5">
<h6 id="portable-applications"><a class="anchor" href="#portable-applications"></a>Portable applications</h6>
<div class="paragraph">
<p>WildFly is much more then a servlet container; it actually provides
users with a fully compliant target platform for Jakarta EE applications.</p>
</div>
<div class="paragraph">
<p>Generally speaking, <em>users are encouraged to write portable
applications</em> by relying only on <em>Jakarta XML Web Services specification</em> whenever
possible. That would by the way ensure easy migrations to and from other
compliant platforms. Being a Jakarta EE container, WildFly already comes
with a Jakarta XML Web Services compliant implementation, which is basically Apache CXF
plus the JBossWS-CXF integration layer. So users just need to write
their Jakarta XML Web Services application; <em>no need for embedding any Apache CXF or any
ws related dependency library in user deployments</em>. Please refer to the
<a href="#Jakarta_XML_Web_Services_User_Guide">Jakarta XML Web Services User Guide</a> section of the documentation for
getting started.</p>
</div>
<div class="paragraph">
<p>WS-* usage (including WS-Security, WS-Addressing, WS-ReliableMessaging,
&#8230;&#8203;) should also be configured in the most portable way; that is by
<em>relying on proper WS-Policy assertions</em> on the endpoint WSDL contracts,
so that client and endpoint configuration is basically a matter of
setting few ws context properties. The WS-* related sections of this
documentation cover all the details on configuring applications making
use of WS-* through policies.</p>
</div>
<div class="paragraph">
<p>As a consequence of the reasoning above, the JBossWS-CXF integration is
currently built directly on the Apache CXF API and aims at allowing
users to configure webservice clients and endpoints <em>without Spring
descriptors</em>.</p>
</div>
</div>
<div class="sect5">
<h6 id="direct-apache-cxf-api-usage"><a class="anchor" href="#direct-apache-cxf-api-usage"></a>Direct Apache CXF API usage</h6>
<div class="paragraph">
<p>Whenever users can&#8217;t really meet their application requirements with
Jakarta XML Web Services plus WS-Policy, it is of course still possible to rely on direct
Apache CXF API usage (given that&#8217;s included in the AS), loosing the Java
EE portability of the application. That could be the case of a user
needing specific Apache CXF functionalities, or having to consume WS-*
enabled endpoints advertised through legacy wsdl contracts without
WS-Policy assertions.</p>
</div>
<div class="paragraph">
<p>On server side, direct Apache CXF API usage might not be always possible
or end up being not very easy. For this reason, the JBossWS integration
comes with a convenient alternative through customization options in the
<code>jboss-webservices.xml</code> descriptor described below on this page.
Properties can be declared in <code>jboss-webservices.xml</code> to control Apache
CXF internals like <em>interceptors</em>, <em>features</em>, etc.</p>
</div>
</div>
</div>
<div class="sect4">
<h5 id="bus-usage"><a class="anchor" href="#bus-usage"></a>Bus usage</h5>
<div class="sect5">
<h6 id="creating-a-bus-instance"><a class="anchor" href="#creating-a-bus-instance"></a>Creating a Bus instance</h6>
<div class="paragraph">
<p>Most of the Apache CXF features are configurable using the
<code>org.apache.cxf.Bus</code> class. While for basic Jakarta XML Web Services usage the user might
never need to explicitly deal with Bus, using Apache CXF specific
features generally requires getting a handle to a <code>org.apache.cxf.Bus</code>
instance. This can happen on client side as well as in a ws endpoint or
handler business code.</p>
</div>
<div class="paragraph">
<p>New Bus instances are produced by the currently configured
<code>org.apache.cxf.BusFactory</code> implementation the following way:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">Bus bus = BusFactory.newInstance().createBus();</code></pre>
</div>
</div>
<div class="paragraph">
<p>The algorithm for selecting the actual implementation of <code>BusFactory</code> to
be used leverages the Service API, basically looking for optional
configurations in <em>META-INF/services/&#8230;&#8203;</em> location using the current
thread context classloader. JBossWS-CXF integration comes with its own
implementation of <code>BusFactory</code>,
<code>org.jboss.wsf.stack.cxf.client.configuration.JBossWSBusFactory</code>, that
allows for seamless setup of JBossWS customizations on top of Apache
CXF. So, assuming the JBossWS-CXF libraries are available in the current
thread context classloader, the <code>JBossWSBusFactory</code> is <em>automatically</em>
retrieved by the <code>BusFactory.newInstance()</code> call above.</p>
</div>
<div class="paragraph">
<p>JBossWS users willing to explicitly use functionalities of
<code>org.apache.cxf.bus.CXFBusFactory</code> <em>,</em> get the same API with JBossWS
additions through <code>JBossWSBusFactory</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">Map&lt;Class, Object&gt; myExtensions = new HashMap&lt;Class, Object&gt;();
myExtensions.put(...);
Bus bus = new JBossWSBusFactory().createBus(myExtensions);</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="using-existing-bus-instances"><a class="anchor" href="#using-existing-bus-instances"></a>Using existing Bus instances</h6>
<div class="paragraph">
<p>Apache CXF keeps reference to a global default <code>Bus</code> instance as well as
to a thread default bus for each thread. That is performed through
static members in <code>org.apache.cxf.BusFactory</code> <em>,</em> which also comes with
the following methods in the public API:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">public static synchronized Bus getDefaultBus()
public static synchronized Bus getDefaultBus(boolean createIfNeeded)
public static synchronized void setDefaultBus(Bus bus)
public static Bus getThreadDefaultBus()
public static Bus getThreadDefaultBus(boolean createIfNeeded)
public static void setThreadDefaultBus(Bus bus)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Please note that the default behaviour of <code>getDefaultBus()</code> <em>/</em>
<code>getDefaultBus(true)</code> <em>/</em> <code>getThreadDefaultBus()</code> <em>/</em>
<code>getThreadDefaultBus(true)</code> is to create a new Bus instance if that&#8217;s
not set yet. Moreover <em>getThreadDefaultBus()</em> and
<em>getThreadDefaultBus(true)</em> first fallback to retrieving the configured
global default bus before actually trying creating a new instance (and
the created new instance is set as global default bus if that was not
set there yet).</p>
</div>
<div class="paragraph">
<p>The drawback of this mechanism (which is basically fine in JSE
environment) is that when running in WildFly container you need to be
careful in order not to (mis)use a bus over multiple applications
(assuming the Apache CXF classes are loaded by the same classloader,
which is currently the case with WildFly).</p>
</div>
<div class="paragraph">
<p>Here is a list of general suggestions to avoid problems when running
in-container:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>forget about the global default bus; you don&#8217;t need that, so don&#8217;t do
<code>getDefaultBus()</code> <em>/</em> <code>getDefaultBus(true)</code> <em>/</em> <code>setDefaultBus()</code> in
your code;</p>
</li>
<li>
<p>avoid <code>getThreadDefaultBus()</code> <em>/</em> <code>getThreadDefaultBus(true)</code> unless
you already know for sure the default bus is already set;</p>
</li>
<li>
<p>keep in mind thread pooling whenever you customize a thread default
bus instance (for instance adding bus scope interceptors, &#8230;&#8203;), as that
thread and bus might be later reused; so either shutdown the bus when
you&#8217;re done or explicitly remove it from the BusFactory thread
association.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Finally, remember that each time you explictly create a new Bus instance
(factory.createBus()) that is set as thread default bus and global
default bus if those are not set yet. The JAXWS <code>Provider</code>
implementation also creates <code>Bus</code> instances internally, in particular
the JBossWS version of JAXWS <code>Provider</code> makes sure the default bus is
never internally used and instead a new <code>Bus</code> is created if required
(more details on this in the next paragraph).</p>
</div>
</div>
<div class="sect5">
<h6 id="bus-selection-strategies-for-jaxws-clients"><a class="anchor" href="#bus-selection-strategies-for-jaxws-clients"></a>Bus selection strategies for JAXWS clients</h6>
<div class="paragraph">
<p>JAXWS clients require an Apache CXF Bus to be available; the client is
registered within the Bus and the Bus affects the client behavior (e.g.
through the configured CXF interceptors). The way a bus is internally
selected for serving a given JAXWS client is very important, especially
for in-container clients; for this reason, JBossWS users can choose the
preferred Bus selection strategy. The strategy is enforced in the
<code>javax.xml.ws.spi.Provider</code> implementation from the JBossWS integration,
being that called whenever a JAXWS <code>Service</code> (client) is requested.</p>
</div>
<div class="sect6">
<h7 id="thread-bus-strategy-thread_bus"><a class="anchor" href="#thread-bus-strategy-thread_bus"></a>Thread bus strategy (THREAD_BUS)</h7>
<div class="paragraph">
<p>Each time the vanilla JAXWS api is used to create a Bus, the JBossWS-CXF
integration will automatically make sure a Bus is currently associated
to the current thread in the BusFactory. If that&#8217;s not the case, a new
Bus is created and linked to the current thread (to prevent the user
from relying on the default Bus). The Apache CXF engine will then create
the client using the current thread Bus.</p>
</div>
<div class="paragraph">
<p>This is the default strategy, and the most straightforward one in Java
SE environments; it lets users automatically reuse a previously created
Bus instance and allows using customized Bus that can possibly be
created and associated to the thread before building up a JAXWS client.</p>
</div>
<div class="paragraph">
<p>The drawback of the strategy is that the link between the Bus instance
and the thread needs to be eventually cleaned up (when not needed
anymore). This is really evident in a Jakarta EE environment (hence when
running in-container), as threads from pools (e.g. serving web requests)
are re-used.</p>
</div>
<div class="paragraph">
<p>When relying on this strategy, the safest approach to be sure of
cleaning up the link is to surround the JAXWS client with a
<code>try/finally</code> block as below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">try {
  Service service = Service.create(wsdlURL, serviceQName);
  MyEndpoint port = service.getPort(MyEndpoint.class);
  //...
} finally {
  BusFactory.setThreadDefaultBus(null);
  // OR (if you don't need the bus and the client anymore)
   Bus bus = BusFactory.getThreadDefaultBus(false);
  bus.shutdown(true);
}</code></pre>
</div>
</div>
</div>
<div class="sect6">
<h7 id="new-bus-strategy-new_bus"><a class="anchor" href="#new-bus-strategy-new_bus"></a>New bus strategy (NEW_BUS)</h7>
<div class="paragraph">
<p>Another strategy is to have the JAXWS Provider from the JBossWS
integration create a new Bus each time a JAXWS client is built. The main
benefit of this approach is that a fresh bus won&#8217;t rely on any formerly
cached information (e.g. cached WSDL / schemas) which might have changed
after the previous client creation. The main drawback is of course worse
performance as the Bus creation takes time.</p>
</div>
<div class="paragraph">
<p>If there&#8217;s a bus already associated to the current thread before the
JAXWS client creation, that is automatically restored when returning
control to the user; in other words, the newly created bus will be used
only for the created JAXWS client but won&#8217;t stay associated to the
current thread at the end of the process. Similarly, if the thread was
not associated to any bus before the client creation, no bus will be
associated to the thread at the end of the client creation.</p>
</div>
</div>
<div class="sect6">
<h7 id="thread-context-classloader-bus-strategy-tccl_bus"><a class="anchor" href="#thread-context-classloader-bus-strategy-tccl_bus"></a>Thread context classloader bus strategy (TCCL_BUS)</h7>
<div class="paragraph">
<p>The last strategy is to have the bus created for serving the client be
associated to the current thread context classloader (TCCL). That
basically means the same Bus instance is shared by JAXWS clients running
when the same TCCL is set. This is particularly interesting as each web
application deployment usually has its own context classloader, so this
strategy is possibly a way to keep the number of created Bus instances
bound to the application number in WildFly container.</p>
</div>
<div class="paragraph">
<p>If there&#8217;s a bus already associated to the current thread before the
JAXWS client creation, that is automatically restored when returning
control to the user; in other words, the bus corresponding to the
current thread context classloader will be used only for the created
JAXWS client but won&#8217;t stay associated to the current thread at the end
of the process. If the thread was not associated to any bus before the
client creation, a new bus will be created (and later user for any other
client built with this strategy and the same TCCL in place); no bus will
be associated to the thread at the end of the client creation.</p>
</div>
</div>
<div class="sect6">
<h7 id="strategy-configuration"><a class="anchor" href="#strategy-configuration"></a>Strategy configuration</h7>
<div class="paragraph">
<p>Users can request a given Bus selection strategy to be used for the
client being built by specifying one of the following JBossWS features
(which extend <code>javax</code> <code>.</code> <code>xml</code> <code>.</code> <code>ws</code> <code>.</code> <code>WebServiceFeature</code>):</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Feature</th>
<th class="tableblock halign-left valign-top">Strategy</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">org.jboss.wsf.stack.cxf.client.UseThreadBusFeature</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">THREAD_BUS</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">org.jboss.wsf.stack.cxf.client.UseNewBusFeature</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">NEW_BUS</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">org.jboss.wsf.stack.cxf.client.UseTCCLBusFeature</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TCCL_BUS</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The feature is specified as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">Service service = Service.create(wsdlURL, serviceQName, new UseThreadBusFeature());</code></pre>
</div>
</div>
<div class="paragraph">
<p>If no feature is explicitly specified, the system default strategy is
used, which can be modified through the
<code>org.jboss.ws.cxf.jaxws-client.bus.strategy</code> system property when
starting the JVM. The valid values for the property are <code>THREAD_BUS</code>,
<code>NEW_BUS</code> and <code>TCCL_BUS</code>. The default is <code>THREAD_BUS</code>.</p>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="server-side-integration-customization"><a class="anchor" href="#server-side-integration-customization"></a>Server Side Integration Customization</h5>
<div class="paragraph">
<p>The JBossWS-CXF server side integration takes care of internally
creating proper Apache CXF structures (including a <code>Bus</code> instance, of
course) for the provided ws deployment. Should the deployment include
multiple endpoints, those would all live within the same Apache CXF Bus,
which would of course be completely separated by the other deployments'
bus instances.</p>
</div>
<div class="paragraph">
<p>While JBossWS sets sensible defaults for most of the Apache CXF
configuration options on server side, users might want to fine tune the
<code>Bus</code> instance that&#8217;s created for their deployment; a
<code>jboss-webservices.xml</code> descriptor can be used for deployment level
customizations.</p>
</div>
<div class="sect5">
<h6 id="deployment-descriptor-properties"><a class="anchor" href="#deployment-descriptor-properties"></a>Deployment descriptor properties</h6>
<div class="paragraph">
<p>The <code>jboss-webservices.xml</code> descriptor can be used to
<a href="#JAX_WS_Advanced_User_Guide">provide property values</a>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;webservices xmlns="http://www.jboss.com/xml/ns/javaee" version="1.2"&gt;
  ...
  &lt;property&gt;
    &lt;name&gt;...&lt;/name&gt;
    &lt;value&gt;...&lt;/value&gt;
  &lt;/property&gt;
  ...
&lt;/webservices&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>JBossWS-CXF integration comes with a set of allowed property names to
control Apache CXF internals.</p>
</div>
<div class="sect6">
<h7 id="workqueue-configuration"><a class="anchor" href="#workqueue-configuration"></a>WorkQueue configuration</h7>
<div class="paragraph">
<p>Apache CXF uses WorkQueue instances for dealing with some operations
(e.g. @Oneway requests processing). A
<a href="http://cxf.apache.org/javadoc/latest-2.5.x/org/apache/cxf/workqueue/WorkQueueManager.html">WorkQueueManager</a>
is installed in the Bus as an extension and allows for adding / removing
queues as well as controlling the existing ones.</p>
</div>
<div class="paragraph">
<p>On server side, queues can be provided by using the
<code>cxf.queue.&lt;queue-name&gt;.*</code> properties in <code>jboss-webservices.xml</code> (e.g.
<code>cxf.queue.default.maxQueueSize</code> for controlling the max queue size of
the <code>default</code> workqueue). At deployment time, the JBossWS integration
can add new instances of
<a href="http://cxf.apache.org/javadoc/latest-2.5.x/org/apache/cxf/workqueue/AutomaticWorkQueueImpl.html">AutomaticWorkQueueImpl</a>
to the currently configured WorkQueueManager; the properties below are
used to fill in parameter into the
<a href="http://cxf.apache.org/javadoc/latest-2.5.x/org/apache/cxf/workqueue/AutomaticWorkQueueImpl.html#AutomaticWorkQueueImpl(int,%20int,%20int,%20int,%20long,%20java.lang.String)">AutomaticWorkQueueImpl
constructor</a>:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Property</th>
<th class="tableblock halign-left valign-top">Default value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">cxf.queue.&lt;queue-name&gt;.maxQueueSize</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">256</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">cxf.queue.&lt;queue-name&gt;.initialThreads</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">cxf.queue.&lt;queue-name&gt;.highWaterMark</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">25</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">cxf.queue.&lt;queue-name&gt;.lowWaterMark</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">5</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">cxf.queue.&lt;queue-name&gt;.dequeueTimeout</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">120000</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect6">
<h7 id="policy-alternative-selector"><a class="anchor" href="#policy-alternative-selector"></a>Policy alternative selector</h7>
<div class="paragraph">
<p>The Apache CXF policy engine supports different strategies to deal with
policy alternatives. JBossWS-CXF integration currently defaults to the
<a href="http://cxf.apache.org/javadoc/latest-2.5.x/org/apache/cxf/ws/policy/selector/MaximalAlternativeSelector.html">MaximalAlternativeSelector</a>,
but still allows for setting different selector implementation using the
<code>cxf.policy.alternativeSelector</code> property in <code>jboss-webservices.xml</code>.</p>
</div>
</div>
<div class="sect6">
<h7 id="mbean-management"><a class="anchor" href="#mbean-management"></a>MBean management</h7>
<div class="paragraph">
<p>Apache CXF allows managing its MBean objects that are installed into the
WildFly MBean server. The feature is enabled on a deployment basis
through the <code>cxf.management.enabled</code> property in
<code>jboss-webservices.xml</code>. The
<code>cxf.management.installResponseTimeInterceptors</code> property can also be
used to control installation of CXF response time interceptors, which
are added by default when enabling MBean management, but might not be
desired in some cases. Here is an example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;webservices xmlns="http://www.jboss.com/xml/ns/javaee" version="1.2"&gt;
  &lt;property&gt;
    &lt;name&gt;cxf.management.enabled&lt;/name&gt;
    &lt;value&gt;true&lt;/value&gt;
  &lt;/property&gt;
  &lt;property&gt;
    &lt;name&gt;cxf.management.installResponseTimeInterceptors&lt;/name&gt;
    &lt;value&gt;false&lt;/value&gt;
  &lt;/property&gt;
&lt;/webservices&gt;</code></pre>
</div>
</div>
</div>
<div class="sect6">
<h7 id="schema-validation"><a class="anchor" href="#schema-validation"></a>Schema validation</h7>
<div class="paragraph">
<p>Schema validation of exchanged messages can also be enabled in
<code>jboss-webservices.xml</code>. Further details available
<a href="#Jakarta_XML_Web_Services_User_Guide">here</a>.</p>
</div>
</div>
<div class="sect6">
<h7 id="Interceptors"><a class="anchor" href="#Interceptors"></a>Interceptors</h7>
<div class="paragraph">
<p>The <code>jboss-webservices.xml</code> descriptor also allows specifying the
<code>cxf.interceptors.in</code> and <code>cxf.interceptors.out</code> properties; those
allows declaring interceptors to be attached to the Bus instance that&#8217;s
created for serving the deployment.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;?xml version="1.1" encoding="UTF-8"?&gt;
&lt;webservices
xmlns="http://www.jboss.com/xml/ns/javaee"
xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
version="1.2"
xsi:schemaLocation="http://www.jboss.com/xml/ns/javaee"&gt;

&lt;property&gt;
&lt;name&gt;cxf.interceptors.in&lt;/name&gt;
&lt;value&gt;org.jboss.test.ws.jaxws.cxf.interceptors.BusInterceptor&lt;/value&gt;
&lt;/property&gt;
&lt;property&gt;
&lt;name&gt;cxf.interceptors.out&lt;/name&gt;
&lt;value&gt;org.jboss.test.ws.jaxws.cxf.interceptors.BusCounterInterceptor&lt;/value&gt;
&lt;/property&gt;
&lt;/webservices&gt;</code></pre>
</div>
</div>
</div>
<div class="sect6">
<h7 id="features"><a class="anchor" href="#features"></a>Features</h7>
<div class="paragraph">
<p>The <code>jboss-webservices.xml</code> descriptor also allows specifying the
<code>cxf.features</code> property; that allows declaring features to be attached
to any endpoint belonging to the Bus instance that&#8217;s created for serving
the deployment.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;?xml version="1.1" encoding="UTF-8"?&gt;
&lt;webservices
xmlns="http://www.jboss.com/xml/ns/javaee"
xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
version="1.2"
xsi:schemaLocation="http://www.jboss.com/xml/ns/javaee"&gt;

&lt;property&gt;
&lt;name&gt;cxf.features&lt;/name&gt;
&lt;value&gt;org.apache.cxf.feature.FastInfosetFeature&lt;/value&gt;
&lt;/property&gt;
&lt;/webservices&gt;</code></pre>
</div>
</div>
</div>
<div class="sect6">
<h7 id="ws-discovery-enablement"><a class="anchor" href="#ws-discovery-enablement"></a>WS-Discovery enablement</h7>
<div class="paragraph">
<p>WS-Discovery support can be turned on in <code>jboss-webservices</code> for the
current deployment. Further details available <a href="#Jakarta_XML_Web_Services_User_Guide">here</a>.</p>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="apache-cxf-interceptors"><a class="anchor" href="#apache-cxf-interceptors"></a>Apache CXF interceptors</h5>
<div class="paragraph">
<p>Apache CXF supports declaring interceptors using one of the following
approaches:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Annotation usage on endpoint classes (
<code>@org.apache.cxf.interceptor.InInterceptor</code>,
<code>@org.apache.cxf.interceptor.OutInterceptor</code>)</p>
</li>
<li>
<p>Direct API usage on client side (through the
<code>org.apache.cxf.interceptor.InterceptorProvider</code> interface)</p>
</li>
<li>
<p>Spring descriptor usage ( <em>cxf.xml</em>)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>As the Spring descriptor usage is not supported, the JBossWS integration
adds an additional descriptor based approach to avoid requiring
modifications to the actual client/endpoint code. Users can declare
interceptors within <a href="#Predefined_client_and_endpoint_configurations">predefined client and endpoint
configurations</a> by specifying a list of interceptor class names for the
<code>cxf.interceptors.in</code> and <code>cxf.interceptors.out</code> properties.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;jaxws-config xmlns="urn:jboss:jbossws-jaxws-config:4.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:javaee="http://java.sun.com/xml/ns/javaee"
xsi:schemaLocation="urn:jboss:jbossws-jaxws-config:4.0 schema/jbossws-jaxws-config_4_0.xsd"&gt;
&lt;endpoint-config&gt;
&lt;config-name&gt;org.jboss.test.ws.jaxws.cxf.interceptors.EndpointImpl&lt;/config-name&gt;
&lt;property&gt;
&lt;property-name&gt;cxf.interceptors.in&lt;/property-name&gt;
&lt;property-value&gt;org.jboss.test.ws.jaxws.cxf.interceptors.EndpointInterceptor,org.jboss.test.ws.jaxws.cxf.interceptors.FooInterceptor&lt;/property-value&gt;
&lt;/property&gt;
&lt;property&gt;
&lt;property-name&gt;cxf.interceptors.out&lt;/property-name&gt;
&lt;property-value&gt;org.jboss.test.ws.jaxws.cxf.interceptors.EndpointCounterInterceptor&lt;/property-value&gt;
&lt;/property&gt;
&lt;/endpoint-config&gt;
&lt;/jaxws-config&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>A new instance of each specified interceptor class will be added to the
client or endpoint the configuration is assigned to. The interceptor
classes must have a no-argument constructor.</p>
</div>
</div>
<div class="sect4">
<h5 id="apache-cxf-features"><a class="anchor" href="#apache-cxf-features"></a>Apache CXF features</h5>
<div class="paragraph">
<p>Apache CXF supports declaring features using one of the following
approaches:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Annotation usage on endpoint classes (
<code>@org.apache.cxf.feature.Features</code>)</p>
</li>
<li>
<p>Direct API usage on client side (through extensions of the
<code>org.apache.cxf.feature.AbstractFeature</code> class)</p>
</li>
<li>
<p>Spring descriptor usage ( <em>cxf.xml</em>)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>As the Spring descriptor usage is not supported, the JBossWS integration
adds an additional descriptor based approach to avoid requiring
modifications to the actual client/endpoint code. Users can declare
features within <a href="#Predefined_client_and_endpoint_configurations">predefined client and endpoint
configurations</a> by specifying a list of feature class names for the
<code>cxf.features</code> property.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;jaxws-config xmlns="urn:jboss:jbossws-jaxws-config:4.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:javaee="http://java.sun.com/xml/ns/javaee"
xsi:schemaLocation="urn:jboss:jbossws-jaxws-config:4.0 schema/jbossws-jaxws-config_4_0.xsd"&gt;
&lt;endpoint-config&gt;
&lt;config-name&gt;Custom FI Config&lt;/config-name&gt;
&lt;property&gt;
&lt;property-name&gt;cxf.features&lt;/property-name&gt;
&lt;property-value&gt;org.apache.cxf.feature.FastInfosetFeature&lt;/property-value&gt;
&lt;/property&gt;
&lt;/endpoint-config&gt;
&lt;/jaxws-config&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>A new instance of each specified feature class will be added to the
client or endpoint the configuration is assigned to. The feature classes
must have a no-argument constructor.</p>
</div>
</div>
<div class="sect4">
<h5 id="properties-driven-bean-creation"><a class="anchor" href="#properties-driven-bean-creation"></a>Properties driven bean creation</h5>
<div class="paragraph">
<p>Sections above explain how to declare CXF interceptors and features
through properties either in a client/endpoint predefined configuration
or in a <code>jboss-webservices.xml</code> descriptor. By getting the
feature/interceptor class name only specified, the container simply
tries to create a bean instance using the class default constructor.
This sets a limitation on the feature/interceptor configuration, unless
custom extensions of vanilla CXF classes are provided, with the default
constructor setting properties before eventually using the super
constructor.</p>
</div>
<div class="paragraph">
<p>To cope with this issue, JBossWS integration comes with a mechanism for
configuring simple bean hierarchies when building them up from
properties. Properties can have bean reference values, that is strings
starting with <code>##</code>. Property reference keys are used to specify the bean
class name and the value for for each attribute. So for instance the
following properties:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Key</th>
<th class="tableblock halign-left valign-top">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">cxf.features</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><mark>foo, </mark>bar</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">##foo</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">org.jboss.Foo</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">##foo.par</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">34</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">##bar</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">org.jboss.Bar</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">##bar.color</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">blue</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>would result into the stack installing two feature instances, the same
that would have been created by</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">import org.Bar;
import org.Foo;

...

Foo foo = new Foo();
foo.setPar(34);
Bar bar = new Bar();
bar.setColor("blue");</code></pre>
</div>
</div>
<div class="paragraph">
<p>The mechanism assumes that the classes are valid beans with proper
getter and setter methods; value objects are cast to the correct
primitive type by inspecting the class definition. Nested beans can of
course be configured.</p>
</div>
</div>
<div class="sect4">
<h5 id="httpconduit-configuration"><a class="anchor" href="#httpconduit-configuration"></a>HTTPConduit configuration</h5>
<div class="paragraph">
<p>HTTP transport setup in Apache CXF is achieved through
<code>org.apache.cxf.transport.http.HTTPConduit</code>
<a href="http://cxf.apache.org/docs/client-http-transport-including-ssl-support.html">configurations</a>.
When running on top of the JBossWS integration, conduits can be
programmatically modified using the Apache CXF API as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">import org.apache.cxf.frontend.ClientProxy;
import org.apache.cxf.transport.http.HTTPConduit;
import org.apache.cxf.transports.http.configuration.HTTPClientPolicy;

//set chunking threshold before using a Jakarta XML Web Services port client
...
HTTPConduit conduit = (HTTPConduit)ClientProxy.getClient(port).getConduit();
HTTPClientPolicy client = conduit.getClient();

client.setChunkingThreshold(8192);
...</code></pre>
</div>
</div>
<div class="paragraph">
<p>Users can also control the default values for the most common
HTTPConduit parameters by setting specific system properties; the
provided values will override Apache CXF defaut values.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Property</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">cxf.client.allowChunking</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A boolean to tell Apache CXF whether to allow
send messages using chunking.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">cxf.client.chunkingThreshold</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">An integer value to tell Apache CXF the
threshold at which switching from non-chunking to chunking mode.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">cxf.client.connectionTimeout</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A long value to tell Apache CXF how many
milliseconds to set the connection timeout to</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">cxf.client.receiveTimeout</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A long value to tell Apache CXF how many
milliseconds to set the receive timeout to</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">cxf.client.connection</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A string to tell Apache CXF to use Keep-Alive or
close connection type</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">cxf.tls-client.disableCNCheck</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A boolean to tell Apache CXF whether
disabling CN host name check or not</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The vanilla Apache CXF defaults apply when the system properties above
are not set.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="WS-Addressing"><a class="anchor" href="#WS-Addressing"></a>16.5.11. WS-Addressing</h4>
<div class="paragraph">
<p>JBoss Web Services inherits full WS-Addressing capabilities from the
underlying Apache CXF implementation. Apache CXF provides support for
2004-08 and <a href="http://www.w3.org/TR/ws-addr-core/">1.0</a> versions of
WS-Addressing.</p>
</div>
<div class="sect4">
<h5 id="enabling-ws-addressing"><a class="anchor" href="#enabling-ws-addressing"></a>Enabling WS-Addressing</h5>
<div class="paragraph">
<p>WS-Addressing can be turned on in multiple standard ways:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>consuming a WSDL contract that specifies a WS-Addressing assertion /
policy</p>
</li>
<li>
<p>using the <code>@javax.xml.ws.soap.Addressing</code> annotation</p>
</li>
<li>
<p>using the <code>javax.xml.ws.soap.AddressingFeature</code> feature</p>
</li>
</ul>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
The supported addressing policy elements are:
</td>
</tr>
</table>
</div>
<div class="literalblock">
<div class="content">
<pre>[http://www.w3.org/2005/02/addressing/wsdl]UsingAddressing
[http://schemas.xmlsoap.org/ws/2004/08/addressing/policy]UsingAddressing
[http://www.w3.org/2006/05/addressing/wsdl]UsingAddressing
[http://www.w3.org/2007/05/addressing/metadata]Addressing</pre>
</div>
</div>
<div class="paragraph">
<p>Alternatively, Apache CXF proprietary ways are also available:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>specifying the ﻿ <em>[<a href="http://cxf.apache.org/ws/addressing" class="bare">http://cxf.apache.org/ws/addressing</a>]addressing</em>
feature for a given client/endpoint</p>
</li>
<li>
<p>using the <code>org.apache.cxf.ws.addressing.WSAddressingFeature</code> feature
through the API</p>
</li>
<li>
<p>manually configuring the Apache CXF addressing interceptors (
<code>org.apache.cxf.ws.addressing.MAPAggregator</code> and
<code>org.apache.cxf.ws.addressing.soap.MAPCodec</code>)</p>
</li>
<li>
<p>setting the <em>org.apache.cxf.ws.addressing.using</em> property in the
message context</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Please refer to the the Apache CXF documentation for further information
on the proprietary
<a href="http://cxf.apache.org/docs/ws-addressing.html">WS-Addressing setup</a> and
<a href="http://cxf.apache.org/docs/wsaconfiguration.html">configuration details</a>.</p>
</div>
</div>
<div class="sect4">
<h5 id="ws-addressing-policy"><a class="anchor" href="#ws-addressing-policy"></a>WS-Addressing Policy</h5>
<div class="paragraph">
<p>The WS-Addressing support is also perfectly integrated with the Apache
CXF WS-Policy engine.</p>
</div>
<div class="paragraph">
<p>This basically means that the WSDL contract generation for code-first
endpoint deployment is policy-aware: users can annotate endpoints with
the <code>@</code> <code>javax.xml.ws.soap.</code> <code>Addressing</code> annotation and expect the
published WSDL contract to contain proper WS-Addressing policy (assuming
no <code>wsdlLocation</code> is specified in the endpoint&#8217;s <code>@WebService</code>
annotation).</p>
</div>
<div class="paragraph">
<p>Similarly, on client side users do not need to manually specify the
<code>javax.xml.ws.soap.AddressingFeature</code> feature, as the policy engine is
able to properly process the WS-Addressing policy in the consumed WSDL
and turn on addressing as requested.</p>
</div>
</div>
<div class="sect4">
<h5 id="example-ws-addressing"><a class="anchor" href="#example-ws-addressing"></a>Example</h5>
<div class="paragraph">
<p>Here is an example showing how to simply enable WS-Addressing through
WS-Policy.</p>
</div>
<div class="sect5">
<h6 id="endpoint-ws-addressing"><a class="anchor" href="#endpoint-ws-addressing"></a>Endpoint</h6>
<div class="paragraph">
<p>A simple Jakarta XML Web Services endpoint is prepared using a java-first approach;
WS-Addressing is enforced through <code>@Addressing</code> annotation and no
<code>wsdlLocation</code> is provided in <code>@WebService</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">package org.jboss.test.ws.jaxws.samples.wsa;

import javax.jws.WebService;
import javax.xml.ws.soap.Addressing;
import org.jboss.logging.Logger;

@WebService
(
   portName = "AddressingServicePort",
   serviceName = "AddressingService",
   targetNamespace = "http://www.jboss.org/jbossws/ws-extensions/wsaddressing",
   endpointInterface = "org.jboss.test.ws.jaxws.samples.wsa.ServiceIface"
)
@Addressing(enabled=true, required=true)
public class ServiceImpl implements ServiceIface
{
   private Logger log = Logger.getLogger(this.getClass());

   public String sayHello(String name)
   {
      return "Hello " + name + "!";
   }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The WSDL contract that&#8217;s generated at deploy time and published looks
like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;wsdl:definitions ....&gt;
...
  &lt;wsdl:binding name="AddressingServiceSoapBinding" type="tns:ServiceIface"&gt;
    &lt;soap:binding style="document" transport="http://schemas.xmlsoap.org/soap/http"/&gt;
    &lt;wsaw:UsingAddressing wsdl:required="true"/&gt;
    &lt;wsp:PolicyReference URI="#AddressingServiceSoapBinding_WSAM_Addressing_Policy"/&gt;

    &lt;wsdl:operation name="sayHello"&gt;
      &lt;soap:operation soapAction="" style="document"/&gt;
      &lt;wsdl:input name="sayHello"&gt;
        &lt;soap:body use="literal"/&gt;
      &lt;/wsdl:input&gt;
      &lt;wsdl:output name="sayHelloResponse"&gt;
        &lt;soap:body use="literal"/&gt;
      &lt;/wsdl:output&gt;
    &lt;/wsdl:operation&gt;

  &lt;/wsdl:binding&gt;
  &lt;wsdl:service name="AddressingService"&gt;
    &lt;wsdl:port binding="tns:AddressingServiceSoapBinding" name="AddressingServicePort"&gt;
      &lt;soap:address location="http://localhost:8080/jaxws-samples-wsa"/&gt;
    &lt;/wsdl:port&gt;
  &lt;/wsdl:service&gt;
    &lt;wsp:Policy wsu:Id="AddressingServiceSoapBinding_WSAM_Addressing_Policy"
       xmlns:wsu="http://docs.oasis-open.org/wss/2004/01/oasis-200401-wss-wssecurity-utility-1.0.xsd"&gt;
      &lt;wsam:Addressing xmlns:wsam="http://www.w3.org/2007/05/addressing/metadata"&gt;
        &lt;wsp:Policy/&gt;
      &lt;/wsam:Addressing&gt;
    &lt;/wsp:Policy&gt;
&lt;/wsdl:definitions&gt;</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="client-addressing"><a class="anchor" href="#client-addressing"></a>Client</h6>
<div class="paragraph">
<p>Since the WS-Policy engine is on by default, the client side code is
basically a pure Jakarta XML Web Services client app:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">QName serviceName = new QName("http://www.jboss.org/jbossws/ws-extensions/wsaddressing", "AddressingService");
URL wsdlURL = new URL("http://localhost:8080/jaxws-samples-wsa?wsdl");
Service service = Service.create(wsdlURL, serviceName);
ServiceIface proxy = (ServiceIface)service.getPort(ServiceIface.class);
proxy.sayHello("World");</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="WS-Security"><a class="anchor" href="#WS-Security"></a>16.5.12. WS-Security</h4>
<div class="sect4">
<h5 id="ws-security-overview"><a class="anchor" href="#ws-security-overview"></a>WS-Security overview</h5>
<div class="paragraph">
<p>WS-Security provides the means to secure your services beyond transport
level protocols such as <em>HTTPS</em>. Through a number of standards such as
<a href="http://www.w3.org/TR/xmlenc-core/">XML-Encryption</a>, and headers defined
in the
<a href="http://www.oasis-open.org/committees/tc_home.php?wg_abbrev=wss">WS-Security</a>
standard, it allows you to:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Pass authentication tokens between services.</p>
</li>
<li>
<p>Encrypt messages or parts of messages.</p>
</li>
<li>
<p>Sign messages.</p>
</li>
<li>
<p>Timestamp messages.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>WS-Security makes heavy use of public and private key cryptography. It
is helpful to understand these basics to really understand how to
configure WS-Security. With public key cryptography, a user has a pair
of public and private keys. These are generated using a large prime
number and a key function.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="_images/Public_key_making.png" alt="images/Public_key_making.png"></span></p>
</div>
<div class="paragraph">
<p>The keys are related mathematically, but cannot be derived from one
another. With these keys we can encrypt messages. For example, if Bob
wants to send a message to Alice, he can encrypt a message using her
public key. Alice can then decrypt this message using her private key.
Only Alice can decrypt this message as she is the only one with the
private key.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="_images/Public_key_encryption-mod.svg.png" alt="images/Public_key_encryption-mod.svg.png"></span></p>
</div>
<div class="paragraph">
<p>Messages can also be signed. This allows you to ensure the authenticity
of the message. If Alice wants to send a message to Bob, and Bob wants
to be sure that it is from Alice, Alice can sign the message using her
private key. Bob can then verify that the message is from Alice by using
her public key.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="_images/250px-Public_key_making.svg.png" alt="images/250px-Public_key_making.svg.png"></span></p>
</div>
</div>
<div class="sect4">
<h5 id="jboss-ws-security-support"><a class="anchor" href="#jboss-ws-security-support"></a>JBoss WS-Security support</h5>
<div class="paragraph">
<p>JBoss Web Services supports many real world scenarios requiring
WS-Security functionalities. This includes signature and encryption
support through X509 certificates, authentication and authorization
through username tokens as well as all ws-security configurations
covered by WS-
<a href="http://docs.oasis-open.org/ws-sx/ws-securitypolicy/v1.3/ws-securitypolicy.html">SecurityPolicy</a>
specification.</p>
</div>
<div class="paragraph">
<p><a href="#Apache_CXF_integration">As well as for other WS-* features</a>, the core of
WS-Security functionalities is provided through the Apache CXF engine.
On top of that the JBossWS integration adds few configuration
enhancements to simplify the setup of WS-Security enabled endpoints.</p>
</div>
<div class="sect5">
<h6 id="apache-cxf-ws-security-implementation"><a class="anchor" href="#apache-cxf-ws-security-implementation"></a>Apache CXF WS-Security implementation</h6>
<div class="paragraph">
<p>Apache CXF features a top class WS-Security module supporting multiple
configurations and easily extendible.</p>
</div>
<div class="paragraph">
<p>The system is based on <em>interceptors</em> that delegate to
<a href="http://ws.apache.org/wss4j">Apache WSS4J</a> for the low level security
operations. Interceptors can be configured in different ways, either
through Spring configuration files or directly using Apache CXF client
API. Please refer to the
<a href="http://cxf.apache.org/docs/ws-security.html">Apache CXF documentation</a> if
you&#8217;re looking for more details.</p>
</div>
<div class="paragraph">
<p>Recent versions of Apache CXF, however, introduced support for
WS-Security Policy, which aims at moving most of the security
configuration into the service contract (through policies), so that
clients can easily be configured almost completely automatically from
that. This way users do not need to manually deal with configuring /
installing the required interceptors; the Apache CXF WS-Policy engine
internally takes care of that instead.</p>
</div>
<div class="sect6">
<h7 id="ws-security-policy-support"><a class="anchor" href="#ws-security-policy-support"></a>WS-Security Policy support</h7>
<div class="paragraph">
<p>WS-SecurityPolicy describes the actions that are required to securely
communicate with a service advertised in a given WSDL contract. The WSDL
bindings / operations reference WS-Policy fragments with the security
requirements to interact with the service. The
<a href="http://docs.oasis-open.org/ws-sx/ws-securitypolicy/v1.3/ws-securitypolicy.html">WS-SecurityPolicy
specification</a> allows for specifying things like asymmetric/symmetric
keys, using transports (https) for encryption, which parts/headers to
encrypt or sign, whether to sign then encrypt or encrypt then sign,
whether to include timestamps, whether to use derived keys, etc.</p>
</div>
<div class="paragraph">
<p>However some mandatory configuration elements are not covered by
WS-SecurityPolicy, basically because they&#8217;re not meant to be public /
part of the published endpoint contract; those include things such as
keystore locations, usernames and passwords, etc. Apache CXF allows
configuring these elements either through Spring xml descriptors or
using the client API / annotations. Below is the list of supported
configuration properties:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">ws-security.username</th>
<th class="tableblock halign-left valign-top">The username used for UsernameToken policy
assertions</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ws-security.password</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The password used for UsernameToken policy
assertions. If not specified, the callback handler will be called.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ws-security.callback-handler</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The WSS4J security CallbackHandler that
will be used to retrieve passwords for keystores and UsernameTokens.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ws-security.signature.properties</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The properties file/object that
contains the WSS4J properties for configuring the signature keystore and
crypto objects</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ws-security.encryption.properties</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The properties file/object that
contains the WSS4J properties for configuring the encryption keystore
and crypto objects</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ws-security.signature.username</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The username or alias for the key in
the signature keystore that will be used. If not specified, it uses the
the default alias set in the properties file. If that&#8217;s also not set,
and the keystore only contains a single key, that key will be used.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ws-security.encryption.username</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The username or alias for the key in
the encryption keystore that will be used. If not specified, it uses the
the default alias set in the properties file. If that&#8217;s also not set,
and the keystore only contains a single key, that key will be used. For
the web service provider, the useReqSigCert keyword can be used to
accept (encrypt to) any client whose public key is in the service&#8217;s
truststore (defined in ws-security.encryption.properties.)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ws-security.signature.crypto</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Instead of specifying the signature
properties, this can point to the full WSS4J Crypto object. This can
allow easier "programmatic" configuration of the Crypto information."</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ws-security.encryption.crypto</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Instead of specifying the encryption
properties, this can point to the full WSS4J Crypto object. This can
allow easier "programmatic" configuration of the Crypto information."</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ws-security.enable.streaming</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Enable streaming (StAX based) processing
of WS-Security messages</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Here is an example of configuration using the client API:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">Map&lt;String, Object&gt; ctx = ((BindingProvider)port).getRequestContext();
ctx.put("ws-security.encryption.properties", properties);
port.echoString("hello");</code></pre>
</div>
</div>
<div class="paragraph">
<p>Please refer to the
<a href="http://cxf.apache.org/docs/ws-securitypolicy.html">Apache CXF
documentation</a> for additional configuration details.</p>
</div>
</div>
</div>
<div class="sect5">
<h6 id="jbossws-configuration-additions"><a class="anchor" href="#jbossws-configuration-additions"></a>JBossWS configuration additions</h6>
<div class="paragraph">
<p>In order for removing the need of Spring on server side for setting up
WS-Security configuration properties not covered by policies, the
JBossWS integration allows for getting those pieces of information from
a defined <em>endpoint configuration</em>. <a href="#Predefined_client_and_endpoint_configurations">Endpoint
configurations</a>can include property declarations and endpoint
implementations can be associated with a given endpoint configuration
using the <code>@EndpointConfig</code> annotation.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;jaxws-config xmlns="urn:jboss:jbossws-jaxws-config:4.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xmlns:javaee="http://java.sun.com/xml/ns/javaee" xsi:schemaLocation="urn:jboss:jbossws-jaxws-config:4.0 schema/jbossws-jaxws-config_4_0.xsd"&gt;
  &lt;endpoint-config&gt;
    &lt;config-name&gt;Custom WS-Security Endpoint&lt;/config-name&gt;
    &lt;property&gt;
      &lt;property-name&gt;ws-security.signature.properties&lt;/property-name&gt;
      &lt;property-value&gt;bob.properties&lt;/property-value&gt;
    &lt;/property&gt;
    &lt;property&gt;
      &lt;property-name&gt;ws-security.encryption.properties&lt;/property-name&gt;
      &lt;property-value&gt;bob.properties&lt;/property-value&gt;
    &lt;/property&gt;
    &lt;property&gt;
      &lt;property-name&gt;ws-security.signature.username&lt;/property-name&gt;
      &lt;property-value&gt;bob&lt;/property-value&gt;
    &lt;/property&gt;
    &lt;property&gt;
      &lt;property-name&gt;ws-security.encryption.username&lt;/property-name&gt;
      &lt;property-value&gt;alice&lt;/property-value&gt;
    &lt;/property&gt;
    &lt;property&gt;
      &lt;property-name&gt;ws-security.callback-handler&lt;/property-name&gt;
      &lt;property-value&gt;org.jboss.test.ws.jaxws.samples.wsse.policy.basic.KeystorePasswordCallback&lt;/property-value&gt;
    &lt;/property&gt;
  &lt;/endpoint-config&gt;
&lt;/jaxws-config&gt;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">import javax.jws.WebService;
import org.jboss.ws.api.annotation.EndpointConfig;

@WebService
(
   portName = "SecurityServicePort",
   serviceName = "SecurityService",
   wsdlLocation = "WEB-INF/wsdl/SecurityService.wsdl",
   targetNamespace = "http://www.jboss.org/jbossws/ws-extensions/wssecuritypolicy",
   endpointInterface = "org.jboss.test.ws.jaxws.samples.wsse.policy.basic.ServiceIface"
)
@EndpointConfig(configFile = "WEB-INF/jaxws-endpoint-config.xml", configName = "Custom WS-Security Endpoint")
public class ServiceImpl implements ServiceIface
{
   public String sayHello()
   {
      return "Secure Hello World!";
   }
}</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="apache-cxf-annotations"><a class="anchor" href="#apache-cxf-annotations"></a>Apache CXF annotations</h6>
<div class="paragraph">
<p>The JBossWS configuration additions allow for a descriptor approach to
the WS-Security Policy engine configuration. If you prefer to provide
the same information through an annotation approach, you can leverage
the Apache CXF <code>@org.apache.cxf.annotations.EndpointProperties</code>
annotation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">@WebService(
   ...
)
@EndpointProperties(value = {
      @EndpointProperty(key = "ws-security.signature.properties", value = "bob.properties"),
      @EndpointProperty(key = "ws-security.encryption.properties", value = "bob.properties"),
      @EndpointProperty(key = "ws-security.signature.username", value = "bob"),
      @EndpointProperty(key = "ws-security.encryption.username", value = "alice"),
      @EndpointProperty(key = "ws-security.callback-handler", value = "org.jboss.test.ws.jaxws.samples.wsse.policy.basic.KeystorePasswordCallback")
      }
)
public class ServiceImpl implements ServiceIface {
   ...
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="examples-ws-security"><a class="anchor" href="#examples-ws-security"></a>Examples</h5>
<div class="paragraph">
<p>In this section some sample of WS-Security service endpoints and clients
are provided. Please note they&#8217;re only meant as tutorials; you should
really careful isolate the ws-security policies / assertion that best
suite your security needs before going to production environment.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
The following sections provide directions and examples on understanding
some of the configuration options for WS-Security engine. Please note
the implementor remains responsible for assessing the application
requirements and choosing the most suitable security policy for them.
</td>
</tr>
</table>
</div>
<div class="sect5">
<h6 id="signature-and-encryption"><a class="anchor" href="#signature-and-encryption"></a>Signature and encryption</h6>
<div class="sect6">
<h7 id="endpoint-ws-security"><a class="anchor" href="#endpoint-ws-security"></a>Endpoint</h7>
<div class="paragraph">
<p>First of all you need to create the web service endpoint using Jakarta XML Web Services.
While this can generally be achieved in different ways, it&#8217;s required to
use a contract-first approach when using WS-Security, as the policies
declared in the wsdl are parsed by the Apache CXF engine on both server
and client sides. So, here is an example of WSDL contract enforcing
signature and encryption using X 509 certificates (the referenced schema
is omitted):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;?xml version="1.0" encoding="UTF-8" standalone="yes"?&gt;
&lt;definitions targetNamespace="http://www.jboss.org/jbossws/ws-extensions/wssecuritypolicy" name="SecurityService"
  xmlns:tns="http://www.jboss.org/jbossws/ws-extensions/wssecuritypolicy"
  xmlns:xsd="http://www.w3.org/2001/XMLSchema"
  xmlns:soap="http://schemas.xmlsoap.org/wsdl/soap/"
  xmlns="http://schemas.xmlsoap.org/wsdl/"
  xmlns:wsp="http://www.w3.org/ns/ws-policy"
        xmlns:wsu="http://docs.oasis-open.org/wss/2004/01/oasis-200401-wss-wssecurity-utility-1.0.xsd"
        xmlns:wsaws="http://www.w3.org/2005/08/addressing"
        xmlns:sp="http://schemas.xmlsoap.org/ws/2005/07/securitypolicy"&gt;
  &lt;types&gt;
    &lt;xsd:schema&gt;
      &lt;xsd:import namespace="http://www.jboss.org/jbossws/ws-extensions/wssecuritypolicy" schemaLocation="SecurityService_schema1.xsd"/&gt;
    &lt;/xsd:schema&gt;
  &lt;/types&gt;
  &lt;message name="sayHello"&gt;
    &lt;part name="parameters" element="tns:sayHello"/&gt;
  &lt;/message&gt;
  &lt;message name="sayHelloResponse"&gt;
    &lt;part name="parameters" element="tns:sayHelloResponse"/&gt;
  &lt;/message&gt;
  &lt;portType name="ServiceIface"&gt;
    &lt;operation name="sayHello"&gt;
      &lt;input message="tns:sayHello"/&gt;
      &lt;output message="tns:sayHelloResponse"/&gt;
    &lt;/operation&gt;
  &lt;/portType&gt;
  &lt;binding name="SecurityServicePortBinding" type="tns:ServiceIface"&gt;
    &lt;wsp:PolicyReference URI="#SecurityServiceSignThenEncryptPolicy"/&gt;
    &lt;soap:binding transport="http://schemas.xmlsoap.org/soap/http" style="document"/&gt;
    &lt;operation name="sayHello"&gt;
      &lt;soap:operation soapAction=""/&gt;
      &lt;input&gt;
        &lt;soap:body use="literal"/&gt;
      &lt;/input&gt;
      &lt;output&gt;
        &lt;soap:body use="literal"/&gt;
      &lt;/output&gt;
    &lt;/operation&gt;
  &lt;/binding&gt;
  &lt;service name="SecurityService"&gt;
    &lt;port name="SecurityServicePort" binding="tns:SecurityServicePortBinding"&gt;
      &lt;soap:address location="http://localhost:8080/jaxws-samples-wssePolicy-sign-encrypt"/&gt;
    &lt;/port&gt;
  &lt;/service&gt;

  &lt;wsp:Policy wsu:Id="SecurityServiceSignThenEncryptPolicy" xmlns:sp="http://schemas.xmlsoap.org/ws/2005/07/securitypolicy"&gt;
    &lt;wsp:ExactlyOne&gt;
      &lt;wsp:All&gt;
        &lt;sp:AsymmetricBinding xmlns:sp="http://schemas.xmlsoap.org/ws/2005/07/securitypolicy"&gt;
          &lt;wsp:Policy&gt;
            &lt;sp:InitiatorToken&gt;
              &lt;wsp:Policy&gt;
                &lt;sp:X509Token sp:IncludeToken="http://schemas.xmlsoap.org/ws/2005/07/securitypolicy/IncludeToken/AlwaysToRecipient"&gt;
                  &lt;wsp:Policy&gt;
                    &lt;sp:WssX509V1Token11/&gt;
                  &lt;/wsp:Policy&gt;
                  &lt;/sp:X509Token&gt;
              &lt;/wsp:Policy&gt;
            &lt;/sp:InitiatorToken&gt;
            &lt;sp:RecipientToken&gt;
              &lt;wsp:Policy&gt;
                &lt;sp:X509Token sp:IncludeToken="http://schemas.xmlsoap.org/ws/2005/07/securitypolicy/IncludeToken/Never"&gt;
                  &lt;wsp:Policy&gt;
                    &lt;sp:WssX509V1Token11/&gt;
                  &lt;/wsp:Policy&gt;
                &lt;/sp:X509Token&gt;
              &lt;/wsp:Policy&gt;
            &lt;/sp:RecipientToken&gt;
            &lt;sp:AlgorithmSuite&gt;
              &lt;wsp:Policy&gt;
                &lt;sp:TripleDesRsa15/&gt;
              &lt;/wsp:Policy&gt;
            &lt;/sp:AlgorithmSuite&gt;
            &lt;sp:Layout&gt;
              &lt;wsp:Policy&gt;
                &lt;sp:Lax/&gt;
              &lt;/wsp:Policy&gt;
            &lt;/sp:Layout&gt;
            &lt;sp:IncludeTimestamp/&gt;
            &lt;sp:EncryptSignature/&gt;
            &lt;sp:OnlySignEntireHeadersAndBody/&gt;
            &lt;sp:SignBeforeEncrypting/&gt;
          &lt;/wsp:Policy&gt;
        &lt;/sp:AsymmetricBinding&gt;
        &lt;sp:SignedParts xmlns:sp="http://schemas.xmlsoap.org/ws/2005/07/securitypolicy"&gt;
          &lt;sp:Body/&gt;
        &lt;/sp:SignedParts&gt;
        &lt;sp:EncryptedParts xmlns:sp="http://schemas.xmlsoap.org/ws/2005/07/securitypolicy"&gt;
          &lt;sp:Body/&gt;
        &lt;/sp:EncryptedParts&gt;
        &lt;sp:Wss10 xmlns:sp="http://schemas.xmlsoap.org/ws/2005/07/securitypolicy"&gt;
          &lt;wsp:Policy&gt;
            &lt;sp:MustSupportRefIssuerSerial/&gt;
          &lt;/wsp:Policy&gt;
        &lt;/sp:Wss10&gt;
      &lt;/wsp:All&gt;
    &lt;/wsp:ExactlyOne&gt;
  &lt;/wsp:Policy&gt;
&lt;/definitions&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The service endpoint can be generated using the <code>wsconsume</code> tool and
then enriched with a <code>@EndpointConfig</code> annotation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">package org.jboss.test.ws.jaxws.samples.wsse.policy.basic;

import javax.jws.WebService;
import org.jboss.ws.api.annotation.EndpointConfig;

@WebService
(
   portName = "SecurityServicePort",
   serviceName = "SecurityService",
   wsdlLocation = "WEB-INF/wsdl/SecurityService.wsdl",
   targetNamespace = "http://www.jboss.org/jbossws/ws-extensions/wssecuritypolicy",
   endpointInterface = "org.jboss.test.ws.jaxws.samples.wsse.policy.basic.ServiceIface"
)
@EndpointConfig(configFile = "WEB-INF/jaxws-endpoint-config.xml", configName = "Custom WS-Security Endpoint")
public class ServiceImpl implements ServiceIface
{
   public String sayHello()
   {
      return "Secure Hello World!";
   }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The referenced <em>jaxws-endpoint-config.xml</em> descriptor is used to provide
a custom endpoint configuration with the required server side
configuration properties; this tells the engine which certificate / key
to use for signature / signature verification and for encryption /
decryption:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;jaxws-config xmlns="urn:jboss:jbossws-jaxws-config:4.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xmlns:javaee="http://java.sun.com/xml/ns/javaee" xsi:schemaLocation="urn:jboss:jbossws-jaxws-config:4.0 schema/jbossws-jaxws-config_4_0.xsd"&gt;
  &lt;endpoint-config&gt;
    &lt;config-name&gt;Custom WS-Security Endpoint&lt;/config-name&gt;
    &lt;property&gt;
      &lt;property-name&gt;ws-security.signature.properties&lt;/property-name&gt;
      &lt;property-value&gt;bob.properties&lt;/property-value&gt;
    &lt;/property&gt;
    &lt;property&gt;
      &lt;property-name&gt;ws-security.encryption.properties&lt;/property-name&gt;
      &lt;property-value&gt;bob.properties&lt;/property-value&gt;
    &lt;/property&gt;
    &lt;property&gt;
      &lt;property-name&gt;ws-security.signature.username&lt;/property-name&gt;
      &lt;property-value&gt;bob&lt;/property-value&gt;
    &lt;/property&gt;
    &lt;property&gt;
      &lt;property-name&gt;ws-security.encryption.username&lt;/property-name&gt;
      &lt;property-value&gt;alice&lt;/property-value&gt;
    &lt;/property&gt;
    &lt;property&gt;
      &lt;property-name&gt;ws-security.callback-handler&lt;/property-name&gt;
      &lt;property-value&gt;org.jboss.test.ws.jaxws.samples.wsse.policy.basic.KeystorePasswordCallback&lt;/property-value&gt;
    &lt;/property&gt;
  &lt;/endpoint-config&gt;
&lt;/jaxws-config&gt;</code></pre>
</div>
</div>
<div class="olist lowerroman">
<ol class="lowerroman" type="i">
<li>
<p>the <em>bob.properties</em> configuration file is also referenced above; it
includes the WSS4J Crypto properties which in turn link to the keystore
file, type and the alias/password to use for accessing it:</p>
</li>
</ol>
</div>
<div class="literalblock">
<div class="content">
<pre>org.apache.ws.security.crypto.provider=org.apache.ws.security.components.crypto.Merlin
org.apache.ws.security.crypto.merlin.keystore.type=jks
org.apache.ws.security.crypto.merlin.keystore.password=password
org.apache.ws.security.crypto.merlin.keystore.alias=bob
org.apache.ws.security.crypto.merlin.keystore.file=bob.jks</pre>
</div>
</div>
<div class="paragraph">
<p>A callback handler for the letting Apache CXF access the keystore is
also provided:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">package org.jboss.test.ws.jaxws.samples.wsse.policy.basic;

import java.io.IOException;
import java.util.HashMap;
import java.util.Map;
import javax.security.auth.callback.Callback;
import javax.security.auth.callback.CallbackHandler;
import javax.security.auth.callback.UnsupportedCallbackException;
import org.apache.ws.security.WSPasswordCallback;

public class KeystorePasswordCallback implements CallbackHandler {
   private Map&lt;String, String&gt; passwords = new HashMap&lt;String, String&gt;();

   public KeystorePasswordCallback() {
      passwords.put("alice", "password");
      passwords.put("bob", "password");
   }

   /**
    * It attempts to get the password from the private
    * alias/passwords map.
    */
   public void handle(Callback[] callbacks) throws IOException, UnsupportedCallbackException {
      for (int i = 0; i &lt; callbacks.length; i++) {
         WSPasswordCallback pc = (WSPasswordCallback)callbacks[i];

         String pass = passwords.get(pc.getIdentifier());
         if (pass != null) {
            pc.setPassword(pass);
            return;
         }
      }
   }

   /**
    * Add an alias/password pair to the callback mechanism.
    */
   public void setAliasPassword(String alias, String password) {
      passwords.put(alias, password);
   }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Assuming the <em>bob.jks</em> keystore has been properly generated and contains
Bob&#8217;s (server) full key (private/certificate + public key) as well as
Alice&#8217;s (client) public key, we can proceed to packaging the endpoint.
Here is the expected content (the endpoint is a <em>POJO</em> one in a <em>war</em>
archive, but <em>EJB3</em> endpoints in <em>jar</em> archives are of course also
supported):</p>
</div>
<div class="literalblock">
<div class="content">
<pre>alessio@inuyasha /dati/jbossws/stack/cxf/trunk $ jar -tvf ./modules/testsuite/cxf-tests/target/test-libs/jaxws-samples-wsse-policy-sign-encrypt.war
     0 Thu Jun 16 18:50:48 CEST 2011 META-INF/
   140 Thu Jun 16 18:50:46 CEST 2011 META-INF/MANIFEST.MF
     0 Thu Jun 16 18:50:48 CEST 2011 WEB-INF/
   586 Thu Jun 16 18:50:44 CEST 2011 WEB-INF/web.xml
     0 Thu Jun 16 18:50:48 CEST 2011 WEB-INF/classes/
     0 Thu Jun 16 18:50:48 CEST 2011 WEB-INF/classes/org/
     0 Thu Jun 16 18:50:48 CEST 2011 WEB-INF/classes/org/jboss/
     0 Thu Jun 16 18:50:48 CEST 2011 WEB-INF/classes/org/jboss/test/
     0 Thu Jun 16 18:50:48 CEST 2011 WEB-INF/classes/org/jboss/test/ws/
     0 Thu Jun 16 18:50:48 CEST 2011 WEB-INF/classes/org/jboss/test/ws/jaxws/
     0 Thu Jun 16 18:50:48 CEST 2011 WEB-INF/classes/org/jboss/test/ws/jaxws/samples/
     0 Thu Jun 16 18:50:48 CEST 2011 WEB-INF/classes/org/jboss/test/ws/jaxws/samples/wsse/
     0 Thu Jun 16 18:50:48 CEST 2011 WEB-INF/classes/org/jboss/test/ws/jaxws/samples/wsse/policy/
     0 Thu Jun 16 18:50:48 CEST 2011 WEB-INF/classes/org/jboss/test/ws/jaxws/samples/wsse/policy/basic/
  1687 Thu Jun 16 18:50:48 CEST 2011 WEB-INF/classes/org/jboss/test/ws/jaxws/samples/wsse/policy/basic/KeystorePasswordCallback.class
   383 Thu Jun 16 18:50:48 CEST 2011 WEB-INF/classes/org/jboss/test/ws/jaxws/samples/wsse/policy/basic/ServiceIface.class
  1070 Thu Jun 16 18:50:48 CEST 2011 WEB-INF/classes/org/jboss/test/ws/jaxws/samples/wsse/policy/basic/ServiceImpl.class
     0 Thu Jun 16 18:50:48 CEST 2011 WEB-INF/classes/org/jboss/test/ws/jaxws/samples/wsse/policy/jaxws/
   705 Thu Jun 16 18:50:48 CEST 2011 WEB-INF/classes/org/jboss/test/ws/jaxws/samples/wsse/policy/jaxws/SayHello.class
  1069 Thu Jun 16 18:50:48 CEST 2011 WEB-INF/classes/org/jboss/test/ws/jaxws/samples/wsse/policy/jaxws/SayHelloResponse.class
  1225 Thu Jun 16 18:50:44 CEST 2011 WEB-INF/jaxws-endpoint-config.xml
     0 Thu Jun 16 18:50:44 CEST 2011 WEB-INF/wsdl/
  4086 Thu Jun 16 18:50:44 CEST 2011 WEB-INF/wsdl/SecurityService.wsdl
   653 Thu Jun 16 18:50:44 CEST 2011 WEB-INF/wsdl/SecurityService_schema1.xsd
  1820 Thu Jun 16 18:50:44 CEST 2011 WEB-INF/classes/bob.jks
   311 Thu Jun 16 18:50:44 CEST 2011 WEB-INF/classes/bob.properties</pre>
</div>
</div>
<div class="paragraph">
<p>As you can see, the jaxws classes generated by the tools are of course
also included, as well as a basic <em>web.xml</em> referencing the endpoint
bean:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;web-app
   version="2.5" xmlns="http://java.sun.com/xml/ns/javaee"
   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
   xsi:schemaLocation="http://java.sun.com/xml/ns/javaee http://java.sun.com/xml/ns/javaee/web-app_2_5.xsd"&gt;
   &lt;servlet&gt;
      &lt;servlet-name&gt;TestService&lt;/servlet-name&gt;
      &lt;servlet-class&gt;org.jboss.test.ws.jaxws.samples.wsse.policy.basic.ServiceImpl&lt;/servlet-class&gt;
   &lt;/servlet&gt;
   &lt;servlet-mapping&gt;
      &lt;servlet-name&gt;TestService&lt;/servlet-name&gt;
      &lt;url-pattern&gt;/*&lt;/url-pattern&gt;
   &lt;/servlet-mapping&gt;
&lt;/web-app&gt;</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
If you&#8217;re deploying the endpoint archive on WildFly, remember to add a
dependency to <em>org.apache.ws.security</em> module in the MANIFEST.MF file.
</td>
</tr>
</table>
</div>
<div class="literalblock">
<div class="content">
<pre>Manifest-Version: 1.0
Ant-Version: Apache Ant 1.7.1
Created-By: 17.0-b16 (Sun Microsystems Inc.)
Dependencies: org.apache.ws.security</pre>
</div>
</div>
</div>
<div class="sect6">
<h7 id="client-ws-security"><a class="anchor" href="#client-ws-security"></a>Client</h7>
<div class="paragraph">
<p>You start by consuming the published WSDL contract using the <em>wsconsume</em>
tool on client side too. Then you simply invoke the the endpoint as a
standard Jakarta XML Web Services one:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">QName serviceName = new QName("http://www.jboss.org/jbossws/ws-extensions/wssecuritypolicy", "SecurityService");
URL wsdlURL = new URL(serviceURL + "?wsdl");
Service service = Service.create(wsdlURL, serviceName);
ServiceIface proxy = (ServiceIface)service.getPort(ServiceIface.class);

((BindingProvider)proxy).getRequestContext().put(SecurityConstants.CALLBACK_HANDLER, new KeystorePasswordCallback());
((BindingProvider)proxy).getRequestContext().put(SecurityConstants.SIGNATURE_PROPERTIES,
     Thread.currentThread().getContextClassLoader().getResource("META-INF/alice.properties"));
((BindingProvider)proxy).getRequestContext().put(SecurityConstants.ENCRYPT_PROPERTIES,
     Thread.currentThread().getContextClassLoader().getResource("META-INF/alice.properties"));
((BindingProvider)proxy).getRequestContext().put(SecurityConstants.SIGNATURE_USERNAME, "alice");
((BindingProvider)proxy).getRequestContext().put(SecurityConstants.ENCRYPT_USERNAME, "bob");

proxy.sayHello();</code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see, the WS-Security properties are set in the request
context. Here the <code>KeystorePasswordCallback</code> is the same as on server
side above, you might want/need different implementation in real world
scenarios, of course.<br>
The <em>alice.properties</em> file is the client side equivalent of the server
side <em>bob.properties</em> and references the <em>alice.jks</em> keystore file,
which has been populated with Alice&#8217;s (client) full key
(private/certificate + public key) as well as Bob&#8217;s (server) public key.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>org.apache.ws.security.crypto.provider=org.apache.ws.security.components.crypto.Merlin
org.apache.ws.security.crypto.merlin.keystore.type=jks
org.apache.ws.security.crypto.merlin.keystore.password=password
org.apache.ws.security.crypto.merlin.keystore.alias=alice
org.apache.ws.security.crypto.merlin.keystore.file=META-INF/alice.jks</pre>
</div>
</div>
<div class="paragraph">
<p>The Apache CXF WS-Policy engine will digest the security requirements in
the contract and ensure a valid secure communication is in place for
interacting with the server endpoint.</p>
</div>
</div>
<div class="sect6">
<h7 id="endpoint-serving-multiple-clients"><a class="anchor" href="#endpoint-serving-multiple-clients"></a>Endpoint serving multiple clients</h7>
<div class="paragraph">
<p>The server side configuration described above implies the endpoint is
configured for serving a given client which a service agreement has been
established for. In some real world scenarios though, the same server
might be expected to be able to deal with (including decrypting and
encrypting) messages coming from and being sent to multiple clients.
Apache CXF supports that through the <code>useReqSigCert</code> value for the
<code>ws-security.encryption.username</code> configuration parameter.</p>
</div>
<div class="paragraph">
<p>Of course the referenced server side keystore then needs to contain the
public key of all the clients that are expected to be served.</p>
</div>
</div>
</div>
<div class="sect5">
<h6 id="authentication-and-authorization"><a class="anchor" href="#authentication-and-authorization"></a>Authentication and authorization</h6>
<div class="paragraph">
<p>The Username Token Profile can be used to provide client&#8217;s credentials
to a WS-Security enabled target endpoint.</p>
</div>
<div class="paragraph">
<p>Apache CXF provides means for setting basic <em>password callback handlers</em>
on both client and server sides to set/check passwords; the
<em>ws-security.username</em> and <em>ws-security.callback-handler</em> properties can
be used similarly as shown in the signature and encryption example.
Things become more interesting when requiring a given user to be
authenticated (and authorized) against a security domain on the target
application server.</p>
</div>
<div class="paragraph">
<p>On server side, you need to install two additional interceptors that act
as bridges towards the application server authentication layer:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>an interceptor for performing authentication and populating a valid
SecurityContext; the provided interceptor should extend
org.apache.cxf.ws.interceptor.security.AbstractUsernameTokenInInterceptor,
in particular JBossWS integration comes with
<em>org.jboss.wsf.stack.cxf.security.authentication.SubjectCreatingInterceptor</em>
for this;</p>
</li>
<li>
<p>an interceptor for performing authorization; CXF requires that to
extend
org.apache.cxf.interceptor.security.AbstractAuthorizingInInterceptor,
for instance the <em>SimpleAuthorizingInterceptor</em> can be used for simply
mapping endpoint operations to allowed roles.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>So, here follows an example of WS-SecurityPolicy endpoint using Username
Token Profile for authenticating through the application server security
domain system.</p>
</div>
<div class="sect6">
<h7 id="endpoint-ws-security-1"><a class="anchor" href="#endpoint-ws-security-1"></a>Endpoint</h7>
<div class="paragraph">
<p>As in the other example, we start with a wsdl contract containing the
proper WS-Security Policy:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;?xml version="1.0" encoding="UTF-8" standalone="yes"?&gt;
&lt;definitions targetNamespace="http://www.jboss.org/jbossws/ws-extensions/wssecuritypolicy" name="SecurityService"
  xmlns:tns="http://www.jboss.org/jbossws/ws-extensions/wssecuritypolicy"
  xmlns:xsd="http://www.w3.org/2001/XMLSchema"
  xmlns:soap="http://schemas.xmlsoap.org/wsdl/soap/"
  xmlns="http://schemas.xmlsoap.org/wsdl/"
  xmlns:wsp="http://schemas.xmlsoap.org/ws/2004/09/policy"
        xmlns:wsu="http://docs.oasis-open.org/wss/2004/01/oasis-200401-wss-wssecurity-utility-1.0.xsd"
        xmlns:wsaws="http://www.w3.org/2005/08/addressing"&gt;
  &lt;types&gt;
    &lt;xsd:schema&gt;
      &lt;xsd:import namespace="http://www.jboss.org/jbossws/ws-extensions/wssecuritypolicy" schemaLocation="SecurityService_schema1.xsd"/&gt;
    &lt;/xsd:schema&gt;
  &lt;/types&gt;
  &lt;message name="sayHello"&gt;
    &lt;part name="parameters" element="tns:sayHello"/&gt;
  &lt;/message&gt;
  &lt;message name="sayHelloResponse"&gt;
    &lt;part name="parameters" element="tns:sayHelloResponse"/&gt;
  &lt;/message&gt;
  &lt;message name="greetMe"&gt;
    &lt;part name="parameters" element="tns:greetMe"/&gt;
  &lt;/message&gt;
  &lt;message name="greetMeResponse"&gt;
    &lt;part name="parameters" element="tns:greetMeResponse"/&gt;
  &lt;/message&gt;
  &lt;portType name="ServiceIface"&gt;
    &lt;operation name="sayHello"&gt;
      &lt;input message="tns:sayHello"/&gt;
      &lt;output message="tns:sayHelloResponse"/&gt;
    &lt;/operation&gt;
    &lt;operation name="greetMe"&gt;
      &lt;input message="tns:greetMe"/&gt;
      &lt;output message="tns:greetMeResponse"/&gt;
    &lt;/operation&gt;
  &lt;/portType&gt;
  &lt;binding name="SecurityServicePortBinding" type="tns:ServiceIface"&gt;
    &lt;wsp:PolicyReference URI="#SecurityServiceUsernameUnsecureTransportPolicy"/&gt;
    &lt;soap:binding transport="http://schemas.xmlsoap.org/soap/http" style="document"/&gt;
    &lt;operation name="sayHello"&gt;
      &lt;soap:operation soapAction=""/&gt;
      &lt;input&gt;
        &lt;soap:body use="literal"/&gt;
      &lt;/input&gt;
      &lt;output&gt;
        &lt;soap:body use="literal"/&gt;
      &lt;/output&gt;
    &lt;/operation&gt;
    &lt;operation name="greetMe"&gt;
      &lt;soap:operation soapAction=""/&gt;
      &lt;input&gt;
        &lt;soap:body use="literal"/&gt;
      &lt;/input&gt;
      &lt;output&gt;
        &lt;soap:body use="literal"/&gt;
      &lt;/output&gt;
    &lt;/operation&gt;
  &lt;/binding&gt;
  &lt;service name="SecurityService"&gt;
    &lt;port name="SecurityServicePort" binding="tns:SecurityServicePortBinding"&gt;
      &lt;soap:address location="http://localhost:8080/jaxws-samples-wsse-username-jaas"/&gt;
    &lt;/port&gt;
  &lt;/service&gt;

  &lt;wsp:Policy wsu:Id="SecurityServiceUsernameUnsecureTransportPolicy"&gt;
        &lt;wsp:ExactlyOne&gt;
            &lt;wsp:All&gt;
                &lt;sp:SupportingTokens xmlns:sp="http://docs.oasis-open.org/ws-sx/ws-securitypolicy/200702"&gt;
                    &lt;wsp:Policy&gt;
                        &lt;sp:UsernameToken sp:IncludeToken="http://docs.oasis-open.org/ws-sx/ws-securitypolicy/200702/IncludeToken/AlwaysToRecipient"&gt;
                            &lt;wsp:Policy&gt;
                                &lt;sp:WssUsernameToken10/&gt;
                            &lt;/wsp:Policy&gt;
                        &lt;/sp:UsernameToken&gt;
                    &lt;/wsp:Policy&gt;
                &lt;/sp:SupportingTokens&gt;
            &lt;/wsp:All&gt;
        &lt;/wsp:ExactlyOne&gt;
    &lt;/wsp:Policy&gt;

&lt;/definitions&gt;</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
If you want to send hash / digest passwords, you can use a policy such
as what follows:
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;wsp:Policy wsu:Id="SecurityServiceUsernameHashPasswordPolicy"&gt;
    &lt;wsp:ExactlyOne&gt;
        &lt;wsp:All&gt;
            &lt;sp:SupportingTokens xmlns:sp="http://docs.oasis-open.org/ws-sx/ws-securitypolicy/200702"&gt;
                &lt;wsp:Policy&gt;
                    &lt;sp:UsernameToken sp:IncludeToken="http://docs.oasis-open.org/ws-sx/ws-securitypolicy/200702/IncludeToken/AlwaysToRecipient"&gt;
                        &lt;wsp:Policy&gt;
                            &lt;sp:HashPassword/&gt;
                        &lt;/wsp:Policy&gt;
                    &lt;/sp:UsernameToken&gt;
                &lt;/wsp:Policy&gt;
            &lt;/sp:SupportingTokens&gt;
        &lt;/wsp:All&gt;
    &lt;/wsp:ExactlyOne&gt;
&lt;/wsp:Policy&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Please note the specified JBoss security domain needs to be properly
configured for computing digests.</p>
</div>
<div class="paragraph">
<p>The service endpoint can be generated using the <code>wsconsume</code> tool and
then enriched with a <code>@EndpointConfig</code> annotation and <code>@InInterceptors</code>
annotation to add the two interceptors mentioned above for JAAS
integration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">package org.jboss.test.ws.jaxws.samples.wsse.policy.jaas;

import javax.jws.WebService;
import org.apache.cxf.interceptor.InInterceptors;
import org.jboss.ws.api.annotation.EndpointConfig;

@WebService
(
   portName = "SecurityServicePort",
   serviceName = "SecurityService",
   wsdlLocation = "WEB-INF/wsdl/SecurityService.wsdl",
   targetNamespace = "http://www.jboss.org/jbossws/ws-extensions/wssecuritypolicy",
   endpointInterface = "org.jboss.test.ws.jaxws.samples.wsse.policy.jaas.ServiceIface"
)
@EndpointConfig(configFile = "WEB-INF/jaxws-endpoint-config.xml", configName = "Custom WS-Security Endpoint")
@InInterceptors(interceptors = {
      "org.jboss.wsf.stack.cxf.security.authentication.SubjectCreatingPolicyInterceptor",
      "org.jboss.test.ws.jaxws.samples.wsse.policy.jaas.POJOEndpointAuthorizationInterceptor"}
)
public class ServiceImpl implements ServiceIface
{
   public String sayHello()
   {
      return "Secure Hello World!";
   }

   public String greetMe()
   {
      return "Greetings!";
   }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>POJOEndpointAuthorizationInterceptor</code> is included into the
deployment and deals with the roles cheks:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">package org.jboss.test.ws.jaxws.samples.wsse.policy.jaas;

import java.util.HashMap;
import java.util.Map;
import org.apache.cxf.interceptor.security.SimpleAuthorizingInterceptor;

public class POJOEndpointAuthorizationInterceptor extends SimpleAuthorizingInterceptor
{

   public POJOEndpointAuthorizationInterceptor()
   {
      super();
      readRoles();
   }

   private void readRoles()
   {
      //just an example, this might read from a configuration file or such
      Map&lt;String, String&gt; roles = new HashMap&lt;String, String&gt;();
      roles.put("sayHello", "friend");
      roles.put("greetMe", "snoopies");
      setMethodRolesMap(roles);
   }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <em>jaxws-endpoint-config.xml</em> descriptor is used to provide a custom
endpoint configuration with the required server side configuration
properties; in particular for this Username Token case that&#8217;s just a CXF
configuration option for leaving the username token validation to the
configured interceptors:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;jaxws-config xmlns="urn:jboss:jbossws-jaxws-config:4.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xmlns:javaee="http://java.sun.com/xml/ns/javaee" xsi:schemaLocation="urn:jboss:jbossws-jaxws-config:4.0 schema/jbossws-jaxws-config_4_0.xsd"&gt;
  &lt;endpoint-config&gt;
    &lt;config-name&gt;Custom WS-Security Endpoint&lt;/config-name&gt;
    &lt;property&gt;
      &lt;property-name&gt;ws-security.validate.token&lt;/property-name&gt;
      &lt;property-value&gt;false&lt;/property-value&gt;
    &lt;/property&gt;
  &lt;/endpoint-config&gt;
&lt;/jaxws-config&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>In order for requiring a given JBoss security domain to be used to
protect access to the endpoint (a POJO one in this case), we declare
that in a <em>jboss-web.xml</em> descriptor (the <em>JBossWS</em> security domain is
used):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;!DOCTYPE jboss-web PUBLIC "-//JBoss//DTD Web Application 2.4//EN" "http://www.jboss.org/j2ee/dtd/jboss-web_4_0.dtd"&gt;
&lt;jboss-web&gt;
   &lt;security-domain&gt;java:/jaas/JBossWS&lt;/security-domain&gt;
&lt;/jboss-web</code></pre>
</div>
</div>
<div class="paragraph">
<p>Finally, the <em>web.xml</em> is as simple as usual:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;web-app
   version="2.5" xmlns="http://java.sun.com/xml/ns/javaee"
   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
   xsi:schemaLocation="http://java.sun.com/xml/ns/javaee http://java.sun.com/xml/ns/javaee/web-app_2_5.xsd"&gt;
   &lt;servlet&gt;
      &lt;servlet-name&gt;TestService&lt;/servlet-name&gt;
      &lt;servlet-class&gt;org.jboss.test.ws.jaxws.samples.wsse.policy.jaas.ServiceImpl&lt;/servlet-class&gt;
   &lt;/servlet&gt;
   &lt;servlet-mapping&gt;
      &lt;servlet-name&gt;TestService&lt;/servlet-name&gt;
      &lt;url-pattern&gt;/*&lt;/url-pattern&gt;
   &lt;/servlet-mapping&gt;
&lt;/web-app&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The endpoint is packaged into a war archive, including the JAXWS classes
generated by wsconsume:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>alessio@inuyasha /dati/jbossws/stack/cxf/trunk $ jar -tvf ./modules/testsuite/cxf-tests/target/test-libs/jaxws-samples-wsse-policy-username-jaas.war
     0 Thu Jun 16 18:50:48 CEST 2011 META-INF/
   155 Thu Jun 16 18:50:46 CEST 2011 META-INF/MANIFEST.MF
     0 Thu Jun 16 18:50:48 CEST 2011 WEB-INF/
   585 Thu Jun 16 18:50:44 CEST 2011 WEB-INF/web.xml
     0 Thu Jun 16 18:50:48 CEST 2011 WEB-INF/classes/
     0 Thu Jun 16 18:50:48 CEST 2011 WEB-INF/classes/org/
     0 Thu Jun 16 18:50:48 CEST 2011 WEB-INF/classes/org/jboss/
     0 Thu Jun 16 18:50:48 CEST 2011 WEB-INF/classes/org/jboss/test/
     0 Thu Jun 16 18:50:48 CEST 2011 WEB-INF/classes/org/jboss/test/ws/
     0 Thu Jun 16 18:50:48 CEST 2011 WEB-INF/classes/org/jboss/test/ws/jaxws/
     0 Thu Jun 16 18:50:48 CEST 2011 WEB-INF/classes/org/jboss/test/ws/jaxws/samples/
     0 Thu Jun 16 18:50:48 CEST 2011 WEB-INF/classes/org/jboss/test/ws/jaxws/samples/wsse/
     0 Thu Jun 16 18:50:48 CEST 2011 WEB-INF/classes/org/jboss/test/ws/jaxws/samples/wsse/policy/
     0 Thu Jun 16 18:50:48 CEST 2011 WEB-INF/classes/org/jboss/test/ws/jaxws/samples/wsse/policy/jaas/
   982 Thu Jun 16 18:50:48 CEST 2011 WEB-INF/classes/org/jboss/test/ws/jaxws/samples/wsse/policy/jaas/POJOEndpointAuthorizationInterceptor.class
   412 Thu Jun 16 18:50:48 CEST 2011 WEB-INF/classes/org/jboss/test/ws/jaxws/samples/wsse/policy/jaas/ServiceIface.class
  1398 Thu Jun 16 18:50:48 CEST 2011 WEB-INF/classes/org/jboss/test/ws/jaxws/samples/wsse/policy/jaas/ServiceImpl.class
     0 Thu Jun 16 18:50:48 CEST 2011 WEB-INF/classes/org/jboss/test/ws/jaxws/samples/wsse/policy/jaxws/
   701 Thu Jun 16 18:50:48 CEST 2011 WEB-INF/classes/org/jboss/test/ws/jaxws/samples/wsse/policy/jaxws/GreetMe.class
  1065 Thu Jun 16 18:50:48 CEST 2011 WEB-INF/classes/org/jboss/test/ws/jaxws/samples/wsse/policy/jaxws/GreetMeResponse.class
   705 Thu Jun 16 18:50:48 CEST 2011 WEB-INF/classes/org/jboss/test/ws/jaxws/samples/wsse/policy/jaxws/SayHello.class
  1069 Thu Jun 16 18:50:48 CEST 2011 WEB-INF/classes/org/jboss/test/ws/jaxws/samples/wsse/policy/jaxws/SayHelloResponse.class
   556 Thu Jun 16 18:50:44 CEST 2011 WEB-INF/jaxws-endpoint-config.xml
   241 Thu Jun 16 18:50:44 CEST 2011 WEB-INF/jboss-web.xml
     0 Thu Jun 16 18:50:44 CEST 2011 WEB-INF/wsdl/
  3183 Thu Jun 16 18:50:44 CEST 2011 WEB-INF/wsdl/SecurityService.wsdl
  1012 Thu Jun 16 18:50:44 CEST 2011 WEB-INF/wsdl/SecurityService_schema1.xsd</pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
If you&#8217;re deploying the endpoint archive on WildFly, remember to add a
dependency to <em>org.apache.ws.security</em> and <em>org.apache.cxf</em> module (due
to the <code>@InInterceptor</code> annotation) in the MANIFEST.MF file.
</td>
</tr>
</table>
</div>
<div class="literalblock">
<div class="content">
<pre>Manifest-Version: 1.0
Ant-Version: Apache Ant 1.7.1
Created-By: 17.0-b16 (Sun Microsystems Inc.)
Dependencies: org.apache.ws.security,org.apache.cxf</pre>
</div>
</div>
</div>
<div class="sect6">
<h7 id="client-ws-security-1"><a class="anchor" href="#client-ws-security-1"></a>Client</h7>
<div class="paragraph">
<p>Here too you start by consuming the published WSDL contract using the
<em>wsconsume</em> tool. Then you simply invoke the the endpoint as a standard
Jakarta XML Web Services one:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">QName serviceName = new QName("http://www.jboss.org/jbossws/ws-extensions/wssecuritypolicy", "SecurityService");
URL wsdlURL = new URL(serviceURL + "?wsdl");
Service service = Service.create(wsdlURL, serviceName);
ServiceIface proxy = (ServiceIface)service.getPort(ServiceIface.class);

((BindingProvider)proxy).getRequestContext().put(SecurityConstants.USERNAME, "kermit");
((BindingProvider)proxy).getRequestContext().put(SecurityConstants.CALLBACK_HANDLER,
      "org.jboss.test.ws.jaxws.samples.wsse.policy.jaas.UsernamePasswordCallback");

proxy.sayHello();</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>UsernamePasswordCallback</code> class is shown below and is responsible
for setting the passwords on client side just before performing the
invocations:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">package org.jboss.test.ws.jaxws.samples.wsse.policy.jaas;

import java.io.IOException;
import javax.security.auth.callback.Callback;
import javax.security.auth.callback.CallbackHandler;
import javax.security.auth.callback.UnsupportedCallbackException;
import org.apache.ws.security.WSPasswordCallback;

public class UsernamePasswordCallback implements CallbackHandler
{
   public void handle(Callback[] callbacks) throws IOException, UnsupportedCallbackException
   {
      WSPasswordCallback pc = (WSPasswordCallback)callbacks[0];
      if ("kermit".equals(pc.getIdentifier()))
         pc.setPassword("thefrog");
   }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>If everything has been done properly, you should expect to calls to
<code>sayHello()</code> fail when done with user "snoopy" and pass with user
"kermit" (and credential "thefrog"); moreover, you should get an
authorization error when trying to call <code>greetMe()</code> with user "kermit",
as that does not have the "snoopies" role.</p>
</div>
</div>
</div>
<div class="sect5">
<h6 id="secure-transport"><a class="anchor" href="#secure-transport"></a>Secure transport</h6>
<div class="paragraph">
<p>Another quite common use case is using WS-Security Username Token
Profile over a secure transport (HTTPS). A scenario like this is
implemented similarly to what&#8217;s described in the previous example,
except for few differences explained below.</p>
</div>
<div class="paragraph">
<p>First of all, here is an excerpt of a wsdl wth a sample security policy
for Username Token over HTTPS:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">...

&lt;binding name="SecurityServicePortBinding" type="tns:ServiceIface"&gt;
  &lt;wsp:PolicyReference URI="#SecurityServiceBindingPolicy"/&gt;
  &lt;soap:binding transport="http://schemas.xmlsoap.org/soap/http" style="document"/&gt;
  &lt;operation name="sayHello"&gt;
    &lt;soap:operation soapAction=""/&gt;
    &lt;input&gt;
      &lt;soap:body use="literal"/&gt;
    &lt;/input&gt;
    &lt;output&gt;
      &lt;soap:body use="literal"/&gt;
    &lt;/output&gt;
  &lt;/operation&gt;
&lt;/binding&gt;
&lt;service name="SecurityService"&gt;
   &lt;port name="SecurityServicePort" binding="tns:SecurityServicePortBinding"&gt;
      &lt;soap:address location="https://localhost:8443/jaxws-samples-wsse-policy-username"/&gt;
   &lt;/port&gt;
&lt;/service&gt;

&lt;wsp:Policy wsu:Id="SecurityServiceBindingPolicy"&gt;
   &lt;wsp:ExactlyOne&gt;
      &lt;wsp:All&gt;
         &lt;foo:unknownPolicy xmlns:foo="http://cxf.apache.org/not/a/policy"/&gt;
      &lt;/wsp:All&gt;
      &lt;wsp:All&gt;
         &lt;wsaws:UsingAddressing xmlns:wsaws="http://www.w3.org/2006/05/addressing/wsdl"/&gt;
         &lt;sp:TransportBinding&gt;
            &lt;wsp:Policy&gt;
               &lt;sp:TransportToken&gt;
                  &lt;wsp:Policy&gt;
                     &lt;sp:HttpsToken RequireClientCertificate="false"/&gt;
                  &lt;/wsp:Policy&gt;
               &lt;/sp:TransportToken&gt;
               &lt;sp:Layout&gt;
                  &lt;wsp:Policy&gt;
                     &lt;sp:Lax/&gt;
                  &lt;/wsp:Policy&gt;
               &lt;/sp:Layout&gt;
               &lt;sp:IncludeTimestamp/&gt;
               &lt;sp:AlgorithmSuite&gt;
                  &lt;wsp:Policy&gt;
                     &lt;sp:Basic128/&gt;
                  &lt;/wsp:Policy&gt;
               &lt;/sp:AlgorithmSuite&gt;
            &lt;/wsp:Policy&gt;
         &lt;/sp:TransportBinding&gt;
         &lt;sp:Wss10&gt;
            &lt;wsp:Policy&gt;
               &lt;sp:MustSupportRefKeyIdentifier/&gt;
            &lt;/wsp:Policy&gt;
         &lt;/sp:Wss10&gt;
         &lt;sp:SignedSupportingTokens&gt;
            &lt;wsp:Policy&gt;
               &lt;sp:UsernameToken sp:IncludeToken="http://schemas.xmlsoap.org/ws/2005/07/securitypolicy/IncludeToken/AlwaysToRecipient"&gt;
                  &lt;wsp:Policy&gt;
                     &lt;sp:WssUsernameToken10/&gt;
                  &lt;/wsp:Policy&gt;
               &lt;/sp:UsernameToken&gt;
            &lt;/wsp:Policy&gt;
         &lt;/sp:SignedSupportingTokens&gt;
      &lt;/wsp:All&gt;
   &lt;/wsp:ExactlyOne&gt;
&lt;/wsp:Policy&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The endpoint then needs of course to be actually available on HTTPS
only, so we have a <em>web.xml</em> setting the <em>transport-guarantee</em> such as
below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;web-app
   version="2.5" xmlns="http://java.sun.com/xml/ns/javaee"
   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
   xsi:schemaLocation="http://java.sun.com/xml/ns/javaee http://java.sun.com/xml/ns/javaee/web-app_2_5.xsd"&gt;
   &lt;servlet&gt;
      &lt;servlet-name&gt;TestService&lt;/servlet-name&gt;
      &lt;servlet-class&gt;org.jboss.test.ws.jaxws.samples.wsse.policy.basic.ServiceImpl&lt;/servlet-class&gt;
   &lt;/servlet&gt;
   &lt;servlet-mapping&gt;
      &lt;servlet-name&gt;TestService&lt;/servlet-name&gt;
      &lt;url-pattern&gt;/*&lt;/url-pattern&gt;
   &lt;/servlet-mapping&gt;

   &lt;security-constraint&gt;
    &lt;web-resource-collection&gt;
      &lt;web-resource-name&gt;TestService&lt;/web-resource-name&gt;
      &lt;url-pattern&gt;/*&lt;/url-pattern&gt;
    &lt;/web-resource-collection&gt;
    &lt;user-data-constraint&gt;
      &lt;transport-guarantee&gt;CONFIDENTIAL&lt;/transport-guarantee&gt;
    &lt;/user-data-constraint&gt;
  &lt;/security-constraint&gt;
&lt;/web-app&gt;</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="secure-conversation"><a class="anchor" href="#secure-conversation"></a>Secure conversation</h6>
<div class="paragraph">
<p>Apache CXF supports
<a href="http://docs.oasis-open.org/ws-sx/ws-secureconversation/200512/ws-secureconversation-1.3-os.html">WS-SecureConversation</a>
specification, which is about improving performance by allowing client
and server to negotiate initial security keys to be used for later
communication encryption/signature. This is done by having two policies
in the wsdl contract, an outer one setting the security requirements to
actually communicate with the endpoint and a bootstrap one, related to
the communication for establishing the secure conversation keys. The
client will be automatically sending an initial message to the server
for negotiating the keys, then the actual communication to the endpoint
takes place. As a consequence, Apache CXF needs a way to specify which
WS-Security configuration properties are intended for the bootstrap
policy and which are intended for the actual service policy. To
accomplish this, properties intended for the bootstrap policy are
appended with <code>.sct</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">...
((BindingProvider)proxy).getRequestContext().put("ws-security.signature.username.sct", "alice");
((BindingProvider)proxy).getRequestContext().put("ws-security.encryption.username.sct", "bob");
...</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">@WebService(
   ...
)
@EndpointProperties(value = {
      @EndpointProperty(key = "ws-security.encryption.properties.sct", value = "bob.properties"),
      @EndpointProperty(key = "ws-security.signature.properties.sct", value = "bob.properties"),
      ...
      }
)
public class ServiceImpl implements ServiceIface {
   ...
}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="WS-Trust_and_STS"><a class="anchor" href="#WS-Trust_and_STS"></a>16.5.13. WS-Trust and STS</h4>
<div class="sect4">
<h5 id="ws-trust-overview"><a class="anchor" href="#ws-trust-overview"></a>WS-Trust overview</h5>
<div class="paragraph">
<p><a href="https://www.oasis-open.org/standards#wstrustv1.4">WS-Trust</a> is a Web
service specification that defines extensions to WS-Security. It is a
general framework for implementing security in a distributed system. The
standard is based on a centralized Security Token Service, STS, which is
capable of authenticating clients and issuing tokens containing various
kinds of authentication and authorization data. The specification
describes a protocol used for issuance, exchange, and validation of
security tokens, however the following specifications play an important
role in the WS-Trust architecture:
<a href="http://docs.oasis-open.org/ws-sx/ws-securitypolicy/200702/ws-securitypolicy-1.2-spec-os.html">WS-SecurityPolicy
1.2</a>,
<a href="http://docs.oasis-open.org/security/saml/v2.0/saml-core-2.0-os.pdf">SAML
2.0</a>,
<a href="http://docs.oasis-open.org/wss/v1.1/wss-v1.1-spec-os-UsernameTokenProfile.pdf">Username
Token Profile</a>,
<a href="http://docs.oasis-open.org/wss-m/wss/v1.1.1/wss-x509TokenProfile-v1.1.1.html">X.509
Token Profile</a>,
<a href="https://www.oasis-open.org/committees/download.php/16768/wss-v1.1-spec-os-SAMLTokenProfile.pdf">SAML
Token Profile</a>, and
<a href="http://docs.oasis-open.org/wss/v1.1/wss-v1.1-spec-os-KerberosTokenProfile.pdf">Kerberos
Token Profile</a>.</p>
</div>
<div class="paragraph">
<p>The WS-Trust extensions address the needs of applications that span
multiple domains and requires the sharing of security keys by providing
a standards based trusted third party web service (STS) to broker trust
relationships between a Web service requester and a Web service
provider. This architecture also alleviates the pain of service updates
that require credential changes by providing a common location for this
information. The STS is the common access point from which both the
requester and provider retrieves and verifies security tokens.</p>
</div>
<div class="paragraph">
<p>There are three main components of the WS-Trust specification.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The Security Token Service (STS), a web service that issues, renews,
and validates security tokens.</p>
</li>
<li>
<p>The message formats for security token requests and responses.</p>
</li>
<li>
<p>The mechanisms for key exchange</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="security-token-service"><a class="anchor" href="#security-token-service"></a>Security Token Service</h5>
<div class="paragraph">
<p>The Security Token Service, STS, is the core of the WS-Trust
specification. It is a standards based mechanism for authentication and
authorization. The STS is an implementation of the WS-Trust
specification&#8217;s protocol for issuing, exchanging, and validating
security tokens, based on token format, namespace, or trust boundaries.
The STS is a web service that acts as a trusted third party to broker
trust relationships between a Web service requester and a Web service
provider. It is a common access point trusted by both requester and
provider to provide interoperable security tokens. It removes the need
for a direct relationship between the two. Because the STS is a
standards based mechanism for authentication, it helps ensure
interoperability across realms and between different platforms.</p>
</div>
<div class="paragraph">
<p>The STS&#8217;s WSDL contract defines how other applications and processes
interact with it. In particular the WSDL defines the WS-Trust and
WS-Security policies that a requester must fulfill in order to
successfully communicate with the STS&#8217;s endpoints. A web service
requester consumes the STS&#8217;s WSDL and with the aid of an STSClient
utility, generates a message request compliant with the stated security
policies and submits it to the STS endpoint. The STS validates the
request and returns an appropriate response.</p>
</div>
</div>
<div class="sect4">
<h5 id="apache-cxf-support"><a class="anchor" href="#apache-cxf-support"></a>Apache CXF support</h5>
<div class="paragraph">
<p>Apache CXF is an open-source, fully featured Web services framework. The
JBossWS open source project integrates the JBoss Web Services (JBossWS)
stack with the Apache CXF project modules thus providing WS-Trust and
other Jakarta XML Web Services functionality in WildFly. This integration makes it easy to
deploy CXF STS implementations, however WildFly can run any WS-Trust
compliant STS. In addition the Apache CXF API provides a STSClient
utility to facilitate web service requester communication with its STS.</p>
</div>
<div class="paragraph">
<p>Detailed information about the Apache CXF&#8217;s WS-Trust implementation can
be found
<a href="http://coheigea.blogspot.it/2011/10/apache-cxf-sts-documentation-part-i.html">here</a>.</p>
</div>
</div>
<div class="sect4">
<h5 id="a-basic-ws-trust-scenario"><a class="anchor" href="#a-basic-ws-trust-scenario"></a>A Basic WS-Trust Scenario</h5>
<div class="paragraph">
<p>Here is an example of a basic WS-Trust scenario. It is comprised of a
Web service requester (ws-requester), a Web service provider
(ws-provider), and a Security Token Service (STS). The ws-provider
requires a SAML 2.0 token issued from a designed STS to be presented by
the ws-requester using asymmetric binding. These communication
requirements are declared in the ws-provider&#8217;s WSDL. The STS requires
ws-requester credentials be provided in a WSS UsernameToken format
request using symmetric binding. The STS&#8217;s response is provided
containing a SAML 2.0 token. These communication requirements are
declared in the STS&#8217;s WSDL.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>A ws-requester contacts the ws-provider and consumes its WSDL. Upon
finding the security token issuer requirement, it creates and configures
a STSClient with the information it requires to generate a proper
request.</p>
</li>
<li>
<p>The STSClient contacts the STS and consumes its WSDL. The security
policies are discovered. The STSClient creates and sends an
authentication request, with appropriate credentials.</p>
</li>
<li>
<p>The STS verifies the credentials.</p>
</li>
<li>
<p>In response, the STS issues a security token that provides proof
that the ws-requester has authenticated with the STS.</p>
</li>
<li>
<p>The STClient presents a message with the security token to the
ws-provider.</p>
</li>
<li>
<p>The ws-provider verifies the token was issued by the STS, thus
proving the ws-requester has successfully authenticated with the STS.</p>
</li>
<li>
<p>The ws-provider executes the requested service and returns the
results to the the ws-requester.</p>
</li>
</ol>
</div>
<div class="sect5">
<h6 id="web-service-provider"><a class="anchor" href="#web-service-provider"></a>Web service provider</h6>
<div class="paragraph">
<p>This section examines the crucial elements in providing endpoint
security in the web service provider described in the basic WS-Trust
scenario. The components that will be discussed are.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>web service provider&#8217;s WSDL</p>
</li>
<li>
<p>web service provider&#8217;s Interface and Implementation classes.</p>
</li>
<li>
<p>ServerCallbackHandler class</p>
</li>
<li>
<p>Crypto properties and keystore files</p>
</li>
<li>
<p>MANIFEST.MF</p>
</li>
</ul>
</div>
<div class="sect6">
<h7 id="web-service-provider-wsdl"><a class="anchor" href="#web-service-provider-wsdl"></a>Web service provider WSDL</h7>
<div class="paragraph">
<p>The web service provider is a contract-first endpoint. All the WS-trust
and security policies for it are declared in the WSDL,
SecurityService.wsdl. For this scenario a ws-requester is required to
present a SAML 2.0 token issued from a designed STS. The address of the
STS is provided in the WSDL. An asymmetric binding policy is used to
encrypt and sign the SOAP body of messages that pass back and forth
between ws-requester and ws-provider. X.509 certificates are use for the
asymmetric binding. The rules for sharing the public and private keys in
the SOAP request and response messages are declared. A detailed
explanation of the security settings are provided in the comments in the
listing below.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml"> &lt;?xml version="1.0" encoding="UTF-8" standalone="yes"?&gt;
&lt;definitions targetNamespace="http://www.jboss.org/jbossws/ws-extensions/wssecuritypolicy" name="SecurityService"
        xmlns:tns="http://www.jboss.org/jbossws/ws-extensions/wssecuritypolicy"
        xmlns:xsd="http://www.w3.org/2001/XMLSchema"
        xmlns:soap="http://schemas.xmlsoap.org/wsdl/soap/"
        xmlns="http://schemas.xmlsoap.org/wsdl/"
        xmlns:wsp="http://www.w3.org/ns/ws-policy"
        xmlns:wsam="http://www.w3.org/2007/05/addressing/metadata"
        xmlns:wsu="http://docs.oasis-open.org/wss/2004/01/oasis-200401-wss-wssecurity-utility-1.0.xsd"
        xmlns:wsaws="http://www.w3.org/2005/08/addressing"
        xmlns:sp="http://docs.oasis-open.org/ws-sx/ws-securitypolicy/200702"
        xmlns:t="http://docs.oasis-open.org/ws-sx/ws-trust/200512"&gt;
  &lt;types&gt;
    &lt;xsd:schema&gt;
      &lt;xsd:import namespace="http://www.jboss.org/jbossws/ws-extensions/wssecuritypolicy" schemaLocation="SecurityService_schema1.xsd"/&gt;
    &lt;/xsd:schema&gt;
  &lt;/types&gt;
  &lt;message name="sayHello"&gt;
    &lt;part name="parameters" element="tns:sayHello"/&gt;
  &lt;/message&gt;
  &lt;message name="sayHelloResponse"&gt;
    &lt;part name="parameters" element="tns:sayHelloResponse"/&gt;
  &lt;/message&gt;
  &lt;portType name="ServiceIface"&gt;
    &lt;operation name="sayHello"&gt;
      &lt;input message="tns:sayHello"/&gt;
      &lt;output message="tns:sayHelloResponse"/&gt;
    &lt;/operation&gt;
  &lt;/portType&gt;
  &lt;!--
        The wsp:PolicyReference binds the security requirments on all the STS endpoints.
        The wsp:Policy wsu:Id="#AsymmetricSAML2Policy" element is defined later in this file.
  --&gt;
  &lt;binding name="SecurityServicePortBinding" type="tns:ServiceIface"&gt;
    &lt;wsp:PolicyReference URI="#AsymmetricSAML2Policy" /&gt;
    &lt;soap:binding transport="http://schemas.xmlsoap.org/soap/http" style="document"/&gt;
    &lt;operation name="sayHello"&gt;
      &lt;soap:operation soapAction=""/&gt;
      &lt;input&gt;
        &lt;soap:body use="literal"/&gt;
        &lt;wsp:PolicyReference URI="#Input_Policy" /&gt;
      &lt;/input&gt;
      &lt;output&gt;
        &lt;soap:body use="literal"/&gt;
        &lt;wsp:PolicyReference URI="#Output_Policy" /&gt;
      &lt;/output&gt;
    &lt;/operation&gt;
  &lt;/binding&gt;
  &lt;service name="SecurityService"&gt;
    &lt;port name="SecurityServicePort" binding="tns:SecurityServicePortBinding"&gt;
      &lt;soap:address location="http://@jboss.bind.address@:8080/jaxws-samples-wsse-policy-trust/SecurityService"/&gt;
    &lt;/port&gt;
  &lt;/service&gt;

  &lt;wsp:Policy wsu:Id="AsymmetricSAML2Policy"&gt;
        &lt;wsp:ExactlyOne&gt;
            &lt;wsp:All&gt;
  &lt;!--
        The wsam:Addressing element, indicates that the endpoints of this
        web service MUST conform to the WS-Addressing specification.  The
        attribute wsp:Optional="false" enforces this assertion.
  --&gt;
                &lt;wsam:Addressing wsp:Optional="false"&gt;
                    &lt;wsp:Policy /&gt;
                &lt;/wsam:Addressing&gt;
  &lt;!--
        The sp:AsymmetricBinding element indicates that security is provided
        at the SOAP layer. A public/private key combinations is required to
        protect the message.  The initiator will use it's private key to sign
        the message and the recipient's public key is used to encrypt the message.
        The recipient of the message will use it's private key to decrypt it and
        initiator's public key to verify the signature.
  --&gt;
                &lt;sp:AsymmetricBinding&gt;
                    &lt;wsp:Policy&gt;
  &lt;!--
        The sp:InitiatorToken element specifies the elements required in
        generating the initiator request to the ws-provider's service.
  --&gt;
                        &lt;sp:InitiatorToken&gt;
                            &lt;wsp:Policy&gt;
  &lt;!--
        The sp:IssuedToken element asserts that a SAML 2.0 security token is
        expected from the STS using a public key type.  The
        sp:IncludeToken="http://docs.oasis-open.org/ws-sx/ws-securitypolicy/200702/IncludeToken/AlwaysToRecipient"&gt;
        attribute instructs the runtime to include the initiator's public key
        with every message sent to the recipient.

        The sp:RequestSecurityTokenTemplate element directs that all of the
        children of this element will be copied directly into the body of the
        RequestSecurityToken (RST) message that is sent to the STS when the
        initiator asks the STS to issue a token.
  --&gt;
                                &lt;sp:IssuedToken
                                    sp:IncludeToken="http://docs.oasis-open.org/ws-sx/ws-securitypolicy/200702/IncludeToken/AlwaysToRecipient"&gt;
                                    &lt;sp:RequestSecurityTokenTemplate&gt;
                                        &lt;t:TokenType&gt;http://docs.oasis-open.org/wss/oasis-wss-saml-token-profile-1.1#SAMLV2.0&lt;/t:TokenType&gt;
                                        &lt;t:KeyType&gt;http://docs.oasis-open.org/ws-sx/ws-trust/200512/PublicKey&lt;/t:KeyType&gt;
                                    &lt;/sp:RequestSecurityTokenTemplate&gt;
                                    &lt;wsp:Policy&gt;
                                        &lt;sp:RequireInternalReference /&gt;
                                    &lt;/wsp:Policy&gt;
  &lt;!--
        The sp:Issuer element defines the STS's address and endpoint information
        This information is used by the STSClient.
  --&gt;
                                    &lt;sp:Issuer&gt;
                                        &lt;wsaws:Address&gt;http://@jboss.bind.address@:8080/jaxws-samples-wsse-policy-trust-sts/SecurityTokenService&lt;/wsaws:Address&gt;
                                        &lt;wsaws:Metadata xmlns:wsdli="http://www.w3.org/2006/01/wsdl-instance"
                                                        wsdli:wsdlLocation="http://@jboss.bind.address@:8080/jaxws-samples-wsse-policy-trust-sts/SecurityTokenService?wsdl"&gt;
                                            &lt;wsaw:ServiceName xmlns:wsaw="http://www.w3.org/2006/05/addressing/wsdl"
                                                            xmlns:stsns="http://docs.oasis-open.org/ws-sx/ws-trust/200512/"
                                                            EndpointName="UT_Port"&gt;stsns:SecurityTokenService&lt;/wsaw:ServiceName&gt;
                                        &lt;/wsaws:Metadata&gt;
                                    &lt;/sp:Issuer&gt;
                                &lt;/sp:IssuedToken&gt;
                            &lt;/wsp:Policy&gt;
                        &lt;/sp:InitiatorToken&gt;
  &lt;!--
        The sp:RecipientToken element asserts the type of public/private key-pair
        expected from the recipient.  The
        sp:IncludeToken="http://docs.oasis-open.org/ws-sx/ws-securitypolicy/200702/IncludeToken/Never"&gt;
        attribute indicates that the initiator's public key will never be included
        in the reply messages.

        The sp:WssX509V3Token10 element indicates that an X509 Version 3 token
        should be used in the message.
  --&gt;
                        &lt;sp:RecipientToken&gt;
                            &lt;wsp:Policy&gt;
                                &lt;sp:X509Token
                                    sp:IncludeToken="http://docs.oasis-open.org/ws-sx/ws-securitypolicy/200702/IncludeToken/Never"&gt;
                                    &lt;wsp:Policy&gt;
                                        &lt;sp:WssX509V3Token10 /&gt;
                                        &lt;sp:RequireIssuerSerialReference /&gt;
                                    &lt;/wsp:Policy&gt;
                                &lt;/sp:X509Token&gt;
                            &lt;/wsp:Policy&gt;
                        &lt;/sp:RecipientToken&gt;
&lt;!--
     The sp:Layout element,  indicates the layout rules to apply when adding
     items to the security header.  The sp:Lax sub-element indicates items
     are added to the security header in any order that conforms to
     WSS: SOAP Message Security.
--&gt;
                        &lt;sp:Layout&gt;
                            &lt;wsp:Policy&gt;
                                &lt;sp:Lax /&gt;
                            &lt;/wsp:Policy&gt;
                        &lt;/sp:Layout&gt;
                        &lt;sp:IncludeTimestamp /&gt;
                        &lt;sp:OnlySignEntireHeadersAndBody /&gt;
 &lt;!--
     The sp:AlgorithmSuite element, requires the Basic256 algorithm suite
     be used in performing cryptographic operations.
--&gt;
                        &lt;sp:AlgorithmSuite&gt;
                            &lt;wsp:Policy&gt;
                                &lt;sp:Basic256 /&gt;
                            &lt;/wsp:Policy&gt;
                        &lt;/sp:AlgorithmSuite&gt;
                    &lt;/wsp:Policy&gt;
                &lt;/sp:AsymmetricBinding&gt;
&lt;!--
    The sp:Wss11 element declares WSS: SOAP Message Security 1.1 options
    to be supported by the STS.  These particular elements generally refer
    to how keys are referenced within the SOAP envelope.  These are normally
    handled by CXF.
--&gt;
                &lt;sp:Wss11&gt;
                    &lt;wsp:Policy&gt;
                        &lt;sp:MustSupportRefIssuerSerial /&gt;
                        &lt;sp:MustSupportRefThumbprint /&gt;
                        &lt;sp:MustSupportRefEncryptedKey /&gt;
                    &lt;/wsp:Policy&gt;
                &lt;/sp:Wss11&gt;
&lt;!--
    The sp:Trust13 element declares controls for WS-Trust 1.3 options.
    They are policy assertions related to exchanges specifically with
    client and server challenges and entropy behaviors.  Again these are
    normally handled by CXF.
--&gt;
                &lt;sp:Trust13&gt;
                    &lt;wsp:Policy&gt;
                        &lt;sp:MustSupportIssuedTokens /&gt;
                        &lt;sp:RequireClientEntropy /&gt;
                        &lt;sp:RequireServerEntropy /&gt;
                    &lt;/wsp:Policy&gt;
                &lt;/sp:Trust13&gt;
            &lt;/wsp:All&gt;
        &lt;/wsp:ExactlyOne&gt;
    &lt;/wsp:Policy&gt;

    &lt;wsp:Policy wsu:Id="Input_Policy"&gt;
        &lt;wsp:ExactlyOne&gt;
            &lt;wsp:All&gt;
                &lt;sp:EncryptedParts&gt;
                    &lt;sp:Body /&gt;
                &lt;/sp:EncryptedParts&gt;
                &lt;sp:SignedParts&gt;
                    &lt;sp:Body /&gt;
                    &lt;sp:Header Name="To" Namespace="http://www.w3.org/2005/08/addressing" /&gt;
                    &lt;sp:Header Name="From" Namespace="http://www.w3.org/2005/08/addressing" /&gt;
                    &lt;sp:Header Name="FaultTo" Namespace="http://www.w3.org/2005/08/addressing" /&gt;
                    &lt;sp:Header Name="ReplyTo" Namespace="http://www.w3.org/2005/08/addressing" /&gt;
                    &lt;sp:Header Name="MessageID" Namespace="http://www.w3.org/2005/08/addressing" /&gt;
                    &lt;sp:Header Name="RelatesTo" Namespace="http://www.w3.org/2005/08/addressing" /&gt;
                    &lt;sp:Header Name="Action" Namespace="http://www.w3.org/2005/08/addressing" /&gt;
                &lt;/sp:SignedParts&gt;
            &lt;/wsp:All&gt;
        &lt;/wsp:ExactlyOne&gt;
    &lt;/wsp:Policy&gt;

    &lt;wsp:Policy wsu:Id="Output_Policy"&gt;
        &lt;wsp:ExactlyOne&gt;
            &lt;wsp:All&gt;
                &lt;sp:EncryptedParts&gt;
                    &lt;sp:Body /&gt;
                &lt;/sp:EncryptedParts&gt;
                &lt;sp:SignedParts&gt;
                    &lt;sp:Body /&gt;
                    &lt;sp:Header Name="To" Namespace="http://www.w3.org/2005/08/addressing" /&gt;
                    &lt;sp:Header Name="From" Namespace="http://www.w3.org/2005/08/addressing" /&gt;
                    &lt;sp:Header Name="FaultTo" Namespace="http://www.w3.org/2005/08/addressing" /&gt;
                    &lt;sp:Header Name="ReplyTo" Namespace="http://www.w3.org/2005/08/addressing" /&gt;
                    &lt;sp:Header Name="MessageID" Namespace="http://www.w3.org/2005/08/addressing" /&gt;
                    &lt;sp:Header Name="RelatesTo" Namespace="http://www.w3.org/2005/08/addressing" /&gt;
                    &lt;sp:Header Name="Action" Namespace="http://www.w3.org/2005/08/addressing" /&gt;
                &lt;/sp:SignedParts&gt;
            &lt;/wsp:All&gt;
        &lt;/wsp:ExactlyOne&gt;
    &lt;/wsp:Policy&gt;
&lt;/definitions&gt;</code></pre>
</div>
</div>
</div>
<div class="sect6">
<h7 id="web-service-provider-interface"><a class="anchor" href="#web-service-provider-interface"></a>Web service provider Interface</h7>
<div class="paragraph">
<p>The web service provider interface class, ServiceIface, is a simple
straight forward web service definition.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">package org.jboss.test.ws.jaxws.samples.wsse.policy.trust.service;

import javax.jws.WebMethod;
import javax.jws.WebService;

@WebService
(
   targetNamespace = "http://www.jboss.org/jbossws/ws-extensions/wssecuritypolicy"
)
public interface ServiceIface
{
   @WebMethod
   String sayHello();
}</code></pre>
</div>
</div>
</div>
<div class="sect6">
<h7 id="web-service-provider-implementation"><a class="anchor" href="#web-service-provider-implementation"></a>Web service provider Implementation</h7>
<div class="paragraph">
<p>The web service provider implementation class, ServiceImpl, is a simple
POJO. It uses the standard WebService annotation to define the service
endpoint. In addition there are two Apache CXF annotations,
EndpointProperties and EndpointProperty used for configuring the
endpoint for the CXF runtime. These annotations come from the
<a href="https://ws.apache.org/wss4j/">Apache WSS4J project</a>, which provides a
Java implementation of the primary WS-Security standards for Web
Services. These annotations are programmatically adding properties to
the endpoint. With plain Apache CXF, these properties are often set via
the &lt;jaxws:properties&gt; element on the &lt;jaxws:endpoint&gt; element in the
Spring config; these annotations allow the properties to be configured
in the code.</p>
</div>
<div class="paragraph">
<p>WSS4J uses the Crypto interface to get keys and certificates for
encryption/decryption and for signature creation/verification. As is
asserted by the WSDL, X509 keys and certificates are required for this
service. The WSS4J configuration information being provided by
ServiceImpl is for Crypto&#8217;s Merlin implementation. More information will
be provided about this in the keystore section.</p>
</div>
<div class="paragraph">
<p>The first EndpointProperty statement in the listing is declaring the
user&#8217;s name to use for the message signature. It is used as the alias
name in the keystore to get the user&#8217;s cert and private key for
signature. The next two EndpointProperty statements declares the Java
properties file that contains the (Merlin) crypto configuration
information. In this case both for signing and encrypting the messages.
WSS4J reads this file and extra required information for message
handling. The last EndpointProperty statement declares the
ServerCallbackHandler implementation class. It is used to obtain the
user&#8217;s password for the certificates in the keystore file.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">package org.jboss.test.ws.jaxws.samples.wsse.policy.trust.service;

import javax.jws.WebService;

import org.apache.cxf.annotations.EndpointProperties;
import org.apache.cxf.annotations.EndpointProperty;

@WebService
(
   portName = "SecurityServicePort",
   serviceName = "SecurityService",
   wsdlLocation = "WEB-INF/wsdl/SecurityService.wsdl",
   targetNamespace = "http://www.jboss.org/jbossws/ws-extensions/wssecuritypolicy",
   endpointInterface = "org.jboss.test.ws.jaxws.samples.wsse.policy.trust.service.ServiceIface"
)
@EndpointProperties(value = {
      @EndpointProperty(key = "ws-security.signature.username", value = "myservicekey"),
      @EndpointProperty(key = "ws-security.signature.properties", value = "serviceKeystore.properties"),
      @EndpointProperty(key = "ws-security.encryption.properties", value = "serviceKeystore.properties"),
      @EndpointProperty(key = "ws-security.callback-handler", value = "org.jboss.test.ws.jaxws.samples.wsse.policy.trust.service.ServerCallbackHandler")
})
public class ServiceImpl implements ServiceIface
{
   public String sayHello()
   {
      return "WS-Trust Hello World!";
   }
}</code></pre>
</div>
</div>
</div>
<div class="sect6">
<h7 id="servercallbackhandler"><a class="anchor" href="#servercallbackhandler"></a>ServerCallbackHandler</h7>
<div class="paragraph">
<p>ServerCallbackHandler is a callback handler for the WSS4J Crypto API. It
is used to obtain the password for the private key in the keystore. This
class enables CXF to retrieve the password of the user name to use for
the message signature. A certificates' password is not discoverable. The
creator of the certificate must record the password he assigns and
provide it when requested through the CallbackHandler. In this scenario
skpass is the password for user myservicekey.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java"> package org.jboss.test.ws.jaxws.samples.wsse.policy.trust.service;

import java.util.HashMap;
import java.util.Map;

import org.jboss.wsf.stack.cxf.extensions.security.PasswordCallbackHandler;

public class ServerCallbackHandler extends PasswordCallbackHandler
{

   public ServerCallbackHandler()
   {
      super(getInitMap());
   }

   private static Map&lt;String, String&gt; getInitMap()
   {
      Map&lt;String, String&gt; passwords = new HashMap&lt;String, String&gt;();
      passwords.put("myservicekey", "skpass");
      return passwords;
   }
}</code></pre>
</div>
</div>
</div>
<div class="sect6">
<h7 id="crypto-properties-and-keystore-files"><a class="anchor" href="#crypto-properties-and-keystore-files"></a>Crypto properties and keystore files</h7>
<div class="paragraph">
<p>WSS4J&#8217;s Crypto implementation is loaded and configured via a Java
properties file that contains Crypto configuration data. The file
contains implementation-specific properties such as a keystore location,
password, default alias and the like. This application is using the
Merlin implementation. File serviceKeystore.properties contains this
information.</p>
</div>
<div class="paragraph">
<p>File servicestore.jks, is a Java KeyStore (JKS) repository. It contains
self signed certificates for myservicekey and mystskey. <em>Self signed
certificates are not appropriate for production use.</em></p>
</div>
<div class="literalblock">
<div class="content">
<pre>org.apache.ws.security.crypto.provider=org.apache.ws.security.components.crypto.Merlin
org.apache.ws.security.crypto.merlin.keystore.type=jks
org.apache.ws.security.crypto.merlin.keystore.password=sspass
org.apache.ws.security.crypto.merlin.keystore.alias=myservicekey
org.apache.ws.security.crypto.merlin.keystore.file=servicestore.jks</pre>
</div>
</div>
</div>
<div class="sect6">
<h7 id="manifest-mf-ws-trust"><a class="anchor" href="#manifest-mf-ws-trust"></a>MANIFEST.MF</h7>
<div class="paragraph">
<p>When deployed on WildFly this application requires access to the JBossWs
and CXF APIs provided in module org.jboss.ws.cxf.jbossws-cxf-client. The
dependency statement directs the server to provide them at deployment.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>Manifest-Version: 1.0
Ant-Version: Apache Ant 1.8.2
Created-By: 1.7.0_25-b15 (Oracle Corporation)
Dependencies: org.jboss.ws.cxf.jbossws-cxf-client</pre>
</div>
</div>
</div>
</div>
<div class="sect5">
<h6 id="security-token-service-sts"><a class="anchor" href="#security-token-service-sts"></a>Security Token Service (STS)</h6>
<div class="paragraph">
<p>This section examines the crucial elements in providing the Security
Token Service functionality described in the basic WS-Trust scenario.
The components that will be discussed are.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>STS&#8217;s WSDL</p>
</li>
<li>
<p>STS&#8217;s implementation class.</p>
</li>
<li>
<p>STSCallbackHandler class</p>
</li>
<li>
<p>Crypto properties and keystore files</p>
</li>
<li>
<p>MANIFEST.MF</p>
</li>
<li>
<p>Server configuration files</p>
</li>
</ul>
</div>
<div class="sect6">
<h7 id="sts-wsdl"><a class="anchor" href="#sts-wsdl"></a>STS WSDL</h7>
<div class="paragraph">
<p>The STS is a contract-first endpoint. All the WS-trust and security
policies for it are declared in the WSDL, ws-trust-1.4-service.wsdl. A
symmetric binding policy is used to encrypt and sign the SOAP body of
messages that pass back and forth between ws-requester and the STS. The
ws-requester is required to authenticate itself by providing WSS
UsernameToken credentials. The rules for sharing the public and private
keys in the SOAP request and response messages are declared. A detailed
explanation of the security settings are provided in the comments in the
listing below.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml"> &lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;wsdl:definitions
        targetNamespace="http://docs.oasis-open.org/ws-sx/ws-trust/200512/"
        xmlns:tns="http://docs.oasis-open.org/ws-sx/ws-trust/200512/"
        xmlns:wstrust="http://docs.oasis-open.org/ws-sx/ws-trust/200512/"
        xmlns:wsdl="http://schemas.xmlsoap.org/wsdl/"
        xmlns:soap="http://schemas.xmlsoap.org/wsdl/soap/"
        xmlns:wsap10="http://www.w3.org/2006/05/addressing/wsdl"
        xmlns:wsu="http://docs.oasis-open.org/wss/2004/01/oasis-200401-wss-wssecurity-utility-1.0.xsd"
        xmlns:wsp="http://www.w3.org/ns/ws-policy"
    xmlns:wst="http://docs.oasis-open.org/ws-sx/ws-trust/200512"
    xmlns:xs="http://www.w3.org/2001/XMLSchema"
    xmlns:wsam="http://www.w3.org/2007/05/addressing/metadata"&gt;

  &lt;wsdl:types&gt;
    &lt;xs:schema elementFormDefault="qualified" targetNamespace='http://docs.oasis-open.org/ws-sx/ws-trust/200512'&gt;

      &lt;xs:element name='RequestSecurityToken' type='wst:AbstractRequestSecurityTokenType' /&gt;
      &lt;xs:element name='RequestSecurityTokenResponse' type='wst:AbstractRequestSecurityTokenType' /&gt;

      &lt;xs:complexType name='AbstractRequestSecurityTokenType' &gt;
        &lt;xs:sequence&gt;
          &lt;xs:any namespace='##any' processContents='lax' minOccurs='0' maxOccurs='unbounded' /&gt;
        &lt;/xs:sequence&gt;
        &lt;xs:attribute name='Context' type='xs:anyURI' use='optional' /&gt;
        &lt;xs:anyAttribute namespace='##other' processContents='lax' /&gt;
      &lt;/xs:complexType&gt;
      &lt;xs:element name='RequestSecurityTokenCollection' type='wst:RequestSecurityTokenCollectionType' /&gt;
      &lt;xs:complexType name='RequestSecurityTokenCollectionType' &gt;
        &lt;xs:sequence&gt;
          &lt;xs:element name='RequestSecurityToken' type='wst:AbstractRequestSecurityTokenType' minOccurs='2' maxOccurs='unbounded'/&gt;
        &lt;/xs:sequence&gt;
      &lt;/xs:complexType&gt;

      &lt;xs:element name='RequestSecurityTokenResponseCollection' type='wst:RequestSecurityTokenResponseCollectionType' /&gt;
      &lt;xs:complexType name='RequestSecurityTokenResponseCollectionType' &gt;
        &lt;xs:sequence&gt;
          &lt;xs:element ref='wst:RequestSecurityTokenResponse' minOccurs='1' maxOccurs='unbounded' /&gt;
        &lt;/xs:sequence&gt;
        &lt;xs:anyAttribute namespace='##other' processContents='lax' /&gt;
      &lt;/xs:complexType&gt;

    &lt;/xs:schema&gt;
  &lt;/wsdl:types&gt;

  &lt;!-- WS-Trust defines the following GEDs --&gt;
  &lt;wsdl:message name="RequestSecurityTokenMsg"&gt;
    &lt;wsdl:part name="request" element="wst:RequestSecurityToken" /&gt;
  &lt;/wsdl:message&gt;
  &lt;wsdl:message name="RequestSecurityTokenResponseMsg"&gt;
    &lt;wsdl:part name="response"
            element="wst:RequestSecurityTokenResponse" /&gt;
  &lt;/wsdl:message&gt;
  &lt;wsdl:message name="RequestSecurityTokenCollectionMsg"&gt;
    &lt;wsdl:part name="requestCollection"
            element="wst:RequestSecurityTokenCollection"/&gt;
  &lt;/wsdl:message&gt;
  &lt;wsdl:message name="RequestSecurityTokenResponseCollectionMsg"&gt;
    &lt;wsdl:part name="responseCollection"
            element="wst:RequestSecurityTokenResponseCollection"/&gt;
  &lt;/wsdl:message&gt;

  &lt;!-- This portType an example of a Requestor (or other) endpoint that
         Accepts SOAP-based challenges from a Security Token Service --&gt;
  &lt;wsdl:portType name="WSSecurityRequestor"&gt;
    &lt;wsdl:operation name="Challenge"&gt;
      &lt;wsdl:input message="tns:RequestSecurityTokenResponseMsg"/&gt;
      &lt;wsdl:output message="tns:RequestSecurityTokenResponseMsg"/&gt;
    &lt;/wsdl:operation&gt;
  &lt;/wsdl:portType&gt;


  &lt;!-- This portType is an example of an STS supporting full protocol --&gt;
&lt;!--
    The wsdl:portType and data types are XML elements defined by the
    WS_Trust specification.  The wsdl:portType defines the endpoints
    supported in the STS implementation.  This WSDL defines all operations
    that an STS implementation can support.
--&gt;
  &lt;wsdl:portType name="STS"&gt;
    &lt;wsdl:operation name="Cancel"&gt;
      &lt;wsdl:input wsam:Action="http://docs.oasis-open.org/ws-sx/ws-trust/200512/RST/Cancel" message="tns:RequestSecurityTokenMsg"/&gt;
      &lt;wsdl:output wsam:Action="http://docs.oasis-open.org/ws-sx/ws-trust/200512/RSTR/CancelFinal" message="tns:RequestSecurityTokenResponseMsg"/&gt;
    &lt;/wsdl:operation&gt;
    &lt;wsdl:operation name="Issue"&gt;
      &lt;wsdl:input wsam:Action="http://docs.oasis-open.org/ws-sx/ws-trust/200512/RST/Issue" message="tns:RequestSecurityTokenMsg"/&gt;
      &lt;wsdl:output wsam:Action="http://docs.oasis-open.org/ws-sx/ws-trust/200512/RSTRC/IssueFinal" message="tns:RequestSecurityTokenResponseCollectionMsg"/&gt;
    &lt;/wsdl:operation&gt;
    &lt;wsdl:operation name="Renew"&gt;
      &lt;wsdl:input wsam:Action="http://docs.oasis-open.org/ws-sx/ws-trust/200512/RST/Renew" message="tns:RequestSecurityTokenMsg"/&gt;
      &lt;wsdl:output wsam:Action="http://docs.oasis-open.org/ws-sx/ws-trust/200512/RSTR/RenewFinal" message="tns:RequestSecurityTokenResponseMsg"/&gt;
    &lt;/wsdl:operation&gt;
    &lt;wsdl:operation name="Validate"&gt;
      &lt;wsdl:input wsam:Action="http://docs.oasis-open.org/ws-sx/ws-trust/200512/RST/Validate" message="tns:RequestSecurityTokenMsg"/&gt;
      &lt;wsdl:output wsam:Action="http://docs.oasis-open.org/ws-sx/ws-trust/200512/RSTR/ValidateFinal" message="tns:RequestSecurityTokenResponseMsg"/&gt;
    &lt;/wsdl:operation&gt;
    &lt;wsdl:operation name="KeyExchangeToken"&gt;
      &lt;wsdl:input wsam:Action="http://docs.oasis-open.org/ws-sx/ws-trust/200512/RST/KET" message="tns:RequestSecurityTokenMsg"/&gt;
      &lt;wsdl:output wsam:Action="http://docs.oasis-open.org/ws-sx/ws-trust/200512/RSTR/KETFinal" message="tns:RequestSecurityTokenResponseMsg"/&gt;
    &lt;/wsdl:operation&gt;
    &lt;wsdl:operation name="RequestCollection"&gt;
      &lt;wsdl:input message="tns:RequestSecurityTokenCollectionMsg"/&gt;
      &lt;wsdl:output message="tns:RequestSecurityTokenResponseCollectionMsg"/&gt;
    &lt;/wsdl:operation&gt;
  &lt;/wsdl:portType&gt;

  &lt;!-- This portType is an example of an endpoint that accepts
         Unsolicited RequestSecurityTokenResponse messages --&gt;
  &lt;wsdl:portType name="SecurityTokenResponseService"&gt;
    &lt;wsdl:operation name="RequestSecurityTokenResponse"&gt;
      &lt;wsdl:input message="tns:RequestSecurityTokenResponseMsg"/&gt;
    &lt;/wsdl:operation&gt;
  &lt;/wsdl:portType&gt;

&lt;!--
    The wsp:PolicyReference binds the security requirments on all the STS endpoints.
    The wsp:Policy wsu:Id="UT_policy" element is later in this file.
--&gt;
  &lt;wsdl:binding name="UT_Binding" type="wstrust:STS"&gt;
    &lt;wsp:PolicyReference URI="#UT_policy" /&gt;
      &lt;soap:binding style="document"
          transport="http://schemas.xmlsoap.org/soap/http" /&gt;
      &lt;wsdl:operation name="Issue"&gt;
          &lt;soap:operation
              soapAction="http://docs.oasis-open.org/ws-sx/ws-trust/200512/RST/Issue" /&gt;
          &lt;wsdl:input&gt;
              &lt;wsp:PolicyReference
               URI="#Input_policy" /&gt;
              &lt;soap:body use="literal" /&gt;
          &lt;/wsdl:input&gt;
          &lt;wsdl:output&gt;
              &lt;wsp:PolicyReference
               URI="#Output_policy" /&gt;
              &lt;soap:body use="literal" /&gt;
          &lt;/wsdl:output&gt;
      &lt;/wsdl:operation&gt;
      &lt;wsdl:operation name="Validate"&gt;
          &lt;soap:operation
              soapAction="http://docs.oasis-open.org/ws-sx/ws-trust/200512/RST/Validate" /&gt;
          &lt;wsdl:input&gt;
              &lt;wsp:PolicyReference
               URI="#Input_policy" /&gt;
              &lt;soap:body use="literal" /&gt;
          &lt;/wsdl:input&gt;
          &lt;wsdl:output&gt;
              &lt;wsp:PolicyReference
               URI="#Output_policy" /&gt;
              &lt;soap:body use="literal" /&gt;
          &lt;/wsdl:output&gt;
      &lt;/wsdl:operation&gt;
      &lt;wsdl:operation name="Cancel"&gt;
          &lt;soap:operation
              soapAction="http://docs.oasis-open.org/ws-sx/ws-trust/200512/RST/Cancel" /&gt;
          &lt;wsdl:input&gt;
              &lt;soap:body use="literal" /&gt;
          &lt;/wsdl:input&gt;
          &lt;wsdl:output&gt;
              &lt;soap:body use="literal" /&gt;
          &lt;/wsdl:output&gt;
      &lt;/wsdl:operation&gt;
      &lt;wsdl:operation name="Renew"&gt;
          &lt;soap:operation
              soapAction="http://docs.oasis-open.org/ws-sx/ws-trust/200512/RST/Renew" /&gt;
          &lt;wsdl:input&gt;
              &lt;soap:body use="literal" /&gt;
          &lt;/wsdl:input&gt;
          &lt;wsdl:output&gt;
              &lt;soap:body use="literal" /&gt;
          &lt;/wsdl:output&gt;
      &lt;/wsdl:operation&gt;
      &lt;wsdl:operation name="KeyExchangeToken"&gt;
          &lt;soap:operation
              soapAction="http://docs.oasis-open.org/ws-sx/ws-trust/200512/RST/KeyExchangeToken" /&gt;
          &lt;wsdl:input&gt;
              &lt;soap:body use="literal" /&gt;
          &lt;/wsdl:input&gt;
          &lt;wsdl:output&gt;
              &lt;soap:body use="literal" /&gt;
          &lt;/wsdl:output&gt;
      &lt;/wsdl:operation&gt;
      &lt;wsdl:operation name="RequestCollection"&gt;
          &lt;soap:operation
              soapAction="http://docs.oasis-open.org/ws-sx/ws-trust/200512/RST/RequestCollection" /&gt;
          &lt;wsdl:input&gt;
              &lt;soap:body use="literal" /&gt;
          &lt;/wsdl:input&gt;
          &lt;wsdl:output&gt;
              &lt;soap:body use="literal" /&gt;
          &lt;/wsdl:output&gt;
      &lt;/wsdl:operation&gt;
  &lt;/wsdl:binding&gt;

  &lt;wsdl:service name="SecurityTokenService"&gt;
      &lt;wsdl:port name="UT_Port" binding="tns:UT_Binding"&gt;
         &lt;soap:address location="http://localhost:8080/SecurityTokenService/UT" /&gt;
      &lt;/wsdl:port&gt;
  &lt;/wsdl:service&gt;

  &lt;wsp:Policy wsu:Id="UT_policy"&gt;
      &lt;wsp:ExactlyOne&gt;
         &lt;wsp:All&gt;
&lt;!--
    The sp:UsingAddressing element, indicates that the endpoints of this
    web service conforms to the WS-Addressing specification.  More detail
    can be found here: [http://www.w3.org/TR/2006/CR-ws-addr-wsdl-20060529]
--&gt;
            &lt;wsap10:UsingAddressing/&gt;
&lt;!--
    The sp:SymmetricBinding element indicates that security is provided
    at the SOAP layer and any initiator must authenticate itself by providing
    WSS UsernameToken credentials.
--&gt;
            &lt;sp:SymmetricBinding
               xmlns:sp="http://docs.oasis-open.org/ws-sx/ws-securitypolicy/200702"&gt;
               &lt;wsp:Policy&gt;
&lt;!--
    In a symmetric binding, the keys used for encrypting and signing in both
    directions are derived from a single key, the one specified by the
    sp:ProtectionToken element.  The sp:X509Token sub-element declares this
    key to be a X.509 certificate and the
    IncludeToken="http://docs.oasis-open.org/ws-sx/ws-securitypolicy/200702/IncludeToken/Never"
    attribute adds the requirement that the token MUST NOT be included in
    any messages sent between the initiator and the recipient; rather, an
    external reference to the token should be used.  Lastly the WssX509V3Token10
    sub-element declares that the Username token presented by the initiator
    should be compliant with Web Services Security UsernameToken Profile
    1.0 specification. [ http://docs.oasis-open.org/wss/2004/01/oasis-200401-wss-username-token-profile-1.0.pdf ]
--&gt;
                  &lt;sp:ProtectionToken&gt;
                     &lt;wsp:Policy&gt;
                        &lt;sp:X509Token
                           sp:IncludeToken="http://docs.oasis-open.org/ws-sx/ws-securitypolicy/200702/IncludeToken/Never"&gt;
                           &lt;wsp:Policy&gt;
                              &lt;sp:RequireDerivedKeys /&gt;
                              &lt;sp:RequireThumbprintReference /&gt;
                              &lt;sp:WssX509V3Token10 /&gt;
                           &lt;/wsp:Policy&gt;
                        &lt;/sp:X509Token&gt;
                     &lt;/wsp:Policy&gt;
                  &lt;/sp:ProtectionToken&gt;
&lt;!--
    The sp:AlgorithmSuite element, requires the Basic256 algorithm suite
    be used in performing cryptographic operations.
--&gt;
                  &lt;sp:AlgorithmSuite&gt;
                     &lt;wsp:Policy&gt;
                        &lt;sp:Basic256 /&gt;
                     &lt;/wsp:Policy&gt;
                  &lt;/sp:AlgorithmSuite&gt;
&lt;!--
    The sp:Layout element,  indicates the layout rules to apply when adding
    items to the security header.  The sp:Lax sub-element indicates items
    are added to the security header in any order that conforms to
    WSS: SOAP Message Security.
--&gt;
                  &lt;sp:Layout&gt;
                     &lt;wsp:Policy&gt;
                        &lt;sp:Lax /&gt;
                     &lt;/wsp:Policy&gt;
                  &lt;/sp:Layout&gt;
                  &lt;sp:IncludeTimestamp /&gt;
                  &lt;sp:EncryptSignature /&gt;
                  &lt;sp:OnlySignEntireHeadersAndBody /&gt;
               &lt;/wsp:Policy&gt;
            &lt;/sp:SymmetricBinding&gt;
&lt;!--
    The sp:SignedSupportingTokens element declares that the security header
    of messages must contain a sp:UsernameToken and the token must be signed.
    The attribute IncludeToken="http://docs.oasis-open.org/ws-sx/ws-securitypolicy/200702/IncludeToken/AlwaysToRecipient"
    on sp:UsernameToken indicates that the token MUST be included in all
    messages sent from initiator to the recipient and that the token MUST
    NOT be included in messages sent from the recipient to the initiator.
    And finally the element sp:WssUsernameToken10 is a policy assertion
    indicating the Username token should be as defined in  Web Services
    Security UsernameToken Profile 1.0
--&gt;
            &lt;sp:SignedSupportingTokens
               xmlns:sp="http://docs.oasis-open.org/ws-sx/ws-securitypolicy/200702"&gt;
               &lt;wsp:Policy&gt;
                  &lt;sp:UsernameToken
                     sp:IncludeToken="http://docs.oasis-open.org/ws-sx/ws-securitypolicy/200702/IncludeToken/AlwaysToRecipient"&gt;
                     &lt;wsp:Policy&gt;
                        &lt;sp:WssUsernameToken10 /&gt;
                     &lt;/wsp:Policy&gt;
                  &lt;/sp:UsernameToken&gt;
               &lt;/wsp:Policy&gt;
            &lt;/sp:SignedSupportingTokens&gt;
&lt;!--
    The sp:Wss11 element declares WSS: SOAP Message Security 1.1 options
    to be supported by the STS.  These particular elements generally refer
    to how keys are referenced within the SOAP envelope.  These are normally
    handled by CXF.
--&gt;
            &lt;sp:Wss11
               xmlns:sp="http://docs.oasis-open.org/ws-sx/ws-securitypolicy/200702"&gt;
               &lt;wsp:Policy&gt;
                  &lt;sp:MustSupportRefKeyIdentifier /&gt;
                  &lt;sp:MustSupportRefIssuerSerial /&gt;
                  &lt;sp:MustSupportRefThumbprint /&gt;
                  &lt;sp:MustSupportRefEncryptedKey /&gt;
               &lt;/wsp:Policy&gt;
            &lt;/sp:Wss11&gt;
&lt;!--
    The sp:Trust13 element declares controls for WS-Trust 1.3 options.
    They are policy assertions related to exchanges specifically with
    client and server challenges and entropy behaviors.  Again these are
    normally handled by CXF.
--&gt;
            &lt;sp:Trust13
               xmlns:sp="http://docs.oasis-open.org/ws-sx/ws-securitypolicy/200702"&gt;
               &lt;wsp:Policy&gt;
                  &lt;sp:MustSupportIssuedTokens /&gt;
                  &lt;sp:RequireClientEntropy /&gt;
                  &lt;sp:RequireServerEntropy /&gt;
               &lt;/wsp:Policy&gt;
            &lt;/sp:Trust13&gt;
         &lt;/wsp:All&gt;
      &lt;/wsp:ExactlyOne&gt;
   &lt;/wsp:Policy&gt;

   &lt;wsp:Policy wsu:Id="Input_policy"&gt;
      &lt;wsp:ExactlyOne&gt;
         &lt;wsp:All&gt;
            &lt;sp:SignedParts
               xmlns:sp="http://docs.oasis-open.org/ws-sx/ws-securitypolicy/200702"&gt;
               &lt;sp:Body /&gt;
               &lt;sp:Header Name="To"
                  Namespace="http://www.w3.org/2005/08/addressing" /&gt;
               &lt;sp:Header Name="From"
                  Namespace="http://www.w3.org/2005/08/addressing" /&gt;
               &lt;sp:Header Name="FaultTo"
                  Namespace="http://www.w3.org/2005/08/addressing" /&gt;
               &lt;sp:Header Name="ReplyTo"
                  Namespace="http://www.w3.org/2005/08/addressing" /&gt;
               &lt;sp:Header Name="MessageID"
                  Namespace="http://www.w3.org/2005/08/addressing" /&gt;
               &lt;sp:Header Name="RelatesTo"
                  Namespace="http://www.w3.org/2005/08/addressing" /&gt;
               &lt;sp:Header Name="Action"
                  Namespace="http://www.w3.org/2005/08/addressing" /&gt;
            &lt;/sp:SignedParts&gt;
            &lt;sp:EncryptedParts
               xmlns:sp="http://docs.oasis-open.org/ws-sx/ws-securitypolicy/200702"&gt;
               &lt;sp:Body /&gt;
            &lt;/sp:EncryptedParts&gt;
         &lt;/wsp:All&gt;
      &lt;/wsp:ExactlyOne&gt;
   &lt;/wsp:Policy&gt;

   &lt;wsp:Policy wsu:Id="Output_policy"&gt;
      &lt;wsp:ExactlyOne&gt;
         &lt;wsp:All&gt;
            &lt;sp:SignedParts
               xmlns:sp="http://docs.oasis-open.org/ws-sx/ws-securitypolicy/200702"&gt;
               &lt;sp:Body /&gt;
               &lt;sp:Header Name="To"
                  Namespace="http://www.w3.org/2005/08/addressing" /&gt;
               &lt;sp:Header Name="From"
                  Namespace="http://www.w3.org/2005/08/addressing" /&gt;
               &lt;sp:Header Name="FaultTo"
                  Namespace="http://www.w3.org/2005/08/addressing" /&gt;
               &lt;sp:Header Name="ReplyTo"
                  Namespace="http://www.w3.org/2005/08/addressing" /&gt;
               &lt;sp:Header Name="MessageID"
                  Namespace="http://www.w3.org/2005/08/addressing" /&gt;
               &lt;sp:Header Name="RelatesTo"
                  Namespace="http://www.w3.org/2005/08/addressing" /&gt;
               &lt;sp:Header Name="Action"
                  Namespace="http://www.w3.org/2005/08/addressing" /&gt;
            &lt;/sp:SignedParts&gt;
            &lt;sp:EncryptedParts
               xmlns:sp="http://docs.oasis-open.org/ws-sx/ws-securitypolicy/200702"&gt;
               &lt;sp:Body /&gt;
            &lt;/sp:EncryptedParts&gt;
         &lt;/wsp:All&gt;
      &lt;/wsp:ExactlyOne&gt;
   &lt;/wsp:Policy&gt;

&lt;/wsdl:definitions&gt;</code></pre>
</div>
</div>
</div>
<div class="sect6">
<h7 id="sts-implementation"><a class="anchor" href="#sts-implementation"></a>STS Implementation</h7>
<div class="paragraph">
<p>The Apache CXF&#8217;s STS, SecurityTokenServiceProvider, is a web service
provider that is compliant with the protocols and functionality defined
by the WS-Trust specification. It has a modular architecture. Many of
its components are configurable or replaceable and there are many
optional features that are enabled by implementing and configuring
plug-ins. Users can customize their own STS by extending from
SecurityTokenServiceProvider and overriding the default settings.
Extensive information about the CXF&#8217;s STS configurable and pluggable
components can be found
<a href="http://coheigea.blogspot.com/2011/11/apache-cxf-sts-documentation-part-viii_10.html">here</a>.</p>
</div>
<div class="paragraph">
<p>This STS implementation class, SimpleSTS, is a POJO that extends from
SecurityTokenServiceProvider. Note that the class is defined with a
WebServiceProvider annotation and not a WebService annotation. This
annotation defines the service as a Provider-based endpoint, meaning it
supports a more messaging-oriented approach to Web services. In
particular, it signals that the exchanged messages will be XML documents
of some type. SecurityTokenServiceProvider is an implementation of the
javax.xml.ws.Provider interface. In comparison the WebService annotation
defines a (service endpoint interface) SEI-based endpoint which supports
message exchange via SOAP envelopes.</p>
</div>
<div class="paragraph">
<p>As was done in the ServiceImpl class, the WSS4J annotations
EndpointProperties and EndpointProperty are providing endpoint
configuration for the CXF runtime. This was previous described
<a href="#web-service-provider-implementation">here</a>.</p>
</div>
<div class="paragraph">
<p>The InInterceptors annotation is used to specify a JBossWS integration
interceptor to be used for authenticating incoming requests; JAAS
integration is used here for authentication, the username/passoword
coming from the UsernameToken in the ws-requester message are used for
authenticating the requester against a security domain on the
application server hosting the STS deployment.</p>
</div>
<div class="paragraph">
<p>In this implementation we are customizing the operations of token
issuance, token validation and their static properties.</p>
</div>
<div class="paragraph">
<p>StaticSTSProperties is used to set select properties for configuring
resources in the STS. You may think this is a duplication of the
settings made with the WSS4J annotations. The values are the same but
the underlaying structures being set are different, thus this
information must be declared in both places.</p>
</div>
<div class="paragraph">
<p>The setIssuer setting is important because it uniquely identifies the
issuing STS. The issuer string is embedded in issued tokens and, when
validating tokens, the STS checks the issuer string value. Consequently,
it is important to use the issuer string in a consistent way, so that
the STS can recognize the tokens that it has issued.</p>
</div>
<div class="paragraph">
<p>The setEndpoints call allows the declaration of a set of allowed token
recipients by address. The addresses are specified as reg-ex patterns.</p>
</div>
<div class="paragraph">
<p>TokenIssueOperation and TokenValidateOperation have a modular structure.
This allows custom behaviors to be injected into the processing of
messages. In this case we are overriding the
SecurityTokenServiceProvider&#8217;s default behavior and performing SAML
token processing and validation. CXF provides an implementation of a
SAMLTokenProvider and SAMLTokenValidator which we are using rather than
writing our own.</p>
</div>
<div class="paragraph">
<p>Learn more about the SAMLTokenProvider
<a href="http://coheigea.blogspot.it/2011/10/apache-cxf-sts-documentation-part-iv.html">here</a>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">package org.jboss.test.ws.jaxws.samples.wsse.policy.trust;

import java.util.Arrays;
import java.util.LinkedList;
import java.util.List;

import javax.xml.ws.WebServiceProvider;

import org.apache.cxf.annotations.EndpointProperties;
import org.apache.cxf.annotations.EndpointProperty;
import org.apache.cxf.interceptor.InInterceptors;
import org.apache.cxf.sts.StaticSTSProperties;
import org.apache.cxf.sts.operation.TokenIssueOperation;
import org.apache.cxf.sts.operation.TokenValidateOperation;
import org.apache.cxf.sts.service.ServiceMBean;
import org.apache.cxf.sts.service.StaticService;
import org.apache.cxf.sts.token.provider.SAMLTokenProvider;
import org.apache.cxf.sts.token.validator.SAMLTokenValidator;
import org.apache.cxf.ws.security.sts.provider.SecurityTokenServiceProvider;

@WebServiceProvider(serviceName = "SecurityTokenService",
      portName = "UT_Port",
      targetNamespace = "http://docs.oasis-open.org/ws-sx/ws-trust/200512/",
      wsdlLocation = "WEB-INF/wsdl/ws-trust-1.4-service.wsdl")
@EndpointProperties(value = {
      @EndpointProperty(key = "ws-security.signature.username", value = "mystskey"),
      @EndpointProperty(key = "ws-security.signature.properties", value = "stsKeystore.properties"),
      @EndpointProperty(key = "ws-security.callback-handler", value = "org.jboss.test.ws.jaxws.samples.wsse.policy.trust.STSCallbackHandler"),
      //to let the JAAS integration deal with validation through the interceptor below
      @EndpointProperty(key = "ws-security.validate.token", value = "false")

})
@InInterceptors(interceptors = {"org.jboss.wsf.stack.cxf.security.authentication.SubjectCreatingPolicyInterceptor"})
public class SampleSTS extends SecurityTokenServiceProvider
{
   public SampleSTS() throws Exception
   {
      super();

      StaticSTSProperties props = new StaticSTSProperties();
      props.setSignaturePropertiesFile("stsKeystore.properties");
      props.setSignatureUsername("mystskey");
      props.setCallbackHandlerClass(STSCallbackHandler.class.getName());
      props.setIssuer("DoubleItSTSIssuer");

      List&lt;ServiceMBean&gt; services = new LinkedList&lt;ServiceMBean&gt;();
      StaticService service = new StaticService();
      service.setEndpoints(Arrays.asList(
              "http://localhost:(\\d)*/jaxws-samples-wsse-policy-trust/SecurityService",
              "http://\\[::1\\]:(\\d)*/jaxws-samples-wsse-policy-trust/SecurityService",
              "http://\\[0:0:0:0:0:0:0:1\\]:(\\d)*/jaxws-samples-wsse-policy-trust/SecurityService"
              ));
      services.add(service);

      TokenIssueOperation issueOperation = new TokenIssueOperation();
      issueOperation.setServices(services);
      issueOperation.getTokenProviders().add(new SAMLTokenProvider());
      issueOperation.setStsProperties(props);

      TokenValidateOperation validateOperation = new TokenValidateOperation();
      validateOperation.getTokenValidators().add(new SAMLTokenValidator());
      validateOperation.setStsProperties(props);

      this.setIssueOperation(issueOperation);
      this.setValidateOperation(validateOperation);
   }
}</code></pre>
</div>
</div>
</div>
<div class="sect6">
<h7 id="stscallbackhandler"><a class="anchor" href="#stscallbackhandler"></a>STSCallbackHandler</h7>
<div class="paragraph">
<p>STSCallbackHandler is a callback handler for the WSS4J Crypto API. It is
used to obtain the password for the private key in the keystore. This
class enables CXF to retrieve the password of the user name to use for
the message signature.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">package org.jboss.test.ws.jaxws.samples.wsse.policy.trust.sts;

import java.util.HashMap;
import java.util.Map;

import org.jboss.wsf.stack.cxf.extensions.security.PasswordCallbackHandler;

public class STSCallbackHandler extends PasswordCallbackHandler
{
   public STSCallbackHandler()
   {
      super(getInitMap());
   }

   private static Map&lt;String, String&gt; getInitMap()
   {
      Map&lt;String, String&gt; passwords = new HashMap&lt;String, String&gt;();
      passwords.put("mystskey", "stskpass");
      return passwords;
   }
}</code></pre>
</div>
</div>
</div>
<div class="sect6">
<h7 id="crypto-properties-and-keystore-files-1"><a class="anchor" href="#crypto-properties-and-keystore-files-1"></a>Crypto properties and keystore files</h7>
<div class="paragraph">
<p>WSS4J&#8217;s Crypto implementation is loaded and configured via a Java
properties file that contains Crypto configuration data. The file
contains implementation-specific properties such as a keystore location,
password, default alias and the like. This application is using the
Merlin implementation. File stsKeystore.properties contains this
information.</p>
</div>
<div class="paragraph">
<p>File servicestore.jks, is a Java KeyStore (JKS) repository. It contains
self signed certificates for myservicekey and mystskey. <em>Self signed
certificates are not appropriate for production use.</em></p>
</div>
<div class="literalblock">
<div class="content">
<pre>org.apache.ws.security.crypto.provider=org.apache.ws.security.components.crypto.Merlin
org.apache.ws.security.crypto.merlin.keystore.type=jks
org.apache.ws.security.crypto.merlin.keystore.password=stsspass
org.apache.ws.security.crypto.merlin.keystore.file=stsstore.jks</pre>
</div>
</div>
</div>
<div class="sect6">
<h7 id="manifest-mf-ws-trust-1"><a class="anchor" href="#manifest-mf-ws-trust-1"></a>MANIFEST.MF</h7>
<div class="paragraph">
<p>When deployed on WildFly, this application requires access to the
JBossWs and CXF APIs provided in modules
org.jboss.ws.cxf.jbossws-cxf-client and org.apache.cxf. The Apache CXF
internals, org.apache.cxf.impl, are needed to build the STS
configuration in the <code>SampleSTS</code> constructor. The dependency statement
directs the server to provide them at deployment.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>Manifest-Version: 1.0
Ant-Version: Apache Ant 1.8.2
Created-By: 1.7.0_25-b15 (Oracle Corporation)
Dependencies: org.jboss.ws.cxf.jbossws-cxf-client,org.apache.cxf.impl</pre>
</div>
</div>
</div>
<div class="sect6">
<h7 id="security-domain-ws-trust"><a class="anchor" href="#security-domain-ws-trust"></a>Security Domain</h7>
<div class="paragraph">
<p>The STS requires a JBoss security domain be configured. The
jboss-web.xml descriptor declares a named security
domain,"JBossWS-trust-sts" to be used by this service for
authentication. This security domain requires two properties files and
the addition of a security-domain declaration in the JBoss server
configuration file.</p>
</div>
<div class="paragraph">
<p>For this scenario the domain needs to contain user <em>alice</em>, password
<em>clarinet</em>, and role <em>friend</em>. See the listings below for
jbossws-users.properties and jbossws-roles.properties. In addition the
following XML must be added to the JBoss security subsystem in the
server configuration file. Replace " <strong>SOME_PATH</strong>" with appropriate
information.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml"> &lt;security-domain name="JBossWS-trust-sts"&gt;
  &lt;authentication&gt;
    &lt;login-module code="UsersRoles" flag="required"&gt;
      &lt;module-option name="usersProperties" value="/SOME_PATH/jbossws-users.properties"/&gt;
      &lt;module-option name="unauthenticatedIdentity" value="anonymous"/&gt;
      &lt;module-option name="rolesProperties" value="/SOME_PATH/jbossws-roles.properties"/&gt;
    &lt;/login-module&gt;
  &lt;/authentication&gt;
&lt;/security-domain&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>jboss-web.xml</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;!DOCTYPE jboss-web PUBLIC "-//JBoss//DTD Web Application 2.4//EN" "&gt;
&lt;jboss-web&gt;
  &lt;security-domain&gt;java:/jaas/JBossWS-trust-sts&lt;/security-domain&gt;
&lt;/jboss-web&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>jbossws-users.properties</p>
</div>
<div class="literalblock">
<div class="content">
<pre># A sample users.properties file for use with the UsersRolesLoginModule
alice=clarinet</pre>
</div>
</div>
<div class="paragraph">
<p>jbossws-roles.properties</p>
</div>
<div class="literalblock">
<div class="content">
<pre># A sample roles.properties file for use with the UsersRolesLoginModule
alice=friend</pre>
</div>
</div>
<div class="paragraph">
<p>WS-MetadataExchange and interoperability</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
To achieve better interoperability, you might consider allowing the STS
endpoint to reply to WS-MetadataExchange messages directed to the <code>/mex</code>
URL sub-path (e.g.
<a href="http://localhost:8080/jaxws-samples-wsse-policy-trust-sts/SecurityTokenService/mex" class="bare">http://localhost:8080/jaxws-samples-wsse-policy-trust-sts/SecurityTokenService/mex</a>).
This can be done by tweaking the <em>url-pattern</em> for the underlying
endpoint servlet, for instance by adding a <em>web.xml</em> descriptor as
follows to the deployment:&lt;?xml version="1.0" encoding="UTF-8"?&gt;<br>
&lt;web-app<br>
version="2.5" xmlns="http://java.sun.com/xml/ns/javaee"<br>
xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"<br>
xsi:schemaLocation="http://java.sun.com/xml/ns/javaee
<a href="http://java.sun.com/xml/ns/javaee/web-app_2_5.xsd"&gt" class="bare">http://java.sun.com/xml/ns/javaee/web-app_2_5.xsd"&gt</a>;<br>
&lt;servlet&gt;<br>
&lt;servlet-name&gt;TestSecurityTokenService&lt;/servlet-name&gt;<br>
&lt;servlet-class&gt;org.jboss.test.ws.jaxws.samples.wsse.policy.trust.SampleSTS&lt;/servlet-class&gt;<br>
&lt;/servlet&gt;<br>
&lt;servlet-mapping&gt;<br>
&lt;servlet-name&gt;TestSecurityTokenService&lt;/servlet-name&gt;<br>
&lt;url-pattern&gt;/SecurityTokenService/*&lt;/url-pattern&gt;<br>
&lt;/servlet-mapping&gt;<br>
&lt;/web-app&gt;<br>
As a matter of fact, at the time of writing some webservices
implementations (including <em>Metro</em>) assume the <code>/mex</code> URL as the default
choice for directing WS-MetadataExchange requests to and use that to
retrieve STS wsdl contracts.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect5">
<h6 id="web-service-requester"><a class="anchor" href="#web-service-requester"></a>Web service requester</h6>
<div class="paragraph">
<p>This section examines the crucial elements in calling a web service that
implements endpoint security as described in the basic WS-Trust
scenario. The components that will be discussed are.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>web service requester&#8217;s implementation</p>
</li>
<li>
<p>ClientCallbackHandler</p>
</li>
<li>
<p>Crypto properties and keystore files</p>
</li>
</ul>
</div>
<div class="sect6">
<h7 id="web-service-requester-implementation"><a class="anchor" href="#web-service-requester-implementation"></a>Web service requester Implementation</h7>
<div class="paragraph">
<p>The ws-requester, the client, uses standard procedures for creating a
reference to the web service in the first four line. To address the
endpoint security requirements, the web service&#8217;s "Request Context" is
configured with the information needed in message generation. In
addition, the STSClient that communicates with the STS is configured
with similar values. Note the key strings ending with a ".it" suffix.
This suffix flags these settings as belonging to the STSClient. The
internal CXF code assigns this information to the STSClient that is
auto-generated for this service call.</p>
</div>
<div class="paragraph">
<p>There is an alternate method of setting up the STSCLient. The user may
provide their own instance of the STSClient. The CXF code will use this
object and not auto-generate one. This is used in the ActAs and
OnBehalfOf examples. When providing the STSClient in this way, the user
must provide a org.apache.cxf.Bus for it and the configuration keys must
not have the ".it" suffix.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">QName serviceName = new QName("http://www.jboss.org/jbossws/ws-extensions/wssecuritypolicy", "SecurityService");
URL wsdlURL = new URL(serviceURL + "?wsdl");
Service service = Service.create(wsdlURL, serviceName);
ServiceIface proxy = (ServiceIface) service.getPort(ServiceIface.class);

// set the security related configuration information for the service "request"
Map&lt;String, Object&gt; ctx = ((BindingProvider) proxy).getRequestContext();
ctx.put(SecurityConstants.CALLBACK_HANDLER, new ClientCallbackHandler());
ctx.put(SecurityConstants.SIGNATURE_PROPERTIES,
   Thread.currentThread().getContextClassLoader().getResource(
   "META-INF/clientKeystore.properties"));
ctx.put(SecurityConstants.ENCRYPT_PROPERTIES,
   Thread.currentThread().getContextClassLoader().getResource(
   "META-INF/clientKeystore.properties"));
ctx.put(SecurityConstants.SIGNATURE_USERNAME, "myclientkey");
ctx.put(SecurityConstants.ENCRYPT_USERNAME, "myservicekey");


//-- Configuration settings that will be transfered to the STSClient
// "alice" is the name provided for the WSS Username. Her password will
// be retreived from the ClientCallbackHander by the STSClient.
ctx.put(SecurityConstants.USERNAME + ".it", "alice");
ctx.put(SecurityConstants.CALLBACK_HANDLER + ".it", new ClientCallbackHandler());
ctx.put(SecurityConstants.ENCRYPT_PROPERTIES + ".it",
   Thread.currentThread().getContextClassLoader().getResource(
   "META-INF/clientKeystore.properties"));
ctx.put(SecurityConstants.ENCRYPT_USERNAME + ".it", "mystskey");
// alias name in the keystore to get the user's public key to send to the STS
ctx.put(SecurityConstants.STS_TOKEN_USERNAME + ".it", "myclientkey");
// Crypto property configuration to use for the STS
ctx.put(SecurityConstants.STS_TOKEN_PROPERTIES + ".it",
   Thread.currentThread().getContextClassLoader().getResource(
   "META-INF/clientKeystore.properties"));
// write out an X509Certificate structure in UseKey/KeyInfo
ctx.put(SecurityConstants.STS_TOKEN_USE_CERT_FOR_KEYINFO + ".it", "true");
// Setting indicates the  STSclient should not try using the WS-MetadataExchange
// call using STS EPR WSA address when the endpoint contract does not contain
// WS-MetadataExchange info.
ctx.put("ws-security.sts.disable-wsmex-call-using-epr-address", "true");

proxy.sayHello();</code></pre>
</div>
</div>
</div>
<div class="sect6">
<h7 id="clientcallbackhandler"><a class="anchor" href="#clientcallbackhandler"></a>ClientCallbackHandler</h7>
<div class="paragraph">
<p>ClientCallbackHandler is a callback handler for the WSS4J Crypto API. It
is used to obtain the password for the private key in the keystore. This
class enables CXF to retrieve the password of the user name to use for
the message signature. Note that "alice" and her password have been
provided here. This information is not in the (JKS) keystore but
provided in the WildFly security domain. It was declared in file
jbossws-users.properties.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">package org.jboss.test.ws.jaxws.samples.wsse.policy.trust.shared;

import java.io.IOException;
import javax.security.auth.callback.Callback;
import javax.security.auth.callback.CallbackHandler;
import javax.security.auth.callback.UnsupportedCallbackException;
import org.apache.ws.security.WSPasswordCallback;

public class ClientCallbackHandler implements CallbackHandler {

    public void handle(Callback[] callbacks) throws IOException,
            UnsupportedCallbackException {
        for (int i = 0; i &lt; callbacks.length; i++) {
            if (callbacks[i] instanceof WSPasswordCallback) {
                WSPasswordCallback pc = (WSPasswordCallback) callbacks[i];
                if ("myclientkey".equals(pc.getIdentifier())) {
                    pc.setPassword("ckpass");
                    break;
                } else if ("alice".equals(pc.getIdentifier())) {
                    pc.setPassword("clarinet");
                    break;
                }
            }
        }
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect6">
<h7 id="requester-crypto-properties-and-keystore-files"><a class="anchor" href="#requester-crypto-properties-and-keystore-files"></a>Requester Crypto properties and keystore files</h7>
<div class="paragraph">
<p>WSS4J&#8217;s Crypto implementation is loaded and configured via a Java
properties file that contains Crypto configuration data. The file
contains implementation-specific properties such as a keystore location,
password, default alias and the like. This application is using the
Merlin implementation. File clientKeystore.properties contains this
information.</p>
</div>
<div class="paragraph">
<p>File clientstore.jks, is a Java KeyStore (JKS) repository. It contains
self signed certificates for myservicekey and mystskey. <em>Self signed
certificates are not appropriate for production use.</em></p>
</div>
<div class="literalblock">
<div class="content">
<pre>org.apache.ws.security.crypto.provider=org.apache.ws.security.components.crypto.Merlin
org.apache.ws.security.crypto.merlin.keystore.type=jks
org.apache.ws.security.crypto.merlin.keystore.password=cspass
org.apache.ws.security.crypto.merlin.keystore.alias=myclientkey
org.apache.ws.security.crypto.merlin.keystore.file=META-INF/clientstore.jks</pre>
</div>
</div>
</div>
</div>
<div class="sect5">
<h6 id="picketlink-sts"><a class="anchor" href="#picketlink-sts"></a>PicketLink STS</h6>
<div class="paragraph">
<p><a href="http://www.jboss.org/picketlink">PicketLink</a> provides facilities for
building up an alternative to the Apache CXF Security Token Service
implementation.</p>
</div>
<div class="paragraph">
<p>Similarly to the previous implementation, the STS is served through a
WebServiceProvider annotated POJO:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java"> package org.jboss.test.ws.jaxws.samples.wsse.policy.trust;

import javax.annotation.Resource;
import javax.xml.ws.Service;
import javax.xml.ws.ServiceMode;
import javax.xml.ws.WebServiceContext;
import javax.xml.ws.WebServiceProvider;

import org.apache.cxf.annotations.EndpointProperties;
import org.apache.cxf.annotations.EndpointProperty;
import org.apache.cxf.interceptor.InInterceptors;
import org.picketlink.identity.federation.core.wstrust.PicketLinkSTS;

@WebServiceProvider(serviceName = "PicketLinkSTS", portName = "PicketLinkSTSPort", targetNamespace = "urn:picketlink:identity-federation:sts", wsdlLocation = "WEB-INF/wsdl/PicketLinkSTS.wsdl")
@ServiceMode(value = Service.Mode.MESSAGE)
//be sure to have dependency on org.apache.cxf module when on AS7, otherwise Apache CXF annotations are ignored
@EndpointProperties(value = {
@EndpointProperty(key = "ws-security.signature.username", value = "mystskey"),
@EndpointProperty(key = "ws-security.signature.properties", value = "stsKeystore.properties"),
@EndpointProperty(key = "ws-security.callback-handler", value = "org.jboss.test.ws.jaxws.samples.wsse.policy.trust.STSCallbackHandler"),
@EndpointProperty(key = "ws-security.validate.token", value = "false") //to let the JAAS integration deal with validation through the interceptor below
})
@InInterceptors(interceptors =

)
public class PicketLinkSTService extends PicketLinkSTS {
@Resource
public void setWSC(WebServiceContext wctx)
Unknown macro: { this.context = wctx; }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>@WebServiceProvider</code> annotation references the following WS-Policy
enabled wsdl contract; please note the wsdl operations, messages and
such must match the <code>PicketLinkSTS</code> implementation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;?xml version="1.0"?&gt;
&lt;wsdl:definitions name="PicketLinkSTS" targetNamespace="urn:picketlink:identity-federation:sts"
    xmlns:tns="urn:picketlink:identity-federation:sts"
    xmlns:xsd="http://www.w3.org/2001/XMLSchema"
    xmlns:wsdl="http://schemas.xmlsoap.org/wsdl/"
    xmlns:wsap10="http://www.w3.org/2006/05/addressing/wsdl"
    xmlns:wsp="http://www.w3.org/ns/ws-policy"
    xmlns:wsu="http://docs.oasis-open.org/wss/2004/01/oasis-200401-wss-wssecurity-utility-1.0.xsd"
    xmlns:wst="http://docs.oasis-open.org/ws-sx/ws-trust/200512"
    xmlns:soap12="http://schemas.xmlsoap.org/wsdl/soap12/"&gt;
  &lt;wsdl:types&gt;
    &lt;xs:schema elementFormDefault="qualified" targetNamespace='http://docs.oasis-open.org/ws-sx/ws-trust/200512' xmlns:xs="http://www.w3.org/2001/XMLSchema"&gt;
      &lt;xs:element name='RequestSecurityToken' type='wst:AbstractRequestSecurityTokenType' /&gt;
      &lt;xs:element name='RequestSecurityTokenResponse' type='wst:AbstractRequestSecurityTokenType' /&gt;
      &lt;xs:complexType name='AbstractRequestSecurityTokenType' &gt;
        &lt;xs:sequence&gt;
          &lt;xs:any namespace='##any' processContents='lax' minOccurs='0' maxOccurs='unbounded' /&gt;
        &lt;/xs:sequence&gt;
        &lt;xs:attribute name='Context' type='xs:anyURI' use='optional' /&gt;
        &lt;xs:anyAttribute namespace='##other' processContents='lax' /&gt;
      &lt;/xs:complexType&gt;
      &lt;xs:element name='RequestSecurityTokenCollection' type='wst:RequestSecurityTokenCollectionType' /&gt;
      &lt;xs:complexType name='RequestSecurityTokenCollectionType' &gt;
        &lt;xs:sequence&gt;
          &lt;xs:element name='RequestSecurityToken' type='wst:AbstractRequestSecurityTokenType' minOccurs='2' maxOccurs='unbounded'/&gt;
        &lt;/xs:sequence&gt;
      &lt;/xs:complexType&gt;
      &lt;xs:element name='RequestSecurityTokenResponseCollection' type='wst:RequestSecurityTokenResponseCollectionType' /&gt;
      &lt;xs:complexType name='RequestSecurityTokenResponseCollectionType' &gt;
        &lt;xs:sequence&gt;
          &lt;xs:element ref='wst:RequestSecurityTokenResponse' minOccurs='1' maxOccurs='unbounded' /&gt;
        &lt;/xs:sequence&gt;
        &lt;xs:anyAttribute namespace='##other' processContents='lax' /&gt;
      &lt;/xs:complexType&gt;
    &lt;/xs:schema&gt;
  &lt;/wsdl:types&gt;

  &lt;wsdl:message name="RequestSecurityTokenMsg"&gt;
    &lt;wsdl:part name="request" element="wst:RequestSecurityToken" /&gt;
  &lt;/wsdl:message&gt;
  &lt;wsdl:message name="RequestSecurityTokenResponseCollectionMsg"&gt;
    &lt;wsdl:part name="responseCollection"
            element="wst:RequestSecurityTokenResponseCollection"/&gt;
  &lt;/wsdl:message&gt;

  &lt;wsdl:portType name="SecureTokenService"&gt;
    &lt;wsdl:operation name="IssueToken"&gt;
      &lt;wsdl:input wsap10:Action="http://docs.oasis-open.org/ws-sx/ws-trust/200512/RST/Issue" message="tns:RequestSecurityTokenMsg"/&gt;
      &lt;wsdl:output wsap10:Action="http://docs.oasis-open.org/ws-sx/ws-trust/200512/RSTRC/IssueFinal" message="tns:RequestSecurityTokenResponseCollectionMsg"/&gt;
    &lt;/wsdl:operation&gt;
  &lt;/wsdl:portType&gt;
  &lt;wsdl:binding name="STSBinding" type="tns:SecureTokenService"&gt;
    &lt;wsp:PolicyReference URI="#UT_policy" /&gt;
    &lt;soap12:binding transport="http://schemas.xmlsoap.org/soap/http"/&gt;
    &lt;wsdl:operation name="IssueToken"&gt;
      &lt;soap12:operation soapAction="http://docs.oasis-open.org/ws-sx/ws-trust/200512/RST/Issue" style="document"/&gt;
      &lt;wsdl:input&gt;
        &lt;wsp:PolicyReference URI="#Input_policy" /&gt;
        &lt;soap12:body use="literal"/&gt;
      &lt;/wsdl:input&gt;
      &lt;wsdl:output&gt;
        &lt;wsp:PolicyReference URI="#Output_policy" /&gt;
        &lt;soap12:body use="literal"/&gt;
      &lt;/wsdl:output&gt;
    &lt;/wsdl:operation&gt;
  &lt;/wsdl:binding&gt;
  &lt;wsdl:service name="PicketLinkSTS"&gt;
    &lt;wsdl:port name="PicketLinkSTSPort" binding="tns:STSBinding"&gt;
      &lt;soap12:address location="http://localhost:8080/picketlink-sts/PicketLinkSTS"/&gt;
    &lt;/wsdl:port&gt;
  &lt;/wsdl:service&gt;

  &lt;wsp:Policy wsu:Id="UT_policy"&gt;
      &lt;wsp:ExactlyOne&gt;
         &lt;wsp:All&gt;
            &lt;wsap10:UsingAddressing/&gt;
            &lt;sp:SymmetricBinding
               xmlns:sp="http://docs.oasis-open.org/ws-sx/ws-securitypolicy/200702"&gt;
               &lt;wsp:Policy&gt;
                  &lt;sp:ProtectionToken&gt;
                     &lt;wsp:Policy&gt;
                        &lt;sp:X509Token
                           sp:IncludeToken="http://docs.oasis-open.org/ws-sx/ws-securitypolicy/200702/IncludeToken/Never"&gt;
                           &lt;wsp:Policy&gt;
                              &lt;sp:RequireDerivedKeys /&gt;
                              &lt;sp:RequireThumbprintReference /&gt;
                              &lt;sp:WssX509V3Token10 /&gt;
                           &lt;/wsp:Policy&gt;
                        &lt;/sp:X509Token&gt;
                     &lt;/wsp:Policy&gt;
                  &lt;/sp:ProtectionToken&gt;
                  &lt;sp:AlgorithmSuite&gt;
                     &lt;wsp:Policy&gt;
                        &lt;sp:Basic256 /&gt;
                     &lt;/wsp:Policy&gt;
                  &lt;/sp:AlgorithmSuite&gt;
                  &lt;sp:Layout&gt;
                     &lt;wsp:Policy&gt;
                        &lt;sp:Lax /&gt;
                     &lt;/wsp:Policy&gt;
                  &lt;/sp:Layout&gt;
                  &lt;sp:IncludeTimestamp /&gt;
                  &lt;sp:EncryptSignature /&gt;
                  &lt;sp:OnlySignEntireHeadersAndBody /&gt;
               &lt;/wsp:Policy&gt;
            &lt;/sp:SymmetricBinding&gt;
            &lt;sp:SignedSupportingTokens
               xmlns:sp="http://docs.oasis-open.org/ws-sx/ws-securitypolicy/200702"&gt;
               &lt;wsp:Policy&gt;
                  &lt;sp:UsernameToken
                     sp:IncludeToken="http://docs.oasis-open.org/ws-sx/ws-securitypolicy/200702/IncludeToken/AlwaysToRecipient"&gt;
                     &lt;wsp:Policy&gt;
                        &lt;sp:WssUsernameToken10 /&gt;
                     &lt;/wsp:Policy&gt;
                  &lt;/sp:UsernameToken&gt;
               &lt;/wsp:Policy&gt;
            &lt;/sp:SignedSupportingTokens&gt;
            &lt;sp:Wss11
               xmlns:sp="http://docs.oasis-open.org/ws-sx/ws-securitypolicy/200702"&gt;
               &lt;wsp:Policy&gt;
                  &lt;sp:MustSupportRefKeyIdentifier /&gt;
                  &lt;sp:MustSupportRefIssuerSerial /&gt;
                  &lt;sp:MustSupportRefThumbprint /&gt;
                  &lt;sp:MustSupportRefEncryptedKey /&gt;
               &lt;/wsp:Policy&gt;
            &lt;/sp:Wss11&gt;
            &lt;sp:Trust13
               xmlns:sp="http://docs.oasis-open.org/ws-sx/ws-securitypolicy/200702"&gt;
               &lt;wsp:Policy&gt;
                  &lt;sp:MustSupportIssuedTokens /&gt;
                  &lt;sp:RequireClientEntropy /&gt;
                  &lt;sp:RequireServerEntropy /&gt;
               &lt;/wsp:Policy&gt;
            &lt;/sp:Trust13&gt;
         &lt;/wsp:All&gt;
      &lt;/wsp:ExactlyOne&gt;
   &lt;/wsp:Policy&gt;

   &lt;wsp:Policy wsu:Id="Input_policy"&gt;
      &lt;wsp:ExactlyOne&gt;
         &lt;wsp:All&gt;
            &lt;sp:SignedParts
               xmlns:sp="http://docs.oasis-open.org/ws-sx/ws-securitypolicy/200702"&gt;
               &lt;sp:Body /&gt;
               &lt;sp:Header Name="To"
                  Namespace="http://www.w3.org/2005/08/addressing" /&gt;
               &lt;sp:Header Name="From"
                  Namespace="http://www.w3.org/2005/08/addressing" /&gt;
               &lt;sp:Header Name="FaultTo"
                  Namespace="http://www.w3.org/2005/08/addressing" /&gt;
               &lt;sp:Header Name="ReplyTo"
                  Namespace="http://www.w3.org/2005/08/addressing" /&gt;
               &lt;sp:Header Name="MessageID"
                  Namespace="http://www.w3.org/2005/08/addressing" /&gt;
               &lt;sp:Header Name="RelatesTo"
                  Namespace="http://www.w3.org/2005/08/addressing" /&gt;
               &lt;sp:Header Name="Action"
                  Namespace="http://www.w3.org/2005/08/addressing" /&gt;
            &lt;/sp:SignedParts&gt;
            &lt;sp:EncryptedParts
               xmlns:sp="http://docs.oasis-open.org/ws-sx/ws-securitypolicy/200702"&gt;
               &lt;sp:Body /&gt;
            &lt;/sp:EncryptedParts&gt;
         &lt;/wsp:All&gt;
      &lt;/wsp:ExactlyOne&gt;
   &lt;/wsp:Policy&gt;

   &lt;wsp:Policy wsu:Id="Output_policy"&gt;
      &lt;wsp:ExactlyOne&gt;
         &lt;wsp:All&gt;
            &lt;sp:SignedParts
               xmlns:sp="http://docs.oasis-open.org/ws-sx/ws-securitypolicy/200702"&gt;
               &lt;sp:Body /&gt;
               &lt;sp:Header Name="To"
                  Namespace="http://www.w3.org/2005/08/addressing" /&gt;
               &lt;sp:Header Name="From"
                  Namespace="http://www.w3.org/2005/08/addressing" /&gt;
               &lt;sp:Header Name="FaultTo"
                  Namespace="http://www.w3.org/2005/08/addressing" /&gt;
               &lt;sp:Header Name="ReplyTo"
                  Namespace="http://www.w3.org/2005/08/addressing" /&gt;
               &lt;sp:Header Name="MessageID"
                  Namespace="http://www.w3.org/2005/08/addressing" /&gt;
               &lt;sp:Header Name="RelatesTo"
                  Namespace="http://www.w3.org/2005/08/addressing" /&gt;
               &lt;sp:Header Name="Action"
                  Namespace="http://www.w3.org/2005/08/addressing" /&gt;
            &lt;/sp:SignedParts&gt;
            &lt;sp:EncryptedParts
               xmlns:sp="http://docs.oasis-open.org/ws-sx/ws-securitypolicy/200702"&gt;
               &lt;sp:Body /&gt;
            &lt;/sp:EncryptedParts&gt;
         &lt;/wsp:All&gt;
      &lt;/wsp:ExactlyOne&gt;
   &lt;/wsp:Policy&gt;

&lt;/wsdl:definitions&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Differently from the Apache CXF STS example described above, the
PicketLink based STS gets its configuration from a picketlink-sts.xml
descriptor which must be added in WEB-INF into the deployment; please
refer to the PicketLink documentation for further information:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;PicketLinkSTS xmlns="urn:picketlink:identity-federation:config:1.0"
    STSName="PicketLinkSTS" TokenTimeout="7200" EncryptToken="false"&gt;
    &lt;KeyProvider ClassName="org.picketlink.identity.federation.core.impl.KeyStoreKeyManager"&gt;
        &lt;Auth Key="KeyStoreURL" Value="stsstore.jks"/&gt;
        &lt;Auth Key="KeyStorePass" Value="stsspass"/&gt;
        &lt;Auth Key="SigningKeyAlias" Value="mystskey"/&gt;
        &lt;Auth Key="SigningKeyPass" Value="stskpass"/&gt;
        &lt;ValidatingAlias Key="http://localhost:8080/jaxws-samples-wsse-policy-trust/SecurityService" Value="myservicekey"/&gt;
    &lt;/KeyProvider&gt;
    &lt;TokenProviders&gt;
            &lt;TokenProvider ProviderClass="org.picketlink.identity.federation.core.wstrust.plugins.saml.SAML11TokenProvider"
                TokenType="http://docs.oasis-open.org/wss/oasis-wss-saml-token-profile-1.1#SAMLV1.1"
            TokenElement="Assertion"
            TokenElementNS="urn:oasis:names:tc:SAML:1.0:assertion"/&gt;
            &lt;TokenProvider ProviderClass="org.picketlink.identity.federation.core.wstrust.plugins.saml.SAML20TokenProvider"
                TokenType="http://docs.oasis-open.org/wss/oasis-wss-saml-token-profile-1.1#SAMLV2.0"
            TokenElement="Assertion"
            TokenElementNS="urn:oasis:names:tc:SAML:2.0:assertion"/&gt;
    &lt;/TokenProviders&gt;
&lt;/PicketLinkSTS&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Finally, the PicketLink alternative approach of course requires
different WildFly module dependencies to be declared in the MANIFEST.MF:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>Manifest-Version: 1.0
Ant-Version: Apache Ant 1.8.2
Created-By: 1.6.0_26-b03 (Sun Microsystems Inc.)
Dependencies: org.apache.ws.security,org.apache.cxf,org.picketlink</pre>
</div>
</div>
<div class="paragraph">
<p>Here is how the PicketLink STS endpoint is packaged:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>alessio@inuyasha /dati/jbossws/stack/cxf/trunk $ jar -tvf ./modules/testsuite/cxf-tests/target/test-libs/jaxws-samples-wsse-policy-trustPicketLink-sts.war
     0 Mon Sep 03 17:38:38 CEST 2012 META-INF/
   174 Mon Sep 03 17:38:36 CEST 2012 META-INF/MANIFEST.MF
     0 Mon Sep 03 17:38:38 CEST 2012 WEB-INF/
     0 Mon Sep 03 17:38:38 CEST 2012 WEB-INF/classes/
     0 Mon Sep 03 16:35:50 CEST 2012 WEB-INF/classes/org/
     0 Mon Sep 03 16:35:50 CEST 2012 WEB-INF/classes/org/jboss/
     0 Mon Sep 03 16:35:50 CEST 2012 WEB-INF/classes/org/jboss/test/
     0 Mon Sep 03 16:35:52 CEST 2012 WEB-INF/classes/org/jboss/test/ws/
     0 Mon Sep 03 16:35:50 CEST 2012 WEB-INF/classes/org/jboss/test/ws/jaxws/
     0 Mon Sep 03 16:35:52 CEST 2012 WEB-INF/classes/org/jboss/test/ws/jaxws/samples/
     0 Mon Sep 03 16:35:50 CEST 2012 WEB-INF/classes/org/jboss/test/ws/jaxws/samples/wsse/
     0 Mon Sep 03 16:35:50 CEST 2012 WEB-INF/classes/org/jboss/test/ws/jaxws/samples/wsse/policy/
     0 Mon Sep 03 16:35:52 CEST 2012 WEB-INF/classes/org/jboss/test/ws/jaxws/samples/wsse/policy/trust/
  1686 Mon Sep 03 16:35:50 CEST 2012 WEB-INF/classes/org/jboss/test/ws/jaxws/samples/wsse/policy/trust/PicketLinkSTService.class
  1148 Mon Sep 03 16:35:52 CEST 2012 WEB-INF/classes/org/jboss/test/ws/jaxws/samples/wsse/policy/trust/STSCallbackHandler.class
   251 Mon Sep 03 17:38:34 CEST 2012 WEB-INF/jboss-web.xml
     0 Mon Sep 03 16:35:50 CEST 2012 WEB-INF/wsdl/
  9070 Mon Sep 03 17:38:34 CEST 2012 WEB-INF/wsdl/PicketLinkSTS.wsdl
  1267 Mon Sep 03 17:38:34 CEST 2012 WEB-INF/classes/picketlink-sts.xml
  1054 Mon Sep 03 16:35:50 CEST 2012 WEB-INF/classes/stsKeystore.properties
  3978 Mon Sep 03 16:35:50 CEST 2012 WEB-INF/classes/stsstore.jks</code></pre>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="ActAs_WS-Trust_Scenario"><a class="anchor" href="#ActAs_WS-Trust_Scenario"></a>ActAs WS-Trust Scenario</h5>
<div class="paragraph">
<p>The ActAs feature is used in scenarios that require composite
delegation. It is commonly used in multi-tiered systems where an
application calls a service on behalf of a logged in user or a service
calls another service on behalf of the original caller.</p>
</div>
<div class="paragraph">
<p>ActAs is nothing more than a new sub-element in the RequestSecurityToken
(RST). It provides additional information about the original caller when
a token is negotiated with the STS. The ActAs element usually takes the
form of a token with identity claims such as name, role, and
authorization code, for the client to access the service.</p>
</div>
<div class="paragraph">
<p>The ActAs scenario is an extension of
<a href="#ActAs_WS-Trust_Scenario">the basic
WS-Trust scenario</a>. In this example the ActAs service calls the
ws-service on behalf of a user. There are only a couple of additions to
the basic scenario&#8217;s code. An ActAs web service provider and callback
handler have been added. The ActAs web services' WSDL imposes the same
security policies as the ws-provider. UsernameTokenCallbackHandler is
new. It is a utility that generates the content for the ActAs element.
And lastly there are a couple of code additions in the STS to support
the ActAs request.</p>
</div>
<div class="sect5">
<h6 id="web-service-provider-2"><a class="anchor" href="#web-service-provider-2"></a>Web service provider</h6>
<div class="paragraph">
<p>This section examines the web service elements from the basic WS-Trust
scenario that have been changed to address the needs of the ActAs
example. The components are</p>
</div>
<div class="ulist">
<ul>
<li>
<p>ActAs web service provider&#8217;s WSDL</p>
</li>
<li>
<p>ActAs web service provider&#8217;s Interface and Implementation classes.</p>
</li>
<li>
<p>ActAsCallbackHandler class</p>
</li>
<li>
<p>UsernameTokenCallbackHandler</p>
</li>
<li>
<p>Crypto properties and keystore files</p>
</li>
<li>
<p>MANIFEST.MF</p>
</li>
</ul>
</div>
<div class="sect6">
<h7 id="web-service-provider-wsdl-2"><a class="anchor" href="#web-service-provider-wsdl-2"></a>Web service provider WSDL</h7>
<div class="paragraph">
<p>The ActAs web service provider&#8217;s WSDL is a clone of the ws-provider&#8217;s
WSDL. The wsp:Policy section is the same. There are changes to the
service endpoint, targetNamespace, portType, binding name, and service.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;?xml version="1.0" encoding="UTF-8" standalone="yes"?&gt;
&lt;definitions targetNamespace="http://www.jboss.org/jbossws/ws-extensions/actaswssecuritypolicy" name="ActAsService"
             xmlns:tns="http://www.jboss.org/jbossws/ws-extensions/actaswssecuritypolicy"
             xmlns:xsd="http://www.w3.org/2001/XMLSchema"
             xmlns:soap="http://schemas.xmlsoap.org/wsdl/soap/"
             xmlns="http://schemas.xmlsoap.org/wsdl/"
             xmlns:wsp="http://www.w3.org/ns/ws-policy"
             xmlns:wsam="http://www.w3.org/2007/05/addressing/metadata"
             xmlns:wsu="http://docs.oasis-open.org/wss/2004/01/oasis-200401-wss-wssecurity-utility-1.0.xsd"
             xmlns:wsaws="http://www.w3.org/2005/08/addressing"
             xmlns:sp="http://docs.oasis-open.org/ws-sx/ws-securitypolicy/200702"
             xmlns:t="http://docs.oasis-open.org/ws-sx/ws-trust/200512"&gt;
    &lt;types&gt;
        &lt;xsd:schema&gt;
            &lt;xsd:import namespace="http://www.jboss.org/jbossws/ws-extensions/actaswssecuritypolicy"
                    schemaLocation="ActAsService_schema1.xsd"/&gt;
        &lt;/xsd:schema&gt;
    &lt;/types&gt;
    &lt;message name="sayHello"&gt;
        &lt;part name="parameters" element="tns:sayHello"/&gt;
    &lt;/message&gt;
    &lt;message name="sayHelloResponse"&gt;
        &lt;part name="parameters" element="tns:sayHelloResponse"/&gt;
    &lt;/message&gt;
    &lt;portType name="ActAsServiceIface"&gt;
        &lt;operation name="sayHello"&gt;
            &lt;input message="tns:sayHello"/&gt;
            &lt;output message="tns:sayHelloResponse"/&gt;
        &lt;/operation&gt;
    &lt;/portType&gt;
    &lt;binding name="ActAsServicePortBinding" type="tns:ActAsServiceIface"&gt;
        &lt;wsp:PolicyReference URI="#AsymmetricSAML2Policy" /&gt;
        &lt;soap:binding transport="http://schemas.xmlsoap.org/soap/http" style="document"/&gt;
        &lt;operation name="sayHello"&gt;
            &lt;soap:operation soapAction=""/&gt;
            &lt;input&gt;
                &lt;soap:body use="literal"/&gt;
                &lt;wsp:PolicyReference URI="#Input_Policy" /&gt;
            &lt;/input&gt;
            &lt;output&gt;
                &lt;soap:body use="literal"/&gt;
                &lt;wsp:PolicyReference URI="#Output_Policy" /&gt;
            &lt;/output&gt;
        &lt;/operation&gt;
    &lt;/binding&gt;
    &lt;service name="ActAsService"&gt;
        &lt;port name="ActAsServicePort" binding="tns:ActAsServicePortBinding"&gt;
            &lt;soap:address location="http://@jboss.bind.address@:8080/jaxws-samples-wsse-policy-trust-actas/ActAsService"/&gt;
        &lt;/port&gt;
    &lt;/service&gt;

&lt;/definitions&gt;</code></pre>
</div>
</div>
</div>
<div class="sect6">
<h7 id="web-service-interface-actas-ws-trust"><a class="anchor" href="#web-service-interface-actas-ws-trust"></a>Web Service Interface</h7>
<div class="paragraph">
<p>The web service provider interface class, ActAsServiceIface, is a simple
web service definition.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">package org.jboss.test.ws.jaxws.samples.wsse.policy.trust.actas;

import javax.jws.WebMethod;
import javax.jws.WebService;

@WebService
(
   targetNamespace = "http://www.jboss.org/jbossws/ws-extensions/actaswssecuritypolicy"
)
public interface ActAsServiceIface
{
   @WebMethod
   String sayHello();
}</code></pre>
</div>
</div>
</div>
<div class="sect6">
<h7 id="web-service-implementation-actas-ws-trust"><a class="anchor" href="#web-service-implementation-actas-ws-trust"></a>Web Service Implementation</h7>
<div class="paragraph">
<p>The web service provider implementation class, ActAsServiceImpl, is a
simple POJO. It uses the standard WebService annotation to define the
service endpoint and two Apache WSS4J annotations, EndpointProperties
and EndpointProperty used for configuring the endpoint for the CXF
runtime. The WSS4J configuration information provided is for WSS4J&#8217;s
Crypto Merlin implementation.</p>
</div>
<div class="paragraph">
<p>ActAsServiceImpl is calling ServiceImpl acting on behalf of the user.
Method setupService performs the requisite configuration setup.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">package org.jboss.test.ws.jaxws.samples.wsse.policy.trust.actas;

import org.apache.cxf.Bus;
import org.apache.cxf.BusFactory;
import org.apache.cxf.annotations.EndpointProperties;
import org.apache.cxf.annotations.EndpointProperty;
import org.apache.cxf.ws.security.SecurityConstants;
import org.apache.cxf.ws.security.trust.STSClient;
import org.jboss.test.ws.jaxws.samples.wsse.policy.trust.service.ServiceIface;
import org.jboss.test.ws.jaxws.samples.wsse.policy.trust.shared.WSTrustAppUtils;

import javax.jws.WebService;
import javax.xml.namespace.QName;
import javax.xml.ws.BindingProvider;
import javax.xml.ws.Service;
import java.net.MalformedURLException;
import java.net.URL;
import java.util.Map;

@WebService
(
   portName = "ActAsServicePort",
   serviceName = "ActAsService",
   wsdlLocation = "WEB-INF/wsdl/ActAsService.wsdl",
   targetNamespace = "http://www.jboss.org/jbossws/ws-extensions/actaswssecuritypolicy",
   endpointInterface = "org.jboss.test.ws.jaxws.samples.wsse.policy.trust.actas.ActAsServiceIface"
)

@EndpointProperties(value = {
      @EndpointProperty(key = "ws-security.signature.username", value = "myactaskey"),
      @EndpointProperty(key = "ws-security.signature.properties", value =  "actasKeystore.properties"),
      @EndpointProperty(key = "ws-security.encryption.properties", value = "actasKeystore.properties"),
      @EndpointProperty(key = "ws-security.callback-handler", value = "org.jboss.test.ws.jaxws.samples.wsse.policy.trust.actas.ActAsCallbackHandler")
})

public class ActAsServiceImpl implements ActAsServiceIface
{
   public String sayHello() {
      try {
         ServiceIface proxy = setupService();
         return "ActAs " + proxy.sayHello();
      } catch (MalformedURLException e) {
         e.printStackTrace();
      }
      return null;
   }

   private  ServiceIface setupService()throws MalformedURLException {
      ServiceIface proxy = null;
      Bus bus = BusFactory.newInstance().createBus();

      try {
         BusFactory.setThreadDefaultBus(bus);

         final String serviceURL = "http://" + WSTrustAppUtils.getServerHost() + ":8080/jaxws-samples-wsse-policy-trust/SecurityService";
         final QName serviceName = new QName("http://www.jboss.org/jbossws/ws-extensions/wssecuritypolicy", "SecurityService");
         final URL wsdlURL = new URL(serviceURL + "?wsdl");
         Service service = Service.create(wsdlURL, serviceName);
         proxy = (ServiceIface) service.getPort(ServiceIface.class);

         Map&lt;String, Object&gt; ctx = ((BindingProvider) proxy).getRequestContext();
         ctx.put(SecurityConstants.CALLBACK_HANDLER, new ActAsCallbackHandler());

         ctx.put(SecurityConstants.SIGNATURE_PROPERTIES,
            Thread.currentThread().getContextClassLoader().getResource("actasKeystore.properties" ));
         ctx.put(SecurityConstants.SIGNATURE_USERNAME, "myactaskey" );
         ctx.put(SecurityConstants.ENCRYPT_PROPERTIES,
            Thread.currentThread().getContextClassLoader().getResource("../../META-INF/clientKeystore.properties" ));
         ctx.put(SecurityConstants.ENCRYPT_USERNAME, "myservicekey");

         STSClient stsClient = new STSClient(bus);
         Map&lt;String, Object&gt; props = stsClient.getProperties();
         props.put(SecurityConstants.USERNAME, "alice");
         props.put(SecurityConstants.ENCRYPT_USERNAME, "mystskey");
         props.put(SecurityConstants.STS_TOKEN_USERNAME, "myactaskey" );
         props.put(SecurityConstants.STS_TOKEN_PROPERTIES,
            Thread.currentThread().getContextClassLoader().getResource("actasKeystore.properties" ));
         props.put(SecurityConstants.STS_TOKEN_USE_CERT_FOR_KEYINFO, "true");

         ctx.put(SecurityConstants.STS_CLIENT, stsClient);

      } finally {
         bus.shutdown(true);
      }

      return proxy;
   }

}</code></pre>
</div>
</div>
</div>
<div class="sect6">
<h7 id="actascallbackhandler-actas-ws-trust"><a class="anchor" href="#actascallbackhandler-actas-ws-trust"></a>ActAsCallbackHandler</h7>
<div class="paragraph">
<p>ActAsCallbackHandler is a callback handler for the WSS4J Crypto API. It
is used to obtain the password for the private key in the keystore. This
class enables CXF to retrieve the password of the user name to use for
the message signature. This class has been revised to return the
passwords for this service, myactaskey and the "actas" user, alice.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">package org.jboss.test.ws.jaxws.samples.wsse.policy.trust.actas;

import org.jboss.wsf.stack.cxf.extensions.security.PasswordCallbackHandler;
import java.util.HashMap;
import java.util.Map;

public class ActAsCallbackHandler extends PasswordCallbackHandler {

   public ActAsCallbackHandler()
   {
      super(getInitMap());
   }

   private static Map&lt;String, String&gt; getInitMap()
   {
      Map&lt;String, String&gt; passwords = new HashMap&lt;String, String&gt;();
      passwords.put("myactaskey", "aspass");
      passwords.put("alice", "clarinet");
      return passwords;
   }
}</code></pre>
</div>
</div>
</div>
<div class="sect6">
<h7 id="usernametokencallbackhandler-actas-ws-trust"><a class="anchor" href="#usernametokencallbackhandler-actas-ws-trust"></a>UsernameTokenCallbackHandler</h7>
<div class="paragraph">
<p>The ActAs and OnBeholdOf sub-elements of the RequestSecurityToken are
required to be defined as WSSE Username Tokens. This utility generates
the properly formated element.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">package org.jboss.test.ws.jaxws.samples.wsse.policy.trust.shared;

import org.apache.cxf.helpers.DOMUtils;
import org.apache.cxf.message.Message;
import org.apache.cxf.ws.security.SecurityConstants;
import org.apache.cxf.ws.security.trust.delegation.DelegationCallback;
import org.apache.ws.security.WSConstants;
import org.apache.ws.security.message.token.UsernameToken;
import org.w3c.dom.Document;
import org.w3c.dom.Node;
import org.w3c.dom.Element;
import org.w3c.dom.ls.DOMImplementationLS;
import org.w3c.dom.ls.LSSerializer;

import javax.security.auth.callback.Callback;
import javax.security.auth.callback.CallbackHandler;
import javax.security.auth.callback.UnsupportedCallbackException;
import java.io.IOException;
import java.util.Map;

/**
* A utility to provide the 3 different input parameter types for jaxws property
* "ws-security.sts.token.act-as" and "ws-security.sts.token.on-behalf-of".
* This implementation obtains a username and password via the jaxws property
* "ws-security.username" and "ws-security.password" respectively, as defined
* in SecurityConstants.  It creates a wss UsernameToken to be used as the
* delegation token.
*/

public class UsernameTokenCallbackHandler implements CallbackHandler {

   public void handle(Callback[] callbacks)
      throws IOException, UnsupportedCallbackException {
      for (int i = 0; i &lt; callbacks.length; i++) {
         if (callbacks[i] instanceof DelegationCallback) {
            DelegationCallback callback = (DelegationCallback) callbacks[i];
            Message message = callback.getCurrentMessage();

            String username =
               (String)message.getContextualProperty(SecurityConstants.USERNAME);
            String password =
               (String)message.getContextualProperty(SecurityConstants.PASSWORD);
            if (username != null) {
               Node contentNode = message.getContent(Node.class);
               Document doc = null;
               if (contentNode != null) {
                  doc = contentNode.getOwnerDocument();
               } else {
                  doc = DOMUtils.createDocument();
               }
               UsernameToken usernameToken = createWSSEUsernameToken(username,password, doc);
               callback.setToken(usernameToken.getElement());
            }
         } else {
            throw new UnsupportedCallbackException(callbacks[i], "Unrecognized Callback");
         }
      }
   }

   /**
    * Provide UsernameToken as a string.
    * @param ctx
    * @return
    */
   public String getUsernameTokenString(Map&lt;String, Object&gt; ctx){
      Document doc = DOMUtils.createDocument();
      String result = null;
      String username = (String)ctx.get(SecurityConstants.USERNAME);
      String password = (String)ctx.get(SecurityConstants.PASSWORD);
      if (username != null) {
         UsernameToken usernameToken = createWSSEUsernameToken(username,password, doc);
         result = toString(usernameToken.getElement().getFirstChild().getParentNode());
      }
      return result;
   }

   /**
    *
    * @param username
    * @param password
    * @return
    */
   public String getUsernameTokenString(String username, String password){
      Document doc = DOMUtils.createDocument();
      String result = null;
      if (username != null) {
         UsernameToken usernameToken = createWSSEUsernameToken(username,password, doc);
         result = toString(usernameToken.getElement().getFirstChild().getParentNode());
      }
      return result;
   }

   /**
    * Provide UsernameToken as a DOM Element.
    * @param ctx
    * @return
    */
   public Element getUsernameTokenElement(Map&lt;String, Object&gt; ctx){
      Document doc = DOMUtils.createDocument();
      Element result = null;
      UsernameToken usernameToken = null;
         String username = (String)ctx.get(SecurityConstants.USERNAME);
      String password = (String)ctx.get(SecurityConstants.PASSWORD);
      if (username != null) {
         usernameToken = createWSSEUsernameToken(username,password, doc);
         result = usernameToken.getElement();
      }
      return result;
   }

   /**
    *
    * @param username
    * @param password
    * @return
    */
   public Element getUsernameTokenElement(String username, String password){
      Document doc = DOMUtils.createDocument();
      Element result = null;
      UsernameToken usernameToken = null;
      if (username != null) {
         usernameToken = createWSSEUsernameToken(username,password, doc);
         result = usernameToken.getElement();
      }
      return result;
   }

   private UsernameToken createWSSEUsernameToken(String username, String password, Document doc) {

      UsernameToken usernameToken = new UsernameToken(true, doc,
         (password == null)? null: WSConstants.PASSWORD_TEXT);
      usernameToken.setName(username);
      usernameToken.addWSUNamespace();
      usernameToken.addWSSENamespace();
      usernameToken.setID("id-" + username);

      if (password != null){
         usernameToken.setPassword(password);
      }

      return usernameToken;
   }


   private String toString(Node node) {
      String str = null;

      if (node != null) {
         DOMImplementationLS lsImpl = (DOMImplementationLS)
            node.getOwnerDocument().getImplementation().getFeature("LS", "3.0");
         LSSerializer serializer = lsImpl.createLSSerializer();
         serializer.getDomConfig().setParameter("xml-declaration", false); //by default its true, so set it to false to get String without xml-declaration
         str = serializer.writeToString(node);
      }
      return str;
   }

}</code></pre>
</div>
</div>
</div>
<div class="sect6">
<h7 id="crypto-properties-and-keystore-files-actas-ws-trust"><a class="anchor" href="#crypto-properties-and-keystore-files-actas-ws-trust"></a>Crypto properties and keystore files</h7>
<div class="paragraph">
<p>The ActAs service must provide its own credentials. The requisite
properties file, actasKeystore.properties, and keystore, actasstore.jks,
were created.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>org.apache.ws.security.crypto.provider=org.apache.ws.security.components.crypto.Merlin
org.apache.ws.security.crypto.merlin.keystore.type=jks
org.apache.ws.security.crypto.merlin.keystore.password=aapass
org.apache.ws.security.crypto.merlin.keystore.alias=myactaskey
org.apache.ws.security.crypto.merlin.keystore.file=actasstore.jks</pre>
</div>
</div>
</div>
<div class="sect6">
<h7 id="manifest-mf-actas-ws-trust-actas-ws-trust"><a class="anchor" href="#manifest-mf-actas-ws-trust-actas-ws-trust"></a>MANIFEST.MF</h7>
<div class="paragraph">
<p>When deployed on WildFly this application requires access to the JBossWs
and CXF APIs provided in modules org.jboss.ws.cxf.jbossws-cxf-client and
org.apache.cxf. The Apache CXF internals, org.apache.cxf.impl, are
needed in handling the ActAs and OnBehalfOf extensions. The dependency
statement directs the server to provide them at deployment.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>Manifest-Version: 1.0
Ant-Version: Apache Ant 1.8.2
Created-By: 1.7.0_25-b15 (Oracle Corporation)
Dependencies: org.jboss.ws.cxf.jbossws-cxf-client, org.apache.cxf.impl</pre>
</div>
</div>
</div>
</div>
<div class="sect5">
<h6 id="security-token-service-actas-ws-trust"><a class="anchor" href="#security-token-service-actas-ws-trust"></a>Security Token Service</h6>
<div class="paragraph">
<p>This section examines the STS elements from the basic WS-Trust scenario
that have been changed to address the needs of the ActAs example. The
components are.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>STS&#8217;s implementation class.</p>
</li>
<li>
<p>STSCallbackHandler class</p>
</li>
</ul>
</div>
<div class="sect6">
<h7 id="sts-implementation-class-actas-ws-trust"><a class="anchor" href="#sts-implementation-class-actas-ws-trust"></a>STS Implementation class</h7>
<div class="paragraph">
<p>The initial description of SampleSTS can be found
<a href="#sts-implementation-class">here</a>.</p>
</div>
<div class="paragraph">
<p>The declaration of the set of allowed token recipients by address has
been extended to accept ActAs addresses and OnBehalfOf addresses. The
addresses are specified as reg-ex patterns.</p>
</div>
<div class="paragraph">
<p>The TokenIssueOperation requires class, UsernameTokenValidator be
provided in order to validate the contents of the OnBehalfOf claims and
class, UsernameTokenDelegationHandler to be provided in order to process
the token delegation request of the ActAs on OnBehalfOf user.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">package org.jboss.test.ws.jaxws.samples.wsse.policy.trust.sts;

import java.util.Arrays;
import java.util.LinkedList;
import java.util.List;

import javax.xml.ws.WebServiceProvider;

import org.apache.cxf.annotations.EndpointProperties;
import org.apache.cxf.annotations.EndpointProperty;
import org.apache.cxf.interceptor.InInterceptors;
import org.apache.cxf.sts.StaticSTSProperties;
import org.apache.cxf.sts.operation.TokenIssueOperation;
import org.apache.cxf.sts.operation.TokenValidateOperation;
import org.apache.cxf.sts.service.ServiceMBean;
import org.apache.cxf.sts.service.StaticService;
import org.apache.cxf.sts.token.delegation.UsernameTokenDelegationHandler;
import org.apache.cxf.sts.token.provider.SAMLTokenProvider;
import org.apache.cxf.sts.token.validator.SAMLTokenValidator;
import org.apache.cxf.sts.token.validator.UsernameTokenValidator;
import org.apache.cxf.ws.security.sts.provider.SecurityTokenServiceProvider;

@WebServiceProvider(serviceName = "SecurityTokenService",
      portName = "UT_Port",
      targetNamespace = "http://docs.oasis-open.org/ws-sx/ws-trust/200512/",
      wsdlLocation = "WEB-INF/wsdl/ws-trust-1.4-service.wsdl")
//be sure to have dependency on org.apache.cxf module when on AS7, otherwise Apache CXF annotations are ignored
@EndpointProperties(value = {
      @EndpointProperty(key = "ws-security.signature.username", value = "mystskey"),
      @EndpointProperty(key = "ws-security.signature.properties", value = "stsKeystore.properties"),
      @EndpointProperty(key = "ws-security.callback-handler", value = "org.jboss.test.ws.jaxws.samples.wsse.policy.trust.sts.STSCallbackHandler"),
      @EndpointProperty(key = "ws-security.validate.token", value = "false") //to let the JAAS integration deal with validation through the interceptor below
})
@InInterceptors(interceptors = {"org.jboss.wsf.stack.cxf.security.authentication.SubjectCreatingPolicyInterceptor"})
public class SampleSTS extends SecurityTokenServiceProvider
{
   public SampleSTS() throws Exception
   {
      super();

      StaticSTSProperties props = new StaticSTSProperties();
      props.setSignatureCryptoProperties("stsKeystore.properties");
      props.setSignatureUsername("mystskey");
      props.setCallbackHandlerClass(STSCallbackHandler.class.getName());
      props.setIssuer("DoubleItSTSIssuer");

      List&lt;ServiceMBean&gt; services = new LinkedList&lt;ServiceMBean&gt;();
      StaticService service = new StaticService();
      service.setEndpoints(Arrays.asList(
         "http://localhost:(\\d)*/jaxws-samples-wsse-policy-trust/SecurityService",
         "http://\\[::1\\]:(\\d)*/jaxws-samples-wsse-policy-trust/SecurityService",
         "http://\\[0:0:0:0:0:0:0:1\\]:(\\d)*/jaxws-samples-wsse-policy-trust/SecurityService",

         "http://localhost:(\\d)*/jaxws-samples-wsse-policy-trust-actas/ActAsService",
         "http://\\[::1\\]:(\\d)*/jaxws-samples-wsse-policy-trust-actas/ActAsService",
         "http://\\[0:0:0:0:0:0:0:1\\]:(\\d)*/jaxws-samples-wsse-policy-trust-actas/ActAsService",

         "http://localhost:(\\d)*/jaxws-samples-wsse-policy-trust-onbehalfof/OnBehalfOfService",
         "http://\\[::1\\]:(\\d)*/jaxws-samples-wsse-policy-trust-onbehalfof/OnBehalfOfService",
         "http://\\[0:0:0:0:0:0:0:1\\]:(\\d)*/jaxws-samples-wsse-policy-trust-onbehalfof/OnBehalfOfService"
      ));
      services.add(service);

      TokenIssueOperation issueOperation = new TokenIssueOperation();
      issueOperation.setServices(services);
      issueOperation.getTokenProviders().add(new SAMLTokenProvider());
      // required for OnBehalfOf
      issueOperation.getTokenValidators().add(new UsernameTokenValidator());
      // added for OnBehalfOf and ActAs
      issueOperation.getDelegationHandlers().add(new UsernameTokenDelegationHandler());
      issueOperation.setStsProperties(props);

      TokenValidateOperation validateOperation = new TokenValidateOperation();
      validateOperation.getTokenValidators().add(new SAMLTokenValidator());
      validateOperation.setStsProperties(props);

      this.setIssueOperation(issueOperation);
      this.setValidateOperation(validateOperation);
   }
}</code></pre>
</div>
</div>
</div>
<div class="sect6">
<h7 id="stscallbackhandler-actas-ws-trust"><a class="anchor" href="#stscallbackhandler-actas-ws-trust"></a>STSCallbackHandler</h7>
<div class="paragraph">
<p>The user, alice, and corresponding password was required to be added for
the ActAs example.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">package org.jboss.test.ws.jaxws.samples.wsse.policy.trust.sts;

import java.util.HashMap;
import java.util.Map;

import org.jboss.wsf.stack.cxf.extensions.security.PasswordCallbackHandler;

public class STSCallbackHandler extends PasswordCallbackHandler
{
   public STSCallbackHandler()
   {
      super(getInitMap());
   }

   private static Map&lt;String, String&gt; getInitMap()
   {
      Map&lt;String, String&gt; passwords = new HashMap&lt;String, String&gt;();
      passwords.put("mystskey", "stskpass");
      passwords.put("alice", "clarinet");
      return passwords;
   }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect5">
<h6 id="web-service-requester-actas-ws-trust"><a class="anchor" href="#web-service-requester-actas-ws-trust"></a>Web service requester</h6>
<div class="paragraph">
<p>This section examines the ws-requester elements from the basic WS-Trust
scenario that have been changed to address the needs of the ActAs
example. The component is</p>
</div>
<div class="ulist">
<ul>
<li>
<p>ActAs web service requester implementation class</p>
</li>
</ul>
</div>
<div class="sect6">
<h7 id="web-service-requester-implementation-actas-ws-trust"><a class="anchor" href="#web-service-requester-implementation-actas-ws-trust"></a>Web service requester Implementation</h7>
<div class="paragraph">
<p>The ActAs ws-requester, the client, uses standard procedures for
creating a reference to the web service in the first four lines. To
address the endpoint security requirements, the web service&#8217;s "Request
Context" is configured via the BindingProvider. Information needed in
the message generation is provided through it. The ActAs user,
myactaskey, is declared in this section and UsernameTokenCallbackHandler
is used to provide the contents of the ActAs element to the STSClient.
In this example a STSClient object is created and provided to the
proxy&#8217;s request context. The alternative is to provide keys tagged with
the ".it" suffix as was done in
<a href="https://docs.jboss.org/author/display/JBWS/WS-Trust+and+STS#WS-TrustandSTS-WebservicerequesterImplementation">the
Basic Scenario client</a>. The use of ActAs is configured through the props
map using the SecurityConstants.STS_TOKEN_ACT_AS key. The alternative is
to use the STSClient.setActAs method.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">final QName serviceName = new QName("http://www.jboss.org/jbossws/ws-extensions/actaswssecuritypolicy", "ActAsService");
final URL wsdlURL = new URL(serviceURL + "?wsdl");
Service service = Service.create(wsdlURL, serviceName);
ActAsServiceIface proxy = (ActAsServiceIface) service.getPort(ActAsServiceIface.class);

Bus bus = BusFactory.newInstance().createBus();
try {
    BusFactory.setThreadDefaultBus(bus);

    Map&lt;String, Object&gt; ctx = proxy.getRequestContext();

    ctx.put(SecurityConstants.CALLBACK_HANDLER, new ClientCallbackHandler());
    ctx.put(SecurityConstants.ENCRYPT_PROPERTIES,
        Thread.currentThread().getContextClassLoader().getResource(
        "META-INF/clientKeystore.properties"));
    ctx.put(SecurityConstants.ENCRYPT_USERNAME, "myactaskey");
    ctx.put(SecurityConstants.SIGNATURE_PROPERTIES,
        Thread.currentThread().getContextClassLoader().getResource(
        "META-INF/clientKeystore.properties"));
    ctx.put(SecurityConstants.SIGNATURE_USERNAME, "myclientkey");

    // Generate the ActAs element contents and pass to the STSClient as a string
    UsernameTokenCallbackHandler ch = new UsernameTokenCallbackHandler();
    String str = ch.getUsernameTokenString("alice","clarinet");
    ctx.put(SecurityConstants.STS_TOKEN_ACT_AS, str);

    STSClient stsClient = new STSClient(bus);
    Map&lt;String, Object&gt; props = stsClient.getProperties();
    props.put(SecurityConstants.USERNAME, "bob");
    props.put(SecurityConstants.CALLBACK_HANDLER, new ClientCallbackHandler());
    props.put(SecurityConstants.ENCRYPT_PROPERTIES,
        Thread.currentThread().getContextClassLoader().getResource(
        "META-INF/clientKeystore.properties"));
    props.put(SecurityConstants.ENCRYPT_USERNAME, "mystskey");
    props.put(SecurityConstants.STS_TOKEN_USERNAME, "myclientkey");
    props.put(SecurityConstants.STS_TOKEN_PROPERTIES,
        Thread.currentThread().getContextClassLoader().getResource(
        "META-INF/clientKeystore.properties"));
    props.put(SecurityConstants.STS_TOKEN_USE_CERT_FOR_KEYINFO, "true");

    ctx.put(SecurityConstants.STS_CLIENT, stsClient);
} finally {
    bus.shutdown(true);
}
proxy.sayHello();</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="OnBehalfOf_WS-Trust_Scenario"><a class="anchor" href="#OnBehalfOf_WS-Trust_Scenario"></a>OnBehalfOf WS-Trust Scenario</h5>
<div class="paragraph">
<p>The OnBehalfOf feature is used in scenarios that use the proxy pattern.
In such scenarios, the client cannot access the STS directly, instead it
communicates through a proxy gateway. The proxy gateway authenticates
the caller and puts information about the caller into the OnBehalfOf
element of the RequestSecurityToken (RST) sent to the real STS for
processing. The resulting token contains only claims related to the
client of the proxy, making the proxy completely transparent to the
receiver of the issued token.</p>
</div>
<div class="paragraph">
<p>OnBehalfOf is nothing more than a new sub-element in the RST. It
provides additional information about the original caller when a token
is negotiated with the STS. The OnBehalfOf element usually takes the
form of a token with identity claims such as name, role, and
authorization code, for the client to access the service.</p>
</div>
<div class="paragraph">
<p>The OnBehalfOf scenario is an extension of
<a href="#OnBehalfOf_WS-Trust_Scenario">the
basic WS-Trust scenario</a>. In this example the OnBehalfOf service calls
the ws-service on behalf of a user. There are only a couple of additions
to the basic scenario&#8217;s code. An OnBehalfOf web service provider and
callback handler have been added. The OnBehalfOf web services' WSDL
imposes the same security policies as the ws-provider.
UsernameTokenCallbackHandler is a utility shared with ActAs. It
generates the content for the OnBehalfOf element. And lastly there are
code additions in the STS that both OnBehalfOf and ActAs share in
common.</p>
</div>
<div class="paragraph">
<p>Infor here [
<a href="http://coheigea.blogspot.it/2012/01/apache-cxf-251-sts-updates.html">Open
Source Security: Apache CXF 2.5.1 STS updates</a> ]</p>
</div>
<div class="sect5">
<h6 id="web-service-provider-3"><a class="anchor" href="#web-service-provider-3"></a>Web service provider</h6>
<div class="paragraph">
<p>This section examines the web service elements from the basic WS-Trust
scenario that have been changed to address the needs of the OnBehalfOf
example. The components are.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>web service provider&#8217;s WSDL</p>
</li>
<li>
<p>web service provider&#8217;s Interface and Implementation classes.</p>
</li>
<li>
<p>OnBehalfOfCallbackHandler class</p>
</li>
</ul>
</div>
<div class="sect6">
<h7 id="web-service-provider-wsdl-3"><a class="anchor" href="#web-service-provider-wsdl-3"></a>Web service provider WSDL</h7>
<div class="paragraph">
<p>The OnBehalfOf web service provider&#8217;s WSDL is a clone of the
ws-provider&#8217;s WSDL. The wsp:Policy section is the same. There are
changes to the service endpoint, targetNamespace, portType, binding
name, and service.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;?xml version="1.0" encoding="UTF-8" standalone="yes"?&gt;
&lt;definitions targetNamespace="http://www.jboss.org/jbossws/ws-extensions/onbehalfofwssecuritypolicy" name="OnBehalfOfService"
             xmlns:tns="http://www.jboss.org/jbossws/ws-extensions/onbehalfofwssecuritypolicy"
             xmlns:xsd="http://www.w3.org/2001/XMLSchema"
             xmlns:soap="http://schemas.xmlsoap.org/wsdl/soap/"
             xmlns="http://schemas.xmlsoap.org/wsdl/"
             xmlns:wsp="http://www.w3.org/ns/ws-policy"
             xmlns:wsam="http://www.w3.org/2007/05/addressing/metadata"
             xmlns:wsu="http://docs.oasis-open.org/wss/2004/01/oasis-200401-wss-wssecurity-utility-1.0.xsd"
             xmlns:wsaws="http://www.w3.org/2005/08/addressing"
             xmlns:sp="http://docs.oasis-open.org/ws-sx/ws-securitypolicy/200702"
             xmlns:t="http://docs.oasis-open.org/ws-sx/ws-trust/200512"&gt;
    &lt;types&gt;
        &lt;xsd:schema&gt;
            &lt;xsd:import namespace="http://www.jboss.org/jbossws/ws-extensions/onbehalfofwssecuritypolicy"
                  schemaLocation="OnBehalfOfService_schema1.xsd"/&gt;
        &lt;/xsd:schema&gt;
    &lt;/types&gt;
    &lt;message name="sayHello"&gt;
        &lt;part name="parameters" element="tns:sayHello"/&gt;
    &lt;/message&gt;
    &lt;message name="sayHelloResponse"&gt;
        &lt;part name="parameters" element="tns:sayHelloResponse"/&gt;
    &lt;/message&gt;
    &lt;portType name="OnBehalfOfServiceIface"&gt;
        &lt;operation name="sayHello"&gt;
            &lt;input message="tns:sayHello"/&gt;
            &lt;output message="tns:sayHelloResponse"/&gt;
        &lt;/operation&gt;
    &lt;/portType&gt;
    &lt;binding name="OnBehalfOfServicePortBinding" type="tns:OnBehalfOfServiceIface"&gt;
        &lt;wsp:PolicyReference URI="#AsymmetricSAML2Policy" /&gt;
        &lt;soap:binding transport="http://schemas.xmlsoap.org/soap/http" style="document"/&gt;
        &lt;operation name="sayHello"&gt;
            &lt;soap:operation soapAction=""/&gt;
            &lt;input&gt;
                &lt;soap:body use="literal"/&gt;
                &lt;wsp:PolicyReference URI="#Input_Policy" /&gt;
            &lt;/input&gt;
            &lt;output&gt;
                &lt;soap:body use="literal"/&gt;
                &lt;wsp:PolicyReference URI="#Output_Policy" /&gt;
            &lt;/output&gt;
        &lt;/operation&gt;
    &lt;/binding&gt;
    &lt;service name="OnBehalfOfService"&gt;
        &lt;port name="OnBehalfOfServicePort" binding="tns:OnBehalfOfServicePortBinding"&gt;
            &lt;soap:address location="http://@jboss.bind.address@:8080/jaxws-samples-wsse-policy-trust-onbehalfof/OnBehalfOfService"/&gt;
        &lt;/port&gt;
    &lt;/service&gt;
&lt;/definitions&gt;</code></pre>
</div>
</div>
</div>
<div class="sect6">
<h7 id="web-service-interface-onbehalfo-ws-trust"><a class="anchor" href="#web-service-interface-onbehalfo-ws-trust"></a>Web Service Interface</h7>
<div class="paragraph">
<p>The web service provider interface class, OnBehalfOfServiceIface, is a
simple web service definition.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">package org.jboss.test.ws.jaxws.samples.wsse.policy.trust.onbehalfof;

import javax.jws.WebMethod;
import javax.jws.WebService;

@WebService
(
   targetNamespace = "http://www.jboss.org/jbossws/ws-extensions/onbehalfofwssecuritypolicy"
)
public interface OnBehalfOfServiceIface
{
   @WebMethod
   String sayHello();
}</code></pre>
</div>
</div>
</div>
<div class="sect6">
<h7 id="web-service-implementation-onbehalfo-ws-trust"><a class="anchor" href="#web-service-implementation-onbehalfo-ws-trust"></a>Web Service Implementation</h7>
<div class="paragraph">
<p>The web service provider implementation class, OnBehalfOfServiceImpl, is
a simple POJO. It uses the standard WebService annotation to define the
service endpoint and two Apache WSS4J annotations, EndpointProperties
and EndpointProperty used for configuring the endpoint for the CXF
runtime. The WSS4J configuration information provided is for WSS4J&#8217;s
Crypto Merlin implementation.</p>
</div>
<div class="paragraph">
<p>OnBehalfOfServiceImpl is calling the ServiceImpl acting on behalf of the
user. Method setupService performs the requisite configuration setup.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">package org.jboss.test.ws.jaxws.samples.wsse.policy.trust.onbehalfof;

import org.apache.cxf.Bus;
import org.apache.cxf.BusFactory;
import org.apache.cxf.annotations.EndpointProperties;
import org.apache.cxf.annotations.EndpointProperty;
import org.apache.cxf.ws.security.SecurityConstants;
import org.apache.cxf.ws.security.trust.STSClient;
import org.jboss.test.ws.jaxws.samples.wsse.policy.trust.service.ServiceIface;
import org.jboss.test.ws.jaxws.samples.wsse.policy.trust.shared.WSTrustAppUtils;

import javax.jws.WebService;
import javax.xml.namespace.QName;
import javax.xml.ws.BindingProvider;
import javax.xml.ws.Service;
import java.net.*;
import java.util.Map;

@WebService
(
   portName = "OnBehalfOfServicePort",
   serviceName = "OnBehalfOfService",
   wsdlLocation = "WEB-INF/wsdl/OnBehalfOfService.wsdl",
   targetNamespace = "http://www.jboss.org/jbossws/ws-extensions/onbehalfofwssecuritypolicy",
   endpointInterface = "org.jboss.test.ws.jaxws.samples.wsse.policy.trust.onbehalfof.OnBehalfOfServiceIface"
)

@EndpointProperties(value = {
      @EndpointProperty(key = "ws-security.signature.username", value = "myactaskey"),
      @EndpointProperty(key = "ws-security.signature.properties", value =  "actasKeystore.properties"),
      @EndpointProperty(key = "ws-security.encryption.properties", value = "actasKeystore.properties"),
      @EndpointProperty(key = "ws-security.callback-handler", value = "org.jboss.test.ws.jaxws.samples.wsse.policy.trust.onbehalfof.OnBehalfOfCallbackHandler")
})

public class OnBehalfOfServiceImpl implements OnBehalfOfServiceIface
{
   public String sayHello() {
      try {

         ServiceIface proxy = setupService();
         return "OnBehalfOf " + proxy.sayHello();

      } catch (MalformedURLException e) {
         e.printStackTrace();
      }
      return null;
   }

   /**
    *
    * @return
    * @throws MalformedURLException
    */
   private  ServiceIface setupService()throws MalformedURLException {
      ServiceIface proxy = null;
      Bus bus = BusFactory.newInstance().createBus();

      try {
         BusFactory.setThreadDefaultBus(bus);

         final String serviceURL = "http://" + WSTrustAppUtils.getServerHost() + ":8080/jaxws-samples-wsse-policy-trust/SecurityService";
         final QName serviceName = new QName("http://www.jboss.org/jbossws/ws-extensions/wssecuritypolicy", "SecurityService");
         final URL wsdlURL = new URL(serviceURL + "?wsdl");
         Service service = Service.create(wsdlURL, serviceName);
         proxy = (ServiceIface) service.getPort(ServiceIface.class);

         Map&lt;String, Object&gt; ctx = ((BindingProvider) proxy).getRequestContext();
         ctx.put(SecurityConstants.CALLBACK_HANDLER, new OnBehalfOfCallbackHandler());

         ctx.put(SecurityConstants.SIGNATURE_PROPERTIES,
            Thread.currentThread().getContextClassLoader().getResource(
            "actasKeystore.properties" ));
         ctx.put(SecurityConstants.SIGNATURE_USERNAME, "myactaskey" );
         ctx.put(SecurityConstants.ENCRYPT_PROPERTIES,
            Thread.currentThread().getContextClassLoader().getResource(
            "../../META-INF/clientKeystore.properties" ));
         ctx.put(SecurityConstants.ENCRYPT_USERNAME, "myservicekey");

         STSClient stsClient = new STSClient(bus);
         Map&lt;String, Object&gt; props = stsClient.getProperties();
         props.put(SecurityConstants.USERNAME, "bob");
         props.put(SecurityConstants.ENCRYPT_USERNAME, "mystskey");
         props.put(SecurityConstants.STS_TOKEN_USERNAME, "myactaskey" );
         props.put(SecurityConstants.STS_TOKEN_PROPERTIES,
            Thread.currentThread().getContextClassLoader().getResource(
            "actasKeystore.properties" ));
         props.put(SecurityConstants.STS_TOKEN_USE_CERT_FOR_KEYINFO, "true");

         ctx.put(SecurityConstants.STS_CLIENT, stsClient);

      } finally {
         bus.shutdown(true);
      }

      return proxy;
   }

}</code></pre>
</div>
</div>
</div>
<div class="sect6">
<h7 id="onbehalfofcallbackhandler-onbehalfo-ws-trust"><a class="anchor" href="#onbehalfofcallbackhandler-onbehalfo-ws-trust"></a>OnBehalfOfCallbackHandler</h7>
<div class="paragraph">
<p>OnBehalfOfCallbackHandler is a callback handler for the WSS4J Crypto
API. It is used to obtain the password for the private key in the
keystore. This class enables CXF to retrieve the password of the user
name to use for the message signature. This class has been revised to
return the passwords for this service, myactaskey and the "OnBehalfOf"
user, alice.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java"> package org.jboss.test.ws.jaxws.samples.wsse.policy.trust.onbehalfof;

import org.jboss.wsf.stack.cxf.extensions.security.PasswordCallbackHandler;
import java.util.HashMap;
import java.util.Map;

public class OnBehalfOfCallbackHandler extends PasswordCallbackHandler {

   public OnBehalfOfCallbackHandler()
   {
      super(getInitMap());
   }

   private static Map&lt;String, String&gt; getInitMap()
   {
      Map&lt;String, String&gt; passwords = new HashMap&lt;String, String&gt;();
      passwords.put("myactaskey", "aspass");
      passwords.put("alice", "clarinet");
      passwords.put("bob", "trombone");
      return passwords;
   }

}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect5">
<h6 id="web-service-requester-onbehalfo-ws-trust"><a class="anchor" href="#web-service-requester-onbehalfo-ws-trust"></a>Web service requester</h6>
<div class="paragraph">
<p>This section examines the ws-requester elements from the basic WS-Trust
scenario that have been changed to address the needs of the OnBehalfOf
example. The component is</p>
</div>
<div class="ulist">
<ul>
<li>
<p>OnBehalfOf web service requester implementation class</p>
</li>
</ul>
</div>
<div class="sect6">
<h7 id="web-service-requester-implementation-onbehalfo-ws-trust"><a class="anchor" href="#web-service-requester-implementation-onbehalfo-ws-trust"></a>Web service requester Implementation</h7>
<div class="paragraph">
<p>The OnBehalfOf ws-requester, the client, uses standard procedures for
creating a reference to the web service in the first four lines. To
address the endpoint security requirements, the web service&#8217;s "Request
Context" is configured via the BindingProvider. Information needed in
the message generation is provided through it. The OnBehalfOf user,
alice, is declared in this section and the callbackHandler,
UsernameTokenCallbackHandler is provided to the STSClient for generation
of the contents for the OnBehalfOf message element. In this example a
STSClient object is created and provided to the proxy&#8217;s request context.
The alternative is to provide keys tagged with the ".it" suffix as was
done in
<a href="#src-557281_OnBehalfOfWS-TrustScenario-WebservicerequesterImplementation">the
Basic Scenario client</a>. The use of OnBehalfOf is configured by the
method call stsClient.setOnBehalfOf. The alternative is to use the key
SecurityConstants.STS_TOKEN_ON_BEHALF_OF and a value in the props map.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">final QName serviceName = new QName("http://www.jboss.org/jbossws/ws-extensions/onbehalfofwssecuritypolicy", "OnBehalfOfService");
final URL wsdlURL = new URL(serviceURL + "?wsdl");
Service service = Service.create(wsdlURL, serviceName);
OnBehalfOfServiceIface proxy = (OnBehalfOfServiceIface) service.getPort(OnBehalfOfServiceIface.class);


Bus bus = BusFactory.newInstance().createBus();
try {

    BusFactory.setThreadDefaultBus(bus);

    Map&lt;String, Object&gt; ctx = proxy.getRequestContext();

    ctx.put(SecurityConstants.CALLBACK_HANDLER, new ClientCallbackHandler());
    ctx.put(SecurityConstants.ENCRYPT_PROPERTIES,
        Thread.currentThread().getContextClassLoader().getResource(
        "META-INF/clientKeystore.properties"));
    ctx.put(SecurityConstants.ENCRYPT_USERNAME, "myactaskey");
    ctx.put(SecurityConstants.SIGNATURE_PROPERTIES,
        Thread.currentThread().getContextClassLoader().getResource(
        "META-INF/clientKeystore.properties"));
    ctx.put(SecurityConstants.SIGNATURE_USERNAME, "myclientkey");

    // user and password OnBehalfOf user
    // UsernameTokenCallbackHandler will extract this information when called
    ctx.put(SecurityConstants.USERNAME,"alice");
    ctx.put(SecurityConstants.PASSWORD, "clarinet");

    STSClient stsClient = new STSClient(bus);

    // Providing the STSClient the mechanism to create the claims contents for OnBehalfOf
    stsClient.setOnBehalfOf(new UsernameTokenCallbackHandler());

    Map&lt;String, Object&gt; props = stsClient.getProperties();
    props.put(SecurityConstants.CALLBACK_HANDLER, new ClientCallbackHandler());
    props.put(SecurityConstants.ENCRYPT_PROPERTIES,
        Thread.currentThread().getContextClassLoader().getResource(
        "META-INF/clientKeystore.properties"));
    props.put(SecurityConstants.ENCRYPT_USERNAME, "mystskey");
    props.put(SecurityConstants.STS_TOKEN_USERNAME, "myclientkey");
    props.put(SecurityConstants.STS_TOKEN_PROPERTIES,
        Thread.currentThread().getContextClassLoader().getResource(
        "META-INF/clientKeystore.properties"));
    props.put(SecurityConstants.STS_TOKEN_USE_CERT_FOR_KEYINFO, "true");

    ctx.put(SecurityConstants.STS_CLIENT, stsClient);

} finally {
    bus.shutdown(true);
}
proxy.sayHello();</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="SAML_Bearer_Assertion_Scenario"><a class="anchor" href="#SAML_Bearer_Assertion_Scenario"></a>SAML Bearer Assertion Scenario</h5>
<div class="paragraph">
<p>WS-Trust deals with managing software security tokens. A SAML assertion
is a type of security token. In the SAML Bearer scenario, the service
provider automatically trusts that the incoming SOAP request came from
the subject defined in the SAML token after the service verifies the
tokens signature.</p>
</div>
<div class="paragraph">
<p>Implementation of this scenario has the following requirements.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>SAML tokens with a Bearer subject confirmation method must be
protected so the token can not be snooped. In most cases, a bearer token
combined with HTTPS is sufficient to prevent "a man in the middle"
getting possession of the token. This means a security policy that uses
a sp:TransportBinding and sp:HttpsToken.</p>
</li>
<li>
<p>A bearer token has no encryption or signing keys associated with it,
therefore a sp:IssuedToken of bearer keyType should be used with a
sp:SupportingToken or a sp:SignedSupportingTokens.</p>
</li>
</ul>
</div>
<div class="sect5">
<h6 id="web-service-provider-4"><a class="anchor" href="#web-service-provider-4"></a>Web service Provider</h6>
<div class="paragraph">
<p>This section examines the web service elements for the SAML Bearer
scenario. The components are</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Bearer web service provider&#8217;s WSDL</p>
</li>
<li>
<p>SSL configuration</p>
</li>
<li>
<p>Bearer web service provider&#8217;s Interface and Implementation classes.</p>
</li>
<li>
<p>Crypto properties and keystore files</p>
</li>
<li>
<p>MANIFEST.MF</p>
</li>
</ul>
</div>
<div class="sect6">
<h7 id="web-service-provider-wsdl-4"><a class="anchor" href="#web-service-provider-wsdl-4"></a>Web service provider WSDL</h7>
<div class="paragraph">
<p>The web service provider is a contract-first endpoint. All the WS-trust
and security policies for it are declared in WSDL, BearerService.wsdl.
For this scenario a ws-requester is required to present a SAML 2.0
Bearer token issued from a designed STS. The address of the STS is
provided in the WSDL. HTTPS, a TransportBinding and HttpsToken policy
are used to protect the SOAP body of messages that pass back and forth
between ws-requester and ws-provider. A detailed explanation of the
security settings are provided in the comments in the listing below.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;?xml version="1.0" encoding="UTF-8" standalone="yes"?&gt;
&lt;definitions targetNamespace="http://www.jboss.org/jbossws/ws-extensions/bearerwssecuritypolicy"
             name="BearerService"
             xmlns:tns="http://www.jboss.org/jbossws/ws-extensions/bearerwssecuritypolicy"
             xmlns:xsd="http://www.w3.org/2001/XMLSchema"
             xmlns:soap="http://schemas.xmlsoap.org/wsdl/soap/"
             xmlns="http://schemas.xmlsoap.org/wsdl/"
             xmlns:wsp="http://www.w3.org/ns/ws-policy"
             xmlns:wsam="http://www.w3.org/2007/05/addressing/metadata"
             xmlns:wsu="http://docs.oasis-open.org/wss/2004/01/oasis-200401-wss-wssecurity-utility-1.0.xsd"
             xmlns:wsaws="http://www.w3.org/2005/08/addressing"
             xmlns:wsx="http://schemas.xmlsoap.org/ws/2004/09/mex"
             xmlns:sp="http://docs.oasis-open.org/ws-sx/ws-securitypolicy/200702"
             xmlns:t="http://docs.oasis-open.org/ws-sx/ws-trust/200512"&gt;

  &lt;types&gt;
    &lt;xsd:schema&gt;
      &lt;xsd:import namespace="http://www.jboss.org/jbossws/ws-extensions/bearerwssecuritypolicy"
                  schemaLocation="BearerService_schema1.xsd"/&gt;
    &lt;/xsd:schema&gt;
  &lt;/types&gt;
  &lt;message name="sayHello"&gt;
    &lt;part name="parameters" element="tns:sayHello"/&gt;
  &lt;/message&gt;
  &lt;message name="sayHelloResponse"&gt;
    &lt;part name="parameters" element="tns:sayHelloResponse"/&gt;
  &lt;/message&gt;
  &lt;portType name="BearerIface"&gt;
    &lt;operation name="sayHello"&gt;
      &lt;input message="tns:sayHello"/&gt;
      &lt;output message="tns:sayHelloResponse"/&gt;
    &lt;/operation&gt;
  &lt;/portType&gt;

&lt;!--
        The wsp:PolicyReference binds the security requirments on all the endpoints.
        The wsp:Policy wsu:Id="#TransportSAML2BearerPolicy" element is defined later in this file.
--&gt;
  &lt;binding name="BearerServicePortBinding" type="tns:BearerIface"&gt;
    &lt;wsp:PolicyReference URI="#TransportSAML2BearerPolicy" /&gt;
    &lt;soap:binding transport="http://schemas.xmlsoap.org/soap/http" style="document"/&gt;
    &lt;operation name="sayHello"&gt;
      &lt;soap:operation soapAction=""/&gt;
      &lt;input&gt;
        &lt;soap:body use="literal"/&gt;
      &lt;/input&gt;
      &lt;output&gt;
        &lt;soap:body use="literal"/&gt;
      &lt;/output&gt;
    &lt;/operation&gt;
  &lt;/binding&gt;

&lt;!--
  The soap:address has been defined to use JBoss's https port, 8443.  This is
  set in conjunction with the sp:TransportBinding policy for https.
--&gt;
  &lt;service name="BearerService"&gt;
    &lt;port name="BearerServicePort" binding="tns:BearerServicePortBinding"&gt;
      &lt;soap:address location="https://@jboss.bind.address@:8443/jaxws-samples-wsse-policy-trust-bearer/BearerService"/&gt;
    &lt;/port&gt;
  &lt;/service&gt;


  &lt;wsp:Policy wsu:Id="TransportSAML2BearerPolicy"&gt;
    &lt;wsp:ExactlyOne&gt;
      &lt;wsp:All&gt;
  &lt;!--
        The wsam:Addressing element, indicates that the endpoints of this
        web service MUST conform to the WS-Addressing specification.  The
        attribute wsp:Optional="false" enforces this assertion.
  --&gt;
        &lt;wsam:Addressing wsp:Optional="false"&gt;
          &lt;wsp:Policy /&gt;
        &lt;/wsam:Addressing&gt;

&lt;!--
  The sp:TransportBinding element indicates that security is provided by the
  message exchange transport medium, https.  WS-Security policy specification
  defines the sp:HttpsToken for use in exchanging messages transmitted over HTTPS.
--&gt;
        &lt;sp:TransportBinding
          xmlns:sp="http://docs.oasis-open.org/ws-sx/ws-securitypolicy/200702"&gt;
          &lt;wsp:Policy&gt;
            &lt;sp:TransportToken&gt;
              &lt;wsp:Policy&gt;
                &lt;sp:HttpsToken&gt;
                  &lt;wsp:Policy/&gt;
                &lt;/sp:HttpsToken&gt;
              &lt;/wsp:Policy&gt;
            &lt;/sp:TransportToken&gt;
&lt;!--
     The sp:AlgorithmSuite element, requires the TripleDes algorithm suite
     be used in performing cryptographic operations.
--&gt;
            &lt;sp:AlgorithmSuite&gt;
              &lt;wsp:Policy&gt;
                &lt;sp:TripleDes /&gt;
              &lt;/wsp:Policy&gt;
            &lt;/sp:AlgorithmSuite&gt;
&lt;!--
     The sp:Layout element,  indicates the layout rules to apply when adding
     items to the security header.  The sp:Lax sub-element indicates items
     are added to the security header in any order that conforms to
     WSS: SOAP Message Security.
--&gt;
            &lt;sp:Layout&gt;
              &lt;wsp:Policy&gt;
                &lt;sp:Lax /&gt;
              &lt;/wsp:Policy&gt;
            &lt;/sp:Layout&gt;
            &lt;sp:IncludeTimestamp /&gt;
          &lt;/wsp:Policy&gt;
        &lt;/sp:TransportBinding&gt;

&lt;!--
  The sp:SignedSupportingTokens element causes the supporting tokens
  to be signed using the primary token that is used to sign the message.
--&gt;
        &lt;sp:SignedSupportingTokens
          xmlns:sp="http://docs.oasis-open.org/ws-sx/ws-securitypolicy/200702"&gt;
          &lt;wsp:Policy&gt;
&lt;!--
  The sp:IssuedToken element asserts that a SAML 2.0 security token of type
  Bearer is expected from the STS.  The
  sp:IncludeToken="http://docs.oasis-open.org/ws-sx/ws-securitypolicy/200702/IncludeToken/AlwaysToRecipient"&gt;
  attribute instructs the runtime to include the initiator's public key
  with every message sent to the recipient.

  The sp:RequestSecurityTokenTemplate element directs that all of the
  children of this element will be copied directly into the body of the
  RequestSecurityToken (RST) message that is sent to the STS when the
  initiator asks the STS to issue a token.
--&gt;
            &lt;sp:IssuedToken
              sp:IncludeToken="http://docs.oasis-open.org/ws-sx/ws-securitypolicy/200702/IncludeToken/AlwaysToRecipient"&gt;
              &lt;sp:RequestSecurityTokenTemplate&gt;
                &lt;t:TokenType&gt;http://docs.oasis-open.org/wss/oasis-wss-saml-token-profile-1.1#SAMLV2.0&lt;/t:TokenType&gt;
                &lt;t:KeyType&gt;http://docs.oasis-open.org/ws-sx/ws-trust/200512/Bearer&lt;/t:KeyType&gt;
              &lt;/sp:RequestSecurityTokenTemplate&gt;
              &lt;wsp:Policy&gt;
                &lt;sp:RequireInternalReference /&gt;
              &lt;/wsp:Policy&gt;
&lt;!--
  The sp:Issuer element defines the STS's address and endpoint information
  This information is used by the STSClient.
--&gt;
              &lt;sp:Issuer&gt;
                &lt;wsaws:Address&gt;http://@jboss.bind.address@:8080/jaxws-samples-wsse-policy-trust-sts-bearer/SecurityTokenService&lt;/wsaws:Address&gt;
                &lt;wsaws:Metadata
                  xmlns:wsdli="http://www.w3.org/2006/01/wsdl-instance"
                  wsdli:wsdlLocation="http://@jboss.bind.address@:8080/jaxws-samples-wsse-policy-trust-sts-bearer/SecurityTokenService?wsdl"&gt;
                  &lt;wsaw:ServiceName
                    xmlns:wsaw="http://www.w3.org/2006/05/addressing/wsdl"
                    xmlns:stsns="http://docs.oasis-open.org/ws-sx/ws-trust/200512/"
                    EndpointName="UT_Port"&gt;stsns:SecurityTokenService&lt;/wsaw:ServiceName&gt;
                &lt;/wsaws:Metadata&gt;
              &lt;/sp:Issuer&gt;

            &lt;/sp:IssuedToken&gt;
          &lt;/wsp:Policy&gt;
        &lt;/sp:SignedSupportingTokens&gt;
&lt;!--
    The sp:Wss11 element declares WSS: SOAP Message Security 1.1 options
    to be supported by the STS.  These particular elements generally refer
    to how keys are referenced within the SOAP envelope.  These are normally
    handled by CXF.
--&gt;
        &lt;sp:Wss11&gt;
          &lt;wsp:Policy&gt;
            &lt;sp:MustSupportRefIssuerSerial /&gt;
            &lt;sp:MustSupportRefThumbprint /&gt;
            &lt;sp:MustSupportRefEncryptedKey /&gt;
          &lt;/wsp:Policy&gt;
        &lt;/sp:Wss11&gt;
&lt;!--
    The sp:Trust13 element declares controls for WS-Trust 1.3 options.
    They are policy assertions related to exchanges specifically with
    client and server challenges and entropy behaviors.  Again these are
    normally handled by CXF.
--&gt;
        &lt;sp:Trust13&gt;
          &lt;wsp:Policy&gt;
            &lt;sp:MustSupportIssuedTokens /&gt;
            &lt;sp:RequireClientEntropy /&gt;
            &lt;sp:RequireServerEntropy /&gt;
          &lt;/wsp:Policy&gt;
        &lt;/sp:Trust13&gt;
      &lt;/wsp:All&gt;
    &lt;/wsp:ExactlyOne&gt;
  &lt;/wsp:Policy&gt;

&lt;/definitions&gt;</code></pre>
</div>
</div>
</div>
<div class="sect6">
<h7 id="ssl-configuration-saml-bearer"><a class="anchor" href="#ssl-configuration-saml-bearer"></a>SSL configuration</h7>
<div class="paragraph">
<p>This web service is using https, therefore the JBoss server must be
configured to provide SSL support in the Web subsystem. There are 2
components to SSL configuration.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>create a certificate keystore</p>
</li>
<li>
<p>declare an SSL connector in the Web subsystem of the JBoss server
configuration file.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Follow the directions in the, " <em>Using the pure Java implementation
supplied by JSSE</em>" section in the
<a href="https://docs.jboss.org/author/display/WFLY8/SSL+setup+guide">SSL Setup
Guide</a>.</p>
</div>
<div class="paragraph">
<p>Here is an example of an SSL connector declaration.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;subsystem xmlns="urn:jboss:domain:web:1.4" default-virtual-server="default-host" native="false"&gt;
  .....
  &lt;connector name="jbws-https-connector" protocol="HTTP/1.1" scheme="https" socket-binding="https" secure="true" enabled="true"&gt;
    &lt;ssl key-alias="tomcat" password="changeit" certificate-key-file="/myJbossHome/security/test.keystore" verify-client="false"/&gt;
  &lt;/connector&gt;
  ...</code></pre>
</div>
</div>
</div>
<div class="sect6">
<h7 id="web-service-interface-saml-bearer"><a class="anchor" href="#web-service-interface-saml-bearer"></a>Web service Interface</h7>
<div class="paragraph">
<p>The web service provider interface class, BearerIface, is a simple
straight forward web service definition.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">package org.jboss.test.ws.jaxws.samples.wsse.policy.trust.bearer;

import javax.jws.WebMethod;
import javax.jws.WebService;

@WebService
(
   targetNamespace = "http://www.jboss.org/jbossws/ws-extensions/bearerwssecuritypolicy"
)
public interface BearerIface
{
   @WebMethod
   String sayHello();
}</code></pre>
</div>
</div>
</div>
<div class="sect6">
<h7 id="web-service-implementation-saml-bearer"><a class="anchor" href="#web-service-implementation-saml-bearer"></a>Web service Implementation</h7>
<div class="paragraph">
<p>The web service provider implementation class, BearerImpl, is a simple
POJO. It uses the standard WebService annotation to define the service
endpoint. In addition there are two Apache CXF annotations,
EndpointProperties and EndpointProperty used for configuring the
endpoint for the CXF runtime. These annotations come from the
<a href="https://ws.apache.org/wss4j/">Apache WSS4J project</a>, which provides a
Java implementation of the primary WS-Security standards for Web
Services. These annotations are programmatically adding properties to
the endpoint. With plain Apache CXF, these properties are often set via
the &lt;jaxws:properties&gt; element on the &lt;jaxws:endpoint&gt; element in the
Spring config; these annotations allow the properties to be configured
in the code.</p>
</div>
<div class="paragraph">
<p>WSS4J uses the Crypto interface to get keys and certificates for
signature creation/verification, as is asserted by the WSDL for this
service. The WSS4J configuration information being provided by
BearerImpl is for Crypto&#8217;s Merlin implementation. More information will
be provided about this in the keystore section.</p>
</div>
<div class="paragraph">
<p>Because the web service provider automatically trusts that the incoming
SOAP request came from the subject defined in the SAML token there is no
need for a Crypto callbackHandler class or a signature username, unlike
in prior examples, however in order to verify the message signature, the
Java properties file that contains the (Merlin) crypto configuration
information is still required.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">package org.jboss.test.ws.jaxws.samples.wsse.policy.trust.bearer;

import org.apache.cxf.annotations.EndpointProperties;
import org.apache.cxf.annotations.EndpointProperty;

import javax.jws.WebService;

@WebService
(
   portName = "BearerServicePort",
   serviceName = "BearerService",
   wsdlLocation = "WEB-INF/wsdl/BearerService.wsdl",
   targetNamespace = "http://www.jboss.org/jbossws/ws-extensions/bearerwssecuritypolicy",
   endpointInterface = "org.jboss.test.ws.jaxws.samples.wsse.policy.trust.bearer.BearerIface"
)
@EndpointProperties(value = {
   @EndpointProperty(key = "ws-security.signature.properties", value = "serviceKeystore.properties")
})
public class BearerImpl implements BearerIface
{
   public String sayHello()
   {
      return "Bearer WS-Trust Hello World!";
   }
}</code></pre>
</div>
</div>
</div>
<div class="sect6">
<h7 id="crypto-properties-and-keystore-files-saml-bearer"><a class="anchor" href="#crypto-properties-and-keystore-files-saml-bearer"></a>Crypto properties and keystore files</h7>
<div class="paragraph">
<p>WSS4J&#8217;s Crypto implementation is loaded and configured via a Java
properties file that contains Crypto configuration data. The file
contains implementation-specific properties such as a keystore location,
password, default alias and the like. This application is using the
Merlin implementation. File serviceKeystore.properties contains this
information.</p>
</div>
<div class="paragraph">
<p>File servicestore.jks, is a Java KeyStore (JKS) repository. It contains
self signed certificates for myservicekey and mystskey. <em>Self signed
certificates are not appropriate for production use.</em></p>
</div>
<div class="literalblock">
<div class="content">
<pre>org.apache.ws.security.crypto.provider=org.apache.ws.security.components.crypto.Merlin
org.apache.ws.security.crypto.merlin.keystore.type=jks
org.apache.ws.security.crypto.merlin.keystore.password=sspass
org.apache.ws.security.crypto.merlin.keystore.alias=myservicekey
org.apache.ws.security.crypto.merlin.keystore.file=servicestore.jks</pre>
</div>
</div>
</div>
<div class="sect6">
<h7 id="manifest-mf-saml-bearer"><a class="anchor" href="#manifest-mf-saml-bearer"></a>MANIFEST.MF</h7>
<div class="paragraph">
<p>When deployed on WildFly this application requires access to the JBossWs
and CXF APIs provided in module org.jboss.ws.cxf.jbossws-cxf-client. The
dependency statement directs the server to provide them at deployment.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>Manifest-Version: 1.0
Ant-Version: Apache Ant 1.8.2
Created-By: 1.7.0_25-b15 (Oracle Corporation)
Dependencies: org.jboss.ws.cxf.jbossws-cxf-client</pre>
</div>
</div>
</div>
</div>
<div class="sect5">
<h6 id="bearer-security-token-service-saml-bearer"><a class="anchor" href="#bearer-security-token-service-saml-bearer"></a>Bearer Security Token Service</h6>
<div class="paragraph">
<p>This section examines the crucial elements in providing the Security
Token Service functionality for providing a SAML Bearer token. The
components that will be discussed are.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Security Domain</p>
</li>
<li>
<p>STS&#8217;s WSDL</p>
</li>
<li>
<p>STS&#8217;s implementation class</p>
</li>
<li>
<p>STSBearerCallbackHandler</p>
</li>
<li>
<p>Crypto properties and keystore files</p>
</li>
<li>
<p>MANIFEST.MF</p>
</li>
</ul>
</div>
<div class="sect6">
<h7 id="security-domain-saml-bearer"><a class="anchor" href="#security-domain-saml-bearer"></a>Security Domain</h7>
<div class="paragraph">
<p>The STS requires a JBoss security domain be configured. The
jboss-web.xml descriptor declares a named security
domain,"JBossWS-trust-sts" to be used by this service for
authentication. This security domain requires two properties files and
the addition of a security-domain declaration in the JBoss server
configuration file.</p>
</div>
<div class="paragraph">
<p>For this scenario the domain needs to contain user <em>alice</em>, password
<em>clarinet</em>, and role <em>friend</em>. See the listings below for
jbossws-users.properties and jbossws-roles.properties. In addition the
following XML must be added to the JBoss security subsystem in the
server configuration file. Replace " <strong>SOME_PATH</strong>" with appropriate
information.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;security-domain name="JBossWS-trust-sts"&gt;
  &lt;authentication&gt;
    &lt;login-module code="UsersRoles" flag="required"&gt;
      &lt;module-option name="usersProperties" value="/SOME_PATH/jbossws-users.properties"/&gt;
      &lt;module-option name="unauthenticatedIdentity" value="anonymous"/&gt;
      &lt;module-option name="rolesProperties" value="/SOME_PATH/jbossws-roles.properties"/&gt;
    &lt;/login-module&gt;
  &lt;/authentication&gt;
&lt;/security-domain&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>jboss-web.xml</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;!DOCTYPE jboss-web PUBLIC "-//JBoss//DTD Web Application 2.4//EN" "&gt;
&lt;jboss-web&gt;
  &lt;security-domain&gt;java:/jaas/JBossWS-trust-sts&lt;/security-domain&gt;
&lt;/jboss-web&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>jbossws-users.properties</p>
</div>
<div class="literalblock">
<div class="content">
<pre># A sample users.properties file for use with the UsersRolesLoginModule
alice=clarinet</pre>
</div>
</div>
<div class="paragraph">
<p>jbossws-roles.properties</p>
</div>
<div class="literalblock">
<div class="content">
<pre># A sample roles.properties file for use with the UsersRolesLoginModule
alice=friend</pre>
</div>
</div>
</div>
<div class="sect6">
<h7 id="stss-wsdl-saml-bearer"><a class="anchor" href="#stss-wsdl-saml-bearer"></a>STS&#8217;s WSDL</h7>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;wsdl:definitions
  targetNamespace="http://docs.oasis-open.org/ws-sx/ws-trust/200512/"
  xmlns:tns="http://docs.oasis-open.org/ws-sx/ws-trust/200512/"
  xmlns:wstrust="http://docs.oasis-open.org/ws-sx/ws-trust/200512/"
  xmlns:wsdl="http://schemas.xmlsoap.org/wsdl/"
  xmlns:soap="http://schemas.xmlsoap.org/wsdl/soap/"
  xmlns:wsap10="http://www.w3.org/2006/05/addressing/wsdl"
  xmlns:wsu="http://docs.oasis-open.org/wss/2004/01/oasis-200401-wss-wssecurity-utility-1.0.xsd"
  xmlns:wsp="http://www.w3.org/ns/ws-policy"
  xmlns:wst="http://docs.oasis-open.org/ws-sx/ws-trust/200512"
  xmlns:xs="http://www.w3.org/2001/XMLSchema"
  xmlns:wsam="http://www.w3.org/2007/05/addressing/metadata"&gt;

  &lt;wsdl:types&gt;
    &lt;xs:schema elementFormDefault="qualified"
               targetNamespace='http://docs.oasis-open.org/ws-sx/ws-trust/200512'&gt;

      &lt;xs:element name='RequestSecurityToken'
                  type='wst:AbstractRequestSecurityTokenType'/&gt;
      &lt;xs:element name='RequestSecurityTokenResponse'
                  type='wst:AbstractRequestSecurityTokenType'/&gt;

      &lt;xs:complexType name='AbstractRequestSecurityTokenType'&gt;
        &lt;xs:sequence&gt;
          &lt;xs:any namespace='##any' processContents='lax' minOccurs='0'
                  maxOccurs='unbounded'/&gt;
        &lt;/xs:sequence&gt;
        &lt;xs:attribute name='Context' type='xs:anyURI' use='optional'/&gt;
        &lt;xs:anyAttribute namespace='##other' processContents='lax'/&gt;
      &lt;/xs:complexType&gt;
      &lt;xs:element name='RequestSecurityTokenCollection'
                  type='wst:RequestSecurityTokenCollectionType'/&gt;
      &lt;xs:complexType name='RequestSecurityTokenCollectionType'&gt;
        &lt;xs:sequence&gt;
          &lt;xs:element name='RequestSecurityToken'
                      type='wst:AbstractRequestSecurityTokenType' minOccurs='2'
                      maxOccurs='unbounded'/&gt;
        &lt;/xs:sequence&gt;
      &lt;/xs:complexType&gt;

      &lt;xs:element name='RequestSecurityTokenResponseCollection'
                  type='wst:RequestSecurityTokenResponseCollectionType'/&gt;
      &lt;xs:complexType name='RequestSecurityTokenResponseCollectionType'&gt;
        &lt;xs:sequence&gt;
          &lt;xs:element ref='wst:RequestSecurityTokenResponse' minOccurs='1'
                      maxOccurs='unbounded'/&gt;
        &lt;/xs:sequence&gt;
        &lt;xs:anyAttribute namespace='##other' processContents='lax'/&gt;
      &lt;/xs:complexType&gt;

    &lt;/xs:schema&gt;
  &lt;/wsdl:types&gt;

  &lt;!-- WS-Trust defines the following GEDs --&gt;
  &lt;wsdl:message name="RequestSecurityTokenMsg"&gt;
    &lt;wsdl:part name="request" element="wst:RequestSecurityToken"/&gt;
  &lt;/wsdl:message&gt;
  &lt;wsdl:message name="RequestSecurityTokenResponseMsg"&gt;
    &lt;wsdl:part name="response"
               element="wst:RequestSecurityTokenResponse"/&gt;
  &lt;/wsdl:message&gt;
  &lt;wsdl:message name="RequestSecurityTokenCollectionMsg"&gt;
    &lt;wsdl:part name="requestCollection"
               element="wst:RequestSecurityTokenCollection"/&gt;
  &lt;/wsdl:message&gt;
  &lt;wsdl:message name="RequestSecurityTokenResponseCollectionMsg"&gt;
    &lt;wsdl:part name="responseCollection"
               element="wst:RequestSecurityTokenResponseCollection"/&gt;
  &lt;/wsdl:message&gt;

  &lt;!-- This portType an example of a Requestor (or other) endpoint that
  Accepts SOAP-based challenges from a Security Token Service --&gt;
  &lt;wsdl:portType name="WSSecurityRequestor"&gt;
    &lt;wsdl:operation name="Challenge"&gt;
      &lt;wsdl:input message="tns:RequestSecurityTokenResponseMsg"/&gt;
      &lt;wsdl:output message="tns:RequestSecurityTokenResponseMsg"/&gt;
    &lt;/wsdl:operation&gt;
  &lt;/wsdl:portType&gt;

  &lt;!-- This portType is an example of an STS supporting full protocol --&gt;
  &lt;!--
      The wsdl:portType and data types are XML elements defined by the
      WS_Trust specification.  The wsdl:portType defines the endpoints
      supported in the STS implementation.  This WSDL defines all operations
      that an STS implementation can support.
  --&gt;
  &lt;wsdl:portType name="STS"&gt;
    &lt;wsdl:operation name="Cancel"&gt;
      &lt;wsdl:input
        wsam:Action="http://docs.oasis-open.org/ws-sx/ws-trust/200512/RST/Cancel"
        message="tns:RequestSecurityTokenMsg"/&gt;
      &lt;wsdl:output
        wsam:Action="http://docs.oasis-open.org/ws-sx/ws-trust/200512/RSTR/CancelFinal"
        message="tns:RequestSecurityTokenResponseMsg"/&gt;
    &lt;/wsdl:operation&gt;
    &lt;wsdl:operation name="Issue"&gt;
      &lt;wsdl:input
        wsam:Action="http://docs.oasis-open.org/ws-sx/ws-trust/200512/RST/Issue"
        message="tns:RequestSecurityTokenMsg"/&gt;
      &lt;wsdl:output
        wsam:Action="http://docs.oasis-open.org/ws-sx/ws-trust/200512/RSTRC/IssueFinal"
        message="tns:RequestSecurityTokenResponseCollectionMsg"/&gt;
    &lt;/wsdl:operation&gt;
    &lt;wsdl:operation name="Renew"&gt;
      &lt;wsdl:input
        wsam:Action="http://docs.oasis-open.org/ws-sx/ws-trust/200512/RST/Renew"
        message="tns:RequestSecurityTokenMsg"/&gt;
      &lt;wsdl:output
        wsam:Action="http://docs.oasis-open.org/ws-sx/ws-trust/200512/RSTR/RenewFinal"
        message="tns:RequestSecurityTokenResponseMsg"/&gt;
    &lt;/wsdl:operation&gt;
    &lt;wsdl:operation name="Validate"&gt;
      &lt;wsdl:input
        wsam:Action="http://docs.oasis-open.org/ws-sx/ws-trust/200512/RST/Validate"
        message="tns:RequestSecurityTokenMsg"/&gt;
      &lt;wsdl:output
        wsam:Action="http://docs.oasis-open.org/ws-sx/ws-trust/200512/RSTR/ValidateFinal"
        message="tns:RequestSecurityTokenResponseMsg"/&gt;
    &lt;/wsdl:operation&gt;
    &lt;wsdl:operation name="KeyExchangeToken"&gt;
      &lt;wsdl:input
        wsam:Action="http://docs.oasis-open.org/ws-sx/ws-trust/200512/RST/KET"
        message="tns:RequestSecurityTokenMsg"/&gt;
      &lt;wsdl:output
        wsam:Action="http://docs.oasis-open.org/ws-sx/ws-trust/200512/RSTR/KETFinal"
        message="tns:RequestSecurityTokenResponseMsg"/&gt;
    &lt;/wsdl:operation&gt;
    &lt;wsdl:operation name="RequestCollection"&gt;
      &lt;wsdl:input message="tns:RequestSecurityTokenCollectionMsg"/&gt;
      &lt;wsdl:output message="tns:RequestSecurityTokenResponseCollectionMsg"/&gt;
    &lt;/wsdl:operation&gt;
  &lt;/wsdl:portType&gt;

  &lt;!-- This portType is an example of an endpoint that accepts
  Unsolicited RequestSecurityTokenResponse messages --&gt;
  &lt;wsdl:portType name="SecurityTokenResponseService"&gt;
    &lt;wsdl:operation name="RequestSecurityTokenResponse"&gt;
      &lt;wsdl:input message="tns:RequestSecurityTokenResponseMsg"/&gt;
    &lt;/wsdl:operation&gt;
  &lt;/wsdl:portType&gt;

  &lt;!--
      The wsp:PolicyReference binds the security requirments on all the STS endpoints.
      The wsp:Policy wsu:Id="UT_policy" element is later in this file.
  --&gt;
  &lt;wsdl:binding name="UT_Binding" type="wstrust:STS"&gt;
    &lt;wsp:PolicyReference URI="#UT_policy"/&gt;
    &lt;soap:binding style="document"
                  transport="http://schemas.xmlsoap.org/soap/http"/&gt;
    &lt;wsdl:operation name="Issue"&gt;
      &lt;soap:operation
        soapAction="http://docs.oasis-open.org/ws-sx/ws-trust/200512/RST/Issue"/&gt;
      &lt;wsdl:input&gt;
        &lt;wsp:PolicyReference
          URI="#Input_policy"/&gt;
        &lt;soap:body use="literal"/&gt;
      &lt;/wsdl:input&gt;
      &lt;wsdl:output&gt;
        &lt;wsp:PolicyReference
          URI="#Output_policy"/&gt;
        &lt;soap:body use="literal"/&gt;
      &lt;/wsdl:output&gt;
    &lt;/wsdl:operation&gt;
    &lt;wsdl:operation name="Validate"&gt;
      &lt;soap:operation
        soapAction="http://docs.oasis-open.org/ws-sx/ws-trust/200512/RST/Validate"/&gt;
      &lt;wsdl:input&gt;
        &lt;wsp:PolicyReference
          URI="#Input_policy"/&gt;
        &lt;soap:body use="literal"/&gt;
      &lt;/wsdl:input&gt;
      &lt;wsdl:output&gt;
        &lt;wsp:PolicyReference
          URI="#Output_policy"/&gt;
        &lt;soap:body use="literal"/&gt;
      &lt;/wsdl:output&gt;
    &lt;/wsdl:operation&gt;
    &lt;wsdl:operation name="Cancel"&gt;
      &lt;soap:operation
        soapAction="http://docs.oasis-open.org/ws-sx/ws-trust/200512/RST/Cancel"/&gt;
      &lt;wsdl:input&gt;
        &lt;soap:body use="literal"/&gt;
      &lt;/wsdl:input&gt;
      &lt;wsdl:output&gt;
        &lt;soap:body use="literal"/&gt;
      &lt;/wsdl:output&gt;
    &lt;/wsdl:operation&gt;
    &lt;wsdl:operation name="Renew"&gt;
      &lt;soap:operation
        soapAction="http://docs.oasis-open.org/ws-sx/ws-trust/200512/RST/Renew"/&gt;
      &lt;wsdl:input&gt;
        &lt;soap:body use="literal"/&gt;
      &lt;/wsdl:input&gt;
      &lt;wsdl:output&gt;
        &lt;soap:body use="literal"/&gt;
      &lt;/wsdl:output&gt;
    &lt;/wsdl:operation&gt;
    &lt;wsdl:operation name="KeyExchangeToken"&gt;
      &lt;soap:operation
        soapAction="http://docs.oasis-open.org/ws-sx/ws-trust/200512/RST/KeyExchangeToken"/&gt;
      &lt;wsdl:input&gt;
        &lt;soap:body use="literal"/&gt;
      &lt;/wsdl:input&gt;
      &lt;wsdl:output&gt;
        &lt;soap:body use="literal"/&gt;
      &lt;/wsdl:output&gt;
    &lt;/wsdl:operation&gt;
    &lt;wsdl:operation name="RequestCollection"&gt;
      &lt;soap:operation
        soapAction="http://docs.oasis-open.org/ws-sx/ws-trust/200512/RST/RequestCollection"/&gt;
      &lt;wsdl:input&gt;
        &lt;soap:body use="literal"/&gt;
      &lt;/wsdl:input&gt;
      &lt;wsdl:output&gt;
        &lt;soap:body use="literal"/&gt;
      &lt;/wsdl:output&gt;
    &lt;/wsdl:operation&gt;
  &lt;/wsdl:binding&gt;

  &lt;wsdl:service name="SecurityTokenService"&gt;
    &lt;wsdl:port name="UT_Port" binding="tns:UT_Binding"&gt;
      &lt;soap:address location="http://localhost:8080/SecurityTokenService/UT"/&gt;
    &lt;/wsdl:port&gt;
  &lt;/wsdl:service&gt;


  &lt;wsp:Policy wsu:Id="UT_policy"&gt;
    &lt;wsp:ExactlyOne&gt;
      &lt;wsp:All&gt;
        &lt;!--
            The sp:UsingAddressing element, indicates that the endpoints of this
            web service conforms to the WS-Addressing specification.  More detail
            can be found here: [http://www.w3.org/TR/2006/CR-ws-addr-wsdl-20060529]
        --&gt;
        &lt;wsap10:UsingAddressing/&gt;
        &lt;!--
            The sp:SymmetricBinding element indicates that security is provided
            at the SOAP layer and any initiator must authenticate itself by providing
            WSS UsernameToken credentials.
        --&gt;
        &lt;sp:SymmetricBinding
          xmlns:sp="http://docs.oasis-open.org/ws-sx/ws-securitypolicy/200702"&gt;
          &lt;wsp:Policy&gt;
            &lt;!--
                In a symmetric binding, the keys used for encrypting and signing in both
                directions are derived from a single key, the one specified by the
                sp:ProtectionToken element.  The sp:X509Token sub-element declares this
                key to be a X.509 certificate and the
                IncludeToken="http://docs.oasis-open.org/ws-sx/ws-securitypolicy/200702/IncludeToken/Never"
                attribute adds the requirement that the token MUST NOT be included in
                any messages sent between the initiator and the recipient; rather, an
                external reference to the token should be used.  Lastly the WssX509V3Token10
                sub-element declares that the Username token presented by the initiator
                should be compliant with Web Services Security UsernameToken Profile
                1.0 specification. [ http://docs.oasis-open.org/wss/2004/01/oasis-200401-wss-username-token-profile-1.0.pdf ]
            --&gt;
            &lt;sp:ProtectionToken&gt;
              &lt;wsp:Policy&gt;
                &lt;sp:X509Token
                  sp:IncludeToken="http://docs.oasis-open.org/ws-sx/ws-securitypolicy/200702/IncludeToken/Never"&gt;
                  &lt;wsp:Policy&gt;
                    &lt;sp:RequireDerivedKeys/&gt;
                    &lt;sp:RequireThumbprintReference/&gt;
                    &lt;sp:WssX509V3Token10/&gt;
                  &lt;/wsp:Policy&gt;
                &lt;/sp:X509Token&gt;
              &lt;/wsp:Policy&gt;
            &lt;/sp:ProtectionToken&gt;
            &lt;!--
                The sp:AlgorithmSuite element, requires the Basic256 algorithm suite
                be used in performing cryptographic operations.
            --&gt;
            &lt;sp:AlgorithmSuite&gt;
              &lt;wsp:Policy&gt;
                &lt;sp:Basic256/&gt;
              &lt;/wsp:Policy&gt;
            &lt;/sp:AlgorithmSuite&gt;
            &lt;!--
                The sp:Layout element,  indicates the layout rules to apply when adding
                items to the security header.  The sp:Lax sub-element indicates items
                are added to the security header in any order that conforms to
                WSS: SOAP Message Security.
            --&gt;
            &lt;sp:Layout&gt;
              &lt;wsp:Policy&gt;
                &lt;sp:Lax/&gt;
              &lt;/wsp:Policy&gt;
            &lt;/sp:Layout&gt;
            &lt;sp:IncludeTimestamp/&gt;
            &lt;sp:EncryptSignature/&gt;
            &lt;sp:OnlySignEntireHeadersAndBody/&gt;
          &lt;/wsp:Policy&gt;
        &lt;/sp:SymmetricBinding&gt;

        &lt;!--
            The sp:SignedSupportingTokens element declares that the security header
            of messages must contain a sp:UsernameToken and the token must be signed.
            The attribute IncludeToken="http://docs.oasis-open.org/ws-sx/ws-securitypolicy/200702/IncludeToken/AlwaysToRecipient"
            on sp:UsernameToken indicates that the token MUST be included in all
            messages sent from initiator to the recipient and that the token MUST
            NOT be included in messages sent from the recipient to the initiator.
            And finally the element sp:WssUsernameToken10 is a policy assertion
            indicating the Username token should be as defined in  Web Services
            Security UsernameToken Profile 1.0
        --&gt;
        &lt;sp:SignedSupportingTokens
          xmlns:sp="http://docs.oasis-open.org/ws-sx/ws-securitypolicy/200702"&gt;
          &lt;wsp:Policy&gt;
            &lt;sp:UsernameToken
              sp:IncludeToken="http://docs.oasis-open.org/ws-sx/ws-securitypolicy/200702/IncludeToken/AlwaysToRecipient"&gt;
              &lt;wsp:Policy&gt;
                &lt;sp:WssUsernameToken10/&gt;
              &lt;/wsp:Policy&gt;
            &lt;/sp:UsernameToken&gt;
          &lt;/wsp:Policy&gt;
        &lt;/sp:SignedSupportingTokens&gt;
        &lt;!--
            The sp:Wss11 element declares WSS: SOAP Message Security 1.1 options
            to be supported by the STS.  These particular elements generally refer
            to how keys are referenced within the SOAP envelope.  These are normally
            handled by CXF.
        --&gt;
        &lt;sp:Wss11
          xmlns:sp="http://docs.oasis-open.org/ws-sx/ws-securitypolicy/200702"&gt;
          &lt;wsp:Policy&gt;
            &lt;sp:MustSupportRefKeyIdentifier/&gt;
            &lt;sp:MustSupportRefIssuerSerial/&gt;
            &lt;sp:MustSupportRefThumbprint/&gt;
            &lt;sp:MustSupportRefEncryptedKey/&gt;
          &lt;/wsp:Policy&gt;
        &lt;/sp:Wss11&gt;
        &lt;!--
            The sp:Trust13 element declares controls for WS-Trust 1.3 options.
            They are policy assertions related to exchanges specifically with
            client and server challenges and entropy behaviors.  Again these are
            normally handled by CXF.
        --&gt;
        &lt;sp:Trust13
          xmlns:sp="http://docs.oasis-open.org/ws-sx/ws-securitypolicy/200702"&gt;
          &lt;wsp:Policy&gt;
            &lt;sp:MustSupportIssuedTokens/&gt;
            &lt;sp:RequireClientEntropy/&gt;
            &lt;sp:RequireServerEntropy/&gt;
          &lt;/wsp:Policy&gt;
        &lt;/sp:Trust13&gt;
      &lt;/wsp:All&gt;
    &lt;/wsp:ExactlyOne&gt;
  &lt;/wsp:Policy&gt;

  &lt;wsp:Policy wsu:Id="Input_policy"&gt;
    &lt;wsp:ExactlyOne&gt;
      &lt;wsp:All&gt;
        &lt;sp:SignedParts
          xmlns:sp="http://docs.oasis-open.org/ws-sx/ws-securitypolicy/200702"&gt;
          &lt;sp:Body/&gt;
          &lt;sp:Header Name="To"
                     Namespace="http://www.w3.org/2005/08/addressing"/&gt;
          &lt;sp:Header Name="From"
                     Namespace="http://www.w3.org/2005/08/addressing"/&gt;
          &lt;sp:Header Name="FaultTo"
                     Namespace="http://www.w3.org/2005/08/addressing"/&gt;
          &lt;sp:Header Name="ReplyTo"
                     Namespace="http://www.w3.org/2005/08/addressing"/&gt;
          &lt;sp:Header Name="MessageID"
                     Namespace="http://www.w3.org/2005/08/addressing"/&gt;
          &lt;sp:Header Name="RelatesTo"
                     Namespace="http://www.w3.org/2005/08/addressing"/&gt;
          &lt;sp:Header Name="Action"
                     Namespace="http://www.w3.org/2005/08/addressing"/&gt;
        &lt;/sp:SignedParts&gt;
      &lt;/wsp:All&gt;
    &lt;/wsp:ExactlyOne&gt;
  &lt;/wsp:Policy&gt;

  &lt;wsp:Policy wsu:Id="Output_policy"&gt;
    &lt;wsp:ExactlyOne&gt;
      &lt;wsp:All&gt;
        &lt;sp:SignedParts
          xmlns:sp="http://docs.oasis-open.org/ws-sx/ws-securitypolicy/200702"&gt;
          &lt;sp:Body/&gt;
          &lt;sp:Header Name="To"
                     Namespace="http://www.w3.org/2005/08/addressing"/&gt;
          &lt;sp:Header Name="From"
                     Namespace="http://www.w3.org/2005/08/addressing"/&gt;
          &lt;sp:Header Name="FaultTo"
                     Namespace="http://www.w3.org/2005/08/addressing"/&gt;
          &lt;sp:Header Name="ReplyTo"
                     Namespace="http://www.w3.org/2005/08/addressing"/&gt;
          &lt;sp:Header Name="MessageID"
                     Namespace="http://www.w3.org/2005/08/addressing"/&gt;
          &lt;sp:Header Name="RelatesTo"
                     Namespace="http://www.w3.org/2005/08/addressing"/&gt;
          &lt;sp:Header Name="Action"
                     Namespace="http://www.w3.org/2005/08/addressing"/&gt;
        &lt;/sp:SignedParts&gt;
      &lt;/wsp:All&gt;
    &lt;/wsp:ExactlyOne&gt;
  &lt;/wsp:Policy&gt;

&lt;/wsdl:definitions&gt;</code></pre>
</div>
</div>
</div>
<div class="sect6">
<h7 id="stss-implementation-class-saml-bearer"><a class="anchor" href="#stss-implementation-class-saml-bearer"></a>STS&#8217;s implementation class</h7>
<div class="paragraph">
<p>The Apache CXF&#8217;s STS, SecurityTokenServiceProvider, is a web service
provider that is compliant with the protocols and functionality defined
by the WS-Trust specification. It has a modular architecture. Many of
its components are configurable or replaceable and there are many
optional features that are enabled by implementing and configuring
plug-ins. Users can customize their own STS by extending from
SecurityTokenServiceProvider and overriding the default settings.
Extensive information about the CXF&#8217;s STS configurable and pluggable
components can be found
<a href="http://coheigea.blogspot.com/2011/11/apache-cxf-sts-documentation-part-viii_10.html">here</a>.</p>
</div>
<div class="paragraph">
<p>This STS implementation class, SampleSTSBearer, is a POJO that extends
from SecurityTokenServiceProvider. Note that the class is defined with a
WebServiceProvider annotation and not a WebService annotation. This
annotation defines the service as a Provider-based endpoint, meaning it
supports a more messaging-oriented approach to Web services. In
particular, it signals that the exchanged messages will be XML documents
of some type. SecurityTokenServiceProvider is an implementation of the
javax.xml.ws.Provider interface. In comparison the WebService annotation
defines a (service endpoint interface) SEI-based endpoint which supports
message exchange via SOAP envelopes.</p>
</div>
<div class="paragraph">
<p>As was done in the BearerImpl class, the WSS4J annotations
EndpointProperties and EndpointProperty are providing endpoint
configuration for the CXF runtime. The first EndpointProperty statement
in the listing is declaring the user&#8217;s name to use for the message
signature. It is used as the alias name in the keystore to get the
user&#8217;s cert and private key for signature. The next two EndpointProperty
statements declares the Java properties file that contains the (Merlin)
crypto configuration information. In this case both for signing and
encrypting the messages. WSS4J reads this file and extra required
information for message handling. The last EndpointProperty statement
declares the STSBearerCallbackHandler implementation class. It is used
to obtain the user&#8217;s password for the certificates in the keystore file.</p>
</div>
<div class="paragraph">
<p>In this implementation we are customizing the operations of token
issuance, token validation and their static properties.</p>
</div>
<div class="paragraph">
<p>StaticSTSProperties is used to set select properties for configuring
resources in the STS. You may think this is a duplication of the
settings made with the WSS4J annotations. The values are the same but
the underlaying structures being set are different, thus this
information must be declared in both places.</p>
</div>
<div class="paragraph">
<p>The setIssuer setting is important because it uniquely identifies the
issuing STS. The issuer string is embedded in issued tokens and, when
validating tokens, the STS checks the issuer string value. Consequently,
it is important to use the issuer string in a consistent way, so that
the STS can recognize the tokens that it has issued.</p>
</div>
<div class="paragraph">
<p>The setEndpoints call allows the declaration of a set of allowed token
recipients by address. The addresses are specified as reg-ex patterns.</p>
</div>
<div class="paragraph">
<p>TokenIssueOperation has a modular structure. This allows custom
behaviors to be injected into the processing of messages. In this case
we are overriding the SecurityTokenServiceProvider&#8217;s default behavior
and performing SAML token processing. CXF provides an implementation of
a SAMLTokenProvider which we are using rather than writing our own.</p>
</div>
<div class="paragraph">
<p>Learn more about the SAMLTokenProvider
<a href="http://coheigea.blogspot.it/2011/10/apache-cxf-sts-documentation-part-iv.html">here</a>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">package org.jboss.test.ws.jaxws.samples.wsse.policy.trust.stsbearer;

import org.apache.cxf.annotations.EndpointProperties;
import org.apache.cxf.annotations.EndpointProperty;
import org.apache.cxf.sts.StaticSTSProperties;
import org.apache.cxf.sts.operation.TokenIssueOperation;
import org.apache.cxf.sts.service.ServiceMBean;
import org.apache.cxf.sts.service.StaticService;
import org.apache.cxf.sts.token.provider.SAMLTokenProvider;
import org.apache.cxf.ws.security.sts.provider.SecurityTokenServiceProvider;

import javax.xml.ws.WebServiceProvider;
import java.util.Arrays;
import java.util.LinkedList;
import java.util.List;

@WebServiceProvider(serviceName = "SecurityTokenService",
      portName = "UT_Port",
      targetNamespace = "http://docs.oasis-open.org/ws-sx/ws-trust/200512/",
      wsdlLocation = "WEB-INF/wsdl/bearer-ws-trust-1.4-service.wsdl")
//be sure to have dependency on org.apache.cxf module when on AS7, otherwise Apache CXF annotations are ignored
@EndpointProperties(value = {
      @EndpointProperty(key = "ws-security.signature.username", value = "mystskey"),
      @EndpointProperty(key = "ws-security.signature.properties", value = "stsKeystore.properties"),
      @EndpointProperty(key = "ws-security.callback-handler", value = "org.jboss.test.ws.jaxws.samples.wsse.policy.trust.stsbearer.STSBearerCallbackHandler")
})
public class SampleSTSBearer extends SecurityTokenServiceProvider
{

   public SampleSTSBearer() throws Exception
   {
      super();

      StaticSTSProperties props = new StaticSTSProperties();
      props.setSignatureCryptoProperties("stsKeystore.properties");
      props.setSignatureUsername("mystskey");
      props.setCallbackHandlerClass(STSBearerCallbackHandler.class.getName());
      props.setEncryptionCryptoProperties("stsKeystore.properties");
      props.setEncryptionUsername("myservicekey");
      props.setIssuer("DoubleItSTSIssuer");

      List&lt;ServiceMBean&gt; services = new LinkedList&lt;ServiceMBean&gt;();
      StaticService service = new StaticService();
      service.setEndpoints(Arrays.asList(
         "https://localhost:(\\d)*/jaxws-samples-wsse-policy-trust-bearer/BearerService",
         "https://\\[::1\\]:(\\d)*/jaxws-samples-wsse-policy-trust-bearer/BearerService",
         "https://\\[0:0:0:0:0:0:0:1\\]:(\\d)*/jaxws-samples-wsse-policy-trust-bearer/BearerService"
      ));
      services.add(service);

      TokenIssueOperation issueOperation = new TokenIssueOperation();
      issueOperation.getTokenProviders().add(new SAMLTokenProvider());
      issueOperation.setServices(services);
      issueOperation.setStsProperties(props);
      this.setIssueOperation(issueOperation);
   }
}</code></pre>
</div>
</div>
</div>
<div class="sect6">
<h7 id="stsbearercallbackhandler-saml-bearer"><a class="anchor" href="#stsbearercallbackhandler-saml-bearer"></a>STSBearerCallbackHandler</h7>
<div class="paragraph">
<p>STSBearerCallbackHandler is a callback handler for the WSS4J Crypto API.
It is used to obtain the password for the private key in the keystore.
This class enables CXF to retrieve the password of the user name to use
for the message signature.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">package org.jboss.test.ws.jaxws.samples.wsse.policy.trust.stsbearer;

import org.jboss.wsf.stack.cxf.extensions.security.PasswordCallbackHandler;

import java.util.HashMap;
import java.util.Map;

public class STSBearerCallbackHandler extends PasswordCallbackHandler
{
   public STSBearerCallbackHandler()
   {
      super(getInitMap());
   }

   private static Map&lt;String, String&gt; getInitMap()
   {
      Map&lt;String, String&gt; passwords = new HashMap&lt;String, String&gt;();
      passwords.put("mystskey", "stskpass");
      passwords.put("alice", "clarinet");
      return passwords;
   }
}</code></pre>
</div>
</div>
</div>
<div class="sect6">
<h7 id="crypto-properties-and-keystore-files-saml-bearer-1"><a class="anchor" href="#crypto-properties-and-keystore-files-saml-bearer-1"></a>Crypto properties and keystore files</h7>
<div class="paragraph">
<p>WSS4J&#8217;s Crypto implementation is loaded and configured via a Java
properties file that contains Crypto configuration data. The file
contains implementation-specific properties such as a keystore location,
password, default alias and the like. This application is using the
Merlin implementation. File stsKeystore.properties contains this
information.</p>
</div>
<div class="paragraph">
<p>File servicestore.jks, is a Java KeyStore (JKS) repository. It contains
self signed certificates for myservicekey and mystskey. <em>Self signed
certificates are not appropriate for production use.</em></p>
</div>
<div class="literalblock">
<div class="content">
<pre>org.apache.ws.security.crypto.provider=org.apache.ws.security.components.crypto.Merlin
org.apache.ws.security.crypto.merlin.keystore.type=jks
org.apache.ws.security.crypto.merlin.keystore.password=stsspass
org.apache.ws.security.crypto.merlin.keystore.file=stsstore.jks</pre>
</div>
</div>
</div>
<div class="sect6">
<h7 id="manifest-mf-saml-bearer-1"><a class="anchor" href="#manifest-mf-saml-bearer-1"></a>MANIFEST.MF</h7>
<div class="paragraph">
<p>When deployed on WildFly, this application requires access to the
JBossWs and CXF APIs provided in modules
org.jboss.ws.cxf.jbossws-cxf-client and org.apache.cxf. The Apache CXF
internals, org.apache.cxf.impl, are needed to build the STS
configuration in the <code>SampleSTS</code> constructor. The dependency statement
directs the server to provide them at deployment.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>Manifest-Version: 1.0
Ant-Version: Apache Ant 1.8.2
Created-By: 1.7.0_25-b15 (Oracle Corporation)
Dependencies: org.jboss.ws.cxf.jbossws-cxf-client,org.apache.cxf.impl</pre>
</div>
</div>
</div>
</div>
<div class="sect5">
<h6 id="web-service-requester-saml-bearer"><a class="anchor" href="#web-service-requester-saml-bearer"></a>Web service requester</h6>
<div class="paragraph">
<p>This section examines the crucial elements in calling a web service that
implements endpoint security as described in the SAML Bearer scenario.
The components that will be discussed are.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Web service requester&#8217;s implementation</p>
</li>
<li>
<p>ClientCallbackHandler</p>
</li>
<li>
<p>Crypto properties and keystore files</p>
</li>
</ul>
</div>
<div class="sect6">
<h7 id="web-service-requester-implementation-saml-bearer"><a class="anchor" href="#web-service-requester-implementation-saml-bearer"></a>Web service requester Implementation</h7>
<div class="paragraph">
<p>The ws-requester, the client, uses standard procedures for creating a
reference to the web service. To address the endpoint security
requirements, the web service&#8217;s "Request Context" is configured with the
information needed in message generation. In addition, the STSClient
that communicates with the STS is configured with similar values. Note
the key strings ending with a ".it" suffix. This suffix flags these
settings as belonging to the STSClient. The internal CXF code assigns
this information to the STSClient that is auto-generated for this
service call.</p>
</div>
<div class="paragraph">
<p>There is an alternate method of setting up the STSCLient. The user may
provide their own instance of the STSClient. The CXF code will use this
object and not auto-generate one. When providing the STSClient in this
way, the user must provide a org.apache.cxf.Bus for it and the
configuration keys must not have the ".it" suffix. This is used in the
ActAs and OnBehalfOf examples.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">  String serviceURL = "https://" + getServerHost() + ":8443/jaxws-samples-wsse-policy-trust-bearer/BearerService";

  final QName serviceName = new QName("http://www.jboss.org/jbossws/ws-extensions/bearerwssecuritypolicy", "BearerService");
  Service service = Service.create(new URL(serviceURL + "?wsdl"), serviceName);
  BearerIface proxy = (BearerIface) service.getPort(BearerIface.class);

  Map&lt;String, Object&gt; ctx = ((BindingProvider)proxy).getRequestContext();

  // set the security related configuration information for the service "request"
  ctx.put(SecurityConstants.CALLBACK_HANDLER, new ClientCallbackHandler());
  ctx.put(SecurityConstants.SIGNATURE_PROPERTIES,
    Thread.currentThread().getContextClassLoader().getResource(
    "META-INF/clientKeystore.properties"));
  ctx.put(SecurityConstants.ENCRYPT_PROPERTIES,
    Thread.currentThread().getContextClassLoader().getResource(
    "META-INF/clientKeystore.properties"));
  ctx.put(SecurityConstants.SIGNATURE_USERNAME, "myclientkey");
  ctx.put(SecurityConstants.ENCRYPT_USERNAME, "myservicekey");

  //-- Configuration settings that will be transfered to the STSClient
  // "alice" is the name provided for the WSS Username. Her password will
  // be retreived from the ClientCallbackHander by the STSClient.
  ctx.put(SecurityConstants.USERNAME + ".it", "alice");
  ctx.put(SecurityConstants.CALLBACK_HANDLER + ".it", new ClientCallbackHandler());
  ctx.put(SecurityConstants.ENCRYPT_PROPERTIES + ".it",
    Thread.currentThread().getContextClassLoader().getResource(
    "META-INF/clientKeystore.properties"));
  ctx.put(SecurityConstants.ENCRYPT_USERNAME + ".it", "mystskey");
  ctx.put(SecurityConstants.STS_TOKEN_USERNAME + ".it", "myclientkey");
  ctx.put(SecurityConstants.STS_TOKEN_PROPERTIES + ".it",
    Thread.currentThread().getContextClassLoader().getResource(
    "META-INF/clientKeystore.properties"));
  ctx.put(SecurityConstants.STS_TOKEN_USE_CERT_FOR_KEYINFO + ".it", "true");

  proxy.sayHello();</code></pre>
</div>
</div>
</div>
<div class="sect6">
<h7 id="clientcallbackhandler-saml-bearer"><a class="anchor" href="#clientcallbackhandler-saml-bearer"></a>ClientCallbackHandler</h7>
<div class="paragraph">
<p><a href="https://docs.jboss.org/author/display/JBWS/WS-Trust+and+STS#WS-TrustandSTS-ClientCallbackHandler" class="bare">https://docs.jboss.org/author/display/JBWS/WS-Trust+and+STS#WS-TrustandSTS-ClientCallbackHandler</a></p>
</div>
<div class="paragraph">
<p>ClientCallbackHandler is a callback handler for the WSS4J Crypto API. It
is used to obtain the password for the private key in the keystore. This
class enables CXF to retrieve the password of the user name to use for
the message signature. Note that "alice" and her password have been
provided here. This information is not in the (JKS) keystore but
provided in the WildFly security domain. It was declared in file
jbossws-users.properties.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">package org.jboss.test.ws.jaxws.samples.wsse.policy.trust.shared;

import java.io.IOException;
import javax.security.auth.callback.Callback;
import javax.security.auth.callback.CallbackHandler;
import javax.security.auth.callback.UnsupportedCallbackException;
import org.apache.ws.security.WSPasswordCallback;

public class ClientCallbackHandler implements CallbackHandler {

    public void handle(Callback[] callbacks) throws IOException,
            UnsupportedCallbackException {
        for (int i = 0; i &lt; callbacks.length; i++) {
            if (callbacks[i] instanceof WSPasswordCallback) {
                WSPasswordCallback pc = (WSPasswordCallback) callbacks[i];
                if ("myclientkey".equals(pc.getIdentifier())) {
                    pc.setPassword("ckpass");
                    break;
                } else if ("alice".equals(pc.getIdentifier())) {
                    pc.setPassword("clarinet");
                    break;
                } else if ("bob".equals(pc.getIdentifier())) {
                    pc.setPassword("trombone");
                    break;
                } else if ("myservicekey".equals(pc.getIdentifier())) {  // rls test  added for bearer test
                   pc.setPassword("skpass");
                   break;
                }
            }
        }
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect6">
<h7 id="crypto-properties-and-keystore-files-saml-bearer-2"><a class="anchor" href="#crypto-properties-and-keystore-files-saml-bearer-2"></a>Crypto properties and keystore files</h7>
<div class="paragraph">
<p><a href="https://docs.jboss.org/author/display/JBWS/WS-Trust+and+STS#WS-TrustandSTS-RequesterCryptopropertiesandkeystorefiles" class="bare">https://docs.jboss.org/author/display/JBWS/WS-Trust+and+STS#WS-TrustandSTS-RequesterCryptopropertiesandkeystorefiles</a></p>
</div>
<div class="paragraph">
<p>WSS4J&#8217;s Crypto implementation is loaded and configured via a Java
properties file that contains Crypto configuration data. The file
contains implementation-specific properties such as a keystore location,
password, default alias and the like. This application is using the
Merlin implementation. File clientKeystore.properties contains this
information.</p>
</div>
<div class="paragraph">
<p>File clientstore.jks, is a Java KeyStore (JKS) repository. It contains
self signed certificates for myservicekey and mystskey. <em>Self signed
certificates are not appropriate for production use.</em></p>
</div>
<div class="literalblock">
<div class="content">
<pre>org.apache.ws.security.crypto.provider=org.apache.ws.security.components.crypto.Merlin
org.apache.ws.security.crypto.merlin.keystore.type=jks
org.apache.ws.security.crypto.merlin.keystore.password=cspass
org.apache.ws.security.crypto.merlin.keystore.alias=myclientkey
org.apache.ws.security.crypto.merlin.keystore.file=META-INF/clientstore.jks</pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="SAML_Holder-Of-Key_Assertion_Scenario"><a class="anchor" href="#SAML_Holder-Of-Key_Assertion_Scenario"></a>SAML Holder-Of-Key Assertion Scenario</h5>
<div class="paragraph">
<p>WS-Trust deals with managing software security tokens. A SAML assertion
is a type of security token. In the Holder-Of-Key method, the STS
creates a SAML token containing the client&#8217;s public key and signs the
SAML token with its private key. The client includes the SAML token and
signs the outgoing soap envelope to the web service with its private
key. The web service validates the SOAP message and the SAML token.</p>
</div>
<div class="paragraph">
<p>Implementation of this scenario has the following requirements.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>SAML tokens with a Holder-Of-Key subject confirmation method must be
protected so the token can not be snooped. In most cases, a
Holder-Of-Key token combined with HTTPS is sufficient to prevent "a man
in the middle" getting possession of the token. This means a security
policy that uses a sp:TransportBinding and sp:HttpsToken.</p>
</li>
<li>
<p>A Holder-Of-Key token has no encryption or signing keys associated
with it, therefore a sp:IssuedToken of SymmetricKey or PublicKey keyType
should be used with a sp:SignedEndorsingSupportingTokens.</p>
</li>
</ul>
</div>
<div class="sect5">
<h6 id="web-service-provider-5"><a class="anchor" href="#web-service-provider-5"></a>Web service Provider</h6>
<div class="paragraph">
<p>This section examines the web service elements for the SAML
Holder-Of-Key scenario. The components are</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Web service provider&#8217;s WSDL</p>
</li>
<li>
<p>SSL configuration</p>
</li>
<li>
<p>Web service provider&#8217;s Interface and Implementation classes.</p>
</li>
<li>
<p>Crypto properties and keystore files</p>
</li>
<li>
<p>MANIFEST.MF</p>
</li>
</ul>
</div>
<div class="sect6">
<h7 id="web-service-provider-wsdl-5"><a class="anchor" href="#web-service-provider-wsdl-5"></a>Web service provider WSDL</h7>
<div class="paragraph">
<p>The web service provider is a contract-first endpoint. All the WS-trust
and security policies for it are declared in the WSDL,
HolderOfKeyService.wsdl. For this scenario a ws-requester is required to
present a SAML 2.0 token of SymmetricKey keyType, issued from a designed
STS. The address of the STS is provided in the WSDL. A transport binding
policy is used. The token is declared to be signed and endorsed,
sp:SignedEndorsingSupportingTokens. A detailed explanation of the
security settings are provided in the comments in the listing below.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;?xml version="1.0" encoding="UTF-8" standalone="yes"?&gt;
&lt;definitions targetNamespace="http://www.jboss.org/jbossws/ws-extensions/holderofkeywssecuritypolicy"
             name="HolderOfKeyService"
        xmlns:tns="http://www.jboss.org/jbossws/ws-extensions/holderofkeywssecuritypolicy"
        xmlns:xsd="http://www.w3.org/2001/XMLSchema"
        xmlns:soap="http://schemas.xmlsoap.org/wsdl/soap/"
        xmlns="http://schemas.xmlsoap.org/wsdl/"
        xmlns:wsp="http://www.w3.org/ns/ws-policy"
        xmlns:wsam="http://www.w3.org/2007/05/addressing/metadata"
    xmlns:wsu="http://docs.oasis-open.org/wss/2004/01/oasis-200401-wss-wssecurity-utility-1.0.xsd"
    xmlns:wsaws="http://www.w3.org/2005/08/addressing"
    xmlns:wsx="http://schemas.xmlsoap.org/ws/2004/09/mex"
    xmlns:sp="http://docs.oasis-open.org/ws-sx/ws-securitypolicy/200702"
    xmlns:t="http://docs.oasis-open.org/ws-sx/ws-trust/200512"&gt;

  &lt;types&gt;
    &lt;xsd:schema&gt;
      &lt;xsd:import namespace="http://www.jboss.org/jbossws/ws-extensions/holderofkeywssecuritypolicy"
                  schemaLocation="HolderOfKeyService_schema1.xsd"/&gt;
    &lt;/xsd:schema&gt;
  &lt;/types&gt;
  &lt;message name="sayHello"&gt;
    &lt;part name="parameters" element="tns:sayHello"/&gt;
  &lt;/message&gt;
  &lt;message name="sayHelloResponse"&gt;
    &lt;part name="parameters" element="tns:sayHelloResponse"/&gt;
  &lt;/message&gt;
  &lt;portType name="HolderOfKeyIface"&gt;
    &lt;operation name="sayHello"&gt;
      &lt;input message="tns:sayHello"/&gt;
      &lt;output message="tns:sayHelloResponse"/&gt;
    &lt;/operation&gt;
  &lt;/portType&gt;
&lt;!--
        The wsp:PolicyReference binds the security requirments on all the endpoints.
        The wsp:Policy wsu:Id="#TransportSAML2HolderOfKeyPolicy" element is defined later in this file.
--&gt;
  &lt;binding name="HolderOfKeyServicePortBinding" type="tns:HolderOfKeyIface"&gt;
    &lt;wsp:PolicyReference URI="#TransportSAML2HolderOfKeyPolicy" /&gt;
    &lt;soap:binding transport="http://schemas.xmlsoap.org/soap/http" style="document"/&gt;
    &lt;operation name="sayHello"&gt;
      &lt;soap:operation soapAction=""/&gt;
      &lt;input&gt;
        &lt;soap:body use="literal"/&gt;
      &lt;/input&gt;
      &lt;output&gt;
        &lt;soap:body use="literal"/&gt;
      &lt;/output&gt;
    &lt;/operation&gt;
  &lt;/binding&gt;
&lt;!--
  The soap:address has been defined to use JBoss's https port, 8443.  This is
  set in conjunction with the sp:TransportBinding policy for https.
--&gt;
  &lt;service name="HolderOfKeyService"&gt;
    &lt;port name="HolderOfKeyServicePort" binding="tns:HolderOfKeyServicePortBinding"&gt;
      &lt;soap:address location="https://@jboss.bind.address@:8443/jaxws-samples-wsse-policy-trust-holderofkey/HolderOfKeyService"/&gt;
    &lt;/port&gt;
  &lt;/service&gt;


  &lt;wsp:Policy wsu:Id="TransportSAML2HolderOfKeyPolicy"&gt;
    &lt;wsp:ExactlyOne&gt;
      &lt;wsp:All&gt;
  &lt;!--
        The wsam:Addressing element, indicates that the endpoints of this
        web service MUST conform to the WS-Addressing specification.  The
        attribute wsp:Optional="false" enforces this assertion.
  --&gt;
        &lt;wsam:Addressing wsp:Optional="false"&gt;
          &lt;wsp:Policy /&gt;
        &lt;/wsam:Addressing&gt;
&lt;!--
  The sp:TransportBinding element indicates that security is provided by the
  message exchange transport medium, https.  WS-Security policy specification
  defines the sp:HttpsToken for use in exchanging messages transmitted over HTTPS.
--&gt;
          &lt;sp:TransportBinding
            xmlns:sp="http://docs.oasis-open.org/ws-sx/ws-securitypolicy/200702"&gt;
            &lt;wsp:Policy&gt;
              &lt;sp:TransportToken&gt;
                &lt;wsp:Policy&gt;
                  &lt;sp:HttpsToken&gt;
                    &lt;wsp:Policy/&gt;
                  &lt;/sp:HttpsToken&gt;
                &lt;/wsp:Policy&gt;
              &lt;/sp:TransportToken&gt;
&lt;!--
     The sp:AlgorithmSuite element, requires the TripleDes algorithm suite
     be used in performing cryptographic operations.
--&gt;
              &lt;sp:AlgorithmSuite&gt;
                &lt;wsp:Policy&gt;
                  &lt;sp:TripleDes /&gt;
                &lt;/wsp:Policy&gt;
              &lt;/sp:AlgorithmSuite&gt;
&lt;!--
     The sp:Layout element,  indicates the layout rules to apply when adding
     items to the security header.  The sp:Lax sub-element indicates items
     are added to the security header in any order that conforms to
     WSS: SOAP Message Security.
--&gt;
              &lt;sp:Layout&gt;
                &lt;wsp:Policy&gt;
                  &lt;sp:Lax /&gt;
                &lt;/wsp:Policy&gt;
              &lt;/sp:Layout&gt;
              &lt;sp:IncludeTimestamp /&gt;
            &lt;/wsp:Policy&gt;
          &lt;/sp:TransportBinding&gt;

&lt;!--
  The sp:SignedEndorsingSupportingTokens, when transport level security level is
  used there will be no message signature and the signature generated by the
  supporting token will sign the Timestamp.
--&gt;
        &lt;sp:SignedEndorsingSupportingTokens
          xmlns:sp="http://docs.oasis-open.org/ws-sx/ws-securitypolicy/200702"&gt;
          &lt;wsp:Policy&gt;
&lt;!--
  The sp:IssuedToken element asserts that a SAML 2.0 security token of type
  Bearer is expected from the STS.  The
  sp:IncludeToken="http://docs.oasis-open.org/ws-sx/ws-securitypolicy/200702/IncludeToken/AlwaysToRecipient"&gt;
  attribute instructs the runtime to include the initiator's public key
  with every message sent to the recipient.

  The sp:RequestSecurityTokenTemplate element directs that all of the
  children of this element will be copied directly into the body of the
  RequestSecurityToken (RST) message that is sent to the STS when the
  initiator asks the STS to issue a token.
--&gt;
            &lt;sp:IssuedToken
              sp:IncludeToken="http://docs.oasis-open.org/ws-sx/ws-securitypolicy/200702/IncludeToken/AlwaysToRecipient"&gt;
              &lt;sp:RequestSecurityTokenTemplate&gt;
                &lt;t:TokenType&gt;http://docs.oasis-open.org/wss/oasis-wss-saml-token-profile-1.1#SAMLV2.0&lt;/t:TokenType&gt;
 &lt;!--
   KeyType of "SymmetricKey", the client must prove to the WS service that it
   possesses a particular symmetric session key.
 --&gt;
                &lt;t:KeyType&gt;http://docs.oasis-open.org/ws-sx/ws-trust/200512/SymmetricKey&lt;/t:KeyType&gt;
              &lt;/sp:RequestSecurityTokenTemplate&gt;
              &lt;wsp:Policy&gt;
                &lt;sp:RequireInternalReference /&gt;
              &lt;/wsp:Policy&gt;
&lt;!--
  The sp:Issuer element defines the STS's address and endpoint information
  This information is used by the STSClient.
--&gt;
              &lt;sp:Issuer&gt;
                &lt;wsaws:Address&gt;http://@jboss.bind.address@:8080/jaxws-samples-wsse-policy-trust-sts-holderofkey/SecurityTokenService&lt;/wsaws:Address&gt;
                &lt;wsaws:Metadata
                  xmlns:wsdli="http://www.w3.org/2006/01/wsdl-instance"
                  wsdli:wsdlLocation="http://@jboss.bind.address@:8080/jaxws-samples-wsse-policy-trust-sts-holderofkey/SecurityTokenService?wsdl"&gt;
                  &lt;wsaw:ServiceName
                    xmlns:wsaw="http://www.w3.org/2006/05/addressing/wsdl"
                    xmlns:stsns="http://docs.oasis-open.org/ws-sx/ws-trust/200512/"
                    EndpointName="UT_Port"&gt;stsns:SecurityTokenService&lt;/wsaw:ServiceName&gt;
                &lt;/wsaws:Metadata&gt;
              &lt;/sp:Issuer&gt;

            &lt;/sp:IssuedToken&gt;
          &lt;/wsp:Policy&gt;
        &lt;/sp:SignedEndorsingSupportingTokens&gt;
&lt;!--
    The sp:Wss11 element declares WSS: SOAP Message Security 1.1 options
    to be supported by the STS.  These particular elements generally refer
    to how keys are referenced within the SOAP envelope.  These are normally
    handled by CXF.
--&gt;
        &lt;sp:Wss11&gt;
          &lt;wsp:Policy&gt;
            &lt;sp:MustSupportRefIssuerSerial /&gt;
            &lt;sp:MustSupportRefThumbprint /&gt;
            &lt;sp:MustSupportRefEncryptedKey /&gt;
          &lt;/wsp:Policy&gt;
        &lt;/sp:Wss11&gt;
&lt;!--
    The sp:Trust13 element declares controls for WS-Trust 1.3 options.
    They are policy assertions related to exchanges specifically with
    client and server challenges and entropy behaviors.  Again these are
    normally handled by CXF.
--&gt;
        &lt;sp:Trust13&gt;
          &lt;wsp:Policy&gt;
            &lt;sp:MustSupportIssuedTokens /&gt;
            &lt;sp:RequireClientEntropy /&gt;
            &lt;sp:RequireServerEntropy /&gt;
          &lt;/wsp:Policy&gt;
        &lt;/sp:Trust13&gt;
      &lt;/wsp:All&gt;
    &lt;/wsp:ExactlyOne&gt;
  &lt;/wsp:Policy&gt;

&lt;/definitions&gt;</code></pre>
</div>
</div>
</div>
<div class="sect6">
<h7 id="ssl-configuration-saml-holder"><a class="anchor" href="#ssl-configuration-saml-holder"></a>SSL configuration</h7>
<div class="paragraph">
<p><a href="https://docs.jboss.org/author/display/JBWS/WS-Trust+and+STS#WS-TrustandSTS-SSLconfiguration" class="bare">https://docs.jboss.org/author/display/JBWS/WS-Trust+and+STS#WS-TrustandSTS-SSLconfiguration</a></p>
</div>
<div class="paragraph">
<p>This web service is using https, therefore the JBoss server must be
configured to provide SSL support in the Web subsystem. There are 2
components to SSL configuration.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>create a certificate keystore</p>
</li>
<li>
<p>declare an SSL connector in the Web subsystem of the JBoss server
configuration file.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Follow the directions in the, " <em>Using the pure Java implementation
supplied by JSSE</em>" section in the link:#[SSL Setup
Guide|../../../../../../../../../../display/WFLY8/SSL+setup+guide|||\].</p>
</div>
<div class="paragraph">
<p>Here is an example of an SSL connector declaration.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">&lt;subsystem xmlns="urn:jboss:domain:web:1.4" default-virtual-server="default-host" native="false"&gt;
.....
  &lt;connector name="jbws-https-connector" protocol="HTTP/1.1" scheme="https" socket-binding="https" secure="true" enabled="true"&gt;
    &lt;ssl key-alias="tomcat" password="changeit" certificate-key-file="/myJbossHome/security/test.keystore" verify-client="false"/&gt;
  &lt;/connector&gt;
...</code></pre>
</div>
</div>
</div>
<div class="sect6">
<h7 id="web-service-interface-saml-holder"><a class="anchor" href="#web-service-interface-saml-holder"></a>Web service Interface</h7>
<div class="paragraph">
<p>The web service provider interface class, HolderOfKeyIface, is a simple
straight forward web service definition.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">package org.jboss.test.ws.jaxws.samples.wsse.policy.trust.holderofkey;

import javax.jws.WebMethod;
import javax.jws.WebService;

@WebService
(
   targetNamespace = "http://www.jboss.org/jbossws/ws-extensions/holderofkeywssecuritypolicy"
)
public interface HolderOfKeyIface {
   @WebMethod
   String sayHello();
}</code></pre>
</div>
</div>
</div>
<div class="sect6">
<h7 id="web-service-implementation-saml-holder"><a class="anchor" href="#web-service-implementation-saml-holder"></a>Web service Implementation</h7>
<div class="paragraph">
<p>The web service provider implementation class, HolderOfKeyImpl, is a
simple POJO. It uses the standard WebService annotation to define the
service endpoint. In addition there are two Apache CXF annotations,
EndpointProperties and EndpointProperty used for configuring the
endpoint for the CXF runtime. These annotations come from the
<a href="https://ws.apache.org/wss4j/">Apache WSS4J project</a>, which provides a
Java implementation of the primary WS-Security standards for Web
Services. These annotations are programmatically adding properties to
the endpoint. With plain Apache CXF, these properties are often set via
the &lt;jaxws:properties&gt; element on the &lt;jaxws:endpoint&gt; element in the
Spring config; these annotations allow the properties to be configured
in the code.</p>
</div>
<div class="paragraph">
<p>WSS4J uses the Crypto interface to get keys and certificates for
signature creation/verification, as is asserted by the WSDL for this
service. The WSS4J configuration information being provided by
HolderOfKeyImpl is for Crypto&#8217;s Merlin implementation. More information
will be provided about this in the keystore section.</p>
</div>
<div class="paragraph">
<p>The first EndpointProperty statement in the listing disables ensurance
of compliance with the Basic Security Profile 1.1. The next
EndpointProperty statements declares the Java properties file that
contains the (Merlin) crypto configuration information. The last
EndpointProperty statement declares the STSHolderOfKeyCallbackHandler
implementation class. It is used to obtain the user&#8217;s password for the
certificates in the keystore file.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">package org.jboss.test.ws.jaxws.samples.wsse.policy.trust.holderofkey;

import org.apache.cxf.annotations.EndpointProperties;
import org.apache.cxf.annotations.EndpointProperty;

import javax.jws.WebService;

@WebService
   (
      portName = "HolderOfKeyServicePort",
      serviceName = "HolderOfKeyService",
      wsdlLocation = "WEB-INF/wsdl/HolderOfKeyService.wsdl",
      targetNamespace = "http://www.jboss.org/jbossws/ws-extensions/holderofkeywssecuritypolicy",
      endpointInterface = "org.jboss.test.ws.jaxws.samples.wsse.policy.trust.holderofkey.HolderOfKeyIface"
   )
@EndpointProperties(value = {
   @EndpointProperty(key = "ws-security.is-bsp-compliant", value = "false"),
   @EndpointProperty(key = "ws-security.signature.properties", value = "serviceKeystore.properties"),
   @EndpointProperty(key = "ws-security.callback-handler", value = "org.jboss.test.ws.jaxws.samples.wsse.policy.trust.holderofkey.HolderOfKeyCallbackHandler")
})
public class HolderOfKeyImpl implements HolderOfKeyIface
{
   public String sayHello()
   {
      return "Holder-Of-Key WS-Trust Hello World!";
   }
}</code></pre>
</div>
</div>
</div>
<div class="sect6">
<h7 id="crypto-properties-and-keystore-files-saml-holder"><a class="anchor" href="#crypto-properties-and-keystore-files-saml-holder"></a>Crypto properties and keystore files</h7>
<div class="paragraph">
<p>WSS4J&#8217;s Crypto implementation is loaded and configured via a Java
properties file that contains Crypto configuration data. The file
contains implementation-specific properties such as a keystore location,
password, default alias and the like. This application is using the
Merlin implementation. File serviceKeystore.properties contains this
information.</p>
</div>
<div class="paragraph">
<p>File servicestore.jks, is a Java KeyStore (JKS) repository. It contains
self signed certificates for myservicekey and mystskey. <em>Self signed
certificates are not appropriate for production use.</em></p>
</div>
<div class="literalblock">
<div class="content">
<pre>org.apache.ws.security.crypto.provider=org.apache.ws.security.components.crypto.Merlin
org.apache.ws.security.crypto.merlin.keystore.type=jks
org.apache.ws.security.crypto.merlin.keystore.password=sspass
org.apache.ws.security.crypto.merlin.keystore.alias=myservicekey
org.apache.ws.security.crypto.merlin.keystore.file=servicestore.jks</pre>
</div>
</div>
</div>
<div class="sect6">
<h7 id="manifest-mf-saml-holder"><a class="anchor" href="#manifest-mf-saml-holder"></a>MANIFEST.MF</h7>
<div class="paragraph">
<p><a href="https://docs.jboss.org/author/display/JBWS/WS-Trust+and+STS#WS-TrustandSTS-MANIFEST.MF" class="bare">https://docs.jboss.org/author/display/JBWS/WS-Trust+and+STS#WS-TrustandSTS-MANIFEST.MF</a></p>
</div>
<div class="paragraph">
<p>When deployed on WildFly this application requires access to the JBossWs
and CXF APIs provided in module org.jboss.ws.cxf.jbossws-cxf-client. The
dependency statement directs the server to provide them at deployment.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>Manifest-Version:1.0
Ant-Version: Apache Ant1.8.2
Created-By:1.7.0_25-b15 (Oracle Corporation)
Dependencies: org.jboss.ws.cxf.jbossws-cxf-client</pre>
</div>
</div>
</div>
</div>
<div class="sect5">
<h6 id="security-token-service-saml-holder"><a class="anchor" href="#security-token-service-saml-holder"></a>Security Token Service</h6>
<div class="paragraph">
<p>This section examines the crucial elements in providing the Security
Token Service functionality for providing a SAML Holder-Of-Key token.
The components that will be discussed are.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Security Domain</p>
</li>
<li>
<p>STS&#8217;s WSDL</p>
</li>
<li>
<p>STS&#8217;s implementation class</p>
</li>
<li>
<p>STSBearerCallbackHandler</p>
</li>
<li>
<p>Crypto properties and keystore files</p>
</li>
<li>
<p>MANIFEST.MF</p>
</li>
</ul>
</div>
<div class="sect6">
<h7 id="security-domain-saml-holder"><a class="anchor" href="#security-domain-saml-holder"></a>Security Domain</h7>
<div class="paragraph">
<p>The STS requires a JBoss security domain be configured. The
jboss-web.xml descriptor declares a named security
domain,"JBossWS-trust-sts" to be used by this service for
authentication. This security domain requires two properties files and
the addition of a security-domain declaration in the JBoss server
configuration file.</p>
</div>
<div class="paragraph">
<p>For this scenario the domain needs to contain user <em>alice</em>, password
<em>clarinet</em>, and role <em>friend</em>. See the listings below for
jbossws-users.properties and jbossws-roles.properties. In addition the
following XML must be added to the JBoss security subsystem in the
server configuration file. Replace " <strong>SOME_PATH</strong>" with appropriate
information.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;security-domain name="JBossWS-trust-sts"&gt;
  &lt;authentication&gt;
   &lt;login-module code="UsersRoles" flag="required"&gt;
     &lt;module-option name="usersProperties" value="/SOME_PATH/jbossws-users.properties"/&gt;
     &lt;module-option name="unauthenticatedIdentity" value="anonymous"/&gt;
     &lt;module-option name="rolesProperties" value="/SOME_PATH/jbossws-roles.properties"/&gt;
   &lt;/login-module&gt;
  &lt;/authentication&gt;
&lt;/security-domain&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>jboss-web.xml</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;!DOCTYPE jboss-web PUBLIC"-//JBoss//DTD Web Application 2.4//EN" "&gt;
&lt;jboss-web&gt;
  &lt;security-domain&gt;java:/jaas/JBossWS-trust-sts&lt;/security-domain&gt;
&lt;/jboss-web&gt;</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 100%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top"></th>
</tr>
</thead>
</table>
<div class="paragraph">
<p>jbossws-users.properties</p>
</div>
<div class="literalblock">
<div class="content">
<pre># A sample users.properties filefor use with the UsersRolesLoginModule
alice=clarinet</pre>
</div>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 100%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top"></th>
</tr>
</thead>
</table>
<div class="paragraph">
<p>jbossws-roles.properties</p>
</div>
<div class="literalblock">
<div class="content">
<pre># A sample roles.properties filefor use with the UsersRolesLoginModule
alice=friend</pre>
</div>
</div>
</div>
<div class="sect6">
<h7 id="stss-wsdl-saml-holder"><a class="anchor" href="#stss-wsdl-saml-holder"></a>STS&#8217;s WSDL</h7>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;wsdl:definitions
  targetNamespace="http://docs.oasis-open.org/ws-sx/ws-trust/200512/"
  xmlns:tns="http://docs.oasis-open.org/ws-sx/ws-trust/200512/"
  xmlns:wstrust="http://docs.oasis-open.org/ws-sx/ws-trust/200512/"
  xmlns:wsdl="http://schemas.xmlsoap.org/wsdl/"
  xmlns:soap="http://schemas.xmlsoap.org/wsdl/soap/"
  xmlns:wsap10="http://www.w3.org/2006/05/addressing/wsdl"
  xmlns:wsu="http://docs.oasis-open.org/wss/2004/01/oasis-200401-wss-wssecurity-utility-1.0.xsd"
  xmlns:wsp="http://www.w3.org/ns/ws-policy"
  xmlns:wst="http://docs.oasis-open.org/ws-sx/ws-trust/200512"
  xmlns:xs="http://www.w3.org/2001/XMLSchema"
  xmlns:wsam="http://www.w3.org/2007/05/addressing/metadata"&gt;

  &lt;wsdl:types&gt;
    &lt;xs:schema elementFormDefault="qualified"
               targetNamespace='http://docs.oasis-open.org/ws-sx/ws-trust/200512'&gt;

      &lt;xs:element name='RequestSecurityToken'
                  type='wst:AbstractRequestSecurityTokenType'/&gt;
      &lt;xs:element name='RequestSecurityTokenResponse'
                  type='wst:AbstractRequestSecurityTokenType'/&gt;

      &lt;xs:complexType name='AbstractRequestSecurityTokenType'&gt;
        &lt;xs:sequence&gt;
          &lt;xs:any namespace='##any' processContents='lax' minOccurs='0'
                  maxOccurs='unbounded'/&gt;
        &lt;/xs:sequence&gt;
        &lt;xs:attribute name='Context' type='xs:anyURI' use='optional'/&gt;
        &lt;xs:anyAttribute namespace='##other' processContents='lax'/&gt;
      &lt;/xs:complexType&gt;
      &lt;xs:element name='RequestSecurityTokenCollection'
                  type='wst:RequestSecurityTokenCollectionType'/&gt;
      &lt;xs:complexType name='RequestSecurityTokenCollectionType'&gt;
        &lt;xs:sequence&gt;
          &lt;xs:element name='RequestSecurityToken'
                      type='wst:AbstractRequestSecurityTokenType' minOccurs='2'
                      maxOccurs='unbounded'/&gt;
        &lt;/xs:sequence&gt;
      &lt;/xs:complexType&gt;

      &lt;xs:element name='RequestSecurityTokenResponseCollection'
                  type='wst:RequestSecurityTokenResponseCollectionType'/&gt;
      &lt;xs:complexType name='RequestSecurityTokenResponseCollectionType'&gt;
        &lt;xs:sequence&gt;
          &lt;xs:element ref='wst:RequestSecurityTokenResponse' minOccurs='1'
                      maxOccurs='unbounded'/&gt;
        &lt;/xs:sequence&gt;
        &lt;xs:anyAttribute namespace='##other' processContents='lax'/&gt;
      &lt;/xs:complexType&gt;

    &lt;/xs:schema&gt;
  &lt;/wsdl:types&gt;

  &lt;!-- WS-Trust defines the following GEDs --&gt;
  &lt;wsdl:message name="RequestSecurityTokenMsg"&gt;
    &lt;wsdl:part name="request" element="wst:RequestSecurityToken"/&gt;
  &lt;/wsdl:message&gt;
  &lt;wsdl:message name="RequestSecurityTokenResponseMsg"&gt;
    &lt;wsdl:part name="response"
               element="wst:RequestSecurityTokenResponse"/&gt;
  &lt;/wsdl:message&gt;
  &lt;wsdl:message name="RequestSecurityTokenCollectionMsg"&gt;
    &lt;wsdl:part name="requestCollection"
               element="wst:RequestSecurityTokenCollection"/&gt;
  &lt;/wsdl:message&gt;
  &lt;wsdl:message name="RequestSecurityTokenResponseCollectionMsg"&gt;
    &lt;wsdl:part name="responseCollection"
               element="wst:RequestSecurityTokenResponseCollection"/&gt;
  &lt;/wsdl:message&gt;

  &lt;!-- This portType an example of a Requestor (or other) endpoint that
         Accepts SOAP-based challenges from a Security Token Service --&gt;
  &lt;wsdl:portType name="WSSecurityRequestor"&gt;
    &lt;wsdl:operation name="Challenge"&gt;
      &lt;wsdl:input message="tns:RequestSecurityTokenResponseMsg"/&gt;
      &lt;wsdl:output message="tns:RequestSecurityTokenResponseMsg"/&gt;
    &lt;/wsdl:operation&gt;
  &lt;/wsdl:portType&gt;

  &lt;!-- This portType is an example of an STS supporting full protocol --&gt;
  &lt;wsdl:portType name="STS"&gt;
    &lt;wsdl:operation name="Cancel"&gt;
      &lt;wsdl:input
        wsam:Action="http://docs.oasis-open.org/ws-sx/ws-trust/200512/RST/Cancel"
        message="tns:RequestSecurityTokenMsg"/&gt;
      &lt;wsdl:output
        wsam:Action="http://docs.oasis-open.org/ws-sx/ws-trust/200512/RSTR/CancelFinal"
        message="tns:RequestSecurityTokenResponseMsg"/&gt;
    &lt;/wsdl:operation&gt;
    &lt;wsdl:operation name="Issue"&gt;
      &lt;wsdl:input
        wsam:Action="http://docs.oasis-open.org/ws-sx/ws-trust/200512/RST/Issue"
        message="tns:RequestSecurityTokenMsg"/&gt;
      &lt;wsdl:output
        wsam:Action="http://docs.oasis-open.org/ws-sx/ws-trust/200512/RSTRC/IssueFinal"
        message="tns:RequestSecurityTokenResponseCollectionMsg"/&gt;
    &lt;/wsdl:operation&gt;
    &lt;wsdl:operation name="Renew"&gt;
      &lt;wsdl:input
        wsam:Action="http://docs.oasis-open.org/ws-sx/ws-trust/200512/RST/Renew"
        message="tns:RequestSecurityTokenMsg"/&gt;
      &lt;wsdl:output
        wsam:Action="http://docs.oasis-open.org/ws-sx/ws-trust/200512/RSTR/RenewFinal"
        message="tns:RequestSecurityTokenResponseMsg"/&gt;
    &lt;/wsdl:operation&gt;
    &lt;wsdl:operation name="Validate"&gt;
      &lt;wsdl:input
        wsam:Action="http://docs.oasis-open.org/ws-sx/ws-trust/200512/RST/Validate"
        message="tns:RequestSecurityTokenMsg"/&gt;
      &lt;wsdl:output
        wsam:Action="http://docs.oasis-open.org/ws-sx/ws-trust/200512/RSTR/ValidateFinal"
        message="tns:RequestSecurityTokenResponseMsg"/&gt;
    &lt;/wsdl:operation&gt;
    &lt;wsdl:operation name="KeyExchangeToken"&gt;
      &lt;wsdl:input
        wsam:Action="http://docs.oasis-open.org/ws-sx/ws-trust/200512/RST/KET"
        message="tns:RequestSecurityTokenMsg"/&gt;
      &lt;wsdl:output
        wsam:Action="http://docs.oasis-open.org/ws-sx/ws-trust/200512/RSTR/KETFinal"
        message="tns:RequestSecurityTokenResponseMsg"/&gt;
    &lt;/wsdl:operation&gt;
    &lt;wsdl:operation name="RequestCollection"&gt;
      &lt;wsdl:input message="tns:RequestSecurityTokenCollectionMsg"/&gt;
      &lt;wsdl:output message="tns:RequestSecurityTokenResponseCollectionMsg"/&gt;
    &lt;/wsdl:operation&gt;
  &lt;/wsdl:portType&gt;

  &lt;!-- This portType is an example of an endpoint that accepts
         Unsolicited RequestSecurityTokenResponse messages --&gt;
  &lt;wsdl:portType name="SecurityTokenResponseService"&gt;
    &lt;wsdl:operation name="RequestSecurityTokenResponse"&gt;
      &lt;wsdl:input message="tns:RequestSecurityTokenResponseMsg"/&gt;
    &lt;/wsdl:operation&gt;
  &lt;/wsdl:portType&gt;

  &lt;wsdl:binding name="UT_Binding" type="wstrust:STS"&gt;
    &lt;wsp:PolicyReference URI="#UT_policy"/&gt;
    &lt;soap:binding style="document"
                  transport="http://schemas.xmlsoap.org/soap/http"/&gt;
    &lt;wsdl:operation name="Issue"&gt;
      &lt;soap:operation
        soapAction="http://docs.oasis-open.org/ws-sx/ws-trust/200512/RST/Issue"/&gt;
      &lt;wsdl:input&gt;
        &lt;wsp:PolicyReference
          URI="#Input_policy"/&gt;
        &lt;soap:body use="literal"/&gt;
      &lt;/wsdl:input&gt;
      &lt;wsdl:output&gt;
        &lt;wsp:PolicyReference
          URI="#Output_policy"/&gt;
        &lt;soap:body use="literal"/&gt;
      &lt;/wsdl:output&gt;
    &lt;/wsdl:operation&gt;
    &lt;wsdl:operation name="Validate"&gt;
      &lt;soap:operation
        soapAction="http://docs.oasis-open.org/ws-sx/ws-trust/200512/RST/Validate"/&gt;
      &lt;wsdl:input&gt;
        &lt;wsp:PolicyReference
          URI="#Input_policy"/&gt;
        &lt;soap:body use="literal"/&gt;
      &lt;/wsdl:input&gt;
      &lt;wsdl:output&gt;
        &lt;wsp:PolicyReference
          URI="#Output_policy"/&gt;
        &lt;soap:body use="literal"/&gt;
      &lt;/wsdl:output&gt;
    &lt;/wsdl:operation&gt;
    &lt;wsdl:operation name="Cancel"&gt;
      &lt;soap:operation
        soapAction="http://docs.oasis-open.org/ws-sx/ws-trust/200512/RST/Cancel"/&gt;
      &lt;wsdl:input&gt;
        &lt;soap:body use="literal"/&gt;
      &lt;/wsdl:input&gt;
      &lt;wsdl:output&gt;
        &lt;soap:body use="literal"/&gt;
      &lt;/wsdl:output&gt;
    &lt;/wsdl:operation&gt;
    &lt;wsdl:operation name="Renew"&gt;
      &lt;soap:operation
        soapAction="http://docs.oasis-open.org/ws-sx/ws-trust/200512/RST/Renew"/&gt;
      &lt;wsdl:input&gt;
        &lt;soap:body use="literal"/&gt;
      &lt;/wsdl:input&gt;
      &lt;wsdl:output&gt;
        &lt;soap:body use="literal"/&gt;
      &lt;/wsdl:output&gt;
    &lt;/wsdl:operation&gt;
    &lt;wsdl:operation name="KeyExchangeToken"&gt;
      &lt;soap:operation
        soapAction="http://docs.oasis-open.org/ws-sx/ws-trust/200512/RST/KeyExchangeToken"/&gt;
      &lt;wsdl:input&gt;
        &lt;soap:body use="literal"/&gt;
      &lt;/wsdl:input&gt;
      &lt;wsdl:output&gt;
        &lt;soap:body use="literal"/&gt;
      &lt;/wsdl:output&gt;
    &lt;/wsdl:operation&gt;
    &lt;wsdl:operation name="RequestCollection"&gt;
      &lt;soap:operation
        soapAction="http://docs.oasis-open.org/ws-sx/ws-trust/200512/RST/RequestCollection"/&gt;
      &lt;wsdl:input&gt;
        &lt;soap:body use="literal"/&gt;
      &lt;/wsdl:input&gt;
      &lt;wsdl:output&gt;
        &lt;soap:body use="literal"/&gt;
      &lt;/wsdl:output&gt;
    &lt;/wsdl:operation&gt;
  &lt;/wsdl:binding&gt;

  &lt;wsdl:service name="SecurityTokenService"&gt;
    &lt;wsdl:port name="UT_Port" binding="tns:UT_Binding"&gt;
      &lt;soap:address location="http://localhost:8080/SecurityTokenService/UT"/&gt;
    &lt;/wsdl:port&gt;
  &lt;/wsdl:service&gt;

  &lt;wsp:Policy wsu:Id="UT_policy"&gt;
    &lt;wsp:ExactlyOne&gt;
      &lt;wsp:All&gt;
        &lt;wsap10:UsingAddressing/&gt;
        &lt;sp:SymmetricBinding
          xmlns:sp="http://docs.oasis-open.org/ws-sx/ws-securitypolicy/200702"&gt;
          &lt;wsp:Policy&gt;
            &lt;sp:ProtectionToken&gt;
              &lt;wsp:Policy&gt;
                &lt;sp:X509Token
                  sp:IncludeToken="http://docs.oasis-open.org/ws-sx/ws-securitypolicy/200702/IncludeToken/Never"&gt;
                  &lt;wsp:Policy&gt;
                    &lt;sp:RequireDerivedKeys/&gt;
                    &lt;sp:RequireThumbprintReference/&gt;
                    &lt;sp:WssX509V3Token10/&gt;
                  &lt;/wsp:Policy&gt;
                &lt;/sp:X509Token&gt;
              &lt;/wsp:Policy&gt;
            &lt;/sp:ProtectionToken&gt;
            &lt;sp:AlgorithmSuite&gt;
              &lt;wsp:Policy&gt;
                &lt;sp:Basic256/&gt;
              &lt;/wsp:Policy&gt;
            &lt;/sp:AlgorithmSuite&gt;
            &lt;sp:Layout&gt;
              &lt;wsp:Policy&gt;
                &lt;sp:Lax/&gt;
              &lt;/wsp:Policy&gt;
            &lt;/sp:Layout&gt;
            &lt;sp:IncludeTimestamp/&gt;
            &lt;sp:EncryptSignature/&gt;
            &lt;sp:OnlySignEntireHeadersAndBody/&gt;
          &lt;/wsp:Policy&gt;
        &lt;/sp:SymmetricBinding&gt;
        &lt;sp:SignedSupportingTokens
          xmlns:sp="http://docs.oasis-open.org/ws-sx/ws-securitypolicy/200702"&gt;
          &lt;wsp:Policy&gt;
            &lt;sp:UsernameToken
              sp:IncludeToken="http://docs.oasis-open.org/ws-sx/ws-securitypolicy/200702/IncludeToken/AlwaysToRecipient"&gt;
              &lt;wsp:Policy&gt;
                &lt;sp:WssUsernameToken10/&gt;
              &lt;/wsp:Policy&gt;
            &lt;/sp:UsernameToken&gt;
          &lt;/wsp:Policy&gt;
        &lt;/sp:SignedSupportingTokens&gt;
        &lt;sp:Wss11
          xmlns:sp="http://docs.oasis-open.org/ws-sx/ws-securitypolicy/200702"&gt;
          &lt;wsp:Policy&gt;
            &lt;sp:MustSupportRefKeyIdentifier/&gt;
            &lt;sp:MustSupportRefIssuerSerial/&gt;
            &lt;sp:MustSupportRefThumbprint/&gt;
            &lt;sp:MustSupportRefEncryptedKey/&gt;
          &lt;/wsp:Policy&gt;
        &lt;/sp:Wss11&gt;
        &lt;sp:Trust13
          xmlns:sp="http://docs.oasis-open.org/ws-sx/ws-securitypolicy/200702"&gt;
          &lt;wsp:Policy&gt;
            &lt;sp:MustSupportIssuedTokens/&gt;
            &lt;sp:RequireClientEntropy/&gt;
            &lt;sp:RequireServerEntropy/&gt;
          &lt;/wsp:Policy&gt;
        &lt;/sp:Trust13&gt;
      &lt;/wsp:All&gt;
    &lt;/wsp:ExactlyOne&gt;
  &lt;/wsp:Policy&gt;

  &lt;wsp:Policy wsu:Id="Input_policy"&gt;
    &lt;wsp:ExactlyOne&gt;
      &lt;wsp:All&gt;
        &lt;sp:SignedParts
          xmlns:sp="http://docs.oasis-open.org/ws-sx/ws-securitypolicy/200702"&gt;
          &lt;sp:Body/&gt;
          &lt;sp:Header Name="To"
                     Namespace="http://www.w3.org/2005/08/addressing"/&gt;
          &lt;sp:Header Name="From"
                     Namespace="http://www.w3.org/2005/08/addressing"/&gt;
          &lt;sp:Header Name="FaultTo"
                     Namespace="http://www.w3.org/2005/08/addressing"/&gt;
          &lt;sp:Header Name="ReplyTo"
                     Namespace="http://www.w3.org/2005/08/addressing"/&gt;
          &lt;sp:Header Name="MessageID"
                     Namespace="http://www.w3.org/2005/08/addressing"/&gt;
          &lt;sp:Header Name="RelatesTo"
                     Namespace="http://www.w3.org/2005/08/addressing"/&gt;
          &lt;sp:Header Name="Action"
                     Namespace="http://www.w3.org/2005/08/addressing"/&gt;
        &lt;/sp:SignedParts&gt;
      &lt;/wsp:All&gt;
    &lt;/wsp:ExactlyOne&gt;
  &lt;/wsp:Policy&gt;

  &lt;wsp:Policy wsu:Id="Output_policy"&gt;
    &lt;wsp:ExactlyOne&gt;
      &lt;wsp:All&gt;
        &lt;sp:SignedParts
          xmlns:sp="http://docs.oasis-open.org/ws-sx/ws-securitypolicy/200702"&gt;
          &lt;sp:Body/&gt;
          &lt;sp:Header Name="To"
                     Namespace="http://www.w3.org/2005/08/addressing"/&gt;
          &lt;sp:Header Name="From"
                     Namespace="http://www.w3.org/2005/08/addressing"/&gt;
          &lt;sp:Header Name="FaultTo"
                     Namespace="http://www.w3.org/2005/08/addressing"/&gt;
          &lt;sp:Header Name="ReplyTo"
                     Namespace="http://www.w3.org/2005/08/addressing"/&gt;
          &lt;sp:Header Name="MessageID"
                     Namespace="http://www.w3.org/2005/08/addressing"/&gt;
          &lt;sp:Header Name="RelatesTo"
                     Namespace="http://www.w3.org/2005/08/addressing"/&gt;
          &lt;sp:Header Name="Action"
                     Namespace="http://www.w3.org/2005/08/addressing"/&gt;
        &lt;/sp:SignedParts&gt;
      &lt;/wsp:All&gt;
    &lt;/wsp:ExactlyOne&gt;
  &lt;/wsp:Policy&gt;

&lt;/wsdl:definitions&gt;</code></pre>
</div>
</div>
</div>
<div class="sect6">
<h7 id="stss-implementation-class-saml-holder"><a class="anchor" href="#stss-implementation-class-saml-holder"></a>STS&#8217;s implementation class</h7>
<div class="paragraph">
<p>The Apache CXF&#8217;s STS, SecurityTokenServiceProvider, is a web service
provider that is compliant with the protocols and functionality defined
by the WS-Trust specification. It has a modular architecture. Many of
its components are configurable or replaceable and there are many
optional features that are enabled by implementing and configuring
plug-ins. Users can customize their own STS by extending from
SecurityTokenServiceProvider and overriding the default settings.
Extensive information about the CXF&#8217;s STS configurable and pluggable
components can be found
<a href="http://coheigea.blogspot.com/2011/11/apache-cxf-sts-documentation-part-viii_10.html">here</a>.</p>
</div>
<div class="paragraph">
<p>This STS implementation class, SampleSTSHolderOfKey, is a POJO that
extends from SecurityTokenServiceProvider. Note that the class is
defined with a WebServiceProvider annotation and not a WebService
annotation. This annotation defines the service as a Provider-based
endpoint, meaning it supports a more messaging-oriented approach to Web
services. In particular, it signals that the exchanged messages will be
XML documents of some type. SecurityTokenServiceProvider is an
implementation of the javax.xml.ws.Provider interface. In comparison the
WebService annotation defines a (service endpoint interface) SEI-based
endpoint which supports message exchange via SOAP envelopes.</p>
</div>
<div class="paragraph">
<p>As was done in the HolderOfKeyImpl class, the WSS4J annotations
EndpointProperties and EndpointProperty are providing endpoint
configuration for the CXF runtime. The first EndpointProperty statements
declares the Java properties file that contains the (Merlin) crypto
configuration information. WSS4J reads this file and extra required
information for message handling. The last EndpointProperty statement
declares the STSHolderOfKeyCallbackHandler implementation class. It is
used to obtain the user&#8217;s password for the certificates in the keystore
file.</p>
</div>
<div class="paragraph">
<p>In this implementation we are customizing the operations of token
issuance and their static properties.</p>
</div>
<div class="paragraph">
<p>StaticSTSProperties is used to set select properties for configuring
resources in the STS. You may think this is a duplication of the
settings made with the WSS4J annotations. The values are the same but
the underlaying structures being set are different, thus this
information must be declared in both places.</p>
</div>
<div class="paragraph">
<p>The setIssuer setting is important because it uniquely identifies the
issuing STS. The issuer string is embedded in issued tokens and, when
validating tokens, the STS checks the issuer string value. Consequently,
it is important to use the issuer string in a consistent way, so that
the STS can recognize the tokens that it has issued.</p>
</div>
<div class="paragraph">
<p>The setEndpoints call allows the declaration of a set of allowed token
recipients by address. The addresses are specified as reg-ex patterns.</p>
</div>
<div class="paragraph">
<p>TokenIssueOperation has a modular structure. This allows custom
behaviors to be injected into the processing of messages. In this case
we are overriding the SecurityTokenServiceProvider&#8217;s default behavior
and performing SAML token processing. CXF provides an implementation of
a SAMLTokenProvider which we are using rather than writing our own.</p>
</div>
<div class="paragraph">
<p>Learn more about the SAMLTokenProvider
<a href="http://coheigea.blogspot.it/2011/10/apache-cxf-sts-documentation-part-iv.html">here</a>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">package org.jboss.test.ws.jaxws.samples.wsse.policy.trust.stsholderofkey;

import org.apache.cxf.annotations.EndpointProperties;
import org.apache.cxf.annotations.EndpointProperty;
import org.apache.cxf.sts.StaticSTSProperties;
import org.apache.cxf.sts.operation.TokenIssueOperation;
import org.apache.cxf.sts.service.ServiceMBean;
import org.apache.cxf.sts.service.StaticService;
import org.apache.cxf.sts.token.provider.SAMLTokenProvider;
import org.apache.cxf.ws.security.sts.provider.SecurityTokenServiceProvider;

import javax.xml.ws.WebServiceProvider;
import java.util.Arrays;
import java.util.LinkedList;
import java.util.List;

/**
 * User: rsearls
 * Date: 3/14/14
 */
@WebServiceProvider(serviceName = "SecurityTokenService",
   portName = "UT_Port",
   targetNamespace = "http://docs.oasis-open.org/ws-sx/ws-trust/200512/",
   wsdlLocation = "WEB-INF/wsdl/holderofkey-ws-trust-1.4-service.wsdl")
//be sure to have dependency on org.apache.cxf module when on AS7, otherwise Apache CXF annotations are ignored
@EndpointProperties(value = {
   @EndpointProperty(key = "ws-security.signature.properties", value = "stsKeystore.properties"),
   @EndpointProperty(key = "ws-security.callback-handler", value = "org.jboss.test.ws.jaxws.samples.wsse.policy.trust.stsholderofkey.STSHolderOfKeyCallbackHandler")
})
public class SampleSTSHolderOfKey extends SecurityTokenServiceProvider
{

   public SampleSTSHolderOfKey() throws Exception
   {
      super();

      StaticSTSProperties props = new StaticSTSProperties();
      props.setSignatureCryptoProperties("stsKeystore.properties");
      props.setSignatureUsername("mystskey");
      props.setCallbackHandlerClass(STSHolderOfKeyCallbackHandler.class.getName());
      props.setEncryptionCryptoProperties("stsKeystore.properties");
      props.setEncryptionUsername("myservicekey");
      props.setIssuer("DoubleItSTSIssuer");

      List&lt;ServiceMBean&gt; services = new LinkedList&lt;ServiceMBean&gt;();
      StaticService service = new StaticService();
      service.setEndpoints(Arrays.asList(
         "https://localhost:(\\d)*/jaxws-samples-wsse-policy-trust-holderofkey/HolderOfKeyService",
         "https://\\[::1\\]:(\\d)*/jaxws-samples-wsse-policy-trust-holderofkey/HolderOfKeyService",
         "https://\\[0:0:0:0:0:0:0:1\\]:(\\d)*/jaxws-samples-wsse-policy-trust-holderofkey/HolderOfKeyService"
      ));

      services.add(service);

      TokenIssueOperation issueOperation = new TokenIssueOperation();
      issueOperation.getTokenProviders().add(new SAMLTokenProvider());
      issueOperation.setServices(services);
      issueOperation.setStsProperties(props);
      this.setIssueOperation(issueOperation);

   }
}</code></pre>
</div>
</div>
</div>
<div class="sect6">
<h7 id="holderofkeycallbackhandler-saml-holder"><a class="anchor" href="#holderofkeycallbackhandler-saml-holder"></a>HolderOfKeyCallbackHandler</h7>
<div class="paragraph">
<p>STSHolderOfKeyCallbackHandler is a callback handler for the WSS4J Crypto
API. It is used to obtain the password for the private key in the
keystore. This class enables CXF to retrieve the password of the user
name to use for the message signature.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">package org.jboss.test.ws.jaxws.samples.wsse.policy.trust.stsholderofkey;

import org.jboss.wsf.stack.cxf.extensions.security.PasswordCallbackHandler;

import java.util.HashMap;
import java.util.Map;

/**
 * User: rsearls
 * Date: 3/19/14
 */
public class STSHolderOfKeyCallbackHandler extends PasswordCallbackHandler
{
   public STSHolderOfKeyCallbackHandler()
   {
      super(getInitMap());
   }

   private static Map&lt;String, String&gt; getInitMap()
   {
      Map&lt;String, String&gt; passwords = new HashMap&lt;String, String&gt;();
      passwords.put("mystskey", "stskpass");
      passwords.put("alice", "clarinet");
      return passwords;
   }
}</code></pre>
</div>
</div>
</div>
<div class="sect6">
<h7 id="crypto-properties-and-keystore-files-saml-holder-1"><a class="anchor" href="#crypto-properties-and-keystore-files-saml-holder-1"></a>Crypto properties and keystore files</h7>
<div class="paragraph">
<p>WSS4J&#8217;s Crypto implementation is loaded and configured via a Java
properties file that contains Crypto configuration data. The file
contains implementation-specific properties such as a keystore location,
password, default alias and the like. This application is using the
Merlin implementation. File stsKeystore.properties contains this
information.</p>
</div>
<div class="paragraph">
<p>File servicestore.jks, is a Java KeyStore (JKS) repository. It contains
self signed certificates for myservicekey and mystskey. <em>Self signed
certificates are not appropriate for production use.</em></p>
</div>
<div class="literalblock">
<div class="content">
<pre>org.apache.ws.security.crypto.provider=org.apache.ws.security.components.crypto.Merlin
org.apache.ws.security.crypto.merlin.keystore.type=jks
org.apache.ws.security.crypto.merlin.keystore.password=stsspass
org.apache.ws.security.crypto.merlin.keystore.file=stsstore.jks</pre>
</div>
</div>
</div>
<div class="sect6">
<h7 id="manifest-mf-saml-holder-1"><a class="anchor" href="#manifest-mf-saml-holder-1"></a>MANIFEST.MF</h7>
<div class="paragraph">
<p>When deployed on WildFly, this application requires access to the
JBossWs and CXF APIs provided in modules
org.jboss.ws.cxf.jbossws-cxf-client and org.apache.cxf. The Apache CXF
internals, org.apache.cxf.impl, are needed to build the STS
configuration in the SampleSTSHolderOfKey constructor. The dependency
statement directs the server to provide them at deployment.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>Manifest-Version:1.0
Ant-Version: Apache Ant1.8.2
Created-By:1.7.0_25-b15 (Oracle Corporation)
Dependencies: org.jboss.ws.cxf.jbossws-cxf-client,org.apache.cxf.impl</pre>
</div>
</div>
</div>
</div>
<div class="sect5">
<h6 id="web-service-requester-saml-holder"><a class="anchor" href="#web-service-requester-saml-holder"></a>Web service requester</h6>
<div class="paragraph">
<p>This section examines the crucial elements in calling a web service that
implements endpoint security as described in the SAML Holder-Of-Key
scenario. The components that will be discussed are.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>web service requester&#8217;s implementation</p>
</li>
<li>
<p>ClientCallbackHandler</p>
</li>
<li>
<p>Crypto properties and keystore files</p>
</li>
</ul>
</div>
<div class="sect6">
<h7 id="web-service-requester-implementation-saml-holder"><a class="anchor" href="#web-service-requester-implementation-saml-holder"></a>Web service requester Implementation</h7>
<div class="paragraph">
<p>The ws-requester, the client, uses standard procedures for creating a
reference to the web service. To address the endpoint security
requirements, the web service&#8217;s "Request Context" is configured with the
information needed in message generation. In addition, the STSClient
that communicates with the STS is configured with similar values. Note
the key strings ending with a ".it" suffix. This suffix flags these
settings as belonging to the STSClient. The internal CXF code assigns
this information to the STSClient that is auto-generated for this
service call.</p>
</div>
<div class="paragraph">
<p>There is an alternate method of setting up the STSCLient. The user may
provide their own instance of the STSClient. The CXF code will use this
object and not auto-generate one. When providing the STSClient in this
way, the user must provide a org.apache.cxf.Bus for it and the
configuration keys must not have the ".it" suffix. This is used in the
ActAs and OnBehalfOf examples.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">String serviceURL = "https://" + getServerHost() + ":8443/jaxws-samples-wsse-policy-trust-holderofkey/HolderOfKeyService";

final QName serviceName = new QName("http://www.jboss.org/jbossws/ws-extensions/holderofkeywssecuritypolicy", "HolderOfKeyService");
final URL wsdlURL = new URL(serviceURL + "?wsdl");
Service service = Service.create(wsdlURL, serviceName);
HolderOfKeyIface proxy = (HolderOfKeyIface) service.getPort(HolderOfKeyIface.class);

Map&lt;String, Object&gt; ctx = ((BindingProvider)proxy).getRequestContext();

// set the security related configuration information for the service "request"
ctx.put(SecurityConstants.CALLBACK_HANDLER, new ClientCallbackHandler());
ctx.put(SecurityConstants.SIGNATURE_PROPERTIES,
  Thread.currentThread().getContextClassLoader().getResource(
  "META-INF/clientKeystore.properties"));
ctx.put(SecurityConstants.ENCRYPT_PROPERTIES,
  Thread.currentThread().getContextClassLoader().getResource(
  "META-INF/clientKeystore.properties"));
ctx.put(SecurityConstants.SIGNATURE_USERNAME, "myclientkey");
ctx.put(SecurityConstants.ENCRYPT_USERNAME, "myservicekey");

//-- Configuration settings that will be transfered to the STSClient
// "alice" is the name provided for the WSS Username. Her password will
// be retreived from the ClientCallbackHander by the STSClient.
ctx.put(SecurityConstants.USERNAME + ".it", "alice");
ctx.put(SecurityConstants.CALLBACK_HANDLER + ".it", new ClientCallbackHandler());
ctx.put(SecurityConstants.ENCRYPT_PROPERTIES + ".it",
  Thread.currentThread().getContextClassLoader().getResource(
  "META-INF/clientKeystore.properties"));
ctx.put(SecurityConstants.ENCRYPT_USERNAME + ".it", "mystskey");
ctx.put(SecurityConstants.STS_TOKEN_USERNAME + ".it", "myclientkey");
ctx.put(SecurityConstants.STS_TOKEN_PROPERTIES + ".it",
  Thread.currentThread().getContextClassLoader().getResource(
  "META-INF/clientKeystore.properties"));
ctx.put(SecurityConstants.STS_TOKEN_USE_CERT_FOR_KEYINFO + ".it", "true");

proxy.sayHello();</code></pre>
</div>
</div>
</div>
<div class="sect6">
<h7 id="clientcallbackhandler-saml-holder"><a class="anchor" href="#clientcallbackhandler-saml-holder"></a>ClientCallbackHandler</h7>
<div class="paragraph">
<p>ClientCallbackHandler is a callback handler for the WSS4J Crypto API. It
is used to obtain the password for the private key in the keystore. This
class enables CXF to retrieve the password of the user name to use for
the message signature. Note that "alice" and her password have been
provided here. This information is not in the (JKS) keystore but
provided in the WildFly security domain. It was declared in file
jbossws-users.properties.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">package org.jboss.test.ws.jaxws.samples.wsse.policy.trust.shared;

import java.io.IOException;
import javax.security.auth.callback.Callback;
import javax.security.auth.callback.CallbackHandler;
import javax.security.auth.callback.UnsupportedCallbackException;
import org.apache.ws.security.WSPasswordCallback;

public class ClientCallbackHandler implements CallbackHandler {

    public void handle(Callback[] callbacks) throws IOException,
            UnsupportedCallbackException {
        for (int i = 0; i &lt; callbacks.length; i++) {
            if (callbacks[i] instanceof WSPasswordCallback) {
                WSPasswordCallback pc = (WSPasswordCallback) callbacks[i];
                if ("myclientkey".equals(pc.getIdentifier())) {
                    pc.setPassword("ckpass");
                    break;
                } else if ("alice".equals(pc.getIdentifier())) {
                    pc.setPassword("clarinet");
                    break;
                } else if ("bob".equals(pc.getIdentifier())) {
                    pc.setPassword("trombone");
                    break;
                } else if ("myservicekey".equals(pc.getIdentifier())) {  // rls test  added for bearer test
                   pc.setPassword("skpass");
                   break;
                }
            }
        }
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect6">
<h7 id="crypto-properties-and-keystore-files-saml-holder-2"><a class="anchor" href="#crypto-properties-and-keystore-files-saml-holder-2"></a>Crypto properties and keystore files</h7>
<div class="paragraph">
<p>WSS4J&#8217;s Crypto implementation is loaded and configured via a Java
properties file that contains Crypto configuration data. The file
contains implementation-specific properties such as a keystore location,
password, default alias and the like. This application is using the
Merlin implementation. File clientKeystore.properties contains this
information.</p>
</div>
<div class="paragraph">
<p>File clientstore.jks, is a Java KeyStore (JKS) repository. It contains
self signed certificates for myservicekey and mystskey. <em>Self signed
certificates are not appropriate for production use.</em></p>
</div>
<div class="literalblock">
<div class="content">
<pre>org.apache.ws.security.crypto.provider=org.apache.ws.security.components.crypto.Merlin
org.apache.ws.security.crypto.merlin.keystore.type=jks
org.apache.ws.security.crypto.merlin.keystore.password=cspass
org.apache.ws.security.crypto.merlin.keystore.alias=myclientkey
org.apache.ws.security.crypto.merlin.keystore.file=META-INF/clientstore.jks</pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="WS-Reliable_Messaging"><a class="anchor" href="#WS-Reliable_Messaging"></a>16.5.14. WS-Reliable Messaging</h4>
<div class="paragraph">
<p>JBoss Web Services inherits full WS-Reliable Messaging capabilities from
the underlying Apache CXF implementation. At the time of writing, Apache
CXF provides support for the
<a href="http://schemas.xmlsoap.org/ws/2005/02/rm/">WS-Reliable Messaging 1.0</a>
(February 2005) version of the specification.</p>
</div>
<div class="sect4">
<h5 id="enabling-ws-reliable-messaging"><a class="anchor" href="#enabling-ws-reliable-messaging"></a>Enabling WS-Reliable Messaging</h5>
<div class="paragraph">
<p>WS-Reliable Messaging is implemented internally in Apache CXF through a
set of interceptors that deal with the low level requirements of the
reliable messaging protocol. In order for enabling WS-Reliable
Messaging, users need to either:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>consume a WSDL contract that specifies proper WS-Reliable Messaging
policies / assertions</p>
</li>
<li>
<p>manually add / configure the reliable messaging interceptors</p>
</li>
<li>
<p>specify the reliable messaging policies in an optional CXF Spring XML
descriptor</p>
</li>
<li>
<p>specify the Apache CXF reliable messaging feature in an optional CXF
Spring XML descriptor</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The former approach relies on the Apache CXF WS-Policy engine and is the
only portable one. The other approaches are Apache CXF proprietary ones,
however they allow for fine-grained configuration of protocol aspects
that are not covered by the WS-Reliable Messaging Policy. More details
are available in the
<a href="http://cxf.apache.org/docs/wsrmconfiguration.html">Apache CXF
documentation</a>.</p>
</div>
</div>
<div class="sect4">
<h5 id="example-ws-reliable-messaging"><a class="anchor" href="#example-ws-reliable-messaging"></a>Example</h5>
<div class="paragraph">
<p>In this example we configure WS-Reliable Messaging endpoint and client
through the WS-Policy support.</p>
</div>
<div class="sect5">
<h6 id="endpoint-ws-reliable-messaging"><a class="anchor" href="#endpoint-ws-reliable-messaging"></a>Endpoint</h6>
<div class="paragraph">
<p>We go with a contract-first approach, so we start by creating a proper
WSDL contract, containing the WS-Reliable Messaging and WS-Addressing
policies (the latter is a requirement of the former):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;wsdl:definitions name="SimpleService" targetNamespace="http://www.jboss.org/jbossws/ws-extensions/wsrm"
  xmlns:tns="http://www.jboss.org/jbossws/ws-extensions/wsrm" xmlns:xsd="http://www.w3.org/2001/XMLSchema"
  xmlns:soap="http://schemas.xmlsoap.org/wsdl/soap/" xmlns:wsdl="http://schemas.xmlsoap.org/wsdl/"
  xmlns:wsp="http://www.w3.org/2006/07/ws-policy"&gt;

  &lt;wsdl:types&gt;
&lt;xsd:schema xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:tns="http://www.jboss.org/jbossws/ws-extensions/wsrm"
  attributeFormDefault="unqualified" elementFormDefault="unqualified"
  targetNamespace="http://www.jboss.org/jbossws/ws-extensions/wsrm"&gt;
&lt;xsd:element name="ping" type="tns:ping"/&gt;
&lt;xsd:complexType name="ping"&gt;
&lt;xsd:sequence/&gt;
&lt;/xsd:complexType&gt;
&lt;xsd:element name="echo" type="tns:echo"/&gt;
&lt;xsd:complexType name="echo"&gt;
&lt;xsd:sequence&gt;
&lt;xsd:element minOccurs="0" name="arg0" type="xsd:string"/&gt;
&lt;/xsd:sequence&gt;
&lt;/xsd:complexType&gt;
&lt;xsd:element name="echoResponse" type="tns:echoResponse"/&gt;
&lt;xsd:complexType name="echoResponse"&gt;
&lt;xsd:sequence&gt;
&lt;xsd:element minOccurs="0" name="return" type="xsd:string"/&gt;
&lt;/xsd:sequence&gt;
&lt;/xsd:complexType&gt;
&lt;/xsd:schema&gt;
  &lt;/wsdl:types&gt;
  &lt;wsdl:message name="echoResponse"&gt;
    &lt;wsdl:part name="parameters" element="tns:echoResponse"&gt;
    &lt;/wsdl:part&gt;
  &lt;/wsdl:message&gt;
  &lt;wsdl:message name="echo"&gt;
    &lt;wsdl:part name="parameters" element="tns:echo"&gt;
    &lt;/wsdl:part&gt;
  &lt;/wsdl:message&gt;
  &lt;wsdl:message name="ping"&gt;
    &lt;wsdl:part name="parameters" element="tns:ping"&gt;
    &lt;/wsdl:part&gt;
  &lt;/wsdl:message&gt;
  &lt;wsdl:portType name="SimpleService"&gt;
    &lt;wsdl:operation name="ping"&gt;
      &lt;wsdl:input name="ping" message="tns:ping"&gt;
    &lt;/wsdl:input&gt;
    &lt;/wsdl:operation&gt;
    &lt;wsdl:operation name="echo"&gt;
      &lt;wsdl:input name="echo" message="tns:echo"&gt;
    &lt;/wsdl:input&gt;
      &lt;wsdl:output name="echoResponse" message="tns:echoResponse"&gt;
    &lt;/wsdl:output&gt;
    &lt;/wsdl:operation&gt;
  &lt;/wsdl:portType&gt;
  &lt;wsdl:binding name="SimpleServiceSoapBinding" type="tns:SimpleService"&gt;
    &lt;wsp:Policy&gt;
      &lt;!-- WS-Addressing and basic WS-Reliable Messaging policy assertions --&gt;
      &lt;wswa:UsingAddressing xmlns:wswa="http://www.w3.org/2006/05/addressing/wsdl"/&gt;
      &lt;wsrmp:RMAssertion xmlns:wsrmp="http://schemas.xmlsoap.org/ws/2005/02/rm/policy"/&gt;
      &lt;!-- --------------------------------------------------------------- --&gt;
    &lt;/wsp:Policy&gt;
    &lt;soap:binding style="document" transport="http://schemas.xmlsoap.org/soap/http"/&gt;
    &lt;wsdl:operation name="ping"&gt;
      &lt;soap:operation soapAction="" style="document"/&gt;
      &lt;wsdl:input name="ping"&gt;
        &lt;soap:body use="literal"/&gt;
      &lt;/wsdl:input&gt;
    &lt;/wsdl:operation&gt;
    &lt;wsdl:operation name="echo"&gt;
      &lt;soap:operation soapAction="" style="document"/&gt;
      &lt;wsdl:input name="echo"&gt;
        &lt;soap:body use="literal"/&gt;
      &lt;/wsdl:input&gt;
      &lt;wsdl:output name="echoResponse"&gt;
        &lt;soap:body use="literal"/&gt;
      &lt;/wsdl:output&gt;
    &lt;/wsdl:operation&gt;
  &lt;/wsdl:binding&gt;
  &lt;wsdl:service name="SimpleService"&gt;
    &lt;wsdl:port name="SimpleServicePort" binding="tns:SimpleServiceSoapBinding"&gt;
      &lt;soap:address location="http://localhost:8080/jaxws-samples-wsrm-api"/&gt;
    &lt;/wsdl:port&gt;
  &lt;/wsdl:service&gt;
&lt;/wsdl:definitions&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then we use the <em>wsconsume</em> tool to generate both standard Jakarta XML Web Services client
and endpoint.</p>
</div>
<div class="paragraph">
<p>We provide a basic Jakarta XML Web Services implementation for the endpoint, nothing
special in it:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">package org.jboss.test.ws.jaxws.samples.wsrm.service;

import javax.jws.Oneway;
import javax.jws.WebMethod;
import javax.jws.WebService;

@WebService
(
   name = "SimpleService",
   serviceName = "SimpleService",
   wsdlLocation = "WEB-INF/wsdl/SimpleService.wsdl",
   targetNamespace = "http://www.jboss.org/jbossws/ws-extensions/wsrm"
)
public class SimpleServiceImpl
{
   @Oneway
   @WebMethod
   public void ping()
   {
      System.out.println("ping()");
   }

   @WebMethod
   public String echo(String s)
   {
      System.out.println("echo(" + s + ")");
      return s;
   }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Finally we package the generated POJO endpoint together with a basic
web.xml the usual way and deploy to the application server. The
webservices stack automatically detects the policies and enables
WS-Reliable Messaging.</p>
</div>
</div>
<div class="sect5">
<h6 id="client-ws-reliable-messaging"><a class="anchor" href="#client-ws-reliable-messaging"></a>Client</h6>
<div class="paragraph">
<p>The endpoint advertises his RM capabilities (and requirements) through
the published WSDL and the client is required to also enable WS-RM for
successfully exchanging messages with the server.</p>
</div>
<div class="paragraph">
<p>So a regular JAX WS client is enough if the user does not need to tune
any specific detail of the RM subsystem.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">QName serviceName = new QName("http://www.jboss.org/jbossws/ws-extensions/wsrm", "SimpleService");
URL wsdlURL = new URL("http://localhost:8080/jaxws-samples-wsrm-api?wsdl");
Service service = Service.create(wsdlURL, serviceName);
proxy = (SimpleService)service.getPort(SimpleService.class);
proxy.echo("Hello World!");</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="additional-configuration"><a class="anchor" href="#additional-configuration"></a>Additional configuration</h6>
<div class="paragraph">
<p>Fine-grained tuning of WS-Reliable Messaging engine requires setting up
proper RM features and attach them for instance to the client proxy.
Here is an example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">package org.jboss.test.ws.jaxws.samples.wsrm.client;

//...
import javax.xml.ws.Service;
import org.apache.cxf.ws.rm.feature.RMFeature;
import org.apache.cxf.ws.rm.manager.AcksPolicyType;
import org.apache.cxf.ws.rm.manager.DestinationPolicyType;
import org.jboss.test.ws.jaxws.samples.wsrm.generated.SimpleService;

// ...
Service service = Service.create(wsdlURL, serviceName);

RMFeature feature = new RMFeature();
RMAssertion rma = new RMAssertion();
RMAssertion.BaseRetransmissionInterval bri = new RMAssertion.BaseRetransmissionInterval();
bri.setMilliseconds(4000L);
rma.setBaseRetransmissionInterval(bri);
AcknowledgementInterval ai = new AcknowledgementInterval();
ai.setMilliseconds(2000L);
rma.setAcknowledgementInterval(ai);
feature.setRMAssertion(rma);
DestinationPolicyType dp = new DestinationPolicyType();
AcksPolicyType ap = new AcksPolicyType();
ap.setIntraMessageThreshold(0);
dp.setAcksPolicy(ap);
feature.setDestinationPolicy(dp);

SimpleService proxy = (SimpleService)service.getPort(SimpleService.class, feature);
proxy.echo("Hello World");</code></pre>
</div>
</div>
<div class="paragraph">
<p>The same can of course be achieved by factoring the feature into a
custom pojo extending <code>org.apache.cxf.ws.rm.feature.RMFeature</code> and
setting the obtained property in a client configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">package org.jboss.test.ws.jaxws.samples.wsrm.client;

import org.apache.cxf.ws.rm.feature.RMFeature;
import org.apache.cxf.ws.rm.manager.AcksPolicyType;
import org.apache.cxf.ws.rm.manager.DestinationPolicyType;
import org.apache.cxf.ws.rmp.v200502.RMAssertion;
import org.apache.cxf.ws.rmp.v200502.RMAssertion.AcknowledgementInterval;

public class CustomRMFeature extends RMFeature
{
  public CustomRMFeature() {
    super();
    RMAssertion rma = new RMAssertion();
    RMAssertion.BaseRetransmissionInterval bri = new RMAssertion.BaseRetransmissionInterval();
    bri.setMilliseconds(4000L);
    rma.setBaseRetransmissionInterval(bri);
    AcknowledgementInterval ai = new AcknowledgementInterval();
    ai.setMilliseconds(2000L);
    rma.setAcknowledgementInterval(ai);
    super.setRMAssertion(rma);
    DestinationPolicyType dp = new DestinationPolicyType();
    AcksPolicyType ap = new AcksPolicyType();
    ap.setIntraMessageThreshold(0);
    dp.setAcksPolicy(ap);
    super.setDestinationPolicy(dp);
  }
}</code></pre>
</div>
</div>
<div class="olist lowerroman">
<ol class="lowerroman" type="i">
<li>
<p>this is how the <code>jaxws-client-config.xml</code> descriptor would look:</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;?xml version="1.0" encoding="UTF-8"?&gt;

&lt;jaxws-config xmlns="urn:jboss:jbossws-jaxws-config:4.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:javaee="http://java.sun.com/xml/ns/javaee"
xsi:schemaLocation="urn:jboss:jbossws-jaxws-config:4.0 schema/jbossws-jaxws-config_4_0.xsd"&gt;

&lt;client-config&gt;
&lt;config-name&gt;Custom Client Config&lt;/config-name&gt;
&lt;property&gt;
&lt;property-name&gt;cxf.features&lt;/property-name&gt;
&lt;property-value&gt;org.jboss.test.ws.jaxws.samples.wsrm.client.CustomRMFeature&lt;/property-value&gt;
&lt;/property&gt;
&lt;/client-config&gt;

&lt;/jaxws-config&gt;</code></pre>
</div>
</div>
<div class="olist lowerroman">
<ol class="lowerroman" type="i">
<li>
<p>and this is how the client would set the configuration:</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">import org.jboss.ws.api.configuration.ClientConfigUtil;
import org.jboss.ws.api.configuration.ClientConfigurer;

//...
Service service = Service.create(wsdlURL, serviceName);
SimpleService proxy = (SimpleService)service.getPort(SimpleService.class);

ClientConfigurer configurer = ClientConfigUtil.resolveClientConfigurer();
configurer.setConfigProperties(proxy, "META-INF/jaxws-client-config.xml", "Custom Client Config");
proxy.echo("Hello World!");</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="SOAP_over_Jakarta_Messaging"><a class="anchor" href="#SOAP_over_Jakarta_Messaging"></a>16.5.15. SOAP over Jakarta Messaging</h4>
<div class="paragraph">
<p>JBoss Web Services allows communication over the <em>Jakarta Messaging</em> transport. The
functionality comes from Apache CXF support for the
<a href="http://www.w3.org/TR/soapjms/">SOAP over Java Message Service 1.0</a>
specification, which is aimed at a set of standards for interoperable
transport of <em>SOAP</em> messages over <em>Jakarta Messaging</em>.</p>
</div>
<div class="paragraph">
<p>On top of Apache CXF functionalities, the JBossWS integration allows
users to deploy WS archives containing both <em>Jakarta Messaging</em> and <em>HTTP</em> endpoints
the same way as they do for basic <em>HTTP</em> WS endpoints (in <em>war</em>
archives). The webservices layer of WildFly takes care of looking for
<em>Jakarta Messaging</em> enpdoints in the deployed archive and starts them delegating to
the Apache CXF core similarly as with <em>HTTP</em> endpoints.</p>
</div>
<div class="sect4">
<h5 id="configuring-soap-over-Jakarta-Messaging"><a class="anchor" href="#configuring-soap-over-Jakarta-Messaging"></a>Configuring SOAP over Jakarta Messaging</h5>
<div class="paragraph">
<p>As per specification, the <em>SOAP over Jakarta Messaging</em> transport configuration is
controlled by proper elements and attributes in the <code>binding</code> and
<code>service</code> elements of the WSDL contract. So a <em>Jakarta Messaging</em> endpoint is usually
developed using a contract-first approach.</p>
</div>
<div class="paragraph">
<p>The <a href="http://cxf.apache.org/docs/soap-over-jms-10-support.html">Apache CXF
documentation</a> covers all the details of the supported configurations.
The minimum configuration implies:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>setting a proper Jakarta Messaging URI in the <code>soap:address</code> <code>location</code> [1]</p>
</li>
<li>
<p>providing a JNDI connection factory name to be used for connecting to
the queues [2]</p>
</li>
<li>
<p>setting the transport binding [3]</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;wsdl:definitions name="HelloWorldService" targetNamespace="http://org.jboss.ws/jaxws/cxf/jms"
  xmlns:soap="http://schemas.xmlsoap.org/wsdl/soap/"
  xmlns:tns="http://org.jboss.ws/jaxws/cxf/jms"
  xmlns:wsdl="http://schemas.xmlsoap.org/wsdl/"
  xmlns:soapjms="http://www.w3.org/2010/soapjms/"
  xmlns:xsd="http://www.w3.org/2001/XMLSchema"&gt;
...

&lt;wsdl:binding name="HelloWorldServiceSoapBinding" type="tns:HelloWorld"&gt;
  &lt;soap:binding style="document" transport="http://www.w3.org/2010/soapjms/"/&gt; &lt;!-- 3 --&gt;
  &lt;wsdl:operation name="echo"&gt;
    &lt;soap:operation soapAction="" style="document"/&gt;
    &lt;wsdl:input name="echo"&gt;
      &lt;soap:body use="literal"/&gt;
    &lt;/wsdl:input&gt;
    &lt;wsdl:output name="echoResponse"&gt;
      &lt;soap:body use="literal"/&gt;
    &lt;/wsdl:output&gt;
  &lt;/wsdl:operation&gt;
&lt;/wsdl:binding&gt;
&lt;wsdl:service name="HelloWorldService"&gt;
  &lt;soapjms:jndiConnectionFactoryName&gt;java:/ConnectionFactory&lt;/soapjms:jndiConnectionFactoryName&gt; &lt;!-- 2 --&gt;
  &lt;wsdl:port binding="tns:HelloWorldServiceSoapBinding" name="HelloWorldImplPort"&gt;
    &lt;soap:address location="jms:queue:testQueue"/&gt; &lt;!-- 1 --&gt;
  &lt;/wsdl:port&gt;
&lt;/wsdl:service&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Apache CXF takes care of setting up the Jakarta Messaging transport for endpoint
implementations whose <code>@WebService</code> annotation points to a port declared
for Jakarta Messaging transport as explained above.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
JBossWS currently supports POJO endpoints only for Jakarta Messaging transport use.
The endpoint classes can be deployed as part of <em>jar</em> or <em>war</em> archives.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The <em>web.xml</em> descriptor in <em>war</em> archives doesn&#8217;t need any entry for
Jakarta Messaging endpoints.</p>
</div>
</div>
<div class="sect4">
<h5 id="examples-soap-over-jms"><a class="anchor" href="#examples-soap-over-jms"></a>Examples</h5>
<div class="sect5">
<h6 id="Jakarta-Messaging-endpoint-only-deployment"><a class="anchor" href="#Jakarta-Messaging-endpoint-only-deployment"></a>Jakarta Messaging endpoint only deployment</h6>
<div class="paragraph">
<p>In this example we create a simple endpoint relying on <em>SOAP over Jakarta Messaging</em>
and deploy it as part of a jar archive.</p>
</div>
<div class="paragraph">
<p>The endpoint is created using wsconsume tool from a WSDL contract such
as:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;?xml version='1.0' encoding='UTF-8'?&gt;
&lt;wsdl:definitions name="HelloWorldService" targetNamespace="http://org.jboss.ws/jaxws/cxf/jms"
  xmlns:ns1="http://schemas.xmlsoap.org/soap/http"
  xmlns:soap="http://schemas.xmlsoap.org/wsdl/soap/"
  xmlns:tns="http://org.jboss.ws/jaxws/cxf/jms"
  xmlns:wsdl="http://schemas.xmlsoap.org/wsdl/"
  xmlns:soapjms="http://www.w3.org/2010/soapjms/"
  xmlns:xsd="http://www.w3.org/2001/XMLSchema"&gt;
  &lt;wsdl:types&gt;
&lt;xs:schema elementFormDefault="unqualified" targetNamespace="http://org.jboss.ws/jaxws/cxf/jms" version="1.0" xmlns:tns="http://org.jboss.ws/jaxws/cxf/jms" xmlns:xs="http://www.w3.org/2001/XMLSchema"&gt;
&lt;xs:element name="echo" type="tns:echo"/&gt;
&lt;xs:element name="echoResponse" type="tns:echoResponse"/&gt;
&lt;xs:complexType name="echo"&gt;
    &lt;xs:sequence&gt;
      &lt;xs:element minOccurs="0" name="arg0" type="xs:string"/&gt;
    &lt;/xs:sequence&gt;
  &lt;/xs:complexType&gt;
&lt;xs:complexType name="echoResponse"&gt;
    &lt;xs:sequence&gt;
      &lt;xs:element minOccurs="0" name="return" type="xs:string"/&gt;
    &lt;/xs:sequence&gt;
  &lt;/xs:complexType&gt;
&lt;/xs:schema&gt;
  &lt;/wsdl:types&gt;
  &lt;wsdl:message name="echoResponse"&gt;
    &lt;wsdl:part element="tns:echoResponse" name="parameters"&gt;
    &lt;/wsdl:part&gt;
  &lt;/wsdl:message&gt;
  &lt;wsdl:message name="echo"&gt;
    &lt;wsdl:part element="tns:echo" name="parameters"&gt;
    &lt;/wsdl:part&gt;
  &lt;/wsdl:message&gt;
  &lt;wsdl:portType name="HelloWorld"&gt;
    &lt;wsdl:operation name="echo"&gt;
      &lt;wsdl:input message="tns:echo" name="echo"&gt;
    &lt;/wsdl:input&gt;
      &lt;wsdl:output message="tns:echoResponse" name="echoResponse"&gt;
    &lt;/wsdl:output&gt;
    &lt;/wsdl:operation&gt;
  &lt;/wsdl:portType&gt;
  &lt;wsdl:binding name="HelloWorldServiceSoapBinding" type="tns:HelloWorld"&gt;
    &lt;soap:binding style="document" transport="http://www.w3.org/2010/soapjms/"/&gt;
    &lt;wsdl:operation name="echo"&gt;
      &lt;soap:operation soapAction="" style="document"/&gt;
      &lt;wsdl:input name="echo"&gt;
        &lt;soap:body use="literal"/&gt;
      &lt;/wsdl:input&gt;
      &lt;wsdl:output name="echoResponse"&gt;
        &lt;soap:body use="literal"/&gt;
      &lt;/wsdl:output&gt;
    &lt;/wsdl:operation&gt;
  &lt;/wsdl:binding&gt;
  &lt;wsdl:service name="HelloWorldService"&gt;
    &lt;soapjms:jndiConnectionFactoryName&gt;java:jms/RemoteConnectionFactory&lt;/soapjms:jndiConnectionFactoryName&gt;
    &lt;soapjms:jndiInitialContextFactory&gt;org.jboss.naming.remote.client.InitialContextFactory&lt;/soapjms:jndiInitialContextFactory&gt;
    &lt;soapjms:jndiURL&gt;http-remoting://myhost:8080&lt;/soapjms:jndiURL&gt;
    &lt;wsdl:port binding="tns:HelloWorldServiceSoapBinding" name="HelloWorldImplPort"&gt;
      &lt;soap:address location="jms:queue:testQueue"/&gt;
    &lt;/wsdl:port&gt;
  &lt;/wsdl:service&gt;
  &lt;wsdl:service name="HelloWorldServiceLocal"&gt;
    &lt;soapjms:jndiConnectionFactoryName&gt;java:/ConnectionFactory&lt;/soapjms:jndiConnectionFactoryName&gt;
    &lt;wsdl:port binding="tns:HelloWorldServiceSoapBinding" name="HelloWorldImplPort"&gt;
      &lt;soap:address location="jms:queue:testQueue"/&gt;
    &lt;/wsdl:port&gt;
  &lt;/wsdl:service&gt;
&lt;/wsdl:definitions&gt;</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
The <em>HelloWorldImplPort</em> here is meant for using the <em>testQueue</em> that
has to be created before deploying the endpoint.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>At the time of writing, <em>java:/ConnectionFactory</em> is the default
connection factory JNDI location on WildFly</p>
</div>
<div class="paragraph">
<p>For allowing remote JNDI lookup of the connection factory, a specific
service ( <code>HelloWorldService</code>) for remote clients is added to the WSDL.
The <em>java:jms/RemoteConnectionFactory</em> is the JNDI location of the same
connection factory mentioned above, except it&#8217;s exposed for remote
lookup. The <code>soapjms:jndiInitialContextFactory</code> and <code>soap:jmsjndiURL</code>
complete the remote connection configuration, specifying the initial
context factory class to use and the JNDI registry address.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Have a look at the application server domain for finding out the
configured connection factory JNDI locations.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The endpoint implementation is a basic Jakarta XML Web Services POJO using @WebService
annotation to refer to the consumed contract:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">package org.jboss.test.ws.jaxws.cxf.jms;

import javax.jws.WebService;

@WebService
(
   portName = "HelloWorldImplPort",
   serviceName = "HelloWorldServiceLocal",
   wsdlLocation = "META-INF/wsdl/HelloWorldService.wsdl",
   endpointInterface = "org.jboss.test.ws.jaxws.cxf.jms.HelloWorld",
   targetNamespace = "http://org.jboss.ws/jaxws/cxf/jms"
)
public class HelloWorldImpl implements HelloWorld
{
   public String echo(String input)
   {
      return input;
   }
}</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The endpoint implementation references the <code>HelloWorldServiceLocal</code> wsdl
service, so that the local JNDI connection factory location is used for
starting the endpoint on server side.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>That&#8217;s pretty much all. We just need to package the generated service
endpoint interface, the endpoint implementation and the WSDL file in a
<em>jar</em> archive and deploy it:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>alessio@inuyasha /dati/jbossws/stack/cxf/trunk $ jar -tvf ./modules/testsuite/cxf-tests/target/test-libs/jaxws-cxf-jms-only-deployment.jar
     0 Thu Jun 23 15:18:44 CEST 2011 META-INF/
   129 Thu Jun 23 15:18:42 CEST 2011 META-INF/MANIFEST.MF
     0 Thu Jun 23 15:18:42 CEST 2011 org/
     0 Thu Jun 23 15:18:42 CEST 2011 org/jboss/
     0 Thu Jun 23 15:18:42 CEST 2011 org/jboss/test/
     0 Thu Jun 23 15:18:42 CEST 2011 org/jboss/test/ws/
     0 Thu Jun 23 15:18:42 CEST 2011 org/jboss/test/ws/jaxws/
     0 Thu Jun 23 15:18:42 CEST 2011 org/jboss/test/ws/jaxws/cxf/
     0 Thu Jun 23 15:18:42 CEST 2011 org/jboss/test/ws/jaxws/cxf/jms/
   313 Thu Jun 23 15:18:42 CEST 2011 org/jboss/test/ws/jaxws/cxf/jms/HelloWorld.class
  1173 Thu Jun 23 15:18:42 CEST 2011 org/jboss/test/ws/jaxws/cxf/jms/HelloWorldImpl.class
     0 Thu Jun 23 15:18:40 CEST 2011 META-INF/wsdl/
  3074 Thu Jun 23 15:18:40 CEST 2011 META-INF/wsdl/HelloWorldService.wsdl</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
A dependency on <code>org.hornetq</code> module needs to be added in MANIFEST.MF
when deploying to WildFly.
</td>
</tr>
</table>
</div>
<div class="literalblock">
<div class="content">
<pre>Manifest-Version: 1.0

Ant-Version: Apache Ant 1.7.1

Created-By: 17.0-b16 (Sun Microsystems Inc.)

Dependencies: org.hornetq</pre>
</div>
</div>
<div class="paragraph">
<p>A Jakarta XML Web Services client can interact with the Jakarta Messaging endpoint the usual way:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">URL wsdlUrl = ...
//start another bus to avoid affecting the one that could already be assigned to the current thread - optional but highly suggested
Bus bus = BusFactory.newInstance().createBus();
BusFactory.setThreadDefaultBus(bus);
try
{
   QName serviceName = new QName("http://org.jboss.ws/jaxws/cxf/jms", "HelloWorldService");
   Service service = Service.create(wsdlUrl, serviceName);
   HelloWorld proxy = (HelloWorld) service.getPort(new QName("http://org.jboss.ws/jaxws/cxf/jms", "HelloWorldImplPort"), HelloWorld.class);
   setupProxy(proxy);
   proxy.echo("Hi");
}
finally
{
   bus.shutdown(true);
}</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
The WSDL location URL needs to be retrieved in a custom way, depending
on the client application. Given the endpoint is Jakarta Messaging only, there&#8217;s no
automatically published WSDL contract.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>in order for performing the remote invocation (which internally goes
through remote JNDI lookup of the connection factory), the calling user
credentials need to be set into the Apache CXF JMSConduit:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">private void setupProxy(HelloWorld proxy) {
   JMSConduit conduit = (JMSConduit)ClientProxy.getClient(proxy).getConduit();
   JNDIConfiguration jndiConfig = conduit.getJmsConfig().getJndiConfig();
   jndiConfig.setConnectionUserName("user");
   jndiConfig.setConnectionPassword("password");
   Properties props = conduit.getJmsConfig().getJndiTemplate().getEnvironment();
   props.put(Context.SECURITY_PRINCIPAL, "user");
   props.put(Context.SECURITY_CREDENTIALS, "password");
}</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Have a look at the WildFly domain and messaging configuration for
finding out the actual security requirements. At the time of writing, a
user with <code>guest</code> role is required and that&#8217;s internally checked using
the <code>other</code> security domain.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Of course once the endpoint is exposed over Jakarta Messaging transport, any plain Jakarta Messaging
client can also be used to send messages to the webservice endpoint. You
can have a look at the SOAP over Jakarta Messaging spec details and code the client
similarly to</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">Properties env = new Properties();
env.put(Context.INITIAL_CONTEXT_FACTORY, "org.jboss.naming.remote.client.InitialContextFactory");
env.put(Context.PROVIDER_URL, "http-remoting://myhost:8080");
env.put(Context.SECURITY_PRINCIPAL, "user");
env.put(Context.SECURITY_CREDENTIALS, "password");
InitialContext context = new InitialContext(env);
QueueConnectionFactory connectionFactory = (QueueConnectionFactory)context.lookup("jms/RemoteConnectionFactory");
Queue reqQueue = (Queue)context.lookup("jms/queue/test");
Queue resQueue = (Queue)context.lookup("jms/queue/test");
QueueConnection con = connectionFactory.createQueueConnection("user", "password");
QueueSession session = con.createQueueSession(false, Session.AUTO_ACKNOWLEDGE);
QueueReceiver receiver = session.createReceiver(resQueue);
ResponseListener responseListener = new ResponseListener(); //a custom response listener...
receiver.setMessageListener(responseListener);
con.start();
TextMessage message = session.createTextMessage(reqMessage);
message.setJMSReplyTo(resQueue);

//setup SOAP-over-JMS properties...
message.setStringProperty("SOAPJMS_contentType", "text/xml");
message.setStringProperty("SOAPJMS_requestURI", "jms:queue:testQueue");

QueueSender sender = session.createSender(reqQueue);
sender.send(message);
sender.close();

...</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="Jakarta-Messaging-and-http-endpoints-deployment"><a class="anchor" href="#Jakarta-Messaging-and-http-endpoints-deployment"></a>Jakarta Messaging and HTTP endpoints deployment</h6>
<div class="paragraph">
<p>In this example we create a deployment containing an endpoint that
serves over both HTTP and Jakarta Messaging transports.</p>
</div>
<div class="paragraph">
<p>We from a WSDL contract such as below (please note we&#8217;ve two <code>binding</code> /
<code>portType</code> for the same <code>service</code>):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;?xml version='1.0' encoding='UTF-8'?&gt;
&lt;wsdl:definitions name="HelloWorldService" targetNamespace="http://org.jboss.ws/jaxws/cxf/jms"
  xmlns:ns1="http://schemas.xmlsoap.org/soap/http"
  xmlns:soap="http://schemas.xmlsoap.org/wsdl/soap/"
  xmlns:tns="http://org.jboss.ws/jaxws/cxf/jms"
  xmlns:wsdl="http://schemas.xmlsoap.org/wsdl/"
  xmlns:soapjms="http://www.w3.org/2010/soapjms/"
  xmlns:xsd="http://www.w3.org/2001/XMLSchema"&gt;
  &lt;wsdl:types&gt;
&lt;xs:schema elementFormDefault="unqualified" targetNamespace="http://org.jboss.ws/jaxws/cxf/jms" version="1.0"
  xmlns:tns="http://org.jboss.ws/jaxws/cxf/jms" xmlns:xs="http://www.w3.org/2001/XMLSchema"&gt;
&lt;xs:element name="echo" type="tns:echo"/&gt;
&lt;xs:element name="echoResponse" type="tns:echoResponse"/&gt;
&lt;xs:complexType name="echo"&gt;
    &lt;xs:sequence&gt;
      &lt;xs:element minOccurs="0" name="arg0" type="xs:string"/&gt;
    &lt;/xs:sequence&gt;
  &lt;/xs:complexType&gt;
&lt;xs:complexType name="echoResponse"&gt;
    &lt;xs:sequence&gt;
      &lt;xs:element minOccurs="0" name="return" type="xs:string"/&gt;
    &lt;/xs:sequence&gt;
  &lt;/xs:complexType&gt;
&lt;/xs:schema&gt;
  &lt;/wsdl:types&gt;
  &lt;wsdl:message name="echoResponse"&gt;
    &lt;wsdl:part element="tns:echoResponse" name="parameters"&gt;
    &lt;/wsdl:part&gt;
  &lt;/wsdl:message&gt;
  &lt;wsdl:message name="echo"&gt;
    &lt;wsdl:part element="tns:echo" name="parameters"&gt;
    &lt;/wsdl:part&gt;
  &lt;/wsdl:message&gt;
  &lt;wsdl:portType name="HelloWorld"&gt;
    &lt;wsdl:operation name="echo"&gt;
      &lt;wsdl:input message="tns:echo" name="echo"&gt;
    &lt;/wsdl:input&gt;
      &lt;wsdl:output message="tns:echoResponse" name="echoResponse"&gt;
    &lt;/wsdl:output&gt;
    &lt;/wsdl:operation&gt;
  &lt;/wsdl:portType&gt;
  &lt;wsdl:binding name="HelloWorldServiceSoapBinding" type="tns:HelloWorld"&gt;
    &lt;soap:binding style="document" transport="http://www.w3.org/2010/soapjms/"/&gt;
    &lt;wsdl:operation name="echo"&gt;
      &lt;soap:operation soapAction="" style="document"/&gt;
      &lt;wsdl:input name="echo"&gt;
        &lt;soap:body use="literal"/&gt;
      &lt;/wsdl:input&gt;
      &lt;wsdl:output name="echoResponse"&gt;
        &lt;soap:body use="literal"/&gt;
      &lt;/wsdl:output&gt;
    &lt;/wsdl:operation&gt;
  &lt;/wsdl:binding&gt;
  &lt;wsdl:binding name="HttpHelloWorldServiceSoapBinding" type="tns:HelloWorld"&gt;
    &lt;soap:binding style="document" transport="http://schemas.xmlsoap.org/soap/http"/&gt;
    &lt;wsdl:operation name="echo"&gt;
      &lt;soap:operation soapAction="" style="document"/&gt;
      &lt;wsdl:input name="echo"&gt;
        &lt;soap:body use="literal"/&gt;
      &lt;/wsdl:input&gt;
      &lt;wsdl:output name="echoResponse"&gt;
        &lt;soap:body use="literal"/&gt;
      &lt;/wsdl:output&gt;
    &lt;/wsdl:operation&gt;
  &lt;/wsdl:binding&gt;
  &lt;wsdl:service name="HelloWorldService"&gt;
    &lt;soapjms:jndiConnectionFactoryName&gt;java:jms/RemoteConnectionFactory&lt;/soapjms:jndiConnectionFactoryName&gt;
    &lt;soapjms:jndiInitialContextFactory&gt;org.jboss.naming.remote.client.InitialContextFactory&lt;/soapjms:jndiInitialContextFactory&gt;
    &lt;soapjms:jndiURL&gt;http-remoting://localhost:8080&lt;/soapjms:jndiURL&gt;
    &lt;wsdl:port binding="tns:HelloWorldServiceSoapBinding" name="HelloWorldImplPort"&gt;
      &lt;soap:address location="jms:queue:testQueue"/&gt;
    &lt;/wsdl:port&gt;
    &lt;wsdl:port binding="tns:HttpHelloWorldServiceSoapBinding" name="HttpHelloWorldImplPort"&gt;
      &lt;soap:address location="http://localhost:8080/jaxws-cxf-jms-http-deployment"/&gt;
    &lt;/wsdl:port&gt;
  &lt;/wsdl:service&gt;
  &lt;wsdl:service name="HelloWorldServiceLocal"&gt;
    &lt;soapjms:jndiConnectionFactoryName&gt;java:/ConnectionFactory&lt;/soapjms:jndiConnectionFactoryName&gt;
    &lt;wsdl:port binding="tns:HelloWorldServiceSoapBinding" name="HelloWorldImplPort"&gt;
      &lt;soap:address location="jms:queue:testQueue"/&gt;
    &lt;/wsdl:port&gt;
&lt;/wsdl:definitions&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The same considerations of the previous example regarding the Jakarta Messaging queue
and JNDI connection factory still apply.<br>
Here we can implement the endpoint in multiple ways, either with a
common implementation class that&#8217;s extended by the Jakarta Messaging and HTTP ones, or
keep the two implementation classes independent and just have them
implement the same service endpoint interface:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">package org.jboss.test.ws.jaxws.cxf.jms_http;

import javax.jws.WebService;

@WebService
(
   portName = "HelloWorldImplPort",
   serviceName = "HelloWorldServiceLocal",
   wsdlLocation = "WEB-INF/wsdl/HelloWorldService.wsdl",
   endpointInterface = "org.jboss.test.ws.jaxws.cxf.jms_http.HelloWorld",
   targetNamespace = "http://org.jboss.ws/jaxws/cxf/jms"
)
public class HelloWorldImpl implements HelloWorld
{
   public String echo(String input)
   {
      System.out.println("input: " + input);
      return input;
   }
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">package org.jboss.test.ws.jaxws.cxf.jms_http;

import javax.jws.WebService;

@WebService
(
   portName = "HttpHelloWorldImplPort",
   serviceName = "HelloWorldService",
   wsdlLocation = "WEB-INF/wsdl/HelloWorldService.wsdl",
   endpointInterface = "org.jboss.test.ws.jaxws.cxf.jms_http.HelloWorld",
   targetNamespace = "http://org.jboss.ws/jaxws/cxf/jms"
)
public class HttpHelloWorldImpl implements HelloWorld
{
   public String echo(String input)
   {
      System.out.println("input (http): " + input);
      return "(http) " + input;
   }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Both classes are packaged together the service endpoint interface and
the WSDL file in a <em>war</em> archive:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>alessio@inuyasha /dati/jbossws/stack/cxf/trunk $ jar -tvf ./modules/testsuite/cxf-spring-tests/target/test-libs/jaxws-cxf-jms-http-deployment.war
     0 Thu Jun 23 15:18:44 CEST 2011 META-INF/
   129 Thu Jun 23 15:18:42 CEST 2011 META-INF/MANIFEST.MF
     0 Thu Jun 23 15:18:44 CEST 2011 WEB-INF/
   569 Thu Jun 23 15:18:40 CEST 2011 WEB-INF/web.xml
     0 Thu Jun 23 15:18:44 CEST 2011 WEB-INF/classes/
     0 Thu Jun 23 15:18:42 CEST 2011 WEB-INF/classes/org/
     0 Thu Jun 23 15:18:42 CEST 2011 WEB-INF/classes/org/jboss/
     0 Thu Jun 23 15:18:42 CEST 2011 WEB-INF/classes/org/jboss/test/
     0 Thu Jun 23 15:18:42 CEST 2011 WEB-INF/classes/org/jboss/test/ws/
     0 Thu Jun 23 15:18:42 CEST 2011 WEB-INF/classes/org/jboss/test/ws/jaxws/
     0 Thu Jun 23 15:18:42 CEST 2011 WEB-INF/classes/org/jboss/test/ws/jaxws/cxf/
     0 Thu Jun 23 15:18:42 CEST 2011 WEB-INF/classes/org/jboss/test/ws/jaxws/cxf/jms_http/
   318 Thu Jun 23 15:18:42 CEST 2011 WEB-INF/classes/org/jboss/test/ws/jaxws/cxf/jms_http/HelloWorld.class
  1192 Thu Jun 23 15:18:42 CEST 2011 WEB-INF/classes/org/jboss/test/ws/jaxws/cxf/jms_http/HelloWorldImpl.class
  1246 Thu Jun 23 15:18:42 CEST 2011 WEB-INF/classes/org/jboss/test/ws/jaxws/cxf/jms_http/HttpHelloWorldImpl.class
     0 Thu Jun 23 15:18:40 CEST 2011 WEB-INF/wsdl/
  3068 Thu Jun 23 15:18:40 CEST 2011 WEB-INF/wsdl/HelloWorldService.wsdl</pre>
</div>
</div>
<div class="paragraph">
<p>A trivial web.xml descriptor is also included to trigger the HTTP
endpoint publish:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;web-app xmlns="http://java.sun.com/xml/ns/j2ee"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="http://java.sun.com/xml/ns/j2ee http://java.sun.com/xml/ns/j2ee/web-app_2_4.xsd"
  version="2.4"&gt;
  &lt;servlet&gt;
    &lt;servlet-name&gt;EndpointServlet&lt;/servlet-name&gt;
    &lt;servlet-class&gt;org.jboss.test.ws.jaxws.cxf.jms_http.HttpHelloWorldImpl&lt;/servlet-class&gt;
  &lt;/servlet&gt;
  &lt;servlet-mapping&gt;
    &lt;servlet-name&gt;EndpointServlet&lt;/servlet-name&gt;
    &lt;url-pattern&gt;/*&lt;/url-pattern&gt;
  &lt;/servlet-mapping&gt;
&lt;/web-app&gt;</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Here too the MANIFEST.MF needs to declare a dependency on <em>org.hornetq</em>
module when deploying to WildFly.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Finally, the Jakarta XML Web Services client can ineract with both Jakarta Messaging and HTTP endpoints
as usual:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">//start another bus to avoid affecting the one that could already be assigned to current thread - optional but highly suggested
Bus bus = BusFactory.newInstance().createBus();
BusFactory.setThreadDefaultBus(bus);
try
{
   QName serviceName = new QName("http://org.jboss.ws/jaxws/cxf/jms", "HelloWorldService");
   Service service = Service.create(wsdlUrl, serviceName);

   //JMS test
   HelloWorld proxy = (HelloWorld) service.getPort(new QName("http://org.jboss.ws/jaxws/cxf/jms", "HelloWorldImplPort"), HelloWorld.class);
   setupProxy(proxy);
   proxy.echo("Hi");
   //HTTP test
   HelloWorld httpProxy = (HelloWorld) service.getPort(new QName("http://org.jboss.ws/jaxws/cxf/jms", "HttpHelloWorldImplPort"), HelloWorld.class);
   httpProxy.echo("Hi");
}
finally
{
   bus.shutdown(true);
}</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="use-of-endpoint.publish-api"><a class="anchor" href="#use-of-endpoint.publish-api"></a>Use of Endpoint.publish() API</h6>
<div class="paragraph">
<p>An alternative to deploying an archive containing Jakarta Messaging endpoints is in
starting them directly using the Jakarta XML Web Services <code>Endpoint.publish(..)</code> API.</p>
</div>
<div class="paragraph">
<p>That&#8217;s as easy as doing:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">Object implementor = new HelloWorldImpl();
Endpoint ep = Endpoint.publish("jms:queue:testQueue", implementor);
try
{
   //use or let others use the endpoint
}
finally
{
   ep.stop();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>where <code>HelloWorldImpl</code> is a POJO endpoint implementation referencing a
Jakarta Messaging <em>port</em> in a given WSDL contract, as explained in the previous
examples.</p>
</div>
<div class="paragraph">
<p>The main difference among the deployment approach is in the direct
control and responsibility over the endpoint lifecycle ( <em>start/publish</em>
and <em>stop</em>).</p>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="HTTP_Proxy"><a class="anchor" href="#HTTP_Proxy"></a>16.5.16. HTTP Proxy</h4>
<div class="paragraph">
<p>The HTTP Proxy related functionalities of JBoss Web Services are
provided by the Apache CXF http transport layer.</p>
</div>
<div class="paragraph">
<p>The suggested configuration mechanism when running JBoss Web Services is
explained below; for further information please refer to the
<a href="http://cxf.apache.org/docs/client-http-transport-including-ssl-support.html">Apache
CXF documentation</a>.</p>
</div>
<div class="sect4">
<h5 id="configuration"><a class="anchor" href="#configuration"></a>Configuration</h5>
<div class="paragraph">
<p>The HTTP proxy configuration for a given Jakarta XML Web Services client can be set in the
following ways:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>through the <code>http.proxyHost</code> and <code>http.proxyPort</code> system properties,
or</p>
</li>
<li>
<p>leveraging the <code>org.apache.cxf.transport.http.HTTPConduit</code> options</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The former is a JVM level configuration; for instance, assuming the http
proxy is currently running at <a href="http://localhost:9934" class="bare">http://localhost:9934</a>, here is the setup:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">System.getProperties().setProperty("http.proxyHost", "localhost");
System.getProperties().setProperty("http.proxyPort", 9934);</code></pre>
</div>
</div>
<div class="paragraph">
<p>The latter is a client stub/port level configuration: the setup is
performed on the <code>HTTPConduit</code> object that&#8217;s part of the Apache CXF
<code>Client</code> abstraction.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">import org.apache.cxf.configuration.security.ProxyAuthorizationPolicy;
import org.apache.cxf.endpoint.Client;
import org.apache.cxf.frontend.ClientProxy;
import org.apache.cxf.transport.http.HTTPConduit;
import org.apache.cxf.transports.http.configuration.HTTPClientPolicy;
import org.apache.cxf.transports.http.configuration.ProxyServerType;
...

Service service = Service.create(wsdlURL, new QName("http://org.jboss.ws/jaxws/cxf/httpproxy", "HelloWorldService"));
HelloWorld port = (HelloWorld) service.getPort(new QName("http://org.jboss.ws/jaxws/cxf/httpproxy", "HelloWorldImplPort"), HelloWorld.class);

Client client = ClientProxy.getClient(port);
HTTPConduit conduit = (HTTPConduit)client.getConduit();
ProxyAuthorizationPolicy policy = new ProxyAuthorizationPolicy();
policy.setAuthorizationType("Basic");
policy.setUserName(PROXY_USER);
policy.setPassword(PROXY_PWD);
conduit.setProxyAuthorization(policy);

port.echo("Foo");</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>ProxyAuthorizationPolicy</code> also allows for setting the authotization
type as well as the username / password to be used.</p>
</div>
<div class="paragraph">
<p>Speaking of authorization and authentication, please note that the JDK
already features the <code>java.net.Authenticator</code> facility, which is used
whenever opening a connection to a given URL requiring a http proxy.
Users might want to set a custom Authenticator for instance when needing
to read WSDL contracts before actually calling into the JBoss Web
Services / Apache CXF code; here is an example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">import java.net.Authenticator;
import java.net.PasswordAuthentication;
...
public class ProxyAuthenticator extends Authenticator
{
   private String user, password;

   public ProxyAuthenticator(String user, String password)
   {
      this.user = user;
      this.password = password;
   }

   protected PasswordAuthentication getPasswordAuthentication()
   {
      return new PasswordAuthentication(user, password.toCharArray());
   }
}

...

Authenticator.setDefault(new ProxyAuthenticator(PROXY_USER, PROXY_PWD));</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="WS-Discovery"><a class="anchor" href="#WS-Discovery"></a>16.5.17. WS-Discovery</h4>
<div class="paragraph">
<p>Apache CXF includes support for <em>Web Services Dynamic Discovery</em> (
<a href="http://docs.oasis-open.org/ws-dd/discovery/1.1/os/wsdd-discovery-1.1-spec-os.html">WS-Discovery</a>),
which is a protocol to enable dynamic discovery of services available on
the local network. The protocol implies using a <code>UDP</code> based multicast
transport to announce new services and probe for existing services. A
managed mode where a discovery proxy is used to reduce the amount of
required multicast traffic is also covered by the protocol.</p>
</div>
<div class="paragraph">
<p>JBossWS integrates the <em>WS-Discovery</em>
<a href="http://cxf.apache.org/docs/ws-discovery.html">functionalities</a> provided
by Apache CXF into the application server.</p>
</div>
<div class="sect4">
<h5 id="enabling-ws-discovery"><a class="anchor" href="#enabling-ws-discovery"></a>Enabling WS-Discovery</h5>
<div class="paragraph">
<p>Apache CXF enables <em>WS-Discovery</em> depending on the availability of its
runtime component; given that&#8217;s always shipped in the application
server, JBossWS integration requires using the
<code>cxf.ws-discovery.enabled</code>
<a href="https://docs.jboss.org/author/display/WFLY8/Advanced+User+Guide#AdvancedUserGuide-Configurationthroughdeploymentdescriptor">property</a>
usage for enabling <em>WS-Discovery</em> for a given deployment. By default
<em>WS-Discovery</em> is disabled on the application server. Below is an
example of <em>jboss-webservices.xml</em> descriptor to be used for enabling
<em>WS-Discovery</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;webservices xmlns="http://www.jboss.com/xml/ns/javaee" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  version="1.2" xsi:schemaLocation="http://www.jboss.com/xml/ns/javaee"&gt;

  &lt;property&gt;
    &lt;name&gt;cxf.ws-discovery.enabled&lt;/name&gt;
    &lt;value&gt;true&lt;/value&gt;
  &lt;/property&gt;

&lt;/webservices&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>By default, a <em>WS-Discovery</em> service endpoint (SOAP-over-UDP bound) will
be started the first time a WS-Discovery enabled deployment is processed
on the application server. Every ws endpoint belonging to <em>WS-Discovery</em>
enabled deployments will be automatically registered into such a
<em>WS-Discovery</em> service endpoint ( <code>Hello</code> messages). The service will
reply to <code>Probe</code> and <code>Resolve</code> messages received on <code>UDP</code> port <code>3702</code>
(including multicast messages sent to <code>IPv4</code> address <code>239.255.255.250</code>,
as per
<a href="http://docs.oasis-open.org/ws-dd/discovery/1.1/os/wsdd-discovery-1.1-spec-os.html#_Toc234231816">specification</a>).
Endpoints will eventually be automatically unregistered using <code>Bye</code>
messages upon undeployment.</p>
</div>
</div>
<div class="sect4">
<h5 id="probing-services"><a class="anchor" href="#probing-services"></a>Probing services</h5>
<div class="paragraph">
<p>Apache CXF comes with a <em>WS-Discovery</em> API that can be used to probe /
resolve services. When running in-container, a JBoss module
<a href="#JAX_WS_JBoss_Modules_and_WS_applications">dependency</a> to the <code>org.apache.cxf.impl</code> module is to
be set to have access to <em>WS-Discovery</em> client functionalities.</p>
</div>
<div class="paragraph">
<p>The
<a href="http://svn.apache.org/viewvc/cxf/tags/cxf-2.7.5/services/ws-discovery/ws-discovery-api/src/main/java/org/apache/cxf/ws/discovery/WSDiscoveryClient.java?revision=1481139&amp;view=markup">org.apache.cxf.ws.discovery.WSDiscoveryClient</a>
class provides the <em>probe</em> and <em>resolve</em> methods which also accepts
filters on scopes. Users can rely on them for locating available
endpoints on the network. Please have a look at the JBossWS testsuite
which includes a
<a href="http://anonsvn.jboss.org/repos/jbossws/stack/cxf/tags/jbossws-cxf-4.2.0.Beta1/modules/testsuite/cxf-tests/src/test/java/org/jboss/test/ws/jaxws/samples/wsdd/WSDiscoveryTestCase.java">sample</a>
on CXF WS-Discovery usage.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="WS-Policy"><a class="anchor" href="#WS-Policy"></a>16.5.18. WS-Policy</h4>
<div class="sect4">
<h5 id="apache-cxf-ws-policy-support"><a class="anchor" href="#apache-cxf-ws-policy-support"></a>Apache CXF WS-Policy support</h5>
<div class="paragraph">
<p>JBossWS policy support rely on the Apache CXF WS-Policy framework, which
is compliant with the
<a href="http://www.w3.org/TR/2007/REC-ws-policy-20070904/">Web Services Policy
1.5 - Framework</a> and
<a href="http://www.w3.org/TR/2007/REC-ws-policy-attach-20070904/">Web Services
Policy 1.5 - Attachment</a> specifications.<br>
Users can work with policies in different ways:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>by adding policy assertions to wsdl contracts and letting the runtime
consume them and behave accordingly;</p>
</li>
<li>
<p>by specifying endpoint policy attachments using either CXF annotations
or features.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Of course users can also make direct use of the Apache CXF policy
framework,
<a href="http://cxf.apache.org/docs/developing-assertions.html">defining custom
assertions</a>, etc.</p>
</div>
<div class="paragraph">
<p>Finally, JBossWS provides some additional annotations for simplified
policy attachment.</p>
</div>
<div class="sect5">
<h6 id="contract-first-approach"><a class="anchor" href="#contract-first-approach"></a>Contract-first approach</h6>
<div class="paragraph">
<p>WS-Policies can be attached and referenced in wsdl elements (the
specifications describe all possible alternatives). Apache CXF
automatically recognizes, reads and uses policies defined in the wsdl.</p>
</div>
<div class="paragraph">
<p>Users should hence develop endpoints using the <em>contract-first</em>
approach, that is explicitly providing the contract for their services.
Here is a excerpt taken from a wsdl including a WS-Addressing policy:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;wsdl:definitions name="Foo" targetNamespace="http://ws.jboss.org/foo"
...
&lt;wsdl:service name="FooService"&gt;
    &lt;wsdl:port binding="tns:FooBinding" name="FooPort"&gt;
        &lt;soap:address location="http://localhost:80800/foo"/&gt;
        &lt;wsp:Policy xmlns:wsp="http://www.w3.org/ns/ws-policy"&gt;
             &lt;wsam:Addressing xmlns:wsam="http://www.w3.org/2007/02/addressing/metadata"&gt;
                 &lt;wsp:Policy/&gt;
              &lt;/wsam:Addressing&gt;
         &lt;/wsp:Policy&gt;
    &lt;/wsdl:port&gt;
&lt;/wsdl:service&gt;
&lt;/wsdl:definitions&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Of course, CXF also acts upon policies specified in wsdl documents
consumed on client side.</p>
</div>
</div>
<div class="sect5">
<h6 id="code-first-approach"><a class="anchor" href="#code-first-approach"></a>Code-first approach</h6>
<div class="paragraph">
<p>For those preferring code-first (java-first) endpoint development,
Apache CXF comes with <code>org.apache.cxf.annotations.Policy</code> and
<code>org.apache.cxf.annotations.Policies</code> annotations to be used for
attaching policy fragments to the wsdl generated at deploy time.</p>
</div>
<div class="paragraph">
<p>Here is an example of a code-first endpoint including @Policy
annotation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">import javax.jws.WebService;
import org.apache.cxf.annotations.Policy;

@WebService(portName = "MyServicePort",
            serviceName = "MyService",
            name = "MyServiceIface",
            targetNamespace = "http://www.jboss.org/jbossws/foo")
@Policy(placement = Policy.Placement.BINDING, uri = "JavaFirstPolicy.xml")
public class MyServiceImpl {
   public String sayHello() {
      return "Hello World!";
   }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The referenced descriptor is to be added to the deployment and will
include the policy to be attached; the attachment position in the
contracts is defined through the <code>placement</code> attribute. Here is a
descriptor example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;?xml version="1.0" encoding="UTF-8" ?&gt;
&lt;wsp:Policy wsu:Id="MyPolicy" xmlns:wsp="http://www.w3.org/ns/ws-policy"
    xmlns:wsu="http://docs.oasis-open.org/wss/2004/01/oasis-200401-wss-wssecurity-utility-1.0.xsd"&gt;
    &lt;wsp:ExactlyOne&gt;
        &lt;wsp:All&gt;
            &lt;sp:SupportingTokens xmlns:sp="http://schemas.xmlsoap.org/ws/2005/07/securitypolicy"&gt;
                &lt;wsp:Policy&gt;
                    &lt;sp:UsernameToken sp:IncludeToken="http://schemas.xmlsoap.org/ws/2005/07/securitypolicy/IncludeToken/AlwaysToRecipient"&gt;
                        &lt;wsp:Policy&gt;
                            &lt;sp:WssUsernameToken10/&gt;
                        &lt;/wsp:Policy&gt;
                    &lt;/sp:UsernameToken&gt;
                &lt;/wsp:Policy&gt;
            &lt;/sp:SupportingTokens&gt;
        &lt;/wsp:All&gt;
    &lt;/wsp:ExactlyOne&gt;
&lt;/wsp:Policy&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="jbossws-additions"><a class="anchor" href="#jbossws-additions"></a>JBossWS additions</h5>
<div class="sect5">
<h6 id="policy-sets"><a class="anchor" href="#policy-sets"></a>Policy sets</h6>
<div class="paragraph">
<p>Both approaches above require users to actually write their policies'
assertions; while this offer great flexibility and control of the actual
contract, providing the assertions might end up being quite a
challenging task for complex policies. For this reason, the JBossWS
integration provides <em>policy sets</em>, which are basically pre-defined
groups of policy assertions corresponding to well known / common needs.
Each set has a label allowing users to specify it in the
<code>@org.jboss.ws.api.annotation.PolicySets</code> annotation to have the policy
assertions for that set attached to the annotated endpoint. Multiple
labels can also be specified. Here is an example of the @PolicySets
annotation on a service endpoint interface:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">import javax.jws.WebService;
import org.jboss.ws.api.annotation.PolicySets;

@WebService(name = "EndpointTwo", targetNamespace = "http://org.jboss.ws.jaxws.cxf/jbws3648")
@PolicySets({"WS-RM_Policy_spec_example", "WS-SP-EX223_WSS11_Anonymous_X509_Sign_Encrypt", "WS-Addressing"})
public interface EndpointTwo
{
   String echo(String input);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The three sets specified in @PolicySets will cause the wsdl generated
for the endpoint having this interface to be enriched with some policy
assertions for WS-RM, WS-Security and WS-Addressing.</p>
</div>
<div class="paragraph">
<p>The labels' list of known sets is stored in the
<code>META-INF/policies/org.jboss.wsf.stack.cxf.extensions.policy.PolicyAttachmentStore</code>
file within the <code>jbossws-cxf-client.jar</code> (
<code>org.jboss.ws.cxf:jbossws-cxf-client</code> maven artifact). Actual policy
fragments for each set are also stored in the same artifact at
<code>META-INF/policies/&lt;set-label&gt;-&lt;attachment-position&gt;.xml</code>.</p>
</div>
<div class="paragraph">
<p>Here is a list of the available policy sets:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Label</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">WS-Addressing</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Basic WS-Addressing policy</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">WS-RM_Policy_spec_example</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The basic WS-RM policy example in the WS-RM
specification</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">WS-SP-EX2121_SSL_UT_Supporting_Token</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The group of policy assertions
used in the section 2.1.2.1 example of the WS-Security Policy Examples
1.0 specification</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">WS-SP-EX213_WSS10_UT_Mutual_Auth_X509_Sign_Encrypt</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The group of policy
assertions used in the section 2.1.3 example of the WS-Security Policy
Examples 1.0 specification</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">WS-SP-EX214_WSS11_User_Name_Cert_Sign_Encrypt</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The group of policy
assertions used in the section 2.1.4 example of the WS-Security Policy
Examples 1.0 specification</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">WS-SP-EX221_WSS10_Mutual_Auth_X509_Sign_Encrypt</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The group of policy
assertions used in the section 2.2.1 example of the WS-Security Policy
Examples 1.0 specification</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">WS-SP-EX222_WSS10_Mutual_Auth_X509_Sign_Encrypt</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The group of policy
assertions used in the section 2.2.2 example of the WS-Security Policy
Examples 1.0 specification</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">WS-SP-EX223_WSS11_Anonymous_X509_Sign_Encrypt</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The group of policy
assertions used in the section 2.2.3 example of the WS-Security Policy
Examples 1.0 specification</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">WS-SP-EX224_WSS11_Mutual_Auth_X509_Sign_Encrypt</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The group of policy
assertions used in the section 2.2.4 example of the WS-Security Policy
Examples 1.0 specification</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">AsymmetricBinding_X509v1_TripleDesRsa15_EncryptBeforeSigning_ProtectTokens</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A WS-Security policy for asymmetric binding (encrypt before signing)
using X.509v1 tokens, 3DES + RSA 1.5 algorithms and with token
protections enabled</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">AsymmetricBinding_X509v1_GCM256OAEP_ProtectTokens</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The same as before,
but using custom Apache CXF algorithm suite including GCM 256 + RSA OAEP
algorithms</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Always verify the contents of the generated wsdl contract, as policy
sets are potentially subject to updates between JBossWS releases. This
is especially important when dealing with security related policies; the
provided sets are to be considered as convenient configuration options
only; users remain responsible for the policies in their contracts.
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
The <code>org.jboss.wsf.stack.cxf.extensions.policy.Constants</code> interface has
convenient String constants for the available policy set labels.
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
If you feel a new set should be added, just propose it by writing the
user forum!
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="Published_WSDL_customization"><a class="anchor" href="#Published_WSDL_customization"></a>16.5.19. Published WSDL customization</h4>
<div class="sect4">
<h5 id="endpoint-address-rewrite"><a class="anchor" href="#endpoint-address-rewrite"></a>Endpoint address rewrite</h5>
<div class="paragraph">
<p>JBossWS supports the rewrite of the <code>&lt;soap:address&gt;</code> element of
endpoints published in WSDL contracts. This feature is useful for
controlling the server address that is advertised to clients for each
endpoint. The rewrite mechanism is configured at server level through a
set of elements in the webservices subsystem of the WildFly management
model. Please refer to the container documentation for details on the
options supported in the selected container version. Below is a list of
the elements available in the latest WildFly sources:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Name</th>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">modify-wsdl-address</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">boolean</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">This boolean enables and disables the
address rewrite functionality.When modify-wsdl-address is set to true
and the content of &lt;soap:address&gt; is a valid URL, JBossWS will rewrite
the URL using the values of wsdl-host and wsdl-port or
wsdl-secure-port.When modify-wsdl-address is set to false and the
content of &lt;soap:address&gt; is a valid URL, JBossWS will not rewrite the
URL. The &lt;soap:address&gt; URL will be used.When the content of
&lt;soap:address&gt; is not a valid URL, JBossWS will rewrite it no matter
what the setting of modify-wsdl-address.If modify-wsdl-address is set to
true and wsdl-host is not defined or explicitly set to
'jbossws.undefined.host' the content of &lt;soap:address&gt; URL is use.
JBossWS uses the requester&#8217;s host when rewriting the &lt;soap:address&gt;When
modify-wsdl-address is not defined JBossWS uses a default value of true.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">wsdl-host</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">string</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The hostname / IP address to be used for rewriting
&lt;soap:address&gt;.If wsdl-host is set to jbossws.undefined.host, JBossWS
uses the requester&#8217;s host when rewriting the &lt;soap:address&gt;When
wsdl-host is not defined JBossWS uses a default value of
'jbossws.undefined.host'.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">wsdl-port</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">int</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set this property to explicitly define the HTTP port
that will be used for rewriting the SOAP address.Otherwise the HTTP port
will be identified by querying the list of installed HTTP connectors.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">wsdl-secure-port</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">int</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set this property to explicitly define the HTTPS
port that will be used for rewriting the SOAP address.Otherwise the
HTTPS port will be identified by querying the list of installed HTTPS
connectors.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">wsdl-uri-scheme</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">string</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">This property explicitly sets the URI scheme
to use for rewriting &lt;soap:address&gt; . Valid values are http and https.
This configuration overrides scheme computed by processing the endpoint
(even if a transport guaranteeis specified). The provided values for
wsdl-port and wsdl-secure-port (or their default values) are used
depending on specified scheme.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">wsdl-path-rewrite-rule</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">string</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">This string defines a SED substitution
command (e.g., 's/regexp/replacement/g') that JBossWS executes against
the path component of each &lt;soap:address&gt; URL published from the
server.When wsdl-path-rewrite-rule is not defined, JBossWS retains the
original path component of each &lt;soap:address&gt; URL.When
'modify-wsdl-address' is set to "false" this element is ignored.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Additionally, users can override the server level configuration by
requesting a specific rewrite behavior for a given endpoint deployment.
That is achieved by setting one of the following properties within a
<em>jboss-webservices.xml</em> descriptor:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Property</th>
<th class="tableblock halign-left valign-top">Corresponding server option</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">wsdl.soapAddress.rewrite.modify-wsdl-address</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">modify-wsdl-address</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">wsdl.soapAddress.rewrite.wsdl-host</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">wsdl-host</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">wsdl.soapAddress.rewrite.wsdl-port</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">wsdl-port</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">wsdl.soapAddress.rewrite.wsdl-secure-port</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">wsdl-secure-port</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">wsdl.soapAddress.rewrite.wsdl-path-rewrite-rule</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">wsdl-path-rewrite-rule</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">wsdl.soapAddress.rewrite.wsdl-uri-scheme</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">wsdl-uri-scheme</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Here is an example of partial overriding of the default configuration
for a specific deployment:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;?xml version="1.1" encoding="UTF-8"?&gt;
&lt;webservices version="1.2"
  xmlns="http://www.jboss.com/xml/ns/javaee"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="http://www.jboss.com/xml/ns/javaee"&gt;
  &lt;property&gt;
    &lt;name&gt;wsdl.soapAddress.rewrite.wsdl-uri-scheme&lt;/name&gt;
    &lt;value&gt;https&lt;/value&gt;
  &lt;/property&gt;
  &lt;property&gt;
    &lt;name&gt;wsdl.soapAddress.rewrite.wsdl-host&lt;/name&gt;
    &lt;value&gt;foo&lt;/value&gt;
  &lt;/property&gt;
&lt;/webservices&gt;</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="system-property-references"><a class="anchor" href="#system-property-references"></a>System property references</h5>
<div class="paragraph">
<p>System property references wrapped within "@" characters are expanded
when found in WSDL attribute and element values. This allows for
instance including multiple WS-Policy declarations in the contract and
selecting the policy to use depending on a server wide system property;
here is an example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;wsdl:definitions ...&gt;
  ...
  &lt;wsdl:binding name="ServiceOneSoapBinding" type="tns:EndpointOne"&gt;
    ...
    &lt;wsp:PolicyReference URI="#@org.jboss.wsf.test.JBWS3628TestCase.policy@"/&gt;
    &lt;wsdl:operation name="echo"&gt;
      ...
    &lt;/wsdl:operation&gt;
  &lt;/wsdl:binding&gt;
  &lt;wsdl:service name="ServiceOne"&gt;
    &lt;wsdl:port binding="tns:ServiceOneSoapBinding" name="EndpointOnePort"&gt;
      &lt;soap:address location="http://localhost:8080/jaxws-cxf-jbws3628/ServiceOne"/&gt;
    &lt;/wsdl:port&gt;
  &lt;/wsdl:service&gt;

  &lt;wsp:Policy xmlns:wsu="http://docs.oasis-open.org/wss/2004/01/oasis-200401-wss-wssecurity-utility-1.0.xsd" xmlns:wsp="http://www.w3.org/ns/ws-policy" wsu:Id="WS-RM_Policy"&gt;
 &lt;wsrmp:RMAssertion xmlns:wsrmp="http://schemas.xmlsoap.org/ws/2005/02/rm/policy"&gt;
          ...
   &lt;/wsrmp:RMAssertion&gt;
  &lt;/wsp:Policy&gt;

  &lt;wsp:Policy xmlns:wsu="http://docs.oasis-open.org/wss/2004/01/oasis-200401-wss-wssecurity-utility-1.0.xsd" xmlns:wsp="http://www.w3.org/ns/ws-policy"
      xmlns:wsam="http://www.w3.org/2007/05/addressing/metadata" wsu:Id="WS-Addressing_policy"&gt;
    &lt;wsam:Addressing&gt;
      &lt;wsp:Policy/&gt;
    &lt;/wsam:Addressing&gt;
  &lt;/wsp:Policy&gt;
&lt;/wsdl:definitions&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>If the <strong><em>org.jboss.wsf.test.JBWS3628TestCase.policy</em></strong> system property is
defined and set to " <strong><em>WS-Addressing_policy</em></strong> ", WS-Addressing will be
enabled for the endpoint defined by the contract above.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="JAX_WS_JBoss_Modules_and_WS_applications"><a class="anchor" href="#JAX_WS_JBoss_Modules_and_WS_applications"></a>16.6. JBoss Modules and WS applications</h3>
<div class="paragraph">
<p>The JBoss Web Services functionalities are provided by a given set of
modules / libraries installed on WildFly, which are organized into JBoss
Modules modules. In particular the <em>org.jboss.as.webservices.*</em> and
<em>org.jboss.ws.*</em> modules belong to the JBossWS - WildFly integration.
Users should not need to change anything in them.</p>
</div>
<div class="paragraph">
<p>While users are of course allowed to provide their own modules for their
custom needs, below is a brief collection of suggestions and hints
around modules and webservices development on WildFly.</p>
</div>
<div class="sect3">
<h4 id="setting-module-dependencies"><a class="anchor" href="#setting-module-dependencies"></a>16.6.1. Setting module dependencies</h4>
<div class="paragraph">
<p>On WildFly the user deployment classloader does not have any visibility
over JBoss internals; so for instance you can&#8217;t <em>directly</em> use JBossWS
<em>implementation</em> classes unless you explicitly set a dependency to the
corresponding module. As a consequence, users need to declare the module
dependencies they want to be added to their deployment.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
The JBoss Web Services APIs are always available by default whenever the
webservices subsystem is available on AS7. So users just use them, no
need for explicit dependencies declaration for those modules.
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="using-manifest.mf"><a class="anchor" href="#using-manifest.mf"></a>Using MANIFEST.MF</h5>
<div class="paragraph">
<p>The convenient method for configuring deployment dependencies is adding
them into the MANIFEST.MF file:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>Manifest-Version: 1.0
Dependencies: org.jboss.ws.cxf.jbossws-cxf-client services export,foo.bar</pre>
</div>
</div>
<div class="paragraph">
<p>Here above <em>org.jboss.ws.cxf.jbossws-cxf-client</em> and <em>foo.bar</em> are the
modules you want to set dependencies to; <em>services</em> tells the modules
framework that you want to also import <em>META-INF/services/..</em>
declarations from the dependency, while <em>export</em> exports the classes
from the module to any other module that might be depending on the
module implicitly created for your deployment.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
When using annotations on your endpoints / handlers such as the Apache
CXF ones (@InInterceptor, @GZIP, &#8230;&#8203;) remember to add the proper module
dependency in your manifest. Otherwise your annotations are not picked
up and added to the annotation index by WildFly, resulting in them being
completely and silently ignored.
</td>
</tr>
</table>
</div>
<div class="sect5">
<h6 id="using-Jakarta-XML-Binding"><a class="anchor" href="#using-Jakarta-XML-Binding"></a>Using Jakarta XML Binding</h6>
<div class="paragraph">
<p>In order for successfully directly using Jakarta XML Binding contexts, etc. in your
client or endpoint running in-container, you need to properly setup a
Jakarta XML Binding implementation; that is performed setting the following dependency:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>Dependencies: com.sun.xml.bind services export</pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="using-apache-cxf"><a class="anchor" href="#using-apache-cxf"></a>Using Apache CXF</h6>
<div class="paragraph">
<p>In order for using Apache CXF APIs and implementation classes you need
to add a dependency to the <em>org.apache.cxf</em> (API) module and / or
<em>org.apache.cxf.impl</em> (implementation) module:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>Dependencies: org.apache.cxf services</pre>
</div>
</div>
<div class="paragraph">
<p>However, please note that would not come with any JBossWS-CXF
customizations nor additional extensions. For this reason, and generally
speaking for simplifying user configuration, a client side aggregation
module is available with all the WS dependencies users might need.</p>
</div>
</div>
<div class="sect5">
<h6 id="client-side-ws-aggregation-module"><a class="anchor" href="#client-side-ws-aggregation-module"></a>Client side WS aggregation module</h6>
<div class="paragraph">
<p>Whenever you simply want to use all the JBoss Web Services
feature/functionalities, you can set a dependency to the convenient
client module.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>Dependencies: org.jboss.ws.cxf.jbossws-cxf-client services</pre>
</div>
</div>
<div class="paragraph">
<p>Please note the <em>services</em> option above: that&#8217;s strictly required in
order for you to get the JBossWS-CXF version of classes that are
retrieved using the <em>Service API</em>, the <code>org.apache.cxf.Bus</code> for
instance.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Be careful as issues because of misconfiguration here can be quite hard
to track down, because the Apache CXF behaviour would be sensibly
different.
</td>
</tr>
</table>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
The <em>services</em> option is almost always needed when declaring
dependencies on <em>org.jboss.ws.cxf.jbossws-cxf-client</em> and
<em>org.apache.cxf</em> modules. The reason for this is in it affecting the
loading of classes through the <em>Service API</em>, which is what is used to
wire most of the JBossWS components as well as all Apache CXF Bus
extensions.
</td>
</tr>
</table>
</div>
</div>
<div class="sect5">
<h6 id="annotation-scanning"><a class="anchor" href="#annotation-scanning"></a>Annotation scanning</h6>
<div class="paragraph">
<p>The application server uses an annotation index for detecting Jakarta XML Web Services
endpoints in user deployments. When declaring WS endpoints whose class
belongs to a different module (for instance referring that in the
<code>web.xml</code> descriptor), be sure to have an <code>annotations</code> type dependency
in place. Without that, your endpoints would simply be ignored as they
won&#8217;t appear as annotated classes to the webservices subsystem.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">Dependencies: org.foo annotations</code></pre>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="using-jboss-deployment-descriptor.xml"><a class="anchor" href="#using-jboss-deployment-descriptor.xml"></a>Using jboss-deployment-descriptor.xml</h5>
<div class="paragraph">
<p>In some circumstances, the convenient approach of setting module
dependencies in MANIFEST.MF might not work. An example is the need for
importing/exporting specific resources from a given module dependency.
Users should hence add a jboss-deployment-structure.xml descriptor to
their deployment and set module dependencies in it.</p>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="Scoped_EJB_client_contexts"><a class="anchor" href="#Scoped_EJB_client_contexts"></a>17. Scoped EJB client contexts</h2>
<div class="sectionbody">
<div class="quoteblock abstract">
<blockquote>
WildFly 14 introduced the EJB client API for managing remote EJB
invocations. The EJB client API works off EJBClientContext(s). An
EJBClientContext can potentially contain any number of EJB receivers. An
EJB receiver is a component which knows how to communicate with a server
which is capable of handling the EJB invocation. Typically EJB remote
applications can be classified into:
</blockquote>
</div>
<div class="ulist">
<ul>
<li>
<p>A remote client which runs as a standalone Java application</p>
</li>
<li>
<p>A remote client which runs within another WildFly 14 instance</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Depending on the kind of remote client, from an EJB client API point of
view, there can potentially be more than 1 EJBClientContext(s) within a
JVM.</p>
</div>
<div class="paragraph">
<p>In case of standalone applications, typically a single EJBClientContext
(backed by any number of EJB receivers) exists. However this isn&#8217;t
mandatory. Certain standalone applications can potentially have more
than one EJBClientContext(s) and an EJB client context selector will be
responsible for returning the appropriate context.</p>
</div>
<div class="paragraph">
<p>In case of remote clients which run within another WildFly 14 instance,
each deployed application will have a corresponding EJB client context.
Whenever that application invokes on another EJB, the corresponding EJB
client context will be used for finding the right EJB receiver and
letting it handle the invocation.</p>
</div>
<div class="sect2">
<h3 id="potential-shortcomings-of-a-single-ejb-client-context"><a class="anchor" href="#potential-shortcomings-of-a-single-ejb-client-context"></a>17.1. Potential shortcomings of a single EJB client context</h3>
<div class="paragraph">
<p>In the Overview section we briefly looked at the different types of
remote clients. Let&#8217;s focus on the standalone remote clients (the ones
that don&#8217;t run within another WildFly 14 instance) for some of the next
sections. Like mentioned earlier, typically a remote standalone client
has just one EJB client context backed by any number of EJB receivers.
Consider this example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">public class MyApplication {

    public static void main(String args[]) {

        final javax.naming.Context ctxOne = new javax.naming.InitialContext();
        final MyBeanInterface beanOne = ctxOne.lookup("ejb:app/module/distinct/bean!interface");
        beanOne.doSomething();
        ...
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now, we have seen in this other chapter
<a href="https://docs.jboss.org/author/display/WFLY8/EJB+invocations+from+a+remote+client+using+JNDI">EJB
invocations from a remote client using JNDI</a> that the JNDI lookups are
(typically) backed by jboss-ejb-client.properties file which is used to
setup the EJB client context and the EJB receivers. Let&#8217;s assume we have
a jboss-ejb-client.properties with the relevant receivers
configurations. These configurations include the security credentials
that will be used to create an EJB receiver which connects to the AS7
server. Now when the above code is invoked, the EJB client API looks for
the EJB client context to pick an EJB receiver, to pass on the EJB
invocation request. Since we just have a single EJB client context, that
context is used by the above code to invoke the bean.</p>
</div>
<div class="paragraph">
<p>Now let&#8217;s consider a case where the user application wants to invoke on
the bean more than once, but wants to connect to the WildFly 14 server
using different security credentials. Let&#8217;s take a look at the following
code:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">public class MyApplication {

    public static void main(String args[]) {

        // let's say we want to use "foo" security credential while connecting to the AS7 server for invoking on this bean instance
        final javax.naming.Context ctxOne = new javax.naming.InitialContext();
        final MyBeanInterface beanOne = ctxOne.lookup("ejb:app/module/distinct/bean!interface");
        beanOne.doSomething();
        ...

        // let's say we want to use "bar" security credential while connecting to the AS7 server for invoking on this bean instance
        final javax.naming.Context ctxTwo = new javax.naming.InitialContext();
        final MyBeanInterface beanTwo = ctxTwo.lookup("ejb:app/module/distinct/bean!interface");
        beanTwo.doSomething();
        ...

    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>So we have the same application, which wants to connect to the same
server instance for invoking the EJB(s) hosted on that server, but wants
to use two different credentials while connecting to the server.
Remember, the client application has a single EJB client context which
can have atmost 1 EJB receiver for each server instance. Which
effectively means that the above code will end up using just one
credential to connect to the server. So there was no easy way to have
the above code working.</p>
</div>
<div class="paragraph">
<p>That was one of the use cases which prompted the
<a href="https://issues.redhat.com/browse/EJBCLIENT-34" class="bare">https://issues.redhat.com/browse/EJBCLIENT-34</a> feature request. The
proposal was to introduce a way, where you can have more control over
the EJB client contexts and their association with JNDI contexts which
are typically used for EJB invocations.</p>
</div>
</div>
<div class="sect2">
<h3 id="scoped-ejb-client-contexts"><a class="anchor" href="#scoped-ejb-client-contexts"></a>17.2. Scoped EJB client contexts</h3>
<div class="paragraph">
<p>Developers familiar with earlier versions of JBoss AS would remember
that for invoking an EJB, you would typically create a JNDI context
passing it the PROVIDER_URL which would point to the target server. That
way any invocation is done on EJB proxies looked up using that JNDI
context, would end up on that server. If we look back at the example
above, we&#8217;ll realize that, we are ultimately aiming for a similar
functionality through <a href="https://issues.redhat.com/browse/EJBCLIENT-34" class="bare">https://issues.redhat.com/browse/EJBCLIENT-34</a>. We
want the user applications to have more control over which EJB receiver
gets used for a specific invocation.</p>
</div>
<div class="paragraph">
<p>Before we introduced <a href="https://issues.redhat.com/browse/EJBCLIENT-34" class="bare">https://issues.redhat.com/browse/EJBCLIENT-34</a>
feature, the EJB client context was typically scoped to the client
application. As part of <a href="https://issues.redhat.com/browse/EJBCLIENT-34" class="bare">https://issues.redhat.com/browse/EJBCLIENT-34</a> we
now allow the EJB client contexts to be scoped with the JNDI contexts.
Consider the following example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">public class MyApplication {

    public static void main(String args[]) {

        // let's say we want to use "foo" security credential while connecting to the AS7 server for invoking on this bean instance
        final Properties ejbClientContextPropsOne = getPropsForEJBClientContextOne():
        final javax.naming.Context ctxOne = new javax.naming.InitialContext(ejbClientContextPropsOne);
        final MyBeanInterface beanOne = ctxOne.lookup("ejb:app/module/distinct/bean!interface");
        beanOne.doSomething();
        ...
        closeContext(ctxOne); // read on the entire article to understand more about closing scoped EJB client contexts

        // let's say we want to use "bar" security credential while connecting to the AS7 server for invoking on this bean instance
        final Properties ejbClientContextPropsTwo = getPropsForEJBClientContextTwo():
        final javax.naming.Context ctxTwo = new javax.naming.InitialContext(ejbClientContextPropsTwo);
        final MyBeanInterface beanTwo = ctxTwo.lookup("ejb:app/module/distinct/bean!interface");
        beanTwo.doSomething();
        ...
        closeContext(ctxTwo); // read on the entire article to understand more about closing scoped EJB client contexts
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Notice any difference between this code and the earlier one? We now
create and pass EJB client context specific properties to the JNDI
context. So what do the EJB client context properties look like? The
properties are the same that you would pass through the
jboss-ejb-client.properties file, except for one additional property
which is required to scope the EJB client context to the JNDI context.
The name of the property is:</p>
</div>
<div class="paragraph">
<p><code>org.jboss.ejb.client.scoped.context</code></p>
</div>
<div class="paragraph">
<p>which is expected to have a value true. This property lets the EJB
client API know that it has to created an EJB client context (backed by
EJB receiver(s)) and that created context is then scoped/visible to only
that JNDI context which created it. Lookup and invocation on any EJB
proxies looked up using this JNDI context will only know of the EJB
client context associated with this JNDI context. This effectively means
that the other JNDI contexts which the application uses to lookup and
invoke on EJBs will <em>not</em> know about the other scoped EJB client
contexts at all.</p>
</div>
<div class="paragraph">
<p>JNDI contexts which aren&#8217;t scoped to a EJB client context (for example,
not passing the org.jboss.ejb.client.scoped.context property) will
fallback to the default behaviour of using the "current" EJB client
context which typically is the one tied to the entire application.</p>
</div>
<div class="paragraph">
<p>This scoping of the EJB client context helps the user applications to
have more control over which JNDI context "talks to" which server and
connects to that server in "what way". This gives the user applications
the flexibility that was associated with the JNP based JNDI invocations
prior to WildFly 14 versions.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<strong>IMPORTANT:</strong> <strong>It is very important to remember that scoped EJB client
contexts which are scoped to the JNDI contexts are NOT fire and forget
kind of contexts. What that means is the application program which is
using these contexts is solely responsible for managing their lifecycle
and the application itself is responsible for closing the context at the
right moment. After closing the context the proxies which are bound to
this context are no longer valid and any invocation will throw an
Exception. Not closing the context will end in resource problems as the
underlying physical connection will stay open.</strong>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><strong>Read the rest of the sections in this article to understand more about
the lifecycle management of such scoped contexts.</strong></p>
</div>
</div>
<div class="sect2">
<h3 id="lifecycle-management-of-scoped-ejb-client-contexts"><a class="anchor" href="#lifecycle-management-of-scoped-ejb-client-contexts"></a>17.3. Lifecycle management of scoped EJB client contexts</h3>
<div class="paragraph">
<p>Like you saw in the previous sections, in case of scoped EJB client
contexts, the EJB client context is tied to the JNDI context. It&#8217;s very
important to understand how the lifecycle of the EJB client context
works in such cases. Especially since any EJB client context is almost
always backed by connections to the server. Not managing the EJB client
context lifecycle correctly can lead to connection leaks in some cases.</p>
</div>
<div class="paragraph">
<p>When you create a scoped EJB client context, the EJB client context
connects to the server(s) listed in the JNDI properties. An internal
implementation detail of this logic includes the ability of the EJB
client context to cache connections based on certain internal algorithm
it uses. The algorithm itself isn&#8217;t publicly documented (yet) since the
chances of it changing or even removal shouldn&#8217;t really affect the
client application and instead it&#8217;s supposed to be transparent to the
client application.</p>
</div>
<div class="paragraph">
<p>The connections thus created for an EJB client context are kept open as
long as the EJB client context is open. This allows the EJB client
context to be usable for EJB invocations. The connections associated
with the EJB client context are closed when the EJB client context
itself is closed.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The connections that were manually added by the application to the EJB
client context are <strong>not</strong> managed by the EJB client context. i.e. they
won&#8217;t be opened (obviously) nor closed by the EJB client API when the
EJB client context is closed.
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="how-to-close-ejb-client-contexts"><a class="anchor" href="#how-to-close-ejb-client-contexts"></a>17.3.1. How to close EJB client contexts?</h4>
<div class="paragraph">
<p>The answer to that is simple. Use the close() method on the appropriate
EJB client context.</p>
</div>
</div>
<div class="sect3">
<h4 id="how-to-close-scoped-ejb-client-contexts"><a class="anchor" href="#how-to-close-scoped-ejb-client-contexts"></a>17.3.2. How to close scoped EJB client contexts?</h4>
<div class="paragraph">
<p>The answer is the same, use the close() method on the EJB client
context. But the real question is how do you get the relevant scoped EJB
client context which is associated with a JNDI context. Before we get to
that, it&#8217;s important to understand how the ejb: JNDI namespace that&#8217;s
used for EJB lookups and how the JNDI context (typically the
InitialContext that you see in the client code) are related. The JNDI
API provided by Java language allows "URL context factory" to be
registered in the JNDI framework (see this for details
<a href="http://docs.oracle.com/javase/jndi/tutorial/provider/url/factory.html" class="bare">http://docs.oracle.com/javase/jndi/tutorial/provider/url/factory.html</a>).
Like that documentation states, the URL context factory can be used to
resolve URL strings during JNDI lookup. That&#8217;s what the ejb: prefix is
when you do a remote EJB lookup. The ejb: URL string is backed by a URL
context factory.</p>
</div>
<div class="paragraph">
<p>Internally, when a lookup happens for a ejb: URL string, a relevant
javax.naming.Context is created for that ejb: lookup. Let&#8217;s see some
code for better understanding:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">// JNDI context "A"
Context jndiCtx = new InitialContext(props);
// Now let's lookup a EJB
MyBean bean = jndiCtx.lookup("ejb:app/module/distinct/bean!interface");</code></pre>
</div>
</div>
<div class="paragraph">
<p>So we first create a JNDI context and then use it to lookup an EJB. The
bean lookup using the ejb: JNDI name, although, is just one statement,
involves a few more things under the hood. What&#8217;s actually happening
when you lookup that string is that a separate javax.naming.Context gets
created for the ejb: URL string. This new javax.naming.Context is then
used to lookup the rest of the string in that JNDI name.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s break up that one line into multiple statements to understand
better:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">// Remember, the ejb: is backed by a URL context factory which returns a Context for the ejb: URL (that's why it's called a context factory)
final Context ejbNamingContext = (Context) jndiCtx.lookup("ejb:");
// Use the returned EJB naming context to lookup the rest of the JNDI string for EJB
final MyBean bean = ejbNamingContext.lookup("app/module/distinct/bean!interface");</code></pre>
</div>
</div>
<div class="paragraph">
<p>As you see above, we split up that single statement into a couple of
statements for explaining the details better. So as you can see when the
ejb: URL string is parsed in a JNDI name, it gets hold of a
javax.naming.Context instance. This instance is different from the one
which was used to do the lookup (jndiCtx in this example). This is an
important detail to understand (for reasons explained later). Now this
returned instance is used to lookup the rest of the JNDI string
("app/module/distinct/bean!interface"), which then returns the EJB
proxy. Irrespective of whether the lookup is done in a single statement
or multiple parts, the code works the same. i.e. an instance of
javax.naming.Context gets created for the ejb: URL string.</p>
</div>
<div class="paragraph">
<p>So why am I explaining all this when the section is titled
<code>"How to close scoped EJB client contexts"</code>? The reason is because
client applications dealing with scoped EJB client contexts which are
associated with a JNDI context would expect the following code to close
the associated EJB client context, but will be surprised that it won&#8217;t:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">final Properties props = new Properties();
// mark it for scoped EJB client context
props.put("org.jboss.ejb.client.scoped.context","true");
// add other properties
props.put(....);
...
Context jndiCtx = new InitialContext(props);
try {
      final MyBean bean = jndiCtx.lookup("ejb:app/module/distinct/bean!interface");
      bean.doSomething();
} finally {
  jndiCtx.close();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Applications expect that the call to jndiCtx.close() will effectively
close the EJB client context associated with the JNDI context. That
doesn&#8217;t happen because as explained previously, the javax.naming.Context
backing the ejb: URL string is a different instance than the one the
code is closing. The JNDI implementation in Java, only just closes the
context on which the close was called. As a result, the other
javax.naming.Context that backs the ejb: URL string is still not closed,
which effectively means that the scoped EJB client context is not closed
too which then ultimately means that the connection to the server(s) in
the EJB client context are not closed too.</p>
</div>
<div class="paragraph">
<p>So now let&#8217;s see how this can be done properly. We know that the ejb:
URL string lookup returns us a javax.naming.Context. All we have to do
is keep a reference to this instance and close it when we are done with
the EJB invocations. So here&#8217;s how it&#8217;s going to look:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">final Properties props = new Properties();
// mark it for scoped EJB client context
props.put("org.jboss.ejb.client.scoped.context","true");
// add other properties
props.put(....);
...
Context jndiCtx = new InitialContext(props);
Context ejbRootNamingContext = (Context) jndiCtx.lookup("ejb:");
try {
    final MyBean bean = ejbRootNamingContext.lookup("app/module/distinct/bean!interface"); // the rest of the EJB jndi string
    bean.doSomething();
} finally {
    try {
        // close the EJB naming JNDI context
        ejbRootNamingContext.close();
    } catch (Throwable t) {
        // log and ignore
    }
    try {
        // also close our other JNDI context since we are done with it too
        jndiCtx.close();
    } catch (Throwable t) {
        // log and ignore
    }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>As you see, we changed the code to first do a lookup on just the "ejb:"
string to get hold of the EJB naming context and then used that
ejbRootNamingContext instance to lookup the rest of the EJB JNDI name to
get hold of the EJB proxy. Then when it was time to close the context,
we closed the ejbRootNamingContext (as well as the other JNDI context).
Closing the ejbRootNamingContext ensures that the scoped EJB client
context associated with that JNDI context is closed too. Effectively,
this closes the connection(s) to the server(s) within that EJB client
context.</p>
</div>
<div class="sect4">
<h5 id="can-that-code-be-simplified-a-bit"><a class="anchor" href="#can-that-code-be-simplified-a-bit"></a>Can that code be simplified a bit?</h5>
<div class="paragraph">
<p>If you are using that JNDI context only for EJB invocations, then yes
you can get rid of some instances and code from the above code. You can
change that code to:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">final Properties props = new Properties();
// mark it for scoped EJB client context
props.put("org.jboss.ejb.client.scoped.context","true");
// add other properties
props.put(....);
...
Context ejbRootNamingContext = (Context) new InitialContext(props).lookup("ejb:");
try {
    final MyBean bean = ejbRootNamingContext.lookup("app/module/distinct/bean!interface"); // the rest of the EJB jndi string
    bean.doSomething();
} finally {
    try {
        // close the EJB naming JNDI context
        ejbRootNamingContext.close();
    } catch (Throwable t) {
        // log and ignore
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Notice that we no longer hold a reference to 2 JNDI contexts and instead
just keep track of the ejbRootNamingContext which is actually the root
JNDI context for our "ejb:" URL string. Of course, this means that you
can only use this context for EJB lookups or any other EJB related JNDI
lookups. So it depends on your application and how it&#8217;s coded.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="cant-the-scoped-ejb-client-context-be-automatically-closed-by-the-ejb-client-api-when-the-jndi-context-is-no-longer-in-scope-i.e.-on-gc"><a class="anchor" href="#cant-the-scoped-ejb-client-context-be-automatically-closed-by-the-ejb-client-api-when-the-jndi-context-is-no-longer-in-scope-i.e.-on-gc"></a>17.3.3. Can&#8217;t the scoped EJB client context be automatically closed by the</h4>
<div class="paragraph">
<p>EJB client API when the JNDI context is no longer in scope (i.e. on GC)?</p>
</div>
<div class="paragraph">
<p>That&#8217;s one of the common questions that gets asked. No, the EJB client
API can&#8217;t take that decision. i.e. it cannot automatically go ahead and
close the scoped EJB client context by itself when the associated JNDI
context is eligible for GC. The reason is simple as illustrated by the
following code:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">void doEJBInvocation() {
    final MyBean bean = lookupEJB();
    bean.doSomething();
    bean.doSomeOtherThing();
    ... // do some other work
    bean.keepDoingSomething();
}

MyBean lookupEJB() {
    final Properties props = new Properties();
    // mark it for scoped EJB client context
    props.put("org.jboss.ejb.client.scoped.context","true");
    // add other properties
    props.put(....);
    ...
    Context ejbRootNamingContext = (Context) new InitialContext(props).lookup("ejb:");
    final MyBean bean = ejbRootNamingContext.lookup("app/module/distinct/bean!interface"); // rest of the EJB jndi string
    return bean;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see, the doEJBInvocation() method first calls a lookupEJB()
method which does a lookup of the bean using a JNDI context and then
returns the bean (proxy). The doEJBInvocation() then uses that returned
proxy and keeps doing the invocations on the bean. As you might have
noticed, the JNDI context that was used for lookup (i.e. the
ejbRootNamingContext) is eligible for GC. If the EJB client API had
closed the scoped EJB client context associated with that JNDI context,
when that JNDI context was garbage collected, then the subsequent EJB
invocations on the returned EJB (proxy) would start failing in
doEJBInvocation() since the EJB client context is no longer available.</p>
</div>
<div class="paragraph">
<p>That&#8217;s the reason why the EJB client API doesn&#8217;t automatically close the
EJB client context.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
References in this document to Enterprise JavaBeans(EJB) refer to the Jakarta Enterprise Beans unless otherwise noted.
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="EJB_invocations_from_a_remote_client_using_JNDI"><a class="anchor" href="#EJB_invocations_from_a_remote_client_using_JNDI"></a>18. EJB invocations from a remote client using JNDI</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This chapter explains how to invoke EJBs from a remote client by using
the JNDI API to first lookup the bean proxy and then invoke on that
proxy.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
After you have read this article, do remember to take a look at
<a href="https://docs.jboss.org/author/display/WFLY8/Remote+EJB+invocations+via+JNDI+-+EJB+client+API+or+remote-naming+project">Remote
EJB invocations via JNDI - EJB client API or remote-naming project</a>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Before getting into the details, we would like the users to know that we
have introduced a new EJB client API, which is a WildFly-specific API
and allows invocation on remote EJBs. This client API isn&#8217;t based on
JNDI. So remote clients need not rely on JNDI API to invoke on EJBs. A
separate document covering the EJB remote client API will be made
available. For now, you can refer to the javadocs of the EJB client
project at <a href="http://docs.jboss.org/ejbclient/" class="bare">http://docs.jboss.org/ejbclient/</a>. In this document, we&#8217;ll
just concentrate on the traditional JNDI based invocation on EJBs. So
let&#8217;s get started:</p>
</div>
<div class="sect2">
<h3 id="deploying-your-ejbs-on-the-server-side"><a class="anchor" href="#deploying-your-ejbs-on-the-server-side"></a>18.1. Deploying your EJBs on the server side:</h3>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Users who already have EJBs deployed on the server side can just skip to
the next section.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>As a first step, you&#8217;ll have to deploy your application containing the
EJBs on the WildFly server. If you want those EJBs to be remotely
invocable, then you&#8217;ll have to expose at least one remote view for that
bean. In this example, let&#8217;s consider a simple Calculator stateless bean
which exposes a RemoteCalculator remote business interface. We&#8217;ll also
have a simple stateful CounterBean which exposes a RemoteCounter remote
business interface. Here&#8217;s the code:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">package org.jboss.as.quickstarts.ejb.remote.stateless;

/**
 * @author Jaikiran Pai
 */
public interface RemoteCalculator {

    int add(int a, int b);

    int subtract(int a, int b);
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">package org.jboss.as.quickstarts.ejb.remote.stateless;

import javax.ejb.Remote;
import javax.ejb.Stateless;

/**
 * @author Jaikiran Pai
 */
@Stateless
@Remote(RemoteCalculator.class)
public class CalculatorBean implements RemoteCalculator {

    @Override
    public int add(int a, int b) {
        return a + b;
    }

    @Override
    public int subtract(int a, int b) {
        return a - b;
    }
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">package org.jboss.as.quickstarts.ejb.remote.stateful;

/**
 * @author Jaikiran Pai
 */
public interface RemoteCounter {

    void increment();

    void decrement();

    int getCount();
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">package org.jboss.as.quickstarts.ejb.remote.stateful;

import javax.ejb.Remote;
import javax.ejb.Stateful;

/**
 * @author Jaikiran Pai
 */
@Stateful
@Remote(RemoteCounter.class)
public class CounterBean implements RemoteCounter {

    private int count = 0;

    @Override
    public void increment() {
        this.count++;
    }

    @Override
    public void decrement() {
        this.count--;
    }

    @Override
    public int getCount() {
        return this.count;
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s package this in a jar (how you package it in a jar is out of scope
of this chapter) named "jboss-as-ejb-remote-app.jar" and deploy it to
the server. Make sure that your deployment has been processed
successfully and there aren&#8217;t any errors.</p>
</div>
</div>
<div class="sect2">
<h3 id="writing-a-remote-client-application-for-accessing-and-invoking-the-ejbs-deployed-on-the-server"><a class="anchor" href="#writing-a-remote-client-application-for-accessing-and-invoking-the-ejbs-deployed-on-the-server"></a>18.2. Writing a remote client application for accessing and invoking the</h3>
<div class="paragraph">
<p>EJBs deployed on the server</p>
</div>
<div class="paragraph">
<p>The next step is to write an application which will invoke the EJBs that
you deployed on the server. In WildFly, you can either choose to use the
WildFly specific EJB client API to do the invocation or use JNDI to
lookup a proxy for your bean and invoke on that returned proxy. In this
chapter we will concentrate on the JNDI lookup and invocation and will
leave the EJB client API for a separate chapter.</p>
</div>
<div class="paragraph">
<p>So let&#8217;s take a look at what the client code looks like for looking up
the JNDI proxy and invoking on it. Here&#8217;s the entire client code which
invokes on a stateless bean:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">package org.jboss.as.quickstarts.ejb.remote.client;

import javax.naming.Context;
import javax.naming.InitialContext;
import javax.naming.NamingException;
import java.security.Security;
import java.util.Hashtable;

import org.jboss.as.quickstarts.ejb.remote.stateful.CounterBean;
import org.jboss.as.quickstarts.ejb.remote.stateful.RemoteCounter;
import org.jboss.as.quickstarts.ejb.remote.stateless.CalculatorBean;
import org.jboss.as.quickstarts.ejb.remote.stateless.RemoteCalculator;
import org.jboss.sasl.JBossSaslProvider;

/**
 * A sample program which acts a remote client for a EJB deployed on WildFly 10 server.
 * This program shows how to lookup stateful and stateless beans via JNDI and then invoke on them
 *
 * @author Jaikiran Pai
 */
public class RemoteEJBClient {

    public static void main(String[] args) throws Exception {
        // Invoke a stateless bean
        invokeStatelessBean();

        // Invoke a stateful bean
        invokeStatefulBean();
    }

    /**
     * Looks up a stateless bean and invokes on it
     *
     * @throws NamingException
     */
    private static void invokeStatelessBean() throws NamingException {
        // Let's lookup the remote stateless calculator
        final RemoteCalculator statelessRemoteCalculator = lookupRemoteStatelessCalculator();
        System.out.println("Obtained a remote stateless calculator for invocation");
        // invoke on the remote calculator
        int a = 204;
        int b = 340;
        System.out.println("Adding " + a + " and " + b + " via the remote stateless calculator deployed on the server");
        int sum = statelessRemoteCalculator.add(a, b);
        System.out.println("Remote calculator returned sum = " + sum);
        if (sum != a + b) {
            throw new RuntimeException("Remote stateless calculator returned an incorrect sum " + sum + " ,expected sum was " + (a + b));
        }
        // try one more invocation, this time for subtraction
        int num1 = 3434;
        int num2 = 2332;
        System.out.println("Subtracting " + num2 + " from " + num1 + " via the remote stateless calculator deployed on the server");
        int difference = statelessRemoteCalculator.subtract(num1, num2);
        System.out.println("Remote calculator returned difference = " + difference);
        if (difference != num1 - num2) {
            throw new RuntimeException("Remote stateless calculator returned an incorrect difference " + difference + " ,expected difference was " + (num1 - num2));
        }
    }

    /**
     * Looks up a stateful bean and invokes on it
     *
     * @throws NamingException
     */
    private static void invokeStatefulBean() throws NamingException {
        // Let's lookup the remote stateful counter
        final RemoteCounter statefulRemoteCounter = lookupRemoteStatefulCounter();
        System.out.println("Obtained a remote stateful counter for invocation");
        // invoke on the remote counter bean
        final int NUM_TIMES = 20;
        System.out.println("Counter will now be incremented " + NUM_TIMES + " times");
        for (int i = 0; i &lt; NUM_TIMES; i++) {
            System.out.println("Incrementing counter");
            statefulRemoteCounter.increment();
            System.out.println("Count after increment is " + statefulRemoteCounter.getCount());
        }
        // now decrementing
        System.out.println("Counter will now be decremented " + NUM_TIMES + " times");
        for (int i = NUM_TIMES; i &gt; 0; i--) {
            System.out.println("Decrementing counter");
            statefulRemoteCounter.decrement();
            System.out.println("Count after decrement is " + statefulRemoteCounter.getCount());
        }
    }

    /**
     * Looks up and returns the proxy to remote stateless calculator bean
     *
     * @return
     * @throws NamingException
     */
    private static RemoteCalculator lookupRemoteStatelessCalculator() throws NamingException {
        final Hashtable jndiProperties = new Hashtable();
        jndiProperties.put(Context.URL_PKG_PREFIXES, "org.jboss.ejb.client.naming");
        final Context context = new InitialContext(jndiProperties);
        // The app name is the application name of the deployed EJBs. This is typically the ear name
        // without the .ear suffix. However, the application name could be overridden in the application.xml of the
        // EJB deployment on the server.
        // Since we haven't deployed the application as a .ear, the app name for us will be an empty string
        final String appName = "";
        // This is the module name of the deployed EJBs on the server. This is typically the jar name of the
        // EJB deployment, without the .jar suffix, but can be overridden via the ejb-jar.xml
        // In this example, we have deployed the EJBs in a jboss-as-ejb-remote-app.jar, so the module name is
        // jboss-as-ejb-remote-app
        final String moduleName = "jboss-as-ejb-remote-app";
        // AS7 allows each deployment to have an (optional) distinct name. We haven't specified a distinct name for
        // our EJB deployment, so this is an empty string
        final String distinctName = "";
        // The EJB name which by default is the simple class name of the bean implementation class
        final String beanName = CalculatorBean.class.getSimpleName();
        // the remote view fully qualified class name
        final String viewClassName = RemoteCalculator.class.getName();
        // let's do the lookup
        return (RemoteCalculator) context.lookup("ejb:" + appName + "/" + moduleName + "/" + distinctName + "/" + beanName + "!" + viewClassName);
    }

    /**
     * Looks up and returns the proxy to remote stateful counter bean
     *
     * @return
     * @throws NamingException
     */
    private static RemoteCounter lookupRemoteStatefulCounter() throws NamingException {
        final Hashtable jndiProperties = new Hashtable();
        jndiProperties.put(Context.URL_PKG_PREFIXES, "org.jboss.ejb.client.naming");
        final Context context = new InitialContext(jndiProperties);
        // The app name is the application name of the deployed EJBs. This is typically the ear name
        // without the .ear suffix. However, the application name could be overridden in the application.xml of the
        // EJB deployment on the server.
        // Since we haven't deployed the application as a .ear, the app name for us will be an empty string
        final String appName = "";
        // This is the module name of the deployed EJBs on the server. This is typically the jar name of the
        // EJB deployment, without the .jar suffix, but can be overridden via the ejb-jar.xml
        // In this example, we have deployed the EJBs in a jboss-as-ejb-remote-app.jar, so the module name is
        // jboss-as-ejb-remote-app
        final String moduleName = "jboss-as-ejb-remote-app";
        // AS7 allows each deployment to have an (optional) distinct name. We haven't specified a distinct name for
        // our EJB deployment, so this is an empty string
        final String distinctName = "";
        // The EJB name which by default is the simple class name of the bean implementation class
        final String beanName = CounterBean.class.getSimpleName();
        // the remote view fully qualified class name
        final String viewClassName = RemoteCounter.class.getName();
        // let's do the lookup (notice the ?stateful string as the last part of the jndi name for stateful bean lookup)
        return (RemoteCounter) context.lookup("ejb:" + appName + "/" + moduleName + "/" + distinctName + "/" + beanName + "!" + viewClassName + "?stateful");
    }
}</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The entire server side and client side code is hosted at the github repo
here
<a href="https://github.com/wildfly/quickstart/tree/master/ejb-remote">ejb-remote</a>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The code has some comments which will help you understand each of those
lines. But we&#8217;ll explain here in more detail what the code does. As a
first step in the client code, we&#8217;ll do a lookup of the EJB using a JNDI
name. In AS7, for remote access to EJBs, you use the ejb: namespace with
the following syntax:</p>
</div>
<div class="paragraph">
<p><strong>For stateless beans:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">ejb:&lt;app-name&gt;/&lt;module-name&gt;/&lt;distinct-name&gt;/&lt;bean-name&gt;!&lt;fully-qualified-classname-of-the-remote-interface&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>For stateful beans:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">ejb:&lt;app-name&gt;/&lt;module-name&gt;/&lt;distinct-name&gt;/&lt;bean-name&gt;!&lt;fully-qualified-classname-of-the-remote-interface&gt;?stateful</code></pre>
</div>
</div>
<div class="paragraph">
<p>The ejb: namespace identifies it as a EJB lookup and is a constant (i.e.
doesn&#8217;t change) for doing EJB lookups. The rest of the parts in the jndi
name are as follows:</p>
</div>
<div class="paragraph">
<p><strong>app-name</strong> : This is the name of the .ear (without the .ear suffix) that
you have deployed on the server and contains your EJBs.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Jakarta EE allows you to override the application name, to a name of
your choice by setting it in the application.xml. If the deployment uses
uses such an override then the app-name used in the JNDI name should
match that name.</p>
</li>
<li>
<p>EJBs can also be deployed in a .war or a plain .jar (like we did in
step 1). In such cases where the deployment isn&#8217;t an .ear file, then the
app-name must be an empty string, while doing the lookup.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>module-name</strong> : This is the name of the .jar (without the .jar suffix)
that you have deployed on the server and the contains your EJBs. If the
EJBs are deployed in a .war then the module name is the .war name
(without the .war suffix).</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Jakarta EE allows you to override the module name, by setting it in the
ejb-jar.xml/web.xml of your deployment. If the deployment uses such an
override then the module-name used in the JNDI name should match that
name.</p>
</li>
<li>
<p>Module name part cannot be an empty string in the JNDI name</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>distinct-name</strong> : This is a WildFly-specific name which can be
optionally assigned to the deployments that are deployed on the server.
More about the purpose and usage of this will be explained in a separate
chapter. If a deployment doesn&#8217;t use distinct-name then, use an empty
string in the JNDI name, for distinct-name</p>
</div>
<div class="paragraph">
<p><strong>bean-name</strong> : This is the name of the bean for which you are doing the
lookup. The bean name is typically the unqualified classname of the bean
implementation class, but can be overriden through either ejb-jar.xml or
via annotations. The bean name part cannot be an empty string in the
JNDI name.</p>
</div>
<div class="paragraph">
<p><strong>fully-qualified-classname-of-the-remote-interface</strong> : This is the fully
qualified class name of the interface for which you are doing the
lookup. The interface should be one of the remote interfaces exposed by
the bean on the server. The fully qualified class name part cannot be an
empty string in the JNDI name.</p>
</div>
<div class="paragraph">
<p>For stateful beans, the JNDI name expects an additional "?stateful" to
be appended after the fully qualified interface name part. This is
because for stateful beans, a new session gets created on JNDI lookup
and the EJB client API implementation doesn&#8217;t contact the server during
the JNDI lookup to know what kind of a bean the JNDI name represents
(we&#8217;ll come to this in a while). So the JNDI name itself is expected to
indicate that the client is looking up a stateful bean, so that an
appropriate session can be created.</p>
</div>
<div class="paragraph">
<p>Now that we know the syntax, let&#8217;s see our code and check what JNDI name
it uses. Since our stateless EJB named CalculatorBean is deployed in a
jboss-as-ejb-remote-app.jar (without any ear) and since we are looking
up the org.jboss.as.quickstarts.ejb.remote.stateless.RemoteCalculator
remote interface, our JNDI name will be:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>ejb:/jboss-as-ejb-remote-app//CalculatorBean!org.jboss.as.quickstarts.ejb.remote.stateless.RemoteCalculator</pre>
</div>
</div>
<div class="paragraph">
<p>That&#8217;s what the lookupRemoteStatelessCalculator() method in the above
client code uses.</p>
</div>
<div class="paragraph">
<p>For the stateful EJB named CounterBean which is deployed in hte same
jboss-as-ejb-remote-app.jar and which exposes the
org.jboss.as.quickstarts.ejb.remote.stateful.RemoteCounter, the JNDI
name will be:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>ejb:/jboss-as-ejb-remote-app//CounterBean!org.jboss.as.quickstarts.ejb.remote.stateful.RemoteCounter?stateful</pre>
</div>
</div>
<div class="paragraph">
<p>That&#8217;s what the lookupRemoteStatefulCounter() method in the above client
code uses.</p>
</div>
<div class="paragraph">
<p>Now that we know of the JNDI name, let&#8217;s take a look at the following
piece of code in the lookupRemoteStatelessCalculator():</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">final Hashtable jndiProperties = new Hashtable();
jndiProperties.put(Context.URL_PKG_PREFIXES, "org.jboss.ejb.client.naming");
final Context context = new InitialContext(jndiProperties);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Here we are creating a JNDI InitialContext object by passing it some
JNDI properties. The Context.URL_PKG_PREFIXES is set to
org.jboss.ejb.client.naming. This is necessary because we should let the
JNDI API know what handles the ejb: namespace that we use in our JNDI
names for lookup. The "org.jboss.ejb.client.naming" has a
URLContextFactory implementation which will be used by the JNDI APIs to
parse and return an object for ejb: namespace lookups. You can either
pass these properties to the constructor of the InitialContext class or
have a jndi.properites file in the classpath of the client application,
which (atleast) contains the following property:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">java.naming.factory.url.pkgs=org.jboss.ejb.client.naming</code></pre>
</div>
</div>
<div class="paragraph">
<p>So at this point, we have setup the InitialContext and also have the
JNDI name ready to do the lookup. You can now do the lookup and the
appropriate proxy which will be castable to the remote interface that
you used as the fully qualified class name in the JNDI name, will be
returned. Some of you might be wondering, how the JNDI implementation
knew which server address to look, for your deployed EJBs. The answer is
in AS7, the proxies returned via JNDI name lookup for ejb: namespace do
not connect to the server unless an invocation on those proxies is done.</p>
</div>
<div class="paragraph">
<p>Now let&#8217;s get to the point where we invoke on this returned proxy:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">// Let's lookup the remote stateless calculator
        final RemoteCalculator statelessRemoteCalculator = lookupRemoteStatelessCalculator();
        System.out.println("Obtained a remote stateless calculator for invocation");
        // invoke on the remote calculator
        int a = 204;
        int b = 340;
        System.out.println("Adding " + a + " and " + b + " via the remote stateless calculator deployed on the server");
        int sum = statelessRemoteCalculator.add(a, b);</code></pre>
</div>
</div>
<div class="paragraph">
<p>We can see here that the proxy returned after the lookup is used to
invoke the add(&#8230;&#8203;) method of the bean. It&#8217;s at this point that the JNDI
implementation (which is backed by the EJB client API) needs to know the
server details. So let&#8217;s now get to the important part of setting up the
EJB client context properties.</p>
</div>
</div>
<div class="sect2">
<h3 id="setting-up-ejb-client-context-properties"><a class="anchor" href="#setting-up-ejb-client-context-properties"></a>18.3. Setting up EJB client context properties</h3>
<div class="paragraph">
<p>A EJB client context is a context which contains contextual information
for carrying out remote invocations on EJBs. This is a WildFly-specific
API. The EJB client context can be associated with multiple EJB
receivers. Each EJB receiver is capable of handling invocations on
different EJBs. For example, an EJB receiver "Foo" might be able to
handle invocation on a bean identified by
app-A/module-A/distinctinctName-A/Bar!RemoteBar, whereas a EJB receiver
named "Blah" might be able to handle invocation on a bean identified by
app-B/module-B/distinctName-B/BeanB!RemoteBean. Each such EJB receiver
knows about what set of EJBs it can handle and each of the EJB receiver
knows which server target to use for handling the invocations on the
bean. For example, if you have a AS7 server at 10.20.30.40 IP address
which has its remoting port opened at 4447 and if that&#8217;s the server on
which you deployed that CalculatorBean, then you can setup a EJB
receiver which knows its target address is 10.20.30.40:4447. Such an EJB
receiver will be capable enough to communicate to the server via the
JBoss specific EJB remote client protocol (details of which will be
explained in-depth in a separate chapter).</p>
</div>
<div class="paragraph">
<p>Now that we know what a EJB client context is and what a EJB receiver
is, let&#8217;s see how we can setup a client context with 1 EJB receiver
which can connect to 10.20.30.40 IP address at port 4447. That EJB
client context will then be used (internally) by the JNDI implementation
to handle invocations on the bean proxy.</p>
</div>
<div class="paragraph">
<p>The client will have to place a jboss-ejb-client.properties file in the
classpath of the application. The jboss-ejb-client.properties can
contain the following properties:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>endpoint.name=client-endpoint
remote.connectionprovider.create.options.org.xnio.Options.SSL_ENABLED=false

remote.connections=default

remote.connection.default.host=10.20.30.40
remote.connection.default.port = 8080
remote.connection.default.connect.options.org.xnio.Options.SASL_POLICY_NOANONYMOUS=false

remote.connection.default.username=appuser
remote.connection.default.password=apppassword</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
This file includes a reference to a default password. Be sure to change
this as soon as possible.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The above properties file is just an example. The actual file that was
used for this sample program is available here for reference
<a href="https://github.com/wildfly/quickstart/blob/master/ejb-remote/client/src/main/resources/jboss-ejb-client.properties">jboss-ejb-client.properties</a></p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
We&#8217;ll see what each of it means.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>First the endpoint.name property. We mentioned earlier that the EJB
receivers will communicate with the server for EJB invocations.
Internally, they use JBoss Remoting project to carry out the
communication. The endpoint.name property represents the name that will
be used to create the client side of the enpdoint. The endpoint.name
property is optional and if not specified in the
jboss-ejb-client.properties file, it will default to
"config-based-ejb-client-endpoint" name.</p>
</div>
<div class="paragraph">
<p>Next is the remote.connectionprovider.create.options.&lt;&#8230;&#8203;.&gt; properties:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>remote.connectionprovider.create.options.org.xnio.Options.SSL_ENABLED=false</pre>
</div>
</div>
<div class="paragraph">
<p>The "remote.connectionprovider.create.options." property prefix can be
used to pass the options that will be used while create the connection
provider which will handle the "remote:" protocol. In this example we
use the "remote.connectionprovider.create.options." property prefix to
pass the "org.xnio.Options.SSL_ENABLED" property value as false. That
property will then be used during the connection provider creation.
Similarly other properties can be passed too, just append it to the
"remote.connectionprovider.create.options." prefix</p>
</div>
<div class="paragraph">
<p>Next we&#8217;ll see:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>remote.connections=default</pre>
</div>
</div>
<div class="paragraph">
<p>This is where you define the connections that you want to setup for
communication with the remote server. The "remote.connections" property
uses a comma separated value of connection "names". The connection names
are just logical and are used grouping together the connection
configuration properties later on in the properties file. The example
above sets up a single remote connection named "default". There can be
more than one connections that are configured. For example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>remote.connections=one, two</pre>
</div>
</div>
<div class="paragraph">
<p>Here we are listing 2 connections named "one" and "two". Ultimately,
each of the connections will map to a EJB receiver. So if you have 2
connections, that will setup 2 EJB receivers that will be added to the
EJB client context. Each of these connections will be configured with
the connection specific properties as follows:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>remote.connection.default.host=10.20.30.40
remote.connection.default.port = 8080
remote.connection.default.connect.options.org.xnio.Options.SASL_POLICY_NOANONYMOUS=false</pre>
</div>
</div>
<div class="paragraph">
<p>As you can see we are using the "remote.connection.&lt;connection-name&gt;."
prefix for specifying the connection specific property. The connection
name here is "default" and we are setting the "host" property of that
connection to point to 10.20.30.40. Similarly we set the "port" for that
connection to 4447.</p>
</div>
<div class="paragraph">
<p>By default WildFly uses 8080 as the remoting port. The EJB client API
uses the http port, with the http-upgrade functionality, for
communicating with the server for remote invocations, so that&#8217;s the port
we use in our client programs (unless the server is configured for some
other http port)</p>
</div>
<div class="literalblock">
<div class="content">
<pre>remote.connection.default.username=appuser
remote.connection.default.password=apppassword</pre>
</div>
</div>
<div class="paragraph">
<p>The given user/password must be set by using the command bin/add-user.sh
﻿(or.bat).<br>
The user and password must be set because the security-realm is enabled
for the subsystem remoting (see standalone*.xml or domain.xml) by
default.<br>
If you do not need the security for remoting you might remove the
attribute security-realm in the configuration.</p>
</div>
<div class="paragraph">
<p>security-realm is enabled by default.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
We then use the "remote.connection.&lt;connection-name&gt;.connect.options."
property prefix to setup options that will be used during the connection
creation.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Here&#8217;s an example of setting up multiple connections with different
properties for each of those:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>remote.connectionprovider.create.options.org.xnio.Options.SSL_ENABLED=false

remote.connections=one, two

remote.connection.one.host=localhost
remote.connection.one.port=6999
remote.connection.one.connect.options.org.xnio.Options.SASL_POLICY_NOANONYMOUS=false

remote.connection.two.host=localhost
remote.connection.two.port=7999
remote.connection.two.connect.options.org.xnio.Options.SASL_POLICY_NOANONYMOUS=false</pre>
</div>
</div>
<div class="paragraph">
<p>As you can see we setup 2 connections "one" and "two" which both point
to "localhost" as the "host" but different ports. Each of these
connections will internally be used to create the EJB receivers in the
EJB client context.</p>
</div>
<div class="paragraph">
<p>So that&#8217;s how the jboss-ejb-client.properties file can be setup and
placed in the classpath.</p>
</div>
<div id="section" class="exampleblock">
<div class="content">
<div class="paragraph">
<p>The EJB client code will by default look for jboss-ejb-client.properties
in the classpath. However, you can specify a different file of your
choice by setting the "jboss.ejb.client.properties.file.path" system
property which points to a properties file on your filesystem,
containing the client context configurations. An example for that would
be
"-Djboss.ejb.client.properties.file.path=/home/me/my-client/custom-jboss-ejb-client.properties"</p>
</div>
</div>
</div>
<div class="paragraph">
<p>A jboss-client jar is shipped in the distribution. It&#8217;s available at
WILDFLY_HOME/bin/client/jboss-client.jar. Place this jar in the
classpath of your client application.</p>
</div>
<div class="paragraph">
<p>If you are using Maven to build the client application, then please
follow the instructions in the WILDFLY_HOME/bin/client/README.txt to add
this jar as a Maven dependency.</p>
</div>
</div>
<div class="sect2">
<h3 id="summary"><a class="anchor" href="#summary"></a>Summary</h3>
<div class="paragraph">
<p>In the above examples, we saw what it takes to invoke a EJB from a
remote client. To summarize:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>On the server side you need to deploy EJBs which expose the remote
views.</p>
</li>
<li>
<p>On the client side you need a client program which:</p>
<div class="ulist">
<ul>
<li>
<p>Has a jboss-ejb-client.properties in its classpath to setup the
server connection information</p>
</li>
<li>
<p>Either has a jndi.properties to specify the
java.naming.factory.url.pkgs property or passes that as a property to
the InitialContext constructor</p>
</li>
<li>
<p>Setup the client classpath to include the jboss-client jar that&#8217;s
required for remote invocation of the EJBs. The location of the jar is
mentioned above. You&#8217;ll also need to have your application&#8217;s bean
interface jars and other jars that are required by your application, in
the client classpath</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
References in this document to Enterprise JavaBeans(EJB) refer to the Jakarta Enterprise Beans unless otherwise noted.
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="EJB_invocations_from_a_remote_server_instance"><a class="anchor" href="#EJB_invocations_from_a_remote_server_instance"></a>19. EJB invocations from a remote server instance</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The purpose of this chapter is to demonstrate how to lookup and invoke
on EJBs deployed on an WildFly server instance <strong>from another</strong> WildFly
server instance. This is different from invoking the EJBs
<a href="https://docs.jboss.org/author/display/AS71/EJB+invocations+from+a+remote+client+using+JNDI">from
a remote standalone client</a></p>
</div>
<div class="paragraph">
<p>Let&#8217;s call the server, from which the invocation happens to the EJB, as
"Client Server" and the server on which the bean is deployed as the
"Destination Server".</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Note that this chapter deals with the case where the bean is deployed on
the "Destination Server" but <strong>not</strong> on the "Client Server".
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="application-packaging"><a class="anchor" href="#application-packaging"></a>19.1. Application packaging</h3>
<div class="paragraph">
<p>In this example, we&#8217;ll consider a EJB which is packaged in a myejb.jar
which is within a myapp.ear. Here&#8217;s how it would look like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">myapp.ear
|
|---- myejb.jar
|        |
|        |---- &lt;org.myapp.ejb.*&gt; // EJB classes</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Note that packaging itself isn&#8217;t really important in the context of this
article. You can deploy the EJBs in any standard way (.ear, .war or
.jar).
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="beans"><a class="anchor" href="#beans"></a>19.2. Beans</h3>
<div class="paragraph">
<p>In our example, we&#8217;ll consider a simple stateless session bean which is
as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">package org.myapp.ejb;

public interface Greeter {

    String greet(String user);
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">package org.myapp.ejb;

import javax.ejb.Remote;
import javax.ejb.Stateless;

@Stateless
@Remote (Greeter.class)
public class GreeterBean implements Greeter {

    @Override
    public String greet(String user) {
        return "Hello " + user + ", have a pleasant day!";
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="security"><a class="anchor" href="#security"></a>19.3. Security</h3>
<div class="paragraph">
<p>WildFly 14 is secure by default. What this means is that no communication
can happen with an WildFly instance from a remote client (irrespective
of whether it is a standalone client or another server instance) without
passing the appropriate credentials. Remember that in this example, our
"client server" will be communicating with the "destination server". So
in order to allow this communication to happen successfully, we&#8217;ll have
to configure user credentials which we will be using during this
communication. So let&#8217;s start with the necessary configurations for
this.</p>
</div>
</div>
<div class="sect2">
<h3 id="configuring-a-user-on-the-destination-server"><a class="anchor" href="#configuring-a-user-on-the-destination-server"></a>19.4. Configuring a user on the "Destination Server"</h3>
<div class="paragraph">
<p>As a first step we&#8217;ll configure a user on the destination server who
will be allowed to access the destination server. We create the user
using the <code>add-user</code> script that&#8217;s available in the JBOSS_HOME/bin
folder. In this example, we&#8217;ll be configuring a <code>Application User</code> named
<code>ejb</code> and with a password <code>test</code> in the <code>ApplicationRealm</code>. Running the
<code>add-user</code> script is an interactive process and you will see
questions/output as follows:</p>
</div>
<div class="listingblock">
<div class="title">add-user</div>
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">jpai@jpai-laptop:bin$ ./add-user.sh

What type of user do you wish to add?
&amp;nbsp;a) Management User (mgmt-users.properties)
&amp;nbsp;b) Application User (application-users.properties)
(a): b

Enter the details of the new user to add.
Realm (ApplicationRealm) :
Username : ejb
Password :
Re-enter Password :
What roles do you want this user to belong to? (Please enter a comma separated list, or leave blank for none)\[&amp;nbsp; \]:
About to add user 'ejb' for realm 'ApplicationRealm'
Is this correct yes/no? yes
Added user 'ejb' to file '/jboss-as-7.1.1.Final/standalone/configuration/application-users.properties'
Added user 'ejb' to file '/jboss-as-7.1.1.Final/domain/configuration/application-users.properties'
Added user 'ejb' with roles to file '/jboss-as-7.1.1.Final/standalone/configuration/application-roles.properties'
Added user 'ejb' with roles to file '/jboss-as-7.1.1.Final/domain/configuration/application-roles.properties'</code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see in the output above we have now configured a user on the
destination server who&#8217;ll be allowed to access this server. We&#8217;ll use
this user credentials later on in the client server for communicating
with this server. The important bits to remember are the user we have
created in this example is <code>ejb</code> and the password is <code>test.</code></p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Note that you can use any username and password combination you want to.
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
You do <strong>not</strong> require the server to be started to add a user using the
add-user script.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="start-the-destination-server"><a class="anchor" href="#start-the-destination-server"></a>19.5. Start the "Destination Server"</h3>
<div class="paragraph">
<p>As a next step towards running this example, we&#8217;ll start the
"Destination Server". In this example, we&#8217;ll use the standalone server
and use the <em>standalone-full.xml</em> configuration. The startup command
will look like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>./standalone.sh -server-config=standalone-full.xml</code></pre>
</div>
</div>
<div class="paragraph">
<p>Ensure that the server has started without any errors.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
It&#8217;s very important to note that if you are starting both the server
instances on the same machine, then each of those server instances
<strong>must</strong> have a unique <code>jboss.node.name</code> system property. You can do that
by passing an appropriate value for <code>-Djboss.node.name</code> system property
to the startup script:
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>./standalone.sh -server-config=standalone-full.xml -Djboss.node.name=&lt;add appropriate value here&gt;</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="deploying-the-application"><a class="anchor" href="#deploying-the-application"></a>19.6. Deploying the application</h3>
<div class="paragraph">
<p>The application ( <em>myapp.ear</em> in our case) will be deployed to
"Destination Server". The process of deploying the application is out of
scope of this chapter. You can either use the Command Line Interface or
the Admin console or any IDE or manually copy it to
JBOSS_HOME/standalone/deployments folder (for standalone server). Just
ensure that the application has been deployed successfully.</p>
</div>
<div class="paragraph">
<p>So far, we have built a EJB application and deployed it on the
"Destination Server". Now let&#8217;s move to the "Client Server" which acts
as the client for the deployed EJBs on the "Destination Server".</p>
</div>
</div>
<div class="sect2">
<h3 id="configuring-the-client-server-to-point-to-the-ejb-remoting-connector-on-the-destination-server"><a class="anchor" href="#configuring-the-client-server-to-point-to-the-ejb-remoting-connector-on-the-destination-server"></a>19.7. Configuring the "Client Server" to point to the EJB remoting connector</h3>
<div class="paragraph">
<p>on the "Destination Server"</p>
</div>
<div class="paragraph">
<p>As a first step on the "Client Server", we need to let the server know
about the "Destination Server"'s EJB remoting connector, over which it
can communicate during the EJB invocations. To do that, we&#8217;ll have to
add a " <em>remote-outbound-connection</em>" to the remoting subsystem on the
"Client Server". The " <em>remote-outbound-connection</em>" configuration
indicates that a outbound connection will be created to a remote server
instance from that server. The " <em>remote-outbound-connection</em>" will be
backed by a " <em>outbound-socket-binding</em>" which will point to a remote
host and a remote port (of the "Destination Server"). So let&#8217;s see how
we create these configurations.</p>
</div>
</div>
<div class="sect2">
<h3 id="start-the-client-server"><a class="anchor" href="#start-the-client-server"></a>19.8. Start the "Client Server"</h3>
<div class="paragraph">
<p>In this example, we&#8217;ll start the "Client Server" on the same machine as
the "Destination Server". We have copied the entire server installation
to a different folder and while starting the "Client Server" we&#8217;ll use a
port-offset (of 100 in this example) to avoid port conflicts:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>./standalone.sh -server-config=standalone-full.xml -Djboss.socket.binding.port-offset=100</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="create-a-security-realm-on-the-client-server"><a class="anchor" href="#create-a-security-realm-on-the-client-server"></a>19.9. Create a security realm on the client server</h3>
<div class="paragraph">
<p>Remember that we need to communicate with a secure destination server.
In order to do that the client server has to pass the user credentials
to the destination server. Earlier we created a user on the destination
server who&#8217;ll be allowed to communicate with that server. Now on the
"client server" we&#8217;ll create a security-realm which will be used to pass
the user information.</p>
</div>
<div class="paragraph">
<p>In this example we&#8217;ll use a security realm which stores a Base64 encoded
password and then passes on that credentials when asked for. Earlier we
created a user named <code>ejb</code> and password <code>test</code>. So our first task here
would be to create the base64 encoded version of the password <code>test</code>.
You can use any utility which generates you a base64 version for a
string. I used <a href="http://www.base64encode.org/">this online site</a> which
generates the base64 encoded string. So for the <code>test</code> password, the
base64 encoded version is <code>dGVzdA==</code></p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
While generating the base64 encoded string make sure that you don&#8217;t have
any trailing or leading spaces for the original password. That can lead
to incorrect encoded versions being generated.
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
With new versions the add-user script will show the base64 password if
you type 'y' if you&#8217;ve been ask
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">Is this new user going to be used for one AS process to connect to another AS process e.g. slave domain controller?</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now that we have generated that base64 encoded password, let&#8217;s use in
the in the security realm that we are going to configure on the "client
server". I&#8217;ll first shutdown the client server and edit the
standalone-full.xml file to add the following in the <code>&lt;management&gt;</code>
section</p>
</div>
<div class="paragraph">
<p>Now let&#8217;s create a " <em>security-realm</em>" for the base64 encoded password.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/core-service=management/security-realm=ejb-security-realm:add()
/core-service=management/security-realm=ejb-security-realm/server-identity=secret:add(value=dGVzdA==)</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Notice that the CLI show the message <em>"process-state" &#8658;
"reload-required"</em>, so you have to restart the server before you can use
this change.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>upon successful invocation of this command, the following configuration
will be created in the <em>management</em> section:</p>
</div>
<div class="listingblock">
<div class="title">standalone-full.xml</div>
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;management&gt;
        &lt;security-realms&gt;
            ...
            &lt;security-realm name="ejb-security-realm"&gt;
                &lt;server-identities&gt;
                    &lt;secret value="dGVzdA=="/&gt;
                &lt;/server-identities&gt;
            &lt;/security-realm&gt;
        &lt;/security-realms&gt;
...</code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see I have created a security realm named
"ejb-security-realm" (you can name it anything) with the base64 encoded
password. So that completes the security realm configuration for the
client server. Now let&#8217;s move on to the next step.</p>
</div>
</div>
<div class="sect2">
<h3 id="create-a-outbound-socket-binding-on-the-client-server"><a class="anchor" href="#create-a-outbound-socket-binding-on-the-client-server"></a>19.10. Create a outbound-socket-binding on the "Client Server"</h3>
<div class="paragraph">
<p>Let&#8217;s first create a <em>outbound-socket-binding</em> which points the
"Destination Server"'s host and port. We&#8217;ll use the CLI to create this
configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/socket-binding-group=standard-sockets/remote-destination-outbound-socket-binding=remote-ejb:add(host=localhost, port=8080)</code></pre>
</div>
</div>
<div class="paragraph">
<p>The above command will create a outbound-socket-binding named "
<em>remote-ejb</em>" (we can name it anything) which points to "localhost" as
the host and port 8080 as the destination port. Note that the host
information should match the host/IP of the "Destination Server" (in
this example we are running on the same machine so we use "localhost")
and the port information should match the http-remoting connector port
used by the EJB subsystem (by default it&#8217;s 8080). When this command is
run successfully, we&#8217;ll see that the standalone-full.xml (the file which
we used to start the server) was updated with the following
outbound-socket-binding in the socket-binding-group:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;socket-binding-group name="standard-sockets" default-interface="public" port-offset="${jboss.socket.binding.port-offset:0}"&gt;
        ...
        &lt;outbound-socket-binding name="remote-ejb"&gt;
            &lt;remote-destination host="localhost" port="8080"/&gt;
        &lt;/outbound-socket-binding&gt;
    &lt;/socket-binding-group&gt;</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="create-a-remote-outbound-connection-which-uses-this-newly-created-outbound-socket-binding"><a class="anchor" href="#create-a-remote-outbound-connection-which-uses-this-newly-created-outbound-socket-binding"></a>19.11. Create a "remote-outbound-connection" which uses this newly created</h3>
<div class="paragraph">
<p>"outbound-socket-binding"</p>
</div>
<div class="paragraph">
<p>Now let&#8217;s create a " <em>remote-outbound-connection</em>" which will use the
newly created outbound-socket-binding (pointing to the EJB remoting
connector of the "Destination Server"). We&#8217;ll continue to use the CLI to
create this configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=remoting/remote-outbound-connection=remote-ejb-connection:add(outbound-socket-binding-ref=remote-ejb, protocol=http-remoting, security-realm=ejb-security-realm, username=ejb)</code></pre>
</div>
</div>
<div class="paragraph">
<p>The above command creates a remote-outbound-connection, named "
<em>remote-ejb-connection</em>" (we can name it anything), in the remoting
subsystem and uses the previously created " <em>remote-ejb</em>"
outbound-socket-binding (notice the outbound-socket-binding-ref in that
command) with the http-remoting protocol. Furthermore, we also set the
security-realm attribute to point to the security-realm that we created
in the previous step. Also notice that we have set the username
attribute to use the user name who is allowed to communicate with the
destination server.</p>
</div>
<div class="paragraph">
<p>What this step does is, it creates a outbound connection, on the client
server, to the remote destination server and sets up the username to the
user who allowed to communicate with that destination server and also
sets up the security-realm to a pre-configured security-realm capable of
passing along the user credentials (in this case the password). This way
when a connection has to be established from the client server to the
destination server, the connection creation logic will have the
necessary security credentials to pass along and setup a successful
secured connection.</p>
</div>
<div class="paragraph">
<p>Now let&#8217;s run the following two operations to set some default
connection creation options for the outbound connection:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=remoting/remote-outbound-connection=remote-ejb-connection/property=SASL_POLICY_NOANONYMOUS:add(value=false)</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=remoting/remote-outbound-connection=remote-ejb-connection/property=SSL_ENABLED:add(value=false)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Ultimately, upon successful invocation of this command, the following
configuration will be created in the remoting subsystem:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;subsystem xmlns="urn:jboss:domain:remoting:1.1"&gt;
....
            &lt;outbound-connections&gt;
                &lt;remote-outbound-connection name="remote-ejb-connection" outbound-socket-binding-ref="remote-ejb" protocol="http-remoting" security-realm="ejb-security-realm" username="ejb"&gt;
                    &lt;properties&gt;
                        &lt;property name="SASL_POLICY_NOANONYMOUS" value="false"/&gt;
                        &lt;property name="SSL_ENABLED" value="false"/&gt;
                    &lt;/properties&gt;
                &lt;/remote-outbound-connection&gt;
            &lt;/outbound-connections&gt;
        &lt;/subsystem&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>From a server configuration point of view, that&#8217;s all we need on the
"Client Server". Our next step is to deploy an application on the
"Client Server" which will invoke on the bean deployed on the
"Destination Server".</p>
</div>
</div>
<div class="sect2">
<h3 id="packaging-the-client-application-on-the-client-server"><a class="anchor" href="#packaging-the-client-application-on-the-client-server"></a>19.12. Packaging the client application on the "Client Server"</h3>
<div class="paragraph">
<p>Like on the "Destination Server", we&#8217;ll use .ear packaging for the
client application too. But like previously mentioned, that&#8217;s not
mandatory. You can even use a .war or .jar deployments. Here&#8217;s how our
client application packaging will look like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>client-app.ear
|
|--- META-INF
|        |
|        |--- jboss-ejb-client.xml
|
|--- web.war
|        |
|        |--- WEB-INF/classes
|        |        |
|        |        |---- &lt;org.myapp.FooServlet&gt; // classes in the web app</pre>
</div>
</div>
<div class="paragraph">
<p>In the client application we&#8217;ll use a servlet which invokes on the bean
deployed on the "Destination Server". We can even invoke the bean on the
"Destination Server" from a EJB on the "Client Server". The code remains
the same (JNDI lookup, followed by invocation on the proxy). The
important part to notice in this client application is the file
<em>jboss-ejb-client.xml</em> which is packaged in the META-INF folder of a top
level deployment (in this case our client-app.ear). This
<em>jboss-ejb-client.xml</em> contains the EJB client configurations which will
be used during the EJB invocations for finding the appropriate
destinations (also known as, EJB receivers). The contents of the
jboss-ejb-client.xml are explained next.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If your application is deployed as a top level .war deployment, then the
jboss-ejb-client.xml is expected to be placed in .war/WEB-INF/ folder
(i.e. the same location where you place any web.xml file).
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="contents-on-jboss-ejb-client.xml"><a class="anchor" href="#contents-on-jboss-ejb-client.xml"></a>19.13. Contents on jboss-ejb-client.xml</h3>
<div class="paragraph">
<p>The jboss-ejb-client.xml will look like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;jboss-ejb-client xmlns="urn:jboss:ejb-client:1.0"&gt;
    &lt;client-context&gt;
        &lt;ejb-receivers&gt;
            &lt;remoting-ejb-receiver outbound-connection-ref="remote-ejb-connection"/&gt;
        &lt;/ejb-receivers&gt;
    &lt;/client-context&gt;
&lt;/jboss-ejb-client&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>You&#8217;ll notice that we have configured the EJB client context (for this
application) to use a remoting-ejb-receiver which points to our earlier
created " <em>remote-outbound-connection</em>" named "
<em>remote-ejb-connection</em>". This links the EJB client context to use the "
<em>remote-ejb-connection</em>" which ultimately points to the EJB remoting
connector on the "Destination Server".</p>
</div>
</div>
<div class="sect2">
<h3 id="deploy-the-client-application"><a class="anchor" href="#deploy-the-client-application"></a>19.14. Deploy the client application</h3>
<div class="paragraph">
<p>Let&#8217;s deploy the client application on the "Client Server". The process
of deploying the application is out of scope, of this chapter. You can
use either the CLI or the admin console or a IDE or deploy manually to
JBOSS_HOME/standalone/deployments folder. Just ensure that the
application is deployed successfully.</p>
</div>
</div>
<div class="sect2">
<h3 id="client-code-invoking-the-bean"><a class="anchor" href="#client-code-invoking-the-bean"></a>19.15. Client code invoking the bean</h3>
<div class="paragraph">
<p>We mentioned that we&#8217;ll be using a servlet to invoke on the bean, but
the code to invoke the bean isn&#8217;t servlet specific and can be used in
other components (like EJB) too. So let&#8217;s see how it looks like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">import javax.naming.Context;
import java.util.Hashtable;
import javax.naming.InitialContext;

...
public void invokeOnBean() {
        try {
            final Hashtable props = new Hashtable();
            // setup the ejb: namespace URL factory
            props.put(Context.URL_PKG_PREFIXES, "org.jboss.ejb.client.naming");
            // create the InitialContext
            final Context context = new javax.naming.InitialContext(props);

            // Lookup the Greeter bean using the ejb: namespace syntax which is explained here https://docs.jboss.org/author/display/AS71/EJB+invocations+from+a+remote+client+using+JNDI
            final Greeter bean = (Greeter) context.lookup("ejb:" + "myapp" + "/" + "myejb" + "/" + "" + "/" + "GreeterBean" + "!" + org.myapp.ejb.Greeter.class.getName());

   // invoke on the bean
   final String greeting = bean.greet("Tom");

            System.out.println("Received greeting: " + greeting);

        } catch (Exception e) {
            throw new RuntimeException(e);
        }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>That&#8217;s it! The above code will invoke on the bean deployed on the
"Destination Server" and return the result.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
References in this document to Enterprise JavaBeans(EJB) refer to the Jakarta Enterprise Beans unless otherwise noted.
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="Remote_Jakarta_Enterprise_Beans_invocations_via_JNDI_-_Jakarta_Enterprise_Beans_client_API_or_wildfly-naming-client_project"><a class="anchor" href="#Remote_Jakarta_Enterprise_Beans_invocations_via_JNDI_-_Jakarta_Enterprise_Beans_client_API_or_wildfly-naming-client_project"></a>20. Remote Jakarta Enterprise Beans invocations via JNDI - Jakarta Enterprise Beans client API or wildfly-naming-client project</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="purpose"><a class="anchor" href="#purpose"></a>20.1. Purpose</h3>
<div class="paragraph">
<p>WildFly provides EJB client API project as well as wildfly-naming-client project(<a href="https://github.com/wildfly/wildfly-naming-client" class="bare">https://github.com/wildfly/wildfly-naming-client</a>)
for invoking on remote objects exposed via JNDI. This article explains
which approach to use when and what the differences and scope of each of
these projects is.</p>
</div>
</div>
<div class="sect2">
<h3 id="overview"><a class="anchor" href="#overview"></a>20.2. Overview</h3>
<div class="paragraph">
<p>Now that we know that for remote client JNDI communication with WildFly
requires wildfly-naming-client project, let&#8217;s quickly see what the code
looks like.</p>
</div>
<div class="sect3">
<h4 id="client-code-relying-on-jndi.properties-in-classpath"><a class="anchor" href="#client-code-relying-on-jndi.properties-in-classpath"></a>20.2.1. Client code relying on jndi.properties in classpath</h4>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">// Create an InitialContext using the javax.naming.* API
InitialContext ctx = new InitialContext();
Blah blah = (Blah) ctx.lookup("foo:blah");</code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see, there&#8217;s not much here in terms of code. We first create
a InitialContext which as per the API will look for a jndi.properties in
the classpath of the application. We&#8217;ll see what our jndi.properties looks like, later.
Once the InitialContext is created, we just use it to do a lookup on a
JNDI name which we know is bound on the server side. We&#8217;ll come back to
the details of this lookup string in a while.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s now see what the jndi.properties in our client classpath looks
like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">java.naming.factory.initial=org.wildfly.naming.client.WildFlyInitialContextFactory
java.naming.provider.url=remote+http://localhost:8080</code></pre>
</div>
</div>
<div class="paragraph">
<p>Those two properties are important for wildfly-naming-client project to be
used for communicating with the WildFly server. The first property tells
the JNDI API which initial context factory to use. In this case we are
pointing it to the WildFlyInitailContextFactory class supplied by the
wildfly-naming-client project. The other property is the PROVIDER_URL.
which is <code>remote+http://</code> for wildfly-naming-client. The rest
of the PROVIDER_URL part is the server hostname or IP and the port on
which the remoting connector is exposed on the server side. By default
the http-remoting connector port in WildFly 14 is 8080. That&#8217;s what we
have used in our example. The hostname we have used is localhost but
that should point to the server IP or hostname where the server is
running.</p>
</div>
<div class="paragraph">
<p>So we saw how to setup the JNDI properties in the jndi.properties file.
The JNDI API also allows you to pass these properties to the constructor
of the InitialContext class (please check the javadoc of that class for
more details). Let&#8217;s quickly see what the code would look like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">Properties props = new Properties();
props.put(Context.INITIAL_CONTEXT_FACTORY, "org.wildfly.naming.client.WildFlyInitialContextFactory");
props.put(Context.PROVIDER_URL, "remote+https://localhost:8080");
InitialContext ctx = new InitialContext(props);
Blah blah = (Blah) ctx.lookup("foo:blah");</code></pre>
</div>
</div>
<div class="paragraph">
<p>That&#8217;s it! You can see that the values that we pass to those properties
are the same as what we did via the jndi.properties. It&#8217;s upto the
client application to decide which approach they want to follow.</p>
</div>
</div>
<div class="sect3">
<h4 id="Using-the-wildfly-config.xml"><a class="anchor" href="#Using-the-wildfly-config.xml"></a>20.2.2. Using the wildfly-config.xml</h4>
<div class="paragraph">
<p>The <code>wildfly-config.xml</code> can be used to specify a static configuration for a
standalone client to use. Below is a simple example specifying plaintext
username / password and the remote server connection (host/port).
The wildfly-config.xml goes in the META-INF directory.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">&lt;configuration&gt;
  &lt;authentication-client xmlns="urn:elytron:1.0.1"&gt;
    &lt;authentication-rules&gt;
      &lt;rule use-configuration="default"/&gt;
    &lt;/authentication-rules&gt;
    &lt;authentication-configurations&gt;
      &lt;configuration name="default"&gt;
        &lt;set-user-name name="ranabir"/&gt;
        &lt;credentials&gt;
          &lt;clear-password password="redhat1!"/&gt;
        &lt;/credentials&gt;
      &lt;/configuration&gt;
    &lt;/authentication-configurations&gt;
  &lt;/authentication-client&gt;
  &lt;jboss-ejb-client xmlns="urn:jboss:wildfly-client-ejb:3.0"&gt;
      &lt;connections&gt;
          &lt;connection uri="remote+http://127.0.0.1:8080" /&gt;
      &lt;/connections&gt;
&lt;/jboss-ejb-client&gt;
&lt;/configuration&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Using the <code>wildfly-config.xml</code>, the InitialContext creation does not specify
the host/port/user/pass since it is already defined in the wildfly-config.xml.
The EJB lookup</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">public static Context getInitialContext(String host, Integer port, String username, String password) throws NamingException {
   Properties props = new Properties();
   props.put(Context.INITIAL_CONTEXT_FACTORY,  "org.wildfly.naming.client.WildFlyInitialContextFactory");
   return new InitialContext(props);
}
public void callRemoteEjb() {
   HelloRemote remote = getInitialContext(host, port, user, pass).lookup("ejb:helloWorld/helloWorld-ejb/HelloWorldSLSB!org.jboss.examples.ejb.HelloRemote");
      remote.helloWorld();
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="how-does-wildfly-naming-client-work"><a class="anchor" href="#how-does-wildfly-naming-client-work"></a>20.2.3. How does wildfly naming client work</h4>
<div class="paragraph">
<p>We have so far had an overview of how the client code looks like when
using the wildfly-naming-client project. Let&#8217;s now have a brief look at how the wildfly-naming-client project
internally establishes the communication with the server and allows JNDI
operations from the client side.</p>
</div>
<div class="paragraph">
<p>When the client code creates an InitialContext backed by the
org.wildfly.naming.client.WildFlyInitialContextFactory class, the
<code>org.wildfly.naming.client.WildFlyInitialContextFactory</code> internally looks
for the PROVIDER_URL (and other) properties that are applicable for that
context ( <em>doesn&#8217;t</em> matter whether it comes from the jndi.properties
file or whether passed explicitly to the constructor of the
InitialContext). Once it identifies the server and port to connect to,
the wildfly-naming-client project internally sets up a connection using the
remoting APIs with the remoting connector which is exposed on that
port.</p>
</div>
<div class="paragraph">
<p>It has also increased its support for security configurations.
Every service including the http+remote connector (which
listens by default on port 8080), is secured.
This means that when trying to do JNDI operations like a
lookup, the client has to pass appropriate user credentials. In our
examples so far we haven&#8217;t passed any username/pass or any other
credentials while creating the InitialContext. That was just to keep the
examples simple. But let&#8217;s now check and use one
of the ways how we pass the user credentials. Let&#8217;s at the moment just
assume that the remoting connector on port 8080 is accessible to a user
named " `ranabir`" whose password is expected to be " `redhat1!`".</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">void doLookup() {
  Properties props = new Properties();
  props.put(Context.INITIAL_CONTEXT_FACTORY,  "org.wildfly.naming.client.WildFlyInitialContextFactory");
  props.put(Context.PROVIDER_URL, "remote+https://localhost:8080");
  // provide an username
  props.put(Context.SECURITY_PRINCIPAL, "ranabir");
  // provide a password
  props.put(Context.SECURITY_CREDENTIALS, "redhat1!");
  // create a context passing these properties
  InitialContext ctx = new InitialContext(props);
  Blah blah = (Blah) ctx.lookup("foo:blah");
  ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The code is similar to our previous example, except that we now have
added 2 additional properties that are passed to the InitialContext
constructor. The first is <code>Context.SECURITY_PRINCIPAL</code>
which passes the username (ranabir in this case)
and the second is Context.SECURITY_CREDENTIALS
which passes the password (redhat1! in this case). Of course the same
properties can be configured in the jndi.properties file (read the
javadoc of the Context class for appropriate properties to be used in
the jndi.properties) and as well as in wildfly-config.xml.
This is one way of passing the security credentials for JNDI communication with WildFly.
There are some other ways to do this too.</p>
</div>
<div class="paragraph">
<p>Moreover In order to manage Lookup High Availability, you can provide a list of remote servers
that will be checked for the Initial Lookup of the remote+http call. Here is the updated
<code>PROVIDER_URL</code> format, supposing you were to contact two servers located at localhost:8080 and localhost:8180</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">props.put(Context.PROVIDER_URL, "remote+http://localhost:8080,remote+http://localhost:8180");</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="jndi-operations-allowed-using-wildfly-naming-client-project"><a class="anchor" href="#jndi-operations-allowed-using-wildfly-naming-client-project"></a>20.2.4. JNDI operations allowed using wildfly-naming-client project</h4>
<div class="paragraph">
<p>So far we have mainly concentrated on how the naming context is created
and what it internally does when an instance is created. Let&#8217;s now take
this one step further and see what kind of operations are allowed for a
JNDI context backed by the wildfly-naming-client project.</p>
</div>
<div class="paragraph">
<p>The JNDI Context has various methods that
are exposed for JNDI operations. One important thing to note in case of
wildfly-naming-client project is that, the project&#8217;s scope is to allow a client
to communicate with the JNDI backend exposed by the server. As such, the
wildfly-naming-client project does <strong>not</strong> support many of the methods that are
exposed by the javax.naming.Context class. The wildfly-naming-client project
only supports the read-only kind of methods (like the lookup() method)
and does not support any write kind of methods (like the bind() method).
The client applications are expected to use the wildfly-naming-client project
mainly for lookups of JNDI objects. Neither WildFly nor wildfly-naming-client
project allows writing/binding to the JNDI server from a remote
application.</p>
</div>
</div>
<div class="sect3">
<h4 id="pre-requisites-of-remotely-accessible-jndi-objects"><a class="anchor" href="#pre-requisites-of-remotely-accessible-jndi-objects"></a>20.2.5. Pre-requisites of remotely accessible JNDI objects</h4>
<div class="paragraph">
<p>On the server side, the JNDI can contain numerous objects that are bound
to it. However, <em>not</em> all of those are exposed remotely. The two
conditions that are to be satisfied by the objects bound to JNDI, to be
remotely accessible are:</p>
</div>
<div class="paragraph">
<p>1) Such objects should be bound under the <code>java:jboss/exported/</code>
namespace. For example, <code>java:jboss/exported/foo/bar</code><br>
2) Objects bound to the <code>java:jboss/exported/</code> namespace are expected to
be serializable. This allows the objects to be sent over the wire to the
remote clients</p>
</div>
<div class="paragraph">
<p>Both these conditions are important and are required for the objects to
be remotely accessible via JNDI.</p>
</div>
</div>
<div class="sect3">
<h4 id="jndi-lookup-strings-for-remote-clients-backed-by-the-wildfly-naming-client-project"><a class="anchor" href="#jndi-lookup-strings-for-remote-clients-backed-by-the-wildfly-naming-client-project"></a>20.2.6. JNDI lookup strings for remote clients backed by the wildfly-naming-client project</h4>
<div class="paragraph">
<p>In our examples, so far, we have been consistently using " `foo/bar`" as
the JNDI name to lookup from a remote client using the wildfly-naming-client
project. There&#8217;s a bit more to understand about the JNDI name and how it
maps to the JNDI name that&#8217;s bound on the server side.</p>
</div>
<div class="paragraph">
<p>First of all, the JNDI names used while using the wildfly-naming-client project
are <strong>always</strong> relative to the java:jboss/exported/ namespace. So in our
examples, we are using " `foo/bar`" JNDI name for the lookup, that
actually is (internally) " `java:jboss/exported/foo/bar`". The
wildfly-naming-client project expects it to <strong>always</strong> be relative to the "
`java:jboss/exported/`" namespace. Once connected with the server side,
the wildfly-naming-client project will lookup for "foo/bar" JNDI name under the
" `java:jboss/exported/`" namespace of the server.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Note: Since the JNDI name that you use on the client side is <strong>always</strong>
relative to java:jboss/exported namespace, you <strong>shouldn&#8217;t</strong> be prefixing
the java:jboss/exported/ string to the JNDI name. For example, if you
use the following JNDI name:
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>ctx.lookup("java:jboss/exported/helloworld");</p>
</div>
<div class="paragraph">
<p>then wildfly-naming-client will translate it to</p>
</div>
<div class="paragraph">
<p>ctx.lookup("java:jboss/exported/java:jboss/exported/helloworld");</p>
</div>
<div class="paragraph">
<p>and as a result, will fail during lookup.</p>
</div>
<div class="paragraph">
<p>The wildfly-naming-client implementation perhaps should be smart enough to strip
off the java:jboss/exported/ namespace prefix if supplied. But let&#8217;s not
go into that here.</p>
</div>
</div>
<div class="sect3">
<h4 id="how-does-wildfly-naming-client-project-implementation-transfer-the-jndi-objects-to-the-clients"><a class="anchor" href="#how-does-wildfly-naming-client-project-implementation-transfer-the-jndi-objects-to-the-clients"></a>20.2.7. How does wildfly-naming-client project implementation transfer the JNDI</h4>
<div class="paragraph">
<p>objects to the clients</p>
</div>
<div class="paragraph">
<p>When a lookup is done on a JNDI string, the wildfly-naming-client implementation
internally uses the connection to the remoting connector (which it has
established based on the properties that were passed to the
InitialContext) to communicate with the server. On the server side, the
implementation then looks for the JNDI name under the
<code>java:jboss/exported/</code> namespace. Assuming that the JNDI name is
available, under that namespace, the wildfly-naming-client implementation then
passes over the object bound at that address to the client. This is
where the requirement about the JNDI object being serializable comes
into picture. wildfly-naming-client project internally uses jboss-marshalling
project to marshal the JNDI object over to the client. On the client
side the wildfly-naming-client implementation then unmarshalles the object and
returns it to the client application.</p>
</div>
<div class="paragraph">
<p>So literally, each lookup backed by the wildfly-naming-client project entails a
server side communication/interaction and then marshalling/unmarshalling
of the object graph. This is very important to remember. We&#8217;ll come back
to this later, to see why this is important when it comes to using EJB
client API project for doing EJB lookups ( <a href="#EJB_invocations_from_a_remote_client_using_JNDI">EJB
invocations from a remote client using JNDI</a>) as against using
wildfly-naming-client project for doing the same thing.</p>
</div>
</div>
<div class="sect3">
<h4 id="few-more-things-"><a class="anchor" href="#few-more-things-"></a>20.2.8. Few more things</h4>
<div class="paragraph">
<p>Unlike the previous <code>jboss-remote-naming</code> project, the connection to
the peer is not requested. Until an operation is performed on the connection,
and all consumers of the same remote URL will share a connection.
The connection lifecycle is independent of any <code>Context</code> instances which reference it.</p>
</div>
<div class="paragraph">
<p>Multiple services can be looked up via the same context. To register providers,
implement the <code>org.wildfly.naming.client.NamingProvider</code> interface and register the
implementation using the approach described in the <code>java.util.ServiceLoader</code> documentation.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Note: One important thing is that jndi.properties should not be packaged in an
app running in Wildfly though you can put it in a standalone java app.
The reason is, when you run in Wildfly , if you do new InitialContext() and
you have jndi.properties in your classpath, it will read those settings
and change the default configuration for the whole wildfly JVM.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="summary-remote-ejb-invocations"><a class="anchor" href="#summary-remote-ejb-invocations"></a>20.3. Summary</h3>
<div class="paragraph">
<p>That pretty much covers whatever is important to know, in the
wildfly-naming-client project, for a typical client application.
This simple JNDI/naming client library abstracts away some of the
pain of JNDI by providing the following features:
Federation support, Class loader based provider extensibility,
A replacement implementation of the <code>jboss-remote-naming</code> protocol,
Abstract context implementations for supporting relative contexts and
federation in custom naming providers.</p>
</div>
<div class="paragraph">
<p>Those of you who don&#8217;t have client applications doing remote EJB
invocations, can just skip the rest of this article if you aren&#8217;t
interested in those details.</p>
</div>
</div>
<div class="sect2">
<h3 id="remote-ejb-invocations-backed-by-the-wildfly-naming-client-project"><a class="anchor" href="#remote-ejb-invocations-backed-by-the-wildfly-naming-client-project"></a>20.4. Remote EJB invocations backed by the wildfly-naming-client project</h3>
<div class="paragraph">
<p>In previous sections of this article we saw that whatever is exposed in
the java:jboss/exported/ namespace is accessible remotely to the client
applications under the relative JNDI name. Some of you might already
have started thinking about exposing remote views of EJBs under that
namespace.</p>
</div>
<div class="paragraph">
<p>It&#8217;s important to note that WildFly server side already by default
exposes the remote views of a EJB under the <code>java:jboss/exported/</code>
namespace (although it isn&#8217;t logged in the server logs). So assuming
your server side application has the following stateless bean:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">package org.myapp.ejb;

@Stateless
@Remote(Foo.class)
public class FooBean implements Foo {
...
 public String sayBar() {
     return "Baaaaaaaar";
 }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then the " <code>Foo`" remote view is exposed under the
`java:jboss/exported/</code> namespace under the following JNDI name scheme
(which is similar to that mandated by Jakarta Enterprise Beans 3.2 spec for <code>java:global/</code>
namespace)</p>
</div>
<div class="paragraph">
<p><code>app-name/module-name/bean-name!bean-interface</code></p>
</div>
<div class="paragraph">
<p>where,</p>
</div>
<div class="paragraph">
<p><code>app-name</code> = the name of the .ear (without the .ear suffix) or the
application name configured via application.xml deployment descriptor.
If the application isn&#8217;t packaged in a .ear then there will be <strong>no</strong>
app-name part to the JNDI string.<br>
<code>module-name</code> = the name of the .jar or .war (without the .jar/.war
suffix) in which the bean is deployed or the module-name configured in
web.xml/ejb-jar.xml of the deployment. The module name is mandatory part
in the JNDI string.<br>
<code>bean-name</code> = the name of the bean which by default is the simple name
of the bean implementation class. Of course it can be overridden either
by using the "name" attribute of the bean definining annotation
(@Stateless(name="blah") in this case) or even the ejb-jar.xml
deployment descriptor.<br>
<code>bean-interface</code> = the fully qualified class name of the interface being
exposed by the bean.</p>
</div>
<div class="paragraph">
<p>So in our example above, let&#8217;s assume the bean is packaged in a
myejbmodule.jar which is within a myapp.ear. So the JNDI name for the
Foo remote view under the <code>java:jboss/exported/</code> namespace would be:</p>
</div>
<div class="paragraph">
<p><code>java:jboss/exported/myapp/myejbmodule/FooBean!org.myapp.ejb.Foo</code></p>
</div>
<div class="paragraph">
<p>That&#8217;s where WildFly will <strong>automatically</strong> expose the remote views of the
EJBs under the <code>java:jboss/exported/</code> namespace, <strong>in addition to</strong> the
java:global/ java:app/ java:module/ namespaces mandated by the EJB 3.1
spec.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Note that only the java:jboss/exported/ namespace is available to remote
clients.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>So the next logical question would be, are these remote views of EJBs
accessible and invokable using the wildfly-naming-client project on the client
application. The answer is <em>yes</em>! Let&#8217;s quickly see the client code for
invoking our <code>FooBean</code>. Again, let&#8217;s just use " `ranabir`" and " `redhat1!`"
as username/password for connecting to the remoting connector.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">void doBeanLookup() {
  ...
  Properties props = new Properties();
  props.put(Context.INITIAL_CONTEXT_FACTORY, "org.wildfly.naming.client.WildFlyInitialContextFactory");
  props.put(Context.PROVIDER_URL,"remote+https://localhost:8080");
  // username
  props.put(Context.SECURITY_PRINCIPAL, "ranabir");
  // password
  props.put(Context.SECURITY_CREDENTIALS, "redhat1!");
  // This is an important property to set if you want to do EJB invocations via the wildfly-naming-client project
  props.put("wildfly.naming.client.ejb.context", true);
  // create a context passing these properties
  InitialContext ctx = new InitialContext(props);
  // lookup the bean     Foo
  beanRemoteInterface = (Foo) ctx.lookup("myapp/myejbmodule/FooBean!org.myapp.ejb.Foo");
  String bar = beanRemoteInterface.sayBar();
  System.out.println("Remote Foo bean returned " + bar);
  ctx.close();
  // after this point the beanRemoteInterface is not longer valid!
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see, most of the code is similar to what we have been seeing
so far for setting up a JNDI context backed by the wildfly-naming-client
project. The only parts that change are:</p>
</div>
<div class="paragraph">
<p>\1) An additional " `wildfly.naming.client.ejb.context`" property that is
added to the properties passed to the InitialContext constructor.<br>
2) The JNDI name used for the lookup<br>
3) And subsequently the invocation on the bean interface returned by the
lookup.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s see what the " <code>wildfly.naming.client.ejb.context`" does. In
WildFly, remote access/invocations on EJBs is facilitated by the JBoss
specific EJB client API, which is a project on its own
<a href="https://github.com/wildfly/jboss-ejb-client" class="bare">https://github.com/wildfly/jboss-ejb-client</a>. So no matter, what
mechanism you use (wildfly-naming-client or core EJB client API), the
invocations are ultimately routed through the EJB client API project. In
this case too, the wildfly-naming-client internally uses EJB client API to
handle EJB invocations. From a EJB client API project perspective, for
successful communication with the server, the project expects a
`EJBClientContext</code> backed by (atleast one) <code>EJBReceiver</code>(s). The
<code>EJBReceiver</code> is responsible for handling the EJB invocations. One type
of a <code>EJBReceiver</code> is a <code>RemotingConnectionEJBReceiver</code> which internally
uses jboss-remoting project to communicate with the remote server to
handle the EJB invocations. Such a <code>EJBReceiver</code> expects a connection
backed by the jboss-remoting project. Of course to be able to connect to
the server, such a <code>EJBReceiver</code> would have to know the server address,
port, security credentials and other similar parameters. If you were
using the core EJB client API, then you would have configured all these
properties via the jboss-ejb-client.properties or via programatic API
usage as explained here <a href="#EJB_invocations_from_a_remote_client_using_JNDI">EJB invocations from a remote
client using JNDI</a>. But in the example above, we are using wildfly-naming-client
project and are <em>not</em> directly interacting with the EJB client API
project.</p>
</div>
<div class="paragraph">
<p>If you look closely at what&#8217;s being passed, via the JNDI properties, to
the wildfly-naming-client project and if you remember the details that we
explained in a previous section about how the wildfly-naming-client project
establishes a connection to the remote server, you&#8217;ll realize that these
properties are indeed the same as what the
<code>RemotingConnectionEJBReceiver</code> would expect to be able to establish the
connection to the server. Now this is where the "
<code>wildfly.naming.client.ejb.context`" property comes into picture. When
this is set to true and passed to the InitialContext creation (either
via jndi.properties or via the constructor of that class), the
wildfly-naming-client project internally will do whatever is necessary to setup
a `EJBClientContext</code>, containing a <code>RemotingConnectionEJBReceiver</code> which
is created using the <strong>same</strong> remoting connection that is created by and
being used by wildfly-naming-client project for its own JNDI communication
usage. So effectively, the InitialContext creation via the wildfly-naming-client
project has now internally triggered the creation of a
<code>EJBClientContext</code> containing a <code>EJBReceiver</code> capable of handling the
EJB invocations (remember, no remote EJB invocations are possible
without the presence of a <code>EJBClientContext</code> containing a <code>EJBReceiver</code>
which can handle the EJB).</p>
</div>
<div class="paragraph">
<p>So we now know the importance of the "
<code>wildfly.naming.client.ejb.context`" property and its usage. Let&#8217;s move on
the next part in that code, the JNDI name. Notice that we have used the
JNDI name relative to the `java:jboss/exported/</code> namespace while doing
the lookup. And since we know that the Foo view is exposed on that JNDI
name, we cast the returned object back to the Foo interface. Remember
that we earlier explained how each lookup via wildfly-naming-client triggers a
server side communication and a marshalling/unmarshalling process. This
applies for EJB views too. In fact, the wildfly-naming-client project has no
clue (since that&#8217;s not in the scope of that project to know) whether
it&#8217;s an EJB or some random object.</p>
</div>
<div class="paragraph">
<p>Once the unmarshalled object is returned (which actually is a proxy to
the bean), the rest is straightforward, we just invoke on that returned
object. Now since the wildfly-naming-client implementation has done the
necessary setup for the EJBClientContext (due to the presence of "
<code>wildfly.naming.client.ejb.context`" property), the invocation on that
proxy will internally use the `EJBClientContext</code> (the proxy is smart
enough to do that) to interact with the server and return back the
result. We won&#8217;t go into the details of how the EJB client API handles
the communication/invocation.</p>
</div>
<div class="paragraph">
<p><em>Long story short, using the wildfly-naming-client project for doing remote EJB
invocations against WildFly is possible!</em></p>
</div>
</div>
<div class="sect2">
<h3 id="why-use-the-ejb-client-api-approach-then"><a class="anchor" href="#why-use-the-ejb-client-api-approach-then"></a>20.5. Why use the EJB client API approach then?</h3>
<div class="paragraph">
<p>I can guess that some of you might already question why/when would one
use the EJB client API style lookups as explained in the
<a href="#EJB_invocations_from_a_remote_client_using_JNDI">EJB invocations from a remote client using JNDI</a>
article instead of just using (what appears to be a simpler)
wildfly-naming-client style lookups.</p>
</div>
<div class="paragraph">
<p>Before we answer that, let&#8217;s understand a bit about the EJB client
project. The EJB client project was implemented keeping in mind various
optimizations and features that would be possible for handling remote
invocations. One such optimization was to avoid doing unnecessary server
side communication(s) which would typically involve network calls,
marshalling/unmarshalling etc&#8230;&#8203; The easiest place where this
optimization can be applied, is to the EJB lookup. Consider the
following code (let&#8217;s ignore how the context is created):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">ctx.lookup("foo/bar");</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now <code>foo/bar</code> JNDI name could potentially point to <strong>any</strong> type of object
on the server side. The jndi name itself won&#8217;t have the type/semantic
information of the object bound to that name on the server side. If the
context was setup using the wildfly-naming-client project (like we have seen
earlier in our examples), then the only way for wildfly-naming-client to return
an object for that lookup operation is to communicate with the server
and marshal/unmarshal the object bound on the server side. And that&#8217;s
exactly what it does (remember, we explained this earlier).</p>
</div>
<div class="sect3">
<h4 id="is-the-lookup-optimization-applicable-for-all-bean-types"><a class="anchor" href="#is-the-lookup-optimization-applicable-for-all-bean-types"></a>20.5.1. Is the lookup optimization applicable for all bean types?</h4>
<div class="paragraph">
<p>In the previous section we have mentioned that the lookup
optimization by the EJB client API project happens for stateless beans.
This kind of optimization is <strong>not</strong> possible for stateful beans because
in case of stateful beans, a lookup is expected to create a session for
that stateful bean and for session creation we do have to communicate
with the server since the server is responsible for creating that
session.</p>
</div>
<div class="paragraph">
<p>That&#8217;s exactly why the EJB client API project expects the JNDI name
lookup string for stateful beans to include the " `?stateful`" string at
the end of the JNDI name:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">context.lookup("ejb:myapp/myejbmodule//StatefulBean!org.myapp.ejb.Counter?stateful");</code></pre>
</div>
</div>
<div class="paragraph">
<p>Notice the use of `"?stateful`" in that JNDI name. See
<a href="#EJB_invocations_from_a_remote_client_using_JNDI">EJB invocations from a remote client using JNDI</a> for
more details about such lookup.</p>
</div>
<div class="paragraph">
<p>The presence of " <code>?stateful`" in the JNDI name lookup string is a
directive to the EJB client API to let it know that a stateful bean is
being looked up and it&#8217;s necessary to communicate with the server and
create a session during that lookup. Though `?stateful</code> is optional now.</p>
</div>
<div class="paragraph">
<p>So as you can see, we have managed to optimize certain operations by
using the EJB client API for EJB lookup/invocation as against using the
wildfly-naming-client project. There are other EJB client API implementation
details (and probably more might be added) which are superior when it is
used for remote EJB invocations in client applications as against
wildfly-naming-client project which doesn&#8217;t have the intelligence to carry out
such optimizations for EJB invocations. <em>That&#8217;s why the wildfly-naming-client
project</em> <strong><em>for remote EJB invocations</em></strong> <em>is considered "</em> <code>deprecated</code>
<em>"</em>. Note that if you want to use wildfly-naming-client for looking up and
invoking on non-EJB remote objects then you are free to do so. In fact,
that&#8217;s why that project has been provided. You can even use the
wildfly-naming-client project for EJB invocations (like we just saw), if you are
fine with <em>not</em> wanting the optimizations that the EJB client API can do
for you or if you have other restrictions that force you to use that
project.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
References in this document to Enterprise JavaBeans(EJB) refer to the Jakarta Enterprise Beans unless otherwise noted.
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="Migrated_to_WildFly_Example_Applications"><a class="anchor" href="#Migrated_to_WildFly_Example_Applications"></a>21. Example Applications - Migrated to WildFly</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="example-applications-migrated-from-previous-releases"><a class="anchor" href="#example-applications-migrated-from-previous-releases"></a>21.1. Example Applications Migrated from Previous Releases</h3>
<div class="paragraph">
<p>The applications in this section were written for a previous version of
the server but have been modified to run on WildFly or JBoss AS 7,
which was based on the same core architecture WildFly uses. Changes were made
to resolve issues that arose during deployment and runtime or to fix
problems with application behaviour. Each example below documents the
changes that were made to get the application to run successfully.</p>
</div>
<div class="sect3">
<h4 id="seam-2-dvd-store-example"><a class="anchor" href="#seam-2-dvd-store-example"></a>21.1.1. Seam 2 DVD Store example</h4>
<div class="paragraph">
<p>For details on how to migrate this demo application, see
<a href="https://community.jboss.org/blogs/marek-novotny/2011/12/16/dvdstore-migration-for-jboss-as-710beta">Seam
2 DVD Store example on JBoss AS 7</a> on Marek Novotny&#8217;s Blog.</p>
</div>
</div>
<div class="sect3">
<h4 id="seam-2-booking-example"><a class="anchor" href="#seam-2-booking-example"></a>21.1.2. Seam 2 Booking example</h4>
<div class="paragraph">
<p>For details on how to migrate this demo application, see
<a href="http://community.jboss.org/blogs/marek-novotny/2011/07/29/seam-2-booking-example-on-jboss-as-7">Seam
2 Booking example on JBoss AS 7</a> on Marek Novotny&#8217;s Blog.</p>
</div>
</div>
<div class="sect3">
<h4 id="jbpm-console-application"><a class="anchor" href="#jbpm-console-application"></a>21.1.3. jBPM-Console application</h4>
<div class="paragraph">
<p>Kris Verlaenen migrated this application from JBoss AS 5 to JBoss AS 7. For
details about this migration, see <a href="http://kverlaen.blogspot.com/2011/07/jbpm5-on-as7-lightning.html">jBPM5 on JBoss AS 7</a> on his Kris&#8217;s Blog.</p>
</div>
</div>
<div class="sect3">
<h4 id="order-application-used-for-performance-testing"><a class="anchor" href="#order-application-used-for-performance-testing"></a>21.1.4. Order application used for performance testing</h4>
<div class="paragraph">
<p>Andy Miller migrated this application from JBoss AS 5 to JBoss AS 7. For details
about this migration, see <a href="#Migrate_Order_Application_from_EAP5">Order Application Migration from EAP5.1 to JBoss AS 7</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="migrate-example-application"><a class="anchor" href="#migrate-example-application"></a>21.1.5. Migrate example application</h4>
<div class="paragraph">
<p>A step by step work through of issues, and their solutions, that might
crop up when migrating applications to WildFly 14. See the following
<a href="https://github.com/danbev/migrate">github project</a> for details.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="example-applications-based-on-ee6"><a class="anchor" href="#example-applications-based-on-ee6"></a>21.2. Example Applications Based on EE6</h3>
<div class="paragraph">
<p>Applications in this section were designed and written specifically to
use the features and functions of EE6.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Quickstarts: A number of quickstart applications were written to
demonstrate Jakarta EE and a few additional technologies. They provide
small, specific, working examples that can be used as a reference for
your own project. For more information about the quickstarts, see
<a href="http://www.jboss.org/jdf/quickstarts/jboss-as-quickstart/guide/Introduction/">Get Started Developing Applications</a></p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="Migrate_Order_Application_from_EAP5"><a class="anchor" href="#Migrate_Order_Application_from_EAP5"></a>22. Porting the Order Application from EAP 5.1 to JBoss AS 7</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Andy Miller ported an example Order application that was used for
performance testing from EAP 5.1 to JBoss AS 7. These are the notes he
made during the migration process.</p>
</div>
<div class="sect2">
<h3 id="overview-of-the-application"><a class="anchor" href="#overview-of-the-application"></a>22.1. Overview of the application</h3>
<div class="paragraph">
<p>The application is relatively simple. it contains three servlets, some
stateless session beans, a stateful session bean, and some entities.</p>
</div>
<div class="paragraph">
<p>In addition to application code changes, modifications were made to the
way the EAR was packaged. This is because WildFly removed support of
some proprietary features that were available in EAP 5.1.</p>
</div>
</div>
<div class="sect2">
<h3 id="summary-of-changes-migrate-order-application"><a class="anchor" href="#summary-of-changes-migrate-order-application"></a>22.2. Summary of changes</h3>
<div class="sect3">
<h4 id="code-changes"><a class="anchor" href="#code-changes"></a>22.2.1. Code Changes</h4>
<div class="sect4">
<h5 id="modify-jndi-lookup-code"><a class="anchor" href="#modify-jndi-lookup-code"></a>Modify JNDI lookup code</h5>
<div class="paragraph">
<p>Since this application was first written for EAP 4.2/4.3, which did not
support EJB reference injection, the servlets were using pre-EE 5
methods for looking up stateless and stateful session bean interfaces.
While migrating to WildFly, it seemed a good time to change the code to
use the @EJB annotation, although this was not a required change.</p>
</div>
<div class="paragraph">
<p>The real difference is in the lookup name. WildFly only supports the new
EE 6 portable JNDI names rather than the old EAR structure based names.
The JNDI lookup code changed as follows:</p>
</div>
<div class="paragraph">
<p>Example of code in the EAP 5.1 version:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">try {
    context = new InitialContext();
    distributionCenterManager = (DistributionCenterManager) context.lookup("OrderManagerApp/DistributionCenterManagerBean/local");
} catch(Exception lookupError) {
    throw new ServletException("Couldn't find DistributionCenterManager bean", lookupError);
}
try {
    customerManager = (CustomerManager) context.lookup("OrderManagerApp/CustomerManagerBean/local");
} catch(Exception lookupError) {
    throw new ServletException("Couldn't find CustomerManager bean", lookupError);
}

try {
    productManager = (ProductManager) context.lookup("OrderManagerApp/ProductManagerBean/local");
} catch(Exception lookupError) {
    throw new ServletException("Couldn't find the ProductManager bean", lookupError);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Example of how this is now coded in WildFly:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">@EJB(lookup="java:app/OrderManagerEJB/DistributionCenterManagerBean!services.ejb.DistributionCenterManager")
private DistributionCenterManager distributionCenterManager;

@EJB(lookup="java:app/OrderManagerEJB/CustomerManagerBean!services.ejb.CustomerManager")
private CustomerManager customerManager;

@EJB(lookup="java:app/OrderManagerEJB/ProductManagerBean!services.ejb.ProductManager")
private ProductManager productManager;</code></pre>
</div>
</div>
<div class="paragraph">
<p>In addition to the change to injection, which was supported in EAP
5.1.0, the lookup name changed from:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">OrderManagerApp/DistributionCenterManagerBean/local</code></pre>
</div>
</div>
<div class="paragraph">
<p>to:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">java:app/OrderManagerEJB/DistributionCenterManagerBean!services.ejb.DistributionCenterManager</code></pre>
</div>
</div>
<div class="paragraph">
<p>All the other beans were changed in a similar manner. They are now based
on the portable JNDI names described in EE 6.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="modify-logging-code"><a class="anchor" href="#modify-logging-code"></a>22.2.2. Modify logging code</h4>
<div class="paragraph">
<p>The next major change was to logging within the application. The old
version was using the commons logging infrastructure and Log4J that is
bundled in the application server. Rather than bundling third-party
logging, the application was modified to use the new WildFly Logging
infrastructure.</p>
</div>
<div class="paragraph">
<p>The code changes themselves are rather trivial, as this example
illustrates:</p>
</div>
<div class="paragraph">
<p>Old JBoss Commons Logging/Log4J:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">private static Log log = LogFactory.getLog(CustomerManagerBean.class);</code></pre>
</div>
</div>
<div class="paragraph">
<p>New WildFly Logging</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">private static Logger logger = Logger.getLogger(CustomerManagerBean.class.toString());</code></pre>
</div>
</div>
<div class="paragraph">
<p>Old JBoss Commons Logging/Log4J:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">if(log.isTraceEnabled()) {
    log.trace("Just flushed " + batchSize + " rows to the database.");
    log.trace("Total rows flushed is " + (i+1));
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>New WildFly Logging:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">if(logger.isLoggable(Level.TRACE)) {
    logger.log(Level.TRACE, "Just flushed " + batchSize + " rows to the database.");
    logger.log(Level.TRACE, "Total rows flushed is " + (i+1));
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>In addition to the code changes made to use the new AS7 JBoss log
manager module, you must add this dependency to the <code>MANIFEST.MF</code> file
as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">Manifest-Version: 1.0
Dependencies: org.jboss.logmanager</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="modify-the-code-to-use-infinispan-for-2nd-level-cache"><a class="anchor" href="#modify-the-code-to-use-infinispan-for-2nd-level-cache"></a>22.2.3. Modify the code to use Infinispan for 2nd level cache</h4>
<div class="paragraph">
<p>Jboss Cache has been replaced by Infinispan for 2nd level cache. This
requires modification of the <code>persistence.xml</code> file.</p>
</div>
<div class="paragraph">
<p>This is what the file looked like in EAP 5.1:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">&lt;properties&gt;
&lt;property name="hibernate.cache.region.factory_class" value="org.hibernate.cache.jbc2.JndiMultiplexedJBossCacheRegionFactory"/&gt;
&lt;property name="hibernate.cache.region.jbc2.cachefactory" value="java:CacheManager"/&gt;
&lt;property name="hibernate.cache.use_second_level_cache" value="true"/&gt;
&lt;property name="hibernate.cache.use_query_cache" value="false"/&gt;
&lt;property name="hibernate.cache.use_minimal_puts" value="true"/&gt;
&lt;property name="hibernate.cache.region.jbc2.cfg.entity" value="mvcc-entity"/&gt;
&lt;property name="hibernate.cache.region_prefix" value="services"/&gt;
&lt;/properties&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>This is how it was modified to use Infinispan for the same
configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">&lt;properties&gt;
&lt;property name="hibernate.cache.use_second_level_cache" value="true"/&gt;
&lt;property name="hibernate.cache.use_minimal_puts" value="true"/&gt;
&lt;/properties&gt;
&lt;shared-cache-mode&gt;ENABLE_SELECTIVE&lt;/shared-cache-mode&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Most of the properties are removed since they will default to the
correct values for the second level cache. See
<a href="https://docs.jboss.org/author/display/AS71/JPA+Reference+Guide#JPAReferenceGuide-UsingtheInfinispansecondlevelcache">"Using
the Infinispan second level cache"</a> for more details.</p>
</div>
<div class="paragraph">
<p>That was the extent of the code changes required to migrate the
application to AS7.</p>
</div>
</div>
<div class="sect3">
<h4 id="ear-packaging-changes"><a class="anchor" href="#ear-packaging-changes"></a>22.2.4. EAR Packaging Changes</h4>
<div class="paragraph">
<p>Due to modular class loading changes, the structure of the existing EAR
failed to deploy successfully in WildFly.</p>
</div>
<div class="paragraph">
<p>The old structure of the EAR was as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">$ jar tf OrderManagerApp.ear
META-INF/MANIFEST.MF
META-INF/application.xml
OrderManagerWeb.war
OrderManagerEntities.jar
OrderManagerEJB.jar
META-INF/</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this structure, the entities and the <code>persistence.xml</code> were in one
jar file, <code>OrderManagerEntities.jar</code>, and the stateless and stateful
session beans were in another jar file, <code>OrderManagerEJB.jar</code>. This did
not work due to modular class loading changes in WildFly. There are a
couple of ways to resolve this issue:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Modify the class path in the <code>MANIFEST.MF</code></p>
</li>
<li>
<p>Flatten the code and put all the beans in one JAR file.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The second approach was selected because it simplified the EAR
structure:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">$ jar tf OrderManagerApp.ear
META-INF/application.xml
OrderManagerWeb.war
OrderManagerEJB.jar
META-INF/</code></pre>
</div>
</div>
<div class="paragraph">
<p>Since there is no longer an <code>OrderManagerEntities.jar</code> file, the
<code>applcation.xml</code> file was modified to remove the entry.</p>
</div>
<div class="paragraph">
<p>An entry was added to the <code>MANIFEST.MF</code> file in the
<code>OrderManagerWeb.war</code> to resolve another class loading issue resulting
from the modification to use EJB reference injection in the servlets.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">Manifest-Version: 1.0
Dependencies: org.jboss.logmanager
Class-Path: OrderManagerEJB.jar</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>Class-Path</code> entry tells the application to look in the
<code>OrderManagerEJB.jar</code> file for the injected beans.</p>
</div>
</div>
<div class="sect3">
<h4 id="summary-migrate-order-application"><a class="anchor" href="#summary-migrate-order-application"></a>22.2.5. Summary</h4>
<div class="paragraph">
<p>Although the existing EAR structure could have worked with additional
modifications to the <code>MANIFEST.MF</code> file, this approach seemed more
appealing because it simplified the structure while maintaining the web
tier in its own WAR.</p>
</div>
<div class="paragraph">
<p>The source files for both versions is attached so you can view the
changes that were made to the application.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
References in this document to Enterprise JavaBeans(EJB) refer to the Jakarta Enterprise Beans unless otherwise noted.
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="Spring_applications_development_and_migration_guide"><a class="anchor" href="#Spring_applications_development_and_migration_guide"></a>23. Spring applications development and migration guide</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This document details the main points that need to be considered by
Spring developers that wish to develop new applications or to migrate
existing applications to be run into WildFly 14.</p>
</div>
<div class="sect2">
<h3 id="dependencies-and-modularity"><a class="anchor" href="#dependencies-and-modularity"></a>23.1. Dependencies and Modularity</h3>
<div class="paragraph">
<p>WildFly 14 has a modular class loading strategy, different from previous
versions of JBoss AS, which enforces a better class loading isolation
between deployments and the application server itself. A detailed
description can be found in the documentation dedicated to
<a href="https://docs.jboss.org/author/display/AS7/Class+Loading+in+AS7">class
loading in WildFly 14</a>.</p>
</div>
<div class="paragraph">
<p>This reduces significantly the risk of running into a class loading
conflict and allows applications to package their own dependencies if
they choose to do so. This makes it easier for Spring applications that
package their own dependencies - such as logging frameworks or
persistence providers to run on WildFly 14.</p>
</div>
<div class="paragraph">
<p>At the same time, this does not mean that duplications and conflicts
cannot exist on the classpath. Some module dependencies are implicit,
depending on the type of deployment as shown
<a href="https://docs.jboss.org/author/display/AS7/Implicit+module+dependencies+for+deployments">here</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="persistence-usage-guide"><a class="anchor" href="#persistence-usage-guide"></a>23.2. Persistence usage guide</h3>
<div class="paragraph">
<p>Depending on the strategy being used, Spring applications can be:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>native Hibernate applications;</p>
</li>
<li>
<p>Jakarta Persistence based applications;</p>
</li>
<li>
<p>native JDBC applications;</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="native-springhibernate-applications"><a class="anchor" href="#native-springhibernate-applications"></a>23.3. Native Spring/Hibernate applications</h3>
<div class="paragraph">
<p>Applications that use the Hibernate API directly with Spring (i.e.
through either one of LocalSessionFactoryBean or
AnnotationSessionFactoryBean) may use a version of Hibernate 3 packaged
inside the application. Hibernate 4 (which is provided through the
'org.hibernate' module of WildFly 14) is not supported by Spring 3.0 and
Spring 3.1 (and may be supported by Spring 3.2 as described in
<a href="https://jira.springsource.org/browse/SPR-8096">SPR-8096</a>), so adding this
module as a dependency is not a solution.</p>
</div>
</div>
<div class="sect2">
<h3 id="Jakarta-Persistence-based-applications"><a class="anchor" href="#Jakarta-Persistence-based-applications"></a>23.4. Jakarta Persistence based applications</h3>
<div class="paragraph">
<p>Spring applications using Jakarta Persistence may choose between:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>using a server-deployed persistence unit;</p>
</li>
<li>
<p>using a Spring-managed persistence unit.</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="using-server-deployed-persistence-units"><a class="anchor" href="#using-server-deployed-persistence-units"></a>23.4.1. Using server-deployed persistence units</h4>
<div class="paragraph">
<p>Applications that use a server-deployed persistence unit must observe
the typical Jakarta EE rules in what concerns dependency management, i.e.
the javax.persistence classes and persistence provider (Hibernate) are
contained in modules which are added automatically by the application
when the persistence unit is deployed.</p>
</div>
<div class="paragraph">
<p>In order to use the server-deployed persistence units from within
Spring, either the persistence context or the persistence unit need to
be registered in JNDI via web.xml as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;persistence-context-ref&gt;
    &lt;persistence-context-ref-name&gt;persistence/petclinic-em&lt;/persistence-unit-ref-name&gt;
    &lt;persistence-unit-name&gt;petclinic&lt;/persistence-unit-name&gt;
&lt;/persistence-context-ref&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>or, respectively:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;persistence-unit-ref&gt;
    &lt;persistence-unit-ref-name&gt;persistence/petclinic-emf&lt;/persistence-unit-ref-name&gt;
    &lt;persistence-unit-name&gt;petclinic&lt;/persistence-unit-name&gt;
&lt;/persistence-unit-ref&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>When doing so, the persistence context or persistence unit are available
to be looked up in JNDI, as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;jee:jndi-lookup id="entityManager" jndi-name="java:comp/env/persistence/petclinic-em"
            expected-type="javax.persistence.EntityManager"/&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>or</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;jee:jndi-lookup id="entityManagerFactory" jndi-name="java:comp/env/persistence/petclinic-emf"
            expected-type="javax.persistence.EntityManagerFactory"/&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>JNDI binding</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
JNDI binding via persistence.xml properties is not supported in WildFly
8.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="using-spring-managed-persistence-units"><a class="anchor" href="#using-spring-managed-persistence-units"></a>23.4.2. Using Spring-managed persistence units</h4>
<div class="paragraph">
<p>Spring applications running in WildFly 14 may also create persistence
units on their own, using the LocalContainerEntityManagerFactoryBean.
This is what these applications need to consider:</p>
</div>
<div class="sect4">
<h5 id="placement-of-the-persistence-unit-definitions"><a class="anchor" href="#placement-of-the-persistence-unit-definitions"></a>Placement of the persistence unit definitions</h5>
<div class="paragraph">
<p>When the application server encounters a deployment that has a file
named META-INF/persistence.xml (or, for that matter,
WEB-INF/classes/META-INF/persistence.xml), it will attempt to create a
persistence unit based on what is provided in the file. In most cases,
such definition files are not compliant with the Jakarta EE requirements,
mostly because required elements such as the datasource of the
persistence unit are supposed to be provided by the Spring context
definitions, which will fail the deployment of the persistence unit, and
consequently of the entire deployment.</p>
</div>
<div class="paragraph">
<p>Spring applications can easily avoid this type of conflict, by using a
feature of the LocalContainerEntityManagerFactoryBean which is designed
for this purpose. Persistence unit definition files can exist in other
locations than META-INF/persistence.xml and the location can be
indicated through the persistenceXmlLocation property of the factory
bean class.</p>
</div>
<div class="paragraph">
<p>Assuming that the persistence unit is in the
META-INF/jpa-persistence.xml, the corresponding definition can be:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;bean id="entityManagerFactory" class="org.springframework.orm.jpa.LocalContainerEntityManagerFactoryBean"&gt;
       &lt;property name="persistenceXmlLocation" value="classpath*:META-INF/jpa-persistence.xml"/&gt;
       &lt;!-- other definitions --&gt;
&lt;/bean&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="managing-dependencies"><a class="anchor" href="#managing-dependencies"></a>23.4.3. Managing dependencies</h4>
<div class="paragraph">
<p>Since the LocalContainerEntityManagerFactoryBean and the corresponding
HibernateJpaVendorAdapter are based on Hibernate 3, it is required to
use that version with the application. Therefore, the Hibernate 3 jars
must be included in the deployment. At the same time, due the presence
of @PersistenceUnit or @PersistenceContext annotations on the
application classes, the application server will automatically add the
'org.hibernate' module as a dependency.</p>
</div>
<div class="paragraph">
<p>This can be avoided by instructing the server to exclude the module from
the deployment&#8217;s list of dependencies. In order to do so, include a
META-INF/jboss-deployment-structure.xml or, for web applications,
WEB-INF/jboss-deployment-structure.xml with the following content:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;jboss-deployment-structure xmlns="urn:jboss:deployment-structure:1.0"&gt;
  &lt;deployment&gt;
    &lt;exclusions&gt;
       &lt;module name="org.hibernate"/&gt;
    &lt;/exclusions&gt;
  &lt;/deployment&gt;
&lt;/jboss-deployment-structure&gt;</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="How_do_I_migrate_my_application_from_AS7_to_WildFly"><a class="anchor" href="#How_do_I_migrate_my_application_from_AS7_to_WildFly"></a>24. How do I migrate my application from JBoss AS 7  to WildFly 10</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="about-this-document"><a class="anchor" href="#about-this-document"></a>24.1. About this Document</h3>
<div class="paragraph">
<p>The purpose of this guide is to document changes that are needed to successfully run and deploy JBoss AS 7 applications on WildFly 10. It provides information on to resolve deployment and runtime problems and how to prevent changes in application behavior. This is the first step in moving to the new platform. Once the application is successfully deployed and running on the new platform, plans can be made to upgrade individual components to use the new functions and features of WildFly.</p>
</div>
</div>
<div class="sect2">
<h3 id="overview-of-wildfly"><a class="anchor" href="#overview-of-wildfly"></a>24.2. Overview of WildFly</h3>
<div class="paragraph">
<p>The list of WildFly new functionality is extensive, being the most relevant, with respect to server and application migrations:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Jakarta EE - WildFly is a certified implementation of Jakarta EE, meeting both the Web and the Full Platform, and already includes support for the latest iterations of CDI (1.2) and Web Sockets (1.1).</p>
</li>
<li>
<p>Undertow - A new cutting-edge web server in WildFly, designed for maximum throughput and scalability, including environments with over a million connections. And the latest web technologies, such as the new HTTP/2 standard, are already onboard.</p>
</li>
<li>
<p>Apache ActiveMQ Artemis - WildFly&#8217;s new Jakarta Messaging broker. Based on an code donation from HornetQ, this Apache subproject provides outstanding performance based on a proven non-blocking architecture.</p>
</li>
<li>
<p>IronJacamar 1.2 - The latest IronJacamar provides a stable and feature rich Jakarta Connectors &amp; Datasources support.</p>
</li>
<li>
<p>JBossWS 5 - The fifth generation of JBossWS, a major leap forward, brings new features and performances improvements to WildFly Web Services</p>
</li>
<li>
<p>RESTEasy 3 - WildFly which goes beyond the standard Jakarta EE REST APIs (Jakarta RESTful Web Services 2.1), by also providing a number of useful extensions, such as JSON Web Encryption, Jackson, Yaml, Jakarta JSON Processing, and reactive facilities.</p>
</li>
<li>
<p>OpenJDK ORB - WildFly switched the IIOP implementation from JacORB, to a downstream branch of the OpenJDK Orb, leading to better interoperability with the JVM ORB and the Jakarta EE RI.</p>
</li>
<li>
<p>Feature Rich Clustering - Clustering support was heavily refactored in WildFly, and includes several APIs for applications</p>
</li>
<li>
<p>Port Reduction - By utilizing HTTP upgrade, WildFly has moved nearly all of its protocols to be multiplexed over just two HTTP ports: a management port (9990), and an application port (8080).</p>
</li>
<li>
<p>Enhanced Logging - The management API now supports the ability to list and view the available log files on a server, or even define custom formatters other than the default pattern formatter. Deployment&#8217;s logging setup is also greatly enhanced.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The support for some technologies was removed, due to the high maintenance cost, low community interest, and much better alternative solutions:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>CMP EJB - Jakarta Persistence offers a much more performant and flexible API</p>
</li>
<li>
<p>Jakarta XML RPC - Jakarta XML Web Services offer a much more accurate and complete solution</p>
</li>
<li>
<p>JSR-88 - With very little adoption, the more complete deployment APIs provided by vendors are preferred</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="server-migration"><a class="anchor" href="#server-migration"></a>24.3. Server Migration</h3>
<div class="paragraph">
<p>Migrating a JBoss AS 7 server to WildFly consists of migrating custom configuration files, and some persisted data that may exist.</p>
</div>
<div class="sect3">
<h4 id="jacorb-subsystem"><a class="anchor" href="#jacorb-subsystem"></a>24.3.1. JacORB Subsystem</h4>
<div class="paragraph">
<p>WildFly ORB support is provided by the JDK itself, instead of relying on JacORB. A subsystem configuration migration is required.</p>
</div>
<div class="sect4">
<h5 id="jacorb-subsystem-configuration"><a class="anchor" href="#jacorb-subsystem-configuration"></a>JacORB Subsystem Configuration</h5>
<div class="paragraph">
<p>The extension&#8217;s module <code>org.jboss.as.jacorb</code> is replaced by module <code>org.wildfly.iiop-openjdk</code>, while the subsystem configuration namespace <code>urn:jboss:domain:jacorb:2.0</code> is replaced by
<code>urn:jboss:domain:iiop-openjdk:1.0</code>.</p>
</div>
<div class="paragraph">
<p>The XML configuration of the new subsystem accepts only a subset of the legacy elements and attributes. Consider the following example of the JacORB subsystem configuration, containing all valid elements and attributes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;subsystem xmlns="urn:jboss:domain:jacorb:1.3"&gt;
   &lt;orb name="JBoss" print-version="off" use-imr="off" use-bom="off"  cache-typecodes="off"
       cache-poa-names="off" giop-minor-version ="2" socket-binding="jacorb" ssl-socket-binding="jacorb-ssl"&gt;
       &lt;connection retries="5" retry-interval="500" client-timeout="0" server-timeout="0"
           max-server-connections="500" max-managed-buf-size="24" outbuf-size="2048"
           outbuf-cache-timeout="-1"/&gt;
       &lt;initializers security="off" transactions="spec"/&gt;
   &lt;/orb&gt;
   &lt;poa monitoring="off" queue-wait="on" queue-min="10" queue-max="100"&gt;
       &lt;request-processors pool-size="10" max-threads="32"/&gt;
   &lt;/poa&gt;
   &lt;naming root-context="JBoss/Naming/root" export-corbaloc="on"/&gt;
   &lt;interop sun="on" comet="off" iona="off" chunk-custom-rmi-valuetypes="on"
       lax-boolean-encoding="off" indirection-encoding-disable="off" strict-check-on-tc-creation="off"/&gt;
   &lt;security support-ssl="off" add-component-via-interceptor="on" client-supports="MutualAuth"
       client-requires="None" server-supports="MutualAuth" server-requires="None"/&gt;
   &lt;properties&gt;
       &lt;property name="some_property" value="some_value"/&gt;
   &lt;/properties&gt;
&lt;/subsystem&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Properties that are not supported and have to be removed:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>&lt;orb/&gt;</code>: <code>client-timeout</code>, <code>max-managed-buf-size</code>, <code>max-server-connections</code>, <code>outbuf-cache-timeout</code>, <code>outbuf-size</code>, <code>connection-retries</code>, <code>retry-interval</code>, <code>name,server-timeout</code></p>
</li>
<li>
<p><code>&lt;poa/&gt;</code>: <code>queue-min</code>, <code>queue-max</code>, <code>pool-size</code>, <code>max-threads</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>On-off properties: have to either be removed or in off mode:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>&lt;orb/&gt;</code>: <code>cache-poa-names</code>, <code>cache-typecodes</code>, <code>print-version</code>, <code>use-bom</code>, <code>use-imr</code></p>
</li>
<li>
<p><code>&lt;interop/&gt;</code>: all except <code>sun</code></p>
</li>
<li>
<p><code>&lt;poa/&gt;</code>: <code>monitoring</code>, <code>queue-wait</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In case the legacy subsystem configuration is available, such configuration may be migrated to the new subsystem by invoking its <code>migrate</code> operation, using the management CLI:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=jacorb:migrate</code></pre>
</div>
</div>
<div class="paragraph">
<p>There is also a <code>describe-migration</code> operation that returns a list of all the management operations that are performed to migrate from the legacy subsystem to the new one:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=jacorb:describe-migration</code></pre>
</div>
</div>
<div class="paragraph">
<p>Both <code>migrate</code> and <code>describe-migration</code> will also display a list of migration-warnings if there are some resource or attributes that can not be migrated automatically. The following is a list of these warnings:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Properties X cannot be emulated using OpenJDK ORB and are not supported</p>
<div class="paragraph">
<p>This warning means that mentioned properties are not supported and won&#8217;t be included in the new subsystem configuration. As a result of that admin must be aware that any behavior implied by those properties would be nonexistent. Admin has to check whether subsystem is able to operate
correctly without that behavior on the new server.Unsupported properties: <code>cache-poa-names</code>, <code>cache-typecodes</code>, <code>chunk-custom-rmi-valuetypes</code>, <code>client-timeout</code>, <code>comet</code>, <code>indirection-encoding-disable</code>, <code>iona</code>, <code>lax-boolean-encoding</code>, <code>max-managed-buf-size</code>, <code>max-server-connections</code>, <code>max-threads</code>, <code>outbuf-cache-timeout</code>, <code>outbuf-size</code>, <code>queue-max</code>, <code>queue-min</code>, <code>poa-monitoring</code>, <code>print-version</code>, <code>retries</code>, <code>retry-interval</code>, <code>queue-wait</code>, <code>server-timeout</code>, <code>strict-check-on-tc-creation</code>, <code>use-bom</code>, <code>use-imr</code>.</p>
</div>
</li>
<li>
<p>The properties X use expressions. Configuration properties that are used to resolve those expressions should be transformed manually to the new <code>iiop-openjdk</code> subsystem format.</p>
<div class="paragraph">
<p>Admin has to transform all the configuration files to work correctly with the <code>jacorb</code> subsystem. For example, <code>jacorb</code> has a property <code>giop-minor-version</code> whereas <code>iiop-openjdk</code> uses the property <code>giop-version</code>. Let&#8217;s suppose we use <code>1</code> minor version in <code>jacorb</code> and have it configured in <code>standalone.conf</code> file as system variable: <code>-Diiop-giop-minor-version=1</code>. Admin is responsible for changing this variable to 1.1 after the migration to make sure that the new subsystem will work correctly.</p>
</div>
</li>
</ul>
</div>
</div>
</div>
<div class="sect3">
<h4 id="jboss-web-subsystem"><a class="anchor" href="#jboss-web-subsystem"></a>24.3.2. JBoss Web Subsystem</h4>
<div class="paragraph">
<p>JBoss Web is replaced by Undertow in WildFly, which means that the legacy subsystem configuration should be migrated to WildFly&#8217;s Undertow subsystem configuration.</p>
</div>
<div class="sect4">
<h5 id="jboss-web-subsystem-configuration"><a class="anchor" href="#jboss-web-subsystem-configuration"></a>JBoss Web Subsystem Configuration</h5>
<div class="paragraph">
<p>The extension&#8217;s module <code>org.jboss.as.web</code> is replaced by module <code>org.wildfly.extension.undertow</code>, while the subsystem configuration namespace <code>urn:jboss:domain:web:</code> is replaced by
<code>urn:jboss:domain:undertow:</code>.</p>
</div>
<div class="paragraph">
<p>The XML configuration of the new subsystem is relatively different. Consider the following example of the JBoss Web subsystem configuration, containing all valid elements and attributes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;subsystem xmlns="urn:jboss:domain:web:2.2" default-virtual-server="default-host" native="true" default-session-timeout="30" instance-id="foo"&gt;
    &lt;configuration&gt;
        &lt;static-resources listings="true"
                          sendfile="1000"
                          file-encoding="utf-8"
                          read-only="true"
                          webdav="false"
                          secret="secret"
                          max-depth="5"
                          disabled="false"
                /&gt;
        &lt;jsp-configuration development="true"
                           disabled="false"
                           keep-generated="true"
                           trim-spaces="true"
                           tag-pooling="true"
                           mapped-file="true"
                           check-interval="20"
                           modification-test-interval="1000"
                           recompile-on-fail="true"
                           smap="true"
                           dump-smap="true"
                           generate-strings-as-char-arrays="true"
                           error-on-use-bean-invalid-class-attribute="true"
                           scratch-dir="/some/dir"
                           source-vm="1.7"
                           target-vm="1.7"
                           java-encoding="utf-8"
                           x-powered-by="true"
                           display-source-fragment="true" /&gt;
        &lt;mime-mapping name="ogx" value="application/ogg" /&gt;
        &lt;welcome-file&gt;titi&lt;/welcome-file&gt;
    &lt;/configuration&gt;
    &lt;connector name="http" scheme="http"
               protocol="HTTP/1.1"
               socket-binding="http"
               enabled="true"
               enable-lookups="false"
               proxy-binding="reverse-proxy"
               max-post-size="2097153"
               max-save-post-size="512"
               redirect-binding="https"
               max-connections="300"
               secure="false"
               executor="some-executor"
            /&gt;
    &lt;connector name="https" scheme="https" protocol="HTTP/1.1" secure="true" socket-binding="https"&gt;
        &lt;ssl certificate-key-file="${file-base}/server.keystore"
             ca-certificate-file="${file-base}/jsse.keystore"
             key-alias="test"
             password="changeit"
             cipher-suite="SSL_RSA_WITH_3DES_EDE_CBC_SHA"
             protocol="SSLv3"
             verify-client="true"
             verify-depth="3"
             certificate-file="certificate-file.ext"
             ca-revocation-url="https://example.org/some/url"
             ca-certificate-password="changeit"
             keystore-type="JKS"
             truststore-type="JKS"
             session-cache-size="512"
             session-timeout="3000"
             ssl-protocol="RFC4279"
                /&gt;
    &lt;/connector&gt;
    &lt;connector name="http-vs" scheme="http" protocol="HTTP/1.1" socket-binding="http" &gt;
        &lt;virtual-server name="vs1" /&gt;
        &lt;virtual-server name="vs2" /&gt;
    &lt;/connector&gt;
    &lt;virtual-server name="default-host" enable-welcome-root="true" default-web-module="foo.war"&gt;
        &lt;alias name="localhost" /&gt;
        &lt;alias name="example.com" /&gt;
        &lt;access-log resolve-hosts="true" extended="true" pattern="extended" prefix="prefix" rotate="true" &gt;
            &lt;directory relative-to="jboss.server.base.dir" path="toto" /&gt;
        &lt;/access-log&gt;
        &lt;rewrite name="myrewrite" pattern="^/helloworld(.*)" substitution="/helloworld/test.jsp" flags="L" /&gt;
        &lt;rewrite name="with-conditions" pattern="^/helloworld(.*)" substitution="/helloworld/test.jsp" flags="L" &gt;
            &lt;condition name="https" pattern="off" test="%{HTTPS}" flags="NC"/&gt;
            &lt;condition name="user" test="%{USER}" pattern="toto" flags="NC"/&gt;
            &lt;condition name="no-flags" test="%{USER}" pattern="toto"/&gt;
        &lt;/rewrite&gt;
        &lt;sso reauthenticate="true" domain="myDomain" cache-name="myCache"
             cache-container="cache-container" http-only="true"/&gt;
    &lt;/virtual-server&gt;
    &lt;virtual-server name="vs1" /&gt;
    &lt;virtual-server name="vs2" /&gt;
    &lt;valve name="myvalve" module="org.jboss.some.module" class-name="org.jboss.some.class" enabled="true"&gt;
        &lt;param param-name="param-name" param-value="some-value"/&gt;
    &lt;/valve&gt;
    &lt;valve name="accessLog" module="org.jboss.as.web" class-name="org.apache.catalina.valves.AccessLogValve"&gt;
        &lt;param param-name="prefix" param-value="myapp_access_log." /&gt;
        &lt;param param-name="suffix" param-value=".log" /&gt;
        &lt;param param-name="rotatable" param-value="true" /&gt;
        &lt;param param-name="fileDateFormat" param-value="yyyy-MM-dd" /&gt;
        &lt;param param-name="pattern" param-value="common" /&gt;
        &lt;param param-name="directory" param-value="${jboss.server.log.dir}" /&gt;
        &lt;param param-name="resolveHosts" param-value="false"/&gt;
        &lt;param param-name="conditionIf" param-value="log-enabled"/&gt;
    &lt;/valve&gt;
    &lt;valve name="request-dumper" module="org.jboss.as.web" class-name="org.apache.catalina.valves.RequestDumperValve"/&gt;
    &lt;valve name="remote-addr" module="org.jboss.as.web" class-name="org.apache.catalina.valves.RemoteAddrValve"&gt;
        &lt;param param-name="allow" param-value="127.0.0.1,127.0.0.2" /&gt;
        &lt;param param-name="deny" param-value="192.168.1.20" /&gt;
    &lt;/valve&gt;
    &lt;valve name="crawler" class-name="org.apache.catalina.valves.CrawlerSessionManagerValve" module="org.jboss.as.web" &gt;
        &lt;param param-name="sessionInactiveInterval" param-value="1" /&gt;
        &lt;param param-name="crawlerUserAgents" param-value="Google" /&gt;
    &lt;/valve&gt;
    &lt;valve name="proxy" class-name="org.apache.catalina.valves.RemoteIpValve" module="org.jboss.as.web" &gt;
        &lt;param param-name="internalProxies" param-value="192\.168\.0\.10|192\.168\.0\.11" /&gt;
        &lt;param param-name="remoteIpHeader" param-value="x-forwarded-for" /&gt;
        &lt;param param-name="proxiesHeader" param-value="x-forwarded-by" /&gt;
        &lt;param param-name="trustedProxies" param-value="proxy1|proxy2" /&gt;
    &lt;/valve&gt;
&lt;/subsystem&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>It is possible to do a migration of the legacy subsystem configuration and related persisted data by invoking the legacy subsystem&#8217;s <code>migrate</code> operation, using the management CLI:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=web:migrate</code></pre>
</div>
</div>
<div class="paragraph">
<p>There is also a <code>describe-migration</code> operation that returns a list of all the management operations that are performed to migrate from the legacy subsystem to the new one:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=web:describe-migration</code></pre>
</div>
</div>
<div class="paragraph">
<p>Both <code>migrate</code> and <code>describe-migration</code> will also display a list of migration-warnings if there are some resource or attributes that can not be migrated automatically. The following is a list of these warnings:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Could not migrate resource X</p>
<div class="paragraph">
<p>This warning means that mentioned resource configuration is not supported and won&#8217;t be included in the new subsystem configuration. As a result of that admin must be aware that any behavior implied by those resources would be nonexistent. Admin has to check whether subsystem is able to operate correctly without that behavior on the new server.</p>
</div>
</li>
<li>
<p>Could not migrate attribute X from resource Y.</p>
<div class="paragraph">
<p>This warning means that mentioned resource configuration property is not supported and won&#8217;t be included in the new subsystem configuration. As a result of that admin must be aware that any behavior implied by those properties would be nonexistent. Admin has to check whether subsystem is
able to operate correctly without that behavior on the new server.</p>
</div>
</li>
<li>
<p>Could not migrate SSL connector as no SSL config is defined</p>
</li>
<li>
<p>Could not migrate verify-client attribute %s to the Undertow equivalent</p>
</li>
<li>
<p>Could not migrate verify-client expression %s</p>
</li>
<li>
<p>Could not migrate valve X</p>
<div class="paragraph">
<p>This warning means that mentioned valve configuration is not supported and won&#8217;t be included in the new subsystem configuration. As a result of that admin must be aware that any behavior implied by those resources would be nonexistent. Admin has to check whether subsystem is able to operate correctly without that behavior on the new server. This warning may happen for:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>org.apache.catalina.valves.RemoteAddrValve : must have at least one
allowed or denied value.</p>
</li>
<li>
<p>org.apache.catalina.valves.RemoteHostValve : must have at least one
allowed or denied value.</p>
</li>
<li>
<p>org.apache.catalina.authenticator.BasicAuthenticator</p>
</li>
<li>
<p>org.apache.catalina.authenticator.DigestAuthenticator</p>
</li>
<li>
<p>org.apache.catalina.authenticator.FormAuthenticator</p>
</li>
<li>
<p>org.apache.catalina.authenticator.SSLAuthenticator</p>
</li>
<li>
<p>org.apache.catalina.authenticator.SpnegoAuthenticator</p>
</li>
<li>
<p>custom valves</p>
</li>
</ul>
</div>
</li>
<li>
<p>Could not migrate attribute X from valve Y</p>
<div class="paragraph">
<p>This warning means that mentioned valve configuration property is not supported and won&#8217;t be included in the new subsystem configuration. As a result of that admin must be aware that any behavior implied by those properties would be nonexistent. Admin has to check whether subsystem is
able to operate correctly without that behavior on the new server. This warning may happen for :</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>org.apache.catalina.valves.AccessLogValve</code> : if you use the following parameters <code>resolveHosts</code>, <code>fileDateFormat</code>, <code>renameOnRotate</code>,
<code>encoding</code>, <code>locale</code>, <code>requestAttributesEnabled</code>, <code>buffered</code>.</p>
</li>
<li>
<p><code>org.apache.catalina.valves.ExtendedAccessLogValve</code> : if you use the following parameters <code>resolveHosts</code>, <code>fileDateFormat</code>, <code>renameOnRotate</code>, <code>encoding</code>, <code>locale</code>, <code>requestAttributesEnabled</code>, <code>buffered</code>.</p>
</li>
<li>
<p><code>org.apache.catalina.valves.RemoteIpValve</code>:</p>
<div class="ulist">
<ul>
<li>
<p>if <code>remoteIpHeader</code> is defined and isn&#8217;t set to "x-forwarded-for".</p>
</li>
<li>
<p>if <code>protocolHeader</code> is defined and isn&#8217;t set to "x-forwarded-proto".</p>
</li>
<li>
<p>if you use the following parameters <code>httpServerPort</code> and <code>httpsServerPort</code> .</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Also, note that Undertow doesn&#8217;t support JBoss Web <code>valves</code>, but some of these may be migrated to Undertow handlers, and JBoss Web subsystem&#8217;s <code>migrate</code> operation do that too.</p>
</div>
<div class="paragraph">
<p>Here is a list of those valves and their corresponding Undertow handler:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Valve</th>
<th class="tableblock halign-left valign-top">Handler</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">org.apache.catalina.valves.AccessLogValve</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">io.undertow.server.handlers.accesslog.AccessLogHandler</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">org.apache.catalina.valves.ExtendedAccessLogValve</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">io.undertow.server.handlers.accesslog.AccessLogHandler</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">org.apache.catalina.valves.RequestDumperValve</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">io.undertow.server.handlers.RequestDumpingHandler</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">org.apache.catalina.valves.RewriteValve</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">io.undertow.server.handlers.SetAttributeHandler</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">org.apache.catalina.valves.RemoteHostValve</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">io.undertow.server.handlers.AccessControlListHandler</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">org.apache.catalina.valves.RemoteAddrValve</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">io.undertow.server.handlers.IPAddressAccessControlHandler</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">org.apache.catalina.valves.RemoteIpValve</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">io.undertow.server.handlers.ProxyPeerAddressHandler</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">org.apache.catalina.valves.StuckThreadDetectionValve</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">io.undertow.server.handlers.StuckThreadDetectionHandler</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">org.apache.catalina.valves.CrawlerSessionManagerValve</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">io.undertow.servlet.handlers.CrawlerSessionManagerHandler</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The <code>org.apache.catalina.valves.JDBCAccessLogValve</code> can&#8217;t be automatically migrated to <code>io.undertow.server.handlers.JDBCLogHandler</code> as the expectations differ.</p>
</div>
<div class="paragraph">
<p>The migration can be done manually though :</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Create the driver module and add the driver to the list of available drivers</p>
</li>
<li>
<p>Create a datasource pointing to the database where the log entries are going to be stored</p>
</li>
<li>
<p>Add an <code>expression-filter</code> definition with the following expression: "jdbc-access-log(datasource='datasource-jndi-name")</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;valve name="jdbc" module="org.jboss.as.web" class-name="org.apache.catalina.valves.JDBCAccessLogValve"&gt;
    &lt;param param-name="driverName" param-value="com.mysql.jdbc.Driver" /&gt;
    &lt;param param-name="connectionName" param-value="root" /&gt;
    &lt;param param-name="connectionPassword" param-value="password" /&gt;
    &lt;param param-name="connectionURL" param-value="jdbc:mysql://localhost:3306/wildfly?zeroDateTimeBehavior=convertToNull" /&gt;
    &lt;param param-name="format" param-value="combined" /&gt;
&lt;/valve&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>should become:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;subsystem xmlns="urn:jboss:domain:datasources:1.2"&gt;
    &lt;datasources&gt;
        &lt;datasource jndi-name="java:jboss/datasources/accessLogDS" pool-name="ccessLogDS" enabled="true" use-java-context="true"&gt;
            &lt;connection-url&gt;jdbc:mysql://localhost:3306/wildfly?zeroDateTimeBehavior=convertToNull&lt;/connection-url&gt;
            &lt;driver&gt;mysql&lt;/driver&gt;
            &lt;security&gt;
               &lt;user-name&gt;root&lt;/user-name&gt;
               &lt;password&gt;password&lt;/password&gt;
            &lt;/security&gt;
        &lt;/datasource&gt;
        ...
        &lt;drivers&gt;
            &lt;driver name="mysql" module="com.mysql"&gt;
                &lt;driver-class&gt;com.mysql.jdbc.Driver&lt;/driver-class&gt;
            &lt;/driver&gt;
        ...
        &lt;/drivers&gt;
    &lt;/datasources&gt;
&lt;/subsystem&gt;
...
&lt;subsystem xmlns="urn:jboss:domain:undertow:3.1" default-virtual-host="default-virtual-host" default-servlet-container="myContainer"
           default-server="some-server" instance-id="some-id" statistics-enabled="true"&gt;
    ...
    &lt;server name="some-server" default-host="other-host" servlet-container="myContainer"&gt;
    ...
        &lt;host name="other-host" alias="www.mysite.com, ${prop.value:default-alias}" default-web-module="something.war" disable-console-redirect="true"&gt;
            &lt;location name="/" handler="welcome-content" /&gt;
            &lt;filter-ref name="jdbc-access"/&gt;
        &lt;/host&gt;
    &lt;/server&gt;
    ...
    &lt;filters&gt;
        &lt;expression-filter name="jdbc-access" expression="jdbc-access-log(datasource='java:jboss/datasources/accessLogDS')" /&gt;
    ...
    &lt;/filters&gt;

&lt;/subsystem&gt;</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>Note that any custom valve won&#8217;t be migrated at all and will just be removed from the configuration.</p>
</div>
<div class="paragraph">
<p>Also the authentication related valves are to be replaced by Undertow authentication mechanisms, and this have to be done manually.</p>
</div>
</div>
<div class="sect4">
<h5 id="websockets"><a class="anchor" href="#websockets"></a>WebSockets</h5>
<div class="paragraph">
<p>In JBoss AS 7, to use WebSockets, you had to configure the 'http' <code>connector</code> in the <code>web</code> subsystem of the server configuration file to use the NIO2 protocol. The following is an example of the management CLI command to configure WebSockets in the previous releases.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=web/connector=http/:write-attribute(name=protocol,value=org.apache.coyote.http11.Http11NioProtocol)</code></pre>
</div>
</div>
<div class="paragraph">
<p>WebSockets are a requirement of the Jakarta EE specification and the default configuration is included in WildFly. More complex WebSocket configuration is done in the <code>servlet-container</code> of the <code>undertow</code> subsystem of the server configuration file.</p>
</div>
<div class="paragraph">
<p>You no longer need to configure the server for default WebSocket support.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="messaging-subsystem"><a class="anchor" href="#messaging-subsystem"></a>24.3.3. Messaging Subsystem</h4>
<div class="paragraph">
<p>WildFly JMS support is provided by ActiveMQ Artemis, instead of HornetQ. It&#8217;s possible to do a migration of the legacy subsystem configuration, and related persisted data.</p>
</div>
<div class="sect4">
<h5 id="messaging-subsystem-configuration"><a class="anchor" href="#messaging-subsystem-configuration"></a>Messaging Subsystem Configuration</h5>
<div class="paragraph">
<p>The extension&#8217;s module <code>org.jboss.as.messaging</code> is replaced by module <code>org.wildfly.extension.messaging-activemq</code>, while the subsystem configuration namespace <code>urn:jboss:domain:messaging:3.0</code> is replaced by <code>urn:jboss:domain:messaging-activemq:1.0</code>.</p>
</div>
<div class="sect5">
<h6 id="management-model"><a class="anchor" href="#management-model"></a>Management model</h6>
<div class="paragraph">
<p>In most cases, an effort was made to keep resource and attribute names as similar as possible to those used in previous releases. The following table lists some of the changes.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">HornetQ name</th>
<th class="tableblock halign-left valign-top">ActiveMQ name</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">hornetq-server</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">server</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">hornetq-serverType</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">serverType</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">connectors</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">connector</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">discovery-group-name</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">discovery-group</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The management operations invoked on the new messaging-subsystem starts with <code>/subsystem=messaging-activemq/server=X</code> while the legacy <code>messaging</code> subsystem was at <code>/subsystem=messaging/hornetq-server=X</code>.</p>
</div>
<div class="paragraph">
<p>In case the legacy subsystem configuration is available, such configuration may be migrated to the new subsystem by invoking its <code>migrate</code> operation, using the management CLI:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=messaging:migrate</code></pre>
</div>
</div>
<div class="paragraph">
<p>There is also a <code>describe-migration</code> operation that returns a list of all the management operations that are performed to migrate from the legacy subsystem to the new one:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=messaging:describe-migration</code></pre>
</div>
</div>
<div class="paragraph">
<p>Both <code>migrate</code> and <code>describe-migration</code> will also display a list of migration-warnings if there are some resource or attributes that can not be migrated automatically. The following is a list of these warnings:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The migrate operation can not be performed: the server must be in admin-only mode</p>
<div class="paragraph">
<p>The <code>migrate</code> operation requires starting the server in admin-only mode, which is done by adding parameter <code>--admin-only</code> to the server start command, e.g.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>./standalone.sh --admin-only</code></pre>
</div>
</div>
</li>
<li>
<p>Can not migrate attribute local-bind-address from resource X. Use instead the socket-attribute to configure this broadcast-group.</p>
</li>
<li>
<p>Can not migrate attribute local-bind-port from resource X. Use instead the socket-binding attribute to configure this broadcast-group.</p>
</li>
<li>
<p>Can not migrate attribute group-address from resource X. Use instead the socket-binding attribute to configure this broadcast-group.</p>
</li>
<li>
<p>Can not migrate attribute group-port from resource X. Use instead the socket-binding attribute to configure this broadcast-group.</p>
<div class="paragraph">
<p>Broadcast-group resources no longer accept local-bind-address, local-bind-port, group-address, group-port attributes. It only accepts a socket-binding. The warning notifies that resource X has an unsupported attribute. The user will have to set the socket-binding attribute on the resource and ensures it corresponds to a defined socket-binding
resource.</p>
</div>
</li>
<li>
<p>Classes providing the %s are discarded during the migration. To use them in the new <code>messaging-activemq</code> subsystem, you will have to extend the Artemis-based Interceptor.</p>
<div class="paragraph">
<p>Messaging interceptors support is significantly different in WildFly 10, any interceptors configured in the legacy subsystem are discarded during migration. See  the <a href="#messaging-interceptors">Messaging Interceptors</a> section to learn how to migrate legacy Messaging interceptors.</p>
</div>
</li>
<li>
<p>Can not migrate the HA configuration of X. Its shared-store and backup attributes holds expressions and it is not possible to determine unambiguously how to create the corresponding ha-policy for the <code>messaging-activemq</code> server.</p>
<div class="paragraph">
<p>If the <code>hornetq-server</code> X&#8217;s shared-store or backup attributes hold an expression, such as ${xxx}, then it&#8217;s not possible to determine the actual ha-policy of the migrated server. In that case, we discard it and the user will have to add the correct <code>ha-policy</code> afterwards. The <code>ha-policy</code> is a single resource underneath the <code>messaging-activemq</code> server resource.</p>
</div>
</li>
<li>
<p>Can not migrate attribute local-bind-address from resource X. Use instead the socket-binding attribute to configure this discovery-group.Can not migrate attribute local-bind-port from resource X. Use instead the socket-binding attribute to configure this discovery-group.</p>
</li>
<li>
<p>Can not migrate attribute group-address from resource X. Use instead the socket-binding attribute to configure this discovery-group.</p>
</li>
<li>
<p>Can not migrate attribute group-port from resource X. Use instead the socket-binding attribute to configure this discovery-group.</p>
<div class="paragraph">
<p>The <code>discovery-group</code> resources no longer accept <code>local-bind-address</code>, <code>local-bind-port</code>, <code>group-address</code>, <code>group-port</code> attributes. It only accepts a <code>socket-binding</code>. The warning notifies that resource X has an unsupported attribute.</p>
</div>
<div class="paragraph">
<p>The user will have to set the socket-binding attribute on the resource and ensures it corresponds to a defined socket-binding resource.</p>
</div>
</li>
<li>
<p>Can not create a legacy-connection-factory based on connection-factory X. It uses a HornetQ in-vm connector that is not compatible with Artemis in-vm connector</p>
<div class="paragraph">
<p>Legacy subsystem&#8217;s remote connection-factory resources are migrated into legacy-connection-factory resources, to allow old EAP6 clients to connect to EAP7. However a connection-factory using in-vm will not be migrated, because a in-vm client will be based on EAP7, not EAP 6. In other words, legacy-connection-factory are created only when the CF is using remote connectors, and this warning notifies about in-vm connection-factory X not migrated.</p>
</div>
</li>
<li>
<p>Can not migrate attribute X from resource Y. The attribute uses an expression that can be resolved differently depending on system properties. After migration, this attribute must be added back with an actual value instead of the expression.</p>
<div class="paragraph">
<p>This warning appears when the migration logic needs to know the concrete value of attribute X during migration, but instead such value includes an expression that&#8217;s can&#8217;t be resolved, so the actual value can not be determined, and the attribute is discarded. It happens in several cases,
for instance:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>cluster-connection forward-when-no-consumers. This boolean attribute has been replaced by the message-load-balancing-type attribute (which is an enum of OFF, STRICT, ON_DEMAND)</p>
</li>
<li>
<p>broadcast-group and discovery-group&#8217;s jgroups-stack and jgroups-channel attributes. They reference other resources and we no longer accept expressions for them.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Can not migrate attribute X from resource Y. This attribute is not supported by the new <code>messaging-activemq</code> subsystem.</p>
<div class="paragraph">
<p>Some attributes are no longer supported in the new <code>messaging-activemq</code> subsystem and are simply discarded:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>hornetq-server&#8217;s failback-delay</p>
</li>
<li>
<p>http-connector&#8217;s use-nio attribute</p>
</li>
<li>
<p>http-acceptor&#8217;s use-nio attribute</p>
</li>
<li>
<p>remote-connector&#8217;s use-nio attribute</p>
</li>
<li>
<p>remote-acceptor&#8217;s use-nio attribute</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
<div class="sect5">
<h6 id="xml-configuration"><a class="anchor" href="#xml-configuration"></a>XML Configuration</h6>
<div class="paragraph">
<p>The XML configuration has changed significantly with the new <code>messaging-activemq</code> subsystem to provide a XML scheme more consistent with other WildFly subsystems.</p>
</div>
<div class="paragraph">
<p>It is not advised to change the XML configuration of the legacy <code>messaging</code> subsystem to conform to the new <code>messaging-activemq</code> subsystem. Instead, invoke the legacy subsystem <code>migrate</code> operation. This operation will write the XML configuration of the new <code>messaging-activemq</code> subsystem as a part of its execution.</p>
</div>
</div>
<div class="sect5">
<h6 id="messaging-interceptors"><a class="anchor" href="#messaging-interceptors"></a>Messaging Interceptors</h6>
<div class="paragraph">
<p>Messaging Interceptors are significantly different in WildFly 10, requiring both code and configuration changes by the user. In concrete the interceptor base Java class is now <code>org.apache.artemis.activemq.api.core.interceptor.Interceptor</code>, and the user interceptor implementation classes may now be loaded by any server module. Note that prior to WildFly 10 the interceptor classes could only be installed by adding these to the HornetQ module, thus requiring the user to change such module XML descriptor, its <code>module.xml</code>.</p>
</div>
<div class="paragraph">
<p>With respect to the server XML configuration, the user must now specify the module to load its interceptors in the new <code>messaging-activemq</code> subsystem XML config, e.g:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;subsystem xmlns="urn:jboss:domain:messaging-activemq:1.0"&gt;
    &lt;server name="default"&gt;
       ...
        &lt;incoming-interceptors&gt;
            &lt;class name="org.foo.incoming.myInterceptor" module="org.foo" /&gt;
            &lt;class name="org.bar.incoming.myOtherInterceptor" module="org.bar" /&gt;
        &lt;/incoming-interceptors&gt;
        &lt;outgoing-interceptors&gt;
            &lt;class name="org.foo.outgoing.myInterceptor" module="org.foo" /&gt;
            &lt;class name="org.bar.outgoing.myOtherInterceptor" module="org.bar" /&gt;
        &lt;/outgoing-interceptors&gt;
   &lt;/server&gt;
&lt;/subsystem&gt;</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="Jakarta-Messaging-destinations"><a class="anchor" href="#Jakarta-Messaging-destinations"></a>Jakarta Messaging Destinations</h6>
<div class="paragraph">
<p>In previous releases, Jakarta Messaging destination queues were configured in the <code>&lt;jms-destinations&gt;</code> element under the hornetq-server section of the <code>messaging</code> subsystem.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;jms-destinations&gt;
    &lt;jms-queue name="testQueue"&gt;
        &lt;entry name="queue/test"/&gt;
        &lt;entry name="java:jboss/exported/jms/queue/test"/&gt;
    &lt;/jms-queue&gt;
&lt;/jms-destinations&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>In WildFly, the Jakarta Messaging destination queue is configured in the default server of the <code>messaging-activemq</code> subsystem.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;jms-queue name="testQueue" entries="queue/test java:jboss/exported/jms/queue/test"/&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="messaging-logging"><a class="anchor" href="#messaging-logging"></a>Messaging Logging</h5>
<div class="paragraph">
<p>The prefix of messaging log messages in WildFly is <code>WFLYMSGAMQ</code>, instead of <code>WFLYMSG</code>.</p>
</div>
</div>
<div class="sect4">
<h5 id="messaging-data"><a class="anchor" href="#messaging-data"></a>Messaging Data</h5>
<div class="paragraph">
<p>The location of the messaging data has been changed in the new <code>messaging-activemq</code> subsystem:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>messagingbindings/ &#8594; activemq/bindings/</p>
</li>
<li>
<p>messagingjournal/ &#8594; activemq/journal/</p>
</li>
<li>
<p>messaginglargemessages/ &#8594; activemq/largemessages/</p>
</li>
<li>
<p>messagingpaging/ &#8594; activemq/paging/</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>To migrate legacy messaging data, you will have to export the directories used by the legacy <code>messaging</code> subsystem and import them into the new subsystem&#8217;s server by using its <code>import-journal</code> operation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>/subsystem=messaging-activemq/server=default:import-journal(file=&lt;path to XML dump&gt;)</code></pre>
</div>
</div>
<div class="paragraph">
<p>The XML dump is a XML file generated by HornetQ <code>XmlDataExporter</code> util class.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="application-migration"><a class="anchor" href="#application-migration"></a>24.4. Application Migration</h3>
<div class="paragraph">
<p>Before you migrate your application, you should be aware that some features that were available in previous releases are now deprecated or missing.</p>
</div>
<div class="sect3">
<h4 id="ejbs"><a class="anchor" href="#ejbs"></a>24.4.1. EJBs</h4>
<div class="sect4">
<h5 id="cmp-entity-ejbs"><a class="anchor" href="#cmp-entity-ejbs"></a>CMP Entity EJBs</h5>
<div class="paragraph">
<p>Container-Managed Persistence entity beans support is optional in Jakarta EE, and WildFly does not provide support for these.</p>
</div>
<div class="paragraph">
<p>CMP entity beans are defined in the <code>ejb-jar.xml</code> descriptor, in concrete an entity bean is CMP only if the <code>&lt;entity/&gt;</code> child element named <code>persistence-type</code> is included and has a value of <code>Container</code>. An example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;?xml version="1.1" encoding="UTF-8"?&gt;
&lt;ejb-jar xmlns="http://java.sun.com/xml/ns/javaee"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://java.sun.com/xml/ns/javaee http://java.sun.com/xml/ns/javaee/ejb-jar_3_1.xsd"
         version="3.1"&gt;
    &lt;enterprise-beans&gt;
        &lt;entity&gt;
            &lt;ejb-name&gt;SimpleBMP&lt;/ejb-name&gt;
            &lt;local-home&gt;org.jboss.as.test.integration.ejb.entity.bmp.BMPLocalHome&lt;/local-home&gt;
            &lt;local&gt;org.jboss.as.test.integration.ejb.entity.bmp.BMPLocalInterface&lt;/local&gt;
            &lt;ejb-class&gt;org.jboss.as.test.integration.ejb.entity.bmp.SimpleBMPBean&lt;/ejb-class&gt;
            &lt;persistence-type&gt;Container&lt;/persistence-type&gt;
            &lt;prim-key-class&gt;java.lang.Integer&lt;/prim-key-class&gt;
            &lt;reentrant&gt;true&lt;/reentrant&gt;
        &lt;/entity&gt;
    &lt;/enterprise-beans&gt;
&lt;/ejb-jar&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>CMP entity beans should be replaced by Jakarta Persistence entities.</p>
</div>
</div>
<div class="sect4">
<h5 id="ejb-client"><a class="anchor" href="#ejb-client"></a>EJB Client</h5>
<div class="sect5">
<h6 id="default-remote-connection-port"><a class="anchor" href="#default-remote-connection-port"></a>Default Remote Connection Port</h6>
<div class="paragraph">
<p>The default remote connection port has changed from <code>4447</code> to <code>8080</code>.</p>
</div>
<div class="paragraph">
<p>In JBoss AS 7, the <code>jboss-ejb-client.properties</code> file looked similar to
the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>remote.connectionprovider.create.options.org.xnio.Options.SSL_ENABLED=false
remote.connections=default
remote.connection.default.host=localhost
remote.connection.default.port=4447
remote.connection.default.connect.options.org.xnio.Options.SASL_POLICY_NOANONYMOUS=false</code></pre>
</div>
</div>
<div class="paragraph">
<p>In WildFly, the properties file looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>remote.connectionprovider.create.options.org.xnio.Options.SSL_ENABLED=false
remote.connections=default
remote.connection.default.host=localhost
remote.connection.default.port=8080
remote.connection.default.connect.options.org.xnio.Options.SASL_POLICY_NOANONYMOUS=false</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="default-connector"><a class="anchor" href="#default-connector"></a>Default Connector</h6>
<div class="paragraph">
<p>In WildFly, the default connector has changed from <code>remoting</code> to <code>http-remoting</code>. This change impacts clients that use libraries from one release of JBoss and to connect to server in a different release.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>If a client application uses the EJB client library from JBoss AS 7 and wants to connect to WildFly 10 server, the server must be configured to expose a remoting connector on a port other than <code>8080</code>. The client must then connect using that newly configured connector.</p>
</li>
<li>
<p>A client application that uses the EJB client library from WildFly 10 and wants to connect to a JBoss AS 7 server must be aware that the server instance does not use the http-remoting connector and instead uses a remoting connector. This is achieved by defining a new client-side connection property.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>remote.connection.default.protocol=remote</code></pre>
</div>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>External applications using JNDI, to remotely lookup up EJBs in a WildFly 10 server, may also need to be migrated, see  <a href="#remote-jndi-clients">#Remote JNDI Clients</a> section for further information.</p>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="Jakarta-Messaging"><a class="anchor" href="#Jakarta-Messaging"></a>24.4.2. Jakarta Messaging</h4>
<div class="sect4">
<h5 id="proprietary-Jakarta-Messaging-resource-definitions"><a class="anchor" href="#proprietary-Jakarta-Messaging-resource-definitions"></a>Proprietary Jakarta Messaging Resource Definitions</h5>
<div class="paragraph">
<p>The proprietary XML descriptors, previously used to setup Jakarta Messaging resources, are deprecated in WildFly. Jakarta EE (section EE.5.18) standardized such functionality.</p>
</div>
<div class="paragraph">
<p>The deprecated descriptors are files bundled in the application package, which name ends with <code>-jms.xml</code>. Their namespace has been changed to <code>urn:jboss:messaging-activemq-deployment:1.0</code>.</p>
</div>
</div>
<div class="sect4">
<h5 id="external-Jakarta-Messaging-clients"><a class="anchor" href="#external-Jakarta-Messaging-clients"></a>External Jakarta Messaging Clients</h5>
<div class="paragraph">
<p>Jakarta Messaging Resources are remotely looked up using JNDI, and looking up resources in a WildFly 10 server may require changes in the application code, see  <a href="#remote-jndi-clients">#Remote JNDI Clients</a> section for further information.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="Jakarta-Persistence-and-hibernate"><a class="anchor" href="#Jakarta-Persistence-and-hibernate"></a>24.4.3. Jakarta Persistence (and Hibernate)</h4>
<div class="sect4">
<h5 id="applications-that-plan-to-use-hibernate-orm-5.0"><a class="anchor" href="#applications-that-plan-to-use-hibernate-orm-5.0"></a>Applications That Plan to Use Hibernate ORM 5.0</h5>
<div class="paragraph">
<p>WildFly ships with Hibernate ORM 5.0 and those libraries are implicitly added to the application classpath when a <code>persistence.xml</code> is detected during deployment. If your application uses Jakarta Persistence, it will default to using the Hibernate ORM 5.0 libraries.</p>
</div>
<div class="paragraph">
<p>Hibernate ORM 5.0 introduces:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Redesigned metamodel - Complete replacement for the current <code>org.hibernate.mapping</code> code</p>
</li>
<li>
<p>Query parser - Improved query parser based on Antlr 3/4</p>
</li>
<li>
<p>Multi-tenancy improvements - Discriminator-based multi-tenancy</p>
</li>
<li>
<p>Follow-on fetches - Two-phase loading via LoadPlans/EntityGraphs</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="applications-that-currently-use-hibernate-orm-4.0---4.3"><a class="anchor" href="#applications-that-currently-use-hibernate-orm-4.0---4.3"></a>Applications that currently use Hibernate ORM 4.0 - 4.3</h5>
<div class="paragraph">
<p>If your application needs second-level cache enabled, you should migrate to Hibernate ORM 5.0, which is integrated with Infinispan 8.0. Applications written with Hibernate ORM 4.x can still use Hibernate 4.x if you define a custom JBoss module with Hibernate 4.x JARs and exclude the Hibernate 5 classes from your application. It is recommended that you migrate your application to use Hibernate 5.</p>
</div>
<div class="paragraph">
<p>For information about the changes implemented between Hibernate 4 and Hibernate 5, see
<a href="https://github.com/hibernate/hibernate-orm/blob/master/migration-guide.adoc" class="bare">https://github.com/hibernate/hibernate-orm/blob/master/migration-guide.adoc</a></p>
</div>
</div>
<div class="sect4">
<h5 id="applications-that-currently-use-hibernate-3"><a class="anchor" href="#applications-that-currently-use-hibernate-3"></a>Applications that currently use Hibernate 3</h5>
<div class="paragraph">
<p>The integration classes that made it easier to use Hibernate 3 in JBoss AS 7 were removed from WildFly 10. If your application still uses Hibernate 3 libraries, it is strongly recommended that you migrate your application to use Hibernate 5 as Hibernate 3 will no longer work in WildFly without
a lot of effort. If you can not migrate to Hibernate 5, you must define a custom JBoss Module for the Hibernate 3 classes and exclude the Hibernate 5 classes from your application.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="web-applications"><a class="anchor" href="#web-applications"></a>24.4.4. Web Applications</h4>
<div class="sect4">
<h5 id="jboss-web-valves"><a class="anchor" href="#jboss-web-valves"></a>JBoss Web Valves</h5>
<div class="paragraph">
<p>Undertow does not support the JBoss Web Valve functionality. This can be replaced by Undertow Handlers. See the <a href="http://undertow.io/undertow-docs/undertow-docs-1.3.0/index.html#undertow-handler-authors-guide">Undertow Handler Authors Guide</a> for more information.</p>
</div>
<div class="paragraph">
<p>List of valves that were provided with JBoss Web, together with a corresponding Undertow handler, is provided above, in the section on the JBoss Web subsystem.</p>
</div>
<div class="paragraph">
<p>JBoss Web Valves are specified in the proprietary <code>jboss-web.xml</code> descriptor, through <code>&lt;valve /&gt;</code> element(s). These can be replaced using the <code>&lt;http-handler /&gt;</code> element(s). For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;jboss-web&gt;
    &lt;valve&gt;
        &lt;class-name&gt;org.apache.catalina.valves.RequestDumperValve&lt;/class-name&gt;
        &lt;module&gt;org.jboss.as.web&lt;/module&gt;
    &lt;/valve&gt;
&lt;/jboss-web&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>can be replaced by</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;jboss-web&gt;
    &lt;http-handler&gt;
        &lt;class-name&gt;io.undertow.server.handlers.RequestDumpingHandler&lt;/class-name&gt;
        &lt;module&gt;io.undertow.core&lt;/module&gt;
    &lt;/http-handler&gt;
&lt;/jboss-web&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="web-services"><a class="anchor" href="#web-services"></a>24.4.5. Web Services</h4>
<div class="sect4">
<h5 id="cxf-spring-webservices"><a class="anchor" href="#cxf-spring-webservices"></a>CXF Spring Webservices</h5>
<div class="paragraph">
<p>The setup of web service&#8217;s endpoints and clients, through a Spring XML descriptor, driving a CXF bus creation, is no longer supported in WildFly.</p>
</div>
<div class="paragraph">
<p>Any application containing a <code>jbossws-cxf.xml</code> must migrate all functionality specified in such XML descriptor, mostly already supported by the Jakarta XML Web Services specification, included in Jakarta EE. It is still possible to rely on direct Apache CXF API usage, loosing the Jakarta EE portability of the application, for instance when specific Apache CXF functionalities are needed. See the Apache CXF Integration document for further information.</p>
</div>
</div>
<div class="sect4">
<h5 id="Jakarta-XML-RPC"><a class="anchor" href="#Jakarta-XML-RPC"></a>Jakarta XML RPC</h5>
<div class="paragraph">
<p>Jakarta XML RPC is an API for building Web services and clients that used remote procedure calls (RPC) and XML, which was deprecated in Jakarta EE, and is no longer supported by WildFly.</p>
</div>
<div class="paragraph">
<p>Jakarta XML RPC Web Services may be identified by the presence of the XML descriptor named <code>webservices.xml</code>, containing a <code>&lt;webservice-description/&gt;</code> element that includes a child element named <code>&lt;jaxrpc-mapping-file/&gt;</code>. An example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-xml hljs" data-lang="xml">&lt;webservices xmlns="http://java.sun.com/xml/ns/j2ee"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://java.sun.com/xml/ns/j2ee http://www.ibm.com/webservices/xsd/j2ee_web_services_1_1.xsd" version="1.1"&gt;
    &lt;webservice-description&gt;
        &lt;webservice-description-name&gt;HelloService&lt;/webservice-description-name&gt;
        &lt;wsdl-file&gt;WEB-INF/wsdl/HelloService.wsdl&lt;/wsdl-file&gt;
        &lt;jaxrpc-mapping-file&gt;WEB-INF/mapping.xml&lt;/jaxrpc-mapping-file&gt;
        &lt;port-component&gt;
            &lt;port-component-name&gt;Hello&lt;/port-component-name&gt;
            &lt;wsdl-port&gt;HelloPort&lt;/wsdl-port&gt;
            &lt;service-endpoint-interface&gt;org.jboss.chap12.hello.Hello&lt;/service-endpoint-interface&gt;
            &lt;service-impl-bean&gt;
                &lt;servlet-link&gt;HelloWorldServlet&lt;/servlet-link&gt;
            &lt;/service-impl-bean&gt;
        &lt;/port-component&gt;
    &lt;/webservice-description&gt;
&lt;/webservices&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Applications using Jakarta XML RPC should be migrated to use Jakarta XML Web Services, the current Jakarta EE standard web service framework.</p>
</div>
</div>
<div class="sect4">
<h5 id="Jakarta-RESTful-Web-Services-2.1"><a class="anchor" href="#Jakarta-RESTful-Web-Services-2.1"></a>Jakarta RESTful Web Services 2.1</h5>
<div class="paragraph">
<p>Jakarta RESTful Web Services 2.1: The Java API for RESTful Web Services specification is located at <a href="https://jakarta.ee/specifications/restful-ws/2.1/" class="bare">https://jakarta.ee/specifications/restful-ws/2.1/</a></p>
</div>
<div class="paragraph">
<p>Some changes to the <code>MessageBodyWriter</code> interface may represent a backward incompatible change with respect to JAX-RS 1.X.</p>
</div>
<div class="paragraph">
<p>Be sure to define an <code>@Produces</code> or <code>@Consumes</code> for your endpoints. Failure to do so may result in an error similar to the following.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code>org.jboss.resteasy.core.NoMessageBodyWriterFoundFailure: Could not find MessageBodyWriter for response object of type: &lt;OBJECT&gt; of media type: &lt;CONTENT_TYPE&gt;</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="rest-client-api"><a class="anchor" href="#rest-client-api"></a>REST Client API</h5>
<div class="paragraph">
<p>Some REST Client API classes and methods are deprecated, for example: <code>org.jboss.resteasy.client.ClientRequest</code> and <code>org.jboss.resteasy.client.ClientResponse</code>. Instead, use
<a href="https://docs.jboss.org/resteasy/docs/3.15.0.Final/javadocs/index.html?org/jboss/resteasy/client/jaxrs/ResteasyClient.html">﻿<code>org.jboss.resteasy.client.jaxrs.ResteasyClient</code></a> and <code>javax.ws.rs.core.Response</code>. See the <code>resteasy-jaxrs-client</code> quickstart for an example of an external Jakarta RESTful Web Services RestEasy client that interacts with a Jakarta RESTful Web Services.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="application-clustering"><a class="anchor" href="#application-clustering"></a>24.4.6. Application Clustering</h4>
<div class="sect4">
<h5 id="ha-singleton"><a class="anchor" href="#ha-singleton"></a>HA Singleton</h5>
<div class="paragraph">
<p>JBoss AS 7 introduced singleton services - a mechanism for installing an service such that it would only start on one node in the cluster at a time, a HA Singleton. Such mechanism required usage of a private WildFly Clustering API, designed around the class <code>org.jboss.as.clustering.singleton.SingletonService</code>, and was documented in detail at
<a href="https://access.redhat.com/documentation/en-US/JBoss_Enterprise_Application_Platform/6.4/html/Development_Guide/Implement_an_HA_Singleton.html" class="bare">https://access.redhat.com/documentation/en-US/JBoss_Enterprise_Application_Platform/6.4/html/Development_Guide/Implement_an_HA_Singleton.html</a>, and while not difficult to implement, the installation process suffered from a couple shortcomings:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Installing multiple singleton services within a single deployment caused the deployer to hang.</p>
</li>
<li>
<p>Installing a singleton service required the user to specify several private module dependencies in <code>/META-INF/MANIFEST.MF</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>WildFly 10 introduces a new public API for building such services, which significantly simplifies the process, and solves the issues found in the legacy solution. The WildFly 10 Quickstart application named <code>cluster-ha-singleton</code> examples a HA Singleton implementation using the new API, and may be found at <a href="https://github.com/jboss-developer/jboss-eap-quickstarts/tree/7.0.x-develop/cluster-ha-singleton" class="bare">https://github.com/jboss-developer/jboss-eap-quickstarts/tree/7.0.x-develop/cluster-ha-singleton</a>
.<br></p>
</div>
</div>
<div class="sect4">
<h5 id="stateful-session-ejb-clustering"><a class="anchor" href="#stateful-session-ejb-clustering"></a>Stateful Session EJB Clustering</h5>
<div class="paragraph">
<p>WildFly 10 no longer requires Stateful Session EJBs to use the <code>org.jboss.ejb3.annotation.Clustered</code> annotation to enable clustering behavior. By default, if the server is started using an HA profile, the state of your SFSBs will be replicated automatically. Disabling this behavior is achievable on a per-EJB basis, by annotating your bean using <code>@Stateful(passivationCapable=false)</code>, which is new to the EJB 3.2 specification; or globally through the configuration of the EJB3 subsystem, in the server configuration.</p>
</div>
<div class="paragraph">
<p>Note that the <code>@Clustered</code> annotation, if used by an application, is simply ignored, the application deployment will not fail.</p>
</div>
</div>
<div class="sect4">
<h5 id="web-session-clustering"><a class="anchor" href="#web-session-clustering"></a>Web Session Clustering</h5>
<div class="paragraph">
<p>WildFly 10 introduces a new web session clustering implementation, replacing the one found in JBoss AS 7, which has been around for ages (since JBoss AS 3.2!), and was tightly coupled to the legacy JBoss Web subsystem source code. The most relevant changes in the new implementation are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Introduction of a proper session manager SPI, and an Infinispan implementation of it, decoupled from the web subsystem implementation</p>
</li>
<li>
<p>Sessions are implemented as a facade over one or more cache entries, which means that the container&#8217;s session manager itself does not retain a separate reference to each HttpSession</p>
</li>
<li>
<p>Pessimistic locking of cache entries effectively ensures that only a single client on a single node ever accesses a given session at any given time</p>
</li>
<li>
<p>Usage of cache entry grouping, instead of atomic maps, to ensure that multiple cache entries belonging to the same session are co-located.</p>
</li>
<li>
<p>Session operations within a request only ever use a single batch/transaction. This results in fewer RPCs per request.</p>
</li>
<li>
<p>Support for write-through cache stores, as well as passivation-only cache stores.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>With respect to applications, the new web session clustering implementation deprecates/reinterprets much of the related configuration, which is included in JBoss&#8217;s proprietary web application
XML descriptor, <code>jboss-web.xml</code>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>&lt;max-active-sessions/&gt;</code></p>
<div class="paragraph">
<p>Previously, session creation would fail if an additional session would cause the number of active sessions to exceed the value specified by <code>&lt;max-active-sessions/&gt;</code>.</p>
</div>
<div class="paragraph">
<p>In the new implementation, <code>&lt;max-active-sessions/&gt;</code> is used to enable session passivation. If session creation would cause the number of active sessions to exceed <code>&lt;max-active-sessions/&gt;</code>, then the oldest session known to the session manager will passivate to make room for the new session.</p>
</div>
</li>
<li>
<p><code>&lt;passivation-config/&gt;</code></p>
<div class="paragraph">
<p>This configuration element and its sub-elements are no longer used in WildFly.</p>
</div>
</li>
<li>
<p><code>&lt;use-session-passivation/&gt;</code></p>
<div class="paragraph">
<p>Previously, passivation was enabled via this attribute, yet in the new implementation, passivation is enabled by specifying a non-negative value for <code>&lt;max-active-sessions/&gt;</code>.</p>
</div>
</li>
<li>
<p><code>&lt;passivation-min-idle-time/&gt;</code></p>
<div class="paragraph">
<p>Previously, sessions needed to be active for at least a specific amount of time before becoming a candidate for passivation. This could cause session creation to fail, even when passivation was enabled.</p>
</div>
<div class="paragraph">
<p>The new implementation does not support this logic and thus avoids this DoS vulnerability.</p>
</div>
</li>
<li>
<p><code>&lt;passivation-max-idle-time/&gt;</code></p>
<div class="paragraph">
<p>Previously, a session would be passivated after it was idle for a specific amount of time.</p>
</div>
<div class="paragraph">
<p>The new implementation does not support eager passivation - only lazy passivation. Sessions are only passivated when necessary to comply with <code>&lt;max-active-sessions/&gt;</code>.</p>
</div>
</li>
<li>
<p><code>&lt;replication-config/&gt;</code></p>
<div class="paragraph">
<p>The new implementation deprecates a number of sub-elements.</p>
</div>
</li>
<li>
<p><code>&lt;replication-trigger/&gt;</code></p>
<div class="paragraph">
<p>Previously, session attributes could be treated as either mutable or immutable depending on the values specified by <code>&lt;replication-trigger/&gt;</code>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>SET treated all attributes as immutable, requiring a separate <code>HttpSession.setAttribute(&#8230;&#8203;)</code> to indicate that the value changed.</p>
</li>
<li>
<p>SET_AND_GET treated all session attributes as mutable.</p>
</li>
<li>
<p>SET_AND_NON_PRIMITIVE_GET recognized a small set of types, for example strings and boxed primitives, as immutable, and assumed that any other attribute was mutable.</p>
<div class="paragraph">
<p>The new implementation replaces this configuration option with a single, robust strategy. Session attributes are assumed to be mutable unless one of the following is true:</p>
</div>
</li>
<li>
<p>The value is a known immutable value:</p>
<div class="ulist">
<ul>
<li>
<p>null</p>
</li>
<li>
<p><code>java.util.Collections.EMPTY_LIST</code>, <code>EMPTY_MAP</code>, <code>EMPTY_SET</code></p>
</li>
</ul>
</div>
</li>
<li>
<p>The value type is or implements a known immutable type:</p>
<div class="ulist">
<ul>
<li>
<p><code>Boolean</code>, <code>Byte</code>, <code>Character</code>, <code>Double</code>, <code>Float</code>, <code>Integer</code>, <code>Long</code>, <code>Short</code></p>
</li>
<li>
<p><code>java.lang.Enum</code>, <code>StackTraceElement</code>, <code>String</code></p>
</li>
<li>
<p><code>java.io.File</code>, <code>java.nio.file.Path</code></p>
</li>
<li>
<p><code>java.math.BigDecimal</code>, <code>BigInteger</code>, <code>MathContext</code></p>
</li>
<li>
<p><code>java.net.InetAddress</code>, <code>InetSocketAddress</code>, <code>URI</code>, <code>URL</code></p>
</li>
<li>
<p><code>java.security.Permission</code></p>
</li>
<li>
<p><code>java.util.Currency</code>, <code>Locale</code>, <code>TimeZone</code>, <code>UUID</code></p>
</li>
</ul>
</div>
</li>
<li>
<p>The value type is annotated with <code>@org.wildfly.clustering.web.annotation.Immutable</code></p>
</li>
</ul>
</div>
</li>
<li>
<p><code>&lt;use-jk/&gt;</code></p>
<div class="paragraph">
<p>Previously, the <code>instance-id</code> of the node handling a given request was appended to the <code>jsessionid</code>, for use by load balancers such as mod_jk, mod_proxy_balancer, mod_cluster, etc., depending on the value specified for <code>&lt;use-jk/&gt;</code>. In the new implementation, the <code>instance-id</code>, if defined, is always appended to the <code>jsessionid</code>.</p>
</div>
</li>
<li>
<p><code>&lt;max-unreplicated-interval/&gt;</code></p>
<div class="paragraph">
<p>Previously, this configuration option was an optimization that would prevent the replicate of a session&#8217;s timestamp if no session attribute was changed. While this sounds nice, in practice it doesn&#8217;t prevent any RPCs, since session access requires cache transaction RPCs regardless of
whether any session attributes changed. In the new implementation, the timestamp of a session is replicated on every request. This prevents stale session meta data following failover.</p>
</div>
</li>
<li>
<p><code>&lt;snapshot-mode/&gt;</code></p>
<div class="paragraph">
<p>Previously, one could configure <code>&lt;snapshot-mode/&gt;</code> as INSTANT or INTERVAL. Infinispan&#8217;s replication queue renders this configuration option obsolete.</p>
</div>
</li>
<li>
<p><code>&lt;snapshot-interval/&gt;</code></p>
<div class="paragraph">
<p>Only relevant for <code>&lt;snapshot-mode&gt;INTERVAL&lt;/snapshot-mode&gt;</code>. See above.</p>
</div>
</li>
<li>
<p><code>&lt;session-notification-policy/&gt;</code></p>
<div class="paragraph">
<p>Previously, the value defined by this attribute defined a policy for triggering session events. In the new implementation, this behavior is spec-driven and not configurable.</p>
</div>
</li>
</ul>
</div>
</div>
</div>
<div class="sect3">
<h4 id="other-specifications-and-frameworks"><a class="anchor" href="#other-specifications-and-frameworks"></a>24.4.7. Other Specifications and Frameworks</h4>
<div class="sect4">
<h5 id="remote-jndi-clients"><a class="anchor" href="#remote-jndi-clients"></a>Remote JNDI Clients</h5>
<div class="paragraph">
<p>WildFly 10&#8217;s default JNDI Provider URL has changed, which means that external applications, using JNDI to lookup remote resources, for instance an EJB or a Jakarta Messaging Queue, may need to change the value for the JNDI <code>InitialContext</code> environment&#8217;s property named
<code>java.naming.provider.url</code>. The default URL scheme is now
<code>http-remoting</code>, and the default URL port is now <code>8080</code>.</p>
</div>
<div class="paragraph">
<p>As an example, considering the application server host is <code>localhost</code>,
then clients previously accessing WildFly 10 would use</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">java.naming.factory.initial=org.jboss.naming.remote.client.InitialContextFactory
java.naming.provider.url=remote://localhost:4447</code></pre>
</div>
</div>
<div class="paragraph">
<p>while clients now accessing WildFly should use instead</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-java hljs" data-lang="java">java.naming.factory.initial=org.jboss.naming.remote.client.InitialContextFactory
java.naming.provider.url=http-remoting://localhost:8080</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="jsr-88"><a class="anchor" href="#jsr-88"></a>JSR-88</h5>
<div class="paragraph">
<p>The specification which aimed to standardize deployment tasks got very little adoption, due to much more "feature rich" proprietary solutions already included in every vendor application server. It was no surprise that JSR-88 support was dropped from Jakarta EE, and WildFly followed that and dropped support too.</p>
</div>
<div class="paragraph">
<p>A JSR-88 deployment plan is identified by a XML descriptor named <code>deployment-plan.xml</code>, bundled in a zip/jar archive.</p>
</div>
</div>
<div class="sect4">
<h5 id="module-dependencies"><a class="anchor" href="#module-dependencies"></a>Module Dependencies</h5>
<div class="paragraph">
<p>Applications defining dependencies to WildFly modules, through the application&#8217;s package <code>MANIFEST.MF</code> or <code>jboss-deployment-structure.xml</code>, may be referencing missing modules. When migrating an application, relying on such functionality, the presence of the referenced modules should be validated in advance.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
References in this document to Enterprise JavaBeans(EJB) refer to the Jakarta Enterprise Beans unless otherwise noted.
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="How_do_I_migrate_my_application_from_WebLogic_to_WildFly"><a class="anchor" href="#How_do_I_migrate_my_application_from_WebLogic_to_WildFly"></a>25. How do I migrate my application from WebLogic to WildFly</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The purpose of this guide is to document the application changes that
are needed to successfully run and deploy WebLogic applications on
WildFly.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Feel free to add content in any way you prefer. You do not need to
follow the template below. This is a work in progress.
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="introduction-weblogic-migration"><a class="anchor" href="#introduction-weblogic-migration"></a>25.1. Introduction</h3>
<div class="sect3">
<h4 id="about-this-guide-weblogic-migration"><a class="anchor" href="#about-this-guide-weblogic-migration"></a>25.1.1. About this Guide</h4>
<div class="paragraph">
<p>The purpose of this document is to guide you through the planning
process and migration of fairly simple and standard Oracle WebLogic
applications to WildFly. O</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="How_do_I_migrate_my_application_from_WebSphere_to_WildFly"><a class="anchor" href="#How_do_I_migrate_my_application_from_WebSphere_to_WildFly"></a>26. How do I migrate my application from WebSphere to WildFly</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The purpose of this guide is to document the application changes that
are needed to successfully run and deploy WebLogic applications on
WildFly.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Feel free to add content in any way you prefer. You do not need to
follow the template below. This is a work in progress.
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="introduction-websphere-migration"><a class="anchor" href="#introduction-websphere-migration"></a>26.1. Introduction</h3>
<div class="sect3">
<h4 id="about-this-guide-websphere-migration"><a class="anchor" href="#about-this-guide-websphere-migration"></a>26.1.1. About this Guide</h4>
<div class="paragraph">
<p>The purpose of this document is to guide you through the planning
process and migration of fairly simple and standard Oracle WebLogic
applications to WildFly.</p>
</div>
</div>
</div>
</div>
</div>
</article>
  </div>
</main>
</div>
<footer class="footer">
  <p>This page was built using the Antora default UI.</p>
  <p>The source code for this UI is licensed under the terms of the MPL-2.0 license.</p>
</footer>
<script src="../_/js/site.js"></script>
<script async src="../_/js/vendor/highlight.js"></script>
  </body>
</html>
